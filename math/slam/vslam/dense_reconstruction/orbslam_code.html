
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Personal Knowledge Base and Notes">
      
      
        <meta name="author" content="Yuqi">
      
      
      
        <link rel="prev" href="orbslam.html">
      
      
        <link rel="next" href="ptam.html">
      
      
        
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>ORB SLAM Source Code Review - Yuqi's Knowledge Blogs</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../stylesheets/extra.css">
    
      <link rel="stylesheet" href="https://unpkg.com/katex@0/dist/katex.min.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#orb-slam-source-code-review" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../../index.html" title="Yuqi&#39;s Knowledge Blogs" class="md-header__button md-logo" aria-label="Yuqi's Knowledge Blogs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Yuqi's Knowledge Blogs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ORB SLAM Source Code Review
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../index.html" title="Yuqi&#39;s Knowledge Blogs" class="md-nav__button md-logo" aria-label="Yuqi's Knowledge Blogs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Yuqi's Knowledge Blogs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Yuqi's Knowledge Blogs
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Data structure and algos
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Data structure and algos
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Algos
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Algos
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1_1" id="__nav_2_1_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Backtracking
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Backtracking
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../data_structure_and_algos/algos/backtracking/backtracking.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Backtracking
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_2" >
        
          
          <label class="md-nav__link" for="__nav_2_1_2" id="__nav_2_1_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Dynamic programming
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Dynamic programming
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../data_structure_and_algos/algos/dynamic_programming/dynamic_programming.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dynamic Programming
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_3" >
        
          
          <label class="md-nav__link" for="__nav_2_1_3" id="__nav_2_1_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Search
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Search
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../data_structure_and_algos/algos/search/bfs_vs_dfs.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Difference Between BFS and DFS
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Data structs
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Data structs
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_2_1" id="__nav_2_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Stack heap queue
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Stack heap queue
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../data_structure_and_algos/data_structs/stack_heap_queue/summary.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Stack, Heap and Queue
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2_2" id="__nav_2_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Tree
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Tree
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../data_structure_and_algos/data_structs/tree/binary_tree.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Binary Tree
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Probability and statistics
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Probability and statistics
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../data_structure_and_algos/probability_and_statistics/ants_leaving_bridge.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Ants leaving bridge
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../data_structure_and_algos/probability_and_statistics/eight_horse_racing.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Eight Horse Racing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../data_structure_and_algos/probability_and_statistics/money_hall_problem.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Money Hall Problem
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Database
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Database
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../database/cluster.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DB Cluster
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../database/sharding_and_partitioning.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sharding
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Non sql
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Non sql
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../database/non_sql/big_query.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Big Query
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../database/non_sql/summary.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Summary
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3_3" id="__nav_3_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Es
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Es
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../database/non_sql/es/elastic_search.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Elastic Search
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../database/non_sql/es/kibana.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Kibana
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_3_4" id="__nav_3_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Ldap
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Ldap
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../database/non_sql/ldap/indexing.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LDAP Indexing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../database/non_sql/ldap/ldap_proto.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LDAP Protocol
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../database/non_sql/ldap/ldap_schema.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LDAP
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3_5" >
        
          
          <label class="md-nav__link" for="__nav_3_3_5" id="__nav_3_3_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Mongodb
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Mongodb
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../database/non_sql/mongodb/indexing.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    MongoDB Indexing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../database/non_sql/mongodb/mongo_clustering.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    MongoDB Clustering and Replication
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../database/non_sql/mongodb/mongodb.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    MongoDB
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3_6" >
        
          
          <label class="md-nav__link" for="__nav_3_3_6" id="__nav_3_3_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Redis
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_3_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Redis
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../database/non_sql/redis/examples.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Redis Example Uses
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../database/non_sql/redis/lock.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Use of redis lock
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../database/non_sql/redis/performance.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Redis Performance Discussions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../database/non_sql/redis/redis.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Redis
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../database/non_sql/redis/redis_clustering.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Redis CLustering
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Sql
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Sql
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../database/sql/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Index
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../database/sql/db_adv_practices.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DB Advanced Practices
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../database/sql/db_basics.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Common DB knowledge
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../database/sql/optimizations_on_complex_sql.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Some Optimizations Over SQL
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../database/sql/sql.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Some SQL Knowledge
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4_6" >
        
          
          <label class="md-nav__link" for="__nav_3_4_6" id="__nav_3_4_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Mysql and oracle
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_4_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Mysql and oracle
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../database/sql/mysql_and_oracle/mysql.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    MYSQL
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../database/sql/mysql_and_oracle/mysql_clustering.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    MYSQL Clustering/Distribution and Sharding
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../database/sql/mysql_and_oracle/optimizations.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Optimizations
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../database/sql/mysql_and_oracle/oracle.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Oracle knowledge
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4_7" >
        
          
          <label class="md-nav__link" for="__nav_3_4_7" id="__nav_3_4_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Postgresql
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_4_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Postgresql
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../database/sql/postgresql/postgresql.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Postgre SQL
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4_8" >
        
          
          <label class="md-nav__link" for="__nav_3_4_8" id="__nav_3_4_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Sqlite
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_4_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Sqlite
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../database/sql/sqlite/sqlite.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SQLite
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Dev ops
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Dev ops
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" >
        
          
          <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Cloud devops
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Cloud devops
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1_1" >
        
          
          <label class="md-nav__link" for="__nav_4_1_1" id="__nav_4_1_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Aws
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Aws
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../dev_ops/cloud_devops/aws/aws_cloud_perf_devops.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AWS Performance DevOps
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../dev_ops/cloud_devops/aws/concepts.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AWS Concepts
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../dev_ops/cloud_devops/aws/connection_checks.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AWS Connection Issues
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../dev_ops/cloud_devops/aws/operations.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Best AWS Practices
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../dev_ops/cloud_devops/aws/system_mgr.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    System Manager
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1_1_6" >
        
          
          <label class="md-nav__link" for="__nav_4_1_1_6" id="__nav_4_1_1_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Rds
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_1_1_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1_1_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Rds
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../dev_ops/cloud_devops/aws/rds/redshift.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AWS Redshift
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1_2" >
        
          
          <label class="md-nav__link" for="__nav_4_1_2" id="__nav_4_1_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Docker
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Docker
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../dev_ops/cloud_devops/docker/containerd.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Containerd
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../dev_ops/cloud_devops/docker/docker.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Docker
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../dev_ops/cloud_devops/docker/docker_adv.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Docker Engine and Advanced Knowledge
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../dev_ops/cloud_devops/docker/docker_practice.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Docker Practices
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1_3" >
        
          
          <label class="md-nav__link" for="__nav_4_1_3" id="__nav_4_1_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    K8s
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    K8s
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../dev_ops/cloud_devops/k8s/helm.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Helm
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../dev_ops/cloud_devops/k8s/k8s.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Kubernetes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../dev_ops/cloud_devops/k8s/k8s_components.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Common K8S Components
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../dev_ops/cloud_devops/k8s/k8s_mon_stack.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    K8S Monitoring Stack
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../dev_ops/cloud_devops/k8s/k8s_practice.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    K8S Practice
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../dev_ops/cloud_devops/k8s/k8s_variants.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    K8S Variants
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1_4" >
        
          
          <label class="md-nav__link" for="__nav_4_1_4" id="__nav_4_1_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Service mgt
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Service mgt
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../dev_ops/cloud_devops/service_mgt/service_discovery.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Service Discovery
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1_5" >
        
          
          <label class="md-nav__link" for="__nav_4_1_5" id="__nav_4_1_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Terraform
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_1_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Terraform
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../dev_ops/cloud_devops/terraform/terraform.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Terraform
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../dev_ops/cloud_devops/terraform/tips.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Some Development Tips
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Linux devops
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Linux devops
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../dev_ops/linux_devops/linux_devops.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Some Linux Knowledge and DevOps
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../dev_ops/linux_devops/linux_network_devops.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux Network DevOps
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../dev_ops/linux_devops/linux_perf_devops.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux Performance DevOps
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../dev_ops/linux_devops/mac.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Mac OS
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../dev_ops/linux_devops/ubuntu.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Ubuntu
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2_6" >
        
          
          <label class="md-nav__link" for="__nav_4_2_6" id="__nav_4_2_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Bash
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_2_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Bash
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../dev_ops/linux_devops/bash/awk.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AWK tool
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../dev_ops/linux_devops/bash/bash_ops.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Bash common Operations
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../dev_ops/linux_devops/bash/linux_tools.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Some Linux Knowledge
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../dev_ops/linux_devops/bash/network.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Network linux tools
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../dev_ops/linux_devops/bash/special_char_ops.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Special Character Operations
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" >
        
          
          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Software tools
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Software tools
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3_1" >
        
          
          <label class="md-nav__link" for="__nav_4_3_1" id="__nav_4_3_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    CMake
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    CMake
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../dev_ops/software_tools/CMake/cmake_tutorials.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    cmake
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3_2" >
        
          
          <label class="md-nav__link" for="__nav_4_3_2" id="__nav_4_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Git
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Git
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../dev_ops/software_tools/Git/git_tutorials.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Git Commands
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3_3" >
        
          
          <label class="md-nav__link" for="__nav_4_3_3" id="__nav_4_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Postman
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Postman
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../dev_ops/software_tools/Postman/postman.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Postman
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3_4" >
        
          
          <label class="md-nav__link" for="__nav_4_3_4" id="__nav_4_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Splunk
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Splunk
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../dev_ops/software_tools/Splunk/Splunk.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Splunk
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3_5" >
        
          
          <label class="md-nav__link" for="__nav_4_3_5" id="__nav_4_3_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Ansible
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Ansible
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../dev_ops/software_tools/ansible/ansible.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Ansible
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3_6" >
        
          
          <label class="md-nav__link" for="__nav_4_3_6" id="__nav_4_3_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Grafana k6
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_3_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Grafana k6
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../dev_ops/software_tools/grafana_k6/grafana_k6.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Grafana K6 for Stress Test
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3_7" >
        
          
          <label class="md-nav__link" for="__nav_4_3_7" id="__nav_4_3_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Jenkins
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_3_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Jenkins
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../dev_ops/software_tools/jenkins/jenkins.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Jenkins
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3_8" >
        
          
          <label class="md-nav__link" for="__nav_4_3_8" id="__nav_4_3_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Nginx
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_3_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Nginx
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../dev_ops/software_tools/nginx/nginx.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Nginx
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3_9" >
        
          
          <label class="md-nav__link" for="__nav_4_3_9" id="__nav_4_3_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Virtualbox
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_3_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    Virtualbox
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../dev_ops/software_tools/virtualbox/virtualbox.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    VirtualBox
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3_10" >
        
          
          <label class="md-nav__link" for="__nav_4_3_10" id="__nav_4_3_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Vscode
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_3_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3_10">
            <span class="md-nav__icon md-icon"></span>
            
  
    Vscode
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../dev_ops/software_tools/vscode/vscode_shortcuts.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Some very useful shortcuts
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Fundamental computer
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Fundamental computer
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/terminologies.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Terminology Explain
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" >
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Compilation principles
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Compilation principles
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/compilation_principles/compilation_principles.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Compilation Principles
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/compilation_principles/computer_arch.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Computer Architecure
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/compilation_principles/cross_compilation.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cross Compilation on x86 and Arm
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/compilation_principles/executable_elf.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Executable ELF (Executable and Linkable Format)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/compilation_principles/helloworld_example.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Hello world example
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/compilation_principles/linker.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linker
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/compilation_principles/symbol_table_elf.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ELF Symbol Table
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" >
        
          
          <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Embedded system
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Embedded system
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/embedded_system/embedded_system_basics.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Embedded System Basics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/embedded_system/embedded_system_multi_media.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Multi-Media
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/embedded_system/eps32_start_guide.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    EPS32
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/embedded_system/esp32p4_board.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ESP32P4 Board and Relevant Components
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4" >
        
          
          <label class="md-nav__link" for="__nav_5_4" id="__nav_5_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Hardwawre
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Hardwawre
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/hardwawre/bootloader.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Bootloader when a Computer Starts
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/hardwawre/display.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Display
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/hardwawre/dma.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Direct Memory Access (DMA)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/hardwawre/motherboard.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Motherboard
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/hardwawre/numa.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Non-Uniform Memory Access (NUMA)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4_6" >
        
          
          <label class="md-nav__link" for="__nav_5_4_6" id="__nav_5_4_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Cpu
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_4_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Cpu
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/hardwawre/cpu/cpu.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CPU
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4_7" >
        
          
          <label class="md-nav__link" for="__nav_5_4_7" id="__nav_5_4_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Digital electronics
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_4_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Digital electronics
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/hardwawre/digital_electronics/FPGA.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    FPGA and Verilog
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/hardwawre/digital_electronics/VHDL.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    VHDL
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/hardwawre/digital_electronics/circuit_basics.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Circuit Basics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/hardwawre/digital_electronics/pcb.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Printed Circuit Board
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/hardwawre/digital_electronics/verilog.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Verilog
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4_7_6" >
        
          
          <label class="md-nav__link" for="__nav_5_4_7_6" id="__nav_5_4_7_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Simple cpu tutorial
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_5_4_7_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4_7_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Simple cpu tutorial
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/hardwawre/digital_electronics/simple_cpu_tutorial/8_bit_cpu_basics.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    8-bit single-cycle CPU
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4_8" >
        
          
          <label class="md-nav__link" for="__nav_5_4_8" id="__nav_5_4_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Disk
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_4_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Disk
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/hardwawre/disk/disk.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Disk Knowledge
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4_9" >
        
          
          <label class="md-nav__link" for="__nav_5_4_9" id="__nav_5_4_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Gpu
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_4_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpu
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/hardwawre/gpu/gpu.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    GPU
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/hardwawre/gpu/gpu_hardware.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    GPU Hardware
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_5" >
        
          
          <label class="md-nav__link" for="__nav_5_5" id="__nav_5_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Operating sys
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Operating sys
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/OS.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Operating System
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/macos.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Mac OS
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/memory.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Memory OS management
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/process_mgt.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Process and thread management
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/rtos.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    RTOS (Real Time Operating System)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/storage_and_peripherals.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Storage and Peripherals
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_5_7" >
        
          
          <label class="md-nav__link" for="__nav_5_5_7" id="__nav_5_5_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Linux
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_5_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_5_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Linux
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/Linux/linux.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux OS
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/Linux/process.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Process
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/Linux/system_call.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux System Call
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/Linux/virtual_file_sys.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Virtual File System
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_5_7_5" >
        
          
          <label class="md-nav__link" for="__nav_5_5_7_5" id="__nav_5_5_7_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Io
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_5_5_7_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_5_7_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Io
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/Linux/io/IO.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux I/O
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/Linux/io/block_io.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Block IO/Peripheral/Devices Layer
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/Linux/io/dma.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Direct Memory Access (DMA)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/Linux/io/driver.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux Driver
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/Linux/io/linux_storage.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux Storage
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_5_7_6" >
        
          
          <label class="md-nav__link" for="__nav_5_5_7_6" id="__nav_5_5_7_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Kernel
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_5_5_7_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_5_7_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Kernel
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/Linux/kernel/kernel.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux Kernel
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/Linux/kernel/kernel_perf.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Kernel Performance Measurement
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/Linux/kernel/memcpy.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Memory copy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/Linux/kernel/memory_kernel_structs.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Memory Implementation in Linux Kernel
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/Linux/kernel/memory_methods.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Kernel Memory Methods
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/Linux/kernel/memory_proc.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Memory for User Processes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/Linux/kernel/page.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Page
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/Linux/kernel/process.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux Process
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/Linux/kernel/process_scheduling.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Process Scheduling
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/Linux/kernel/thread.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Thread
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_5_7_7" >
        
          
          <label class="md-nav__link" for="__nav_5_5_7_7" id="__nav_5_5_7_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Malloc and free
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_5_5_7_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_5_7_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Malloc and free
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/Linux/malloc_and_free/free.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Free
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/Linux/malloc_and_free/malloc.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    malloc and free Implementation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/Linux/malloc_and_free/others.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Malloc and Free Other Discussions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_5_7_8" >
        
          
          <label class="md-nav__link" for="__nav_5_5_7_8" id="__nav_5_5_7_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Realtime
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_5_5_7_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_5_7_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Realtime
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/Linux/realtime/realtime.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Real Time Linux (RT)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_5_8" >
        
          
          <label class="md-nav__link" for="__nav_5_5_8" id="__nav_5_5_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Socket
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_5_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_5_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Socket
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/socket/napi.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    New API (NAPI)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/socket/socket_struct.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Socket structures
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/socket/tcp_queue_summary.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    TCP queues
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/socket/tcp_recv_mem.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Summary
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_5_8_5" >
        
          
          <label class="md-nav__link" for="__nav_5_5_8_5" id="__nav_5_5_8_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Select poll epoll
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_5_5_8_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_5_8_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Select poll epoll
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/socket/select_poll_epoll/epoll.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    EPoll
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/socket/select_poll_epoll/epoll_implementation.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Epoll Implementation Detail
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/socket/select_poll_epoll/nginx_epoll_study.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Nginx epoll study
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/socket/select_poll_epoll/poll.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Socket Poll
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/socket/select_poll_epoll/select.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Socket Select
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/socket/select_poll_epoll/summary.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Summary
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_5_8_6" >
        
          
          <label class="md-nav__link" for="__nav_5_5_8_6" id="__nav_5_5_8_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Socket proc
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_5_5_8_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_5_8_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Socket proc
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/socket/socket_proc/accept.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Accept
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/socket/socket_proc/bind.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Bind
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/socket/socket_proc/connect.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Connect
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/socket/socket_proc/listen.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Listen
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/socket/socket_proc/recv_byNIC.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    TCP recv from NIC
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/socket/socket_proc/recv_byUser.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Recv from user
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/socket/socket_proc/send.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Connect
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/socket/socket_proc/socket.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Socket
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../fundamental_computer/operating_sys/socket/socket_proc/summary.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Summary
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" checked>
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Math
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Math
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1" >
        
          
          <label class="md-nav__link" for="__nav_6_1" id="__nav_6_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Ai
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Ai
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1_1" >
        
          
          <label class="md-nav__link" for="__nav_6_1_1" id="__nav_6_1_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Audio
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_1_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Audio
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/audio/audio_freq.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Audio Frequency Explained
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/audio/text_and_audio.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Text and Audio
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1_2" >
        
          
          <label class="md-nav__link" for="__nav_6_1_2" id="__nav_6_1_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Cv
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_1_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Cv
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/cv/epilolar_geo.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Epipolar geometry
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/cv/homography.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Homography
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/cv/paddleocr.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Paddle OCR (Optical Character Recognition)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/cv/shader.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Shader
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/cv/triangulation.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Triangulation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1_2_6" >
        
          
          <label class="md-nav__link" for="__nav_6_1_2_6" id="__nav_6_1_2_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Camera
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_6_1_2_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_1_2_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Camera
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/cv/camera/camera_setup.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Stereo Camera Calibration and Rectification
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/cv/camera/camera_types.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Camera Types
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/cv/camera/light_and_lens.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Light and Lens
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1_2_7" >
        
          
          <label class="md-nav__link" for="__nav_6_1_2_7" id="__nav_6_1_2_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Cnn
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_6_1_2_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_1_2_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Cnn
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/cv/cnn/cnn.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Convolutional Neural Network (CNN)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/cv/cnn/googlenet.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    GoogLeNet (InceptionV1)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/cv/cnn/r_cnn.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Regions with CNN (R-CNN)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/cv/cnn/resnet.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Residual neural network (ResNet)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/cv/cnn/u_net.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    U-Net
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/cv/cnn/yolo.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    You Only Look Once v3 (YOLOv3)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/cv/cnn/yolo_libtorch_code.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    YOLOv3 + Libtorch Implementation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1_2_8" >
        
          
          <label class="md-nav__link" for="__nav_6_1_2_8" id="__nav_6_1_2_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Cv basics.md
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_6_1_2_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_1_2_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Cv basics.md
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/cv/cv_basics.md/img_proc_basics.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Basic Image Process
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/cv/cv_basics.md/interpolation.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Interpolation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1_2_9" >
        
          
          <label class="md-nav__link" for="__nav_6_1_2_9" id="__nav_6_1_2_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Cv features
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_6_1_2_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_1_2_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    Cv features
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/cv/cv_features/akaze.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Akaze
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/cv/cv_features/bow.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    BoW (Bags of Words)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/cv/cv_features/canny_detector.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Canny Detector
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/cv/cv_features/harris.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Harris Operator
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/cv/cv_features/orb.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ORB (Oriented FAST and Rotated BRIEF)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/cv/cv_features/sift.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Scale-invariant feature transform (SIFT)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/cv/cv_features/surf.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SURF (Speeded-Up Robust Features)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/cv/cv_features/wavelet.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Wavelet Transform
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1_2_10" >
        
          
          <label class="md-nav__link" for="__nav_6_1_2_10" id="__nav_6_1_2_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Cv generative
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_6_1_2_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_1_2_10">
            <span class="md-nav__icon md-icon"></span>
            
  
    Cv generative
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/cv/cv_generative/clip.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Contrastive Language-Image Pre-training (CLIP)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/cv/cv_generative/controlnet.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ControlNet
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/cv/cv_generative/diffusion_model.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Diffusion Model
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/cv/cv_generative/vae.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Variational Autoencoder (VAE)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1_3" >
        
          
          <label class="md-nav__link" for="__nav_6_1_3" id="__nav_6_1_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Machine learning
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_1_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Machine learning
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/machine_learning/basics.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Basic machine learning knowledge
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/machine_learning/err_metrics.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Error Metrics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/machine_learning/high_dim_embedding.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    High Dimension Embedding
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/machine_learning/multi_task_training.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Multi-Task Training/Fine-Tuning
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/machine_learning/reinforcement_learning.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Reinforcement Learning
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1_3_6" >
        
          
          <label class="md-nav__link" for="__nav_6_1_3_6" id="__nav_6_1_3_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Deep learning
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_6_1_3_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_1_3_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Deep learning
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/machine_learning/deep_learning/activation_funcs.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Activation Functions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/machine_learning/deep_learning/compression.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Model Compression: Pruning, Distillation and Quantization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/machine_learning/deep_learning/nn.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Neural Network
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/machine_learning/deep_learning/nn_weight_init.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Model Parameter Initialization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/machine_learning/deep_learning/normalization.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Normalization in Deep Learning
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/machine_learning/deep_learning/ntk.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Neural Tangent Kernel (NTK)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/machine_learning/deep_learning/optimizer.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Optimizers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/machine_learning/deep_learning/quantization.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LLM Quantization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/machine_learning/deep_learning/rnn_and_lstm.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sequence NNs: RNN, GRU and LSTM
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/machine_learning/deep_learning/stable_training.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Stable Training Discussions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/machine_learning/deep_learning/training_rate_scheduling.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Training Rate Scheduling
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1_3_7" >
        
          
          <label class="md-nav__link" for="__nav_6_1_3_7" id="__nav_6_1_3_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Non deeplearning methods
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_6_1_3_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_1_3_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Non deeplearning methods
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/machine_learning/non_deeplearning_methods/boosting.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Boosting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/machine_learning/non_deeplearning_methods/decision_tree.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Decision Tree
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/machine_learning/non_deeplearning_methods/kmeans_and_knn.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    K-means and KNN
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/machine_learning/non_deeplearning_methods/lda.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linear Discriminant Analysis (LDA)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/machine_learning/non_deeplearning_methods/logistic_regression.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Logistic Regression
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/machine_learning/non_deeplearning_methods/markov_chain.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Markov Chain
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/machine_learning/non_deeplearning_methods/naive_bayes.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Naive Bayes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/machine_learning/non_deeplearning_methods/ransac.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Random Sample Consensus (RANSAC)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/machine_learning/non_deeplearning_methods/svm.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Support Vector Machine
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1_4" >
        
          
          <label class="md-nav__link" for="__nav_6_1_4" id="__nav_6_1_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Nlp
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_1_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Nlp
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/nlp/attention_further_details.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Attention Mechanism Further Explained
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/nlp/attention_is_all_you_need.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Attention Is All You Need
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/nlp/attention_variants.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Attention Variants
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/nlp/non_deep_learning_embeddings.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Non Deep Learning Embeddings
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/nlp/practices.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Large Language Model (LLM) Practices
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/nlp/similarity.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Text Similarity/Overlap
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/nlp/text_generation_strategies.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Text Generation Strategies
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/nlp/tokenization.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tokenization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1_4_9" >
        
          
          <label class="md-nav__link" for="__nav_6_1_4_9" id="__nav_6_1_4_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Embedding
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_6_1_4_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_1_4_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    Embedding
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/nlp/embedding/constrasive_learning.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Contrastive Learning
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/nlp/embedding/rope_emb.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Embeddings
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/nlp/embedding/semantic_emb.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Semantics/Linguistics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1_4_10" >
        
          
          <label class="md-nav__link" for="__nav_6_1_4_10" id="__nav_6_1_4_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Llm
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_6_1_4_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_1_4_10">
            <span class="md-nav__icon md-icon"></span>
            
  
    Llm
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/nlp/llm/deepseek.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DeepSeek
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/nlp/llm/inference.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LLM Inference Practices
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/nlp/llm/llm.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LLM (Large Language Model)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/nlp/llm/llm_cache.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cache in LLM
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/nlp/llm/llm_evaluation_enhancement.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LLM Evaluation Enhancement Practices
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/nlp/llm/llm_evaluations.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LLM Evaluations
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/nlp/llm/llm_frameworks.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LLM Frameworks
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/nlp/llm/long_context.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LLM Long Context Interpolation and Extrapolation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/nlp/llm/moe.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Mixture of Experts (MoEs)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1_4_10_10" >
        
          
          <label class="md-nav__link" for="__nav_6_1_4_10_10" id="__nav_6_1_4_10_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Rag
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_6_1_4_10_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_1_4_10_10">
            <span class="md-nav__icon md-icon"></span>
            
  
    Rag
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/nlp/llm/rag/adv_rag.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Advanced RAG
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/nlp/llm/rag/graph_rag.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Graph RAG
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/nlp/llm/rag/rag.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Retrieval Augmented Generation (RAG)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1_4_10_11" >
        
          
          <label class="md-nav__link" for="__nav_6_1_4_10_11" id="__nav_6_1_4_10_11_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Training and finetuning
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_6_1_4_10_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_1_4_10_11">
            <span class="md-nav__icon md-icon"></span>
            
  
    Training and finetuning
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/nlp/llm/training_and_finetuning/llm_fine_tuning_practices.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Parameter-Efficient Fine Tuning (PEFT) Practices
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/nlp/llm/training_and_finetuning/llm_full_param_finetuning.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Full Parameter Finetuning
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/nlp/llm/training_and_finetuning/llm_param_efficient_finetuning.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Parameter-Efficient Fine Tuning (PEFT)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/nlp/llm/training_and_finetuning/llm_training_practices.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Training Considerations
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/nlp/llm/training_and_finetuning/ppo.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Proximal Policy Optimization (PPO)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/nlp/llm/training_and_finetuning/rlhf.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Reinforcement Learning from Human Feedback (RLHF)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1_5" >
        
          
          <label class="md-nav__link" for="__nav_6_1_5" id="__nav_6_1_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Software
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_1_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_1_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Software
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ai/software/comfyui.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Comfy UI
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2" >
        
          
          <label class="md-nav__link" for="__nav_6_2" id="__nav_6_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Algebra
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Algebra
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/polynomial.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Polynomial
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/seires.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Series
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/sequence.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sequence
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/some_algebra.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Some Miscellaneous Algebra
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/trigonometry.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Trigonometry
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2_6" >
        
          
          <label class="md-nav__link" for="__nav_6_2_6" id="__nav_6_2_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Complex and series
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_2_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Complex and series
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/complex_and_series/calculations.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Some Calculation Practices
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/complex_and_series/complex_analysis.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Complex Analysis
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/complex_and_series/complex_aplications.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Complex Applications
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2_7" >
        
          
          <label class="md-nav__link" for="__nav_6_2_7" id="__nav_6_2_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Differential and integral
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_2_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Differential and integral
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/differential_and_integral/calculations.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Some Differential and Integral Calculations
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/differential_and_integral/differentiable_manifold.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Differentiable Manifold
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/differential_and_integral/differential_equations.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Differential equations in matrix form
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/differential_and_integral/differential_rules.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Some Differential Rules
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/differential_and_integral/integral_rules.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Some Integral Rules
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/differential_and_integral/legendre_transformation.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Legendre Transformation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/differential_and_integral/principal_curvature.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Principal Curvature
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/differential_and_integral/some_terminologies.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Terminologies in Differential and Integral
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2_7_9" >
        
          
          <label class="md-nav__link" for="__nav_6_2_7_9" id="__nav_6_2_7_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Integral approx
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_6_2_7_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2_7_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    Integral approx
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/differential_and_integral/integral_approx/gauss_hermite_quad.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    GaussHermite Quadrature
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/differential_and_integral/integral_approx/gaussian_quad.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Gaussian quadrature
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/differential_and_integral/integral_approx/lagrange_interpolation.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lagrange Interpolation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/differential_and_integral/integral_approx/legendre_poly.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Legendre polynomials
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/differential_and_integral/integral_approx/riemann_sum.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Riemann sum
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/differential_and_integral/integral_approx/stone_weierstrass.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    StoneWeierstrass theorem
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/differential_and_integral/integral_approx/taylor_polynomials.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Approximating Integrals using Taylor Polynomials
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2_8" >
        
          
          <label class="md-nav__link" for="__nav_6_2_8" id="__nav_6_2_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Linear algebra
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_2_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Linear algebra
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2_8_1" >
        
          
          <label class="md-nav__link" for="__nav_6_2_8_1" id="__nav_6_2_8_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Matrix
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_6_2_8_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2_8_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Matrix
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/linear_algebra/matrix/linear_transform_intuition.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linear Transform Intuition
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/linear_algebra/matrix/matrix.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Some Matrix Types
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/linear_algebra/matrix/matrix_adv.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    More Matrix Knowledge
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/linear_algebra/matrix/matrix_decomp.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Matrix Decomposition
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/linear_algebra/matrix/matrix_derivative.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Matrix Derivative
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/linear_algebra/matrix/matrix_norm.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Matrix Norms
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/linear_algebra/matrix/matrix_ops_rules.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Matrix/vector Multiplication and Derivative Rules
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/linear_algebra/matrix/positive_definite_mat.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Positive-definite matrix
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/linear_algebra/matrix/skew_mat.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Skew Symmetric
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/linear_algebra/matrix/svd.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Singular Value Decomposition (SVD)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2_8_2" >
        
          
          <label class="md-nav__link" for="__nav_6_2_8_2" id="__nav_6_2_8_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Vector
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_6_2_8_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2_8_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Vector
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/linear_algebra/vector/vector.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Vector
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/linear_algebra/vector/vector_field.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Vector Field
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/linear_algebra/vector/vector_norm.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Vector Normalization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/linear_algebra/vector/vector_products.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Products: dot, cross and exterior
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2_9" >
        
          
          <label class="md-nav__link" for="__nav_6_2_9" id="__nav_6_2_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Optimization
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_2_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    Optimization
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2_9_1" >
        
          
          <label class="md-nav__link" for="__nav_6_2_9_1" id="__nav_6_2_9_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Approaches
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_6_2_9_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2_9_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Approaches
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/optimization/approaches/expectation_maximization.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Expectation Maximization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/optimization/approaches/lagrange_multipliers.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lagrangian Multiplier
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/optimization/approaches/primal_dual.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Primal-Dual Algorithm
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2_9_1_4" >
        
          
          <label class="md-nav__link" for="__nav_6_2_9_1_4" id="__nav_6_2_9_1_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Bio inspired
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_6_2_9_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2_9_1_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Bio inspired
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/optimization/approaches/bio_inspired/ant_colony.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Ant colony
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/optimization/approaches/bio_inspired/gene.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Gene
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/optimization/approaches/bio_inspired/pso.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Particle Swarm Optimization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2_9_1_5" >
        
          
          <label class="md-nav__link" for="__nav_6_2_9_1_5" id="__nav_6_2_9_1_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Iterative gradients
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_6_2_9_1_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2_9_1_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Iterative gradients
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/optimization/approaches/iterative_gradients/conjugate_gradient.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Conjugate Gradient
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/optimization/approaches/iterative_gradients/dogleg.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Powell's Dogleg Method
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/optimization/approaches/iterative_gradients/gauss_newton.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Gauss-Newton Method
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/optimization/approaches/iterative_gradients/gradient_descent.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Gradient Descent
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/optimization/approaches/iterative_gradients/levenberg_marquardt.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Levenberg-Marquardt's Method
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/optimization/approaches/iterative_gradients/newton.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Newton's Method
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/optimization/approaches/iterative_gradients/powell_conjugate_direction.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Powell's Conjugate Direction Method
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/optimization/approaches/iterative_gradients/runge_kutta.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Runge-Kutta
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/optimization/approaches/iterative_gradients/summary.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Summary of various methods
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2_9_2" >
        
          
          <label class="md-nav__link" for="__nav_6_2_9_2" id="__nav_6_2_9_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Problem statements
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_6_2_9_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2_9_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Problem statements
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/optimization/problem_statements/convex.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Convex Optimization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/optimization/problem_statements/dp.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dynamic Programming
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/optimization/problem_statements/graph_optimization.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Graph Optimization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/optimization/problem_statements/least_squares.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Least Squares Problem
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/optimization/problem_statements/max_likelihood_est.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Maximum Likelihood Estimation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/optimization/problem_statements/qp.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quadratic Programming
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/optimization/problem_statements/regularization.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Regularization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/optimization/problem_statements/saddle_point_and_hessian.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Saddle Points and Hessian in Optimization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2_10" >
        
          
          <label class="md-nav__link" for="__nav_6_2_10" id="__nav_6_2_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Stats and probability
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_2_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2_10">
            <span class="md-nav__icon md-icon"></span>
            
  
    Stats and probability
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/stats_and_probability/baysian.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Bayes' Theorem
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/stats_and_probability/inferential_stats.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Inferential Statistics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/stats_and_probability/information.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Information
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/stats_and_probability/riddles.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Probability, Combination and Permutation Riddles
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/stats_and_probability/stats_evaluation.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Evaluation Metrics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2_10_6" >
        
          
          <label class="md-nav__link" for="__nav_6_2_10_6" id="__nav_6_2_10_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Distribution
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_6_2_10_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2_10_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Distribution
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/stats_and_probability/distribution/chi_squared_dist.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chi-Squared Distribution () and Tests
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/stats_and_probability/distribution/distribution.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Distribution
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/stats_and_probability/distribution/miltinomial_dist.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Multinomial Distribution
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/stats_and_probability/distribution/normal_dist.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Normal Distribution
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/stats_and_probability/distribution/poisson_dist.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Poisson Distribution
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/stats_and_probability/distribution/t_dist.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    T Distribution
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2_10_7" >
        
          
          <label class="md-nav__link" for="__nav_6_2_10_7" id="__nav_6_2_10_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Random process
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_6_2_10_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2_10_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Random process
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/stats_and_probability/random_process/bernoulli_process.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Bernoulli process
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/stats_and_probability/random_process/gaussian_process.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Gaussian Process
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/stats_and_probability/random_process/ornstein_uhlenbeck_process.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Ornstein-Uhlenbeck (OU) Process
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/stats_and_probability/random_process/poisson_process.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Poisson Process
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/stats_and_probability/random_process/random_process.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Random/Stochastic Process
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/stats_and_probability/random_process/random_walk.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Random Walk
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/stats_and_probability/random_process/wiener_process.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Wiener Process  (Brownian Motion )
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3" >
        
          
          <label class="md-nav__link" for="__nav_6_3" id="__nav_6_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Finance
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Finance
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3_1" >
        
          
          <label class="md-nav__link" for="__nav_6_3_1" id="__nav_6_3_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Eco law fin knowledge
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_3_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Eco law fin knowledge
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../finance/eco_law_fin_knowledge/commercial_banking.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Commercial Banking for Business
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../finance/eco_law_fin_knowledge/derivatives.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Derivative
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../finance/eco_law_fin_knowledge/eco_law_fin_basics.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Economics, Law and Finance Concepts
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../finance/eco_law_fin_knowledge/equities.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Equities
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../finance/eco_law_fin_knowledge/ficc.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Fixed Income, Currencies and Commodities (FICC)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../finance/eco_law_fin_knowledge/investment_banking.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Investment Banking
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../finance/eco_law_fin_knowledge/legal.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Legal and Regulations
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3_2" >
        
          
          <label class="md-nav__link" for="__nav_6_3_2" id="__nav_6_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Financing
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_3_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Financing
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../finance/financing/bond.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Bond
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../finance/financing/bond_yield_modeling.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    bond Yield Modeling
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../finance/financing/financing_by_bonds_and_loans.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Financing ()
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../finance/financing/financing_interest_rate.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Financing Interest Rates
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../finance/financing/loan.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Loan
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../finance/financing/repo.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Repurchase Agreement (REPO, /)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../finance/financing/repo_practices.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Repurchase Agreement (REPO) Practices
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../finance/financing/repo_risks.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Repurchase Agreement (REPO) Risks
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../finance/financing/triparty.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Custodian and Triparty
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3_3" >
        
          
          <label class="md-nav__link" for="__nav_6_3_3" id="__nav_6_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Quant
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_3_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Quant
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../finance/quant/alphas.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Alphas: The Excess Return
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../finance/quant/barra_risk.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Barra Risk Factor Analysis
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../finance/quant/fix.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Financial Information eXchange (FIX)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../finance/quant/hft_cpp_tricks.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    High Frequency Trading C++ Tricks
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../finance/quant/hkex_derivative_realtime_data_access.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    HKEX Orion Market Data Platform for Derivatives (OMD-D)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../finance/quant/quant_trading.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quantitative Trading Basics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../finance/quant/risks.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Risks
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3_4" >
        
          
          <label class="md-nav__link" for="__nav_6_3_4" id="__nav_6_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Structured products
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_3_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Structured products
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../finance/structured_products/black_scholes.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Black scholes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../finance/structured_products/structured_product_rfq.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Structured product rfq
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../finance/structured_products/structured_products.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Structured Products
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_4" >
        
          
          <label class="md-nav__link" for="__nav_6_4" id="__nav_6_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Mechanics
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Mechanics
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../mechanics/3d_printing.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    3d printing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_5" checked>
        
          
          <label class="md-nav__link" for="__nav_6_5" id="__nav_6_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Slam
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Slam
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lidar_camera_calibration.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lidar Camera Calibration and Simple Fusion
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../personal_projects.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Some Personal Projects
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ros.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ROS
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_5_4" >
        
          
          <label class="md-nav__link" for="__nav_6_5_4" id="__nav_6_5_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Control
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_5_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Control
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../control/fuzzy_control.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Fuzzy Control
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../control/kalman_filter.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Kalman Filter
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../control/kalman_filter_nonlinear.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Kalman filters for non-linear problems
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../control/lqr.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LQR (Linear Quadratic Regulator)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../control/mpc.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Model Predictive Control (MPC)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../control/state_estimation.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    State Estimation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_5_4_7" >
        
          
          <label class="md-nav__link" for="__nav_6_5_4_7" id="__nav_6_5_4_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Imu
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_6_5_4_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_5_4_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Imu
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../control/imu/imu_noise_calibration.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IMU
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../control/imu/imu_preintegration.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Pre-integration in IMU
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_5_4_8" >
        
          
          <label class="md-nav__link" for="__nav_6_5_4_8" id="__nav_6_5_4_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Kinematics
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_6_5_4_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_5_4_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Kinematics
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../control/kinematics/affine_trans.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Affine Transform
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../control/kinematics/homogeneous_trans.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Homogeneous Transformation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../control/kinematics/physics.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Physics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../control/kinematics/quaternion.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quaternion
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../control/kinematics/rotation.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Rotation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../control/kinematics/sim3.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Similar Transform Group \(Sim(3)\) and \(sim(3)\)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_5_4_8_7" >
        
          
          <label class="md-nav__link" for="__nav_6_5_4_8_7" id="__nav_6_5_4_8_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Lie group and algebra
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_6_5_4_8_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_5_4_8_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Lie group and algebra
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../control/kinematics/lie_group_and_algebra/lie_and_robotics.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lie and Robotics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../control/kinematics/lie_group_and_algebra/lie_bracket.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lie Bracket
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../control/kinematics/lie_group_and_algebra/lie_group_and_algebra.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lie Algebra and Group
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../control/kinematics/lie_group_and_algebra/verification_proof.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lie Group and Lie Algebra Proof for \(SO(3)\), \(SE(3)\), and \(Sim(3)\)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_5_5" >
        
          
          <label class="md-nav__link" for="__nav_6_5_5" id="__nav_6_5_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Lidar slam
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_5_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_5_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Lidar slam
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lidar_slam/amcl.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lidar Localization - AMCL Adaptive Monte Carlo Localization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lidar_slam/amcl_code.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AMCL Implementation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lidar_slam/google_cart.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lidar Mapping Google Cartographer
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lidar_slam/google_cart_code.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Google Cartographer Code
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lidar_slam/icp.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Iterative Closest Point (ICP)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lidar_slam/lidar_hardware.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lidar hardware
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lidar_slam/loam.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LOAM: Lidar Odometry and Mapping
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lidar_slam/loam_code.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LOAM (Lidar Odometry and Mapping) Implementation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lidar_slam/ndt.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Normal Distribution Transform (NDT)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lidar_slam/particle_filters.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Particle Filter
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lidar_slam/pcl.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Point Cloud Library (PCL)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_5_6" >
        
          
          <label class="md-nav__link" for="__nav_6_5_6" id="__nav_6_5_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Path
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_5_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_5_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Path
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../path/aStar_and_dStar.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    A and D Global Path Planning
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../path/curves.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Curves
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../path/dwa_local_planning.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dynamic Window Approach to Collision Avoidance
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../path/em_planner.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    EM (Expectation-Maximization) Path Planner
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../path/lattice.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lattice Motion Planning
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../path/loop_closure.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Loop Closure
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../path/rrt.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Rapidly-exploring Random Tree (RRT)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../path/teb_local_planning.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Timed Elastic Band
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../path/tracking_basics.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Vehicle Properties/Measurements to Road/Track
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_5_7" checked>
        
          
          <label class="md-nav__link" for="__nav_6_5_7" id="__nav_6_5_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Vslam
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_5_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6_5_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Vslam
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../bundle_adjustment_basics.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Bundle Adjustment
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../bundle_adjustment_optimization.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Bundle Adjustment Optimization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lucas_kanade_tracking.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lucas-Kanade Tracking
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../optical_flow.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Optical Flow
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pnp.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    PnP (Perspective-n-Point)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_5_7_6" checked>
        
          
          <label class="md-nav__link" for="__nav_6_5_7_6" id="__nav_6_5_7_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Dense reconstruction
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_6_5_7_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6_5_7_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Dense reconstruction
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="bevformer.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Bevformer
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="dense_reconstruction.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dense Reconstruction/Structure from Motion (SfM)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="dtam.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Direct Tracking and Mapping (DTAM)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="lsd.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LSD-SLAM: Large-Scale Direct Monocular SLAM
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="orbslam.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ORB-SLAM: a Versatile and Accurate Monocular SLAM System
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    ORB SLAM Source Code Review
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="orbslam_code.html" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    ORB SLAM Source Code Review
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#start" class="md-nav__link">
    <span class="md-ellipsis">
      
        Start
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Start">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-main" class="md-nav__link">
    <span class="md-ellipsis">
      
        The main()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-system-orb_slam2system" class="md-nav__link">
    <span class="md-ellipsis">
      
        The System ORB_SLAM2::System
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#frame-and-keyframe" class="md-nav__link">
    <span class="md-ellipsis">
      
        Frame and Keyframe
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Frame and Keyframe">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#frame" class="md-nav__link">
    <span class="md-ellipsis">
      
        Frame
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#keyframe" class="md-nav__link">
    <span class="md-ellipsis">
      
        Keyframe
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#keyframe-co-visibility" class="md-nav__link">
    <span class="md-ellipsis">
      
        Keyframe Co-Visibility
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#connected-keyframes-vs-co-visibility-keyframes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Connected Keyframes vs Co-Visibility Keyframes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spanning-tree-and-essential-graph" class="md-nav__link">
    <span class="md-ellipsis">
      
        Spanning Tree and Essential Graph
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#orb-extractor" class="md-nav__link">
    <span class="md-ellipsis">
      
        ORB Extractor
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ORB Extractor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fast-feature-orientation" class="md-nav__link">
    <span class="md-ellipsis">
      
        FAST Feature Orientation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#orb-feature-pair-test" class="md-nav__link">
    <span class="md-ellipsis">
      
        ORB Feature Pair Test
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#octree-for-orb-feature" class="md-nav__link">
    <span class="md-ellipsis">
      
        Octree For ORB Feature
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#orb-feature-computation" class="md-nav__link">
    <span class="md-ellipsis">
      
        ORB Feature Computation
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#orb-feature-matcher" class="md-nav__link">
    <span class="md-ellipsis">
      
        ORB Feature Matcher
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ORB Feature Matcher">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#search-by-projection" class="md-nav__link">
    <span class="md-ellipsis">
      
        Search By Projection
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#search-by-bow" class="md-nav__link">
    <span class="md-ellipsis">
      
        Search By BoW
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#search-by-sim3" class="md-nav__link">
    <span class="md-ellipsis">
      
        Search By \(Sim(3)\)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#local-pose-graph-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Local Pose Graph Optimization
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Local Pose Graph Optimization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#optimizerposeoptimizationframe-pframe" class="md-nav__link">
    <span class="md-ellipsis">
      
        Optimizer::PoseOptimization(Frame *pFrame)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compute-f" class="md-nav__link">
    <span class="md-ellipsis">
      
        Compute \(F\)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monocular-mapping-initialization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Monocular Mapping Initialization
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sim3-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      
        \(Sim(3)\) Optimization
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="\(Sim(3)\) Optimization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#solve-sim3-by-closed-form-solution-of-absolute-orientation-using-unit-quaternions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Solve \(Sim(3)\) by Closed-form Solution of Absolute Orientation Using Unit Quaternions
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#feature-tracking" class="md-nav__link">
    <span class="md-ellipsis">
      
        Feature Tracking
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Feature Tracking">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#constructor" class="md-nav__link">
    <span class="md-ellipsis">
      
        Constructor
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#systemtrackmonocular" class="md-nav__link">
    <span class="md-ellipsis">
      
        System::TrackMonocular
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tracking" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tracking
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bundle-adjustment" class="md-nav__link">
    <span class="md-ellipsis">
      
        Bundle Adjustment
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Bundle Adjustment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#global-bundle-adjustment" class="md-nav__link">
    <span class="md-ellipsis">
      
        Global Bundle Adjustment
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#map-point-normal-and-depth-update" class="md-nav__link">
    <span class="md-ellipsis">
      
        Map Point Normal And Depth Update
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#local-bundle-adjustment" class="md-nav__link">
    <span class="md-ellipsis">
      
        Local Bundle Adjustment
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#local-mapping" class="md-nav__link">
    <span class="md-ellipsis">
      
        Local Mapping
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#loop-closure" class="md-nav__link">
    <span class="md-ellipsis">
      
        Loop Closure
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Loop Closure">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#detectloop" class="md-nav__link">
    <span class="md-ellipsis">
      
        DetectLoop()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#computesim3" class="md-nav__link">
    <span class="md-ellipsis">
      
        ComputeSim3()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#correctloop" class="md-nav__link">
    <span class="md-ellipsis">
      
        CorrectLoop()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#essentail-graph-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Essentail Graph Optimization
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="ptam.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Parallel Tracking and Mapping (PTAM)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="svo.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SVO: Fast Semi-Direct Monocular Visual Odometry
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="vins.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    VINS-Mono: A Robust and Versatile Monocular Visual-Inertial State Estimator
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="vins_code.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    VINS SLAM Source Code Review
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_5_7_7" >
        
          
          <label class="md-nav__link" for="__nav_6_5_7_7" id="__nav_6_5_7_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Examples
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_6_5_7_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_5_7_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Examples
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/ceres.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Ceres Optimization Tools
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Mgt and design
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Mgt and design
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mgt_and_design/ITOfficeConcepts.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Some Concepts
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_2" >
        
          
          <label class="md-nav__link" for="__nav_7_2" id="__nav_7_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    UML
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    UML
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mgt_and_design/UML/UML.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    UML (Unified Modeling Language)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_3" >
        
          
          <label class="md-nav__link" for="__nav_7_3" id="__nav_7_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Creational design patterns
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Creational design patterns
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_3_1" >
        
          
          <label class="md-nav__link" for="__nav_7_3_1" id="__nav_7_3_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Builder
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_3_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Builder
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mgt_and_design/creational_design_patterns/builder/builder.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Builder
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_3_2" >
        
          
          <label class="md-nav__link" for="__nav_7_3_2" id="__nav_7_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Factory
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_3_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Factory
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mgt_and_design/creational_design_patterns/factory/factory.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Factory
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_3_3" >
        
          
          <label class="md-nav__link" for="__nav_7_3_3" id="__nav_7_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Prototype
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_3_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Prototype
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mgt_and_design/creational_design_patterns/prototype/prototype.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Prototype
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_3_4" >
        
          
          <label class="md-nav__link" for="__nav_7_3_4" id="__nav_7_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Proxy
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_3_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Proxy
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mgt_and_design/creational_design_patterns/proxy/proxy.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Proxy Design
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_3_5" >
        
          
          <label class="md-nav__link" for="__nav_7_3_5" id="__nav_7_3_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Singleton
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_3_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Singleton
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mgt_and_design/creational_design_patterns/singleton/singleton.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Singleton
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_4" >
        
          
          <label class="md-nav__link" for="__nav_7_4" id="__nav_7_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Project management
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Project management
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mgt_and_design/project_management/DesignThinking.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Design Thinking
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mgt_and_design/project_management/Test.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tests in Project Management
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mgt_and_design/project_management/agile.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Agile
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mgt_and_design/project_management/complex_system_naming_convention.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Complex System Naming Convention
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mgt_and_design/project_management/okr.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    OKR
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_5" >
        
          
          <label class="md-nav__link" for="__nav_7_5" id="__nav_7_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    System design
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    System design
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mgt_and_design/system_design/FST_HFSM.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Behavior Tree (BT) and Hierarchical Finite State Machine (HFSM)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mgt_and_design/system_design/genai_design.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Enterprise Generative AI (NLP) Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mgt_and_design/system_design/microservice.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Microservice
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mgt_and_design/system_design/obj_oriented_programming.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Four Concepts of Object Oriented Programming
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mgt_and_design/system_design/system_design.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    System Design
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mgt_and_design/system_design/web_server_system_design.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    System Design: High-Performance Web Server System
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Network
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Network
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../network/http_headers.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    HTTP Headers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../network/networks.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Network Knowledge
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_3" >
        
          
          <label class="md-nav__link" for="__nav_8_3" id="__nav_8_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Blockchain
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Blockchain
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../network/blockchain/asset_tokenization.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Asset Tokenization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../network/blockchain/blockchain.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Blockchain
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../network/blockchain/corda.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    R3's Corda
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../network/blockchain/etherum.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Ethereum
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../network/blockchain/quorum.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    JP Morgans Quorum
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_3_6" >
        
          
          <label class="md-nav__link" for="__nav_8_3_6" id="__nav_8_3_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Examples
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_8_3_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_3_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Examples
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_3_6_1" >
        
          
          <label class="md-nav__link" for="__nav_8_3_6_1" id="__nav_8_3_6_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Ethereum
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_8_3_6_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_3_6_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Ethereum
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_3_6_1_1" >
        
          
          <label class="md-nav__link" for="__nav_8_3_6_1_1" id="__nav_8_3_6_1_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Smart contract
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_8_3_6_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_3_6_1_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Smart contract
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_3_6_1_1_1" >
        
          
          <label class="md-nav__link" for="__nav_8_3_6_1_1_1" id="__nav_8_3_6_1_1_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Nft
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="6" aria-labelledby="__nav_8_3_6_1_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_3_6_1_1_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Nft
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../network/blockchain/examples/ethereum/smart_contract/nft/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Make NFT Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_3_6_1_1_2" >
        
          
          <label class="md-nav__link" for="__nav_8_3_6_1_1_2" id="__nav_8_3_6_1_1_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Yuqi coin
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="6" aria-labelledby="__nav_8_3_6_1_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_3_6_1_1_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Yuqi coin
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../network/blockchain/examples/ethereum/smart_contract/yuqi_coin/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    YuqiCoin Demo
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_3_6_2" >
        
          
          <label class="md-nav__link" for="__nav_8_3_6_2" id="__nav_8_3_6_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Tcn
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_8_3_6_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_3_6_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Tcn
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../network/blockchain/examples/tcn/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tokenized Collateral Network - DvP Trading Simulation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_4" >
        
          
          <label class="md-nav__link" for="__nav_8_4" id="__nav_8_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Message queue
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Message queue
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../network/message_queue/dpdk.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Data Plane Development Kit (DPDK)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../network/message_queue/dpdk_apis.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Useful DPDK APIs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../network/message_queue/dpdk_udp_epoll.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Data Plane Development Kit (DPDK), UDP and EPoll
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../network/message_queue/kafka.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Kafka
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../network/message_queue/message_queue.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Message Queue
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../network/message_queue/packet_transmission_analysis.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    TCP/UDP Packet Treansmission Analysis
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../network/message_queue/zero_mq.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Example Framework: ZeroMQ
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_5" >
        
          
          <label class="md-nav__link" for="__nav_8_5" id="__nav_8_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Multi media
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Multi media
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../network/multi-media/hologram.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Hologram
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../network/multi-media/mp4.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Video and Audio
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_6" >
        
          
          <label class="md-nav__link" for="__nav_8_6" id="__nav_8_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Security
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Security
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../network/security/access_mgt.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Access Management
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../network/security/authentication.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Authentication Methods
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../network/security/common_hacks.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cyber Security
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../network/security/ssh.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SSH (Secure Shell)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../network/security/terminologies.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Some Terminologies
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_6_6" >
        
          
          <label class="md-nav__link" for="__nav_8_6_6" id="__nav_8_6_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Certs and keys
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_8_6_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_6_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Certs and keys
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../network/security/certs_and_keys/certificate.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Certificate
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../network/security/certs_and_keys/certificate_gen_walkthrough.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cert generation example
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../network/security/certs_and_keys/diff_file_extensions.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Different File Extensions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../network/security/certs_and_keys/secure_tunneling.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Secure Tunneling
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_7" >
        
          
          <label class="md-nav__link" for="__nav_8_7" id="__nav_8_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Server
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Server
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../network/server/server_softwares.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Some Server Softwares
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../network/server/social_app_server.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Some Considerations about A Social App Server
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../network/server/web_concepts_and_software.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Some Web Concepts
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_8" >
        
          
          <label class="md-nav__link" for="__nav_8_8" id="__nav_8_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Tcpip
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Tcpip
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../network/tcpip/data_communication.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Data Communication
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../network/tcpip/tcp_packet.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    TCP/IP
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../network/tcpip/udp.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    User Datagram Protocol (UDP)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../network/tcpip/websocket.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Websocket
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_9" >
        
          
          <label class="md-nav__link" for="__nav_8_9" id="__nav_8_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Web crawling
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    Web crawling
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../network/web_crawling/web_crawling.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Web Crawling
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Programming
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    Programming
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1" >
        
          
          <label class="md-nav__link" for="__nav_9_1" id="__nav_9_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Cpp
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_9_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Cpp
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/asm.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ASM (Assembly)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_2" >
        
          
          <label class="md-nav__link" for="__nav_9_1_2" id="__nav_9_1_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Async and threading
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Async and threading
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/async_and_threading/cache_sharing_coherence.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CPU Cache Sharing Coherence and Memory Model
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/async_and_threading/coroutine.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Coroutine
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/async_and_threading/coroutine_practices.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Coroutine Practices
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/async_and_threading/multi_threads_and_procs.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Multi Threads and Processes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/async_and_threading/mutex.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Mutex Under the Hood
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/async_and_threading/remote_procedure_call.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Remote Procedure Call (RPC)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/async_and_threading/semaphore.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Semaphore
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_2_8" >
        
          
          <label class="md-nav__link" for="__nav_9_1_2_8" id="__nav_9_1_2_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Concurrency
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_9_1_2_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1_2_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Concurrency
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/async_and_threading/concurrency/async.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Async
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/async_and_threading/concurrency/concurrency.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Concurrency
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/async_and_threading/concurrency/hardware_concurrency.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Thread Hardware Concurrency
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_3" >
        
          
          <label class="md-nav__link" for="__nav_9_1_3" id="__nav_9_1_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Ctor dtor gc
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Ctor dtor gc
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/ctor_dtor_gc/RAII.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Resource Acquisition Is Initialization (RAII)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/ctor_dtor_gc/ctor_dtor_gc.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Garbage Collection, Constructor and Destructor
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/ctor_dtor_gc/five_ctors.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Constructor Types
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/ctor_dtor_gc/global_objs.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Global Objects
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/ctor_dtor_gc/initialization.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Initialization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/ctor_dtor_gc/virtual_methods.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Virtual functions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/ctor_dtor_gc/virtual_perf.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Virtual Method Performance
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/ctor_dtor_gc/virtual_tbl_and_inheritance.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Virtual Table and Inheritance
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_4" >
        
          
          <label class="md-nav__link" for="__nav_9_1_4" id="__nav_9_1_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Meta programming
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Meta programming
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/meta_programming/cast.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cast and conversion
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/meta_programming/conccept_and_requires.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Concept and Requires (since C++20)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/meta_programming/crtp.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Curiously Recurring Template Pattern (CRTP)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/meta_programming/meta_programming.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Meta Programming
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/meta_programming/overload_override_overwrite.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    overload, override, overwrite
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/meta_programming/preprocessing.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Preprocessing work
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/meta_programming/sfinae.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Substitution Failure Is Not An Error (SFINAE)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/meta_programming/template_deduction.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Template
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_5" >
        
          
          <label class="md-nav__link" for="__nav_9_1_5" id="__nav_9_1_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Misc
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_1_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Misc
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/misc/compilation_flags.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Some Compilation Flags
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/misc/const.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Const
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/misc/cpp_misc.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Some C++ Knowledge
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/misc/cpp_misc_adv.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Some C++ Advanced Knowledge
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/misc/exception.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Exception handling
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/misc/functions.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Functions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/misc/personal_difficult_practices.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Personal Encountered Difficult Practices
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/misc/practice_tips.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Some Practice Tips
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_5_9" >
        
          
          <label class="md-nav__link" for="__nav_9_1_5_9" id="__nav_9_1_5_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Debug
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_9_1_5_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1_5_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    Debug
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/misc/debug/debug.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Debug
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_5_10" >
        
          
          <label class="md-nav__link" for="__nav_9_1_5_10" id="__nav_9_1_5_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Sdk making
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_9_1_5_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1_5_10">
            <span class="md-nav__icon md-icon"></span>
            
  
    Sdk making
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/misc/sdk_making/make_sdk.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Make a c++ SDK
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_5_11" >
        
          
          <label class="md-nav__link" for="__nav_9_1_5_11" id="__nav_9_1_5_11_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Testing
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_9_1_5_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1_5_11">
            <span class="md-nav__icon md-icon"></span>
            
  
    Testing
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/misc/testing/google_benchmark.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Google Benchmark
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/misc/testing/google_test.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    GoogleTest
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_6" >
        
          
          <label class="md-nav__link" for="__nav_9_1_6" id="__nav_9_1_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Optimization
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_1_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Optimization
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/optimization/branch_prediction.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Branch Prediction
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/optimization/compiler_optimization.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Optimization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/optimization/cpu_affinity_isolcpu.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Processor Affinity and CPU Isolation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/optimization/instrusive.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Intrusive and non-intrusive containers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/optimization/practices.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Common optimization practices
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/optimization/simd.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SIMD
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_6_7" >
        
          
          <label class="md-nav__link" for="__nav_9_1_6_7" id="__nav_9_1_6_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Cuda
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_9_1_6_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1_6_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Cuda
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/optimization/cuda/cuda.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CUDA
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/optimization/cuda/cuda_practices.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CUDA practices
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/optimization/cuda/gemm.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    GEMM (General Matrix Multiplication)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_6_8" >
        
          
          <label class="md-nav__link" for="__nav_9_1_6_8" id="__nav_9_1_6_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Memory
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_9_1_6_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1_6_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Memory
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/optimization/memory/allocator.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Allocator
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/optimization/memory/atomicity.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Atomicity
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/optimization/memory/cache.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cache
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/optimization/memory/memory_things.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Something About Memory
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/optimization/memory/shared_mem_for_ipc.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Shared Memory for Inter-Process Communication (IPC)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_6_9" >
        
          
          <label class="md-nav__link" for="__nav_9_1_6_9" id="__nav_9_1_6_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Thread pool
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_9_1_6_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1_6_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    Thread pool
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/optimization/thread_pool/thread_pool.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Thread Pool
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_6_10" >
        
          
          <label class="md-nav__link" for="__nav_9_1_6_10" id="__nav_9_1_6_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Vtune profiling
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_9_1_6_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1_6_10">
            <span class="md-nav__icon md-icon"></span>
            
  
    Vtune profiling
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/optimization/vtune_profiling/vtune_profiling.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    VTune
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_7" >
        
          
          <label class="md-nav__link" for="__nav_9_1_7" id="__nav_9_1_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Ref and ptr
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_1_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Ref and ptr
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/ref_and_ptr/lvalue_rvalue.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Rvalue vs Lvalue
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/ref_and_ptr/lvalue_rvalue_performance.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lvalue vs Rvalue Performance
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/ref_and_ptr/pointer.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Pointers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/ref_and_ptr/reference.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Reference
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/ref_and_ptr/smart_ptr.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Smart Pointer's Realization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_8" >
        
          
          <label class="md-nav__link" for="__nav_9_1_8" id="__nav_9_1_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Stl
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_1_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Stl
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/stl/algo.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    STL Algo
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/stl/conditional.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Conditional
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/stl/container.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    STL
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/stl/ptr_and_ref.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    STL Pointer and Reference
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/cpp/stl/thread_safety.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    STL Thread Safety
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_2" >
        
          
          <label class="md-nav__link" for="__nav_9_2" id="__nav_9_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Java
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_9_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Java
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/java/containers.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Java Primitives and Containers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/java/java_advanced.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Some Advanced JAVA Topics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/java/java_oop.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Java OOP (Object Oriented Programming)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/java/java_useful_pkgs.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Java Useful Packages
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/java/jvm.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Java Virtual Machine
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/java/maven.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Maven
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/java/mq.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    MQ (Message Queue)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/java/multi_threading.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Java Concurrency
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/java/practices.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Java Practices
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_2_10" >
        
          
          <label class="md-nav__link" for="__nav_9_2_10" id="__nav_9_2_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Java related languages
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_2_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_2_10">
            <span class="md-nav__icon md-icon"></span>
            
  
    Java related languages
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/java/java_related_languages/gradle.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Gradle
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/java/java_related_languages/groovy.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Groovy Basics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/java/java_related_languages/kotlin.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Kotlin
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/java/java_related_languages/scala.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Scala
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_2_11" >
        
          
          <label class="md-nav__link" for="__nav_9_2_11" id="__nav_9_2_11_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Obj oriented programming
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_2_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_2_11">
            <span class="md-nav__icon md-icon"></span>
            
  
    Obj oriented programming
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/java/obj_oriented_programming/OOP_basics.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Some Basic OOP Concepts
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/java/obj_oriented_programming/design_pattern.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Something about Design
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_2_12" >
        
          
          <label class="md-nav__link" for="__nav_9_2_12" id="__nav_9_2_12_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Servlet
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_2_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_2_12">
            <span class="md-nav__icon md-icon"></span>
            
  
    Servlet
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/java/servlet/rest_api.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    REST API
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/java/servlet/servlet.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Servlet
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/java/servlet/tomcat.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tomcat
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/java/servlet/tomcat_and_servlet.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tomcat and Servlet
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_2_13" >
        
          
          <label class="md-nav__link" for="__nav_9_2_13" id="__nav_9_2_13_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Spring
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_2_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_2_13">
            <span class="md-nav__icon md-icon"></span>
            
  
    Spring
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/java/spring/api_mgt.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    API Hosting For External Use
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/java/spring/dao.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DAO (Data Access Object)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/java/spring/spring.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Spring
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/java/spring/spring_enterprise_project_arch.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Spring Enterprise Project Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/java/spring/spring_mvc.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Spring MVC Design
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/java/spring/spring_performance.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Spring Performance
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_3" >
        
          
          <label class="md-nav__link" for="__nav_9_3" id="__nav_9_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Js
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_9_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Js
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/js/build_tools.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    JS Frontend Build and Development Tools
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/js/css.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cascading Style Sheets (CSS)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/js/js.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    JavaScript
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_3_4" >
        
          
          <label class="md-nav__link" for="__nav_9_3_4" id="__nav_9_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    App
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_3_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    App
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/js/app/app.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    APP Development
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_3_4_2" >
        
          
          <label class="md-nav__link" for="__nav_9_3_4_2" id="__nav_9_3_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Android
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_9_3_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_3_4_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Android
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/js/app/android/android.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Very Basic Android Concepts
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_3_4_3" >
        
          
          <label class="md-nav__link" for="__nav_9_3_4_3" id="__nav_9_3_4_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Uni app
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_9_3_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_3_4_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Uni app
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/js/app/uni_app/uni_app.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Uni App
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_3_5" >
        
          
          <label class="md-nav__link" for="__nav_9_3_5" id="__nav_9_3_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    React
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_3_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    React
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/js/react/react.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    React
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/js/react/react_interview.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Typical React Interview Questions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/js/react/react_practices.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    React Practices
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_3_6" >
        
          
          <label class="md-nav__link" for="__nav_9_3_6" id="__nav_9_3_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Vue
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_3_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_3_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Vue
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/js/vue/vue.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Vue
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/js/vue/vue_adv.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Advanced Vue Knowledge
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_4" >
        
          
          <label class="md-nav__link" for="__nav_9_4" id="__nav_9_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Python
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_9_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Python
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/python/cpp_to_python.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    C++ Code Be Used For Python
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/python/multi_threading_and_processing.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Python Multi Threading and Multiprocessing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/python/python_adv.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Python Advanced Usage/Knowledge
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/python/python_basics.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Python Notes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/python/python_interpreter.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Python Interpreters
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/python/python_mem_obj_gc.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Python Memory Investigation, Object Management, and Garbage Collection
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/python/python_software_dev.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Python Software Development
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_4_8" >
        
          
          <label class="md-nav__link" for="__nav_9_4_8" id="__nav_9_4_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Ai
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_4_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_4_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Ai
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/python/ai/ai_dev_concerns.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Python for AI Server Development
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/python/ai/pandas_and_numpy.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Numpy and Pandas practices
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_4_8_3" >
        
          
          <label class="md-nav__link" for="__nav_9_4_8_3" id="__nav_9_4_8_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Agent
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_9_4_8_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_4_8_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Agent
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/python/ai/agent/agent.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AI Agent Development Beginner Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_4_8_3_2" >
        
          
          <label class="md-nav__link" for="__nav_9_4_8_3_2" id="__nav_9_4_8_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Examples
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_9_4_8_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_4_8_3_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Examples
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/python/ai/agent/examples/checkin_agent_demo.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Checkin App Agent Demo
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_4_8_3_2_2" >
        
          
          <label class="md-nav__link" for="__nav_9_4_8_3_2_2" id="__nav_9_4_8_3_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Skill example gog 1.0.0
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="6" aria-labelledby="__nav_9_4_8_3_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_4_8_3_2_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Skill example gog 1.0.0
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/python/ai/agent/examples/skill-example-gog-1.0.0/SKILL.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    gog
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_4_8_4" >
        
          
          <label class="md-nav__link" for="__nav_9_4_8_4" id="__nav_9_4_8_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Comfy ui
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_9_4_8_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_4_8_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Comfy ui
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/python/ai/comfy_ui/audio_video_sync_workflow.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ComfyUI Audio &amp; Video Lip Sync Workflow
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/python/ai/comfy_ui/comfy_ui.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Comfy UI
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/python/ai/comfy_ui/comfy_ui_audio.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Comfy UI Audio
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/python/ai/comfy_ui/comfy_ui_practices.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Comfy ui practices
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_4_8_5" >
        
          
          <label class="md-nav__link" for="__nav_9_4_8_5" id="__nav_9_4_8_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Lang chain
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_9_4_8_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_4_8_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Lang chain
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/python/ai/lang_chain/lang_chain_agent_implementation.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LangChain Agent Implementation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/python/ai/lang_chain/lang_chain_basics.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LangChain Basics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/python/ai/lang_chain/langfuse_monitoring.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Langfuse monitoring
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_4_8_6" >
        
          
          <label class="md-nav__link" for="__nav_9_4_8_6" id="__nav_9_4_8_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Llm server
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_9_4_8_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_4_8_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Llm server
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/python/ai/llm_server/vllm.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LLM Hosting by VLLM
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_4_8_7" >
        
          
          <label class="md-nav__link" for="__nav_9_4_8_7" id="__nav_9_4_8_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Pytorch
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_9_4_8_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_4_8_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Pytorch
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/python/ai/pytorch/cuda.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cuda with python
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/python/ai/pytorch/dp.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Pytorch (Distributed) Data Parallel (DDP)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/python/ai/pytorch/pytorch.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    PyTorch
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_4_8_8" >
        
          
          <label class="md-nav__link" for="__nav_9_4_8_8" id="__nav_9_4_8_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Spacy
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_9_4_8_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_4_8_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Spacy
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/python/ai/spacy/spacy.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Spacy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_4_9" >
        
          
          <label class="md-nav__link" for="__nav_9_4_9" id="__nav_9_4_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Server
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_4_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_4_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    Server
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/python/server/fastapi.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Fast API
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/python/server/webserver.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Webserver
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#start" class="md-nav__link">
    <span class="md-ellipsis">
      
        Start
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Start">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-main" class="md-nav__link">
    <span class="md-ellipsis">
      
        The main()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-system-orb_slam2system" class="md-nav__link">
    <span class="md-ellipsis">
      
        The System ORB_SLAM2::System
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#frame-and-keyframe" class="md-nav__link">
    <span class="md-ellipsis">
      
        Frame and Keyframe
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Frame and Keyframe">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#frame" class="md-nav__link">
    <span class="md-ellipsis">
      
        Frame
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#keyframe" class="md-nav__link">
    <span class="md-ellipsis">
      
        Keyframe
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#keyframe-co-visibility" class="md-nav__link">
    <span class="md-ellipsis">
      
        Keyframe Co-Visibility
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#connected-keyframes-vs-co-visibility-keyframes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Connected Keyframes vs Co-Visibility Keyframes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spanning-tree-and-essential-graph" class="md-nav__link">
    <span class="md-ellipsis">
      
        Spanning Tree and Essential Graph
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#orb-extractor" class="md-nav__link">
    <span class="md-ellipsis">
      
        ORB Extractor
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ORB Extractor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fast-feature-orientation" class="md-nav__link">
    <span class="md-ellipsis">
      
        FAST Feature Orientation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#orb-feature-pair-test" class="md-nav__link">
    <span class="md-ellipsis">
      
        ORB Feature Pair Test
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#octree-for-orb-feature" class="md-nav__link">
    <span class="md-ellipsis">
      
        Octree For ORB Feature
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#orb-feature-computation" class="md-nav__link">
    <span class="md-ellipsis">
      
        ORB Feature Computation
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#orb-feature-matcher" class="md-nav__link">
    <span class="md-ellipsis">
      
        ORB Feature Matcher
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ORB Feature Matcher">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#search-by-projection" class="md-nav__link">
    <span class="md-ellipsis">
      
        Search By Projection
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#search-by-bow" class="md-nav__link">
    <span class="md-ellipsis">
      
        Search By BoW
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#search-by-sim3" class="md-nav__link">
    <span class="md-ellipsis">
      
        Search By \(Sim(3)\)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#local-pose-graph-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Local Pose Graph Optimization
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Local Pose Graph Optimization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#optimizerposeoptimizationframe-pframe" class="md-nav__link">
    <span class="md-ellipsis">
      
        Optimizer::PoseOptimization(Frame *pFrame)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compute-f" class="md-nav__link">
    <span class="md-ellipsis">
      
        Compute \(F\)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monocular-mapping-initialization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Monocular Mapping Initialization
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sim3-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      
        \(Sim(3)\) Optimization
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="\(Sim(3)\) Optimization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#solve-sim3-by-closed-form-solution-of-absolute-orientation-using-unit-quaternions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Solve \(Sim(3)\) by Closed-form Solution of Absolute Orientation Using Unit Quaternions
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#feature-tracking" class="md-nav__link">
    <span class="md-ellipsis">
      
        Feature Tracking
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Feature Tracking">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#constructor" class="md-nav__link">
    <span class="md-ellipsis">
      
        Constructor
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#systemtrackmonocular" class="md-nav__link">
    <span class="md-ellipsis">
      
        System::TrackMonocular
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tracking" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tracking
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bundle-adjustment" class="md-nav__link">
    <span class="md-ellipsis">
      
        Bundle Adjustment
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Bundle Adjustment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#global-bundle-adjustment" class="md-nav__link">
    <span class="md-ellipsis">
      
        Global Bundle Adjustment
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#map-point-normal-and-depth-update" class="md-nav__link">
    <span class="md-ellipsis">
      
        Map Point Normal And Depth Update
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#local-bundle-adjustment" class="md-nav__link">
    <span class="md-ellipsis">
      
        Local Bundle Adjustment
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#local-mapping" class="md-nav__link">
    <span class="md-ellipsis">
      
        Local Mapping
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#loop-closure" class="md-nav__link">
    <span class="md-ellipsis">
      
        Loop Closure
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Loop Closure">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#detectloop" class="md-nav__link">
    <span class="md-ellipsis">
      
        DetectLoop()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#computesim3" class="md-nav__link">
    <span class="md-ellipsis">
      
        ComputeSim3()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#correctloop" class="md-nav__link">
    <span class="md-ellipsis">
      
        CorrectLoop()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#essentail-graph-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Essentail Graph Optimization
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="orb-slam-source-code-review">ORB SLAM Source Code Review</h1>
<h2 id="start">Start</h2>
<p>Run by
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>rosrun<span class="w"> </span>ORB_SLAM2<span class="w"> </span>RGBD<span class="w"> </span>&lt;path_to_vocabulary&gt;<span class="w"> </span>&lt;path_to_settings&gt;
</code></pre></div></p>
<h3 id="the-main">The <code>main()</code></h3>
<p>ORB-SLAM has config for mono, rgb-d and stereo (dual cameras).
Here only take <code>ORB_SLAM2::System::MONOCULAR</code> as an example.</p>
<p>First, launch ORB-SLM with the specified camera model <code>ORB_SLAM2::System SLAM(argv[1],argv[2],ORB_SLAM2::System::MONOCULAR,true);</code>.
The <code>ORB_SLAM2::System</code> launches the Local Mapping, Loop Closing and Viewer threads.</p>
<p>Then, construct <code>ImageGrabber igb(&amp;SLAM);</code>.
The <code>ImageGrabber::GrabImage(...)</code> serves as the callback function for source raw camera images subscribed to the topic <code>"/camera/image_raw"</code>.</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="p">{</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">    </span><span class="n">ros</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Mono&quot;</span><span class="p">);</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">    </span><span class="n">ros</span><span class="o">::</span><span class="n">start</span><span class="p">();</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w">        </span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">endl</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Usage: rosrun ORB_SLAM2 Mono path_to_vocabulary path_to_settings&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">endl</span><span class="p">;</span><span class="w">        </span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="w">        </span><span class="n">ros</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="w">    </span><span class="p">}</span><span class="w">    </span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="w">    </span><span class="c1">// Create SLAM system. It initializes all system threads and gets ready to process frames.</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="w">    </span><span class="n">ORB_SLAM2</span><span class="o">::</span><span class="n">System</span><span class="w"> </span><span class="n">SLAM</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">ORB_SLAM2</span><span class="o">::</span><span class="n">System</span><span class="o">::</span><span class="n">MONOCULAR</span><span class="p">,</span><span class="nb">true</span><span class="p">);</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="w">    </span><span class="n">ImageGrabber</span><span class="w"> </span><span class="n">igb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SLAM</span><span class="p">);</span>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a><span class="w">    </span><span class="n">ros</span><span class="o">::</span><span class="n">NodeHandle</span><span class="w"> </span><span class="n">nodeHandler</span><span class="p">;</span>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a><span class="w">    </span><span class="n">ros</span><span class="o">::</span><span class="n">Subscriber</span><span class="w"> </span><span class="n">sub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodeHandler</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="s">&quot;/camera/image_raw&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ImageGrabber</span><span class="o">::</span><span class="n">GrabImage</span><span class="p">,</span><span class="o">&amp;</span><span class="n">igb</span><span class="p">);</span>
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a><span class="w">    </span><span class="n">ros</span><span class="o">::</span><span class="n">spin</span><span class="p">();</span>
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a><span class="w">    </span><span class="c1">// Stop all threads</span>
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a><span class="w">    </span><span class="n">SLAM</span><span class="p">.</span><span class="n">Shutdown</span><span class="p">();</span>
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a>
<a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a><span class="w">    </span><span class="c1">// Save camera trajectory</span>
<a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a><span class="w">    </span><span class="n">SLAM</span><span class="p">.</span><span class="n">SaveKeyFrameTrajectoryTUM</span><span class="p">(</span><span class="s">&quot;KeyFrameTrajectory.txt&quot;</span><span class="p">);</span>
<a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a>
<a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a><span class="w">    </span><span class="n">ros</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>
<a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a>
<a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a><span class="p">}</span>
</code></pre></div>
where <code>ImageGrabber</code> is defined as below.</p>
<p>Inside <code>ImageGrabber::GrabImage(...)</code>, <code>mpSLAM-&gt;TrackMonocular(...)</code> reads the raw image data and performs feature tracking.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">ImageGrabber</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="p">{</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="k">public</span><span class="o">:</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">    </span><span class="n">ImageGrabber</span><span class="p">(</span><span class="n">ORB_SLAM2</span><span class="o">::</span><span class="n">System</span><span class="o">*</span><span class="w"> </span><span class="n">pSLAM</span><span class="p">)</span><span class="o">:</span><span class="n">mpSLAM</span><span class="p">(</span><span class="n">pSLAM</span><span class="p">){}</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">GrabImage</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">sensor_msgs</span><span class="o">::</span><span class="n">ImageConstPtr</span><span class="o">&amp;</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w">    </span><span class="n">ORB_SLAM2</span><span class="o">::</span><span class="n">System</span><span class="o">*</span><span class="w"> </span><span class="n">mpSLAM</span><span class="p">;</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="p">};</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="kt">void</span><span class="w"> </span><span class="nf">ImageGrabber::GrabImage</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">sensor_msgs</span><span class="o">::</span><span class="n">ImageConstPtr</span><span class="o">&amp;</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="p">{</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="w">    </span><span class="c1">// Copy the ros image message to cv::Mat.</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="w">    </span><span class="n">cv_bridge</span><span class="o">::</span><span class="n">CvImageConstPtr</span><span class="w"> </span><span class="n">cv_ptr</span><span class="p">;</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="w">    </span><span class="k">try</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="w">        </span><span class="n">cv_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv_bridge</span><span class="o">::</span><span class="n">toCvShare</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a><span class="w">    </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">cv_bridge</span><span class="o">::</span><span class="n">Exception</span><span class="o">&amp;</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a><span class="w">        </span><span class="n">ROS_ERROR</span><span class="p">(</span><span class="s">&quot;cv_bridge exception: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a>
<a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a><span class="w">    </span><span class="n">mpSLAM</span><span class="o">-&gt;</span><span class="n">TrackMonocular</span><span class="p">(</span><span class="n">cv_ptr</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">,</span><span class="n">cv_ptr</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span><span class="p">.</span><span class="n">toSec</span><span class="p">());</span>
<a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a><span class="p">}</span>
</code></pre></div>
<h3 id="the-system-orb_slam2system">The System <code>ORB_SLAM2::System</code></h3>
<p><code>ORB_SLAM2::System</code> first loads ORB database, then spawns three threads:
* <code>new Tracking(this, mpVocabulary, mpFrameDrawer, mpMapDrawer, mpMap, mpKeyFrameDatabase, strSettingsFile, mSensor);</code>
* <code>mpLocalMapper = new LocalMapping(mpMap, mSensor==MONOCULAR);</code>
* <code>mpLoopCloser = new LoopClosing(mpMap, mpKeyFrameDatabase, mpVocabulary, mSensor!=MONOCULAR);</code></p>
<p>Optionally, visual output (e.g., markers) can be config.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="k">namespace</span><span class="w"> </span><span class="nn">ORB_SLAM2</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="p">{</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="n">System</span><span class="o">::</span><span class="n">System</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">strVocFile</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">strSettingsFile</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">eSensor</span><span class="w"> </span><span class="n">sensor</span><span class="p">,</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">               </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">bUseViewer</span><span class="p">)</span><span class="o">:</span><span class="n">mSensor</span><span class="p">(</span><span class="n">sensor</span><span class="p">),</span><span class="w"> </span><span class="n">mpViewer</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Viewer</span><span class="o">*&gt;</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)),</span><span class="w"> </span><span class="n">mbReset</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span><span class="n">mbActivateLocalizationMode</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">        </span><span class="n">mbDeactivateLocalizationMode</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="p">{</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="w">    </span><span class="p">...</span><span class="w"> </span><span class="c1">// some welcome msg and setting config</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="w">    </span><span class="n">mpVocabulary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ORBVocabulary</span><span class="p">();</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">bVocLoad</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mpVocabulary</span><span class="o">-&gt;</span><span class="n">loadFromTextFile</span><span class="p">(</span><span class="n">strVocFile</span><span class="p">);</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">bVocLoad</span><span class="p">)</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="w">        </span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Wrong path to vocabulary. &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">endl</span><span class="p">;</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a><span class="w">        </span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Falied to open at: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">strVocFile</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">endl</span><span class="p">;</span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a><span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a><span class="w">    </span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Vocabulary loaded!&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">endl</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">endl</span><span class="p">;</span>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>
<a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a><span class="w">    </span><span class="c1">//Create KeyFrame Database</span>
<a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a><span class="w">    </span><span class="n">mpKeyFrameDatabase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">KeyFrameDatabase</span><span class="p">(</span><span class="o">*</span><span class="n">mpVocabulary</span><span class="p">);</span>
<a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a>
<a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a><span class="w">    </span><span class="c1">//Create the Map</span>
<a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a><span class="w">    </span><span class="n">mpMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Map</span><span class="p">();</span>
<a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a>
<a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a><span class="w">    </span><span class="c1">//Create Drawers. These are used by the Viewer</span>
<a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a><span class="w">    </span><span class="n">mpFrameDrawer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FrameDrawer</span><span class="p">(</span><span class="n">mpMap</span><span class="p">);</span>
<a id="__codelineno-3-28" name="__codelineno-3-28" href="#__codelineno-3-28"></a><span class="w">    </span><span class="n">mpMapDrawer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MapDrawer</span><span class="p">(</span><span class="n">mpMap</span><span class="p">,</span><span class="w"> </span><span class="n">strSettingsFile</span><span class="p">);</span>
<a id="__codelineno-3-29" name="__codelineno-3-29" href="#__codelineno-3-29"></a>
<a id="__codelineno-3-30" name="__codelineno-3-30" href="#__codelineno-3-30"></a><span class="w">    </span><span class="c1">//Initialize the Tracking thread</span>
<a id="__codelineno-3-31" name="__codelineno-3-31" href="#__codelineno-3-31"></a><span class="w">    </span><span class="c1">//(it will live in the main thread of execution, the one that called this constructor)</span>
<a id="__codelineno-3-32" name="__codelineno-3-32" href="#__codelineno-3-32"></a><span class="w">    </span><span class="n">mpTracker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Tracking</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">mpVocabulary</span><span class="p">,</span><span class="w"> </span><span class="n">mpFrameDrawer</span><span class="p">,</span><span class="w"> </span><span class="n">mpMapDrawer</span><span class="p">,</span>
<a id="__codelineno-3-33" name="__codelineno-3-33" href="#__codelineno-3-33"></a><span class="w">                             </span><span class="n">mpMap</span><span class="p">,</span><span class="w"> </span><span class="n">mpKeyFrameDatabase</span><span class="p">,</span><span class="w"> </span><span class="n">strSettingsFile</span><span class="p">,</span><span class="w"> </span><span class="n">mSensor</span><span class="p">);</span>
<a id="__codelineno-3-34" name="__codelineno-3-34" href="#__codelineno-3-34"></a>
<a id="__codelineno-3-35" name="__codelineno-3-35" href="#__codelineno-3-35"></a><span class="w">    </span><span class="c1">//Initialize the Local Mapping thread and launch</span>
<a id="__codelineno-3-36" name="__codelineno-3-36" href="#__codelineno-3-36"></a><span class="w">    </span><span class="n">mpLocalMapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LocalMapping</span><span class="p">(</span><span class="n">mpMap</span><span class="p">,</span><span class="w"> </span><span class="n">mSensor</span><span class="o">==</span><span class="n">MONOCULAR</span><span class="p">);</span>
<a id="__codelineno-3-37" name="__codelineno-3-37" href="#__codelineno-3-37"></a><span class="w">    </span><span class="n">mptLocalMapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kr">thread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ORB_SLAM2</span><span class="o">::</span><span class="n">LocalMapping</span><span class="o">::</span><span class="n">Run</span><span class="p">,</span><span class="n">mpLocalMapper</span><span class="p">);</span>
<a id="__codelineno-3-38" name="__codelineno-3-38" href="#__codelineno-3-38"></a>
<a id="__codelineno-3-39" name="__codelineno-3-39" href="#__codelineno-3-39"></a><span class="w">    </span><span class="c1">//Initialize the Loop Closing thread and launch</span>
<a id="__codelineno-3-40" name="__codelineno-3-40" href="#__codelineno-3-40"></a><span class="w">    </span><span class="n">mpLoopCloser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LoopClosing</span><span class="p">(</span><span class="n">mpMap</span><span class="p">,</span><span class="w"> </span><span class="n">mpKeyFrameDatabase</span><span class="p">,</span><span class="w"> </span><span class="n">mpVocabulary</span><span class="p">,</span><span class="w"> </span><span class="n">mSensor</span><span class="o">!=</span><span class="n">MONOCULAR</span><span class="p">);</span>
<a id="__codelineno-3-41" name="__codelineno-3-41" href="#__codelineno-3-41"></a><span class="w">    </span><span class="n">mptLoopClosing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kr">thread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ORB_SLAM2</span><span class="o">::</span><span class="n">LoopClosing</span><span class="o">::</span><span class="n">Run</span><span class="p">,</span><span class="w"> </span><span class="n">mpLoopCloser</span><span class="p">);</span>
<a id="__codelineno-3-42" name="__codelineno-3-42" href="#__codelineno-3-42"></a>
<a id="__codelineno-3-43" name="__codelineno-3-43" href="#__codelineno-3-43"></a><span class="w">    </span><span class="c1">//Initialize the Viewer thread and launch</span>
<a id="__codelineno-3-44" name="__codelineno-3-44" href="#__codelineno-3-44"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">bUseViewer</span><span class="p">)</span>
<a id="__codelineno-3-45" name="__codelineno-3-45" href="#__codelineno-3-45"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-3-46" name="__codelineno-3-46" href="#__codelineno-3-46"></a><span class="w">        </span><span class="n">mpViewer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Viewer</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">mpFrameDrawer</span><span class="p">,</span><span class="n">mpMapDrawer</span><span class="p">,</span><span class="n">mpTracker</span><span class="p">,</span><span class="n">strSettingsFile</span><span class="p">);</span>
<a id="__codelineno-3-47" name="__codelineno-3-47" href="#__codelineno-3-47"></a><span class="w">        </span><span class="n">mptViewer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kr">thread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Viewer</span><span class="o">::</span><span class="n">Run</span><span class="p">,</span><span class="w"> </span><span class="n">mpViewer</span><span class="p">);</span>
<a id="__codelineno-3-48" name="__codelineno-3-48" href="#__codelineno-3-48"></a><span class="w">        </span><span class="n">mpTracker</span><span class="o">-&gt;</span><span class="n">SetViewer</span><span class="p">(</span><span class="n">mpViewer</span><span class="p">);</span>
<a id="__codelineno-3-49" name="__codelineno-3-49" href="#__codelineno-3-49"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-3-50" name="__codelineno-3-50" href="#__codelineno-3-50"></a>
<a id="__codelineno-3-51" name="__codelineno-3-51" href="#__codelineno-3-51"></a><span class="w">    </span><span class="c1">//Set pointers between threads</span>
<a id="__codelineno-3-52" name="__codelineno-3-52" href="#__codelineno-3-52"></a><span class="w">    </span><span class="n">mpTracker</span><span class="o">-&gt;</span><span class="n">SetLocalMapper</span><span class="p">(</span><span class="n">mpLocalMapper</span><span class="p">);</span>
<a id="__codelineno-3-53" name="__codelineno-3-53" href="#__codelineno-3-53"></a><span class="w">    </span><span class="n">mpTracker</span><span class="o">-&gt;</span><span class="n">SetLoopClosing</span><span class="p">(</span><span class="n">mpLoopCloser</span><span class="p">);</span>
<a id="__codelineno-3-54" name="__codelineno-3-54" href="#__codelineno-3-54"></a>
<a id="__codelineno-3-55" name="__codelineno-3-55" href="#__codelineno-3-55"></a><span class="w">    </span><span class="n">mpLocalMapper</span><span class="o">-&gt;</span><span class="n">SetTracker</span><span class="p">(</span><span class="n">mpTracker</span><span class="p">);</span>
<a id="__codelineno-3-56" name="__codelineno-3-56" href="#__codelineno-3-56"></a><span class="w">    </span><span class="n">mpLocalMapper</span><span class="o">-&gt;</span><span class="n">SetLoopCloser</span><span class="p">(</span><span class="n">mpLoopCloser</span><span class="p">);</span>
<a id="__codelineno-3-57" name="__codelineno-3-57" href="#__codelineno-3-57"></a>
<a id="__codelineno-3-58" name="__codelineno-3-58" href="#__codelineno-3-58"></a><span class="w">    </span><span class="n">mpLoopCloser</span><span class="o">-&gt;</span><span class="n">SetTracker</span><span class="p">(</span><span class="n">mpTracker</span><span class="p">);</span>
<a id="__codelineno-3-59" name="__codelineno-3-59" href="#__codelineno-3-59"></a><span class="w">    </span><span class="n">mpLoopCloser</span><span class="o">-&gt;</span><span class="n">SetLocalMapper</span><span class="p">(</span><span class="n">mpLocalMapper</span><span class="p">);</span>
<a id="__codelineno-3-60" name="__codelineno-3-60" href="#__codelineno-3-60"></a><span class="p">}</span>
<a id="__codelineno-3-61" name="__codelineno-3-61" href="#__codelineno-3-61"></a>
<a id="__codelineno-3-62" name="__codelineno-3-62" href="#__codelineno-3-62"></a><span class="p">}</span>
</code></pre></div>
<h2 id="frame-and-keyframe">Frame and Keyframe</h2>
<h3 id="frame">Frame</h3>
<p>The <code>Frame(...)</code> should be self-explanatory, that it takes an input image <code>const cv::Mat &amp;imGray</code> and the camera model <code>cv::Mat &amp;K, cv::Mat &amp;distCoef</code> to extract ORB features and get the undistorted keypoints.</p>
<p><code>mvpMapPoints = vector&lt;MapPoint*&gt;(N,static_cast&lt;MapPoint*&gt;(NULL));</code> map points and <code>mvbOutlier = vector&lt;bool&gt;(N,false);</code> map point outliers are init as nullptr in the frame constructor.
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1">// MapPoints associated to keypoints, NULL pointer if no association.</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">mvpMapPoints</span><span class="p">;</span>
</code></pre></div></p>
<p>Finally, <code>AssignFeaturesToGrid();</code> puts the keypoints into the segmented grid <code>FRAME_GRID_COLS*FRAME_GRID_ROWS</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="n">Frame</span><span class="o">::</span><span class="n">Frame</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="o">&amp;</span><span class="n">imGray</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">&amp;</span><span class="n">timeStamp</span><span class="p">,</span><span class="w"> </span><span class="n">ORBextractor</span><span class="o">*</span><span class="w"> </span><span class="n">extractor</span><span class="p">,</span><span class="n">ORBVocabulary</span><span class="o">*</span><span class="w"> </span><span class="n">voc</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="o">&amp;</span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="o">&amp;</span><span class="n">distCoef</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bf</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">&amp;</span><span class="n">thDepth</span><span class="p">)</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">    </span><span class="o">:</span><span class="n">mpORBvocabulary</span><span class="p">(</span><span class="n">voc</span><span class="p">),</span><span class="n">mpORBextractorLeft</span><span class="p">(</span><span class="n">extractor</span><span class="p">),</span><span class="n">mpORBextractorRight</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">ORBextractor</span><span class="o">*&gt;</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)),</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w">     </span><span class="n">mTimeStamp</span><span class="p">(</span><span class="n">timeStamp</span><span class="p">),</span><span class="w"> </span><span class="n">mK</span><span class="p">(</span><span class="n">K</span><span class="p">.</span><span class="n">clone</span><span class="p">()),</span><span class="n">mDistCoef</span><span class="p">(</span><span class="n">distCoef</span><span class="p">.</span><span class="n">clone</span><span class="p">()),</span><span class="w"> </span><span class="n">mbf</span><span class="p">(</span><span class="n">bf</span><span class="p">),</span><span class="w"> </span><span class="n">mThDepth</span><span class="p">(</span><span class="n">thDepth</span><span class="p">)</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="p">{</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">    </span><span class="c1">// Frame ID</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w">    </span><span class="n">mnId</span><span class="o">=</span><span class="n">nNextId</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="w">    </span><span class="c1">// Scale Level Info</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="w">    </span><span class="n">mnScaleLevels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mpORBextractorLeft</span><span class="o">-&gt;</span><span class="n">GetLevels</span><span class="p">();</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="w">    </span><span class="n">mfScaleFactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mpORBextractorLeft</span><span class="o">-&gt;</span><span class="n">GetScaleFactor</span><span class="p">();</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="w">    </span><span class="n">mfLogScaleFactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">log</span><span class="p">(</span><span class="n">mfScaleFactor</span><span class="p">);</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="w">    </span><span class="n">mvScaleFactors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mpORBextractorLeft</span><span class="o">-&gt;</span><span class="n">GetScaleFactors</span><span class="p">();</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="w">    </span><span class="n">mvInvScaleFactors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mpORBextractorLeft</span><span class="o">-&gt;</span><span class="n">GetInverseScaleFactors</span><span class="p">();</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="w">    </span><span class="n">mvLevelSigma2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mpORBextractorLeft</span><span class="o">-&gt;</span><span class="n">GetScaleSigmaSquares</span><span class="p">();</span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a><span class="w">    </span><span class="n">mvInvLevelSigma2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mpORBextractorLeft</span><span class="o">-&gt;</span><span class="n">GetInverseScaleSigmaSquares</span><span class="p">();</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a><span class="w">    </span><span class="c1">// ORB extraction</span>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a><span class="w">    </span><span class="n">ExtractORB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">imGray</span><span class="p">);</span>
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a><span class="w">    </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mvKeys</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mvKeys</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a><span class="w">    </span><span class="n">UndistortKeyPoints</span><span class="p">();</span>
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a><span class="w">    </span><span class="c1">// Set no stereo information</span>
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a><span class="w">    </span><span class="n">mvuRight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="mi">-1</span><span class="p">);</span>
<a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a><span class="w">    </span><span class="n">mvDepth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="mi">-1</span><span class="p">);</span>
<a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a>
<a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a><span class="w">    </span><span class="n">mvpMapPoints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
<a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a><span class="w">    </span><span class="n">mvbOutlier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="nb">false</span><span class="p">);</span>
<a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a>
<a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a><span class="w">    </span><span class="c1">// This is done only for the first Frame (or after a change in the calibration)</span>
<a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mbInitialComputations</span><span class="p">)</span>
<a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-5-37" name="__codelineno-5-37" href="#__codelineno-5-37"></a><span class="w">        </span><span class="n">ComputeImageBounds</span><span class="p">(</span><span class="n">imGray</span><span class="p">);</span>
<a id="__codelineno-5-38" name="__codelineno-5-38" href="#__codelineno-5-38"></a>
<a id="__codelineno-5-39" name="__codelineno-5-39" href="#__codelineno-5-39"></a><span class="w">        </span><span class="n">mfGridElementWidthInv</span><span class="o">=</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">FRAME_GRID_COLS</span><span class="p">)</span><span class="o">/</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">mnMaxX</span><span class="o">-</span><span class="n">mnMinX</span><span class="p">);</span>
<a id="__codelineno-5-40" name="__codelineno-5-40" href="#__codelineno-5-40"></a><span class="w">        </span><span class="n">mfGridElementHeightInv</span><span class="o">=</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">FRAME_GRID_ROWS</span><span class="p">)</span><span class="o">/</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">mnMaxY</span><span class="o">-</span><span class="n">mnMinY</span><span class="p">);</span>
<a id="__codelineno-5-41" name="__codelineno-5-41" href="#__codelineno-5-41"></a>
<a id="__codelineno-5-42" name="__codelineno-5-42" href="#__codelineno-5-42"></a><span class="w">        </span><span class="n">fx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">K</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-5-43" name="__codelineno-5-43" href="#__codelineno-5-43"></a><span class="w">        </span><span class="n">fy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">K</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-5-44" name="__codelineno-5-44" href="#__codelineno-5-44"></a><span class="w">        </span><span class="n">cx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">K</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-5-45" name="__codelineno-5-45" href="#__codelineno-5-45"></a><span class="w">        </span><span class="n">cy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">K</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-5-46" name="__codelineno-5-46" href="#__codelineno-5-46"></a><span class="w">        </span><span class="n">invfx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0f</span><span class="o">/</span><span class="n">fx</span><span class="p">;</span>
<a id="__codelineno-5-47" name="__codelineno-5-47" href="#__codelineno-5-47"></a><span class="w">        </span><span class="n">invfy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0f</span><span class="o">/</span><span class="n">fy</span><span class="p">;</span>
<a id="__codelineno-5-48" name="__codelineno-5-48" href="#__codelineno-5-48"></a>
<a id="__codelineno-5-49" name="__codelineno-5-49" href="#__codelineno-5-49"></a><span class="w">        </span><span class="n">mbInitialComputations</span><span class="o">=</span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-5-50" name="__codelineno-5-50" href="#__codelineno-5-50"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-5-51" name="__codelineno-5-51" href="#__codelineno-5-51"></a>
<a id="__codelineno-5-52" name="__codelineno-5-52" href="#__codelineno-5-52"></a><span class="w">    </span><span class="n">mb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mbf</span><span class="o">/</span><span class="n">fx</span><span class="p">;</span>
<a id="__codelineno-5-53" name="__codelineno-5-53" href="#__codelineno-5-53"></a>
<a id="__codelineno-5-54" name="__codelineno-5-54" href="#__codelineno-5-54"></a><span class="w">    </span><span class="n">AssignFeaturesToGrid</span><span class="p">();</span>
<a id="__codelineno-5-55" name="__codelineno-5-55" href="#__codelineno-5-55"></a><span class="p">}</span>
<a id="__codelineno-5-56" name="__codelineno-5-56" href="#__codelineno-5-56"></a>
<a id="__codelineno-5-57" name="__codelineno-5-57" href="#__codelineno-5-57"></a><span class="cp">#define FRAME_GRID_ROWS 48</span>
<a id="__codelineno-5-58" name="__codelineno-5-58" href="#__codelineno-5-58"></a><span class="cp">#define FRAME_GRID_COLS 64</span>
<a id="__codelineno-5-59" name="__codelineno-5-59" href="#__codelineno-5-59"></a><span class="kt">void</span><span class="w"> </span><span class="n">Frame</span><span class="o">::</span><span class="n">AssignFeaturesToGrid</span><span class="p">()</span>
<a id="__codelineno-5-60" name="__codelineno-5-60" href="#__codelineno-5-60"></a><span class="p">{</span>
<a id="__codelineno-5-61" name="__codelineno-5-61" href="#__codelineno-5-61"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nReserve</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5f</span><span class="o">*</span><span class="n">N</span><span class="o">/</span><span class="p">(</span><span class="n">FRAME_GRID_COLS</span><span class="o">*</span><span class="n">FRAME_GRID_ROWS</span><span class="p">);</span>
<a id="__codelineno-5-62" name="__codelineno-5-62" href="#__codelineno-5-62"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">FRAME_GRID_COLS</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-5-63" name="__codelineno-5-63" href="#__codelineno-5-63"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;</span><span class="n">FRAME_GRID_ROWS</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-5-64" name="__codelineno-5-64" href="#__codelineno-5-64"></a><span class="w">            </span><span class="n">mGrid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">reserve</span><span class="p">(</span><span class="n">nReserve</span><span class="p">);</span>
<a id="__codelineno-5-65" name="__codelineno-5-65" href="#__codelineno-5-65"></a>
<a id="__codelineno-5-66" name="__codelineno-5-66" href="#__codelineno-5-66"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-5-67" name="__codelineno-5-67" href="#__codelineno-5-67"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-5-68" name="__codelineno-5-68" href="#__codelineno-5-68"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">KeyPoint</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mvKeysUn</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-5-69" name="__codelineno-5-69" href="#__codelineno-5-69"></a>
<a id="__codelineno-5-70" name="__codelineno-5-70" href="#__codelineno-5-70"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">nGridPosX</span><span class="p">,</span><span class="w"> </span><span class="n">nGridPosY</span><span class="p">;</span>
<a id="__codelineno-5-71" name="__codelineno-5-71" href="#__codelineno-5-71"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">PosInGrid</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span><span class="n">nGridPosX</span><span class="p">,</span><span class="n">nGridPosY</span><span class="p">))</span>
<a id="__codelineno-5-72" name="__codelineno-5-72" href="#__codelineno-5-72"></a><span class="w">            </span><span class="n">mGrid</span><span class="p">[</span><span class="n">nGridPosX</span><span class="p">][</span><span class="n">nGridPosY</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<a id="__codelineno-5-73" name="__codelineno-5-73" href="#__codelineno-5-73"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-5-74" name="__codelineno-5-74" href="#__codelineno-5-74"></a><span class="p">}</span>
</code></pre></div>
<p>A frame is created in <code>cv::Mat Tracking::GrabImageMonocular(...)</code> (a callback function when an image is received from camera) that takes a gray image to construct a frame.
<code>mpORBextractorLeft</code> and <code>mpORBVocabulary</code> are built when the tracking thread <code>mpTracker = new Tracking(...);</code> starts.
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="nf">Tracking::GrabImageMonocular</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="o">&amp;</span><span class="n">im</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">&amp;</span><span class="n">timestamp</span><span class="p">)</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="p">{</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mState</span><span class="o">==</span><span class="n">NOT_INITIALIZED</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">mState</span><span class="o">==</span><span class="n">NO_IMAGES_YET</span><span class="p">)</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">        </span><span class="n">mCurrentFrame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Frame</span><span class="p">(</span><span class="n">mImGray</span><span class="p">,</span><span class="n">timestamp</span><span class="p">,</span><span class="n">mpIniORBextractor</span><span class="p">,</span><span class="n">mpORBVocabulary</span><span class="p">,</span><span class="n">mK</span><span class="p">,</span><span class="n">mDistCoef</span><span class="p">,</span><span class="n">mbf</span><span class="p">,</span><span class="n">mThDepth</span><span class="p">);</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">    </span><span class="k">else</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="w">        </span><span class="n">mCurrentFrame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Frame</span><span class="p">(</span><span class="n">mImGray</span><span class="p">,</span><span class="n">timestamp</span><span class="p">,</span><span class="n">mpORBextractorLeft</span><span class="p">,</span><span class="n">mpORBVocabulary</span><span class="p">,</span><span class="n">mK</span><span class="p">,</span><span class="n">mDistCoef</span><span class="p">,</span><span class="n">mbf</span><span class="p">,</span><span class="n">mThDepth</span><span class="p">);</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="p">}</span>
</code></pre></div></p>
<h3 id="keyframe">Keyframe</h3>
<p>A keyframe is created in <code>Tracking::Track()</code> (a callback function when an image is received from camera), where <code>NeedNewKeyFrame()</code> judges if a new keyframe should be inserted by <code>CreateNewKeyFrame();</code> that takes the reference of <code>Frame &amp;F</code> as input to create a new keyframe.</p>
<p>The motivation to add a new keyframe is shown as below.
In general, 
* when there are too many frames passed without creating a new keyframe
* when CPU is idle
* when too few match points found</p>
<p>that a new keyframe is created.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">Tracking::Track</span><span class="p">()</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="p">{</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">    </span><span class="c1">// Check if we need to insert a new keyframe</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">NeedNewKeyFrame</span><span class="p">())</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">        </span><span class="n">CreateNewKeyFrame</span><span class="p">();</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="p">}</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="kt">bool</span><span class="w"> </span><span class="nf">Tracking::NeedNewKeyFrame</span><span class="p">()</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="p">{</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="w">    </span><span class="p">...</span><span class="w"> </span><span class="c1">// nTrackedClose: tracked non-outlier map points</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="w">        </span><span class="c1">// nNonTrackedClose: otherwise non-nTrackedClose</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nRefMatches</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mpReferenceKF</span><span class="o">-&gt;</span><span class="n">TrackedMapPoints</span><span class="p">(</span><span class="n">nMinObs</span><span class="p">);</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">bNeedToInsertClose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">nTrackedClose</span><span class="o">&lt;</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">nNonTrackedClose</span><span class="o">&gt;</span><span class="mi">70</span><span class="p">);</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mSensor</span><span class="o">==</span><span class="n">System</span><span class="o">::</span><span class="n">MONOCULAR</span><span class="p">)</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="w">        </span><span class="n">thRefRatio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.9f</span><span class="p">;</span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a><span class="w">    </span><span class="c1">// Condition 1a: More than &quot;MaxFrames&quot; have passed from last keyframe insertion</span>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">c1a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mnId</span><span class="o">&gt;=</span><span class="n">mnLastKeyFrameId</span><span class="o">+</span><span class="n">mMaxFrames</span><span class="p">;</span>
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a><span class="w">    </span><span class="c1">// Condition 1b: More than &quot;MinFrames&quot; have passed and Local Mapping is idle</span>
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">c1b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mnId</span><span class="o">&gt;=</span><span class="n">mnLastKeyFrameId</span><span class="o">+</span><span class="n">mMinFrames</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">bLocalMappingIdle</span><span class="p">);</span>
<a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a><span class="w">    </span><span class="c1">//Condition 1c: tracking is weak</span>
<a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">c1c</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">mSensor</span><span class="o">!=</span><span class="n">System</span><span class="o">::</span><span class="n">MONOCULAR</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">mnMatchesInliers</span><span class="o">&lt;</span><span class="n">nRefMatches</span><span class="o">*</span><span class="mf">0.25</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">bNeedToInsertClose</span><span class="p">)</span><span class="w"> </span><span class="p">;</span>
<a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a><span class="w">    </span><span class="c1">// Condition 2: Few tracked points compared to reference keyframe. Lots of visual odometry compared to map matches.</span>
<a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">mnMatchesInliers</span><span class="o">&lt;</span><span class="n">nRefMatches</span><span class="o">*</span><span class="n">thRefRatio</span><span class="o">||</span><span class="w"> </span><span class="n">bNeedToInsertClose</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mnMatchesInliers</span><span class="o">&gt;</span><span class="mi">15</span><span class="p">);</span>
<a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a>
<a id="__codelineno-7-31" name="__codelineno-7-31" href="#__codelineno-7-31"></a><span class="w">    </span><span class="k">if</span><span class="p">((</span><span class="n">c1a</span><span class="o">||</span><span class="n">c1b</span><span class="o">||</span><span class="n">c1c</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="n">c2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-32" name="__codelineno-7-32" href="#__codelineno-7-32"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w">    </span>
<a id="__codelineno-7-33" name="__codelineno-7-33" href="#__codelineno-7-33"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-34" name="__codelineno-7-34" href="#__codelineno-7-34"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-7-35" name="__codelineno-7-35" href="#__codelineno-7-35"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-7-36" name="__codelineno-7-36" href="#__codelineno-7-36"></a><span class="p">}</span>
</code></pre></div>
<p>Generally speaking, a <code>KeyFrame</code> uses <code>Frame &amp;F</code> to init its fields.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="n">KeyFrame</span><span class="o">::</span><span class="n">KeyFrame</span><span class="p">(</span><span class="n">Frame</span><span class="w"> </span><span class="o">&amp;</span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="n">Map</span><span class="w"> </span><span class="o">*</span><span class="n">pMap</span><span class="p">,</span><span class="w"> </span><span class="n">KeyFrameDatabase</span><span class="w"> </span><span class="o">*</span><span class="n">pKFDB</span><span class="p">)</span><span class="o">:</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="w">    </span><span class="n">mnFrameId</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">mnId</span><span class="p">),</span><span class="w">  </span><span class="n">mTimeStamp</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">mTimeStamp</span><span class="p">),</span><span class="w"> </span><span class="n">mnGridCols</span><span class="p">(</span><span class="n">FRAME_GRID_COLS</span><span class="p">),</span><span class="w"> </span><span class="n">mnGridRows</span><span class="p">(</span><span class="n">FRAME_GRID_ROWS</span><span class="p">),</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">    </span><span class="n">mfGridElementWidthInv</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">mfGridElementWidthInv</span><span class="p">),</span><span class="w"> </span><span class="n">mfGridElementHeightInv</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">mfGridElementHeightInv</span><span class="p">),</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">    </span><span class="n">mnTrackReferenceForFrame</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">mnFuseTargetForKF</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">mnBALocalForKF</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">mnBAFixedForKF</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">    </span><span class="n">mnLoopQuery</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">mnLoopWords</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">mnRelocQuery</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">mnRelocWords</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">mnBAGlobalForKF</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">    </span><span class="n">fx</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">fx</span><span class="p">),</span><span class="w"> </span><span class="n">fy</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">fy</span><span class="p">),</span><span class="w"> </span><span class="n">cx</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">cx</span><span class="p">),</span><span class="w"> </span><span class="n">cy</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">cy</span><span class="p">),</span><span class="w"> </span><span class="n">invfx</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">invfx</span><span class="p">),</span><span class="w"> </span><span class="n">invfy</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">invfy</span><span class="p">),</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="w">    </span><span class="n">mbf</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">mbf</span><span class="p">),</span><span class="w"> </span><span class="n">mb</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">mb</span><span class="p">),</span><span class="w"> </span><span class="n">mThDepth</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">mThDepth</span><span class="p">),</span><span class="w"> </span><span class="n">N</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">N</span><span class="p">),</span><span class="w"> </span><span class="n">mvKeys</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">mvKeys</span><span class="p">),</span><span class="w"> </span><span class="n">mvKeysUn</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">mvKeysUn</span><span class="p">),</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="w">    </span><span class="n">mvuRight</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">mvuRight</span><span class="p">),</span><span class="w"> </span><span class="n">mvDepth</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">mvDepth</span><span class="p">),</span><span class="w"> </span><span class="n">mDescriptors</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">mDescriptors</span><span class="p">.</span><span class="n">clone</span><span class="p">()),</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="w">    </span><span class="n">mBowVec</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">mBowVec</span><span class="p">),</span><span class="w"> </span><span class="n">mFeatVec</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">mFeatVec</span><span class="p">),</span><span class="w"> </span><span class="n">mnScaleLevels</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">mnScaleLevels</span><span class="p">),</span><span class="w"> </span><span class="n">mfScaleFactor</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">mfScaleFactor</span><span class="p">),</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="w">    </span><span class="n">mfLogScaleFactor</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">mfLogScaleFactor</span><span class="p">),</span><span class="w"> </span><span class="n">mvScaleFactors</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">mvScaleFactors</span><span class="p">),</span><span class="w"> </span><span class="n">mvLevelSigma2</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">mvLevelSigma2</span><span class="p">),</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="w">    </span><span class="n">mvInvLevelSigma2</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">mvInvLevelSigma2</span><span class="p">),</span><span class="w"> </span><span class="n">mnMinX</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">mnMinX</span><span class="p">),</span><span class="w"> </span><span class="n">mnMinY</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">mnMinY</span><span class="p">),</span><span class="w"> </span><span class="n">mnMaxX</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">mnMaxX</span><span class="p">),</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="w">    </span><span class="n">mnMaxY</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">mnMaxY</span><span class="p">),</span><span class="w"> </span><span class="n">mK</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">mK</span><span class="p">),</span><span class="w"> </span><span class="n">mvpMapPoints</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">mvpMapPoints</span><span class="p">),</span><span class="w"> </span><span class="n">mpKeyFrameDB</span><span class="p">(</span><span class="n">pKFDB</span><span class="p">),</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="w">    </span><span class="n">mpORBvocabulary</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">mpORBvocabulary</span><span class="p">),</span><span class="w"> </span><span class="n">mbFirstConnection</span><span class="p">(</span><span class="nb">true</span><span class="p">),</span><span class="w"> </span><span class="n">mpParent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span><span class="w"> </span><span class="n">mbNotErase</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="w">    </span><span class="n">mbToBeErased</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span><span class="w"> </span><span class="n">mbBad</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span><span class="w"> </span><span class="n">mHalfBaseline</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">mb</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">mpMap</span><span class="p">(</span><span class="n">pMap</span><span class="p">)</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a><span class="p">{</span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a><span class="w">    </span><span class="n">mnId</span><span class="o">=</span><span class="n">nNextId</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a><span class="w">    </span><span class="n">mGrid</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">mnGridCols</span><span class="p">);</span>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">mnGridCols</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a><span class="w">        </span><span class="n">mGrid</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">resize</span><span class="p">(</span><span class="n">mnGridRows</span><span class="p">);</span>
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;</span><span class="n">mnGridRows</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a><span class="w">            </span><span class="n">mGrid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">F</span><span class="p">.</span><span class="n">mGrid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
<a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a>
<a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a><span class="w">    </span><span class="n">SetPose</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">mTcw</span><span class="p">);</span><span class="w">    </span>
<a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a><span class="p">}</span>
</code></pre></div>
<h3 id="keyframe-co-visibility">Keyframe Co-Visibility</h3>
<p><code>KeyFrame::UpdateConnections()</code> is called in local mapping to build co-visibility.</p>
<p>The co-visibility is basically the count of co-visible features seen by keyframes such that <code>map&lt;KeyFrame*,size_t&gt; observations</code>.
For each element of <code>KFcounter</code> denoted as <code>mit</code>, the keyframe <code>mit-&gt;first</code> is added <code>this</code> current keyframe connection of the keyframe <code>mit</code>'s number observed features: <code>(mit-&gt;first)-&gt;AddConnection(this,mit-&gt;second);</code>.</p>
<p>Finally, <code>mvpOrderedConnectedKeyFrames</code> is built for <code>this</code> keyframe recording all keyframes that share some co-visible features;
<code>mvOrderedWeights</code> is for the "weights" of the co-visibility, which is the count of co-visible features.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">KeyFrame::UpdateConnections</span><span class="p">()</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="p">{</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">    </span><span class="n">map</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*</span><span class="p">,</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">KFcounter</span><span class="p">;</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">vpMP</span><span class="p">;</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="w">        </span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lockMPs</span><span class="p">(</span><span class="n">mMutexFeatures</span><span class="p">);</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="w">        </span><span class="n">vpMP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mvpMapPoints</span><span class="p">;</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="w">    </span><span class="c1">//For all map points in keyframe check in which other keyframes are they seen</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="w">    </span><span class="c1">//Increase counter for those keyframes</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">vit</span><span class="o">=</span><span class="n">vpMP</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">vend</span><span class="o">=</span><span class="n">vpMP</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">vit</span><span class="o">!=</span><span class="n">vend</span><span class="p">;</span><span class="w"> </span><span class="n">vit</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a><span class="w">        </span><span class="n">MapPoint</span><span class="o">*</span><span class="w"> </span><span class="n">pMP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">vit</span><span class="p">;</span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a><span class="w">        </span><span class="p">...</span><span class="w"> </span><span class="c1">// bad map point removal</span>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a><span class="w">        </span><span class="n">map</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*</span><span class="p">,</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">observations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">GetObservations</span><span class="p">();</span>
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a>
<a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">map</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*</span><span class="p">,</span><span class="kt">size_t</span><span class="o">&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">mit</span><span class="o">=</span><span class="n">observations</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">mend</span><span class="o">=</span><span class="n">observations</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">mit</span><span class="o">!=</span><span class="n">mend</span><span class="p">;</span><span class="w"> </span><span class="n">mit</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">mit</span><span class="o">-&gt;</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="o">==</span><span class="n">mnId</span><span class="p">)</span>
<a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a><span class="w">                </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a><span class="w">            </span><span class="n">KFcounter</span><span class="p">[</span><span class="n">mit</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a>
<a id="__codelineno-9-30" name="__codelineno-9-30" href="#__codelineno-9-30"></a><span class="w">    </span><span class="c1">// This should not happen</span>
<a id="__codelineno-9-31" name="__codelineno-9-31" href="#__codelineno-9-31"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">KFcounter</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
<a id="__codelineno-9-32" name="__codelineno-9-32" href="#__codelineno-9-32"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-9-33" name="__codelineno-9-33" href="#__codelineno-9-33"></a>
<a id="__codelineno-9-34" name="__codelineno-9-34" href="#__codelineno-9-34"></a><span class="w">    </span><span class="c1">//If the counter is greater than threshold add connection</span>
<a id="__codelineno-9-35" name="__codelineno-9-35" href="#__codelineno-9-35"></a><span class="w">    </span><span class="c1">//In case no keyframe counter is over threshold add the one with maximum counter</span>
<a id="__codelineno-9-36" name="__codelineno-9-36" href="#__codelineno-9-36"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nmax</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-9-37" name="__codelineno-9-37" href="#__codelineno-9-37"></a><span class="w">    </span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pKFmax</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
<a id="__codelineno-9-38" name="__codelineno-9-38" href="#__codelineno-9-38"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">th</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">15</span><span class="p">;</span>
<a id="__codelineno-9-39" name="__codelineno-9-39" href="#__codelineno-9-39"></a>
<a id="__codelineno-9-40" name="__codelineno-9-40" href="#__codelineno-9-40"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="n">KeyFrame</span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vPairs</span><span class="p">;</span>
<a id="__codelineno-9-41" name="__codelineno-9-41" href="#__codelineno-9-41"></a><span class="w">    </span><span class="n">vPairs</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">KFcounter</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
<a id="__codelineno-9-42" name="__codelineno-9-42" href="#__codelineno-9-42"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">map</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*</span><span class="p">,</span><span class="kt">int</span><span class="o">&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">mit</span><span class="o">=</span><span class="n">KFcounter</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">mend</span><span class="o">=</span><span class="n">KFcounter</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">mit</span><span class="o">!=</span><span class="n">mend</span><span class="p">;</span><span class="w"> </span><span class="n">mit</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-9-43" name="__codelineno-9-43" href="#__codelineno-9-43"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-9-44" name="__codelineno-9-44" href="#__codelineno-9-44"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">mit</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">&gt;</span><span class="n">nmax</span><span class="p">)</span>
<a id="__codelineno-9-45" name="__codelineno-9-45" href="#__codelineno-9-45"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-9-46" name="__codelineno-9-46" href="#__codelineno-9-46"></a><span class="w">            </span><span class="n">nmax</span><span class="o">=</span><span class="n">mit</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
<a id="__codelineno-9-47" name="__codelineno-9-47" href="#__codelineno-9-47"></a><span class="w">            </span><span class="n">pKFmax</span><span class="o">=</span><span class="n">mit</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">;</span>
<a id="__codelineno-9-48" name="__codelineno-9-48" href="#__codelineno-9-48"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-9-49" name="__codelineno-9-49" href="#__codelineno-9-49"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">mit</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">&gt;=</span><span class="n">th</span><span class="p">)</span>
<a id="__codelineno-9-50" name="__codelineno-9-50" href="#__codelineno-9-50"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-9-51" name="__codelineno-9-51" href="#__codelineno-9-51"></a><span class="w">            </span><span class="n">vPairs</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">make_pair</span><span class="p">(</span><span class="n">mit</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">,</span><span class="n">mit</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">));</span>
<a id="__codelineno-9-52" name="__codelineno-9-52" href="#__codelineno-9-52"></a><span class="w">            </span><span class="p">(</span><span class="n">mit</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">AddConnection</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="n">mit</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">);</span>
<a id="__codelineno-9-53" name="__codelineno-9-53" href="#__codelineno-9-53"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-9-54" name="__codelineno-9-54" href="#__codelineno-9-54"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-55" name="__codelineno-9-55" href="#__codelineno-9-55"></a>
<a id="__codelineno-9-56" name="__codelineno-9-56" href="#__codelineno-9-56"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">vPairs</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
<a id="__codelineno-9-57" name="__codelineno-9-57" href="#__codelineno-9-57"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-9-58" name="__codelineno-9-58" href="#__codelineno-9-58"></a><span class="w">        </span><span class="n">vPairs</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">make_pair</span><span class="p">(</span><span class="n">nmax</span><span class="p">,</span><span class="n">pKFmax</span><span class="p">));</span>
<a id="__codelineno-9-59" name="__codelineno-9-59" href="#__codelineno-9-59"></a><span class="w">        </span><span class="n">pKFmax</span><span class="o">-&gt;</span><span class="n">AddConnection</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="n">nmax</span><span class="p">);</span>
<a id="__codelineno-9-60" name="__codelineno-9-60" href="#__codelineno-9-60"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-61" name="__codelineno-9-61" href="#__codelineno-9-61"></a>
<a id="__codelineno-9-62" name="__codelineno-9-62" href="#__codelineno-9-62"></a><span class="w">    </span><span class="n">sort</span><span class="p">(</span><span class="n">vPairs</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="n">vPairs</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
<a id="__codelineno-9-63" name="__codelineno-9-63" href="#__codelineno-9-63"></a><span class="w">    </span><span class="n">list</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">lKFs</span><span class="p">;</span>
<a id="__codelineno-9-64" name="__codelineno-9-64" href="#__codelineno-9-64"></a><span class="w">    </span><span class="n">list</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lWs</span><span class="p">;</span>
<a id="__codelineno-9-65" name="__codelineno-9-65" href="#__codelineno-9-65"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">vPairs</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-9-66" name="__codelineno-9-66" href="#__codelineno-9-66"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-9-67" name="__codelineno-9-67" href="#__codelineno-9-67"></a><span class="w">        </span><span class="n">lKFs</span><span class="p">.</span><span class="n">push_front</span><span class="p">(</span><span class="n">vPairs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">second</span><span class="p">);</span>
<a id="__codelineno-9-68" name="__codelineno-9-68" href="#__codelineno-9-68"></a><span class="w">        </span><span class="n">lWs</span><span class="p">.</span><span class="n">push_front</span><span class="p">(</span><span class="n">vPairs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">first</span><span class="p">);</span>
<a id="__codelineno-9-69" name="__codelineno-9-69" href="#__codelineno-9-69"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-70" name="__codelineno-9-70" href="#__codelineno-9-70"></a>
<a id="__codelineno-9-71" name="__codelineno-9-71" href="#__codelineno-9-71"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-9-72" name="__codelineno-9-72" href="#__codelineno-9-72"></a><span class="w">        </span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lockCon</span><span class="p">(</span><span class="n">mMutexConnections</span><span class="p">);</span>
<a id="__codelineno-9-73" name="__codelineno-9-73" href="#__codelineno-9-73"></a>
<a id="__codelineno-9-74" name="__codelineno-9-74" href="#__codelineno-9-74"></a><span class="w">        </span><span class="c1">// mspConnectedKeyFrames = spConnectedKeyFrames;</span>
<a id="__codelineno-9-75" name="__codelineno-9-75" href="#__codelineno-9-75"></a><span class="w">        </span><span class="n">mConnectedKeyFrameWeights</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KFcounter</span><span class="p">;</span>
<a id="__codelineno-9-76" name="__codelineno-9-76" href="#__codelineno-9-76"></a><span class="w">        </span><span class="n">mvpOrderedConnectedKeyFrames</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">lKFs</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="n">lKFs</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
<a id="__codelineno-9-77" name="__codelineno-9-77" href="#__codelineno-9-77"></a><span class="w">        </span><span class="n">mvOrderedWeights</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">lWs</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">lWs</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
<a id="__codelineno-9-78" name="__codelineno-9-78" href="#__codelineno-9-78"></a>
<a id="__codelineno-9-79" name="__codelineno-9-79" href="#__codelineno-9-79"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">mbFirstConnection</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mnId</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-9-80" name="__codelineno-9-80" href="#__codelineno-9-80"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-9-81" name="__codelineno-9-81" href="#__codelineno-9-81"></a><span class="w">            </span><span class="n">mpParent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mvpOrderedConnectedKeyFrames</span><span class="p">.</span><span class="n">front</span><span class="p">();</span>
<a id="__codelineno-9-82" name="__codelineno-9-82" href="#__codelineno-9-82"></a><span class="w">            </span><span class="n">mpParent</span><span class="o">-&gt;</span><span class="n">AddChild</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<a id="__codelineno-9-83" name="__codelineno-9-83" href="#__codelineno-9-83"></a><span class="w">            </span><span class="n">mbFirstConnection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-9-84" name="__codelineno-9-84" href="#__codelineno-9-84"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-9-85" name="__codelineno-9-85" href="#__codelineno-9-85"></a>
<a id="__codelineno-9-86" name="__codelineno-9-86" href="#__codelineno-9-86"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-87" name="__codelineno-9-87" href="#__codelineno-9-87"></a><span class="p">}</span>
<a id="__codelineno-9-88" name="__codelineno-9-88" href="#__codelineno-9-88"></a>
<a id="__codelineno-9-89" name="__codelineno-9-89" href="#__codelineno-9-89"></a><span class="kt">void</span><span class="w"> </span><span class="nf">KeyFrame::AddConnection</span><span class="p">(</span><span class="n">KeyFrame</span><span class="w"> </span><span class="o">*</span><span class="n">pKF</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">&amp;</span><span class="n">weight</span><span class="p">)</span>
<a id="__codelineno-9-90" name="__codelineno-9-90" href="#__codelineno-9-90"></a><span class="p">{</span>
<a id="__codelineno-9-91" name="__codelineno-9-91" href="#__codelineno-9-91"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-9-92" name="__codelineno-9-92" href="#__codelineno-9-92"></a><span class="w">        </span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">mMutexConnections</span><span class="p">);</span>
<a id="__codelineno-9-93" name="__codelineno-9-93" href="#__codelineno-9-93"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">mConnectedKeyFrameWeights</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">pKF</span><span class="p">))</span>
<a id="__codelineno-9-94" name="__codelineno-9-94" href="#__codelineno-9-94"></a><span class="w">            </span><span class="n">mConnectedKeyFrameWeights</span><span class="p">[</span><span class="n">pKF</span><span class="p">]</span><span class="o">=</span><span class="n">weight</span><span class="p">;</span>
<a id="__codelineno-9-95" name="__codelineno-9-95" href="#__codelineno-9-95"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">mConnectedKeyFrameWeights</span><span class="p">[</span><span class="n">pKF</span><span class="p">]</span><span class="o">!=</span><span class="n">weight</span><span class="p">)</span>
<a id="__codelineno-9-96" name="__codelineno-9-96" href="#__codelineno-9-96"></a><span class="w">            </span><span class="n">mConnectedKeyFrameWeights</span><span class="p">[</span><span class="n">pKF</span><span class="p">]</span><span class="o">=</span><span class="n">weight</span><span class="p">;</span>
<a id="__codelineno-9-97" name="__codelineno-9-97" href="#__codelineno-9-97"></a><span class="w">        </span><span class="k">else</span>
<a id="__codelineno-9-98" name="__codelineno-9-98" href="#__codelineno-9-98"></a><span class="w">            </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-9-99" name="__codelineno-9-99" href="#__codelineno-9-99"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-100" name="__codelineno-9-100" href="#__codelineno-9-100"></a>
<a id="__codelineno-9-101" name="__codelineno-9-101" href="#__codelineno-9-101"></a><span class="w">    </span><span class="n">UpdateBestCovisibles</span><span class="p">();</span>
<a id="__codelineno-9-102" name="__codelineno-9-102" href="#__codelineno-9-102"></a><span class="p">}</span>
<a id="__codelineno-9-103" name="__codelineno-9-103" href="#__codelineno-9-103"></a>
<a id="__codelineno-9-104" name="__codelineno-9-104" href="#__codelineno-9-104"></a><span class="kt">void</span><span class="w"> </span><span class="nf">KeyFrame::UpdateBestCovisibles</span><span class="p">()</span>
<a id="__codelineno-9-105" name="__codelineno-9-105" href="#__codelineno-9-105"></a><span class="p">{</span>
<a id="__codelineno-9-106" name="__codelineno-9-106" href="#__codelineno-9-106"></a><span class="w">    </span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">mMutexConnections</span><span class="p">);</span>
<a id="__codelineno-9-107" name="__codelineno-9-107" href="#__codelineno-9-107"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="n">KeyFrame</span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vPairs</span><span class="p">;</span>
<a id="__codelineno-9-108" name="__codelineno-9-108" href="#__codelineno-9-108"></a><span class="w">    </span><span class="n">vPairs</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">mConnectedKeyFrameWeights</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
<a id="__codelineno-9-109" name="__codelineno-9-109" href="#__codelineno-9-109"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">map</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*</span><span class="p">,</span><span class="kt">int</span><span class="o">&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">mit</span><span class="o">=</span><span class="n">mConnectedKeyFrameWeights</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">mend</span><span class="o">=</span><span class="n">mConnectedKeyFrameWeights</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">mit</span><span class="o">!=</span><span class="n">mend</span><span class="p">;</span><span class="w"> </span><span class="n">mit</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-9-110" name="__codelineno-9-110" href="#__codelineno-9-110"></a><span class="w">       </span><span class="n">vPairs</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">make_pair</span><span class="p">(</span><span class="n">mit</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">,</span><span class="n">mit</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">));</span>
<a id="__codelineno-9-111" name="__codelineno-9-111" href="#__codelineno-9-111"></a>
<a id="__codelineno-9-112" name="__codelineno-9-112" href="#__codelineno-9-112"></a><span class="w">    </span><span class="n">sort</span><span class="p">(</span><span class="n">vPairs</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="n">vPairs</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
<a id="__codelineno-9-113" name="__codelineno-9-113" href="#__codelineno-9-113"></a><span class="w">    </span><span class="n">list</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">lKFs</span><span class="p">;</span>
<a id="__codelineno-9-114" name="__codelineno-9-114" href="#__codelineno-9-114"></a><span class="w">    </span><span class="n">list</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lWs</span><span class="p">;</span>
<a id="__codelineno-9-115" name="__codelineno-9-115" href="#__codelineno-9-115"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">iend</span><span class="o">=</span><span class="n">vPairs</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">iend</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-9-116" name="__codelineno-9-116" href="#__codelineno-9-116"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-9-117" name="__codelineno-9-117" href="#__codelineno-9-117"></a><span class="w">        </span><span class="n">lKFs</span><span class="p">.</span><span class="n">push_front</span><span class="p">(</span><span class="n">vPairs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">second</span><span class="p">);</span>
<a id="__codelineno-9-118" name="__codelineno-9-118" href="#__codelineno-9-118"></a><span class="w">        </span><span class="n">lWs</span><span class="p">.</span><span class="n">push_front</span><span class="p">(</span><span class="n">vPairs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">first</span><span class="p">);</span>
<a id="__codelineno-9-119" name="__codelineno-9-119" href="#__codelineno-9-119"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-120" name="__codelineno-9-120" href="#__codelineno-9-120"></a>
<a id="__codelineno-9-121" name="__codelineno-9-121" href="#__codelineno-9-121"></a><span class="w">    </span><span class="n">mvpOrderedConnectedKeyFrames</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">lKFs</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="n">lKFs</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
<a id="__codelineno-9-122" name="__codelineno-9-122" href="#__codelineno-9-122"></a><span class="w">    </span><span class="n">mvOrderedWeights</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">lWs</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">lWs</span><span class="p">.</span><span class="n">end</span><span class="p">());</span><span class="w">    </span>
<a id="__codelineno-9-123" name="__codelineno-9-123" href="#__codelineno-9-123"></a><span class="p">}</span>
</code></pre></div>
<h3 id="connected-keyframes-vs-co-visibility-keyframes">Connected Keyframes vs Co-Visibility Keyframes</h3>
<p>Both are referring to the keyframe list about some keyframes sharing some observed feature points.
The differences are </p>
<ul>
<li><code>mvpOrderedConnectedKeyFrames</code> takes co-visible keyframes as elements when <code>if(mit-&gt;second&gt;=th)</code> holds true, and is built after <code>sort(vPairs.begin(),vPairs.end());</code> meaning the elements are sorted by their observed shared feature points </li>
<li><code>mConnectedKeyFrameWeights</code> take direct definition from <code>KFcounter</code> and update the weights (number of shared observed feature points)</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="n">set</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">KeyFrame</span><span class="o">::</span><span class="n">GetConnectedKeyFrames</span><span class="p">()</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="p">{</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">    </span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">mMutexConnections</span><span class="p">);</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">    </span><span class="n">set</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">s</span><span class="p">;</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">map</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*</span><span class="p">,</span><span class="kt">int</span><span class="o">&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">mit</span><span class="o">=</span><span class="n">mConnectedKeyFrameWeights</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="n">mit</span><span class="o">!=</span><span class="n">mConnectedKeyFrameWeights</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="n">mit</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w">        </span><span class="n">s</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">mit</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">);</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">s</span><span class="p">;</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="p">}</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="n">vector</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">KeyFrame</span><span class="o">::</span><span class="n">GetVectorCovisibleKeyFrames</span><span class="p">()</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="p">{</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="w">    </span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">mMutexConnections</span><span class="p">);</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a><span class="w">    </span><span class="c1">// if(mit-&gt;second&gt;=th)</span>
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a><span class="w">    </span><span class="c1">// {</span>
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a><span class="w">    </span><span class="c1">//     vPairs.push_back(make_pair(mit-&gt;second,mit-&gt;first));</span>
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a><span class="w">    </span><span class="c1">//     (mit-&gt;first)-&gt;AddConnection(this,mit-&gt;second);</span>
<a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a><span class="w">    </span><span class="c1">// }</span>
<a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a><span class="w">    </span><span class="c1">// for(size_t i=0; i&lt;vPairs.size();i++)</span>
<a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a><span class="w">    </span><span class="c1">// {</span>
<a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a><span class="w">    </span><span class="c1">//     lKFs.push_front(vPairs[i].second);</span>
<a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a><span class="w">    </span><span class="c1">//     lWs.push_front(vPairs[i].first);</span>
<a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a><span class="w">    </span><span class="c1">// }</span>
<a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a><span class="w">    </span><span class="c1">// mvpOrderedConnectedKeyFrames = vector&lt;KeyFrame*&gt;(lKFs.begin(),lKFs.end());</span>
<a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">mvpOrderedConnectedKeyFrames</span><span class="p">;</span>
<a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a><span class="p">}</span>
</code></pre></div>
<h3 id="spanning-tree-and-essential-graph">Spanning Tree and Essential Graph</h3>
<p>Every keyframe has a <code>mpParent</code> which is a keyframe pointer <code>KeyFrame*</code> that shares the most feature points with the current keyframe.
Then, the most co-visible keyframe <code>mpParent</code> adds the current keyframe <code>this</code> as its child.</p>
<p>As more and more keyframes are created, a spanning tree can be constructed.
If a keyframe represents a road intersection that a vehicle would repeatedly visit, this keyframe should have many children, otherwise, a keyframe might just have one child keyframe that is the neighbor of the keyframe.</p>
<p>One keyframe just has one <code>mpParent</code>.
One parent keyframe such as a road intersection can have many children.
Some keyframes might not have any child.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">KeyFrame::UpdateConnections</span><span class="p">()</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="p">{</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="w">    </span><span class="c1">// `mbFirstConnection` is init to true when a keyframe is created</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="w">    </span><span class="c1">// `mnId=nNextId++;` where `long unsigned int KeyFrame::nNextId=0;` which is a global var</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mbFirstConnection</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mnId</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="w">        </span><span class="n">mpParent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mvpOrderedConnectedKeyFrames</span><span class="p">.</span><span class="n">front</span><span class="p">();</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="w">        </span><span class="n">mpParent</span><span class="o">-&gt;</span><span class="n">AddChild</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="w">        </span><span class="n">mbFirstConnection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="p">}</span>
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="kt">void</span><span class="w"> </span><span class="nf">KeyFrame::AddChild</span><span class="p">(</span><span class="n">KeyFrame</span><span class="w"> </span><span class="o">*</span><span class="n">pKF</span><span class="p">)</span>
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a><span class="p">{</span>
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a><span class="w">    </span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lockCon</span><span class="p">(</span><span class="n">mMutexConnections</span><span class="p">);</span>
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>
<a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a><span class="w">    </span><span class="c1">// std::set&lt;ORB_SLAM2::KeyFrame *&gt; ORB_SLAM2::KeyFrame::mspChildrens</span>
<a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a><span class="w">    </span><span class="n">mspChildrens</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pKF</span><span class="p">);</span>
<a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a><span class="p">}</span>
</code></pre></div>
<p>The spanning tree is exactly defined as one keyframe just has one <code>mpParent</code>.</p>
<p>The Essential Graph contains the spanning tree, the subset of edges from the co-visibility graph with high co-visibility
(should at least have <span class="arithmatex">\(100\)</span> co-visible features), and the loop closure edges, resulting in a strong network of cameras.</p>
<div style="display: flex; justify-content: center;">
      <img src="imgs/orbslam_graphs.png" width="30%" height="30%" alt="orbslam_graphs" /> 
</div>
<p><br/></p>
<h2 id="orb-extractor">ORB Extractor</h2>
<p>Some <code>ORBextractor</code> init arguments are
* <code>nfeatures</code> number of features
* <code>scaleFactor</code> pyramid scaling factor
* <code>nlevel</code> number of pyramid level
* <code>iniThFAST</code> FAST initial threshold
* <code>minThFAST</code> FAST minimal threshold</p>
<p>Images are scaled by pyramid: <code>nlevel=8</code> levels and <code>scaleFactor=1.2</code> for each level increment.</p>
<p>The <code>ORBextractor</code> constructor inits the pyramid scaling with the above parameters.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="n">ORBextractor</span><span class="o">::</span><span class="n">ORBextractor</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">_nfeatures</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">_scaleFactor</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">_nlevels</span><span class="p">,</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="w">         </span><span class="kt">int</span><span class="w"> </span><span class="n">_iniThFAST</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">_minThFAST</span><span class="p">)</span><span class="o">:</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">    </span><span class="n">nfeatures</span><span class="p">(</span><span class="n">_nfeatures</span><span class="p">),</span><span class="w"> </span><span class="n">scaleFactor</span><span class="p">(</span><span class="n">_scaleFactor</span><span class="p">),</span><span class="w"> </span><span class="n">nlevels</span><span class="p">(</span><span class="n">_nlevels</span><span class="p">),</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">    </span><span class="n">iniThFAST</span><span class="p">(</span><span class="n">_iniThFAST</span><span class="p">),</span><span class="w"> </span><span class="n">minThFAST</span><span class="p">(</span><span class="n">_minThFAST</span><span class="p">)</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="p">{</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">    </span><span class="n">mvScaleFactor</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">nlevels</span><span class="p">);</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="w">    </span><span class="n">mvLevelSigma2</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">nlevels</span><span class="p">);</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="w">    </span><span class="n">mvScaleFactor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mf">1.0f</span><span class="p">;</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="w">    </span><span class="n">mvLevelSigma2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mf">1.0f</span><span class="p">;</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">nlevels</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="w">        </span><span class="c1">// 1.2 = 1 * 1.2; 1.44 = 1.2 * 1.2; 1.728 = 1.44 * 1.2 ...</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="w">        </span><span class="n">mvScaleFactor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">mvScaleFactor</span><span class="p">[</span><span class="n">i</span><span class="mi">-1</span><span class="p">]</span><span class="o">*</span><span class="n">scaleFactor</span><span class="p">;</span>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="w">        </span><span class="c1">// 1.44 = 1.2 * 1.2; 2.0736 = 1.44 * 1.44; 4.2998 = 2.0736 * 2.0736 ...</span>
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a><span class="w">        </span><span class="n">mvLevelSigma2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">mvScaleFactor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">mvScaleFactor</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a><span class="w">    </span><span class="n">mvInvScaleFactor</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">nlevels</span><span class="p">);</span>
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a><span class="w">    </span><span class="n">mvInvLevelSigma2</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">nlevels</span><span class="p">);</span>
<a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">nlevels</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a><span class="w">        </span><span class="c1">// 1 = 1/1; 0.833 = 1/1.2; 0.694 = 1/1.44 ...</span>
<a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a><span class="w">        </span><span class="n">mvInvScaleFactor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mf">1.0f</span><span class="o">/</span><span class="n">mvScaleFactor</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a><span class="w">        </span><span class="c1">// 0.694 = 1/1.44; 0.482 = 1/2.0736 ...</span>
<a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a><span class="w">        </span><span class="n">mvInvLevelSigma2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mf">1.0f</span><span class="o">/</span><span class="n">mvLevelSigma2</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a>
<a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a><span class="w">    </span><span class="n">mvImagePyramid</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">nlevels</span><span class="p">);</span>
<a id="__codelineno-12-29" name="__codelineno-12-29" href="#__codelineno-12-29"></a>
<a id="__codelineno-12-30" name="__codelineno-12-30" href="#__codelineno-12-30"></a><span class="w">    </span><span class="n">mnFeaturesPerLevel</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">nlevels</span><span class="p">);</span>
<a id="__codelineno-12-31" name="__codelineno-12-31" href="#__codelineno-12-31"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">factor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0f</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">scaleFactor</span><span class="p">;</span><span class="w"> </span><span class="c1">// 0.833 = 1/1.2</span>
<a id="__codelineno-12-32" name="__codelineno-12-32" href="#__codelineno-12-32"></a><span class="w">    </span><span class="c1">// 1000 * (1 - 0.833) / (1 - 0.833^8)</span>
<a id="__codelineno-12-33" name="__codelineno-12-33" href="#__codelineno-12-33"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">nDesiredFeaturesPerScale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nfeatures</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">factor</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">pow</span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="n">factor</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">nlevels</span><span class="p">));</span>
<a id="__codelineno-12-34" name="__codelineno-12-34" href="#__codelineno-12-34"></a>
<a id="__codelineno-12-35" name="__codelineno-12-35" href="#__codelineno-12-35"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">sumFeatures</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-12-36" name="__codelineno-12-36" href="#__codelineno-12-36"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nlevels</span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="n">level</span><span class="o">++</span><span class="w"> </span><span class="p">)</span>
<a id="__codelineno-12-37" name="__codelineno-12-37" href="#__codelineno-12-37"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-12-38" name="__codelineno-12-38" href="#__codelineno-12-38"></a><span class="w">        </span><span class="n">mnFeaturesPerLevel</span><span class="p">[</span><span class="n">level</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cvRound</span><span class="p">(</span><span class="n">nDesiredFeaturesPerScale</span><span class="p">);</span>
<a id="__codelineno-12-39" name="__codelineno-12-39" href="#__codelineno-12-39"></a><span class="w">        </span><span class="n">sumFeatures</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">mnFeaturesPerLevel</span><span class="p">[</span><span class="n">level</span><span class="p">];</span>
<a id="__codelineno-12-40" name="__codelineno-12-40" href="#__codelineno-12-40"></a><span class="w">        </span><span class="n">nDesiredFeaturesPerScale</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">factor</span><span class="p">;</span>
<a id="__codelineno-12-41" name="__codelineno-12-41" href="#__codelineno-12-41"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-42" name="__codelineno-12-42" href="#__codelineno-12-42"></a><span class="w">    </span><span class="n">mnFeaturesPerLevel</span><span class="p">[</span><span class="n">nlevels</span><span class="mi">-1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">nfeatures</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sumFeatures</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-12-43" name="__codelineno-12-43" href="#__codelineno-12-43"></a>
<a id="__codelineno-12-44" name="__codelineno-12-44" href="#__codelineno-12-44"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">npoints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">512</span><span class="p">;</span>
<a id="__codelineno-12-45" name="__codelineno-12-45" href="#__codelineno-12-45"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">Point</span><span class="o">*</span><span class="w"> </span><span class="n">pattern0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Point</span><span class="o">*</span><span class="p">)</span><span class="n">bit_pattern_31_</span><span class="p">;</span>
<a id="__codelineno-12-46" name="__codelineno-12-46" href="#__codelineno-12-46"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">copy</span><span class="p">(</span><span class="n">pattern0</span><span class="p">,</span><span class="w"> </span><span class="n">pattern0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">npoints</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">back_inserter</span><span class="p">(</span><span class="n">pattern</span><span class="p">));</span>
<a id="__codelineno-12-47" name="__codelineno-12-47" href="#__codelineno-12-47"></a>
<a id="__codelineno-12-48" name="__codelineno-12-48" href="#__codelineno-12-48"></a><span class="w">    </span><span class="c1">// This is for orientation</span>
<a id="__codelineno-12-49" name="__codelineno-12-49" href="#__codelineno-12-49"></a><span class="w">    </span><span class="c1">// pre-compute the end of a row in a circular patch</span>
<a id="__codelineno-12-50" name="__codelineno-12-50" href="#__codelineno-12-50"></a><span class="w">    </span><span class="c1">// HALF_PATCH_SIZE = 15</span>
<a id="__codelineno-12-51" name="__codelineno-12-51" href="#__codelineno-12-51"></a><span class="w">    </span><span class="n">umax</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">HALF_PATCH_SIZE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-12-52" name="__codelineno-12-52" href="#__codelineno-12-52"></a>
<a id="__codelineno-12-53" name="__codelineno-12-53" href="#__codelineno-12-53"></a><span class="w">    </span><span class="c1">// vmax = 11 = 15 * 0.707 + 1</span>
<a id="__codelineno-12-54" name="__codelineno-12-54" href="#__codelineno-12-54"></a><span class="w">    </span><span class="c1">// vmin = 11 = 15 * 0.707</span>
<a id="__codelineno-12-55" name="__codelineno-12-55" href="#__codelineno-12-55"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">vmax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cvFloor</span><span class="p">(</span><span class="n">HALF_PATCH_SIZE</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.f</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-12-56" name="__codelineno-12-56" href="#__codelineno-12-56"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">vmin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cvCeil</span><span class="p">(</span><span class="n">HALF_PATCH_SIZE</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.f</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-12-57" name="__codelineno-12-57" href="#__codelineno-12-57"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">hp2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HALF_PATCH_SIZE</span><span class="o">*</span><span class="n">HALF_PATCH_SIZE</span><span class="p">;</span><span class="w"> </span><span class="c1">// hp2 = 225 = 15 * 15</span>
<a id="__codelineno-12-58" name="__codelineno-12-58" href="#__codelineno-12-58"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">vmax</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">v</span><span class="p">)</span>
<a id="__codelineno-12-59" name="__codelineno-12-59" href="#__codelineno-12-59"></a><span class="w">        </span><span class="n">umax</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cvRound</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">hp2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">v</span><span class="p">));</span><span class="w"> </span><span class="c1">// 225 - 0; 225 - 1; 225 -4; 225 - 16 ...</span>
<a id="__codelineno-12-60" name="__codelineno-12-60" href="#__codelineno-12-60"></a>
<a id="__codelineno-12-61" name="__codelineno-12-61" href="#__codelineno-12-61"></a><span class="w">    </span><span class="c1">// Make sure we are symmetric</span>
<a id="__codelineno-12-62" name="__codelineno-12-62" href="#__codelineno-12-62"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HALF_PATCH_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">v0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">vmin</span><span class="p">;</span><span class="w"> </span><span class="o">--</span><span class="n">v</span><span class="p">)</span>
<a id="__codelineno-12-63" name="__codelineno-12-63" href="#__codelineno-12-63"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-12-64" name="__codelineno-12-64" href="#__codelineno-12-64"></a><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">umax</span><span class="p">[</span><span class="n">v0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">umax</span><span class="p">[</span><span class="n">v0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-12-65" name="__codelineno-12-65" href="#__codelineno-12-65"></a><span class="w">            </span><span class="o">++</span><span class="n">v0</span><span class="p">;</span>
<a id="__codelineno-12-66" name="__codelineno-12-66" href="#__codelineno-12-66"></a><span class="w">        </span><span class="n">umax</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v0</span><span class="p">;</span>
<a id="__codelineno-12-67" name="__codelineno-12-67" href="#__codelineno-12-67"></a><span class="w">        </span><span class="o">++</span><span class="n">v0</span><span class="p">;</span>
<a id="__codelineno-12-68" name="__codelineno-12-68" href="#__codelineno-12-68"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-69" name="__codelineno-12-69" href="#__codelineno-12-69"></a><span class="p">}</span>
</code></pre></div>
<h3 id="fast-feature-orientation">FAST Feature Orientation</h3>
<p>For a radius of <span class="arithmatex">\(15\)</span> patch, there is</p>
<div class="arithmatex">\[
\begin{align*}
m_{10} &amp;= 
\sum^{15}_{u=-15} \sum^{15}_{v=-15} u^1 v^0 i(u,v)
\\\\ &amp;=
\sum^{15}_{u=-15} \sum^{15}_{v=-15} u \space i(u,v)
\end{align*}
\qquad
\begin{align*}
m_{01} &amp;= 
\sum^{15}_{u=-15} \sum^{15}_{v=-15} u^0 v^1 i(u,v)
\\\\ &amp;=
\sum^{15}_{u=-15} \sum^{15}_{v=-15} v \space i(u,v)
\end{align*}
\]</div>
<p>The orientation is computed as</p>
<div class="arithmatex">\[
\theta = 
\arctan2(m_{01}, m_{10})
\]</div>
<p>Given the above FAST orientation formula, the code implementation below:
* compute within the FAST radius <code>HALF_PATCH_SIZE</code>
* Take the center FAST feature <code>const uchar* center = &amp;image.at&lt;uchar&gt; (cvRound(pt.y), cvRound(pt.x));</code>
* <span class="arithmatex">\(m_{10}\)</span> and <span class="arithmatex">\(m_{01}\)</span> are computed according to the formula
* return <code>fastAtan2((float)m_01, (float)m_10);</code> (<span class="arithmatex">\(\theta = \arctan2(m_{01}, m_{10})\)</span>)</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="k">namespace</span><span class="w"> </span><span class="nn">ORB_SLAM2</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="p">{</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">PATCH_SIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">31</span><span class="p">;</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">HALF_PATCH_SIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">15</span><span class="p">;</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">EDGE_THRESHOLD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">19</span><span class="p">;</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="k">static</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="nf">IC_Angle</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Mat</span><span class="o">&amp;</span><span class="w"> </span><span class="n">image</span><span class="p">,</span><span class="w"> </span><span class="n">Point2f</span><span class="w"> </span><span class="n">pt</span><span class="p">,</span><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">u_max</span><span class="p">)</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="p">{</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">m_01</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">m_10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">uchar</span><span class="o">*</span><span class="w"> </span><span class="n">center</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">image</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="n">uchar</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">cvRound</span><span class="p">(</span><span class="n">pt</span><span class="p">.</span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="n">cvRound</span><span class="p">(</span><span class="n">pt</span><span class="p">.</span><span class="n">x</span><span class="p">));</span>
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a><span class="w">    </span><span class="c1">// Treat the center line differently, v=0</span>
<a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">HALF_PATCH_SIZE</span><span class="p">;</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">HALF_PATCH_SIZE</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">u</span><span class="p">)</span>
<a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a><span class="w">        </span><span class="n">m_10</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">center</span><span class="p">[</span><span class="n">u</span><span class="p">];</span>
<a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a>
<a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a><span class="w">    </span><span class="c1">// Go line by line in the circuI853lar patch</span>
<a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">step</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">image</span><span class="p">.</span><span class="n">step1</span><span class="p">();</span>
<a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">HALF_PATCH_SIZE</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">v</span><span class="p">)</span>
<a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a><span class="w">        </span><span class="c1">// Proceed over the two lines</span>
<a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">v_sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u_max</span><span class="p">[</span><span class="n">v</span><span class="p">];</span>
<a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">d</span><span class="p">;</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">d</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">u</span><span class="p">)</span>
<a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">val_plus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">center</span><span class="p">[</span><span class="n">u</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">v</span><span class="o">*</span><span class="n">step</span><span class="p">],</span><span class="w"> </span><span class="n">val_minus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">center</span><span class="p">[</span><span class="n">u</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">v</span><span class="o">*</span><span class="n">step</span><span class="p">];</span>
<a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a><span class="w">            </span><span class="n">v_sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="n">val_plus</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">val_minus</span><span class="p">);</span>
<a id="__codelineno-13-30" name="__codelineno-13-30" href="#__codelineno-13-30"></a><span class="w">            </span><span class="n">m_10</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">val_plus</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">val_minus</span><span class="p">);</span>
<a id="__codelineno-13-31" name="__codelineno-13-31" href="#__codelineno-13-31"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-13-32" name="__codelineno-13-32" href="#__codelineno-13-32"></a><span class="w">        </span><span class="n">m_01</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">v_sum</span><span class="p">;</span>
<a id="__codelineno-13-33" name="__codelineno-13-33" href="#__codelineno-13-33"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-13-34" name="__codelineno-13-34" href="#__codelineno-13-34"></a>
<a id="__codelineno-13-35" name="__codelineno-13-35" href="#__codelineno-13-35"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">fastAtan2</span><span class="p">((</span><span class="kt">float</span><span class="p">)</span><span class="n">m_01</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">m_10</span><span class="p">);</span>
<a id="__codelineno-13-36" name="__codelineno-13-36" href="#__codelineno-13-36"></a><span class="p">}</span>
<a id="__codelineno-13-37" name="__codelineno-13-37" href="#__codelineno-13-37"></a><span class="p">}</span>
</code></pre></div>
<p>The <code>computeOrientation(...)</code> computes keypoint's angle by the <code>IC_Angle(...)</code>.
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">computeOrientation</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Mat</span><span class="o">&amp;</span><span class="w"> </span><span class="n">image</span><span class="p">,</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KeyPoint</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">keypoints</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">umax</span><span class="p">)</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="p">{</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KeyPoint</span><span class="o">&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">keypoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">keypoints</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="w">         </span><span class="n">keypointEnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">keypoints</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">keypoint</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">keypointEnd</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">keypoint</span><span class="p">)</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="w">        </span><span class="n">keypoint</span><span class="o">-&gt;</span><span class="n">angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IC_Angle</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="w"> </span><span class="n">keypoint</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">,</span><span class="w"> </span><span class="n">umax</span><span class="p">);</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="p">}</span>
</code></pre></div></p>
<h3 id="orb-feature-pair-test">ORB Feature Pair Test</h3>
<p>A total of <span class="arithmatex">\(256=32 \times 8\)</span> tests are conducted as below.
Since each pair test result is of one bit (either <code>true</code>/<code>false</code>, or <span class="arithmatex">\(1\)</span>/<span class="arithmatex">\(0\)</span>), every time, together <span class="arithmatex">\(8\)</span>-bit results are put into one <code>uchar</code> such as <code>desc[i] = (uchar)val;</code>.</p>
<div class="arithmatex">\[
t(p,q) = 
\left\{ 
    \begin{matrix}
        1 &amp; \quad p &gt; q \\\\
        0 &amp; \quad p \le q \\\\
    \end{matrix}
\right.
\]</div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">computeOrbDescriptor</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">KeyPoint</span><span class="o">&amp;</span><span class="w"> </span><span class="n">kpt</span><span class="p">,</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="w">                                 </span><span class="k">const</span><span class="w"> </span><span class="n">Mat</span><span class="o">&amp;</span><span class="w"> </span><span class="n">img</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">Point</span><span class="o">*</span><span class="w"> </span><span class="n">pattern</span><span class="p">,</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="w">                                 </span><span class="n">uchar</span><span class="o">*</span><span class="w"> </span><span class="n">desc</span><span class="p">)</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="p">{</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">kpt</span><span class="p">.</span><span class="n">angle</span><span class="o">*</span><span class="n">factorPI</span><span class="p">;</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">);</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">uchar</span><span class="o">*</span><span class="w"> </span><span class="n">center</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">img</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="n">uchar</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cvRound</span><span class="p">(</span><span class="n">kpt</span><span class="p">.</span><span class="n">pt</span><span class="p">.</span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="n">cvRound</span><span class="p">(</span><span class="n">kpt</span><span class="p">.</span><span class="n">pt</span><span class="p">.</span><span class="n">x</span><span class="p">));</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">step</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">img</span><span class="p">.</span><span class="n">step</span><span class="p">;</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="w">    </span><span class="cp">#define GET_VALUE(idx) \</span>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="cp">        center[cvRound(pattern[idx].x*b + pattern[idx].y*a)*step + \</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a><span class="cp">               cvRound(pattern[idx].x*a - pattern[idx].y*b)]</span>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">pattern</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span>
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">;</span>
<a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a><span class="w">        </span><span class="n">t0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GET_VALUE</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GET_VALUE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a><span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t0</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">t1</span><span class="p">;</span>
<a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a><span class="w">        </span><span class="n">t0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GET_VALUE</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GET_VALUE</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a><span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="n">t0</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a><span class="w">        </span><span class="n">t0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GET_VALUE</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GET_VALUE</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a><span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="n">t0</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a><span class="w">        </span><span class="n">t0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GET_VALUE</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GET_VALUE</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
<a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a><span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="n">t0</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<a id="__codelineno-15-27" name="__codelineno-15-27" href="#__codelineno-15-27"></a><span class="w">        </span><span class="n">t0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GET_VALUE</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GET_VALUE</span><span class="p">(</span><span class="mi">9</span><span class="p">);</span>
<a id="__codelineno-15-28" name="__codelineno-15-28" href="#__codelineno-15-28"></a><span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="n">t0</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<a id="__codelineno-15-29" name="__codelineno-15-29" href="#__codelineno-15-29"></a><span class="w">        </span><span class="n">t0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GET_VALUE</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GET_VALUE</span><span class="p">(</span><span class="mi">11</span><span class="p">);</span>
<a id="__codelineno-15-30" name="__codelineno-15-30" href="#__codelineno-15-30"></a><span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="n">t0</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<a id="__codelineno-15-31" name="__codelineno-15-31" href="#__codelineno-15-31"></a><span class="w">        </span><span class="n">t0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GET_VALUE</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GET_VALUE</span><span class="p">(</span><span class="mi">13</span><span class="p">);</span>
<a id="__codelineno-15-32" name="__codelineno-15-32" href="#__codelineno-15-32"></a><span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="n">t0</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span>
<a id="__codelineno-15-33" name="__codelineno-15-33" href="#__codelineno-15-33"></a><span class="w">        </span><span class="n">t0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GET_VALUE</span><span class="p">(</span><span class="mi">14</span><span class="p">);</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GET_VALUE</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>
<a id="__codelineno-15-34" name="__codelineno-15-34" href="#__codelineno-15-34"></a><span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="n">t0</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span>
<a id="__codelineno-15-35" name="__codelineno-15-35" href="#__codelineno-15-35"></a>
<a id="__codelineno-15-36" name="__codelineno-15-36" href="#__codelineno-15-36"></a><span class="w">        </span><span class="n">desc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uchar</span><span class="p">)</span><span class="n">val</span><span class="p">;</span>
<a id="__codelineno-15-37" name="__codelineno-15-37" href="#__codelineno-15-37"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-15-38" name="__codelineno-15-38" href="#__codelineno-15-38"></a>
<a id="__codelineno-15-39" name="__codelineno-15-39" href="#__codelineno-15-39"></a><span class="w">    </span><span class="cp">#undef GET_VALUE</span>
<a id="__codelineno-15-40" name="__codelineno-15-40" href="#__codelineno-15-40"></a><span class="p">}</span>
</code></pre></div>
<h3 id="octree-for-orb-feature">Octree For ORB Feature</h3>
<p><code>ExtractorNode</code> defines the octree (in 2d it is named quadtree) space for ORB feature storage.</p>
<div style="display: flex; justify-content: center;">
      <img src="imgs/quadtree.png" width="40%" height="30%" alt="quadtree" />
</div>
<p></br></p>
<p>First, define four boundary params <code>cv::Point2i UL, UR, BL, BR;</code> for Upper Left, Upper Right, Bottom Left, Bottom Right.
Then, compute the half space <code>halfX</code> and <code>halfY</code>.</p>
<p>Every node divide produces four subspaces <code>n1, n2, n3, n4</code>.
Keypoints are associated to the four nodes according to their coordinates on the image by <code>ni.vKeys.push_back(kp);</code></p>
<p><code>ExtractorNode::DivideNode(...)</code> is called in <code>ORBextractor::DistributeOctTree(...)</code> to perform space division.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">ExtractorNode</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="p">{</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="k">public</span><span class="o">:</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">    </span><span class="n">ExtractorNode</span><span class="p">()</span><span class="o">:</span><span class="n">bNoMore</span><span class="p">(</span><span class="nb">false</span><span class="p">){}</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">DivideNode</span><span class="p">(</span><span class="n">ExtractorNode</span><span class="w"> </span><span class="o">&amp;</span><span class="n">n1</span><span class="p">,</span><span class="w"> </span><span class="n">ExtractorNode</span><span class="w"> </span><span class="o">&amp;</span><span class="n">n2</span><span class="p">,</span><span class="w"> </span><span class="n">ExtractorNode</span><span class="w"> </span><span class="o">&amp;</span><span class="n">n3</span><span class="p">,</span><span class="w"> </span><span class="n">ExtractorNode</span><span class="w"> </span><span class="o">&amp;</span><span class="n">n4</span><span class="p">);</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">KeyPoint</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vKeys</span><span class="p">;</span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Point2i</span><span class="w"> </span><span class="n">UL</span><span class="p">,</span><span class="w"> </span><span class="n">UR</span><span class="p">,</span><span class="w"> </span><span class="n">BL</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">;</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">ExtractorNode</span><span class="o">&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">lit</span><span class="p">;</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">bNoMore</span><span class="p">;</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="p">};</span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="kt">void</span><span class="w"> </span><span class="nf">ExtractorNode::DivideNode</span><span class="p">(</span><span class="n">ExtractorNode</span><span class="w"> </span><span class="o">&amp;</span><span class="n">n1</span><span class="p">,</span><span class="w"> </span><span class="n">ExtractorNode</span><span class="w"> </span><span class="o">&amp;</span><span class="n">n2</span><span class="p">,</span><span class="w"> </span><span class="n">ExtractorNode</span><span class="w"> </span><span class="o">&amp;</span><span class="n">n3</span><span class="p">,</span><span class="w"> </span><span class="n">ExtractorNode</span><span class="w"> </span><span class="o">&amp;</span><span class="n">n4</span><span class="p">)</span>
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="p">{</span>
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">halfX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ceil</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">UR</span><span class="p">.</span><span class="n">x</span><span class="o">-</span><span class="n">UL</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">halfY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ceil</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BR</span><span class="p">.</span><span class="n">y</span><span class="o">-</span><span class="n">UL</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a>
<a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a><span class="w">    </span><span class="c1">//Define boundaries of children</span>
<a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a><span class="w">    </span><span class="n">n1</span><span class="p">.</span><span class="n">UL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UL</span><span class="p">;</span>
<a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a><span class="w">    </span><span class="n">n1</span><span class="p">.</span><span class="n">UR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Point2i</span><span class="p">(</span><span class="n">UL</span><span class="p">.</span><span class="n">x</span><span class="o">+</span><span class="n">halfX</span><span class="p">,</span><span class="n">UL</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
<a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a><span class="w">    </span><span class="n">n1</span><span class="p">.</span><span class="n">BL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Point2i</span><span class="p">(</span><span class="n">UL</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="n">UL</span><span class="p">.</span><span class="n">y</span><span class="o">+</span><span class="n">halfY</span><span class="p">);</span>
<a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a><span class="w">    </span><span class="n">n1</span><span class="p">.</span><span class="n">BR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Point2i</span><span class="p">(</span><span class="n">UL</span><span class="p">.</span><span class="n">x</span><span class="o">+</span><span class="n">halfX</span><span class="p">,</span><span class="n">UL</span><span class="p">.</span><span class="n">y</span><span class="o">+</span><span class="n">halfY</span><span class="p">);</span>
<a id="__codelineno-16-24" name="__codelineno-16-24" href="#__codelineno-16-24"></a><span class="w">    </span><span class="n">n1</span><span class="p">.</span><span class="n">vKeys</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">vKeys</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
<a id="__codelineno-16-25" name="__codelineno-16-25" href="#__codelineno-16-25"></a>
<a id="__codelineno-16-26" name="__codelineno-16-26" href="#__codelineno-16-26"></a><span class="w">    </span><span class="n">n2</span><span class="p">.</span><span class="n">UL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n1</span><span class="p">.</span><span class="n">UR</span><span class="p">;</span>
<a id="__codelineno-16-27" name="__codelineno-16-27" href="#__codelineno-16-27"></a><span class="w">    </span><span class="n">n2</span><span class="p">.</span><span class="n">UR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UR</span><span class="p">;</span>
<a id="__codelineno-16-28" name="__codelineno-16-28" href="#__codelineno-16-28"></a><span class="w">    </span><span class="n">n2</span><span class="p">.</span><span class="n">BL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n1</span><span class="p">.</span><span class="n">BR</span><span class="p">;</span>
<a id="__codelineno-16-29" name="__codelineno-16-29" href="#__codelineno-16-29"></a><span class="w">    </span><span class="n">n2</span><span class="p">.</span><span class="n">BR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Point2i</span><span class="p">(</span><span class="n">UR</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="n">UL</span><span class="p">.</span><span class="n">y</span><span class="o">+</span><span class="n">halfY</span><span class="p">);</span>
<a id="__codelineno-16-30" name="__codelineno-16-30" href="#__codelineno-16-30"></a><span class="w">    </span><span class="n">n2</span><span class="p">.</span><span class="n">vKeys</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">vKeys</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
<a id="__codelineno-16-31" name="__codelineno-16-31" href="#__codelineno-16-31"></a>
<a id="__codelineno-16-32" name="__codelineno-16-32" href="#__codelineno-16-32"></a><span class="w">    </span><span class="n">n3</span><span class="p">.</span><span class="n">UL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n1</span><span class="p">.</span><span class="n">BL</span><span class="p">;</span>
<a id="__codelineno-16-33" name="__codelineno-16-33" href="#__codelineno-16-33"></a><span class="w">    </span><span class="n">n3</span><span class="p">.</span><span class="n">UR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n1</span><span class="p">.</span><span class="n">BR</span><span class="p">;</span>
<a id="__codelineno-16-34" name="__codelineno-16-34" href="#__codelineno-16-34"></a><span class="w">    </span><span class="n">n3</span><span class="p">.</span><span class="n">BL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BL</span><span class="p">;</span>
<a id="__codelineno-16-35" name="__codelineno-16-35" href="#__codelineno-16-35"></a><span class="w">    </span><span class="n">n3</span><span class="p">.</span><span class="n">BR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Point2i</span><span class="p">(</span><span class="n">n1</span><span class="p">.</span><span class="n">BR</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="n">BL</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
<a id="__codelineno-16-36" name="__codelineno-16-36" href="#__codelineno-16-36"></a><span class="w">    </span><span class="n">n3</span><span class="p">.</span><span class="n">vKeys</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">vKeys</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
<a id="__codelineno-16-37" name="__codelineno-16-37" href="#__codelineno-16-37"></a>
<a id="__codelineno-16-38" name="__codelineno-16-38" href="#__codelineno-16-38"></a><span class="w">    </span><span class="n">n4</span><span class="p">.</span><span class="n">UL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n3</span><span class="p">.</span><span class="n">UR</span><span class="p">;</span>
<a id="__codelineno-16-39" name="__codelineno-16-39" href="#__codelineno-16-39"></a><span class="w">    </span><span class="n">n4</span><span class="p">.</span><span class="n">UR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n2</span><span class="p">.</span><span class="n">BR</span><span class="p">;</span>
<a id="__codelineno-16-40" name="__codelineno-16-40" href="#__codelineno-16-40"></a><span class="w">    </span><span class="n">n4</span><span class="p">.</span><span class="n">BL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n3</span><span class="p">.</span><span class="n">BR</span><span class="p">;</span>
<a id="__codelineno-16-41" name="__codelineno-16-41" href="#__codelineno-16-41"></a><span class="w">    </span><span class="n">n4</span><span class="p">.</span><span class="n">BR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BR</span><span class="p">;</span>
<a id="__codelineno-16-42" name="__codelineno-16-42" href="#__codelineno-16-42"></a><span class="w">    </span><span class="n">n4</span><span class="p">.</span><span class="n">vKeys</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">vKeys</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
<a id="__codelineno-16-43" name="__codelineno-16-43" href="#__codelineno-16-43"></a>
<a id="__codelineno-16-44" name="__codelineno-16-44" href="#__codelineno-16-44"></a><span class="w">    </span><span class="c1">//Associate points to children</span>
<a id="__codelineno-16-45" name="__codelineno-16-45" href="#__codelineno-16-45"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">vKeys</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-16-46" name="__codelineno-16-46" href="#__codelineno-16-46"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-16-47" name="__codelineno-16-47" href="#__codelineno-16-47"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">KeyPoint</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vKeys</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-16-48" name="__codelineno-16-48" href="#__codelineno-16-48"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">kp</span><span class="p">.</span><span class="n">pt</span><span class="p">.</span><span class="n">x</span><span class="o">&lt;</span><span class="n">n1</span><span class="p">.</span><span class="n">UR</span><span class="p">.</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-16-49" name="__codelineno-16-49" href="#__codelineno-16-49"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-16-50" name="__codelineno-16-50" href="#__codelineno-16-50"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">kp</span><span class="p">.</span><span class="n">pt</span><span class="p">.</span><span class="n">y</span><span class="o">&lt;</span><span class="n">n1</span><span class="p">.</span><span class="n">BR</span><span class="p">.</span><span class="n">y</span><span class="p">)</span>
<a id="__codelineno-16-51" name="__codelineno-16-51" href="#__codelineno-16-51"></a><span class="w">                </span><span class="n">n1</span><span class="p">.</span><span class="n">vKeys</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">kp</span><span class="p">);</span>
<a id="__codelineno-16-52" name="__codelineno-16-52" href="#__codelineno-16-52"></a><span class="w">            </span><span class="k">else</span>
<a id="__codelineno-16-53" name="__codelineno-16-53" href="#__codelineno-16-53"></a><span class="w">                </span><span class="n">n3</span><span class="p">.</span><span class="n">vKeys</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">kp</span><span class="p">);</span>
<a id="__codelineno-16-54" name="__codelineno-16-54" href="#__codelineno-16-54"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-16-55" name="__codelineno-16-55" href="#__codelineno-16-55"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">kp</span><span class="p">.</span><span class="n">pt</span><span class="p">.</span><span class="n">y</span><span class="o">&lt;</span><span class="n">n1</span><span class="p">.</span><span class="n">BR</span><span class="p">.</span><span class="n">y</span><span class="p">)</span>
<a id="__codelineno-16-56" name="__codelineno-16-56" href="#__codelineno-16-56"></a><span class="w">            </span><span class="n">n2</span><span class="p">.</span><span class="n">vKeys</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">kp</span><span class="p">);</span>
<a id="__codelineno-16-57" name="__codelineno-16-57" href="#__codelineno-16-57"></a><span class="w">        </span><span class="k">else</span>
<a id="__codelineno-16-58" name="__codelineno-16-58" href="#__codelineno-16-58"></a><span class="w">            </span><span class="n">n4</span><span class="p">.</span><span class="n">vKeys</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">kp</span><span class="p">);</span>
<a id="__codelineno-16-59" name="__codelineno-16-59" href="#__codelineno-16-59"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-16-60" name="__codelineno-16-60" href="#__codelineno-16-60"></a>
<a id="__codelineno-16-61" name="__codelineno-16-61" href="#__codelineno-16-61"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">n1</span><span class="p">.</span><span class="n">vKeys</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-16-62" name="__codelineno-16-62" href="#__codelineno-16-62"></a><span class="w">        </span><span class="n">n1</span><span class="p">.</span><span class="n">bNoMore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<a id="__codelineno-16-63" name="__codelineno-16-63" href="#__codelineno-16-63"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">n2</span><span class="p">.</span><span class="n">vKeys</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-16-64" name="__codelineno-16-64" href="#__codelineno-16-64"></a><span class="w">        </span><span class="n">n2</span><span class="p">.</span><span class="n">bNoMore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<a id="__codelineno-16-65" name="__codelineno-16-65" href="#__codelineno-16-65"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">n3</span><span class="p">.</span><span class="n">vKeys</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-16-66" name="__codelineno-16-66" href="#__codelineno-16-66"></a><span class="w">        </span><span class="n">n3</span><span class="p">.</span><span class="n">bNoMore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<a id="__codelineno-16-67" name="__codelineno-16-67" href="#__codelineno-16-67"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">n4</span><span class="p">.</span><span class="n">vKeys</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-16-68" name="__codelineno-16-68" href="#__codelineno-16-68"></a><span class="w">        </span><span class="n">n4</span><span class="p">.</span><span class="n">bNoMore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<a id="__codelineno-16-69" name="__codelineno-16-69" href="#__codelineno-16-69"></a><span class="p">}</span>
</code></pre></div>
<p><code>DistributeOctTree(...)</code> constructs the octant/quad tree for ORB feature storage that, keep dividing space if the subspace has more than one keypoints.</p>
<p>For any node that has more than one keypoint <code>ni.vKeys.size()&gt;1</code>, should push this node to the front <code>lNodes.push_front(ni);</code>, then get this node's iterator pointing to its parent's front node <code>lNodes.front().lit = lNodes.begin();</code>.
Meanwhile, get this node stored in a vector to be divided later in the next level <code>vSizeAndPointerToNode.push_back(make_pair(n1.vKeys.size(),&amp;lNodes.front()));</code>
At the end, start dividing the next node by <code>lit=lNodes.erase(lit);</code>.</p>
<p>In the next level division, do <code>vPrevSizeAndPointerToNode[j].second-&gt;DivideNode(n1,n2,n3,n4);</code>, and get the child nodes' front iterator pointing to this node, same as how this node is pointed to its parent node's.</p>
<p>Repeat the above process until each node only contains one keypoint, and the node should be arranged in the tree layout as below.</p>
<div style="display: flex; justify-content: center;">
      <img src="imgs/quadtree.png" width="40%" height="30%" alt="quadtree" />
</div>
<p></br></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="n">vector</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">KeyPoint</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ORBextractor</span><span class="o">::</span><span class="n">DistributeOctTree</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">KeyPoint</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">vToDistributeKeys</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">&amp;</span><span class="n">minX</span><span class="p">,</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="w">                                       </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">&amp;</span><span class="n">maxX</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">&amp;</span><span class="n">minY</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">&amp;</span><span class="n">maxY</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">&amp;</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">&amp;</span><span class="n">level</span><span class="p">)</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="p">{</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="w">    </span><span class="c1">// Compute how many initial nodes   </span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nIni</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">round</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">maxX</span><span class="o">-</span><span class="n">minX</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">maxY</span><span class="o">-</span><span class="n">minY</span><span class="p">));</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">hX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">maxX</span><span class="o">-</span><span class="n">minX</span><span class="p">)</span><span class="o">/</span><span class="n">nIni</span><span class="p">;</span>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="w">    </span><span class="n">list</span><span class="o">&lt;</span><span class="n">ExtractorNode</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lNodes</span><span class="p">;</span>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">ExtractorNode</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">vpIniNodes</span><span class="p">;</span>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="w">    </span><span class="n">vpIniNodes</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">nIni</span><span class="p">);</span>
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a>
<a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">nIni</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a><span class="w">        </span><span class="n">ExtractorNode</span><span class="w"> </span><span class="n">ni</span><span class="p">;</span>
<a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a><span class="w">        </span><span class="n">ni</span><span class="p">.</span><span class="n">UL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Point2i</span><span class="p">(</span><span class="n">hX</span><span class="o">*</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a><span class="w">        </span><span class="n">ni</span><span class="p">.</span><span class="n">UR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Point2i</span><span class="p">(</span><span class="n">hX</span><span class="o">*</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a><span class="w">        </span><span class="n">ni</span><span class="p">.</span><span class="n">BL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Point2i</span><span class="p">(</span><span class="n">ni</span><span class="p">.</span><span class="n">UL</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="n">maxY</span><span class="o">-</span><span class="n">minY</span><span class="p">);</span>
<a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a><span class="w">        </span><span class="n">ni</span><span class="p">.</span><span class="n">BR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Point2i</span><span class="p">(</span><span class="n">ni</span><span class="p">.</span><span class="n">UR</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="n">maxY</span><span class="o">-</span><span class="n">minY</span><span class="p">);</span>
<a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a><span class="w">        </span><span class="n">ni</span><span class="p">.</span><span class="n">vKeys</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">vToDistributeKeys</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
<a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a>
<a id="__codelineno-17-22" name="__codelineno-17-22" href="#__codelineno-17-22"></a><span class="w">        </span><span class="n">lNodes</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">ni</span><span class="p">);</span>
<a id="__codelineno-17-23" name="__codelineno-17-23" href="#__codelineno-17-23"></a><span class="w">        </span><span class="n">vpIniNodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lNodes</span><span class="p">.</span><span class="n">back</span><span class="p">();</span>
<a id="__codelineno-17-24" name="__codelineno-17-24" href="#__codelineno-17-24"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-17-25" name="__codelineno-17-25" href="#__codelineno-17-25"></a>
<a id="__codelineno-17-26" name="__codelineno-17-26" href="#__codelineno-17-26"></a><span class="w">    </span><span class="c1">//Associate points to children</span>
<a id="__codelineno-17-27" name="__codelineno-17-27" href="#__codelineno-17-27"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">vToDistributeKeys</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-28" name="__codelineno-17-28" href="#__codelineno-17-28"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">KeyPoint</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vToDistributeKeys</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-17-29" name="__codelineno-17-29" href="#__codelineno-17-29"></a><span class="w">        </span><span class="n">vpIniNodes</span><span class="p">[</span><span class="n">kp</span><span class="p">.</span><span class="n">pt</span><span class="p">.</span><span class="n">x</span><span class="o">/</span><span class="n">hX</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">vKeys</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">kp</span><span class="p">);</span>
<a id="__codelineno-17-30" name="__codelineno-17-30" href="#__codelineno-17-30"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-17-31" name="__codelineno-17-31" href="#__codelineno-17-31"></a>
<a id="__codelineno-17-32" name="__codelineno-17-32" href="#__codelineno-17-32"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-17-33" name="__codelineno-17-33" href="#__codelineno-17-33"></a>
<a id="__codelineno-17-34" name="__codelineno-17-34" href="#__codelineno-17-34"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="n">ExtractorNode</span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vSizeAndPointerToNode</span><span class="p">;</span>
<a id="__codelineno-17-35" name="__codelineno-17-35" href="#__codelineno-17-35"></a><span class="w">    </span><span class="n">vSizeAndPointerToNode</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">lNodes</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
<a id="__codelineno-17-36" name="__codelineno-17-36" href="#__codelineno-17-36"></a>
<a id="__codelineno-17-37" name="__codelineno-17-37" href="#__codelineno-17-37"></a><span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">bFinish</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-38" name="__codelineno-17-38" href="#__codelineno-17-38"></a><span class="w">        </span><span class="n">iteration</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-17-39" name="__codelineno-17-39" href="#__codelineno-17-39"></a>
<a id="__codelineno-17-40" name="__codelineno-17-40" href="#__codelineno-17-40"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">prevSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lNodes</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<a id="__codelineno-17-41" name="__codelineno-17-41" href="#__codelineno-17-41"></a>
<a id="__codelineno-17-42" name="__codelineno-17-42" href="#__codelineno-17-42"></a><span class="w">        </span><span class="n">lit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lNodes</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
<a id="__codelineno-17-43" name="__codelineno-17-43" href="#__codelineno-17-43"></a>
<a id="__codelineno-17-44" name="__codelineno-17-44" href="#__codelineno-17-44"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">nToExpand</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-17-45" name="__codelineno-17-45" href="#__codelineno-17-45"></a>
<a id="__codelineno-17-46" name="__codelineno-17-46" href="#__codelineno-17-46"></a><span class="w">        </span><span class="n">vSizeAndPointerToNode</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<a id="__codelineno-17-47" name="__codelineno-17-47" href="#__codelineno-17-47"></a>
<a id="__codelineno-17-48" name="__codelineno-17-48" href="#__codelineno-17-48"></a><span class="w">        </span><span class="k">while</span><span class="p">(</span><span class="n">lit</span><span class="o">!=</span><span class="n">lNodes</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-49" name="__codelineno-17-49" href="#__codelineno-17-49"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">lit</span><span class="o">-&gt;</span><span class="n">bNoMore</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-50" name="__codelineno-17-50" href="#__codelineno-17-50"></a><span class="w">                </span><span class="c1">// If node only contains one point do not subdivide and continue</span>
<a id="__codelineno-17-51" name="__codelineno-17-51" href="#__codelineno-17-51"></a><span class="w">                </span><span class="n">lit</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-17-52" name="__codelineno-17-52" href="#__codelineno-17-52"></a><span class="w">                </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-17-53" name="__codelineno-17-53" href="#__codelineno-17-53"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-17-54" name="__codelineno-17-54" href="#__codelineno-17-54"></a><span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-55" name="__codelineno-17-55" href="#__codelineno-17-55"></a><span class="w">                </span><span class="c1">// If more than one point, subdivide</span>
<a id="__codelineno-17-56" name="__codelineno-17-56" href="#__codelineno-17-56"></a><span class="w">                </span><span class="n">ExtractorNode</span><span class="w"> </span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span><span class="p">,</span><span class="n">n4</span><span class="p">;</span>
<a id="__codelineno-17-57" name="__codelineno-17-57" href="#__codelineno-17-57"></a><span class="w">                </span><span class="n">lit</span><span class="o">-&gt;</span><span class="n">DivideNode</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span><span class="p">,</span><span class="n">n4</span><span class="p">);</span>
<a id="__codelineno-17-58" name="__codelineno-17-58" href="#__codelineno-17-58"></a>
<a id="__codelineno-17-59" name="__codelineno-17-59" href="#__codelineno-17-59"></a><span class="w">                </span><span class="c1">// Add children if they contain points</span>
<a id="__codelineno-17-60" name="__codelineno-17-60" href="#__codelineno-17-60"></a><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">n1</span><span class="p">.</span><span class="n">vKeys</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-61" name="__codelineno-17-61" href="#__codelineno-17-61"></a><span class="w">                    </span><span class="n">lNodes</span><span class="p">.</span><span class="n">push_front</span><span class="p">(</span><span class="n">n1</span><span class="p">);</span><span class="w">                    </span>
<a id="__codelineno-17-62" name="__codelineno-17-62" href="#__codelineno-17-62"></a><span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="n">n1</span><span class="p">.</span><span class="n">vKeys</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-63" name="__codelineno-17-63" href="#__codelineno-17-63"></a><span class="w">                        </span><span class="n">nToExpand</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-17-64" name="__codelineno-17-64" href="#__codelineno-17-64"></a><span class="w">                        </span><span class="n">vSizeAndPointerToNode</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">make_pair</span><span class="p">(</span><span class="n">n1</span><span class="p">.</span><span class="n">vKeys</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span><span class="o">&amp;</span><span class="n">lNodes</span><span class="p">.</span><span class="n">front</span><span class="p">()));</span>
<a id="__codelineno-17-65" name="__codelineno-17-65" href="#__codelineno-17-65"></a><span class="w">                        </span><span class="n">lNodes</span><span class="p">.</span><span class="n">front</span><span class="p">().</span><span class="n">lit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lNodes</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
<a id="__codelineno-17-66" name="__codelineno-17-66" href="#__codelineno-17-66"></a><span class="w">                    </span><span class="p">}</span>
<a id="__codelineno-17-67" name="__codelineno-17-67" href="#__codelineno-17-67"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-17-68" name="__codelineno-17-68" href="#__codelineno-17-68"></a><span class="w">                </span><span class="p">...</span><span class="w"> </span><span class="c1">// same as to `n1` for the other n2, n3 and n4</span>
<a id="__codelineno-17-69" name="__codelineno-17-69" href="#__codelineno-17-69"></a>
<a id="__codelineno-17-70" name="__codelineno-17-70" href="#__codelineno-17-70"></a><span class="w">                </span><span class="c1">// erase element by position</span>
<a id="__codelineno-17-71" name="__codelineno-17-71" href="#__codelineno-17-71"></a><span class="w">                </span><span class="c1">// return an iterator pointing to the element that followed the last element erased by the function call.</span>
<a id="__codelineno-17-72" name="__codelineno-17-72" href="#__codelineno-17-72"></a><span class="w">                </span><span class="n">lit</span><span class="o">=</span><span class="n">lNodes</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">lit</span><span class="p">);</span>
<a id="__codelineno-17-73" name="__codelineno-17-73" href="#__codelineno-17-73"></a><span class="w">                </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-17-74" name="__codelineno-17-74" href="#__codelineno-17-74"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-17-75" name="__codelineno-17-75" href="#__codelineno-17-75"></a><span class="w">        </span><span class="p">}</span><span class="w">     </span>
<a id="__codelineno-17-76" name="__codelineno-17-76" href="#__codelineno-17-76"></a><span class="w">        </span><span class="c1">// Finish if there are more nodes than required features</span>
<a id="__codelineno-17-77" name="__codelineno-17-77" href="#__codelineno-17-77"></a><span class="w">        </span><span class="c1">// or all nodes contain just one point</span>
<a id="__codelineno-17-78" name="__codelineno-17-78" href="#__codelineno-17-78"></a><span class="w">        </span><span class="k">if</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">lNodes</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">&gt;=</span><span class="n">N</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">lNodes</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">==</span><span class="n">prevSize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-79" name="__codelineno-17-79" href="#__codelineno-17-79"></a><span class="w">            </span><span class="n">bFinish</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<a id="__codelineno-17-80" name="__codelineno-17-80" href="#__codelineno-17-80"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-17-81" name="__codelineno-17-81" href="#__codelineno-17-81"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(((</span><span class="kt">int</span><span class="p">)</span><span class="n">lNodes</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">+</span><span class="n">nToExpand</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span><span class="o">&gt;</span><span class="n">N</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-82" name="__codelineno-17-82" href="#__codelineno-17-82"></a><span class="w">            </span><span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">bFinish</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-83" name="__codelineno-17-83" href="#__codelineno-17-83"></a><span class="w">                </span><span class="n">prevSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lNodes</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<a id="__codelineno-17-84" name="__codelineno-17-84" href="#__codelineno-17-84"></a><span class="w">                </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="n">ExtractorNode</span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vPrevSizeAndPointerToNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vSizeAndPointerToNode</span><span class="p">;</span>
<a id="__codelineno-17-85" name="__codelineno-17-85" href="#__codelineno-17-85"></a><span class="w">                </span><span class="n">vSizeAndPointerToNode</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<a id="__codelineno-17-86" name="__codelineno-17-86" href="#__codelineno-17-86"></a>
<a id="__codelineno-17-87" name="__codelineno-17-87" href="#__codelineno-17-87"></a><span class="w">                </span><span class="n">sort</span><span class="p">(</span><span class="n">vPrevSizeAndPointerToNode</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="n">vPrevSizeAndPointerToNode</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
<a id="__codelineno-17-88" name="__codelineno-17-88" href="#__codelineno-17-88"></a><span class="w">                </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="n">vPrevSizeAndPointerToNode</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="mi">-1</span><span class="p">;</span><span class="n">j</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-89" name="__codelineno-17-89" href="#__codelineno-17-89"></a><span class="w">                    </span><span class="n">ExtractorNode</span><span class="w"> </span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span><span class="p">,</span><span class="n">n4</span><span class="p">;</span>
<a id="__codelineno-17-90" name="__codelineno-17-90" href="#__codelineno-17-90"></a><span class="w">                    </span><span class="n">vPrevSizeAndPointerToNode</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">DivideNode</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span><span class="p">,</span><span class="n">n4</span><span class="p">);</span>
<a id="__codelineno-17-91" name="__codelineno-17-91" href="#__codelineno-17-91"></a>
<a id="__codelineno-17-92" name="__codelineno-17-92" href="#__codelineno-17-92"></a><span class="w">                    </span><span class="c1">// Add children if they contain points</span>
<a id="__codelineno-17-93" name="__codelineno-17-93" href="#__codelineno-17-93"></a><span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="n">n1</span><span class="p">.</span><span class="n">vKeys</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-94" name="__codelineno-17-94" href="#__codelineno-17-94"></a><span class="w">                        </span><span class="n">lNodes</span><span class="p">.</span><span class="n">push_front</span><span class="p">(</span><span class="n">n1</span><span class="p">);</span>
<a id="__codelineno-17-95" name="__codelineno-17-95" href="#__codelineno-17-95"></a><span class="w">                        </span><span class="k">if</span><span class="p">(</span><span class="n">n1</span><span class="p">.</span><span class="n">vKeys</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-96" name="__codelineno-17-96" href="#__codelineno-17-96"></a><span class="w">                            </span><span class="n">vSizeAndPointerToNode</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">make_pair</span><span class="p">(</span><span class="n">n1</span><span class="p">.</span><span class="n">vKeys</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span><span class="o">&amp;</span><span class="n">lNodes</span><span class="p">.</span><span class="n">front</span><span class="p">()));</span>
<a id="__codelineno-17-97" name="__codelineno-17-97" href="#__codelineno-17-97"></a><span class="w">                            </span><span class="n">lNodes</span><span class="p">.</span><span class="n">front</span><span class="p">().</span><span class="n">lit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lNodes</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
<a id="__codelineno-17-98" name="__codelineno-17-98" href="#__codelineno-17-98"></a><span class="w">                        </span><span class="p">}</span>
<a id="__codelineno-17-99" name="__codelineno-17-99" href="#__codelineno-17-99"></a><span class="w">                    </span><span class="p">}</span>
<a id="__codelineno-17-100" name="__codelineno-17-100" href="#__codelineno-17-100"></a><span class="w">                    </span><span class="p">...</span><span class="w"> </span><span class="c1">// same as to `n1` for the other n2, n3 and n4</span>
<a id="__codelineno-17-101" name="__codelineno-17-101" href="#__codelineno-17-101"></a>
<a id="__codelineno-17-102" name="__codelineno-17-102" href="#__codelineno-17-102"></a><span class="w">                    </span><span class="n">lNodes</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">vPrevSizeAndPointerToNode</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">lit</span><span class="p">);</span>
<a id="__codelineno-17-103" name="__codelineno-17-103" href="#__codelineno-17-103"></a>
<a id="__codelineno-17-104" name="__codelineno-17-104" href="#__codelineno-17-104"></a><span class="w">                    </span><span class="k">if</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">lNodes</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">&gt;=</span><span class="n">N</span><span class="p">)</span>
<a id="__codelineno-17-105" name="__codelineno-17-105" href="#__codelineno-17-105"></a><span class="w">                        </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-17-106" name="__codelineno-17-106" href="#__codelineno-17-106"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-17-107" name="__codelineno-17-107" href="#__codelineno-17-107"></a>
<a id="__codelineno-17-108" name="__codelineno-17-108" href="#__codelineno-17-108"></a><span class="w">                </span><span class="k">if</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">lNodes</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">&gt;=</span><span class="n">N</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">lNodes</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">==</span><span class="n">prevSize</span><span class="p">)</span>
<a id="__codelineno-17-109" name="__codelineno-17-109" href="#__codelineno-17-109"></a><span class="w">                    </span><span class="n">bFinish</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<a id="__codelineno-17-110" name="__codelineno-17-110" href="#__codelineno-17-110"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-17-111" name="__codelineno-17-111" href="#__codelineno-17-111"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-17-112" name="__codelineno-17-112" href="#__codelineno-17-112"></a><span class="w">    </span><span class="p">}</span><span class="w">  </span>
<a id="__codelineno-17-113" name="__codelineno-17-113" href="#__codelineno-17-113"></a>
<a id="__codelineno-17-114" name="__codelineno-17-114" href="#__codelineno-17-114"></a><span class="w">    </span><span class="c1">// Retain the best point in each node</span>
<a id="__codelineno-17-115" name="__codelineno-17-115" href="#__codelineno-17-115"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">KeyPoint</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vResultKeys</span><span class="p">;</span>
<a id="__codelineno-17-116" name="__codelineno-17-116" href="#__codelineno-17-116"></a><span class="w">    </span><span class="n">vResultKeys</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">nfeatures</span><span class="p">);</span>
<a id="__codelineno-17-117" name="__codelineno-17-117" href="#__codelineno-17-117"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">list</span><span class="o">&lt;</span><span class="n">ExtractorNode</span><span class="o">&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">lit</span><span class="o">=</span><span class="n">lNodes</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"> </span><span class="n">lit</span><span class="o">!=</span><span class="n">lNodes</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">lit</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-118" name="__codelineno-17-118" href="#__codelineno-17-118"></a><span class="w">        </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">KeyPoint</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vNodeKeys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lit</span><span class="o">-&gt;</span><span class="n">vKeys</span><span class="p">;</span>
<a id="__codelineno-17-119" name="__codelineno-17-119" href="#__codelineno-17-119"></a><span class="w">        </span><span class="n">cv</span><span class="o">::</span><span class="n">KeyPoint</span><span class="o">*</span><span class="w"> </span><span class="n">pKP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vNodeKeys</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<a id="__codelineno-17-120" name="__codelineno-17-120" href="#__codelineno-17-120"></a><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">maxResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKP</span><span class="o">-&gt;</span><span class="n">response</span><span class="p">;</span>
<a id="__codelineno-17-121" name="__codelineno-17-121" href="#__codelineno-17-121"></a>
<a id="__codelineno-17-122" name="__codelineno-17-122" href="#__codelineno-17-122"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">k</span><span class="o">&lt;</span><span class="n">vNodeKeys</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="n">k</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-123" name="__codelineno-17-123" href="#__codelineno-17-123"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">vNodeKeys</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">response</span><span class="o">&gt;</span><span class="n">maxResponse</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-124" name="__codelineno-17-124" href="#__codelineno-17-124"></a><span class="w">                </span><span class="n">pKP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vNodeKeys</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
<a id="__codelineno-17-125" name="__codelineno-17-125" href="#__codelineno-17-125"></a><span class="w">                </span><span class="n">maxResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vNodeKeys</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">response</span><span class="p">;</span>
<a id="__codelineno-17-126" name="__codelineno-17-126" href="#__codelineno-17-126"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-17-127" name="__codelineno-17-127" href="#__codelineno-17-127"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-17-128" name="__codelineno-17-128" href="#__codelineno-17-128"></a><span class="w">        </span><span class="n">vResultKeys</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="o">*</span><span class="n">pKP</span><span class="p">);</span>
<a id="__codelineno-17-129" name="__codelineno-17-129" href="#__codelineno-17-129"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-17-130" name="__codelineno-17-130" href="#__codelineno-17-130"></a>
<a id="__codelineno-17-131" name="__codelineno-17-131" href="#__codelineno-17-131"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">vResultKeys</span><span class="p">;</span>
<a id="__codelineno-17-132" name="__codelineno-17-132" href="#__codelineno-17-132"></a><span class="p">}</span>
</code></pre></div>
<h3 id="orb-feature-computation">ORB Feature Computation</h3>
<p>For an input image <code>cv::InputArray image</code>, the function <code>ORBextractor::operator()(...)</code> computes for <code>std::vector&lt;cv::KeyPoint&gt;&amp; keypoints</code> (initial FAST points) and <code>cv::OutputArray descriptors</code> (BRIEF-compared points).</p>
<ol>
<li><code>ComputePyramid(image);</code> scaling image</li>
<li><code>ComputeKeyPointsOctTree(allKeypoints);</code> finds FAST features stored in <code>allKeypoints</code></li>
<li><code>GaussianBlur(workingMat, workingMat, Size(7, 7), 2, 2, BORDER_REFLECT_101);</code> computes Gaussian blur</li>
<li><code>computeDescriptors(workingMat, keypoints, desc, pattern);</code> computes BRIEF features against the <code>pattern</code>.</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="c1">// Compute the ORB features and descriptors on an image.</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="c1">// ORB are dispersed on the image using an octree.</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="c1">// Mask is ignored in the current implementation.</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="kt">void</span><span class="w"> </span><span class="nf">ORBextractor::operator</span><span class="p">()(</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">InputArray</span><span class="w"> </span><span class="n">image</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">InputArray</span><span class="w"> </span><span class="n">mask</span><span class="p">,</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">KeyPoint</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">keypoints</span><span class="p">,</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="w">  </span><span class="n">cv</span><span class="o">::</span><span class="n">OutputArray</span><span class="w"> </span><span class="n">descriptors</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">_image</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a>
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="w">    </span><span class="n">Mat</span><span class="w"> </span><span class="n">image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_image</span><span class="p">.</span><span class="n">getMat</span><span class="p">();</span>
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">type</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CV_8UC1</span><span class="w"> </span><span class="p">);</span>
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a>
<a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="w">    </span><span class="c1">// Pre-compute the scale pyramid</span>
<a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="w">    </span><span class="n">ComputePyramid</span><span class="p">(</span><span class="n">image</span><span class="p">);</span>
<a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a>
<a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a><span class="w">    </span><span class="n">vector</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KeyPoint</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">allKeypoints</span><span class="p">;</span>
<a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a><span class="w">    </span><span class="n">ComputeKeyPointsOctTree</span><span class="p">(</span><span class="n">allKeypoints</span><span class="p">);</span>
<a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a><span class="w">    </span><span class="c1">//ComputeKeyPointsOld(allKeypoints);</span>
<a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a>
<a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a><span class="w">    </span><span class="n">Mat</span><span class="w"> </span><span class="n">descriptors</span><span class="p">;</span>
<a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a>
<a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nkeypoints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nlevels</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">level</span><span class="p">)</span>
<a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a><span class="w">        </span><span class="n">nkeypoints</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">allKeypoints</span><span class="p">[</span><span class="n">level</span><span class="p">].</span><span class="n">size</span><span class="p">();</span>
<a id="__codelineno-18-26" name="__codelineno-18-26" href="#__codelineno-18-26"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">nkeypoints</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span>
<a id="__codelineno-18-27" name="__codelineno-18-27" href="#__codelineno-18-27"></a><span class="w">        </span><span class="n">_descriptors</span><span class="p">.</span><span class="n">release</span><span class="p">();</span>
<a id="__codelineno-18-28" name="__codelineno-18-28" href="#__codelineno-18-28"></a><span class="w">    </span><span class="k">else</span>
<a id="__codelineno-18-29" name="__codelineno-18-29" href="#__codelineno-18-29"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-18-30" name="__codelineno-18-30" href="#__codelineno-18-30"></a><span class="w">        </span><span class="n">_descriptors</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">nkeypoints</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="n">CV_8U</span><span class="p">);</span>
<a id="__codelineno-18-31" name="__codelineno-18-31" href="#__codelineno-18-31"></a><span class="w">        </span><span class="n">descriptors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_descriptors</span><span class="p">.</span><span class="n">getMat</span><span class="p">();</span>
<a id="__codelineno-18-32" name="__codelineno-18-32" href="#__codelineno-18-32"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-18-33" name="__codelineno-18-33" href="#__codelineno-18-33"></a>
<a id="__codelineno-18-34" name="__codelineno-18-34" href="#__codelineno-18-34"></a><span class="w">    </span><span class="n">_keypoints</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<a id="__codelineno-18-35" name="__codelineno-18-35" href="#__codelineno-18-35"></a><span class="w">    </span><span class="n">_keypoints</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">nkeypoints</span><span class="p">);</span>
<a id="__codelineno-18-36" name="__codelineno-18-36" href="#__codelineno-18-36"></a>
<a id="__codelineno-18-37" name="__codelineno-18-37" href="#__codelineno-18-37"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-18-38" name="__codelineno-18-38" href="#__codelineno-18-38"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nlevels</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">level</span><span class="p">)</span>
<a id="__codelineno-18-39" name="__codelineno-18-39" href="#__codelineno-18-39"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-18-40" name="__codelineno-18-40" href="#__codelineno-18-40"></a><span class="w">        </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KeyPoint</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">keypoints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allKeypoints</span><span class="p">[</span><span class="n">level</span><span class="p">];</span>
<a id="__codelineno-18-41" name="__codelineno-18-41" href="#__codelineno-18-41"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">nkeypointsLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">keypoints</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<a id="__codelineno-18-42" name="__codelineno-18-42" href="#__codelineno-18-42"></a>
<a id="__codelineno-18-43" name="__codelineno-18-43" href="#__codelineno-18-43"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">nkeypointsLevel</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-18-44" name="__codelineno-18-44" href="#__codelineno-18-44"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-18-45" name="__codelineno-18-45" href="#__codelineno-18-45"></a>
<a id="__codelineno-18-46" name="__codelineno-18-46" href="#__codelineno-18-46"></a><span class="w">        </span><span class="c1">// preprocess the resized image</span>
<a id="__codelineno-18-47" name="__codelineno-18-47" href="#__codelineno-18-47"></a><span class="w">        </span><span class="n">Mat</span><span class="w"> </span><span class="n">workingMat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mvImagePyramid</span><span class="p">[</span><span class="n">level</span><span class="p">].</span><span class="n">clone</span><span class="p">();</span>
<a id="__codelineno-18-48" name="__codelineno-18-48" href="#__codelineno-18-48"></a><span class="w">        </span><span class="n">GaussianBlur</span><span class="p">(</span><span class="n">workingMat</span><span class="p">,</span><span class="w"> </span><span class="n">workingMat</span><span class="p">,</span><span class="w"> </span><span class="n">Size</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">),</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">BORDER_REFLECT_101</span><span class="p">);</span>
<a id="__codelineno-18-49" name="__codelineno-18-49" href="#__codelineno-18-49"></a>
<a id="__codelineno-18-50" name="__codelineno-18-50" href="#__codelineno-18-50"></a><span class="w">        </span><span class="c1">// Compute the descriptors</span>
<a id="__codelineno-18-51" name="__codelineno-18-51" href="#__codelineno-18-51"></a><span class="w">        </span><span class="n">Mat</span><span class="w"> </span><span class="n">desc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">descriptors</span><span class="p">.</span><span class="n">rowRange</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">nkeypointsLevel</span><span class="p">);</span>
<a id="__codelineno-18-52" name="__codelineno-18-52" href="#__codelineno-18-52"></a><span class="w">        </span><span class="n">computeDescriptors</span><span class="p">(</span><span class="n">workingMat</span><span class="p">,</span><span class="w"> </span><span class="n">keypoints</span><span class="p">,</span><span class="w"> </span><span class="n">desc</span><span class="p">,</span><span class="w"> </span><span class="n">pattern</span><span class="p">);</span>
<a id="__codelineno-18-53" name="__codelineno-18-53" href="#__codelineno-18-53"></a>
<a id="__codelineno-18-54" name="__codelineno-18-54" href="#__codelineno-18-54"></a><span class="w">        </span><span class="n">offset</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">nkeypointsLevel</span><span class="p">;</span>
<a id="__codelineno-18-55" name="__codelineno-18-55" href="#__codelineno-18-55"></a>
<a id="__codelineno-18-56" name="__codelineno-18-56" href="#__codelineno-18-56"></a><span class="w">        </span><span class="c1">// Scale keypoint coordinates</span>
<a id="__codelineno-18-57" name="__codelineno-18-57" href="#__codelineno-18-57"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">level</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-18-58" name="__codelineno-18-58" href="#__codelineno-18-58"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-18-59" name="__codelineno-18-59" href="#__codelineno-18-59"></a><span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mvScaleFactor</span><span class="p">[</span><span class="n">level</span><span class="p">];</span><span class="w"> </span><span class="c1">//getScale(level, firstLevel, scaleFactor);</span>
<a id="__codelineno-18-60" name="__codelineno-18-60" href="#__codelineno-18-60"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KeyPoint</span><span class="o">&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">keypoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">keypoints</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span>
<a id="__codelineno-18-61" name="__codelineno-18-61" href="#__codelineno-18-61"></a><span class="w">                 </span><span class="n">keypointEnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">keypoints</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">keypoint</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">keypointEnd</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">keypoint</span><span class="p">)</span>
<a id="__codelineno-18-62" name="__codelineno-18-62" href="#__codelineno-18-62"></a><span class="w">                </span><span class="n">keypoint</span><span class="o">-&gt;</span><span class="n">pt</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">scale</span><span class="p">;</span>
<a id="__codelineno-18-63" name="__codelineno-18-63" href="#__codelineno-18-63"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-18-64" name="__codelineno-18-64" href="#__codelineno-18-64"></a><span class="w">        </span><span class="c1">// And add the keypoints to the output</span>
<a id="__codelineno-18-65" name="__codelineno-18-65" href="#__codelineno-18-65"></a><span class="w">        </span><span class="n">_keypoints</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">_keypoints</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="n">keypoints</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">keypoints</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
<a id="__codelineno-18-66" name="__codelineno-18-66" href="#__codelineno-18-66"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-18-67" name="__codelineno-18-67" href="#__codelineno-18-67"></a><span class="p">}</span>
</code></pre></div>
<p><code>ComputePyramid(...)</code> simply resizes the input image.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">ORBextractor::ComputePyramid</span><span class="p">(</span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">image</span><span class="p">)</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="p">{</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nlevels</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">level</span><span class="p">)</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mvInvScaleFactor</span><span class="p">[</span><span class="n">level</span><span class="p">];</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="w">        </span><span class="n">Size</span><span class="w"> </span><span class="n">sz</span><span class="p">(</span><span class="n">cvRound</span><span class="p">((</span><span class="kt">float</span><span class="p">)</span><span class="n">image</span><span class="p">.</span><span class="n">cols</span><span class="o">*</span><span class="n">scale</span><span class="p">),</span><span class="w"> </span><span class="n">cvRound</span><span class="p">((</span><span class="kt">float</span><span class="p">)</span><span class="n">image</span><span class="p">.</span><span class="n">rows</span><span class="o">*</span><span class="n">scale</span><span class="p">));</span>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="w">        </span><span class="n">Size</span><span class="w"> </span><span class="n">wholeSize</span><span class="p">(</span><span class="n">sz</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">EDGE_THRESHOLD</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">sz</span><span class="p">.</span><span class="n">height</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">EDGE_THRESHOLD</span><span class="o">*</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="w">        </span><span class="n">Mat</span><span class="w"> </span><span class="n">temp</span><span class="p">(</span><span class="n">wholeSize</span><span class="p">,</span><span class="w"> </span><span class="n">image</span><span class="p">.</span><span class="n">type</span><span class="p">()),</span><span class="w"> </span><span class="n">masktemp</span><span class="p">;</span>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="w">        </span><span class="n">mvImagePyramid</span><span class="p">[</span><span class="n">level</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp</span><span class="p">(</span><span class="n">Rect</span><span class="p">(</span><span class="n">EDGE_THRESHOLD</span><span class="p">,</span><span class="w"> </span><span class="n">EDGE_THRESHOLD</span><span class="p">,</span><span class="w"> </span><span class="n">sz</span><span class="p">.</span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">sz</span><span class="p">.</span><span class="n">height</span><span class="p">));</span>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a>
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="w">        </span><span class="c1">// Compute the resized image</span>
<a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span>
<a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="w">            </span><span class="n">resize</span><span class="p">(</span><span class="n">mvImagePyramid</span><span class="p">[</span><span class="n">level</span><span class="mi">-1</span><span class="p">],</span><span class="w"> </span><span class="n">mvImagePyramid</span><span class="p">[</span><span class="n">level</span><span class="p">],</span><span class="w"> </span><span class="n">sz</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">INTER_LINEAR</span><span class="p">);</span>
<a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a>
<a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a><span class="w">            </span><span class="n">copyMakeBorder</span><span class="p">(</span><span class="n">mvImagePyramid</span><span class="p">[</span><span class="n">level</span><span class="p">],</span><span class="w"> </span><span class="n">temp</span><span class="p">,</span><span class="w"> </span><span class="n">EDGE_THRESHOLD</span><span class="p">,</span><span class="w"> </span><span class="n">EDGE_THRESHOLD</span><span class="p">,</span><span class="w"> </span><span class="n">EDGE_THRESHOLD</span><span class="p">,</span><span class="w"> </span><span class="n">EDGE_THRESHOLD</span><span class="p">,</span>
<a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a><span class="w">                           </span><span class="n">BORDER_REFLECT_101</span><span class="o">+</span><span class="n">BORDER_ISOLATED</span><span class="p">);</span><span class="w">            </span>
<a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a><span class="w">        </span><span class="k">else</span>
<a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a><span class="w">            </span><span class="n">copyMakeBorder</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="w"> </span><span class="n">temp</span><span class="p">,</span><span class="w"> </span><span class="n">EDGE_THRESHOLD</span><span class="p">,</span><span class="w"> </span><span class="n">EDGE_THRESHOLD</span><span class="p">,</span><span class="w"> </span><span class="n">EDGE_THRESHOLD</span><span class="p">,</span><span class="w"> </span><span class="n">EDGE_THRESHOLD</span><span class="p">,</span>
<a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a><span class="w">                           </span><span class="n">BORDER_REFLECT_101</span><span class="p">);</span><span class="w">            </span>
<a id="__codelineno-19-23" name="__codelineno-19-23" href="#__codelineno-19-23"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-19-24" name="__codelineno-19-24" href="#__codelineno-19-24"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-19-25" name="__codelineno-19-25" href="#__codelineno-19-25"></a>
<a id="__codelineno-19-26" name="__codelineno-19-26" href="#__codelineno-19-26"></a><span class="p">}</span>
</code></pre></div>
<p><code>ComputeKeyPointsOctTree(...)</code> takes each level of the previously computed pyramid, by a window size of <code>W = 30;</code>, finds the FAST features in each window.
Then, store the found FAST features into a quadtree by <code>DistributeOctTree(...)</code>.
Finally, the keypoints' orientations are computed <code>computeOrientation(...)</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">ORBextractor::ComputeKeyPointsOctTree</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KeyPoint</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">allKeypoints</span><span class="p">)</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="p">{</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="w">    </span><span class="n">allKeypoints</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">nlevels</span><span class="p">);</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">W</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">30</span><span class="p">;</span>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nlevels</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">level</span><span class="p">)</span>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">minBorderX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EDGE_THRESHOLD</span><span class="mi">-3</span><span class="p">;</span>
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">minBorderY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">minBorderX</span><span class="p">;</span>
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">maxBorderX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mvImagePyramid</span><span class="p">[</span><span class="n">level</span><span class="p">].</span><span class="n">cols</span><span class="o">-</span><span class="n">EDGE_THRESHOLD</span><span class="o">+</span><span class="mi">3</span><span class="p">;</span>
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">maxBorderY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mvImagePyramid</span><span class="p">[</span><span class="n">level</span><span class="p">].</span><span class="n">rows</span><span class="o">-</span><span class="n">EDGE_THRESHOLD</span><span class="o">+</span><span class="mi">3</span><span class="p">;</span>
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a>
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a><span class="w">        </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">KeyPoint</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vToDistributeKeys</span><span class="p">;</span>
<a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a><span class="w">        </span><span class="n">vToDistributeKeys</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">nfeatures</span><span class="o">*</span><span class="mi">10</span><span class="p">);</span>
<a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a>
<a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">maxBorderX</span><span class="o">-</span><span class="n">minBorderX</span><span class="p">);</span>
<a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">maxBorderY</span><span class="o">-</span><span class="n">minBorderY</span><span class="p">);</span>
<a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a>
<a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nCols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">width</span><span class="o">/</span><span class="n">W</span><span class="p">;</span>
<a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nRows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">height</span><span class="o">/</span><span class="n">W</span><span class="p">;</span>
<a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">wCell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ceil</span><span class="p">(</span><span class="n">width</span><span class="o">/</span><span class="n">nCols</span><span class="p">);</span>
<a id="__codelineno-20-23" name="__codelineno-20-23" href="#__codelineno-20-23"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">hCell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ceil</span><span class="p">(</span><span class="n">height</span><span class="o">/</span><span class="n">nRows</span><span class="p">);</span>
<a id="__codelineno-20-24" name="__codelineno-20-24" href="#__codelineno-20-24"></a>
<a id="__codelineno-20-25" name="__codelineno-20-25" href="#__codelineno-20-25"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">nRows</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-20-26" name="__codelineno-20-26" href="#__codelineno-20-26"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-20-27" name="__codelineno-20-27" href="#__codelineno-20-27"></a><span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">iniY</span><span class="w"> </span><span class="o">=</span><span class="n">minBorderY</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">hCell</span><span class="p">;</span>
<a id="__codelineno-20-28" name="__codelineno-20-28" href="#__codelineno-20-28"></a><span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">maxY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iniY</span><span class="o">+</span><span class="n">hCell</span><span class="o">+</span><span class="mi">6</span><span class="p">;</span>
<a id="__codelineno-20-29" name="__codelineno-20-29" href="#__codelineno-20-29"></a>
<a id="__codelineno-20-30" name="__codelineno-20-30" href="#__codelineno-20-30"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">iniY</span><span class="o">&gt;=</span><span class="n">maxBorderY</span><span class="mi">-3</span><span class="p">)</span>
<a id="__codelineno-20-31" name="__codelineno-20-31" href="#__codelineno-20-31"></a><span class="w">                </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-20-32" name="__codelineno-20-32" href="#__codelineno-20-32"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">maxY</span><span class="o">&gt;</span><span class="n">maxBorderY</span><span class="p">)</span>
<a id="__codelineno-20-33" name="__codelineno-20-33" href="#__codelineno-20-33"></a><span class="w">                </span><span class="n">maxY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">maxBorderY</span><span class="p">;</span>
<a id="__codelineno-20-34" name="__codelineno-20-34" href="#__codelineno-20-34"></a>
<a id="__codelineno-20-35" name="__codelineno-20-35" href="#__codelineno-20-35"></a><span class="w">            </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;</span><span class="n">nCols</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-20-36" name="__codelineno-20-36" href="#__codelineno-20-36"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-20-37" name="__codelineno-20-37" href="#__codelineno-20-37"></a><span class="w">                </span><span class="p">...</span><span class="w"> </span>
<a id="__codelineno-20-38" name="__codelineno-20-38" href="#__codelineno-20-38"></a>
<a id="__codelineno-20-39" name="__codelineno-20-39" href="#__codelineno-20-39"></a><span class="w">                </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">KeyPoint</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vKeysCell</span><span class="p">;</span>
<a id="__codelineno-20-40" name="__codelineno-20-40" href="#__codelineno-20-40"></a><span class="w">                </span><span class="n">FAST</span><span class="p">(</span><span class="n">mvImagePyramid</span><span class="p">[</span><span class="n">level</span><span class="p">].</span><span class="n">rowRange</span><span class="p">(</span><span class="n">iniY</span><span class="p">,</span><span class="n">maxY</span><span class="p">).</span><span class="n">colRange</span><span class="p">(</span><span class="n">iniX</span><span class="p">,</span><span class="n">maxX</span><span class="p">),</span>
<a id="__codelineno-20-41" name="__codelineno-20-41" href="#__codelineno-20-41"></a><span class="w">                     </span><span class="n">vKeysCell</span><span class="p">,</span><span class="n">iniThFAST</span><span class="p">,</span><span class="nb">true</span><span class="p">);</span>
<a id="__codelineno-20-42" name="__codelineno-20-42" href="#__codelineno-20-42"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-20-43" name="__codelineno-20-43" href="#__codelineno-20-43"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-20-44" name="__codelineno-20-44" href="#__codelineno-20-44"></a>
<a id="__codelineno-20-45" name="__codelineno-20-45" href="#__codelineno-20-45"></a><span class="w">        </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KeyPoint</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">keypoints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allKeypoints</span><span class="p">[</span><span class="n">level</span><span class="p">];</span>
<a id="__codelineno-20-46" name="__codelineno-20-46" href="#__codelineno-20-46"></a><span class="w">        </span><span class="n">keypoints</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">nfeatures</span><span class="p">);</span>
<a id="__codelineno-20-47" name="__codelineno-20-47" href="#__codelineno-20-47"></a>
<a id="__codelineno-20-48" name="__codelineno-20-48" href="#__codelineno-20-48"></a><span class="w">        </span><span class="n">keypoints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DistributeOctTree</span><span class="p">(</span><span class="n">vToDistributeKeys</span><span class="p">,</span><span class="w"> </span><span class="n">minBorderX</span><span class="p">,</span><span class="w"> </span><span class="n">maxBorderX</span><span class="p">,</span>
<a id="__codelineno-20-49" name="__codelineno-20-49" href="#__codelineno-20-49"></a><span class="w">                                      </span><span class="n">minBorderY</span><span class="p">,</span><span class="w"> </span><span class="n">maxBorderY</span><span class="p">,</span><span class="n">mnFeaturesPerLevel</span><span class="p">[</span><span class="n">level</span><span class="p">],</span><span class="w"> </span><span class="n">level</span><span class="p">);</span>
<a id="__codelineno-20-50" name="__codelineno-20-50" href="#__codelineno-20-50"></a>
<a id="__codelineno-20-51" name="__codelineno-20-51" href="#__codelineno-20-51"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">scaledPatchSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PATCH_SIZE</span><span class="o">*</span><span class="n">mvScaleFactor</span><span class="p">[</span><span class="n">level</span><span class="p">];</span>
<a id="__codelineno-20-52" name="__codelineno-20-52" href="#__codelineno-20-52"></a>
<a id="__codelineno-20-53" name="__codelineno-20-53" href="#__codelineno-20-53"></a><span class="w">        </span><span class="c1">// Add border to coordinates and scale information</span>
<a id="__codelineno-20-54" name="__codelineno-20-54" href="#__codelineno-20-54"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nkps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">keypoints</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<a id="__codelineno-20-55" name="__codelineno-20-55" href="#__codelineno-20-55"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">nkps</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-20-56" name="__codelineno-20-56" href="#__codelineno-20-56"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-20-57" name="__codelineno-20-57" href="#__codelineno-20-57"></a><span class="w">            </span><span class="n">keypoints</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pt</span><span class="p">.</span><span class="n">x</span><span class="o">+=</span><span class="n">minBorderX</span><span class="p">;</span>
<a id="__codelineno-20-58" name="__codelineno-20-58" href="#__codelineno-20-58"></a><span class="w">            </span><span class="n">keypoints</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pt</span><span class="p">.</span><span class="n">y</span><span class="o">+=</span><span class="n">minBorderY</span><span class="p">;</span>
<a id="__codelineno-20-59" name="__codelineno-20-59" href="#__codelineno-20-59"></a><span class="w">            </span><span class="n">keypoints</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">octave</span><span class="o">=</span><span class="n">level</span><span class="p">;</span>
<a id="__codelineno-20-60" name="__codelineno-20-60" href="#__codelineno-20-60"></a><span class="w">            </span><span class="n">keypoints</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scaledPatchSize</span><span class="p">;</span>
<a id="__codelineno-20-61" name="__codelineno-20-61" href="#__codelineno-20-61"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-20-62" name="__codelineno-20-62" href="#__codelineno-20-62"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-20-63" name="__codelineno-20-63" href="#__codelineno-20-63"></a>
<a id="__codelineno-20-64" name="__codelineno-20-64" href="#__codelineno-20-64"></a><span class="w">    </span><span class="c1">// compute orientations</span>
<a id="__codelineno-20-65" name="__codelineno-20-65" href="#__codelineno-20-65"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nlevels</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">level</span><span class="p">)</span>
<a id="__codelineno-20-66" name="__codelineno-20-66" href="#__codelineno-20-66"></a><span class="w">        </span><span class="n">computeOrientation</span><span class="p">(</span><span class="n">mvImagePyramid</span><span class="p">[</span><span class="n">level</span><span class="p">],</span><span class="w"> </span><span class="n">allKeypoints</span><span class="p">[</span><span class="n">level</span><span class="p">],</span><span class="w"> </span><span class="n">umax</span><span class="p">);</span>
<a id="__codelineno-20-67" name="__codelineno-20-67" href="#__codelineno-20-67"></a><span class="p">}</span>
</code></pre></div>
<h2 id="orb-feature-matcher">ORB Feature Matcher</h2>
<p>ORB feature matcher provides many ORB feature matching implementations, there are
* Projection: project between frames/keyframes 
* BoW: check ORB feature similarity against the existing ORB database
* <span class="arithmatex">\(Sim(3)\)</span>: given a known <span class="arithmatex">\(Sim(3)\)</span> transform, find the corresponding map points</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="k">namespace</span><span class="w"> </span><span class="nn">ORB_SLAM2</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="p">{</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">ORBmatcher</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="p">{</span><span class="w">    </span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="k">public</span><span class="o">:</span>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="w">    </span><span class="n">ORBmatcher</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">nnratio</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">checkOri</span><span class="o">=</span><span class="nb">true</span><span class="p">);</span>
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a><span class="w">    </span><span class="c1">// Computes the Hamming distance between two ORB descriptors</span>
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">DescriptorDistance</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="o">&amp;</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="o">&amp;</span><span class="n">b</span><span class="p">);</span>
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a>
<a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a><span class="w">    </span><span class="c1">// Search matches between Frame keypoints and projected MapPoints. Returns number of matches</span>
<a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a><span class="w">    </span><span class="c1">// Used to track the local map (Tracking)</span>
<a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="nf">SearchByProjection</span><span class="p">(</span><span class="n">Frame</span><span class="w"> </span><span class="o">&amp;</span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vpMapPoints</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">th</span><span class="o">=</span><span class="mi">3</span><span class="p">);</span>
<a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a>
<a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a><span class="w">    </span><span class="c1">// Project MapPoints tracked in last frame into the current frame and search matches.</span>
<a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a><span class="w">    </span><span class="c1">// Used to track from previous frame (Tracking)</span>
<a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="nf">SearchByProjection</span><span class="p">(</span><span class="n">Frame</span><span class="w"> </span><span class="o">&amp;</span><span class="n">CurrentFrame</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">Frame</span><span class="w"> </span><span class="o">&amp;</span><span class="n">LastFrame</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">th</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">bMono</span><span class="p">);</span>
<a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a>
<a id="__codelineno-21-20" name="__codelineno-21-20" href="#__codelineno-21-20"></a><span class="w">    </span><span class="c1">// Project MapPoints seen in KeyFrame into the Frame and search matches.</span>
<a id="__codelineno-21-21" name="__codelineno-21-21" href="#__codelineno-21-21"></a><span class="w">    </span><span class="c1">// Used in relocalisation (Tracking)</span>
<a id="__codelineno-21-22" name="__codelineno-21-22" href="#__codelineno-21-22"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="nf">SearchByProjection</span><span class="p">(</span><span class="n">Frame</span><span class="w"> </span><span class="o">&amp;</span><span class="n">CurrentFrame</span><span class="p">,</span><span class="w"> </span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pKF</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sAlreadyFound</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">th</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ORBdist</span><span class="p">);</span>
<a id="__codelineno-21-23" name="__codelineno-21-23" href="#__codelineno-21-23"></a>
<a id="__codelineno-21-24" name="__codelineno-21-24" href="#__codelineno-21-24"></a><span class="w">    </span><span class="c1">// Project MapPoints using a Similarity Transformation and search matches.</span>
<a id="__codelineno-21-25" name="__codelineno-21-25" href="#__codelineno-21-25"></a><span class="w">    </span><span class="c1">// Used in loop detection (Loop Closing)</span>
<a id="__codelineno-21-26" name="__codelineno-21-26" href="#__codelineno-21-26"></a><span class="w">     </span><span class="kt">int</span><span class="w"> </span><span class="nf">SearchByProjection</span><span class="p">(</span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pKF</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">Scw</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vpPoints</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vpMatched</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">th</span><span class="p">);</span>
<a id="__codelineno-21-27" name="__codelineno-21-27" href="#__codelineno-21-27"></a>
<a id="__codelineno-21-28" name="__codelineno-21-28" href="#__codelineno-21-28"></a><span class="w">    </span><span class="c1">// Search matches between MapPoints in a KeyFrame and ORB in a Frame.</span>
<a id="__codelineno-21-29" name="__codelineno-21-29" href="#__codelineno-21-29"></a><span class="w">    </span><span class="c1">// Brute force constrained to ORB that belong to the same vocabulary node (at a certain level)</span>
<a id="__codelineno-21-30" name="__codelineno-21-30" href="#__codelineno-21-30"></a><span class="w">    </span><span class="c1">// Used in Relocalisation and Loop Detection</span>
<a id="__codelineno-21-31" name="__codelineno-21-31" href="#__codelineno-21-31"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="nf">SearchByBoW</span><span class="p">(</span><span class="n">KeyFrame</span><span class="w"> </span><span class="o">*</span><span class="n">pKF</span><span class="p">,</span><span class="w"> </span><span class="n">Frame</span><span class="w"> </span><span class="o">&amp;</span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vpMapPointMatches</span><span class="p">);</span>
<a id="__codelineno-21-32" name="__codelineno-21-32" href="#__codelineno-21-32"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="nf">SearchByBoW</span><span class="p">(</span><span class="n">KeyFrame</span><span class="w"> </span><span class="o">*</span><span class="n">pKF1</span><span class="p">,</span><span class="w"> </span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pKF2</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vpMatches12</span><span class="p">);</span>
<a id="__codelineno-21-33" name="__codelineno-21-33" href="#__codelineno-21-33"></a>
<a id="__codelineno-21-34" name="__codelineno-21-34" href="#__codelineno-21-34"></a><span class="w">    </span><span class="c1">// Matching for the Map Initialization (only used in the monocular case)</span>
<a id="__codelineno-21-35" name="__codelineno-21-35" href="#__codelineno-21-35"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="nf">SearchForInitialization</span><span class="p">(</span><span class="n">Frame</span><span class="w"> </span><span class="o">&amp;</span><span class="n">F1</span><span class="p">,</span><span class="w"> </span><span class="n">Frame</span><span class="w"> </span><span class="o">&amp;</span><span class="n">F2</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">Point2f</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vbPrevMatched</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vnMatches12</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">windowSize</span><span class="o">=</span><span class="mi">10</span><span class="p">);</span>
<a id="__codelineno-21-36" name="__codelineno-21-36" href="#__codelineno-21-36"></a>
<a id="__codelineno-21-37" name="__codelineno-21-37" href="#__codelineno-21-37"></a><span class="w">    </span><span class="c1">// Matching to triangulate new MapPoints. Check Epipolar Constraint.</span>
<a id="__codelineno-21-38" name="__codelineno-21-38" href="#__codelineno-21-38"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="nf">SearchForTriangulation</span><span class="p">(</span><span class="n">KeyFrame</span><span class="w"> </span><span class="o">*</span><span class="n">pKF1</span><span class="p">,</span><span class="w"> </span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pKF2</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">F12</span><span class="p">,</span>
<a id="__codelineno-21-39" name="__codelineno-21-39" href="#__codelineno-21-39"></a><span class="w">                               </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vMatchedPairs</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">bOnlyStereo</span><span class="p">);</span>
<a id="__codelineno-21-40" name="__codelineno-21-40" href="#__codelineno-21-40"></a>
<a id="__codelineno-21-41" name="__codelineno-21-41" href="#__codelineno-21-41"></a><span class="w">    </span><span class="c1">// Search matches between MapPoints seen in KF1 and KF2 transforming by a Sim3 [s12*R12|t12]</span>
<a id="__codelineno-21-42" name="__codelineno-21-42" href="#__codelineno-21-42"></a><span class="w">    </span><span class="c1">// In the stereo and RGB-D case, s12=1</span>
<a id="__codelineno-21-43" name="__codelineno-21-43" href="#__codelineno-21-43"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="nf">SearchBySim3</span><span class="p">(</span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pKF1</span><span class="p">,</span><span class="w"> </span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pKF2</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vpMatches12</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">&amp;</span><span class="n">s12</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="o">&amp;</span><span class="n">R12</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="o">&amp;</span><span class="n">t12</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">th</span><span class="p">);</span>
<a id="__codelineno-21-44" name="__codelineno-21-44" href="#__codelineno-21-44"></a>
<a id="__codelineno-21-45" name="__codelineno-21-45" href="#__codelineno-21-45"></a><span class="w">    </span><span class="c1">// Project MapPoints into KeyFrame and search for duplicated MapPoints.</span>
<a id="__codelineno-21-46" name="__codelineno-21-46" href="#__codelineno-21-46"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="nf">Fuse</span><span class="p">(</span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pKF</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vpMapPoints</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">th</span><span class="o">=</span><span class="mf">3.0</span><span class="p">);</span>
<a id="__codelineno-21-47" name="__codelineno-21-47" href="#__codelineno-21-47"></a>
<a id="__codelineno-21-48" name="__codelineno-21-48" href="#__codelineno-21-48"></a><span class="w">    </span><span class="c1">// Project MapPoints into KeyFrame using a given Sim3 and search for duplicated MapPoints.</span>
<a id="__codelineno-21-49" name="__codelineno-21-49" href="#__codelineno-21-49"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="nf">Fuse</span><span class="p">(</span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pKF</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">Scw</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vpPoints</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">th</span><span class="p">,</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vpReplacePoint</span><span class="p">);</span>
<a id="__codelineno-21-50" name="__codelineno-21-50" href="#__codelineno-21-50"></a>
<a id="__codelineno-21-51" name="__codelineno-21-51" href="#__codelineno-21-51"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-21-52" name="__codelineno-21-52" href="#__codelineno-21-52"></a><span class="p">}</span>
<a id="__codelineno-21-53" name="__codelineno-21-53" href="#__codelineno-21-53"></a><span class="p">}</span><span class="c1">// namespace ORB_SLAM</span>
</code></pre></div>
<p><code>GetFeaturesInArea(...)</code> takes the current frame feature located at <span class="arithmatex">\((x,y)\)</span>, given a radius <code>const float  &amp;r</code>, and given pyramid levels between <code>minLevel</code> and <code>maxLevel</code>, find the features from within.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="n">vector</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Frame</span><span class="o">::</span><span class="n">GetFeaturesInArea</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">&amp;</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w">  </span><span class="o">&amp;</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w">  </span><span class="o">&amp;</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">minLevel</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">maxLevel</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="p">{</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vIndices</span><span class="p">;</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="w">    </span><span class="n">vIndices</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">N</span><span class="p">);</span>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nMinCellX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">floor</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">mnMinX</span><span class="o">-</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="n">mfGridElementWidthInv</span><span class="p">));</span>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">nMinCellX</span><span class="o">&gt;=</span><span class="n">FRAME_GRID_COLS</span><span class="p">)</span>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">vIndices</span><span class="p">;</span>
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nMaxCellX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">FRAME_GRID_COLS</span><span class="mi">-1</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">ceil</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">mnMinX</span><span class="o">+</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="n">mfGridElementWidthInv</span><span class="p">));</span>
<a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">nMaxCellX</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">vIndices</span><span class="p">;</span>
<a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a>
<a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nMinCellY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">floor</span><span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">mnMinY</span><span class="o">-</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="n">mfGridElementHeightInv</span><span class="p">));</span>
<a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">nMinCellY</span><span class="o">&gt;=</span><span class="n">FRAME_GRID_ROWS</span><span class="p">)</span>
<a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">vIndices</span><span class="p">;</span>
<a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a>
<a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nMaxCellY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">FRAME_GRID_ROWS</span><span class="mi">-1</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">ceil</span><span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">mnMinY</span><span class="o">+</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="n">mfGridElementHeightInv</span><span class="p">));</span>
<a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">nMaxCellY</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">vIndices</span><span class="p">;</span>
<a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a>
<a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">bCheckLevels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">minLevel</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">maxLevel</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-22-23" name="__codelineno-22-23" href="#__codelineno-22-23"></a>
<a id="__codelineno-22-24" name="__codelineno-22-24" href="#__codelineno-22-24"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nMinCellX</span><span class="p">;</span><span class="w"> </span><span class="n">ix</span><span class="o">&lt;=</span><span class="n">nMaxCellX</span><span class="p">;</span><span class="w"> </span><span class="n">ix</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-22-25" name="__codelineno-22-25" href="#__codelineno-22-25"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-22-26" name="__codelineno-22-26" href="#__codelineno-22-26"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">iy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nMinCellY</span><span class="p">;</span><span class="w"> </span><span class="n">iy</span><span class="o">&lt;=</span><span class="n">nMaxCellY</span><span class="p">;</span><span class="w"> </span><span class="n">iy</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-22-27" name="__codelineno-22-27" href="#__codelineno-22-27"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-22-28" name="__codelineno-22-28" href="#__codelineno-22-28"></a><span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vCell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mGrid</span><span class="p">[</span><span class="n">ix</span><span class="p">][</span><span class="n">iy</span><span class="p">];</span>
<a id="__codelineno-22-29" name="__codelineno-22-29" href="#__codelineno-22-29"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">vCell</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
<a id="__codelineno-22-30" name="__codelineno-22-30" href="#__codelineno-22-30"></a><span class="w">                </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-22-31" name="__codelineno-22-31" href="#__codelineno-22-31"></a>
<a id="__codelineno-22-32" name="__codelineno-22-32" href="#__codelineno-22-32"></a><span class="w">            </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">jend</span><span class="o">=</span><span class="n">vCell</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;</span><span class="n">jend</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-22-33" name="__codelineno-22-33" href="#__codelineno-22-33"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-22-34" name="__codelineno-22-34" href="#__codelineno-22-34"></a><span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">KeyPoint</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kpUn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mvKeysUn</span><span class="p">[</span><span class="n">vCell</span><span class="p">[</span><span class="n">j</span><span class="p">]];</span>
<a id="__codelineno-22-35" name="__codelineno-22-35" href="#__codelineno-22-35"></a><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">bCheckLevels</span><span class="p">)</span>
<a id="__codelineno-22-36" name="__codelineno-22-36" href="#__codelineno-22-36"></a><span class="w">                </span><span class="p">{</span>
<a id="__codelineno-22-37" name="__codelineno-22-37" href="#__codelineno-22-37"></a><span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="n">kpUn</span><span class="p">.</span><span class="n">octave</span><span class="o">&lt;</span><span class="n">minLevel</span><span class="p">)</span>
<a id="__codelineno-22-38" name="__codelineno-22-38" href="#__codelineno-22-38"></a><span class="w">                        </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-22-39" name="__codelineno-22-39" href="#__codelineno-22-39"></a><span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="n">maxLevel</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-22-40" name="__codelineno-22-40" href="#__codelineno-22-40"></a><span class="w">                        </span><span class="k">if</span><span class="p">(</span><span class="n">kpUn</span><span class="p">.</span><span class="n">octave</span><span class="o">&gt;</span><span class="n">maxLevel</span><span class="p">)</span>
<a id="__codelineno-22-41" name="__codelineno-22-41" href="#__codelineno-22-41"></a><span class="w">                            </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-22-42" name="__codelineno-22-42" href="#__codelineno-22-42"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-22-43" name="__codelineno-22-43" href="#__codelineno-22-43"></a>
<a id="__codelineno-22-44" name="__codelineno-22-44" href="#__codelineno-22-44"></a><span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">distx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kpUn</span><span class="p">.</span><span class="n">pt</span><span class="p">.</span><span class="n">x</span><span class="o">-</span><span class="n">x</span><span class="p">;</span>
<a id="__codelineno-22-45" name="__codelineno-22-45" href="#__codelineno-22-45"></a><span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">disty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kpUn</span><span class="p">.</span><span class="n">pt</span><span class="p">.</span><span class="n">y</span><span class="o">-</span><span class="n">y</span><span class="p">;</span>
<a id="__codelineno-22-46" name="__codelineno-22-46" href="#__codelineno-22-46"></a>
<a id="__codelineno-22-47" name="__codelineno-22-47" href="#__codelineno-22-47"></a><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">fabs</span><span class="p">(</span><span class="n">distx</span><span class="p">)</span><span class="o">&lt;</span><span class="n">r</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">fabs</span><span class="p">(</span><span class="n">disty</span><span class="p">)</span><span class="o">&lt;</span><span class="n">r</span><span class="p">)</span>
<a id="__codelineno-22-48" name="__codelineno-22-48" href="#__codelineno-22-48"></a><span class="w">                    </span><span class="n">vIndices</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">vCell</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
<a id="__codelineno-22-49" name="__codelineno-22-49" href="#__codelineno-22-49"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-22-50" name="__codelineno-22-50" href="#__codelineno-22-50"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-22-51" name="__codelineno-22-51" href="#__codelineno-22-51"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-22-52" name="__codelineno-22-52" href="#__codelineno-22-52"></a>
<a id="__codelineno-22-53" name="__codelineno-22-53" href="#__codelineno-22-53"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">vIndices</span><span class="p">;</span>
<a id="__codelineno-22-54" name="__codelineno-22-54" href="#__codelineno-22-54"></a><span class="p">}</span>
</code></pre></div>
<h3 id="search-by-projection">Search By Projection</h3>
<p><code>SearchByProjection(...)</code> finds match points by selecting feature points from the last frame comparing against this frame's nearby pixels.</p>
<p><code>twc</code> <span class="arithmatex">\(\mathbf{t}_{wc}\)</span> and <code>tlc</code> <span class="arithmatex">\(\mathbf{t}_{lc}\)</span> are computed as below representing the current frame camera pose and the last frame camera pose, both measured in the world coordinate system.</p>
<div class="arithmatex">\[
\begin{align*}
&amp;&amp;
T_{wc} = T_{cw}^{-1} &amp;= 
\begin{bmatrix}
    R_{cw}^{\top} &amp; -R_{cw}^{\top}\mathbf{t}_{cw} \\\\
    \mathbf{0}^{\top} &amp; 1
\end{bmatrix}
\\\\ \Rightarrow &amp;&amp;
\mathbf{t}_{wc} &amp;= -R_{cw}^{\top}\mathbf{t}_{cw}
\\\\ \Rightarrow &amp;&amp;
\mathbf{t}_{lc} &amp;= R_{lw} \mathbf{t}_{wc}  + \mathbf{t}_{lw}
\end{align*}
\]</div>
<p>For every last frame feature <code>cv::Mat x3Dw = pMP-&gt;GetWorldPos();</code>, the camera frame coordinate is computed by <code>cv::Mat x3Dc = Rcw*x3Dw+tcw;</code>.
Then, compute projection.</p>
<div class="arithmatex">\[
\begin{align*}
    u &amp;= f_x \frac{X}{Z} + c_x
    &amp;&amp;&amp;
    v &amp;= f_y \frac{Y}{Z} + c_y
\end{align*}
\]</div>
<p>Having located the features in the last frame, search nearby pixels in the current frame by <code>GetFeaturesInArea(...)</code> to find the most similar features.
The similarity is measured by Hamming distance by <code>DescriptorDistance(...)</code>.</p>
<p>Finally, compute features' orientation by <code>cv::KeyPoint::angle</code>, and put them into corresponding bins to form a histogram (each bin classified per <span class="arithmatex">\(30^{\circ}\)</span>).
Find the three most prominent angle bins and remove non-prominent angle features (rotation consistency).
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ORBmatcher</span><span class="o">::</span><span class="n">TH_HIGH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ORBmatcher</span><span class="o">::</span><span class="n">TH_LOW</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">50</span><span class="p">;</span>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ORBmatcher</span><span class="o">::</span><span class="n">HISTO_LENGTH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">30</span><span class="p">;</span>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="kt">int</span><span class="w"> </span><span class="nf">ORBmatcher::SearchByProjection</span><span class="p">(</span><span class="n">Frame</span><span class="w"> </span><span class="o">&amp;</span><span class="n">CurrentFrame</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">Frame</span><span class="w"> </span><span class="o">&amp;</span><span class="n">LastFrame</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">th</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">bMono</span><span class="p">)</span>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="p">{</span>
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nmatches</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a><span class="w">    </span><span class="c1">// Rotation Histogram (to check rotation consistency)</span>
<a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">rotHist</span><span class="p">[</span><span class="n">HISTO_LENGTH</span><span class="p">];</span>
<a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">HISTO_LENGTH</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a><span class="w">        </span><span class="n">rotHist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reserve</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
<a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">factor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0f</span><span class="o">/</span><span class="n">HISTO_LENGTH</span><span class="p">;</span>
<a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a>
<a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">Rcw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CurrentFrame</span><span class="p">.</span><span class="n">mTcw</span><span class="p">.</span><span class="n">rowRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">).</span><span class="n">colRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
<a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">tcw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CurrentFrame</span><span class="p">.</span><span class="n">mTcw</span><span class="p">.</span><span class="n">rowRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">).</span><span class="n">col</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a>
<a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a><span class="w">    </span><span class="c1">// `.t()` means taking transpose of a matrix</span>
<a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">twc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">Rcw</span><span class="p">.</span><span class="n">t</span><span class="p">()</span><span class="o">*</span><span class="n">tcw</span><span class="p">;</span>
<a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a>
<a id="__codelineno-23-21" name="__codelineno-23-21" href="#__codelineno-23-21"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">Rlw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LastFrame</span><span class="p">.</span><span class="n">mTcw</span><span class="p">.</span><span class="n">rowRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">).</span><span class="n">colRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
<a id="__codelineno-23-22" name="__codelineno-23-22" href="#__codelineno-23-22"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">tlw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LastFrame</span><span class="p">.</span><span class="n">mTcw</span><span class="p">.</span><span class="n">rowRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">).</span><span class="n">col</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<a id="__codelineno-23-23" name="__codelineno-23-23" href="#__codelineno-23-23"></a>
<a id="__codelineno-23-24" name="__codelineno-23-24" href="#__codelineno-23-24"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">tlc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Rlw</span><span class="o">*</span><span class="n">twc</span><span class="o">+</span><span class="n">tlw</span><span class="p">;</span>
<a id="__codelineno-23-25" name="__codelineno-23-25" href="#__codelineno-23-25"></a>
<a id="__codelineno-23-26" name="__codelineno-23-26" href="#__codelineno-23-26"></a><span class="w">    </span><span class="c1">// `.mb`: Stereo baseline in meters.</span>
<a id="__codelineno-23-27" name="__codelineno-23-27" href="#__codelineno-23-27"></a><span class="w">    </span><span class="c1">// for mono, both `bForward` and `bBackward` are set to false.</span>
<a id="__codelineno-23-28" name="__codelineno-23-28" href="#__codelineno-23-28"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">bForward</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tlc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">CurrentFrame</span><span class="p">.</span><span class="n">mb</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">bMono</span><span class="p">;</span>
<a id="__codelineno-23-29" name="__codelineno-23-29" href="#__codelineno-23-29"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">bBackward</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">tlc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">CurrentFrame</span><span class="p">.</span><span class="n">mb</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">bMono</span><span class="p">;</span>
<a id="__codelineno-23-30" name="__codelineno-23-30" href="#__codelineno-23-30"></a>
<a id="__codelineno-23-31" name="__codelineno-23-31" href="#__codelineno-23-31"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">LastFrame</span><span class="p">.</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-32" name="__codelineno-23-32" href="#__codelineno-23-32"></a><span class="w">        </span><span class="n">MapPoint</span><span class="o">*</span><span class="w"> </span><span class="n">pMP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LastFrame</span><span class="p">.</span><span class="n">mvpMapPoints</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-23-33" name="__codelineno-23-33" href="#__codelineno-23-33"></a>
<a id="__codelineno-23-34" name="__codelineno-23-34" href="#__codelineno-23-34"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">pMP</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-35" name="__codelineno-23-35" href="#__codelineno-23-35"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">LastFrame</span><span class="p">.</span><span class="n">mvbOutlier</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-36" name="__codelineno-23-36" href="#__codelineno-23-36"></a><span class="w">                </span><span class="c1">// Project</span>
<a id="__codelineno-23-37" name="__codelineno-23-37" href="#__codelineno-23-37"></a><span class="w">                </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">x3Dw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">GetWorldPos</span><span class="p">();</span>
<a id="__codelineno-23-38" name="__codelineno-23-38" href="#__codelineno-23-38"></a><span class="w">                </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">x3Dc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Rcw</span><span class="o">*</span><span class="n">x3Dw</span><span class="o">+</span><span class="n">tcw</span><span class="p">;</span>
<a id="__codelineno-23-39" name="__codelineno-23-39" href="#__codelineno-23-39"></a>
<a id="__codelineno-23-40" name="__codelineno-23-40" href="#__codelineno-23-40"></a><span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">xc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x3Dc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-23-41" name="__codelineno-23-41" href="#__codelineno-23-41"></a><span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">yc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x3Dc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-23-42" name="__codelineno-23-42" href="#__codelineno-23-42"></a><span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">invzc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="o">/</span><span class="n">x3Dc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-23-43" name="__codelineno-23-43" href="#__codelineno-23-43"></a>
<a id="__codelineno-23-44" name="__codelineno-23-44" href="#__codelineno-23-44"></a><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">invzc</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-23-45" name="__codelineno-23-45" href="#__codelineno-23-45"></a><span class="w">                    </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-23-46" name="__codelineno-23-46" href="#__codelineno-23-46"></a>
<a id="__codelineno-23-47" name="__codelineno-23-47" href="#__codelineno-23-47"></a><span class="w">                </span><span class="kt">float</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CurrentFrame</span><span class="p">.</span><span class="n">fx</span><span class="o">*</span><span class="n">xc</span><span class="o">*</span><span class="n">invzc</span><span class="o">+</span><span class="n">CurrentFrame</span><span class="p">.</span><span class="n">cx</span><span class="p">;</span>
<a id="__codelineno-23-48" name="__codelineno-23-48" href="#__codelineno-23-48"></a><span class="w">                </span><span class="kt">float</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CurrentFrame</span><span class="p">.</span><span class="n">fy</span><span class="o">*</span><span class="n">yc</span><span class="o">*</span><span class="n">invzc</span><span class="o">+</span><span class="n">CurrentFrame</span><span class="p">.</span><span class="n">cy</span><span class="p">;</span>
<a id="__codelineno-23-49" name="__codelineno-23-49" href="#__codelineno-23-49"></a>
<a id="__codelineno-23-50" name="__codelineno-23-50" href="#__codelineno-23-50"></a><span class="w">                </span><span class="c1">//!&lt; octave (pyramid layer) from which the keypoint has been extracted</span>
<a id="__codelineno-23-51" name="__codelineno-23-51" href="#__codelineno-23-51"></a><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">nLastOctave</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LastFrame</span><span class="p">.</span><span class="n">mvKeys</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">octave</span><span class="p">;</span>
<a id="__codelineno-23-52" name="__codelineno-23-52" href="#__codelineno-23-52"></a>
<a id="__codelineno-23-53" name="__codelineno-23-53" href="#__codelineno-23-53"></a><span class="w">                </span><span class="c1">// Search in a window. Size depends on scale</span>
<a id="__codelineno-23-54" name="__codelineno-23-54" href="#__codelineno-23-54"></a><span class="w">                </span><span class="kt">float</span><span class="w"> </span><span class="n">radius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">th</span><span class="o">*</span><span class="n">CurrentFrame</span><span class="p">.</span><span class="n">mvScaleFactors</span><span class="p">[</span><span class="n">nLastOctave</span><span class="p">];</span>
<a id="__codelineno-23-55" name="__codelineno-23-55" href="#__codelineno-23-55"></a>
<a id="__codelineno-23-56" name="__codelineno-23-56" href="#__codelineno-23-56"></a><span class="w">                </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vIndices2</span><span class="p">;</span>
<a id="__codelineno-23-57" name="__codelineno-23-57" href="#__codelineno-23-57"></a>
<a id="__codelineno-23-58" name="__codelineno-23-58" href="#__codelineno-23-58"></a><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">bForward</span><span class="p">)</span>
<a id="__codelineno-23-59" name="__codelineno-23-59" href="#__codelineno-23-59"></a><span class="w">                    </span><span class="n">vIndices2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CurrentFrame</span><span class="p">.</span><span class="n">GetFeaturesInArea</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="n">nLastOctave</span><span class="p">);</span>
<a id="__codelineno-23-60" name="__codelineno-23-60" href="#__codelineno-23-60"></a><span class="w">                </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">bBackward</span><span class="p">)</span>
<a id="__codelineno-23-61" name="__codelineno-23-61" href="#__codelineno-23-61"></a><span class="w">                    </span><span class="n">vIndices2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CurrentFrame</span><span class="p">.</span><span class="n">GetFeaturesInArea</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">nLastOctave</span><span class="p">);</span>
<a id="__codelineno-23-62" name="__codelineno-23-62" href="#__codelineno-23-62"></a><span class="w">                </span><span class="k">else</span><span class="w"> </span><span class="c1">// for mono</span>
<a id="__codelineno-23-63" name="__codelineno-23-63" href="#__codelineno-23-63"></a><span class="w">                    </span><span class="n">vIndices2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CurrentFrame</span><span class="p">.</span><span class="n">GetFeaturesInArea</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="n">nLastOctave</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="n">nLastOctave</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-23-64" name="__codelineno-23-64" href="#__codelineno-23-64"></a>
<a id="__codelineno-23-65" name="__codelineno-23-65" href="#__codelineno-23-65"></a><span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">dMP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">GetDescriptor</span><span class="p">();</span>
<a id="__codelineno-23-66" name="__codelineno-23-66" href="#__codelineno-23-66"></a>
<a id="__codelineno-23-67" name="__codelineno-23-67" href="#__codelineno-23-67"></a><span class="w">                </span><span class="k">for</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;::</span><span class="n">const_iterator</span><span class="w"> </span><span class="n">vit</span><span class="o">=</span><span class="n">vIndices2</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">vend</span><span class="o">=</span><span class="n">vIndices2</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">vit</span><span class="o">!=</span><span class="n">vend</span><span class="p">;</span><span class="w"> </span><span class="n">vit</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-23-68" name="__codelineno-23-68" href="#__codelineno-23-68"></a><span class="w">                </span><span class="p">{</span>
<a id="__codelineno-23-69" name="__codelineno-23-69" href="#__codelineno-23-69"></a><span class="w">                    </span><span class="k">const</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">i2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">vit</span><span class="p">;</span>
<a id="__codelineno-23-70" name="__codelineno-23-70" href="#__codelineno-23-70"></a>
<a id="__codelineno-23-71" name="__codelineno-23-71" href="#__codelineno-23-71"></a><span class="w">                    </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="o">&amp;</span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CurrentFrame</span><span class="p">.</span><span class="n">mDescriptors</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="n">i2</span><span class="p">);</span>
<a id="__codelineno-23-72" name="__codelineno-23-72" href="#__codelineno-23-72"></a>
<a id="__codelineno-23-73" name="__codelineno-23-73" href="#__codelineno-23-73"></a><span class="w">                    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DescriptorDistance</span><span class="p">(</span><span class="n">dMP</span><span class="p">,</span><span class="n">d</span><span class="p">);</span>
<a id="__codelineno-23-74" name="__codelineno-23-74" href="#__codelineno-23-74"></a>
<a id="__codelineno-23-75" name="__codelineno-23-75" href="#__codelineno-23-75"></a><span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="n">dist</span><span class="o">&lt;</span><span class="n">bestDist</span><span class="p">)</span>
<a id="__codelineno-23-76" name="__codelineno-23-76" href="#__codelineno-23-76"></a><span class="w">                    </span><span class="p">{</span>
<a id="__codelineno-23-77" name="__codelineno-23-77" href="#__codelineno-23-77"></a><span class="w">                        </span><span class="n">bestDist</span><span class="o">=</span><span class="n">dist</span><span class="p">;</span>
<a id="__codelineno-23-78" name="__codelineno-23-78" href="#__codelineno-23-78"></a><span class="w">                        </span><span class="n">bestIdx2</span><span class="o">=</span><span class="n">i2</span><span class="p">;</span>
<a id="__codelineno-23-79" name="__codelineno-23-79" href="#__codelineno-23-79"></a><span class="w">                    </span><span class="p">}</span>
<a id="__codelineno-23-80" name="__codelineno-23-80" href="#__codelineno-23-80"></a>
<a id="__codelineno-23-81" name="__codelineno-23-81" href="#__codelineno-23-81"></a><span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="n">bestDist</span><span class="o">&lt;=</span><span class="n">TH_HIGH</span><span class="p">)</span>
<a id="__codelineno-23-82" name="__codelineno-23-82" href="#__codelineno-23-82"></a><span class="w">                    </span><span class="p">{</span>
<a id="__codelineno-23-83" name="__codelineno-23-83" href="#__codelineno-23-83"></a><span class="w">                        </span><span class="n">CurrentFrame</span><span class="p">.</span><span class="n">mvpMapPoints</span><span class="p">[</span><span class="n">bestIdx2</span><span class="p">]</span><span class="o">=</span><span class="n">pMP</span><span class="p">;</span>
<a id="__codelineno-23-84" name="__codelineno-23-84" href="#__codelineno-23-84"></a><span class="w">                        </span><span class="n">nmatches</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-23-85" name="__codelineno-23-85" href="#__codelineno-23-85"></a>
<a id="__codelineno-23-86" name="__codelineno-23-86" href="#__codelineno-23-86"></a><span class="w">                        </span><span class="k">if</span><span class="p">(</span><span class="n">mbCheckOrientation</span><span class="p">)</span>
<a id="__codelineno-23-87" name="__codelineno-23-87" href="#__codelineno-23-87"></a><span class="w">                        </span><span class="p">{</span>
<a id="__codelineno-23-88" name="__codelineno-23-88" href="#__codelineno-23-88"></a><span class="w">                            </span><span class="c1">//!&lt; computed orientation of the keypoint (-1 if not applicable);</span>
<a id="__codelineno-23-89" name="__codelineno-23-89" href="#__codelineno-23-89"></a><span class="w">                            </span><span class="c1">//!&lt; it&#39;s in [0,360) degrees and measured relative to</span>
<a id="__codelineno-23-90" name="__codelineno-23-90" href="#__codelineno-23-90"></a><span class="w">                            </span><span class="c1">//!&lt; image coordinate system, ie in clockwise.</span>
<a id="__codelineno-23-91" name="__codelineno-23-91" href="#__codelineno-23-91"></a><span class="w">                            </span><span class="kt">float</span><span class="w"> </span><span class="n">rot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kp</span><span class="p">.</span><span class="n">angle</span><span class="o">-</span><span class="n">F</span><span class="p">.</span><span class="n">mvKeys</span><span class="p">[</span><span class="n">bestIdxF</span><span class="p">].</span><span class="n">angle</span><span class="p">;</span>
<a id="__codelineno-23-92" name="__codelineno-23-92" href="#__codelineno-23-92"></a>
<a id="__codelineno-23-93" name="__codelineno-23-93" href="#__codelineno-23-93"></a><span class="w">                            </span><span class="k">if</span><span class="p">(</span><span class="n">rot</span><span class="o">&lt;</span><span class="mf">0.0</span><span class="p">)</span>
<a id="__codelineno-23-94" name="__codelineno-23-94" href="#__codelineno-23-94"></a><span class="w">                                </span><span class="n">rot</span><span class="o">+=</span><span class="mf">360.0f</span><span class="p">;</span>
<a id="__codelineno-23-95" name="__codelineno-23-95" href="#__codelineno-23-95"></a><span class="w">                            </span><span class="kt">int</span><span class="w"> </span><span class="n">bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">round</span><span class="p">(</span><span class="n">rot</span><span class="o">*</span><span class="n">factor</span><span class="p">);</span>
<a id="__codelineno-23-96" name="__codelineno-23-96" href="#__codelineno-23-96"></a><span class="w">                            </span><span class="k">if</span><span class="p">(</span><span class="n">bin</span><span class="o">==</span><span class="n">HISTO_LENGTH</span><span class="p">)</span>
<a id="__codelineno-23-97" name="__codelineno-23-97" href="#__codelineno-23-97"></a><span class="w">                                </span><span class="n">bin</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-23-98" name="__codelineno-23-98" href="#__codelineno-23-98"></a><span class="w">                            </span><span class="n">assert</span><span class="p">(</span><span class="n">bin</span><span class="o">&gt;=</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">bin</span><span class="o">&lt;</span><span class="n">HISTO_LENGTH</span><span class="p">);</span>
<a id="__codelineno-23-99" name="__codelineno-23-99" href="#__codelineno-23-99"></a>
<a id="__codelineno-23-100" name="__codelineno-23-100" href="#__codelineno-23-100"></a><span class="w">                            </span><span class="n">rotHist</span><span class="p">[</span><span class="n">bin</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">bestIdxF</span><span class="p">);</span>
<a id="__codelineno-23-101" name="__codelineno-23-101" href="#__codelineno-23-101"></a><span class="w">                        </span><span class="p">}</span>
<a id="__codelineno-23-102" name="__codelineno-23-102" href="#__codelineno-23-102"></a><span class="w">                    </span><span class="p">}</span>
<a id="__codelineno-23-103" name="__codelineno-23-103" href="#__codelineno-23-103"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-23-104" name="__codelineno-23-104" href="#__codelineno-23-104"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-23-105" name="__codelineno-23-105" href="#__codelineno-23-105"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-23-106" name="__codelineno-23-106" href="#__codelineno-23-106"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-23-107" name="__codelineno-23-107" href="#__codelineno-23-107"></a>
<a id="__codelineno-23-108" name="__codelineno-23-108" href="#__codelineno-23-108"></a><span class="w">    </span><span class="c1">//Apply rotation consistency</span>
<a id="__codelineno-23-109" name="__codelineno-23-109" href="#__codelineno-23-109"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mbCheckOrientation</span><span class="p">)</span>
<a id="__codelineno-23-110" name="__codelineno-23-110" href="#__codelineno-23-110"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-23-111" name="__codelineno-23-111" href="#__codelineno-23-111"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">ind1</span><span class="o">=</span><span class="mi">-1</span><span class="p">;</span>
<a id="__codelineno-23-112" name="__codelineno-23-112" href="#__codelineno-23-112"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">ind2</span><span class="o">=</span><span class="mi">-1</span><span class="p">;</span>
<a id="__codelineno-23-113" name="__codelineno-23-113" href="#__codelineno-23-113"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">ind3</span><span class="o">=</span><span class="mi">-1</span><span class="p">;</span>
<a id="__codelineno-23-114" name="__codelineno-23-114" href="#__codelineno-23-114"></a>
<a id="__codelineno-23-115" name="__codelineno-23-115" href="#__codelineno-23-115"></a><span class="w">        </span><span class="n">ComputeThreeMaxima</span><span class="p">(</span><span class="n">rotHist</span><span class="p">,</span><span class="n">HISTO_LENGTH</span><span class="p">,</span><span class="n">ind1</span><span class="p">,</span><span class="n">ind2</span><span class="p">,</span><span class="n">ind3</span><span class="p">);</span>
<a id="__codelineno-23-116" name="__codelineno-23-116" href="#__codelineno-23-116"></a>
<a id="__codelineno-23-117" name="__codelineno-23-117" href="#__codelineno-23-117"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">HISTO_LENGTH</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-23-118" name="__codelineno-23-118" href="#__codelineno-23-118"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-23-119" name="__codelineno-23-119" href="#__codelineno-23-119"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">!=</span><span class="n">ind1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">i</span><span class="o">!=</span><span class="n">ind2</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">i</span><span class="o">!=</span><span class="n">ind3</span><span class="p">)</span>
<a id="__codelineno-23-120" name="__codelineno-23-120" href="#__codelineno-23-120"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-23-121" name="__codelineno-23-121" href="#__codelineno-23-121"></a><span class="w">                </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">jend</span><span class="o">=</span><span class="n">rotHist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;</span><span class="n">jend</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-23-122" name="__codelineno-23-122" href="#__codelineno-23-122"></a><span class="w">                </span><span class="p">{</span>
<a id="__codelineno-23-123" name="__codelineno-23-123" href="#__codelineno-23-123"></a><span class="w">                    </span><span class="c1">// i: each angle bin</span>
<a id="__codelineno-23-124" name="__codelineno-23-124" href="#__codelineno-23-124"></a><span class="w">                    </span><span class="c1">// j: each feature in the bin</span>
<a id="__codelineno-23-125" name="__codelineno-23-125" href="#__codelineno-23-125"></a><span class="w">                    </span><span class="n">CurrentFrame</span><span class="p">.</span><span class="n">mvpMapPoints</span><span class="p">[</span><span class="n">rotHist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]]</span><span class="o">=</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<a id="__codelineno-23-126" name="__codelineno-23-126" href="#__codelineno-23-126"></a><span class="w">                    </span><span class="n">nmatches</span><span class="o">--</span><span class="p">;</span>
<a id="__codelineno-23-127" name="__codelineno-23-127" href="#__codelineno-23-127"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-23-128" name="__codelineno-23-128" href="#__codelineno-23-128"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-23-129" name="__codelineno-23-129" href="#__codelineno-23-129"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-23-130" name="__codelineno-23-130" href="#__codelineno-23-130"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-23-131" name="__codelineno-23-131" href="#__codelineno-23-131"></a>
<a id="__codelineno-23-132" name="__codelineno-23-132" href="#__codelineno-23-132"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">nmatches</span><span class="p">;</span>
<a id="__codelineno-23-133" name="__codelineno-23-133" href="#__codelineno-23-133"></a><span class="p">}</span>
</code></pre></div></p>
<h3 id="search-by-bow">Search By BoW</h3>
<p><code>SearchByBoW(...)</code> checks BoW features between two frames/keyframes, and store matched keypoints in <code>vector&lt;MapPoint *&gt; &amp;vpMatches12</code>.</p>
<p>If <code>if(f1it-&gt;first == f2it-&gt;first)</code> is false, it means the features are located on different nodes/branches of the BoW tree.
For example, <code>if(f1it-&gt;first &lt; f2it-&gt;first)</code> is true, it means <code>f1it</code>'s node id is smaller than <code>f2it</code>'s, indicating <code>f2it</code> resides at a higer layer (closer to leaf nodes) than <code>f1it</code>'s, 
hence having <code>f1it = vFeatVec1.lower_bound(f2it-&gt;first);</code> to move <code>f1it</code> to <code>f2it</code>'s layer.</p>
<p>For <code>f1it</code> and <code>f2it</code> at the same layer, conduct feature distance match by Hamming distancee, and record the best match points.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">ORBmatcher::SearchByBoW</span><span class="p">(</span><span class="n">KeyFrame</span><span class="w"> </span><span class="o">*</span><span class="n">pKF1</span><span class="p">,</span><span class="w"> </span><span class="n">KeyFrame</span><span class="w"> </span><span class="o">*</span><span class="n">pKF2</span><span class="p">,</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vpMatches12</span><span class="p">)</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="p">{</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">KeyPoint</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vKeysUn1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF1</span><span class="o">-&gt;</span><span class="n">mvKeysUn</span><span class="p">;</span>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">DBoW2</span><span class="o">::</span><span class="n">FeatureVector</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vFeatVec1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF1</span><span class="o">-&gt;</span><span class="n">mFeatVec</span><span class="p">;</span>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">vpMapPoints1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF1</span><span class="o">-&gt;</span><span class="n">GetMapPointMatches</span><span class="p">();</span>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Descriptors1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF1</span><span class="o">-&gt;</span><span class="n">mDescriptors</span><span class="p">;</span>
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a>
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">KeyPoint</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vKeysUn2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF2</span><span class="o">-&gt;</span><span class="n">mvKeysUn</span><span class="p">;</span>
<a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">DBoW2</span><span class="o">::</span><span class="n">FeatureVector</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vFeatVec2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF2</span><span class="o">-&gt;</span><span class="n">mFeatVec</span><span class="p">;</span>
<a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">vpMapPoints2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF2</span><span class="o">-&gt;</span><span class="n">GetMapPointMatches</span><span class="p">();</span>
<a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Descriptors2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF2</span><span class="o">-&gt;</span><span class="n">mDescriptors</span><span class="p">;</span>
<a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a>
<a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a><span class="w">    </span><span class="n">vpMatches12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">vpMapPoints1</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
<a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vbMatched2</span><span class="p">(</span><span class="n">vpMapPoints2</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span><span class="nb">false</span><span class="p">);</span>
<a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a>
<a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">rotHist</span><span class="p">[</span><span class="n">HISTO_LENGTH</span><span class="p">];</span>
<a id="__codelineno-24-17" name="__codelineno-24-17" href="#__codelineno-24-17"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">HISTO_LENGTH</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-24-18" name="__codelineno-24-18" href="#__codelineno-24-18"></a><span class="w">        </span><span class="n">rotHist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reserve</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
<a id="__codelineno-24-19" name="__codelineno-24-19" href="#__codelineno-24-19"></a>
<a id="__codelineno-24-20" name="__codelineno-24-20" href="#__codelineno-24-20"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">factor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0f</span><span class="o">/</span><span class="n">HISTO_LENGTH</span><span class="p">;</span>
<a id="__codelineno-24-21" name="__codelineno-24-21" href="#__codelineno-24-21"></a>
<a id="__codelineno-24-22" name="__codelineno-24-22" href="#__codelineno-24-22"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nmatches</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-24-23" name="__codelineno-24-23" href="#__codelineno-24-23"></a>
<a id="__codelineno-24-24" name="__codelineno-24-24" href="#__codelineno-24-24"></a><span class="w">    </span><span class="n">DBoW2</span><span class="o">::</span><span class="n">FeatureVector</span><span class="o">::</span><span class="n">const_iterator</span><span class="w"> </span><span class="n">f1it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vFeatVec1</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
<a id="__codelineno-24-25" name="__codelineno-24-25" href="#__codelineno-24-25"></a><span class="w">    </span><span class="n">DBoW2</span><span class="o">::</span><span class="n">FeatureVector</span><span class="o">::</span><span class="n">const_iterator</span><span class="w"> </span><span class="n">f2it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vFeatVec2</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
<a id="__codelineno-24-26" name="__codelineno-24-26" href="#__codelineno-24-26"></a><span class="w">    </span><span class="n">DBoW2</span><span class="o">::</span><span class="n">FeatureVector</span><span class="o">::</span><span class="n">const_iterator</span><span class="w"> </span><span class="n">f1end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vFeatVec1</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
<a id="__codelineno-24-27" name="__codelineno-24-27" href="#__codelineno-24-27"></a><span class="w">    </span><span class="n">DBoW2</span><span class="o">::</span><span class="n">FeatureVector</span><span class="o">::</span><span class="n">const_iterator</span><span class="w"> </span><span class="n">f2end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vFeatVec2</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
<a id="__codelineno-24-28" name="__codelineno-24-28" href="#__codelineno-24-28"></a>
<a id="__codelineno-24-29" name="__codelineno-24-29" href="#__codelineno-24-29"></a><span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="n">f1it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">f1end</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">f2it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">f2end</span><span class="p">)</span>
<a id="__codelineno-24-30" name="__codelineno-24-30" href="#__codelineno-24-30"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-24-31" name="__codelineno-24-31" href="#__codelineno-24-31"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">f1it</span><span class="o">-&gt;</span><span class="n">first</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">f2it</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">)</span>
<a id="__codelineno-24-32" name="__codelineno-24-32" href="#__codelineno-24-32"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-24-33" name="__codelineno-24-33" href="#__codelineno-24-33"></a><span class="w">            </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">iend1</span><span class="o">=</span><span class="n">f1it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i1</span><span class="o">&lt;</span><span class="n">iend1</span><span class="p">;</span><span class="w"> </span><span class="n">i1</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-24-34" name="__codelineno-24-34" href="#__codelineno-24-34"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-24-35" name="__codelineno-24-35" href="#__codelineno-24-35"></a><span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">idx1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f1it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">[</span><span class="n">i1</span><span class="p">];</span>
<a id="__codelineno-24-36" name="__codelineno-24-36" href="#__codelineno-24-36"></a><span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="o">&amp;</span><span class="n">d1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Descriptors1</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="n">idx1</span><span class="p">);</span>
<a id="__codelineno-24-37" name="__codelineno-24-37" href="#__codelineno-24-37"></a>
<a id="__codelineno-24-38" name="__codelineno-24-38" href="#__codelineno-24-38"></a><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">bestDist1</span><span class="o">=</span><span class="mi">256</span><span class="p">;</span>
<a id="__codelineno-24-39" name="__codelineno-24-39" href="#__codelineno-24-39"></a><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">bestIdx2</span><span class="w"> </span><span class="o">=</span><span class="mi">-1</span><span class="w"> </span><span class="p">;</span>
<a id="__codelineno-24-40" name="__codelineno-24-40" href="#__codelineno-24-40"></a><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">bestDist2</span><span class="o">=</span><span class="mi">256</span><span class="p">;</span>
<a id="__codelineno-24-41" name="__codelineno-24-41" href="#__codelineno-24-41"></a>
<a id="__codelineno-24-42" name="__codelineno-24-42" href="#__codelineno-24-42"></a><span class="w">                </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i2</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">iend2</span><span class="o">=</span><span class="n">f2it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i2</span><span class="o">&lt;</span><span class="n">iend2</span><span class="p">;</span><span class="w"> </span><span class="n">i2</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-24-43" name="__codelineno-24-43" href="#__codelineno-24-43"></a><span class="w">                </span><span class="p">{</span>
<a id="__codelineno-24-44" name="__codelineno-24-44" href="#__codelineno-24-44"></a><span class="w">                    </span><span class="k">const</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">idx2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f2it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">[</span><span class="n">i2</span><span class="p">];</span>
<a id="__codelineno-24-45" name="__codelineno-24-45" href="#__codelineno-24-45"></a>
<a id="__codelineno-24-46" name="__codelineno-24-46" href="#__codelineno-24-46"></a><span class="w">                    </span><span class="n">MapPoint</span><span class="o">*</span><span class="w"> </span><span class="n">pMP2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vpMapPoints2</span><span class="p">[</span><span class="n">idx2</span><span class="p">];</span>
<a id="__codelineno-24-47" name="__codelineno-24-47" href="#__codelineno-24-47"></a><span class="w">                    </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="o">&amp;</span><span class="n">d2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Descriptors2</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="n">idx2</span><span class="p">);</span>
<a id="__codelineno-24-48" name="__codelineno-24-48" href="#__codelineno-24-48"></a>
<a id="__codelineno-24-49" name="__codelineno-24-49" href="#__codelineno-24-49"></a><span class="w">                    </span><span class="kt">int</span><span class="w"> </span><span class="n">dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DescriptorDistance</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span><span class="n">d2</span><span class="p">);</span>
<a id="__codelineno-24-50" name="__codelineno-24-50" href="#__codelineno-24-50"></a>
<a id="__codelineno-24-51" name="__codelineno-24-51" href="#__codelineno-24-51"></a><span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="n">dist</span><span class="o">&lt;</span><span class="n">bestDist1</span><span class="p">)</span>
<a id="__codelineno-24-52" name="__codelineno-24-52" href="#__codelineno-24-52"></a><span class="w">                    </span><span class="p">{</span>
<a id="__codelineno-24-53" name="__codelineno-24-53" href="#__codelineno-24-53"></a><span class="w">                        </span><span class="n">bestDist2</span><span class="o">=</span><span class="n">bestDist1</span><span class="p">;</span>
<a id="__codelineno-24-54" name="__codelineno-24-54" href="#__codelineno-24-54"></a><span class="w">                        </span><span class="n">bestDist1</span><span class="o">=</span><span class="n">dist</span><span class="p">;</span>
<a id="__codelineno-24-55" name="__codelineno-24-55" href="#__codelineno-24-55"></a><span class="w">                        </span><span class="n">bestIdx2</span><span class="o">=</span><span class="n">idx2</span><span class="p">;</span>
<a id="__codelineno-24-56" name="__codelineno-24-56" href="#__codelineno-24-56"></a><span class="w">                    </span><span class="p">}</span>
<a id="__codelineno-24-57" name="__codelineno-24-57" href="#__codelineno-24-57"></a><span class="w">                    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">dist</span><span class="o">&lt;</span><span class="n">bestDist2</span><span class="p">)</span>
<a id="__codelineno-24-58" name="__codelineno-24-58" href="#__codelineno-24-58"></a><span class="w">                    </span><span class="p">{</span>
<a id="__codelineno-24-59" name="__codelineno-24-59" href="#__codelineno-24-59"></a><span class="w">                        </span><span class="n">bestDist2</span><span class="o">=</span><span class="n">dist</span><span class="p">;</span>
<a id="__codelineno-24-60" name="__codelineno-24-60" href="#__codelineno-24-60"></a><span class="w">                    </span><span class="p">}</span>
<a id="__codelineno-24-61" name="__codelineno-24-61" href="#__codelineno-24-61"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-24-62" name="__codelineno-24-62" href="#__codelineno-24-62"></a>
<a id="__codelineno-24-63" name="__codelineno-24-63" href="#__codelineno-24-63"></a><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">bestDist1</span><span class="o">&lt;</span><span class="n">TH_LOW</span><span class="p">)</span>
<a id="__codelineno-24-64" name="__codelineno-24-64" href="#__codelineno-24-64"></a><span class="w">                </span><span class="p">{</span>
<a id="__codelineno-24-65" name="__codelineno-24-65" href="#__codelineno-24-65"></a><span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">bestDist1</span><span class="p">)</span><span class="o">&lt;</span><span class="n">mfNNratio</span><span class="o">*</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">bestDist2</span><span class="p">))</span>
<a id="__codelineno-24-66" name="__codelineno-24-66" href="#__codelineno-24-66"></a><span class="w">                    </span><span class="p">{</span>
<a id="__codelineno-24-67" name="__codelineno-24-67" href="#__codelineno-24-67"></a><span class="w">                        </span><span class="n">vpMatches12</span><span class="p">[</span><span class="n">idx1</span><span class="p">]</span><span class="o">=</span><span class="n">vpMapPoints2</span><span class="p">[</span><span class="n">bestIdx2</span><span class="p">];</span>
<a id="__codelineno-24-68" name="__codelineno-24-68" href="#__codelineno-24-68"></a><span class="w">                        </span><span class="n">vbMatched2</span><span class="p">[</span><span class="n">bestIdx2</span><span class="p">]</span><span class="o">=</span><span class="nb">true</span><span class="p">;</span>
<a id="__codelineno-24-69" name="__codelineno-24-69" href="#__codelineno-24-69"></a>
<a id="__codelineno-24-70" name="__codelineno-24-70" href="#__codelineno-24-70"></a><span class="w">                        </span><span class="k">if</span><span class="p">(</span><span class="n">mbCheckOrientation</span><span class="p">)</span>
<a id="__codelineno-24-71" name="__codelineno-24-71" href="#__codelineno-24-71"></a><span class="w">                        </span><span class="p">{</span>
<a id="__codelineno-24-72" name="__codelineno-24-72" href="#__codelineno-24-72"></a><span class="w">                            </span><span class="p">...</span><span class="w"> </span><span class="c1">// same as adding features&#39; angle forming a histogram in `SearchByProjection`</span>
<a id="__codelineno-24-73" name="__codelineno-24-73" href="#__codelineno-24-73"></a><span class="w">                        </span><span class="p">}</span>
<a id="__codelineno-24-74" name="__codelineno-24-74" href="#__codelineno-24-74"></a><span class="w">                        </span><span class="n">nmatches</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-24-75" name="__codelineno-24-75" href="#__codelineno-24-75"></a><span class="w">                    </span><span class="p">}</span>
<a id="__codelineno-24-76" name="__codelineno-24-76" href="#__codelineno-24-76"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-24-77" name="__codelineno-24-77" href="#__codelineno-24-77"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-24-78" name="__codelineno-24-78" href="#__codelineno-24-78"></a>
<a id="__codelineno-24-79" name="__codelineno-24-79" href="#__codelineno-24-79"></a><span class="w">            </span><span class="n">f1it</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-24-80" name="__codelineno-24-80" href="#__codelineno-24-80"></a><span class="w">            </span><span class="n">f2it</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-24-81" name="__codelineno-24-81" href="#__codelineno-24-81"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-24-82" name="__codelineno-24-82" href="#__codelineno-24-82"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">f1it</span><span class="o">-&gt;</span><span class="n">first</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">f2it</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-24-83" name="__codelineno-24-83" href="#__codelineno-24-83"></a><span class="w">            </span><span class="n">f1it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vFeatVec1</span><span class="p">.</span><span class="n">lower_bound</span><span class="p">(</span><span class="n">f2it</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">);</span>
<a id="__codelineno-24-84" name="__codelineno-24-84" href="#__codelineno-24-84"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-24-85" name="__codelineno-24-85" href="#__codelineno-24-85"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-24-86" name="__codelineno-24-86" href="#__codelineno-24-86"></a><span class="w">            </span><span class="n">f2it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vFeatVec2</span><span class="p">.</span><span class="n">lower_bound</span><span class="p">(</span><span class="n">f1it</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">);</span>
<a id="__codelineno-24-87" name="__codelineno-24-87" href="#__codelineno-24-87"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-24-88" name="__codelineno-24-88" href="#__codelineno-24-88"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-24-89" name="__codelineno-24-89" href="#__codelineno-24-89"></a>
<a id="__codelineno-24-90" name="__codelineno-24-90" href="#__codelineno-24-90"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mbCheckOrientation</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-24-91" name="__codelineno-24-91" href="#__codelineno-24-91"></a><span class="w">        </span><span class="p">...</span><span class="w"> </span><span class="c1">// same as removing non-prominent angle features in `SearchByProjection`</span>
<a id="__codelineno-24-92" name="__codelineno-24-92" href="#__codelineno-24-92"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-24-93" name="__codelineno-24-93" href="#__codelineno-24-93"></a>
<a id="__codelineno-24-94" name="__codelineno-24-94" href="#__codelineno-24-94"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">nmatches</span><span class="p">;</span>
<a id="__codelineno-24-95" name="__codelineno-24-95" href="#__codelineno-24-95"></a><span class="p">}</span>
</code></pre></div>
<h3 id="search-by-sim3">Search By <span class="arithmatex">\(Sim(3)\)</span></h3>
<p><code>SearchBySim3(...)</code> computes the  <span class="arithmatex">\(Sim(3)\)</span> transform from <code>KeyFrame *pKF1</code> to <code>KeyFrame *pKF2</code>, then by this transform searches for likely feature points in <code>pKF2</code> nearby the found features in <code>pKF1</code> by <code>GetFeaturesInArea(...)</code>.
Record the matching features.</p>
<p>Reversely, compute the  <span class="arithmatex">\(Sim(3)\)</span> transform from <code>KeyFrame *pKF2</code> to <code>KeyFrame *pKF1</code> and, same as above, find feature points in <code>pKF1</code> given existing feature points in <code>pKF2</code>.</p>
<p>Finally, assert the two keyframes have the matching feature point idx.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">ORBmatcher::SearchBySim3</span><span class="p">(</span><span class="n">KeyFrame</span><span class="w"> </span><span class="o">*</span><span class="n">pKF1</span><span class="p">,</span><span class="w"> </span><span class="n">KeyFrame</span><span class="w"> </span><span class="o">*</span><span class="n">pKF2</span><span class="p">,</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vpMatches12</span><span class="p">,</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="w">                             </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">&amp;</span><span class="n">s12</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="o">&amp;</span><span class="n">R12</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="o">&amp;</span><span class="n">t12</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">th</span><span class="p">)</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="p">{</span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">&amp;</span><span class="n">fx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF1</span><span class="o">-&gt;</span><span class="n">fx</span><span class="p">;</span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">&amp;</span><span class="n">fy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF1</span><span class="o">-&gt;</span><span class="n">fy</span><span class="p">;</span>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF1</span><span class="o">-&gt;</span><span class="n">cx</span><span class="p">;</span>
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF1</span><span class="o">-&gt;</span><span class="n">cy</span><span class="p">;</span>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a>
<a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a><span class="w">    </span><span class="c1">// Camera 1 from world</span>
<a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">R1w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF1</span><span class="o">-&gt;</span><span class="n">GetRotation</span><span class="p">();</span>
<a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">t1w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF1</span><span class="o">-&gt;</span><span class="n">GetTranslation</span><span class="p">();</span>
<a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a>
<a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a><span class="w">    </span><span class="c1">//Camera 2 from world</span>
<a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">R2w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF2</span><span class="o">-&gt;</span><span class="n">GetRotation</span><span class="p">();</span>
<a id="__codelineno-25-15" name="__codelineno-25-15" href="#__codelineno-25-15"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">t2w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF2</span><span class="o">-&gt;</span><span class="n">GetTranslation</span><span class="p">();</span>
<a id="__codelineno-25-16" name="__codelineno-25-16" href="#__codelineno-25-16"></a>
<a id="__codelineno-25-17" name="__codelineno-25-17" href="#__codelineno-25-17"></a><span class="w">    </span><span class="c1">//Transformation between cameras</span>
<a id="__codelineno-25-18" name="__codelineno-25-18" href="#__codelineno-25-18"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">sR12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s12</span><span class="o">*</span><span class="n">R12</span><span class="p">;</span>
<a id="__codelineno-25-19" name="__codelineno-25-19" href="#__codelineno-25-19"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">sR21</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">s12</span><span class="p">)</span><span class="o">*</span><span class="n">R12</span><span class="p">.</span><span class="n">t</span><span class="p">();</span>
<a id="__codelineno-25-20" name="__codelineno-25-20" href="#__codelineno-25-20"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">t21</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">sR21</span><span class="o">*</span><span class="n">t12</span><span class="p">;</span>
<a id="__codelineno-25-21" name="__codelineno-25-21" href="#__codelineno-25-21"></a>
<a id="__codelineno-25-22" name="__codelineno-25-22" href="#__codelineno-25-22"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">vpMapPoints1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF1</span><span class="o">-&gt;</span><span class="n">GetMapPointMatches</span><span class="p">();</span>
<a id="__codelineno-25-23" name="__codelineno-25-23" href="#__codelineno-25-23"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vpMapPoints1</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<a id="__codelineno-25-24" name="__codelineno-25-24" href="#__codelineno-25-24"></a>
<a id="__codelineno-25-25" name="__codelineno-25-25" href="#__codelineno-25-25"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">vpMapPoints2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF2</span><span class="o">-&gt;</span><span class="n">GetMapPointMatches</span><span class="p">();</span>
<a id="__codelineno-25-26" name="__codelineno-25-26" href="#__codelineno-25-26"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vpMapPoints2</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<a id="__codelineno-25-27" name="__codelineno-25-27" href="#__codelineno-25-27"></a>
<a id="__codelineno-25-28" name="__codelineno-25-28" href="#__codelineno-25-28"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vbAlreadyMatched1</span><span class="p">(</span><span class="n">N1</span><span class="p">,</span><span class="nb">false</span><span class="p">);</span>
<a id="__codelineno-25-29" name="__codelineno-25-29" href="#__codelineno-25-29"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vbAlreadyMatched2</span><span class="p">(</span><span class="n">N2</span><span class="p">,</span><span class="nb">false</span><span class="p">);</span>
<a id="__codelineno-25-30" name="__codelineno-25-30" href="#__codelineno-25-30"></a>
<a id="__codelineno-25-31" name="__codelineno-25-31" href="#__codelineno-25-31"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">N1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-32" name="__codelineno-25-32" href="#__codelineno-25-32"></a><span class="w">        </span><span class="n">MapPoint</span><span class="o">*</span><span class="w"> </span><span class="n">pMP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vpMatches12</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-25-33" name="__codelineno-25-33" href="#__codelineno-25-33"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">pMP</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-34" name="__codelineno-25-34" href="#__codelineno-25-34"></a><span class="w">            </span><span class="n">vbAlreadyMatched1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="nb">true</span><span class="p">;</span>
<a id="__codelineno-25-35" name="__codelineno-25-35" href="#__codelineno-25-35"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">idx2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">GetIndexInKeyFrame</span><span class="p">(</span><span class="n">pKF2</span><span class="p">);</span>
<a id="__codelineno-25-36" name="__codelineno-25-36" href="#__codelineno-25-36"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">idx2</span><span class="o">&gt;=</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">idx2</span><span class="o">&lt;</span><span class="n">N2</span><span class="p">)</span>
<a id="__codelineno-25-37" name="__codelineno-25-37" href="#__codelineno-25-37"></a><span class="w">                </span><span class="n">vbAlreadyMatched2</span><span class="p">[</span><span class="n">idx2</span><span class="p">]</span><span class="o">=</span><span class="nb">true</span><span class="p">;</span>
<a id="__codelineno-25-38" name="__codelineno-25-38" href="#__codelineno-25-38"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-25-39" name="__codelineno-25-39" href="#__codelineno-25-39"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-25-40" name="__codelineno-25-40" href="#__codelineno-25-40"></a>
<a id="__codelineno-25-41" name="__codelineno-25-41" href="#__codelineno-25-41"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vnMatch1</span><span class="p">(</span><span class="n">N1</span><span class="p">,</span><span class="mi">-1</span><span class="p">);</span>
<a id="__codelineno-25-42" name="__codelineno-25-42" href="#__codelineno-25-42"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vnMatch2</span><span class="p">(</span><span class="n">N2</span><span class="p">,</span><span class="mi">-1</span><span class="p">);</span>
<a id="__codelineno-25-43" name="__codelineno-25-43" href="#__codelineno-25-43"></a>
<a id="__codelineno-25-44" name="__codelineno-25-44" href="#__codelineno-25-44"></a><span class="w">    </span><span class="c1">// Transform from KF1 to KF2 and search</span>
<a id="__codelineno-25-45" name="__codelineno-25-45" href="#__codelineno-25-45"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i1</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i1</span><span class="o">&lt;</span><span class="n">N1</span><span class="p">;</span><span class="w"> </span><span class="n">i1</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-25-46" name="__codelineno-25-46" href="#__codelineno-25-46"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-25-47" name="__codelineno-25-47" href="#__codelineno-25-47"></a><span class="w">        </span><span class="n">MapPoint</span><span class="o">*</span><span class="w"> </span><span class="n">pMP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vpMapPoints1</span><span class="p">[</span><span class="n">i1</span><span class="p">];</span>
<a id="__codelineno-25-48" name="__codelineno-25-48" href="#__codelineno-25-48"></a>
<a id="__codelineno-25-49" name="__codelineno-25-49" href="#__codelineno-25-49"></a><span class="w">        </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">p3Dw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">GetWorldPos</span><span class="p">();</span>
<a id="__codelineno-25-50" name="__codelineno-25-50" href="#__codelineno-25-50"></a><span class="w">        </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">p3Dc1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">R1w</span><span class="o">*</span><span class="n">p3Dw</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">t1w</span><span class="p">;</span>
<a id="__codelineno-25-51" name="__codelineno-25-51" href="#__codelineno-25-51"></a><span class="w">        </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">p3Dc2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sR21</span><span class="o">*</span><span class="n">p3Dc1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">t21</span><span class="p">;</span>
<a id="__codelineno-25-52" name="__codelineno-25-52" href="#__codelineno-25-52"></a>
<a id="__codelineno-25-53" name="__codelineno-25-53" href="#__codelineno-25-53"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">invz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="o">/</span><span class="n">p3Dc2</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-25-54" name="__codelineno-25-54" href="#__codelineno-25-54"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p3Dc2</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">invz</span><span class="p">;</span>
<a id="__codelineno-25-55" name="__codelineno-25-55" href="#__codelineno-25-55"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p3Dc2</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">invz</span><span class="p">;</span>
<a id="__codelineno-25-56" name="__codelineno-25-56" href="#__codelineno-25-56"></a>
<a id="__codelineno-25-57" name="__codelineno-25-57" href="#__codelineno-25-57"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fx</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="n">cx</span><span class="p">;</span>
<a id="__codelineno-25-58" name="__codelineno-25-58" href="#__codelineno-25-58"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fy</span><span class="o">*</span><span class="n">y</span><span class="o">+</span><span class="n">cy</span><span class="p">;</span>
<a id="__codelineno-25-59" name="__codelineno-25-59" href="#__codelineno-25-59"></a>
<a id="__codelineno-25-60" name="__codelineno-25-60" href="#__codelineno-25-60"></a><span class="w">        </span><span class="c1">// Point must be inside the image</span>
<a id="__codelineno-25-61" name="__codelineno-25-61" href="#__codelineno-25-61"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">pKF2</span><span class="o">-&gt;</span><span class="n">IsInImage</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">))</span>
<a id="__codelineno-25-62" name="__codelineno-25-62" href="#__codelineno-25-62"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-25-63" name="__codelineno-25-63" href="#__codelineno-25-63"></a>
<a id="__codelineno-25-64" name="__codelineno-25-64" href="#__codelineno-25-64"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">dist3D</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">norm</span><span class="p">(</span><span class="n">p3Dc2</span><span class="p">);</span>
<a id="__codelineno-25-65" name="__codelineno-25-65" href="#__codelineno-25-65"></a>
<a id="__codelineno-25-66" name="__codelineno-25-66" href="#__codelineno-25-66"></a><span class="w">        </span><span class="c1">// Compute predicted octave</span>
<a id="__codelineno-25-67" name="__codelineno-25-67" href="#__codelineno-25-67"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nPredictedLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">PredictScale</span><span class="p">(</span><span class="n">dist3D</span><span class="p">,</span><span class="n">pKF2</span><span class="p">);</span>
<a id="__codelineno-25-68" name="__codelineno-25-68" href="#__codelineno-25-68"></a>
<a id="__codelineno-25-69" name="__codelineno-25-69" href="#__codelineno-25-69"></a><span class="w">        </span><span class="c1">// Search in a radius</span>
<a id="__codelineno-25-70" name="__codelineno-25-70" href="#__codelineno-25-70"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">radius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">th</span><span class="o">*</span><span class="n">pKF2</span><span class="o">-&gt;</span><span class="n">mvScaleFactors</span><span class="p">[</span><span class="n">nPredictedLevel</span><span class="p">];</span>
<a id="__codelineno-25-71" name="__codelineno-25-71" href="#__codelineno-25-71"></a>
<a id="__codelineno-25-72" name="__codelineno-25-72" href="#__codelineno-25-72"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vIndices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF2</span><span class="o">-&gt;</span><span class="n">GetFeaturesInArea</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">radius</span><span class="p">);</span>
<a id="__codelineno-25-73" name="__codelineno-25-73" href="#__codelineno-25-73"></a>
<a id="__codelineno-25-74" name="__codelineno-25-74" href="#__codelineno-25-74"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">vIndices</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
<a id="__codelineno-25-75" name="__codelineno-25-75" href="#__codelineno-25-75"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-25-76" name="__codelineno-25-76" href="#__codelineno-25-76"></a>
<a id="__codelineno-25-77" name="__codelineno-25-77" href="#__codelineno-25-77"></a><span class="w">        </span><span class="c1">// Match to the most similar keypoint in the radius</span>
<a id="__codelineno-25-78" name="__codelineno-25-78" href="#__codelineno-25-78"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">dMP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">GetDescriptor</span><span class="p">();</span>
<a id="__codelineno-25-79" name="__codelineno-25-79" href="#__codelineno-25-79"></a>
<a id="__codelineno-25-80" name="__codelineno-25-80" href="#__codelineno-25-80"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">bestDist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">INT_MAX</span><span class="p">;</span>
<a id="__codelineno-25-81" name="__codelineno-25-81" href="#__codelineno-25-81"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">bestIdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<a id="__codelineno-25-82" name="__codelineno-25-82" href="#__codelineno-25-82"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;::</span><span class="n">const_iterator</span><span class="w"> </span><span class="n">vit</span><span class="o">=</span><span class="n">vIndices</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">vend</span><span class="o">=</span><span class="n">vIndices</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">vit</span><span class="o">!=</span><span class="n">vend</span><span class="p">;</span><span class="w"> </span><span class="n">vit</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-25-83" name="__codelineno-25-83" href="#__codelineno-25-83"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-25-84" name="__codelineno-25-84" href="#__codelineno-25-84"></a><span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">vit</span><span class="p">;</span>
<a id="__codelineno-25-85" name="__codelineno-25-85" href="#__codelineno-25-85"></a>
<a id="__codelineno-25-86" name="__codelineno-25-86" href="#__codelineno-25-86"></a><span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dKF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF2</span><span class="o">-&gt;</span><span class="n">mDescriptors</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
<a id="__codelineno-25-87" name="__codelineno-25-87" href="#__codelineno-25-87"></a>
<a id="__codelineno-25-88" name="__codelineno-25-88" href="#__codelineno-25-88"></a><span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DescriptorDistance</span><span class="p">(</span><span class="n">dMP</span><span class="p">,</span><span class="n">dKF</span><span class="p">);</span>
<a id="__codelineno-25-89" name="__codelineno-25-89" href="#__codelineno-25-89"></a>
<a id="__codelineno-25-90" name="__codelineno-25-90" href="#__codelineno-25-90"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">dist</span><span class="o">&lt;</span><span class="n">bestDist</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-91" name="__codelineno-25-91" href="#__codelineno-25-91"></a><span class="w">                </span><span class="n">bestDist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dist</span><span class="p">;</span>
<a id="__codelineno-25-92" name="__codelineno-25-92" href="#__codelineno-25-92"></a><span class="w">                </span><span class="n">bestIdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idx</span><span class="p">;</span>
<a id="__codelineno-25-93" name="__codelineno-25-93" href="#__codelineno-25-93"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-25-94" name="__codelineno-25-94" href="#__codelineno-25-94"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-25-95" name="__codelineno-25-95" href="#__codelineno-25-95"></a>
<a id="__codelineno-25-96" name="__codelineno-25-96" href="#__codelineno-25-96"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">bestDist</span><span class="o">&lt;=</span><span class="n">TH_HIGH</span><span class="p">)</span><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-25-97" name="__codelineno-25-97" href="#__codelineno-25-97"></a><span class="w">            </span><span class="n">vnMatch1</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span><span class="o">=</span><span class="n">bestIdx</span><span class="p">;</span>
<a id="__codelineno-25-98" name="__codelineno-25-98" href="#__codelineno-25-98"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-25-99" name="__codelineno-25-99" href="#__codelineno-25-99"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-25-100" name="__codelineno-25-100" href="#__codelineno-25-100"></a>
<a id="__codelineno-25-101" name="__codelineno-25-101" href="#__codelineno-25-101"></a><span class="w">    </span><span class="c1">// Transform from KF2 to KF1 and search</span>
<a id="__codelineno-25-102" name="__codelineno-25-102" href="#__codelineno-25-102"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i2</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i2</span><span class="o">&lt;</span><span class="n">N2</span><span class="p">;</span><span class="w"> </span><span class="n">i2</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-103" name="__codelineno-25-103" href="#__codelineno-25-103"></a><span class="w">        </span><span class="n">MapPoint</span><span class="o">*</span><span class="w"> </span><span class="n">pMP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vpMapPoints2</span><span class="p">[</span><span class="n">i2</span><span class="p">];</span>
<a id="__codelineno-25-104" name="__codelineno-25-104" href="#__codelineno-25-104"></a>
<a id="__codelineno-25-105" name="__codelineno-25-105" href="#__codelineno-25-105"></a><span class="w">        </span><span class="p">...</span><span class="w"> </span><span class="c1">//  same as before having computed `u,v,radius`, but from KF2 to KF1</span>
<a id="__codelineno-25-106" name="__codelineno-25-106" href="#__codelineno-25-106"></a>
<a id="__codelineno-25-107" name="__codelineno-25-107" href="#__codelineno-25-107"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vIndices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF1</span><span class="o">-&gt;</span><span class="n">GetFeaturesInArea</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">radius</span><span class="p">);</span>
<a id="__codelineno-25-108" name="__codelineno-25-108" href="#__codelineno-25-108"></a>
<a id="__codelineno-25-109" name="__codelineno-25-109" href="#__codelineno-25-109"></a><span class="w">        </span><span class="c1">// Match to the most similar keypoint in the radius</span>
<a id="__codelineno-25-110" name="__codelineno-25-110" href="#__codelineno-25-110"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">dMP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">GetDescriptor</span><span class="p">();</span>
<a id="__codelineno-25-111" name="__codelineno-25-111" href="#__codelineno-25-111"></a>
<a id="__codelineno-25-112" name="__codelineno-25-112" href="#__codelineno-25-112"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">bestDist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">INT_MAX</span><span class="p">;</span>
<a id="__codelineno-25-113" name="__codelineno-25-113" href="#__codelineno-25-113"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">bestIdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<a id="__codelineno-25-114" name="__codelineno-25-114" href="#__codelineno-25-114"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;::</span><span class="n">const_iterator</span><span class="w"> </span><span class="n">vit</span><span class="o">=</span><span class="n">vIndices</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">vend</span><span class="o">=</span><span class="n">vIndices</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">vit</span><span class="o">!=</span><span class="n">vend</span><span class="p">;</span><span class="w"> </span><span class="n">vit</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-25-115" name="__codelineno-25-115" href="#__codelineno-25-115"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-25-116" name="__codelineno-25-116" href="#__codelineno-25-116"></a><span class="w">            </span><span class="p">...</span><span class="w"> </span><span class="c1">// same as before having computed distance and recorded the best idx</span>
<a id="__codelineno-25-117" name="__codelineno-25-117" href="#__codelineno-25-117"></a>
<a id="__codelineno-25-118" name="__codelineno-25-118" href="#__codelineno-25-118"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">dist</span><span class="o">&lt;</span><span class="n">bestDist</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-119" name="__codelineno-25-119" href="#__codelineno-25-119"></a><span class="w">                </span><span class="n">bestDist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dist</span><span class="p">;</span>
<a id="__codelineno-25-120" name="__codelineno-25-120" href="#__codelineno-25-120"></a><span class="w">                </span><span class="n">bestIdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idx</span><span class="p">;</span>
<a id="__codelineno-25-121" name="__codelineno-25-121" href="#__codelineno-25-121"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-25-122" name="__codelineno-25-122" href="#__codelineno-25-122"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-25-123" name="__codelineno-25-123" href="#__codelineno-25-123"></a>
<a id="__codelineno-25-124" name="__codelineno-25-124" href="#__codelineno-25-124"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">bestDist</span><span class="o">&lt;=</span><span class="n">TH_HIGH</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-125" name="__codelineno-25-125" href="#__codelineno-25-125"></a><span class="w">            </span><span class="n">vnMatch2</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span><span class="o">=</span><span class="n">bestIdx</span><span class="p">;</span>
<a id="__codelineno-25-126" name="__codelineno-25-126" href="#__codelineno-25-126"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-25-127" name="__codelineno-25-127" href="#__codelineno-25-127"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-25-128" name="__codelineno-25-128" href="#__codelineno-25-128"></a>
<a id="__codelineno-25-129" name="__codelineno-25-129" href="#__codelineno-25-129"></a><span class="w">    </span><span class="c1">// Check agreement: `vpMatches12` should see the same feature in `vpMapPoints2`</span>
<a id="__codelineno-25-130" name="__codelineno-25-130" href="#__codelineno-25-130"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nFound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-25-131" name="__codelineno-25-131" href="#__codelineno-25-131"></a>
<a id="__codelineno-25-132" name="__codelineno-25-132" href="#__codelineno-25-132"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i1</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i1</span><span class="o">&lt;</span><span class="n">N1</span><span class="p">;</span><span class="w"> </span><span class="n">i1</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-133" name="__codelineno-25-133" href="#__codelineno-25-133"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">idx2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vnMatch1</span><span class="p">[</span><span class="n">i1</span><span class="p">];</span>
<a id="__codelineno-25-134" name="__codelineno-25-134" href="#__codelineno-25-134"></a>
<a id="__codelineno-25-135" name="__codelineno-25-135" href="#__codelineno-25-135"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">idx2</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-136" name="__codelineno-25-136" href="#__codelineno-25-136"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">idx1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vnMatch2</span><span class="p">[</span><span class="n">idx2</span><span class="p">];</span>
<a id="__codelineno-25-137" name="__codelineno-25-137" href="#__codelineno-25-137"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">idx1</span><span class="o">==</span><span class="n">i1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-138" name="__codelineno-25-138" href="#__codelineno-25-138"></a><span class="w">                </span><span class="n">vpMatches12</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vpMapPoints2</span><span class="p">[</span><span class="n">idx2</span><span class="p">];</span>
<a id="__codelineno-25-139" name="__codelineno-25-139" href="#__codelineno-25-139"></a><span class="w">                </span><span class="n">nFound</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-25-140" name="__codelineno-25-140" href="#__codelineno-25-140"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-25-141" name="__codelineno-25-141" href="#__codelineno-25-141"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-25-142" name="__codelineno-25-142" href="#__codelineno-25-142"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-25-143" name="__codelineno-25-143" href="#__codelineno-25-143"></a>
<a id="__codelineno-25-144" name="__codelineno-25-144" href="#__codelineno-25-144"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">nFound</span><span class="p">;</span>
<a id="__codelineno-25-145" name="__codelineno-25-145" href="#__codelineno-25-145"></a><span class="p">}</span>
</code></pre></div>
<h2 id="local-pose-graph-optimization">Local Pose Graph Optimization</h2>
<h3 id="optimizerposeoptimizationframe-pframe"><code>Optimizer::PoseOptimization(Frame *pFrame)</code></h3>
<p>For <code>const int N = pFrame-&gt;N;</code> match points, build a hyper graph for optimization</p>
<p>There is only one vertex: <code>g2o::VertexSE3Expmap * vSE3 = new g2o::VertexSE3Expmap();</code> (represent a pose at the frame <code>pFrame</code>) that has the initial guess <code>pFrame-&gt;mTcw</code> and will be optimized constrained by the edge <code>g2o::EdgeSE3ProjectXYZOnlyPose* e = new g2o::EdgeSE3ProjectXYZOnlyPose();</code>, whose residual is the 3d-to-2d projection error.
All match points' projection errors are added as edges to the one vertex/pose.</p>
<p>Then perform four times optimizations.
After each optimization, outliers are excluded; this is done by <code>e-&gt;setLevel(1);</code>.
<code>setLevel(int)</code> is useful when calling <code>optimizer.initializeOptimization(int )</code>, that if set <code>initializeOptimization(0)</code>, the optimizer will include all edges up to level <code>0</code> in the optimization, and edges set to <code>level &gt;=1</code> will not be included.</p>
<p>The outlier selection criterion is a test if the sample sits outside the <span class="arithmatex">\(95\%\)</span> (by Chi-square distribution <span class="arithmatex">\(\mathcal{X}^2\)</span>, <span class="arithmatex">\(5.991\)</span> and <span class="arithmatex">\(7.815\)</span> represent the <span class="arithmatex">\(95\%\)</span> of confidence for the <span class="arithmatex">\(2\)</span>- and <span class="arithmatex">\(3\)</span>-dimension sample space).
In other words, the criterion removes <span class="arithmatex">\(5\%\)</span> most significant error samples.</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">Optimizer::PoseOptimization</span><span class="p">(</span><span class="n">Frame</span><span class="w"> </span><span class="o">*</span><span class="n">pFrame</span><span class="p">)</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="p">{</span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="w">    </span><span class="n">g2o</span><span class="o">::</span><span class="n">SparseOptimizer</span><span class="w"> </span><span class="n">optimizer</span><span class="p">;</span>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="w">    </span><span class="n">g2o</span><span class="o">::</span><span class="n">BlockSolver_6_3</span><span class="o">::</span><span class="n">LinearSolverType</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">linearSolver</span><span class="p">;</span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="w">    </span><span class="n">linearSolver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">g2o</span><span class="o">::</span><span class="n">LinearSolverDense</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">BlockSolver_6_3</span><span class="o">::</span><span class="n">PoseMatrixType</span><span class="o">&gt;</span><span class="p">();</span>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a>
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a><span class="w">    </span><span class="n">g2o</span><span class="o">::</span><span class="n">BlockSolver_6_3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">solver_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">g2o</span><span class="o">::</span><span class="n">BlockSolver_6_3</span><span class="p">(</span><span class="n">linearSolver</span><span class="p">);</span>
<a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a>
<a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a><span class="w">    </span><span class="n">g2o</span><span class="o">::</span><span class="n">OptimizationAlgorithmLevenberg</span><span class="o">*</span><span class="w"> </span><span class="n">solver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">g2o</span><span class="o">::</span><span class="n">OptimizationAlgorithmLevenberg</span><span class="p">(</span><span class="n">solver_ptr</span><span class="p">);</span>
<a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a><span class="w">    </span><span class="n">optimizer</span><span class="p">.</span><span class="n">setAlgorithm</span><span class="p">(</span><span class="n">solver</span><span class="p">);</span>
<a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a>
<a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nInitialCorrespondences</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a>
<a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a><span class="w">    </span><span class="c1">// Set Frame vertex</span>
<a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a><span class="w">    </span><span class="n">g2o</span><span class="o">::</span><span class="n">VertexSE3Expmap</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">vSE3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">g2o</span><span class="o">::</span><span class="n">VertexSE3Expmap</span><span class="p">();</span>
<a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a><span class="w">    </span><span class="n">vSE3</span><span class="o">-&gt;</span><span class="n">setEstimate</span><span class="p">(</span><span class="n">Converter</span><span class="o">::</span><span class="n">toSE3Quat</span><span class="p">(</span><span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">mTcw</span><span class="p">));</span>
<a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a><span class="w">    </span><span class="n">vSE3</span><span class="o">-&gt;</span><span class="n">setId</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a><span class="w">    </span><span class="n">vSE3</span><span class="o">-&gt;</span><span class="n">setFixed</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
<a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a><span class="w">    </span><span class="n">optimizer</span><span class="p">.</span><span class="n">addVertex</span><span class="p">(</span><span class="n">vSE3</span><span class="p">);</span>
<a id="__codelineno-26-21" name="__codelineno-26-21" href="#__codelineno-26-21"></a>
<a id="__codelineno-26-22" name="__codelineno-26-22" href="#__codelineno-26-22"></a><span class="w">    </span><span class="c1">// Set MapPoint vertices</span>
<a id="__codelineno-26-23" name="__codelineno-26-23" href="#__codelineno-26-23"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">N</span><span class="p">;</span>
<a id="__codelineno-26-24" name="__codelineno-26-24" href="#__codelineno-26-24"></a>
<a id="__codelineno-26-25" name="__codelineno-26-25" href="#__codelineno-26-25"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">EdgeSE3ProjectXYZOnlyPose</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">vpEdgesMono</span><span class="p">;</span>
<a id="__codelineno-26-26" name="__codelineno-26-26" href="#__codelineno-26-26"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vnIndexEdgeMono</span><span class="p">;</span>
<a id="__codelineno-26-27" name="__codelineno-26-27" href="#__codelineno-26-27"></a><span class="w">    </span><span class="n">vpEdgesMono</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">N</span><span class="p">);</span>
<a id="__codelineno-26-28" name="__codelineno-26-28" href="#__codelineno-26-28"></a><span class="w">    </span><span class="n">vnIndexEdgeMono</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">N</span><span class="p">);</span>
<a id="__codelineno-26-29" name="__codelineno-26-29" href="#__codelineno-26-29"></a>
<a id="__codelineno-26-30" name="__codelineno-26-30" href="#__codelineno-26-30"></a><span class="w">    </span><span class="p">...</span><span class="w"> </span><span class="c1">// some vars for stereo</span>
<a id="__codelineno-26-31" name="__codelineno-26-31" href="#__codelineno-26-31"></a>
<a id="__codelineno-26-32" name="__codelineno-26-32" href="#__codelineno-26-32"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">deltaMono</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="mf">5.991</span><span class="p">);</span>
<a id="__codelineno-26-33" name="__codelineno-26-33" href="#__codelineno-26-33"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">deltaStereo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="mf">7.815</span><span class="p">);</span>
<a id="__codelineno-26-34" name="__codelineno-26-34" href="#__codelineno-26-34"></a>
<a id="__codelineno-26-35" name="__codelineno-26-35" href="#__codelineno-26-35"></a>
<a id="__codelineno-26-36" name="__codelineno-26-36" href="#__codelineno-26-36"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-26-37" name="__codelineno-26-37" href="#__codelineno-26-37"></a><span class="w">    </span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">MapPoint</span><span class="o">::</span><span class="n">mGlobalMutex</span><span class="p">);</span>
<a id="__codelineno-26-38" name="__codelineno-26-38" href="#__codelineno-26-38"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-39" name="__codelineno-26-39" href="#__codelineno-26-39"></a><span class="w">        </span><span class="n">MapPoint</span><span class="o">*</span><span class="w"> </span><span class="n">pMP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">mvpMapPoints</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-26-40" name="__codelineno-26-40" href="#__codelineno-26-40"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">pMP</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-41" name="__codelineno-26-41" href="#__codelineno-26-41"></a><span class="w">            </span><span class="c1">// Monocular observation</span>
<a id="__codelineno-26-42" name="__codelineno-26-42" href="#__codelineno-26-42"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">mvuRight</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-43" name="__codelineno-26-43" href="#__codelineno-26-43"></a><span class="w">                </span><span class="n">nInitialCorrespondences</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-26-44" name="__codelineno-26-44" href="#__codelineno-26-44"></a><span class="w">                </span><span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">mvbOutlier</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-26-45" name="__codelineno-26-45" href="#__codelineno-26-45"></a>
<a id="__codelineno-26-46" name="__codelineno-26-46" href="#__codelineno-26-46"></a><span class="w">                </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">obs</span><span class="p">;</span>
<a id="__codelineno-26-47" name="__codelineno-26-47" href="#__codelineno-26-47"></a><span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">KeyPoint</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kpUn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">mvKeysUn</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-26-48" name="__codelineno-26-48" href="#__codelineno-26-48"></a><span class="w">                </span><span class="n">obs</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">kpUn</span><span class="p">.</span><span class="n">pt</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">kpUn</span><span class="p">.</span><span class="n">pt</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<a id="__codelineno-26-49" name="__codelineno-26-49" href="#__codelineno-26-49"></a>
<a id="__codelineno-26-50" name="__codelineno-26-50" href="#__codelineno-26-50"></a><span class="w">                </span><span class="n">g2o</span><span class="o">::</span><span class="n">EdgeSE3ProjectXYZOnlyPose</span><span class="o">*</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">g2o</span><span class="o">::</span><span class="n">EdgeSE3ProjectXYZOnlyPose</span><span class="p">();</span>
<a id="__codelineno-26-51" name="__codelineno-26-51" href="#__codelineno-26-51"></a>
<a id="__codelineno-26-52" name="__codelineno-26-52" href="#__codelineno-26-52"></a><span class="w">                </span><span class="c1">// `dynamic_cast` is used since `g2o::VertexSE3Expmap * vSE3` inherits from `g2o::OptimizableGraph::Vertex`</span>
<a id="__codelineno-26-53" name="__codelineno-26-53" href="#__codelineno-26-53"></a><span class="w">                </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">setVertex</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">OptimizableGraph</span><span class="o">::</span><span class="n">Vertex</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">optimizer</span><span class="p">.</span><span class="n">vertex</span><span class="p">(</span><span class="mi">0</span><span class="p">)));</span>
<a id="__codelineno-26-54" name="__codelineno-26-54" href="#__codelineno-26-54"></a><span class="w">                </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">setMeasurement</span><span class="p">(</span><span class="n">obs</span><span class="p">);</span>
<a id="__codelineno-26-55" name="__codelineno-26-55" href="#__codelineno-26-55"></a><span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">invSigma2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">mvInvLevelSigma2</span><span class="p">[</span><span class="n">kpUn</span><span class="p">.</span><span class="n">octave</span><span class="p">];</span>
<a id="__codelineno-26-56" name="__codelineno-26-56" href="#__codelineno-26-56"></a><span class="w">                </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">setInformation</span><span class="p">(</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix2d</span><span class="o">::</span><span class="n">Identity</span><span class="p">()</span><span class="o">*</span><span class="n">invSigma2</span><span class="p">);</span>
<a id="__codelineno-26-57" name="__codelineno-26-57" href="#__codelineno-26-57"></a>
<a id="__codelineno-26-58" name="__codelineno-26-58" href="#__codelineno-26-58"></a><span class="w">                </span><span class="n">g2o</span><span class="o">::</span><span class="n">RobustKernelHuber</span><span class="o">*</span><span class="w"> </span><span class="n">rk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">g2o</span><span class="o">::</span><span class="n">RobustKernelHuber</span><span class="p">;</span>
<a id="__codelineno-26-59" name="__codelineno-26-59" href="#__codelineno-26-59"></a><span class="w">                </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">setRobustKernel</span><span class="p">(</span><span class="n">rk</span><span class="p">);</span>
<a id="__codelineno-26-60" name="__codelineno-26-60" href="#__codelineno-26-60"></a><span class="w">                </span><span class="n">rk</span><span class="o">-&gt;</span><span class="n">setDelta</span><span class="p">(</span><span class="n">deltaMono</span><span class="p">);</span>
<a id="__codelineno-26-61" name="__codelineno-26-61" href="#__codelineno-26-61"></a>
<a id="__codelineno-26-62" name="__codelineno-26-62" href="#__codelineno-26-62"></a><span class="w">                </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">fx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">fx</span><span class="p">;</span>
<a id="__codelineno-26-63" name="__codelineno-26-63" href="#__codelineno-26-63"></a><span class="w">                </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">fy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">fy</span><span class="p">;</span>
<a id="__codelineno-26-64" name="__codelineno-26-64" href="#__codelineno-26-64"></a><span class="w">                </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">cx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">cx</span><span class="p">;</span>
<a id="__codelineno-26-65" name="__codelineno-26-65" href="#__codelineno-26-65"></a><span class="w">                </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">cy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">cy</span><span class="p">;</span>
<a id="__codelineno-26-66" name="__codelineno-26-66" href="#__codelineno-26-66"></a><span class="w">                </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">Xw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">GetWorldPos</span><span class="p">();</span>
<a id="__codelineno-26-67" name="__codelineno-26-67" href="#__codelineno-26-67"></a><span class="w">                </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">Xw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Xw</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-26-68" name="__codelineno-26-68" href="#__codelineno-26-68"></a><span class="w">                </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">Xw</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Xw</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-26-69" name="__codelineno-26-69" href="#__codelineno-26-69"></a><span class="w">                </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">Xw</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Xw</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-26-70" name="__codelineno-26-70" href="#__codelineno-26-70"></a>
<a id="__codelineno-26-71" name="__codelineno-26-71" href="#__codelineno-26-71"></a><span class="w">                </span><span class="n">optimizer</span><span class="p">.</span><span class="n">addEdge</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
<a id="__codelineno-26-72" name="__codelineno-26-72" href="#__codelineno-26-72"></a>
<a id="__codelineno-26-73" name="__codelineno-26-73" href="#__codelineno-26-73"></a><span class="w">                </span><span class="n">vpEdgesMono</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
<a id="__codelineno-26-74" name="__codelineno-26-74" href="#__codelineno-26-74"></a><span class="w">                </span><span class="n">vnIndexEdgeMono</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<a id="__codelineno-26-75" name="__codelineno-26-75" href="#__codelineno-26-75"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-26-76" name="__codelineno-26-76" href="#__codelineno-26-76"></a><span class="w">            </span><span class="k">else</span><span class="w">  </span><span class="c1">// Stereo observation</span>
<a id="__codelineno-26-77" name="__codelineno-26-77" href="#__codelineno-26-77"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-26-78" name="__codelineno-26-78" href="#__codelineno-26-78"></a><span class="w">                </span><span class="p">...</span>
<a id="__codelineno-26-79" name="__codelineno-26-79" href="#__codelineno-26-79"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-26-80" name="__codelineno-26-80" href="#__codelineno-26-80"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-26-81" name="__codelineno-26-81" href="#__codelineno-26-81"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-26-82" name="__codelineno-26-82" href="#__codelineno-26-82"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-26-83" name="__codelineno-26-83" href="#__codelineno-26-83"></a>
<a id="__codelineno-26-84" name="__codelineno-26-84" href="#__codelineno-26-84"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">nInitialCorrespondences</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-26-85" name="__codelineno-26-85" href="#__codelineno-26-85"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-26-86" name="__codelineno-26-86" href="#__codelineno-26-86"></a>
<a id="__codelineno-26-87" name="__codelineno-26-87" href="#__codelineno-26-87"></a><span class="w">    </span><span class="c1">// We perform 4 optimizations, after each optimization we classify observation as inlier/outlier</span>
<a id="__codelineno-26-88" name="__codelineno-26-88" href="#__codelineno-26-88"></a><span class="w">    </span><span class="c1">// At the next optimization, outliers are not included, but at the end they can be classified as inliers again.</span>
<a id="__codelineno-26-89" name="__codelineno-26-89" href="#__codelineno-26-89"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">chi2Mono</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="mf">5.991</span><span class="p">,</span><span class="mf">5.991</span><span class="p">,</span><span class="mf">5.991</span><span class="p">,</span><span class="mf">5.991</span><span class="p">};</span>
<a id="__codelineno-26-90" name="__codelineno-26-90" href="#__codelineno-26-90"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">chi2Stereo</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="mf">7.815</span><span class="p">,</span><span class="mf">7.815</span><span class="p">,</span><span class="mf">7.815</span><span class="p">,</span><span class="w"> </span><span class="mf">7.815</span><span class="p">};</span>
<a id="__codelineno-26-91" name="__codelineno-26-91" href="#__codelineno-26-91"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">its</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">};</span><span class="w">    </span>
<a id="__codelineno-26-92" name="__codelineno-26-92" href="#__codelineno-26-92"></a>
<a id="__codelineno-26-93" name="__codelineno-26-93" href="#__codelineno-26-93"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nBad</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-26-94" name="__codelineno-26-94" href="#__codelineno-26-94"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">it</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">it</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="n">it</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-95" name="__codelineno-26-95" href="#__codelineno-26-95"></a>
<a id="__codelineno-26-96" name="__codelineno-26-96" href="#__codelineno-26-96"></a><span class="w">        </span><span class="n">vSE3</span><span class="o">-&gt;</span><span class="n">setEstimate</span><span class="p">(</span><span class="n">Converter</span><span class="o">::</span><span class="n">toSE3Quat</span><span class="p">(</span><span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">mTcw</span><span class="p">));</span>
<a id="__codelineno-26-97" name="__codelineno-26-97" href="#__codelineno-26-97"></a><span class="w">        </span><span class="n">optimizer</span><span class="p">.</span><span class="n">initializeOptimization</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-26-98" name="__codelineno-26-98" href="#__codelineno-26-98"></a><span class="w">        </span><span class="n">optimizer</span><span class="p">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">its</span><span class="p">[</span><span class="n">it</span><span class="p">]);</span>
<a id="__codelineno-26-99" name="__codelineno-26-99" href="#__codelineno-26-99"></a>
<a id="__codelineno-26-100" name="__codelineno-26-100" href="#__codelineno-26-100"></a><span class="w">        </span><span class="n">nBad</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-26-101" name="__codelineno-26-101" href="#__codelineno-26-101"></a><span class="w">        </span><span class="c1">// for each edge/feature projection error</span>
<a id="__codelineno-26-102" name="__codelineno-26-102" href="#__codelineno-26-102"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">iend</span><span class="o">=</span><span class="n">vpEdgesMono</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">iend</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-103" name="__codelineno-26-103" href="#__codelineno-26-103"></a><span class="w">            </span><span class="n">g2o</span><span class="o">::</span><span class="n">EdgeSE3ProjectXYZOnlyPose</span><span class="o">*</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vpEdgesMono</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-26-104" name="__codelineno-26-104" href="#__codelineno-26-104"></a>
<a id="__codelineno-26-105" name="__codelineno-26-105" href="#__codelineno-26-105"></a><span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vnIndexEdgeMono</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-26-106" name="__codelineno-26-106" href="#__codelineno-26-106"></a>
<a id="__codelineno-26-107" name="__codelineno-26-107" href="#__codelineno-26-107"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">mvbOutlier</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span><span class="w"> </span><span class="c1">// err will not be computed if is outlier</span>
<a id="__codelineno-26-108" name="__codelineno-26-108" href="#__codelineno-26-108"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-26-109" name="__codelineno-26-109" href="#__codelineno-26-109"></a><span class="w">                </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">computeError</span><span class="p">();</span>
<a id="__codelineno-26-110" name="__codelineno-26-110" href="#__codelineno-26-110"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-26-111" name="__codelineno-26-111" href="#__codelineno-26-111"></a>
<a id="__codelineno-26-112" name="__codelineno-26-112" href="#__codelineno-26-112"></a><span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">chi2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">chi2</span><span class="p">();</span>
<a id="__codelineno-26-113" name="__codelineno-26-113" href="#__codelineno-26-113"></a>
<a id="__codelineno-26-114" name="__codelineno-26-114" href="#__codelineno-26-114"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">chi2</span><span class="o">&gt;</span><span class="n">chi2Mono</span><span class="p">[</span><span class="n">it</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w">                </span>
<a id="__codelineno-26-115" name="__codelineno-26-115" href="#__codelineno-26-115"></a><span class="w">                </span><span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">mvbOutlier</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">=</span><span class="nb">true</span><span class="p">;</span>
<a id="__codelineno-26-116" name="__codelineno-26-116" href="#__codelineno-26-116"></a><span class="w">                </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">setLevel</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-26-117" name="__codelineno-26-117" href="#__codelineno-26-117"></a><span class="w">                </span><span class="n">nBad</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-26-118" name="__codelineno-26-118" href="#__codelineno-26-118"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-26-119" name="__codelineno-26-119" href="#__codelineno-26-119"></a><span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-120" name="__codelineno-26-120" href="#__codelineno-26-120"></a><span class="w">                </span><span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">mvbOutlier</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">=</span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-26-121" name="__codelineno-26-121" href="#__codelineno-26-121"></a><span class="w">                </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">setLevel</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-26-122" name="__codelineno-26-122" href="#__codelineno-26-122"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-26-123" name="__codelineno-26-123" href="#__codelineno-26-123"></a>
<a id="__codelineno-26-124" name="__codelineno-26-124" href="#__codelineno-26-124"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">it</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-26-125" name="__codelineno-26-125" href="#__codelineno-26-125"></a><span class="w">                </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">setRobustKernel</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-26-126" name="__codelineno-26-126" href="#__codelineno-26-126"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-26-127" name="__codelineno-26-127" href="#__codelineno-26-127"></a>
<a id="__codelineno-26-128" name="__codelineno-26-128" href="#__codelineno-26-128"></a><span class="w">        </span><span class="c1">// for stereo</span>
<a id="__codelineno-26-129" name="__codelineno-26-129" href="#__codelineno-26-129"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">iend</span><span class="o">=</span><span class="n">vpEdgesStereo</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">iend</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-130" name="__codelineno-26-130" href="#__codelineno-26-130"></a><span class="w">            </span><span class="p">...</span>
<a id="__codelineno-26-131" name="__codelineno-26-131" href="#__codelineno-26-131"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-26-132" name="__codelineno-26-132" href="#__codelineno-26-132"></a>
<a id="__codelineno-26-133" name="__codelineno-26-133" href="#__codelineno-26-133"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">optimizer</span><span class="p">.</span><span class="n">edges</span><span class="p">().</span><span class="n">size</span><span class="p">()</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">)</span>
<a id="__codelineno-26-134" name="__codelineno-26-134" href="#__codelineno-26-134"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-26-135" name="__codelineno-26-135" href="#__codelineno-26-135"></a><span class="w">    </span><span class="p">}</span><span class="w">    </span>
<a id="__codelineno-26-136" name="__codelineno-26-136" href="#__codelineno-26-136"></a>
<a id="__codelineno-26-137" name="__codelineno-26-137" href="#__codelineno-26-137"></a><span class="w">    </span><span class="c1">// Recover optimized pose and return number of inliers</span>
<a id="__codelineno-26-138" name="__codelineno-26-138" href="#__codelineno-26-138"></a><span class="w">    </span><span class="n">g2o</span><span class="o">::</span><span class="n">VertexSE3Expmap</span><span class="o">*</span><span class="w"> </span><span class="n">vSE3_recov</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">VertexSE3Expmap</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">optimizer</span><span class="p">.</span><span class="n">vertex</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<a id="__codelineno-26-139" name="__codelineno-26-139" href="#__codelineno-26-139"></a><span class="w">    </span><span class="n">g2o</span><span class="o">::</span><span class="n">SE3Quat</span><span class="w"> </span><span class="n">SE3quat_recov</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vSE3_recov</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">();</span>
<a id="__codelineno-26-140" name="__codelineno-26-140" href="#__codelineno-26-140"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">pose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Converter</span><span class="o">::</span><span class="n">toCvMat</span><span class="p">(</span><span class="n">SE3quat_recov</span><span class="p">);</span>
<a id="__codelineno-26-141" name="__codelineno-26-141" href="#__codelineno-26-141"></a><span class="w">    </span><span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">SetPose</span><span class="p">(</span><span class="n">pose</span><span class="p">);</span>
<a id="__codelineno-26-142" name="__codelineno-26-142" href="#__codelineno-26-142"></a>
<a id="__codelineno-26-143" name="__codelineno-26-143" href="#__codelineno-26-143"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">nInitialCorrespondences</span><span class="o">-</span><span class="n">nBad</span><span class="p">;</span>
<a id="__codelineno-26-144" name="__codelineno-26-144" href="#__codelineno-26-144"></a><span class="p">}</span>
</code></pre></div>
where
* <code>setToOriginImpl()</code> inits <code>_estimate</code> as the init guess
* <code>oplusImpl(const double* update_)</code> performs optimization step <span class="arithmatex">\(\mathbf{x}_{t+1}=\mathbf{x}_t \oplus \Delta\mathbf{x}_t\)</span>
* <code>computeError()</code> computes the residuals stored to <code>_error</code>
* <code>linearizeOplus()</code> computes the Jacobians
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="k">class</span><span class="w">  </span><span class="nc">VertexSE3Expmap</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">BaseVertex</span><span class="o">&lt;</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="n">SE3Quat</span><span class="o">&gt;</span><span class="p">{</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="k">public</span><span class="o">:</span>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="w">  </span><span class="n">EIGEN_MAKE_ALIGNED_OPERATOR_NEW</span>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="w">  </span><span class="n">VertexSE3Expmap</span><span class="p">();</span>
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a>
<a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="nf">read</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">istream</span><span class="o">&amp;</span><span class="w"> </span><span class="n">is</span><span class="p">);</span>
<a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a>
<a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="nf">write</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="n">os</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a>
<a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a><span class="w">  </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setToOriginImpl</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a><span class="w">    </span><span class="n">_estimate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SE3Quat</span><span class="p">();</span>
<a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a>
<a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a><span class="w">  </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">oplusImpl</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">update_</span><span class="p">)</span><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a><span class="w">    </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Map</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">Vector6d</span><span class="o">&gt;</span><span class="w"> </span><span class="n">update</span><span class="p">(</span><span class="n">update_</span><span class="p">);</span>
<a id="__codelineno-27-17" name="__codelineno-27-17" href="#__codelineno-27-17"></a><span class="w">    </span><span class="n">setEstimate</span><span class="p">(</span><span class="n">SE3Quat</span><span class="o">::</span><span class="n">exp</span><span class="p">(</span><span class="n">update</span><span class="p">)</span><span class="o">*</span><span class="n">estimate</span><span class="p">());</span>
<a id="__codelineno-27-18" name="__codelineno-27-18" href="#__codelineno-27-18"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-27-19" name="__codelineno-27-19" href="#__codelineno-27-19"></a><span class="p">};</span>
<a id="__codelineno-27-20" name="__codelineno-27-20" href="#__codelineno-27-20"></a>
<a id="__codelineno-27-21" name="__codelineno-27-21" href="#__codelineno-27-21"></a><span class="k">class</span><span class="w">  </span><span class="nc">EdgeSE3ProjectXYZOnlyPose</span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w">  </span><span class="n">BaseUnaryEdge</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">Vector2d</span><span class="p">,</span><span class="w"> </span><span class="n">VertexSE3Expmap</span><span class="o">&gt;</span><span class="p">{</span>
<a id="__codelineno-27-22" name="__codelineno-27-22" href="#__codelineno-27-22"></a><span class="k">public</span><span class="o">:</span>
<a id="__codelineno-27-23" name="__codelineno-27-23" href="#__codelineno-27-23"></a><span class="w">  </span><span class="n">EIGEN_MAKE_ALIGNED_OPERATOR_NEW</span>
<a id="__codelineno-27-24" name="__codelineno-27-24" href="#__codelineno-27-24"></a>
<a id="__codelineno-27-25" name="__codelineno-27-25" href="#__codelineno-27-25"></a><span class="w">  </span><span class="n">EdgeSE3ProjectXYZOnlyPose</span><span class="p">(){}</span>
<a id="__codelineno-27-26" name="__codelineno-27-26" href="#__codelineno-27-26"></a>
<a id="__codelineno-27-27" name="__codelineno-27-27" href="#__codelineno-27-27"></a><span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">read</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">istream</span><span class="o">&amp;</span><span class="w"> </span><span class="n">is</span><span class="p">);</span>
<a id="__codelineno-27-28" name="__codelineno-27-28" href="#__codelineno-27-28"></a>
<a id="__codelineno-27-29" name="__codelineno-27-29" href="#__codelineno-27-29"></a><span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="nf">write</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="n">os</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<a id="__codelineno-27-30" name="__codelineno-27-30" href="#__codelineno-27-30"></a>
<a id="__codelineno-27-31" name="__codelineno-27-31" href="#__codelineno-27-31"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">computeError</span><span class="p">()</span><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-27-32" name="__codelineno-27-32" href="#__codelineno-27-32"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VertexSE3Expmap</span><span class="o">*</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">VertexSE3Expmap</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">_vertices</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<a id="__codelineno-27-33" name="__codelineno-27-33" href="#__codelineno-27-33"></a><span class="w">    </span><span class="n">Vector2d</span><span class="w"> </span><span class="n">obs</span><span class="p">(</span><span class="n">_measurement</span><span class="p">);</span>
<a id="__codelineno-27-34" name="__codelineno-27-34" href="#__codelineno-27-34"></a><span class="w">    </span><span class="n">_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obs</span><span class="o">-</span><span class="n">cam_project</span><span class="p">(</span><span class="n">v1</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="n">Xw</span><span class="p">));</span>
<a id="__codelineno-27-35" name="__codelineno-27-35" href="#__codelineno-27-35"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-27-36" name="__codelineno-27-36" href="#__codelineno-27-36"></a>
<a id="__codelineno-27-37" name="__codelineno-27-37" href="#__codelineno-27-37"></a><span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="nf">isDepthPositive</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-38" name="__codelineno-27-38" href="#__codelineno-27-38"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VertexSE3Expmap</span><span class="o">*</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">VertexSE3Expmap</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">_vertices</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<a id="__codelineno-27-39" name="__codelineno-27-39" href="#__codelineno-27-39"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">v1</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="n">Xw</span><span class="p">))(</span><span class="mi">2</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.0</span><span class="p">;</span>
<a id="__codelineno-27-40" name="__codelineno-27-40" href="#__codelineno-27-40"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-27-41" name="__codelineno-27-41" href="#__codelineno-27-41"></a>
<a id="__codelineno-27-42" name="__codelineno-27-42" href="#__codelineno-27-42"></a>
<a id="__codelineno-27-43" name="__codelineno-27-43" href="#__codelineno-27-43"></a><span class="w">  </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">linearizeOplus</span><span class="p">();</span>
<a id="__codelineno-27-44" name="__codelineno-27-44" href="#__codelineno-27-44"></a>
<a id="__codelineno-27-45" name="__codelineno-27-45" href="#__codelineno-27-45"></a><span class="w">  </span><span class="n">Vector2d</span><span class="w"> </span><span class="nf">cam_project</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Vector3d</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">trans_xyz</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<a id="__codelineno-27-46" name="__codelineno-27-46" href="#__codelineno-27-46"></a>
<a id="__codelineno-27-47" name="__codelineno-27-47" href="#__codelineno-27-47"></a><span class="w">  </span><span class="n">Vector3d</span><span class="w"> </span><span class="n">Xw</span><span class="p">;</span>
<a id="__codelineno-27-48" name="__codelineno-27-48" href="#__codelineno-27-48"></a><span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">fx</span><span class="p">,</span><span class="w"> </span><span class="n">fy</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="n">cy</span><span class="p">;</span>
<a id="__codelineno-27-49" name="__codelineno-27-49" href="#__codelineno-27-49"></a><span class="p">};</span>
<a id="__codelineno-27-50" name="__codelineno-27-50" href="#__codelineno-27-50"></a>
<a id="__codelineno-27-51" name="__codelineno-27-51" href="#__codelineno-27-51"></a><span class="n">Vector2d</span><span class="w"> </span><span class="nf">EdgeSE3ProjectXYZOnlyPose::cam_project</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Vector3d</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">trans_xyz</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-52" name="__codelineno-27-52" href="#__codelineno-27-52"></a><span class="w">  </span><span class="n">Vector2d</span><span class="w"> </span><span class="n">proj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">project2d</span><span class="p">(</span><span class="n">trans_xyz</span><span class="p">);</span>
<a id="__codelineno-27-53" name="__codelineno-27-53" href="#__codelineno-27-53"></a><span class="w">  </span><span class="n">Vector2d</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<a id="__codelineno-27-54" name="__codelineno-27-54" href="#__codelineno-27-54"></a><span class="w">  </span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">fx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cx</span><span class="p">;</span>
<a id="__codelineno-27-55" name="__codelineno-27-55" href="#__codelineno-27-55"></a><span class="w">  </span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">fy</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cy</span><span class="p">;</span>
<a id="__codelineno-27-56" name="__codelineno-27-56" href="#__codelineno-27-56"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<a id="__codelineno-27-57" name="__codelineno-27-57" href="#__codelineno-27-57"></a><span class="p">}</span>
<a id="__codelineno-27-58" name="__codelineno-27-58" href="#__codelineno-27-58"></a>
<a id="__codelineno-27-59" name="__codelineno-27-59" href="#__codelineno-27-59"></a><span class="kt">double</span><span class="w"> </span><span class="nf">BaseEdge::chi2</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-60" name="__codelineno-27-60" href="#__codelineno-27-60"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">_error</span><span class="p">.</span><span class="n">dot</span><span class="p">(</span><span class="n">information</span><span class="p">()</span><span class="o">*</span><span class="n">_error</span><span class="p">);</span>
<a id="__codelineno-27-61" name="__codelineno-27-61" href="#__codelineno-27-61"></a><span class="p">}</span>
</code></pre></div></p>
<h3 id="compute-f">Compute <span class="arithmatex">\(F\)</span></h3>
<p>Given two keyframes <code>pKF1</code> and <code>pKF2</code>, camera instrinsics <code>K1</code> and <code>K2</code>,
the fundamental matrix <span class="arithmatex">\(F\)</span> (transform plus camera instrinsics) between the two keyframes can be computed as below.</p>
<div class="arithmatex">\[
\begin{align*}
&amp;&amp;
T = T^{-1} &amp;= 
\begin{bmatrix}
    R^{\top} &amp; -R^{\top}\mathbf{t} \\\\
    \mathbf{0}^{\top} &amp; 1
\end{bmatrix}
\\\\ \Rightarrow &amp;&amp;
{R}_{12} &amp;= R_{1}R_{2}^{\top}
\\\\ \Rightarrow &amp;&amp;
\mathbf{t}_{12}^\wedge &amp;= \big( -R_{1}R_{2}^{\top}\mathbf{t}_{2} + \mathbf{t}_{1} \big)^\wedge
\\\\ \space
\\\\ \Rightarrow &amp;&amp;
F &amp;= (K_1^{\top})^{-1} \mathbf{t}_{12}^\wedge \mathbf{R}_{12} K_2^{-1}
\end{align*}
\]</div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="nf">LocalMapping::ComputeF12</span><span class="p">(</span><span class="n">KeyFrame</span><span class="w"> </span><span class="o">*&amp;</span><span class="n">pKF1</span><span class="p">,</span><span class="w"> </span><span class="n">KeyFrame</span><span class="w"> </span><span class="o">*&amp;</span><span class="n">pKF2</span><span class="p">)</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="p">{</span>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">R1w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF1</span><span class="o">-&gt;</span><span class="n">GetRotation</span><span class="p">();</span>
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">t1w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF1</span><span class="o">-&gt;</span><span class="n">GetTranslation</span><span class="p">();</span>
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">R2w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF2</span><span class="o">-&gt;</span><span class="n">GetRotation</span><span class="p">();</span>
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">t2w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF2</span><span class="o">-&gt;</span><span class="n">GetTranslation</span><span class="p">();</span>
<a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a>
<a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">R12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">R1w</span><span class="o">*</span><span class="n">R2w</span><span class="p">.</span><span class="n">t</span><span class="p">();</span>
<a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">t12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">R1w</span><span class="o">*</span><span class="n">R2w</span><span class="p">.</span><span class="n">t</span><span class="p">()</span><span class="o">*</span><span class="n">t2w</span><span class="o">+</span><span class="n">t1w</span><span class="p">;</span>
<a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a>
<a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">t12x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SkewSymmetricMatrix</span><span class="p">(</span><span class="n">t12</span><span class="p">);</span>
<a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a>
<a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="o">&amp;</span><span class="n">K1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF1</span><span class="o">-&gt;</span><span class="n">mK</span><span class="p">;</span>
<a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="o">&amp;</span><span class="n">K2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF2</span><span class="o">-&gt;</span><span class="n">mK</span><span class="p">;</span>
<a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a>
<a id="__codelineno-28-16" name="__codelineno-28-16" href="#__codelineno-28-16"></a>
<a id="__codelineno-28-17" name="__codelineno-28-17" href="#__codelineno-28-17"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">K1</span><span class="p">.</span><span class="n">t</span><span class="p">().</span><span class="n">inv</span><span class="p">()</span><span class="o">*</span><span class="n">t12x</span><span class="o">*</span><span class="n">R12</span><span class="o">*</span><span class="n">K2</span><span class="p">.</span><span class="n">inv</span><span class="p">();</span>
<a id="__codelineno-28-18" name="__codelineno-28-18" href="#__codelineno-28-18"></a><span class="p">}</span>
</code></pre></div>
<h2 id="monocular-mapping-initialization">Monocular Mapping Initialization</h2>
<p><code>MonocularInitialization()</code> computes the relative transform pose between two/a few frames to triangulate an initial set of map points, 
ORB-SLAM proposes to compute in parallel two geometrical models: 
* a homography assuming a planar scene 
* a fundamental matrix assuming a non-planar scene.</p>
<p>The model selection task is done in <code>mpInitializer-&gt;Initialize(...)</code>.
Before model selection, should first find enough features to match between the initial few frames by <code>matcher.SearchForInitialization(...);</code>.
This function is repeated called until there are enough match points between some initial keyframes.</p>
<p><code>Initializer mpInitializer</code> is repeatedly <code>new</code>ed and <code>delete</code>ed if <code>matcher.SearchForInitialization(...);</code> could not find enough match points. </p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">Tracking::MonocularInitialization</span><span class="p">()</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="p">{</span>
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">mpInitializer</span><span class="p">)</span>
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a><span class="w">        </span><span class="c1">// Set Reference Frame</span>
<a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mvKeys</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">100</span><span class="p">)</span>
<a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a><span class="w">            </span><span class="n">mInitialFrame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Frame</span><span class="p">(</span><span class="n">mCurrentFrame</span><span class="p">);</span>
<a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a><span class="w">            </span><span class="n">mLastFrame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Frame</span><span class="p">(</span><span class="n">mCurrentFrame</span><span class="p">);</span>
<a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a><span class="w">            </span><span class="n">mvbPrevMatched</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mvKeysUn</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
<a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a><span class="w">            </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mvKeysUn</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a><span class="w">                </span><span class="n">mvbPrevMatched</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mvKeysUn</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pt</span><span class="p">;</span>
<a id="__codelineno-29-14" name="__codelineno-29-14" href="#__codelineno-29-14"></a>
<a id="__codelineno-29-15" name="__codelineno-29-15" href="#__codelineno-29-15"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">mpInitializer</span><span class="p">)</span>
<a id="__codelineno-29-16" name="__codelineno-29-16" href="#__codelineno-29-16"></a><span class="w">                </span><span class="k">delete</span><span class="w"> </span><span class="n">mpInitializer</span><span class="p">;</span>
<a id="__codelineno-29-17" name="__codelineno-29-17" href="#__codelineno-29-17"></a>
<a id="__codelineno-29-18" name="__codelineno-29-18" href="#__codelineno-29-18"></a><span class="w">            </span><span class="n">mpInitializer</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="k">new</span><span class="w"> </span><span class="n">Initializer</span><span class="p">(</span><span class="n">mCurrentFrame</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="mi">200</span><span class="p">);</span>
<a id="__codelineno-29-19" name="__codelineno-29-19" href="#__codelineno-29-19"></a>
<a id="__codelineno-29-20" name="__codelineno-29-20" href="#__codelineno-29-20"></a><span class="w">            </span><span class="n">fill</span><span class="p">(</span><span class="n">mvIniMatches</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="n">mvIniMatches</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="mi">-1</span><span class="p">);</span>
<a id="__codelineno-29-21" name="__codelineno-29-21" href="#__codelineno-29-21"></a>
<a id="__codelineno-29-22" name="__codelineno-29-22" href="#__codelineno-29-22"></a><span class="w">            </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-29-23" name="__codelineno-29-23" href="#__codelineno-29-23"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-29-24" name="__codelineno-29-24" href="#__codelineno-29-24"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-29-25" name="__codelineno-29-25" href="#__codelineno-29-25"></a><span class="w">    </span><span class="k">else</span>
<a id="__codelineno-29-26" name="__codelineno-29-26" href="#__codelineno-29-26"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-29-27" name="__codelineno-29-27" href="#__codelineno-29-27"></a><span class="w">        </span><span class="c1">// Try to initialize</span>
<a id="__codelineno-29-28" name="__codelineno-29-28" href="#__codelineno-29-28"></a><span class="w">        </span><span class="k">if</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mvKeys</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">&lt;=</span><span class="mi">100</span><span class="p">)</span>
<a id="__codelineno-29-29" name="__codelineno-29-29" href="#__codelineno-29-29"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-29-30" name="__codelineno-29-30" href="#__codelineno-29-30"></a><span class="w">            </span><span class="k">delete</span><span class="w"> </span><span class="n">mpInitializer</span><span class="p">;</span>
<a id="__codelineno-29-31" name="__codelineno-29-31" href="#__codelineno-29-31"></a><span class="w">            </span><span class="n">mpInitializer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Initializer</span><span class="o">*&gt;</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<a id="__codelineno-29-32" name="__codelineno-29-32" href="#__codelineno-29-32"></a><span class="w">            </span><span class="n">fill</span><span class="p">(</span><span class="n">mvIniMatches</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="n">mvIniMatches</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="mi">-1</span><span class="p">);</span>
<a id="__codelineno-29-33" name="__codelineno-29-33" href="#__codelineno-29-33"></a><span class="w">            </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-29-34" name="__codelineno-29-34" href="#__codelineno-29-34"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-29-35" name="__codelineno-29-35" href="#__codelineno-29-35"></a>
<a id="__codelineno-29-36" name="__codelineno-29-36" href="#__codelineno-29-36"></a><span class="w">        </span><span class="c1">// Find correspondences</span>
<a id="__codelineno-29-37" name="__codelineno-29-37" href="#__codelineno-29-37"></a><span class="w">        </span><span class="n">ORBmatcher</span><span class="w"> </span><span class="n">matcher</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span><span class="nb">true</span><span class="p">);</span>
<a id="__codelineno-29-38" name="__codelineno-29-38" href="#__codelineno-29-38"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">nmatches</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">matcher</span><span class="p">.</span><span class="n">SearchForInitialization</span><span class="p">(</span><span class="n">mInitialFrame</span><span class="p">,</span><span class="n">mCurrentFrame</span><span class="p">,</span><span class="n">mvbPrevMatched</span><span class="p">,</span><span class="n">mvIniMatches</span><span class="p">,</span><span class="mi">100</span><span class="p">);</span>
<a id="__codelineno-29-39" name="__codelineno-29-39" href="#__codelineno-29-39"></a>
<a id="__codelineno-29-40" name="__codelineno-29-40" href="#__codelineno-29-40"></a><span class="w">        </span><span class="c1">// Check if there are enough correspondences</span>
<a id="__codelineno-29-41" name="__codelineno-29-41" href="#__codelineno-29-41"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">nmatches</span><span class="o">&lt;</span><span class="mi">100</span><span class="p">)</span>
<a id="__codelineno-29-42" name="__codelineno-29-42" href="#__codelineno-29-42"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-29-43" name="__codelineno-29-43" href="#__codelineno-29-43"></a><span class="w">            </span><span class="k">delete</span><span class="w"> </span><span class="n">mpInitializer</span><span class="p">;</span>
<a id="__codelineno-29-44" name="__codelineno-29-44" href="#__codelineno-29-44"></a><span class="w">            </span><span class="n">mpInitializer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Initializer</span><span class="o">*&gt;</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<a id="__codelineno-29-45" name="__codelineno-29-45" href="#__codelineno-29-45"></a><span class="w">            </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-29-46" name="__codelineno-29-46" href="#__codelineno-29-46"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-29-47" name="__codelineno-29-47" href="#__codelineno-29-47"></a>
<a id="__codelineno-29-48" name="__codelineno-29-48" href="#__codelineno-29-48"></a><span class="w">        </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">Rcw</span><span class="p">;</span><span class="w"> </span><span class="c1">// Current Camera Rotation</span>
<a id="__codelineno-29-49" name="__codelineno-29-49" href="#__codelineno-29-49"></a><span class="w">        </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">tcw</span><span class="p">;</span><span class="w"> </span><span class="c1">// Current Camera Translation</span>
<a id="__codelineno-29-50" name="__codelineno-29-50" href="#__codelineno-29-50"></a><span class="w">        </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vbTriangulated</span><span class="p">;</span><span class="w"> </span><span class="c1">// Triangulated Correspondences (mvIniMatches)</span>
<a id="__codelineno-29-51" name="__codelineno-29-51" href="#__codelineno-29-51"></a>
<a id="__codelineno-29-52" name="__codelineno-29-52" href="#__codelineno-29-52"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">mpInitializer</span><span class="o">-&gt;</span><span class="n">Initialize</span><span class="p">(</span><span class="n">mCurrentFrame</span><span class="p">,</span><span class="w"> </span><span class="n">mvIniMatches</span><span class="p">,</span><span class="w"> </span><span class="n">Rcw</span><span class="p">,</span><span class="w"> </span><span class="n">tcw</span><span class="p">,</span><span class="w"> </span><span class="n">mvIniP3D</span><span class="p">,</span><span class="w"> </span><span class="n">vbTriangulated</span><span class="p">))</span>
<a id="__codelineno-29-53" name="__codelineno-29-53" href="#__codelineno-29-53"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-29-54" name="__codelineno-29-54" href="#__codelineno-29-54"></a><span class="w">            </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">iend</span><span class="o">=</span><span class="n">mvIniMatches</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">iend</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-29-55" name="__codelineno-29-55" href="#__codelineno-29-55"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-29-56" name="__codelineno-29-56" href="#__codelineno-29-56"></a><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">mvIniMatches</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;=</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">vbTriangulated</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<a id="__codelineno-29-57" name="__codelineno-29-57" href="#__codelineno-29-57"></a><span class="w">                </span><span class="p">{</span>
<a id="__codelineno-29-58" name="__codelineno-29-58" href="#__codelineno-29-58"></a><span class="w">                    </span><span class="n">mvIniMatches</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">-1</span><span class="p">;</span>
<a id="__codelineno-29-59" name="__codelineno-29-59" href="#__codelineno-29-59"></a><span class="w">                    </span><span class="n">nmatches</span><span class="o">--</span><span class="p">;</span>
<a id="__codelineno-29-60" name="__codelineno-29-60" href="#__codelineno-29-60"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-29-61" name="__codelineno-29-61" href="#__codelineno-29-61"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-29-62" name="__codelineno-29-62" href="#__codelineno-29-62"></a>
<a id="__codelineno-29-63" name="__codelineno-29-63" href="#__codelineno-29-63"></a><span class="w">            </span><span class="c1">// Set Frame Poses</span>
<a id="__codelineno-29-64" name="__codelineno-29-64" href="#__codelineno-29-64"></a><span class="w">            </span><span class="n">mInitialFrame</span><span class="p">.</span><span class="n">SetPose</span><span class="p">(</span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">::</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">CV_32F</span><span class="p">));</span>
<a id="__codelineno-29-65" name="__codelineno-29-65" href="#__codelineno-29-65"></a><span class="w">            </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">Tcw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">::</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">CV_32F</span><span class="p">);</span>
<a id="__codelineno-29-66" name="__codelineno-29-66" href="#__codelineno-29-66"></a><span class="w">            </span><span class="n">Rcw</span><span class="p">.</span><span class="n">copyTo</span><span class="p">(</span><span class="n">Tcw</span><span class="p">.</span><span class="n">rowRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">).</span><span class="n">colRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">));</span>
<a id="__codelineno-29-67" name="__codelineno-29-67" href="#__codelineno-29-67"></a><span class="w">            </span><span class="n">tcw</span><span class="p">.</span><span class="n">copyTo</span><span class="p">(</span><span class="n">Tcw</span><span class="p">.</span><span class="n">rowRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">).</span><span class="n">col</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
<a id="__codelineno-29-68" name="__codelineno-29-68" href="#__codelineno-29-68"></a><span class="w">            </span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">SetPose</span><span class="p">(</span><span class="n">Tcw</span><span class="p">);</span>
<a id="__codelineno-29-69" name="__codelineno-29-69" href="#__codelineno-29-69"></a>
<a id="__codelineno-29-70" name="__codelineno-29-70" href="#__codelineno-29-70"></a><span class="w">            </span><span class="n">CreateInitialMapMonocular</span><span class="p">();</span>
<a id="__codelineno-29-71" name="__codelineno-29-71" href="#__codelineno-29-71"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-29-72" name="__codelineno-29-72" href="#__codelineno-29-72"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-29-73" name="__codelineno-29-73" href="#__codelineno-29-73"></a><span class="p">}</span>
</code></pre></div>
<p><code>Initializer::Initialize(...)</code> computes in parallel threads a homography <span class="arithmatex">\({H}_{cr}\)</span> and a
fundamental matrix <span class="arithmatex">\({F}_{cr}\)</span>:</p>
<div class="arithmatex">\[
\mathbf{x}_c = {H}_{cr} \mathbf{x}_r
\quad\quad
\mathbf{x}_c {F}_{cr} \mathbf{x}_r = 0
\]</div>
<p>where <span class="arithmatex">\(\mathbf{x}_c\)</span> and <span class="arithmatex">\(\mathbf{x}_r\)</span> are keypoints in two keyframes. </p>
<p>Both <span class="arithmatex">\({H}_{cr}\)</span> and <span class="arithmatex">\({F}_{cr}\)</span> are computed via RANSAC <em>Eight-Point Algorithm</em> inside <code>ComputeH21(...)</code> and <code>ComputeF21(...)</code> that use the selected best <span class="arithmatex">\(8\)</span> points to perform SVD to find <span class="arithmatex">\({H}_{cr}\)</span> and <span class="arithmatex">\({F}_{cr}\)</span> .</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">Initializer::FindHomography</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vbMatchesInliers</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">&amp;</span><span class="n">score</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="o">&amp;</span><span class="n">H21</span><span class="p">)</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="p">{</span>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="w">    </span><span class="p">...</span><span class="w"> </span><span class="c1">// some variable inits</span>
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a>
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a><span class="w">    </span><span class="c1">// Perform all RANSAC iterations and save the solution with highest score</span>
<a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">it</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">it</span><span class="o">&lt;</span><span class="n">mMaxIterations</span><span class="p">;</span><span class="w"> </span><span class="n">it</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a><span class="w">        </span><span class="c1">// Select a minimum set</span>
<a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;</span><span class="mi">8</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-30-11" name="__codelineno-30-11" href="#__codelineno-30-11"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mvSets</span><span class="p">[</span><span class="n">it</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
<a id="__codelineno-30-12" name="__codelineno-30-12" href="#__codelineno-30-12"></a><span class="w">            </span><span class="n">vPn1i</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vPn1</span><span class="p">[</span><span class="n">mvMatches12</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">first</span><span class="p">];</span>
<a id="__codelineno-30-13" name="__codelineno-30-13" href="#__codelineno-30-13"></a><span class="w">            </span><span class="n">vPn2i</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vPn2</span><span class="p">[</span><span class="n">mvMatches12</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">second</span><span class="p">];</span>
<a id="__codelineno-30-14" name="__codelineno-30-14" href="#__codelineno-30-14"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-30-15" name="__codelineno-30-15" href="#__codelineno-30-15"></a>
<a id="__codelineno-30-16" name="__codelineno-30-16" href="#__codelineno-30-16"></a><span class="w">        </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">Hn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ComputeH21</span><span class="p">(</span><span class="n">vPn1i</span><span class="p">,</span><span class="n">vPn2i</span><span class="p">);</span>
<a id="__codelineno-30-17" name="__codelineno-30-17" href="#__codelineno-30-17"></a><span class="w">        </span><span class="n">H21i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T2inv</span><span class="o">*</span><span class="n">Hn</span><span class="o">*</span><span class="n">T1</span><span class="p">;</span>
<a id="__codelineno-30-18" name="__codelineno-30-18" href="#__codelineno-30-18"></a><span class="w">        </span><span class="n">H12i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">H21i</span><span class="p">.</span><span class="n">inv</span><span class="p">();</span>
<a id="__codelineno-30-19" name="__codelineno-30-19" href="#__codelineno-30-19"></a>
<a id="__codelineno-30-20" name="__codelineno-30-20" href="#__codelineno-30-20"></a><span class="w">        </span><span class="n">currentScore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CheckHomography</span><span class="p">(</span><span class="n">H21i</span><span class="p">,</span><span class="w"> </span><span class="n">H12i</span><span class="p">,</span><span class="w"> </span><span class="n">vbCurrentInliers</span><span class="p">,</span><span class="w"> </span><span class="n">mSigma</span><span class="p">);</span>
<a id="__codelineno-30-21" name="__codelineno-30-21" href="#__codelineno-30-21"></a><span class="w">        </span><span class="p">...</span><span class="w"> </span><span class="c1">// get the best score</span>
<a id="__codelineno-30-22" name="__codelineno-30-22" href="#__codelineno-30-22"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-30-23" name="__codelineno-30-23" href="#__codelineno-30-23"></a><span class="p">}</span>
<a id="__codelineno-30-24" name="__codelineno-30-24" href="#__codelineno-30-24"></a>
<a id="__codelineno-30-25" name="__codelineno-30-25" href="#__codelineno-30-25"></a><span class="kt">void</span><span class="w"> </span><span class="nf">Initializer::FindFundamental</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vbMatchesInliers</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">&amp;</span><span class="n">score</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="o">&amp;</span><span class="n">F21</span><span class="p">)</span>
<a id="__codelineno-30-26" name="__codelineno-30-26" href="#__codelineno-30-26"></a><span class="p">{</span><span class="w">   </span>
<a id="__codelineno-30-27" name="__codelineno-30-27" href="#__codelineno-30-27"></a><span class="w">    </span><span class="p">...</span><span class="w"> </span><span class="c1">// some variable inits</span>
<a id="__codelineno-30-28" name="__codelineno-30-28" href="#__codelineno-30-28"></a>
<a id="__codelineno-30-29" name="__codelineno-30-29" href="#__codelineno-30-29"></a><span class="w">    </span><span class="c1">// Perform all RANSAC iterations and save the solution with highest score</span>
<a id="__codelineno-30-30" name="__codelineno-30-30" href="#__codelineno-30-30"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">it</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">it</span><span class="o">&lt;</span><span class="n">mMaxIterations</span><span class="p">;</span><span class="w"> </span><span class="n">it</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-30-31" name="__codelineno-30-31" href="#__codelineno-30-31"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-30-32" name="__codelineno-30-32" href="#__codelineno-30-32"></a><span class="w">        </span><span class="c1">// Select a minimum set</span>
<a id="__codelineno-30-33" name="__codelineno-30-33" href="#__codelineno-30-33"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;</span><span class="mi">8</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-30-34" name="__codelineno-30-34" href="#__codelineno-30-34"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-30-35" name="__codelineno-30-35" href="#__codelineno-30-35"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mvSets</span><span class="p">[</span><span class="n">it</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
<a id="__codelineno-30-36" name="__codelineno-30-36" href="#__codelineno-30-36"></a><span class="w">            </span><span class="n">vPn1i</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vPn1</span><span class="p">[</span><span class="n">mvMatches12</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">first</span><span class="p">];</span>
<a id="__codelineno-30-37" name="__codelineno-30-37" href="#__codelineno-30-37"></a><span class="w">            </span><span class="n">vPn2i</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vPn2</span><span class="p">[</span><span class="n">mvMatches12</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">second</span><span class="p">];</span>
<a id="__codelineno-30-38" name="__codelineno-30-38" href="#__codelineno-30-38"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-30-39" name="__codelineno-30-39" href="#__codelineno-30-39"></a>
<a id="__codelineno-30-40" name="__codelineno-30-40" href="#__codelineno-30-40"></a><span class="w">        </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">Fn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ComputeF21</span><span class="p">(</span><span class="n">vPn1i</span><span class="p">,</span><span class="n">vPn2i</span><span class="p">);</span>
<a id="__codelineno-30-41" name="__codelineno-30-41" href="#__codelineno-30-41"></a><span class="w">        </span><span class="n">F21i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T2t</span><span class="o">*</span><span class="n">Fn</span><span class="o">*</span><span class="n">T1</span><span class="p">;</span>
<a id="__codelineno-30-42" name="__codelineno-30-42" href="#__codelineno-30-42"></a>
<a id="__codelineno-30-43" name="__codelineno-30-43" href="#__codelineno-30-43"></a><span class="w">        </span><span class="n">currentScore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CheckFundamental</span><span class="p">(</span><span class="n">F21i</span><span class="p">,</span><span class="w"> </span><span class="n">vbCurrentInliers</span><span class="p">,</span><span class="w"> </span><span class="n">mSigma</span><span class="p">);</span>
<a id="__codelineno-30-44" name="__codelineno-30-44" href="#__codelineno-30-44"></a><span class="w">        </span><span class="p">...</span><span class="w"> </span><span class="c1">// get the best score</span>
<a id="__codelineno-30-45" name="__codelineno-30-45" href="#__codelineno-30-45"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-30-46" name="__codelineno-30-46" href="#__codelineno-30-46"></a><span class="p">}</span>
</code></pre></div>
<p>Then, <code>Initializer::Initialize(...)</code> computeS a score <span class="arithmatex">\(S_M\)</span> for each model <span class="arithmatex">\(M\)</span> (either <span class="arithmatex">\(M=F\)</span> for non-planar model or <span class="arithmatex">\(M=H\)</span> for planar model)</p>
<div class="arithmatex">\[
S_M = 
\sum_i \bigg(
\rho_M \big(
    d^2_{cr}(\mathbf{x}_{ri}, \mathbf{x}_{ci}) \big) +
\rho_M \big(
    d^2_{rc}(\mathbf{x}_{ri}, \mathbf{x}_{ci}) \big)
\bigg)
\]</div>
<p>where </p>
<div class="arithmatex">\[
\rho_M \big( d^2 \big) =
\left\{
    \begin{matrix}
        T_H - d^2 &amp; \text{if } d^2 &lt; T_M \\\\
        0 &amp; \text{if } d^2 \ge T_M \\\\
    \end{matrix}
\right.
\]</div>
<p>where <span class="arithmatex">\(d^2\)</span> is the symmetric transfer error, <span class="arithmatex">\(T_M\)</span> is an outlier rejector based on <span class="arithmatex">\(\mathcal{X}^2\)</span> test. <span class="arithmatex">\(T_H\)</span> is the outlier rejector for the homography (planar) model.</p>
<p>If the scene is planar, nearly planar or there is low
parallax, it can be explained by a homography. Otherwise, it should be anon-planar scene.</p>
<p>In implementation, if <span class="arithmatex">\(\frac{S_H}{S_H+S_F}&gt;0.45\)</span>, select homography model, otherwise, select non-planar model.</p>
<p>Full bundle adjustment is applied across multiple frames to further refine the initial reconstruction if <code>if(RH&gt;0.40)</code>. </p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="kt">bool</span><span class="w"> </span><span class="nf">Initializer::Initialize</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Frame</span><span class="w"> </span><span class="o">&amp;</span><span class="n">CurrentFrame</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vMatches12</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="o">&amp;</span><span class="n">R21</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="o">&amp;</span><span class="n">t21</span><span class="p">,</span>
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="w">                             </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">Point3f</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vP3D</span><span class="p">,</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vbTriangulated</span><span class="p">)</span>
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="p">{</span>
<a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="w">    </span><span class="p">...</span><span class="w"> </span><span class="c1">// some preparation work</span>
<a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="w">        </span><span class="c1">// assign random index to mvMatches12 so that it can be referenced in RANSAC</span>
<a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a>
<a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a><span class="w">    </span><span class="c1">// Launch threads to compute in parallel a fundamental matrix and a homography</span>
<a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vbMatchesInliersH</span><span class="p">,</span><span class="w"> </span><span class="n">vbMatchesInliersF</span><span class="p">;</span>
<a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">SH</span><span class="p">,</span><span class="w"> </span><span class="n">SF</span><span class="p">;</span>
<a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">H</span><span class="p">,</span><span class="w"> </span><span class="n">F</span><span class="p">;</span>
<a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a>
<a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a><span class="w">    </span><span class="kr">thread</span><span class="w"> </span><span class="n">threadH</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Initializer</span><span class="o">::</span><span class="n">FindHomography</span><span class="p">,</span><span class="k">this</span><span class="p">,</span><span class="n">ref</span><span class="p">(</span><span class="n">vbMatchesInliersH</span><span class="p">),</span><span class="w"> </span><span class="n">ref</span><span class="p">(</span><span class="n">SH</span><span class="p">),</span><span class="w"> </span><span class="n">ref</span><span class="p">(</span><span class="n">H</span><span class="p">));</span>
<a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a><span class="w">    </span><span class="kr">thread</span><span class="w"> </span><span class="n">threadF</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Initializer</span><span class="o">::</span><span class="n">FindFundamental</span><span class="p">,</span><span class="k">this</span><span class="p">,</span><span class="n">ref</span><span class="p">(</span><span class="n">vbMatchesInliersF</span><span class="p">),</span><span class="w"> </span><span class="n">ref</span><span class="p">(</span><span class="n">SF</span><span class="p">),</span><span class="w"> </span><span class="n">ref</span><span class="p">(</span><span class="n">F</span><span class="p">));</span>
<a id="__codelineno-31-14" name="__codelineno-31-14" href="#__codelineno-31-14"></a>
<a id="__codelineno-31-15" name="__codelineno-31-15" href="#__codelineno-31-15"></a><span class="w">    </span><span class="c1">// Wait until both threads have finished</span>
<a id="__codelineno-31-16" name="__codelineno-31-16" href="#__codelineno-31-16"></a><span class="w">    </span><span class="n">threadH</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
<a id="__codelineno-31-17" name="__codelineno-31-17" href="#__codelineno-31-17"></a><span class="w">    </span><span class="n">threadF</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
<a id="__codelineno-31-18" name="__codelineno-31-18" href="#__codelineno-31-18"></a>
<a id="__codelineno-31-19" name="__codelineno-31-19" href="#__codelineno-31-19"></a><span class="w">    </span><span class="c1">// Compute ratio of scores</span>
<a id="__codelineno-31-20" name="__codelineno-31-20" href="#__codelineno-31-20"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">RH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SH</span><span class="o">/</span><span class="p">(</span><span class="n">SH</span><span class="o">+</span><span class="n">SF</span><span class="p">);</span>
<a id="__codelineno-31-21" name="__codelineno-31-21" href="#__codelineno-31-21"></a>
<a id="__codelineno-31-22" name="__codelineno-31-22" href="#__codelineno-31-22"></a><span class="w">    </span><span class="c1">// Try to reconstruct from homography or fundamental depending on the ratio (0.40-0.45)</span>
<a id="__codelineno-31-23" name="__codelineno-31-23" href="#__codelineno-31-23"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">RH</span><span class="o">&gt;</span><span class="mf">0.40</span><span class="p">)</span>
<a id="__codelineno-31-24" name="__codelineno-31-24" href="#__codelineno-31-24"></a><span class="w">        </span><span class="c1">// We recover 8 motion hypotheses using the method of Faugeras et al.</span>
<a id="__codelineno-31-25" name="__codelineno-31-25" href="#__codelineno-31-25"></a><span class="w">        </span><span class="c1">// Motion and structure from motion in a piecewise planar environment.</span>
<a id="__codelineno-31-26" name="__codelineno-31-26" href="#__codelineno-31-26"></a><span class="w">        </span><span class="c1">// International Journal of Pattern Recognition and Artificial Intelligence, 1988</span>
<a id="__codelineno-31-27" name="__codelineno-31-27" href="#__codelineno-31-27"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ReconstructH</span><span class="p">(</span><span class="n">vbMatchesInliersH</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">mK</span><span class="p">,</span><span class="n">R21</span><span class="p">,</span><span class="n">t21</span><span class="p">,</span><span class="n">vP3D</span><span class="p">,</span><span class="n">vbTriangulated</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="mi">50</span><span class="p">);</span>
<a id="__codelineno-31-28" name="__codelineno-31-28" href="#__codelineno-31-28"></a><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="c1">//if(pF_HF&gt;0.6)</span>
<a id="__codelineno-31-29" name="__codelineno-31-29" href="#__codelineno-31-29"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ReconstructF</span><span class="p">(</span><span class="n">vbMatchesInliersF</span><span class="p">,</span><span class="n">F</span><span class="p">,</span><span class="n">mK</span><span class="p">,</span><span class="n">R21</span><span class="p">,</span><span class="n">t21</span><span class="p">,</span><span class="n">vP3D</span><span class="p">,</span><span class="n">vbTriangulated</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="mi">50</span><span class="p">);</span>
<a id="__codelineno-31-30" name="__codelineno-31-30" href="#__codelineno-31-30"></a>
<a id="__codelineno-31-31" name="__codelineno-31-31" href="#__codelineno-31-31"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-31-32" name="__codelineno-31-32" href="#__codelineno-31-32"></a><span class="p">}</span>
</code></pre></div>
<h2 id="sim3-optimization"><span class="arithmatex">\(Sim(3)\)</span> Optimization</h2>
<p><span class="arithmatex">\(Sim(3)\)</span> adds scale information for monocular vision.</p>
<p>Define a <span class="arithmatex">\(3\)</span>-d point <span class="arithmatex">\(\mathbf{p}=[X\quad Y\quad Z]^\top\)</span> and its transformation result <span class="arithmatex">\(\mathbf{p}'\)</span></p>
<div class="arithmatex">\[
\begin{align*}
    \mathbf{p}' &amp;= \begin{bmatrix}
    s\mathbf{R} &amp; \mathbf{t} \\\\
    \mathbf{0} &amp; 1
    \end{bmatrix}
    \mathbf{p}
    \\\\ &amp;=
    \begin{bmatrix}
    s\mathbf{R} &amp; \mathbf{t} \\\\
    \mathbf{0} &amp; 1
    \end{bmatrix}
    \begin{bmatrix}
        \mathbf{p} \\\\
        \mathbf{0}
    \end{bmatrix}
    \\\\ &amp;=
    s\mathbf{R}\mathbf{p} + \mathbf{t}
\end{align*}
\]</div>
<p>Here gives the definition to <span class="arithmatex">\(Sim(3)\)</span> and <span class="arithmatex">\(sim(3)\)</span>. <span class="arithmatex">\(\mathbf{\zeta}\)</span> is a 7-dimensional
vector that has the same elements as <span class="arithmatex">\(se(3)\)</span> plus one scaling factor <span class="arithmatex">\(\sigma\)</span>.</p>
<div class="arithmatex">\[
\begin{align*}
Sim(3) &amp;= \bigg\{
    \mathbf{S} = \begin{bmatrix}
        s\mathbf{R} &amp; \mathbf{t} \\\\
        \mathbf{0} &amp; 1
    \end{bmatrix}
    \in \mathbb{R}^{4 \times 4}
\bigg\} \\\\
sim(3) &amp;= \bigg\{
    \mathbf{\zeta} = \begin{bmatrix}
        \mathbf{\rho} \\\\
        \mathbf{\phi} \\\\
        \sigma
    \end{bmatrix}
    \in \mathbb{R}^{7}
    , \quad
    \mathbf{\zeta}^\wedge =
    \begin{bmatrix}
        \sigma \mathbf{I}+\mathbf{\phi}^\wedge &amp; \mathbf{\rho} \\\\
        \mathbf{0} &amp; \mathbf{0}
    \end{bmatrix}
    \in \mathbb{R}^{4 \times 4}
\bigg\}
\end{align*}
\]</div>
<h3 id="solve-sim3-by-closed-form-solution-of-absolute-orientation-using-unit-quaternions">Solve <span class="arithmatex">\(Sim(3)\)</span> by Closed-form Solution of Absolute Orientation Using Unit Quaternions</h3>
<p>Take three map points from the left hand side camera <span class="arithmatex">\(\{\mathbf{r}_{l,1}, \mathbf{r}_{l,2}, \mathbf{r}_{l,3}\}\)</span>; 
three map points from the right hand side camera <span class="arithmatex">\(\{\mathbf{r}_{r,1}, \mathbf{r}_{r,2}, \mathbf{r}_{r,3}\}\)</span>; </p>
<p>Take <span class="arithmatex">\(\mathbf{r}_{l,1}\)</span> as the origin for the left hand side coordinate, then define the estimates for three dimensions:
* <span class="arithmatex">\(\hat{\mathbf{x}}_l = {\mathbf{x}_l}/{||\mathbf{x}_l||},\qquad \mathbf{x}_l = \mathbf{r}_{l,2}-\mathbf{r}_{l,1}\)</span>
* <span class="arithmatex">\(\hat{\mathbf{y}}_l = {\mathbf{y}_l}/{||\mathbf{y}_l||},\qquad \mathbf{y}_l = (\mathbf{r}_{l,3}-\mathbf{r}_{l,1}) - \big( (\mathbf{r}_{l,3}-\mathbf{r}_{l,1}) \cdot \hat{\mathbf{x}}_l \big)\hat{\mathbf{x}}_l\)</span>
* <span class="arithmatex">\(\hat{\mathbf{z}}_l = {\mathbf{z}_l}/{||\mathbf{z}_l||},\qquad \mathbf{z}_l = \hat{\mathbf{x}}_l \times \hat{\mathbf{y}}_l\)</span>
where <span class="arithmatex">\(\big( (\mathbf{r}_{l,3}-\mathbf{r}_{l,1}) \cdot \hat{\mathbf{x}}_l \big)\hat{\mathbf{x}}_l\)</span> is the projection on the <span class="arithmatex">\(\hat{\mathbf{x}}_l\)</span> axis.</p>
<p>Set <span class="arithmatex">\(M_l = [\hat{\mathbf{x}}_l, \hat{\mathbf{y}}_l, \hat{\mathbf{z}}_l]\)</span> and <span class="arithmatex">\(M_r = [\hat{\mathbf{x}}_r, \hat{\mathbf{y}}_r, \hat{\mathbf{z}}_r]\)</span></p>
<div style="display: flex; justify-content: center;">
      <img src="imgs/sim3_computation.png" width="20%" height="20%" alt="sim3_computation" />
</div>
<p></br></p>
<p>For any vector on the left hand side coordinate <span class="arithmatex">\(\mathbf{r}_l\)</span>, assume a transform such that <span class="arithmatex">\(\mathbf{r}_r = sR(\mathbf{r}_l) + \mathbf{t}\)</span>.
The algorithm below attempts to find the optimal <span class="arithmatex">\(s^*\)</span>, <span class="arithmatex">\(R^*\)</span> and <span class="arithmatex">\(\mathbf{t}^*\)</span> given the corresponding points <span class="arithmatex">\(\mathbf{r}_l\)</span> and <span class="arithmatex">\(\mathbf{r}_r\)</span></p>
<ul>
<li><strong>Find the optimal translation <span class="arithmatex">\(\mathbf{t}^*\)</span></strong></li>
</ul>
<p>For any vector <span class="arithmatex">\(\mathbf{r}_{l,i}\)</span>, attempt to find <span class="arithmatex">\(\hat{\mathbf{r}}_{r,i} = s R( \mathbf{r}_{l,i}) + \mathbf{t}\)</span>, where <span class="arithmatex">\(\mathbf{t}\)</span> is the translation offset from the left to right coordinate system.
Here <span class="arithmatex">\(s\)</span> is a scale factor to rotation matrix <span class="arithmatex">\(R( \mathbf{r}_{l,i})\)</span> that has <span class="arithmatex">\(\big|\big| R(\mathbf{r}_{l,i}) \big|\big|^2 = \big|\big| \mathbf{r}_{l,i} \big|\big|^2\)</span> preserving the length during rotation operation (<span class="arithmatex">\(\big|\big| \mathbf{r}_{l,i} \big|\big|^2=\mathbf{r}_{l,i} \cdot \mathbf{r}_{l,i}\)</span>).</p>
<p>The residual of the least squared problem to find the optimal <span class="arithmatex">\(\mathbf{t}^*\)</span> is defined as below.</p>
<div class="arithmatex">\[
\begin{align*}
\mathbf{t}^* = \argmin_{\mathbf{t}} \mathbf{e}_i &amp;= 
\mathbf{r}_{r,i} - \hat{\mathbf{r}}_{r,i} 
\\\\ &amp;= 
\mathbf{r}_{r,i} - s R( \mathbf{r}_{l,i}) - \mathbf{t}    
\end{align*}
\]</div>
<p>Now, compute centroids served as offsets.</p>
<div class="arithmatex">\[
\overline{\mathbf{r}}_l = \frac{1}{n} \sum_{i=1}^n \mathbf{r}_{l,i}
\qquad
\overline{\mathbf{r}}_r = \frac{1}{n} \sum_{i=1}^n \mathbf{r}_{r,i}
\]</div>
<p>For any vector <span class="arithmatex">\(\mathbf{r}_{l,i}\)</span> or <span class="arithmatex">\(\mathbf{r}_{r,i}\)</span>, move/offset their coordinates from the origin reference <span class="arithmatex">\(\mathbf{r}_{l,1}\)</span> and <span class="arithmatex">\(\mathbf{r}_{r,1}\)</span> to the above computed centroid, denote the new origin's vectors as <span class="arithmatex">\(\mathbf{r}'_{l,i}\)</span> and <span class="arithmatex">\(\mathbf{r}'_{r,i}\)</span>.</p>
<div class="arithmatex">\[
\mathbf{r}'_{l,i} = \mathbf{r}_{l,i} - \overline{\mathbf{r}}_l
\qquad
\mathbf{r}'_{r,i} = \mathbf{r}_{r,i} - \overline{\mathbf{r}}_r
\]</div>
<p>Apparently, the new centroid reference's vectors' sums should be zeros.</p>
<div class="arithmatex">\[
\mathbf{r}'_{l,o} = \sum_{i=1}^n \mathbf{r}'_{l,i} = [0 \quad 0 \quad 0]^{\top}
\qquad
\mathbf{r}'_{r,o} = \sum_{i=1}^n \mathbf{r}'_{r,i} = [0 \quad 0 \quad 0]^{\top}
\]</div>
<p>Rewrite the residual,</p>
<div class="arithmatex">\[
\mathbf{e}_i = \mathbf{r}_{r,i}' - s R( \mathbf{r}_{l,i}') - \mathbf{t}'
\]</div>
<p>where</p>
<div class="arithmatex">\[
\mathbf{t}' =  \mathbf{t} - \overline{\mathbf{r}}_r + sR(\overline{\mathbf{r}}_l)
\]</div>
<p>So that the least squared problem becomes finding the optimal <span class="arithmatex">\(\mathbf{t}'\)</span></p>
<div class="arithmatex">\[
\begin{align*}
\min_{\mathbf{t}'} \sum_{i=1}^n \big|\big| \mathbf{e}_i \big|\big|^2 &amp;= 
\sum_{i=1}^n \big|\big| \mathbf{r}_{r,i}' - s R( \mathbf{r}_{l,i}') - \mathbf{t}' \big|\big|^2
\\\\ &amp;=
\sum_{i=1}^n \big|\big| \mathbf{r}_{r,i}' - s R( \mathbf{r}_{l,i}') \big|\big|^2 - nd{align*}
\]</div>
<p>The sum in the middle of this expression is zero since the measurements are referred to the centroid. </p>
<p>The first term does not depend on <span class="arithmatex">\(\mathbf{t}'\)</span>, and the last term cannot be negative. 
So that <span class="arithmatex">\(\sum_{i=1}^n \big|\big| \mathbf{e}_i \big|\big|^2\)</span> reaches its minimum when <span class="arithmatex">\(\mathbf{t}'=\mathbf{0}\)</span>.</p>
<p>Rewrite <span class="arithmatex">\(\mathbf{t}' = \mathbf{0} = \mathbf{t} - \overline{\mathbf{r}}_r + sR(\overline{\mathbf{r}}_l)\)</span>, so that the optimal translation <span class="arithmatex">\(\mathbf{t}^*\)</span> in <span class="arithmatex">\(Sim(3)\)</span> is just the difference between <span class="arithmatex">\(\overline{\mathbf{r}}_r\)</span> and scaled rotation <span class="arithmatex">\(sR(\overline{\mathbf{r}}_l)\)</span>.
In other words, if <span class="arithmatex">\(sR(\overline{\mathbf{r}}_l)\)</span> is known, the <span class="arithmatex">\(\mathbf{t}^*\)</span> can easily computed.</p>
<div class="arithmatex">\[
\mathbf{t}^* =  \overline{\mathbf{r}}_r - sR(\overline{\mathbf{r}}_l)
\]</div>
<p>Having said <span class="arithmatex">\(\mathbf{t}' = \mathbf{0}\)</span>, the error can be expressed as</p>
<div class="arithmatex">\[
\sum_{i=1}^n \big|\big| \mathbf{e}_i \big|\big|^2 =
\sum_{i=1}^n \big|\big| \mathbf{r}_{r,i}' - s R( \mathbf{r}_{l,i}') \big|\big|^2
\]</div>
<ul>
<li><strong>Find the optimal scale <span class="arithmatex">\(s^*\)</span></strong></li>
</ul>
<p>Expand the error term</p>
<div class="arithmatex">\[
\begin{align*}
&amp;&amp;
\sum_{i=1}^n \big|\big| \mathbf{e}_i \big|\big|^2 &amp;=
\sum_{i=1}^n \big|\big| \mathbf{r}_{r,i}' - s R( \mathbf{r}_{l,i}') \big|\big|^2
\\\\ &amp;&amp; &amp;=
\sum_{i=1}^n \big|\big| \mathbf{r}_{r,i}' \big|\big|^2 
-2s \sum_{i=1}^n \Big( \mathbf{r}_{r,i}' \cdot R( \mathbf{r}_{l,i}')  \Big)+\sum_{i=1}^n \underbrace{ \big|\big| R( \mathbf{r}_{l,i}') \big|\big|^2}_{
    \begin{matrix}
        =\big|\big| \mathbf{r}_{l,i}' \big|\big|^2  \\\\
        \text{ for they have} \\\\
        \text{the same length}
    \end{matrix}
}
\\\\ \text{Just rewrite the notations}
&amp;&amp; &amp;=
S_r - 2sD + s^2 S_l
\\\\ &amp;&amp; &amp;=
\underbrace{\Big( s\sqrt{S_l} - \frac{S}{\sqrt{S_l}} \Big)^2}_{\ge 0}+\frac{S_r S_l - D^2}{S_l}
\end{align*}
\]</div>
<p>The above quadratic term can have the optimal <span class="arithmatex">\(s^*=\frac{D}{S_l}\)</span> (derived by <span class="arithmatex">\(\Big( s\sqrt{S_l} - \frac{S}{\sqrt{S_l}} \Big)^2=0\)</span> ):</p>
<div class="arithmatex">\[
s^*=\frac{D}{S_l}=\frac{\sum_{i=1}^n \Big( \mathbf{r}_{r,i}' \cdot R( \mathbf{r}_{l,i}')  \Big)}
{\sum_{i=1}^n \big|\big| R( \mathbf{r}_{l,i}') \big|\big|^2}
\]</div>
<p>Now, consider the inverse transform from the right coordinate system to the left one:</p>
<div class="arithmatex">\[
s^{-1}=\frac{D^{-1}}{S_l}=\frac{\sum_{i=1}^n \Big( \mathbf{r}_{l,i}' \cdot R( \mathbf{r}_{r,i}')  \Big)}
{\sum_{i=1}^n \big|\big| R( \mathbf{r}_{r,i}') \big|\big|^2}
\ne \frac{1}{s} \text{ likely for the most of the time}
\]</div>
<p>where <span class="arithmatex">\(\big|\big| R( \mathbf{r}_{r,i}') \big|\big|^2=\big|\big| \mathbf{r}_{l,i}' \big|\big|^2\)</span> is constant.</p>
<p>This expression <span class="arithmatex">\(s^{*\space -1} \ne \frac{1}{s}\)</span> means that, the error computed with respect to scale <span class="arithmatex">\(s\)</span> according to transform from the left's to the right's <span class="arithmatex">\(\mathbf{e}_{i, l \rightarrow r}=\mathbf{r}_{r,i}' - s R( \mathbf{r}_{l,i}')\)</span> does not have the inverse scale <span class="arithmatex">\(\frac{1}{s}\)</span> when transformed from the right's to the left's.
In other words, the inverse transform error <span class="arithmatex">\(\mathbf{e}_{i, r \rightarrow l}\)</span> would see asymmetrical <span class="arithmatex">\(s^{-1}\)</span>.</p>
<p>Unless the left-to-right transform has much more precision than the right-to-left's that <span class="arithmatex">\(\mathbf{e}_{i, l \rightarrow r}=\mathbf{r}_{r,i}' - s R( \mathbf{r}_{l,i}')\)</span> becomes accurate, otherwise, to formulate the error with respect to the scale <span class="arithmatex">\(s\)</span>, it is better use the below symmetrical error that balances between the left-to-right and right-to-left transforms:</p>
<div class="arithmatex">\[
\mathbf{e}_i = 
\frac{1}{\sqrt{s}}\mathbf{r}'_{r,i} - \sqrt{s} R (\mathbf{r}_{l,i})
\]</div>
<p>The least squared problem becomes</p>
<div class="arithmatex">\[
\begin{align*}
\sum_{i=1}^n \big|\big| \mathbf{e}_i \big|\big|^2 &amp;=
\frac{1}{s}S_r - 2D + s S_l
\\\\ &amp;= 
\underbrace{\Big( \sqrt{s} {S_l} - \frac{1}{\sqrt{s}} S_r \Big)^2}_{\ge 0}+2(S_l S_r -D)
\end{align*}
\]</div>
<p>The optimal <span class="arithmatex">\(s^*=\frac{S_r}{S_l}\)</span> can be found when <span class="arithmatex">\(\Big( \sqrt{s} {S_l} - \frac{1}{\sqrt{s}} S_r \Big)^2=0\)</span>:</p>
<div class="arithmatex">\[
s^* = \sqrt{
    \frac{ \sum_{i=1}^n \big|\big| {\mathbf{r}'_{r,i}} \big|\big|^2 }
    { \sum_{i=1}^n \big|\big| {\mathbf{r}'_{l,i}} \big|\big|^2 }
}
\]</div>
<p>which has a great form where rotation <span class="arithmatex">\(R\)</span> is removed, that the optimal scale computation only concerns the vectors/map points <span class="arithmatex">\({\mathbf{r}'_{l}}\)</span> and <span class="arithmatex">\({\mathbf{r}'_{r}}\)</span> in the left and right coordinate systems.</p>
<p>The error <span class="arithmatex">\(\sum_{i=1}^n \big|\big| \mathbf{e}_i \big|\big|^2 = \underbrace{\Big( \sqrt{s} {S_l} - \frac{1}{\sqrt{s}} S_r \Big)^2}_{\ge 0} + 2(S_l S_r -D)\)</span> reaches its minimum when <span class="arithmatex">\(D=\sum_{i=1}^n \Big( \mathbf{r}_{r,i}' \cdot R( \mathbf{r}_{l,i}')  \Big)\)</span> grows to maximum.</p>
<ul>
<li><strong>Find the optimal rotation <span class="arithmatex">\(R^*\)</span></strong></li>
</ul>
<p>Denote <span class="arithmatex">\(\mathring{\mathbf{r}}\)</span> as the quaternion form of <span class="arithmatex">\(\mathbf{r}\)</span>:</p>
<div class="arithmatex">\[
\mathring{\mathbf{r}} = 
r_0 + \overrightarrow{i}r_x + \overrightarrow{j}r_y + \overrightarrow{k}r_z
\]</div>
<p>Express <span class="arithmatex">\(R\)</span> in quaternion form: <span class="arithmatex">\(\mathbf{r}\)</span> rotation by quaternion <span class="arithmatex">\(\mathring{\mathbf{q}}\)</span> can be expressed as</p>
<div class="arithmatex">\[
\mathring{\mathbf{r}}' = \mathring{\mathbf{q}} \mathring{\mathbf{r}} \mathring{\mathbf{q}}^{\dagger}
\]</div>
<p>where the rotation is defined as rotating an angle of <span class="arithmatex">\(\theta\)</span> about the axis defined by the unit vector <span class="arithmatex">\(\mathbf{u}\)</span> such that <span class="arithmatex">\(\mathring{\mathbf{q}} = \cos \frac{\theta}{2} + \sin\frac{\theta}{2} \big( \overrightarrow{i}u_x + \overrightarrow{j}u_y + \overrightarrow{k}u_z \big)\)</span>.
Here <span class="arithmatex">\(\mathring{\mathbf{q}}^{\dagger}\)</span> is the normalization term.</p>
<p>Then,</p>
<div class="arithmatex">\[
M= \sum_{i=1}^{n} \mathbf{r}'_{l,i} \mathbf{r'}_{l,i}^{\top}= \begin{bmatrix}
    S_{xx} &amp; S_{xy} &amp; S_{xz} \\\\
    S_{yx} &amp; S_{yy} &amp; S_{yz} \\\\
    S_{zx} &amp; S_{zy} &amp; S_{zz} \\\\
\end{bmatrix}
\]</div>
<p>where, for example, <span class="arithmatex">\(S_{xx}=\sum_{i=1}^{n} x'_{l,i} x'_{r,i}, S_{xy}=\sum_{i=1}^{n} x'_{l,i} y'_{r,i}\)</span>.</p>
<p>Recall that <span class="arithmatex">\(D=\sum_{i=1}^n \Big( \mathbf{r}_{r,i}' \cdot R( \mathbf{r}_{l,i}')  \Big)\)</span>  needs to grow to maximum for 
<span class="arithmatex">\(\sum_{i=1}^n \big|\big| \mathbf{e}_i \big|\big|^2 = \underbrace{\Big( \sqrt{s} {S_l} - \frac{1}{\sqrt{s}} S_r \Big)^2}_{\ge 0} + 2(S_l S_r -D)\)</span> reaching its minimum.
Rewrite <span class="arithmatex">\(D\)</span>'s elements to that <span class="arithmatex">\(\Big( \mathring{\mathbf{q}} \mathring{\mathbf{r}}_{l,i}' \mathring{\mathbf{q}}^{\dagger} \Big) \cdot \mathring{\mathbf{r}}_{r,i}' =\Big( \mathring{\mathbf{q}}\mathbf{r}_{l,i}' \Big) \cdot \Big(  \mathring{\mathbf{r}}_{r,i}' \mathring{\mathbf{q}} \Big)\)</span>.</p>
<p>Take <span class="arithmatex">\(\mathbf{r}_{l,i}' \rightarrow \mathring{\mathbf{r'}}_{l,i}\)</span>, then by quaternion multiplication, there is</p>
<div class="arithmatex">\[
\mathring{\mathbf{q}} \mathring{\mathbf{r}}_{l,i}' = 
\begin{bmatrix}
    0 &amp; -x'_{l,i} &amp; -y'_{l,i} &amp; -z'_{l,i} \\\\
    x'_{l,i} &amp; 0 &amp; z'_{l,i} &amp; -y'_{l,i} \\\\
    y'_{l,i} &amp; -z'_{l,i} &amp; 0 &amp; x'_{l,i} \\\\
    z'_{l,i} &amp; y'_{l,i} &amp; -x'_{l,i} &amp; 0 \\\\
\end{bmatrix}
\mathring{\mathbf{q}}=\overline{\mathcal{R}}_{l,i} \mathring{\mathbf{q}}
\]</div>
<p>Similarly, there is <span class="arithmatex">\(\mathring{\mathbf{r}}_{r,i}' \mathring{\mathbf{q}} = \mathcal{R}_{r,i} \mathring{\mathbf{q}}\)</span>.</p>
<p>So that, <span class="arithmatex">\(D\)</span> can be expressed as</p>
<div class="arithmatex">\[
\begin{align*}
D &amp;=
\sum_{i=1}^{n} \Big( \mathring{\mathbf{q}}\mathbf{r}_{r,i}' \Big) \cdot \Big( \mathring{\mathbf{q}} \mathring{\mathbf{r}}_{l,i}' \Big)
\\\\ &amp;=
\sum_{i=1}^{n} \Big( \overline{\mathcal{R}}_{l,i} \mathring{\mathbf{q}} \Big) \cdot \Big( {\mathcal{R}}_{r,i} \mathring{\mathbf{q}}  \Big)
\\\\ &amp;=
\sum_{i=1}^{n} \mathring{\mathbf{q}}^{\top} 
\underbrace{\overline{\mathcal{R}}_{l,i}^{\top} {\mathcal{R}}_{r,i} }_{=N_i}
\mathring{\mathbf{q}}
\\\\ &amp;=
\mathring{\mathbf{q}}^{\top} \Big( \sum_{i=1}^{n} N_i \Big) \mathring{\mathbf{q}}
\\\\ &amp;=
\mathring{\mathbf{q}}^{\top} N \mathring{\mathbf{q}}
\end{align*}
\]</div>
<p>The <span class="arithmatex">\(N\)</span> can be expressed as</p>
<div class="arithmatex">\[
N = \begin{bmatrix}
    S_{xx}+S_{yy}+S_{zz} &amp; S_{yz}-S{zy} &amp; S_{zx}-S{xz} &amp; S_{xy}-S{yx} \\\\
    S_{yz}-S{zy} &amp; S_{xx}-S_{yy}-S_{zz} &amp; S_{xy}+S{yx} &amp; S_{zx}+S{xz} \\\\
    S_{zx}-S{xz} &amp; S_{xy}+S{yx} &amp; -S_{xx}+S_{yy}-S_{zz} &amp; S_{yz}+S{zy} \\\\
    S_{xy}-S{yx} &amp; S_{zx}+S{xz} &amp; S_{yz}+S{zy} &amp; -S_{xx}-S_{yy}+S_{zz} \\\\
\end{bmatrix}
\]</div>
<p>Here <span class="arithmatex">\(N\)</span> is a real symmetric having <span class="arithmatex">\(10\)</span> independent elements serving the sums of the <span class="arithmatex">\(9\)</span> elements of <span class="arithmatex">\(M\)</span>.
The sum of the diagonal of <span class="arithmatex">\(N\)</span> is zero.
In other words, the trace <span class="arithmatex">\(tr(N)=0\)</span> takes care of the <span class="arithmatex">\(10\)</span>-th degree of freedom.</p>
<p>To maximize <span class="arithmatex">\(\mathring{\mathbf{q}}^{\top} N \mathring{\mathbf{q}}\)</span> by adjusting rotation <span class="arithmatex">\(\mathring{\mathbf{q}}\)</span>, here computes <span class="arithmatex">\(\text{det}(N-\lambda I)=0\)</span>, where the largest eigenvalue <span class="arithmatex">\(\lambda_{max}\)</span> corresponding eigenvector <span class="arithmatex">\(\mathbf{v}\)</span> is the optimal quaternion <span class="arithmatex">\(\mathring{\mathbf{q}}^*\)</span>.</p>
<p>Below code illustrates the algorithm.
RANSAC is selected to randomly find <span class="arithmatex">\(3\)</span> points for the left and right coordinate systems.
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="nf">Sim3Solver::iterate</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">nIterations</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bNoMore</span><span class="p">,</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vbInliers</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">&amp;</span><span class="n">nInliers</span><span class="p">)</span>
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="p">{</span>
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">P3Dc1i</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">CV_32F</span><span class="p">);</span>
<a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">P3Dc2i</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">CV_32F</span><span class="p">);</span>
<a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a>
<a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nCurrentIterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a><span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="n">mnIterations</span><span class="o">&lt;</span><span class="n">mRansacMaxIts</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">nCurrentIterations</span><span class="o">&lt;</span><span class="n">nIterations</span><span class="p">)</span>
<a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-32-10" name="__codelineno-32-10" href="#__codelineno-32-10"></a><span class="w">        </span><span class="n">nCurrentIterations</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-32-11" name="__codelineno-32-11" href="#__codelineno-32-11"></a><span class="w">        </span><span class="n">mnIterations</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-32-12" name="__codelineno-32-12" href="#__codelineno-32-12"></a>
<a id="__codelineno-32-13" name="__codelineno-32-13" href="#__codelineno-32-13"></a><span class="w">        </span><span class="n">vAvailableIndices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mvAllIndices</span><span class="p">;</span>
<a id="__codelineno-32-14" name="__codelineno-32-14" href="#__codelineno-32-14"></a>
<a id="__codelineno-32-15" name="__codelineno-32-15" href="#__codelineno-32-15"></a><span class="w">        </span><span class="c1">// Get min set of points</span>
<a id="__codelineno-32-16" name="__codelineno-32-16" href="#__codelineno-32-16"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">short</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<a id="__codelineno-32-17" name="__codelineno-32-17" href="#__codelineno-32-17"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-32-18" name="__codelineno-32-18" href="#__codelineno-32-18"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">randi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DUtils</span><span class="o">::</span><span class="n">Random</span><span class="o">::</span><span class="n">RandomInt</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">vAvailableIndices</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="mi">-1</span><span class="p">);</span>
<a id="__codelineno-32-19" name="__codelineno-32-19" href="#__codelineno-32-19"></a>
<a id="__codelineno-32-20" name="__codelineno-32-20" href="#__codelineno-32-20"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vAvailableIndices</span><span class="p">[</span><span class="n">randi</span><span class="p">];</span>
<a id="__codelineno-32-21" name="__codelineno-32-21" href="#__codelineno-32-21"></a>
<a id="__codelineno-32-22" name="__codelineno-32-22" href="#__codelineno-32-22"></a><span class="w">            </span><span class="n">mvX3Dc1</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">copyTo</span><span class="p">(</span><span class="n">P3Dc1i</span><span class="p">.</span><span class="n">col</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
<a id="__codelineno-32-23" name="__codelineno-32-23" href="#__codelineno-32-23"></a><span class="w">            </span><span class="n">mvX3Dc2</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">copyTo</span><span class="p">(</span><span class="n">P3Dc2i</span><span class="p">.</span><span class="n">col</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
<a id="__codelineno-32-24" name="__codelineno-32-24" href="#__codelineno-32-24"></a>
<a id="__codelineno-32-25" name="__codelineno-32-25" href="#__codelineno-32-25"></a><span class="w">            </span><span class="n">vAvailableIndices</span><span class="p">[</span><span class="n">randi</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vAvailableIndices</span><span class="p">.</span><span class="n">back</span><span class="p">();</span>
<a id="__codelineno-32-26" name="__codelineno-32-26" href="#__codelineno-32-26"></a><span class="w">            </span><span class="n">vAvailableIndices</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
<a id="__codelineno-32-27" name="__codelineno-32-27" href="#__codelineno-32-27"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-32-28" name="__codelineno-32-28" href="#__codelineno-32-28"></a>
<a id="__codelineno-32-29" name="__codelineno-32-29" href="#__codelineno-32-29"></a><span class="w">        </span><span class="n">ComputeSim3</span><span class="p">(</span><span class="n">P3Dc1i</span><span class="p">,</span><span class="n">P3Dc2i</span><span class="p">);</span>
<a id="__codelineno-32-30" name="__codelineno-32-30" href="#__codelineno-32-30"></a><span class="w">        </span><span class="p">...</span>
<a id="__codelineno-32-31" name="__codelineno-32-31" href="#__codelineno-32-31"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-32-32" name="__codelineno-32-32" href="#__codelineno-32-32"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-32-33" name="__codelineno-32-33" href="#__codelineno-32-33"></a><span class="p">}</span>
<a id="__codelineno-32-34" name="__codelineno-32-34" href="#__codelineno-32-34"></a>
<a id="__codelineno-32-35" name="__codelineno-32-35" href="#__codelineno-32-35"></a><span class="kt">void</span><span class="w"> </span><span class="nf">Sim3Solver::ComputeSim3</span><span class="p">(</span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="o">&amp;</span><span class="n">P1</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="o">&amp;</span><span class="n">P2</span><span class="p">)</span>
<a id="__codelineno-32-36" name="__codelineno-32-36" href="#__codelineno-32-36"></a><span class="p">{</span>
<a id="__codelineno-32-37" name="__codelineno-32-37" href="#__codelineno-32-37"></a><span class="w">    </span><span class="c1">// Custom implementation of:</span>
<a id="__codelineno-32-38" name="__codelineno-32-38" href="#__codelineno-32-38"></a><span class="w">    </span><span class="c1">// Horn 1987, Closed-form solution of absolute orientataion using unit quaternions</span>
<a id="__codelineno-32-39" name="__codelineno-32-39" href="#__codelineno-32-39"></a>
<a id="__codelineno-32-40" name="__codelineno-32-40" href="#__codelineno-32-40"></a><span class="w">    </span><span class="c1">// Step 1: Centroid and relative coordinates</span>
<a id="__codelineno-32-41" name="__codelineno-32-41" href="#__codelineno-32-41"></a>
<a id="__codelineno-32-42" name="__codelineno-32-42" href="#__codelineno-32-42"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">Pr1</span><span class="p">(</span><span class="n">P1</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span><span class="n">P1</span><span class="p">.</span><span class="n">type</span><span class="p">());</span><span class="w"> </span><span class="c1">// Relative coordinates to centroid (set 1)</span>
<a id="__codelineno-32-43" name="__codelineno-32-43" href="#__codelineno-32-43"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">Pr2</span><span class="p">(</span><span class="n">P2</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span><span class="n">P2</span><span class="p">.</span><span class="n">type</span><span class="p">());</span><span class="w"> </span><span class="c1">// Relative coordinates to centroid (set 2)</span>
<a id="__codelineno-32-44" name="__codelineno-32-44" href="#__codelineno-32-44"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">O1</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">Pr1</span><span class="p">.</span><span class="n">type</span><span class="p">());</span><span class="w"> </span><span class="c1">// Centroid of P1</span>
<a id="__codelineno-32-45" name="__codelineno-32-45" href="#__codelineno-32-45"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">O2</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">Pr2</span><span class="p">.</span><span class="n">type</span><span class="p">());</span><span class="w"> </span><span class="c1">// Centroid of P2</span>
<a id="__codelineno-32-46" name="__codelineno-32-46" href="#__codelineno-32-46"></a>
<a id="__codelineno-32-47" name="__codelineno-32-47" href="#__codelineno-32-47"></a><span class="w">    </span><span class="n">ComputeCentroid</span><span class="p">(</span><span class="n">P1</span><span class="p">,</span><span class="n">Pr1</span><span class="p">,</span><span class="n">O1</span><span class="p">);</span>
<a id="__codelineno-32-48" name="__codelineno-32-48" href="#__codelineno-32-48"></a><span class="w">    </span><span class="n">ComputeCentroid</span><span class="p">(</span><span class="n">P2</span><span class="p">,</span><span class="n">Pr2</span><span class="p">,</span><span class="n">O2</span><span class="p">);</span>
<a id="__codelineno-32-49" name="__codelineno-32-49" href="#__codelineno-32-49"></a>
<a id="__codelineno-32-50" name="__codelineno-32-50" href="#__codelineno-32-50"></a><span class="w">    </span><span class="c1">// Step 2: Compute M matrix</span>
<a id="__codelineno-32-51" name="__codelineno-32-51" href="#__codelineno-32-51"></a>
<a id="__codelineno-32-52" name="__codelineno-32-52" href="#__codelineno-32-52"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pr2</span><span class="o">*</span><span class="n">Pr1</span><span class="p">.</span><span class="n">t</span><span class="p">();</span>
<a id="__codelineno-32-53" name="__codelineno-32-53" href="#__codelineno-32-53"></a>
<a id="__codelineno-32-54" name="__codelineno-32-54" href="#__codelineno-32-54"></a><span class="w">    </span><span class="c1">// Step 3: Compute N matrix</span>
<a id="__codelineno-32-55" name="__codelineno-32-55" href="#__codelineno-32-55"></a>
<a id="__codelineno-32-56" name="__codelineno-32-56" href="#__codelineno-32-56"></a><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">N11</span><span class="p">,</span><span class="w"> </span><span class="n">N12</span><span class="p">,</span><span class="w"> </span><span class="n">N13</span><span class="p">,</span><span class="w"> </span><span class="n">N14</span><span class="p">,</span><span class="w"> </span><span class="n">N22</span><span class="p">,</span><span class="w"> </span><span class="n">N23</span><span class="p">,</span><span class="w"> </span><span class="n">N24</span><span class="p">,</span><span class="w"> </span><span class="n">N33</span><span class="p">,</span><span class="w"> </span><span class="n">N34</span><span class="p">,</span><span class="w"> </span><span class="n">N44</span><span class="p">;</span>
<a id="__codelineno-32-57" name="__codelineno-32-57" href="#__codelineno-32-57"></a>
<a id="__codelineno-32-58" name="__codelineno-32-58" href="#__codelineno-32-58"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">N</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">P1</span><span class="p">.</span><span class="n">type</span><span class="p">());</span>
<a id="__codelineno-32-59" name="__codelineno-32-59" href="#__codelineno-32-59"></a>
<a id="__codelineno-32-60" name="__codelineno-32-60" href="#__codelineno-32-60"></a><span class="w">    </span><span class="n">N11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">M</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">M</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">M</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-32-61" name="__codelineno-32-61" href="#__codelineno-32-61"></a><span class="w">    </span><span class="n">N12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">M</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">M</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-32-62" name="__codelineno-32-62" href="#__codelineno-32-62"></a><span class="w">    </span><span class="n">N13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">M</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="n">M</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-32-63" name="__codelineno-32-63" href="#__codelineno-32-63"></a><span class="w">    </span><span class="n">N14</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">M</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">M</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-32-64" name="__codelineno-32-64" href="#__codelineno-32-64"></a><span class="w">    </span><span class="n">N22</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">M</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="n">M</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">M</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-32-65" name="__codelineno-32-65" href="#__codelineno-32-65"></a><span class="w">    </span><span class="n">N23</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">M</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">M</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-32-66" name="__codelineno-32-66" href="#__codelineno-32-66"></a><span class="w">    </span><span class="n">N24</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">M</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">M</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-32-67" name="__codelineno-32-67" href="#__codelineno-32-67"></a><span class="w">    </span><span class="n">N33</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">M</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">M</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">M</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-32-68" name="__codelineno-32-68" href="#__codelineno-32-68"></a><span class="w">    </span><span class="n">N34</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">M</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">M</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-32-69" name="__codelineno-32-69" href="#__codelineno-32-69"></a><span class="w">    </span><span class="n">N44</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">M</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="n">M</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">M</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-32-70" name="__codelineno-32-70" href="#__codelineno-32-70"></a>
<a id="__codelineno-32-71" name="__codelineno-32-71" href="#__codelineno-32-71"></a><span class="w">    </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">cv</span><span class="o">::</span><span class="n">Mat_</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">N11</span><span class="p">,</span><span class="w"> </span><span class="n">N12</span><span class="p">,</span><span class="w"> </span><span class="n">N13</span><span class="p">,</span><span class="w"> </span><span class="n">N14</span><span class="p">,</span>
<a id="__codelineno-32-72" name="__codelineno-32-72" href="#__codelineno-32-72"></a><span class="w">                                 </span><span class="n">N12</span><span class="p">,</span><span class="w"> </span><span class="n">N22</span><span class="p">,</span><span class="w"> </span><span class="n">N23</span><span class="p">,</span><span class="w"> </span><span class="n">N24</span><span class="p">,</span>
<a id="__codelineno-32-73" name="__codelineno-32-73" href="#__codelineno-32-73"></a><span class="w">                                 </span><span class="n">N13</span><span class="p">,</span><span class="w"> </span><span class="n">N23</span><span class="p">,</span><span class="w"> </span><span class="n">N33</span><span class="p">,</span><span class="w"> </span><span class="n">N34</span><span class="p">,</span>
<a id="__codelineno-32-74" name="__codelineno-32-74" href="#__codelineno-32-74"></a><span class="w">                                 </span><span class="n">N14</span><span class="p">,</span><span class="w"> </span><span class="n">N24</span><span class="p">,</span><span class="w"> </span><span class="n">N34</span><span class="p">,</span><span class="w"> </span><span class="n">N44</span><span class="p">);</span>
<a id="__codelineno-32-75" name="__codelineno-32-75" href="#__codelineno-32-75"></a>
<a id="__codelineno-32-76" name="__codelineno-32-76" href="#__codelineno-32-76"></a>
<a id="__codelineno-32-77" name="__codelineno-32-77" href="#__codelineno-32-77"></a><span class="w">    </span><span class="c1">// Step 4: Eigenvector of the highest eigenvalue</span>
<a id="__codelineno-32-78" name="__codelineno-32-78" href="#__codelineno-32-78"></a>
<a id="__codelineno-32-79" name="__codelineno-32-79" href="#__codelineno-32-79"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">eval</span><span class="p">,</span><span class="w"> </span><span class="n">evec</span><span class="p">;</span>
<a id="__codelineno-32-80" name="__codelineno-32-80" href="#__codelineno-32-80"></a>
<a id="__codelineno-32-81" name="__codelineno-32-81" href="#__codelineno-32-81"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">eigen</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">eval</span><span class="p">,</span><span class="n">evec</span><span class="p">);</span><span class="w"> </span><span class="c1">//evec[0] is the quaternion of the desired rotation</span>
<a id="__codelineno-32-82" name="__codelineno-32-82" href="#__codelineno-32-82"></a>
<a id="__codelineno-32-83" name="__codelineno-32-83" href="#__codelineno-32-83"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">vec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">evec</span><span class="p">.</span><span class="n">type</span><span class="p">());</span>
<a id="__codelineno-32-84" name="__codelineno-32-84" href="#__codelineno-32-84"></a><span class="w">    </span><span class="p">(</span><span class="n">evec</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">colRange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)).</span><span class="n">copyTo</span><span class="p">(</span><span class="n">vec</span><span class="p">);</span><span class="w"> </span><span class="c1">//extract imaginary part of the quaternion (sin*axis)</span>
<a id="__codelineno-32-85" name="__codelineno-32-85" href="#__codelineno-32-85"></a>
<a id="__codelineno-32-86" name="__codelineno-32-86" href="#__codelineno-32-86"></a><span class="w">    </span><span class="c1">// Rotation angle. sin is the norm of the imaginary part, cos is the real part</span>
<a id="__codelineno-32-87" name="__codelineno-32-87" href="#__codelineno-32-87"></a><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">ang</span><span class="o">=</span><span class="n">atan2</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">vec</span><span class="p">),</span><span class="n">evec</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">));</span>
<a id="__codelineno-32-88" name="__codelineno-32-88" href="#__codelineno-32-88"></a>
<a id="__codelineno-32-89" name="__codelineno-32-89" href="#__codelineno-32-89"></a><span class="w">    </span><span class="n">vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">ang</span><span class="o">*</span><span class="n">vec</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">vec</span><span class="p">);</span><span class="w"> </span><span class="c1">//Angle-axis representation. quaternion angle is the half</span>
<a id="__codelineno-32-90" name="__codelineno-32-90" href="#__codelineno-32-90"></a>
<a id="__codelineno-32-91" name="__codelineno-32-91" href="#__codelineno-32-91"></a><span class="w">    </span><span class="n">mR12i</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">P1</span><span class="p">.</span><span class="n">type</span><span class="p">());</span>
<a id="__codelineno-32-92" name="__codelineno-32-92" href="#__codelineno-32-92"></a>
<a id="__codelineno-32-93" name="__codelineno-32-93" href="#__codelineno-32-93"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Rodrigues</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span><span class="n">mR12i</span><span class="p">);</span><span class="w"> </span><span class="c1">// computes the rotation matrix from angle-axis</span>
<a id="__codelineno-32-94" name="__codelineno-32-94" href="#__codelineno-32-94"></a>
<a id="__codelineno-32-95" name="__codelineno-32-95" href="#__codelineno-32-95"></a><span class="w">    </span><span class="c1">// Step 5: Rotate set 2</span>
<a id="__codelineno-32-96" name="__codelineno-32-96" href="#__codelineno-32-96"></a>
<a id="__codelineno-32-97" name="__codelineno-32-97" href="#__codelineno-32-97"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">P3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mR12i</span><span class="o">*</span><span class="n">Pr2</span><span class="p">;</span>
<a id="__codelineno-32-98" name="__codelineno-32-98" href="#__codelineno-32-98"></a>
<a id="__codelineno-32-99" name="__codelineno-32-99" href="#__codelineno-32-99"></a><span class="w">    </span><span class="c1">// Step 6: Scale</span>
<a id="__codelineno-32-100" name="__codelineno-32-100" href="#__codelineno-32-100"></a>
<a id="__codelineno-32-101" name="__codelineno-32-101" href="#__codelineno-32-101"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">mbFixScale</span><span class="p">)</span>
<a id="__codelineno-32-102" name="__codelineno-32-102" href="#__codelineno-32-102"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-32-103" name="__codelineno-32-103" href="#__codelineno-32-103"></a><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">nom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pr1</span><span class="p">.</span><span class="n">dot</span><span class="p">(</span><span class="n">P3</span><span class="p">);</span>
<a id="__codelineno-32-104" name="__codelineno-32-104" href="#__codelineno-32-104"></a><span class="w">        </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">aux_P3</span><span class="p">(</span><span class="n">P3</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span><span class="n">P3</span><span class="p">.</span><span class="n">type</span><span class="p">());</span>
<a id="__codelineno-32-105" name="__codelineno-32-105" href="#__codelineno-32-105"></a><span class="w">        </span><span class="n">aux_P3</span><span class="o">=</span><span class="n">P3</span><span class="p">;</span>
<a id="__codelineno-32-106" name="__codelineno-32-106" href="#__codelineno-32-106"></a><span class="w">        </span><span class="n">cv</span><span class="o">::</span><span class="n">pow</span><span class="p">(</span><span class="n">P3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">aux_P3</span><span class="p">);</span>
<a id="__codelineno-32-107" name="__codelineno-32-107" href="#__codelineno-32-107"></a><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">den</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-32-108" name="__codelineno-32-108" href="#__codelineno-32-108"></a>
<a id="__codelineno-32-109" name="__codelineno-32-109" href="#__codelineno-32-109"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">aux_P3</span><span class="p">.</span><span class="n">rows</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-32-110" name="__codelineno-32-110" href="#__codelineno-32-110"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-32-111" name="__codelineno-32-111" href="#__codelineno-32-111"></a><span class="w">            </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;</span><span class="n">aux_P3</span><span class="p">.</span><span class="n">cols</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-32-112" name="__codelineno-32-112" href="#__codelineno-32-112"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-32-113" name="__codelineno-32-113" href="#__codelineno-32-113"></a><span class="w">                </span><span class="n">den</span><span class="o">+=</span><span class="n">aux_P3</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">);</span>
<a id="__codelineno-32-114" name="__codelineno-32-114" href="#__codelineno-32-114"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-32-115" name="__codelineno-32-115" href="#__codelineno-32-115"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-32-116" name="__codelineno-32-116" href="#__codelineno-32-116"></a>
<a id="__codelineno-32-117" name="__codelineno-32-117" href="#__codelineno-32-117"></a><span class="w">        </span><span class="n">ms12i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nom</span><span class="o">/</span><span class="n">den</span><span class="p">;</span>
<a id="__codelineno-32-118" name="__codelineno-32-118" href="#__codelineno-32-118"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-32-119" name="__codelineno-32-119" href="#__codelineno-32-119"></a><span class="w">    </span><span class="k">else</span>
<a id="__codelineno-32-120" name="__codelineno-32-120" href="#__codelineno-32-120"></a><span class="w">        </span><span class="n">ms12i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">;</span>
<a id="__codelineno-32-121" name="__codelineno-32-121" href="#__codelineno-32-121"></a>
<a id="__codelineno-32-122" name="__codelineno-32-122" href="#__codelineno-32-122"></a><span class="w">    </span><span class="c1">// Step 7: Translation</span>
<a id="__codelineno-32-123" name="__codelineno-32-123" href="#__codelineno-32-123"></a>
<a id="__codelineno-32-124" name="__codelineno-32-124" href="#__codelineno-32-124"></a><span class="w">    </span><span class="n">mt12i</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">P1</span><span class="p">.</span><span class="n">type</span><span class="p">());</span>
<a id="__codelineno-32-125" name="__codelineno-32-125" href="#__codelineno-32-125"></a><span class="w">    </span><span class="n">mt12i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">O1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ms12i</span><span class="o">*</span><span class="n">mR12i</span><span class="o">*</span><span class="n">O2</span><span class="p">;</span>
<a id="__codelineno-32-126" name="__codelineno-32-126" href="#__codelineno-32-126"></a>
<a id="__codelineno-32-127" name="__codelineno-32-127" href="#__codelineno-32-127"></a><span class="w">    </span><span class="c1">// Step 8: Transformation</span>
<a id="__codelineno-32-128" name="__codelineno-32-128" href="#__codelineno-32-128"></a>
<a id="__codelineno-32-129" name="__codelineno-32-129" href="#__codelineno-32-129"></a><span class="w">    </span><span class="c1">// Step 8.1 T12</span>
<a id="__codelineno-32-130" name="__codelineno-32-130" href="#__codelineno-32-130"></a><span class="w">    </span><span class="n">mT12i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">::</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">P1</span><span class="p">.</span><span class="n">type</span><span class="p">());</span>
<a id="__codelineno-32-131" name="__codelineno-32-131" href="#__codelineno-32-131"></a>
<a id="__codelineno-32-132" name="__codelineno-32-132" href="#__codelineno-32-132"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">sR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ms12i</span><span class="o">*</span><span class="n">mR12i</span><span class="p">;</span>
<a id="__codelineno-32-133" name="__codelineno-32-133" href="#__codelineno-32-133"></a>
<a id="__codelineno-32-134" name="__codelineno-32-134" href="#__codelineno-32-134"></a><span class="w">    </span><span class="n">sR</span><span class="p">.</span><span class="n">copyTo</span><span class="p">(</span><span class="n">mT12i</span><span class="p">.</span><span class="n">rowRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">).</span><span class="n">colRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">));</span>
<a id="__codelineno-32-135" name="__codelineno-32-135" href="#__codelineno-32-135"></a><span class="w">    </span><span class="n">mt12i</span><span class="p">.</span><span class="n">copyTo</span><span class="p">(</span><span class="n">mT12i</span><span class="p">.</span><span class="n">rowRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">).</span><span class="n">col</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
<a id="__codelineno-32-136" name="__codelineno-32-136" href="#__codelineno-32-136"></a>
<a id="__codelineno-32-137" name="__codelineno-32-137" href="#__codelineno-32-137"></a><span class="w">    </span><span class="c1">// Step 8.2 T21</span>
<a id="__codelineno-32-138" name="__codelineno-32-138" href="#__codelineno-32-138"></a>
<a id="__codelineno-32-139" name="__codelineno-32-139" href="#__codelineno-32-139"></a><span class="w">    </span><span class="n">mT21i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">::</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">P1</span><span class="p">.</span><span class="n">type</span><span class="p">());</span>
<a id="__codelineno-32-140" name="__codelineno-32-140" href="#__codelineno-32-140"></a>
<a id="__codelineno-32-141" name="__codelineno-32-141" href="#__codelineno-32-141"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">sRinv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">ms12i</span><span class="p">)</span><span class="o">*</span><span class="n">mR12i</span><span class="p">.</span><span class="n">t</span><span class="p">();</span>
<a id="__codelineno-32-142" name="__codelineno-32-142" href="#__codelineno-32-142"></a>
<a id="__codelineno-32-143" name="__codelineno-32-143" href="#__codelineno-32-143"></a><span class="w">    </span><span class="n">sRinv</span><span class="p">.</span><span class="n">copyTo</span><span class="p">(</span><span class="n">mT21i</span><span class="p">.</span><span class="n">rowRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">).</span><span class="n">colRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">));</span>
<a id="__codelineno-32-144" name="__codelineno-32-144" href="#__codelineno-32-144"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">tinv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">sRinv</span><span class="o">*</span><span class="n">mt12i</span><span class="p">;</span>
<a id="__codelineno-32-145" name="__codelineno-32-145" href="#__codelineno-32-145"></a><span class="w">    </span><span class="n">tinv</span><span class="p">.</span><span class="n">copyTo</span><span class="p">(</span><span class="n">mT21i</span><span class="p">.</span><span class="n">rowRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">).</span><span class="n">col</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
<a id="__codelineno-32-146" name="__codelineno-32-146" href="#__codelineno-32-146"></a><span class="p">}</span>
</code></pre></div></p>
<p><code>Optimizer::OptimizeSim3(...)</code> optimizes the transform <span class="arithmatex">\(Sim(3)\)</span> <code>g2o::Sim3 &amp;g2oS12</code> between two keyframes <code>KeyFrame *pKF1</code> and <code>KeyFrame *pKF2</code> given the matching point observations <code>vector&lt;MapPoint *&gt; &amp;vpMatches1</code>.</p>
<p>G2O has builtin <code>g2o::VertexSim3Expmap * vSim3</code> that takes care of the transform <span class="arithmatex">\(SE(3)\)</span> plus a scaling <span class="arithmatex">\(s\)</span>, and it is added to optimizer <code>optimizer.addVertex(vSim3);</code>.
Two corresponding map points added to vertices: <code>vPoint1</code> init estimated by <code>cv::Mat P3D1c = R1w*P3D1w + t1w;</code> and <code>vPoint2</code> init estimated by <code>cv::Mat P3D2c = R2w*P3D2w + t2w;</code>, and they are set to fixed.</p>
<p>There are two edges/errors <code>g2o::EdgeSim3ProjectXYZ</code> defined per two corresponding map points: the <code>g2oS12</code> with <code>vPoint1</code>, and <code>g2oS12</code> with <code>vPoint2</code>. 
Each egde residual is of <code>Vector2d</code>.</p>
<p>The inliner checking is done via Chi-squared test <code>if(e12-&gt;chi2()&gt;th2 || e21-&gt;chi2()&gt;th2)</code>, where <code>th2=10</code> as implemented in <code>LoopClosing::ComputeSim3()</code> to remove about some <span class="arithmatex">\(0.5\%\)</span> outlier edges (for <span class="arithmatex">\(2\)</span>-d Chi-squared distribution <span class="arithmatex">\(\mathcal{X}^2_{1\%}=9.21\)</span> and <span class="arithmatex">\(\mathcal{X}^2_{0,5\%}=10.597\)</span>).</p>
<p>After having removed outliers, optimization is performed again to derive <span class="arithmatex">\(Sim(3)\)</span> stored in <code>g2oS12</code>. </p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">Optimizer::OptimizeSim3</span><span class="p">(</span><span class="n">KeyFrame</span><span class="w"> </span><span class="o">*</span><span class="n">pKF1</span><span class="p">,</span><span class="w"> </span><span class="n">KeyFrame</span><span class="w"> </span><span class="o">*</span><span class="n">pKF2</span><span class="p">,</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vpMatches1</span><span class="p">,</span><span class="w"> </span><span class="n">g2o</span><span class="o">::</span><span class="n">Sim3</span><span class="w"> </span><span class="o">&amp;</span><span class="n">g2oS12</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">th2</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">bFixScale</span><span class="p">)</span>
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="p">{</span>
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="w">    </span><span class="n">g2o</span><span class="o">::</span><span class="n">SparseOptimizer</span><span class="w"> </span><span class="n">optimizer</span><span class="p">;</span>
<a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="w">    </span><span class="n">g2o</span><span class="o">::</span><span class="n">BlockSolverX</span><span class="o">::</span><span class="n">LinearSolverType</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">linearSolver</span><span class="p">;</span>
<a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a>
<a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a><span class="w">    </span><span class="n">linearSolver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">g2o</span><span class="o">::</span><span class="n">LinearSolverDense</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">BlockSolverX</span><span class="o">::</span><span class="n">PoseMatrixType</span><span class="o">&gt;</span><span class="p">();</span>
<a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a>
<a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a><span class="w">    </span><span class="n">g2o</span><span class="o">::</span><span class="n">BlockSolverX</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">solver_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">g2o</span><span class="o">::</span><span class="n">BlockSolverX</span><span class="p">(</span><span class="n">linearSolver</span><span class="p">);</span>
<a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a>
<a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a><span class="w">    </span><span class="n">g2o</span><span class="o">::</span><span class="n">OptimizationAlgorithmLevenberg</span><span class="o">*</span><span class="w"> </span><span class="n">solver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">g2o</span><span class="o">::</span><span class="n">OptimizationAlgorithmLevenberg</span><span class="p">(</span><span class="n">solver_ptr</span><span class="p">);</span>
<a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a><span class="w">    </span><span class="n">optimizer</span><span class="p">.</span><span class="n">setAlgorithm</span><span class="p">(</span><span class="n">solver</span><span class="p">);</span>
<a id="__codelineno-33-12" name="__codelineno-33-12" href="#__codelineno-33-12"></a>
<a id="__codelineno-33-13" name="__codelineno-33-13" href="#__codelineno-33-13"></a><span class="w">    </span><span class="c1">// Calibration</span>
<a id="__codelineno-33-14" name="__codelineno-33-14" href="#__codelineno-33-14"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="o">&amp;</span><span class="n">K1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF1</span><span class="o">-&gt;</span><span class="n">mK</span><span class="p">;</span>
<a id="__codelineno-33-15" name="__codelineno-33-15" href="#__codelineno-33-15"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="o">&amp;</span><span class="n">K2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF2</span><span class="o">-&gt;</span><span class="n">mK</span><span class="p">;</span>
<a id="__codelineno-33-16" name="__codelineno-33-16" href="#__codelineno-33-16"></a>
<a id="__codelineno-33-17" name="__codelineno-33-17" href="#__codelineno-33-17"></a><span class="w">    </span><span class="c1">// Camera poses</span>
<a id="__codelineno-33-18" name="__codelineno-33-18" href="#__codelineno-33-18"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">R1w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF1</span><span class="o">-&gt;</span><span class="n">GetRotation</span><span class="p">();</span>
<a id="__codelineno-33-19" name="__codelineno-33-19" href="#__codelineno-33-19"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">t1w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF1</span><span class="o">-&gt;</span><span class="n">GetTranslation</span><span class="p">();</span>
<a id="__codelineno-33-20" name="__codelineno-33-20" href="#__codelineno-33-20"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">R2w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF2</span><span class="o">-&gt;</span><span class="n">GetRotation</span><span class="p">();</span>
<a id="__codelineno-33-21" name="__codelineno-33-21" href="#__codelineno-33-21"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">t2w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF2</span><span class="o">-&gt;</span><span class="n">GetTranslation</span><span class="p">();</span>
<a id="__codelineno-33-22" name="__codelineno-33-22" href="#__codelineno-33-22"></a>
<a id="__codelineno-33-23" name="__codelineno-33-23" href="#__codelineno-33-23"></a><span class="w">    </span><span class="c1">// Set Sim3 vertex</span>
<a id="__codelineno-33-24" name="__codelineno-33-24" href="#__codelineno-33-24"></a><span class="w">    </span><span class="n">g2o</span><span class="o">::</span><span class="n">VertexSim3Expmap</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">vSim3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">g2o</span><span class="o">::</span><span class="n">VertexSim3Expmap</span><span class="p">();</span><span class="w">    </span>
<a id="__codelineno-33-25" name="__codelineno-33-25" href="#__codelineno-33-25"></a><span class="w">    </span><span class="n">vSim3</span><span class="o">-&gt;</span><span class="n">_fix_scale</span><span class="o">=</span><span class="n">bFixScale</span><span class="p">;</span>
<a id="__codelineno-33-26" name="__codelineno-33-26" href="#__codelineno-33-26"></a><span class="w">    </span><span class="n">vSim3</span><span class="o">-&gt;</span><span class="n">setEstimate</span><span class="p">(</span><span class="n">g2oS12</span><span class="p">);</span>
<a id="__codelineno-33-27" name="__codelineno-33-27" href="#__codelineno-33-27"></a><span class="w">    </span><span class="n">vSim3</span><span class="o">-&gt;</span><span class="n">setId</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-33-28" name="__codelineno-33-28" href="#__codelineno-33-28"></a><span class="w">    </span><span class="n">vSim3</span><span class="o">-&gt;</span><span class="n">setFixed</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
<a id="__codelineno-33-29" name="__codelineno-33-29" href="#__codelineno-33-29"></a><span class="w">    </span><span class="n">vSim3</span><span class="o">-&gt;</span><span class="n">_principle_point1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">K1</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-33-30" name="__codelineno-33-30" href="#__codelineno-33-30"></a><span class="w">    </span><span class="n">vSim3</span><span class="o">-&gt;</span><span class="n">_principle_point1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">K1</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-33-31" name="__codelineno-33-31" href="#__codelineno-33-31"></a><span class="w">    </span><span class="n">vSim3</span><span class="o">-&gt;</span><span class="n">_focal_length1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">K1</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-33-32" name="__codelineno-33-32" href="#__codelineno-33-32"></a><span class="w">    </span><span class="n">vSim3</span><span class="o">-&gt;</span><span class="n">_focal_length1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">K1</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-33-33" name="__codelineno-33-33" href="#__codelineno-33-33"></a><span class="w">    </span><span class="n">vSim3</span><span class="o">-&gt;</span><span class="n">_principle_point2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">K2</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-33-34" name="__codelineno-33-34" href="#__codelineno-33-34"></a><span class="w">    </span><span class="n">vSim3</span><span class="o">-&gt;</span><span class="n">_principle_point2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">K2</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-33-35" name="__codelineno-33-35" href="#__codelineno-33-35"></a><span class="w">    </span><span class="n">vSim3</span><span class="o">-&gt;</span><span class="n">_focal_length2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">K2</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-33-36" name="__codelineno-33-36" href="#__codelineno-33-36"></a><span class="w">    </span><span class="n">vSim3</span><span class="o">-&gt;</span><span class="n">_focal_length2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">K2</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-33-37" name="__codelineno-33-37" href="#__codelineno-33-37"></a><span class="w">    </span><span class="n">optimizer</span><span class="p">.</span><span class="n">addVertex</span><span class="p">(</span><span class="n">vSim3</span><span class="p">);</span>
<a id="__codelineno-33-38" name="__codelineno-33-38" href="#__codelineno-33-38"></a>
<a id="__codelineno-33-39" name="__codelineno-33-39" href="#__codelineno-33-39"></a><span class="w">    </span><span class="c1">// Set MapPoint vertices</span>
<a id="__codelineno-33-40" name="__codelineno-33-40" href="#__codelineno-33-40"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vpMatches1</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<a id="__codelineno-33-41" name="__codelineno-33-41" href="#__codelineno-33-41"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">vpMapPoints1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF1</span><span class="o">-&gt;</span><span class="n">GetMapPointMatches</span><span class="p">();</span>
<a id="__codelineno-33-42" name="__codelineno-33-42" href="#__codelineno-33-42"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">EdgeSim3ProjectXYZ</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">vpEdges12</span><span class="p">;</span>
<a id="__codelineno-33-43" name="__codelineno-33-43" href="#__codelineno-33-43"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">EdgeInverseSim3ProjectXYZ</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">vpEdges21</span><span class="p">;</span>
<a id="__codelineno-33-44" name="__codelineno-33-44" href="#__codelineno-33-44"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vnIndexEdge</span><span class="p">;</span>
<a id="__codelineno-33-45" name="__codelineno-33-45" href="#__codelineno-33-45"></a>
<a id="__codelineno-33-46" name="__codelineno-33-46" href="#__codelineno-33-46"></a><span class="w">    </span><span class="n">vnIndexEdge</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="p">);</span>
<a id="__codelineno-33-47" name="__codelineno-33-47" href="#__codelineno-33-47"></a><span class="w">    </span><span class="n">vpEdges12</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="p">);</span>
<a id="__codelineno-33-48" name="__codelineno-33-48" href="#__codelineno-33-48"></a><span class="w">    </span><span class="n">vpEdges21</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="p">);</span>
<a id="__codelineno-33-49" name="__codelineno-33-49" href="#__codelineno-33-49"></a>
<a id="__codelineno-33-50" name="__codelineno-33-50" href="#__codelineno-33-50"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">deltaHuber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">th2</span><span class="p">);</span>
<a id="__codelineno-33-51" name="__codelineno-33-51" href="#__codelineno-33-51"></a>
<a id="__codelineno-33-52" name="__codelineno-33-52" href="#__codelineno-33-52"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nCorrespondences</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-33-53" name="__codelineno-33-53" href="#__codelineno-33-53"></a>
<a id="__codelineno-33-54" name="__codelineno-33-54" href="#__codelineno-33-54"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-33-55" name="__codelineno-33-55" href="#__codelineno-33-55"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-33-56" name="__codelineno-33-56" href="#__codelineno-33-56"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">vpMatches1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<a id="__codelineno-33-57" name="__codelineno-33-57" href="#__codelineno-33-57"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-33-58" name="__codelineno-33-58" href="#__codelineno-33-58"></a>
<a id="__codelineno-33-59" name="__codelineno-33-59" href="#__codelineno-33-59"></a><span class="w">        </span><span class="n">MapPoint</span><span class="o">*</span><span class="w"> </span><span class="n">pMP1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vpMapPoints1</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-33-60" name="__codelineno-33-60" href="#__codelineno-33-60"></a><span class="w">        </span><span class="n">MapPoint</span><span class="o">*</span><span class="w"> </span><span class="n">pMP2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vpMatches1</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-33-61" name="__codelineno-33-61" href="#__codelineno-33-61"></a>
<a id="__codelineno-33-62" name="__codelineno-33-62" href="#__codelineno-33-62"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">id1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-33-63" name="__codelineno-33-63" href="#__codelineno-33-63"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">id2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-33-64" name="__codelineno-33-64" href="#__codelineno-33-64"></a>
<a id="__codelineno-33-65" name="__codelineno-33-65" href="#__codelineno-33-65"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pMP2</span><span class="o">-&gt;</span><span class="n">GetIndexInKeyFrame</span><span class="p">(</span><span class="n">pKF2</span><span class="p">);</span>
<a id="__codelineno-33-66" name="__codelineno-33-66" href="#__codelineno-33-66"></a>
<a id="__codelineno-33-67" name="__codelineno-33-67" href="#__codelineno-33-67"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">pMP1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">pMP2</span><span class="p">)</span>
<a id="__codelineno-33-68" name="__codelineno-33-68" href="#__codelineno-33-68"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-33-69" name="__codelineno-33-69" href="#__codelineno-33-69"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">pMP1</span><span class="o">-&gt;</span><span class="n">isBad</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">pMP2</span><span class="o">-&gt;</span><span class="n">isBad</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">i2</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-33-70" name="__codelineno-33-70" href="#__codelineno-33-70"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-33-71" name="__codelineno-33-71" href="#__codelineno-33-71"></a><span class="w">                </span><span class="n">g2o</span><span class="o">::</span><span class="n">VertexSBAPointXYZ</span><span class="o">*</span><span class="w"> </span><span class="n">vPoint1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">g2o</span><span class="o">::</span><span class="n">VertexSBAPointXYZ</span><span class="p">();</span>
<a id="__codelineno-33-72" name="__codelineno-33-72" href="#__codelineno-33-72"></a><span class="w">                </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">P3D1w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pMP1</span><span class="o">-&gt;</span><span class="n">GetWorldPos</span><span class="p">();</span>
<a id="__codelineno-33-73" name="__codelineno-33-73" href="#__codelineno-33-73"></a><span class="w">                </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">P3D1c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">R1w</span><span class="o">*</span><span class="n">P3D1w</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">t1w</span><span class="p">;</span>
<a id="__codelineno-33-74" name="__codelineno-33-74" href="#__codelineno-33-74"></a><span class="w">                </span><span class="n">vPoint1</span><span class="o">-&gt;</span><span class="n">setEstimate</span><span class="p">(</span><span class="n">Converter</span><span class="o">::</span><span class="n">toVector3d</span><span class="p">(</span><span class="n">P3D1c</span><span class="p">));</span>
<a id="__codelineno-33-75" name="__codelineno-33-75" href="#__codelineno-33-75"></a><span class="w">                </span><span class="n">vPoint1</span><span class="o">-&gt;</span><span class="n">setId</span><span class="p">(</span><span class="n">id1</span><span class="p">);</span>
<a id="__codelineno-33-76" name="__codelineno-33-76" href="#__codelineno-33-76"></a><span class="w">                </span><span class="n">vPoint1</span><span class="o">-&gt;</span><span class="n">setFixed</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<a id="__codelineno-33-77" name="__codelineno-33-77" href="#__codelineno-33-77"></a><span class="w">                </span><span class="n">optimizer</span><span class="p">.</span><span class="n">addVertex</span><span class="p">(</span><span class="n">vPoint1</span><span class="p">);</span>
<a id="__codelineno-33-78" name="__codelineno-33-78" href="#__codelineno-33-78"></a>
<a id="__codelineno-33-79" name="__codelineno-33-79" href="#__codelineno-33-79"></a><span class="w">                </span><span class="n">g2o</span><span class="o">::</span><span class="n">VertexSBAPointXYZ</span><span class="o">*</span><span class="w"> </span><span class="n">vPoint2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">g2o</span><span class="o">::</span><span class="n">VertexSBAPointXYZ</span><span class="p">();</span>
<a id="__codelineno-33-80" name="__codelineno-33-80" href="#__codelineno-33-80"></a><span class="w">                </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">P3D2w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pMP2</span><span class="o">-&gt;</span><span class="n">GetWorldPos</span><span class="p">();</span>
<a id="__codelineno-33-81" name="__codelineno-33-81" href="#__codelineno-33-81"></a><span class="w">                </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">P3D2c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">R2w</span><span class="o">*</span><span class="n">P3D2w</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">t2w</span><span class="p">;</span>
<a id="__codelineno-33-82" name="__codelineno-33-82" href="#__codelineno-33-82"></a><span class="w">                </span><span class="n">vPoint2</span><span class="o">-&gt;</span><span class="n">setEstimate</span><span class="p">(</span><span class="n">Converter</span><span class="o">::</span><span class="n">toVector3d</span><span class="p">(</span><span class="n">P3D2c</span><span class="p">));</span>
<a id="__codelineno-33-83" name="__codelineno-33-83" href="#__codelineno-33-83"></a><span class="w">                </span><span class="n">vPoint2</span><span class="o">-&gt;</span><span class="n">setId</span><span class="p">(</span><span class="n">id2</span><span class="p">);</span>
<a id="__codelineno-33-84" name="__codelineno-33-84" href="#__codelineno-33-84"></a><span class="w">                </span><span class="n">vPoint2</span><span class="o">-&gt;</span><span class="n">setFixed</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<a id="__codelineno-33-85" name="__codelineno-33-85" href="#__codelineno-33-85"></a><span class="w">                </span><span class="n">optimizer</span><span class="p">.</span><span class="n">addVertex</span><span class="p">(</span><span class="n">vPoint2</span><span class="p">);</span>
<a id="__codelineno-33-86" name="__codelineno-33-86" href="#__codelineno-33-86"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-33-87" name="__codelineno-33-87" href="#__codelineno-33-87"></a><span class="w">            </span><span class="k">else</span>
<a id="__codelineno-33-88" name="__codelineno-33-88" href="#__codelineno-33-88"></a><span class="w">                </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-33-89" name="__codelineno-33-89" href="#__codelineno-33-89"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-33-90" name="__codelineno-33-90" href="#__codelineno-33-90"></a><span class="w">        </span><span class="k">else</span>
<a id="__codelineno-33-91" name="__codelineno-33-91" href="#__codelineno-33-91"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-33-92" name="__codelineno-33-92" href="#__codelineno-33-92"></a>
<a id="__codelineno-33-93" name="__codelineno-33-93" href="#__codelineno-33-93"></a><span class="w">        </span><span class="n">nCorrespondences</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-33-94" name="__codelineno-33-94" href="#__codelineno-33-94"></a>
<a id="__codelineno-33-95" name="__codelineno-33-95" href="#__codelineno-33-95"></a><span class="w">        </span><span class="c1">// Set edge x1 = S12*X2</span>
<a id="__codelineno-33-96" name="__codelineno-33-96" href="#__codelineno-33-96"></a><span class="w">        </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">obs1</span><span class="p">;</span>
<a id="__codelineno-33-97" name="__codelineno-33-97" href="#__codelineno-33-97"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">KeyPoint</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kpUn1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF1</span><span class="o">-&gt;</span><span class="n">mvKeysUn</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-33-98" name="__codelineno-33-98" href="#__codelineno-33-98"></a><span class="w">        </span><span class="n">obs1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">kpUn1</span><span class="p">.</span><span class="n">pt</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">kpUn1</span><span class="p">.</span><span class="n">pt</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<a id="__codelineno-33-99" name="__codelineno-33-99" href="#__codelineno-33-99"></a>
<a id="__codelineno-33-100" name="__codelineno-33-100" href="#__codelineno-33-100"></a><span class="w">        </span><span class="n">g2o</span><span class="o">::</span><span class="n">EdgeSim3ProjectXYZ</span><span class="o">*</span><span class="w"> </span><span class="n">e12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">g2o</span><span class="o">::</span><span class="n">EdgeSim3ProjectXYZ</span><span class="p">();</span>
<a id="__codelineno-33-101" name="__codelineno-33-101" href="#__codelineno-33-101"></a><span class="w">        </span><span class="n">e12</span><span class="o">-&gt;</span><span class="n">setVertex</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">OptimizableGraph</span><span class="o">::</span><span class="n">Vertex</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">optimizer</span><span class="p">.</span><span class="n">vertex</span><span class="p">(</span><span class="n">id2</span><span class="p">)));</span>
<a id="__codelineno-33-102" name="__codelineno-33-102" href="#__codelineno-33-102"></a><span class="w">        </span><span class="n">e12</span><span class="o">-&gt;</span><span class="n">setVertex</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">OptimizableGraph</span><span class="o">::</span><span class="n">Vertex</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">optimizer</span><span class="p">.</span><span class="n">vertex</span><span class="p">(</span><span class="mi">0</span><span class="p">)));</span>
<a id="__codelineno-33-103" name="__codelineno-33-103" href="#__codelineno-33-103"></a><span class="w">        </span><span class="n">e12</span><span class="o">-&gt;</span><span class="n">setMeasurement</span><span class="p">(</span><span class="n">obs1</span><span class="p">);</span>
<a id="__codelineno-33-104" name="__codelineno-33-104" href="#__codelineno-33-104"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">&amp;</span><span class="n">invSigmaSquare1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF1</span><span class="o">-&gt;</span><span class="n">mvInvLevelSigma2</span><span class="p">[</span><span class="n">kpUn1</span><span class="p">.</span><span class="n">octave</span><span class="p">];</span>
<a id="__codelineno-33-105" name="__codelineno-33-105" href="#__codelineno-33-105"></a><span class="w">        </span><span class="n">e12</span><span class="o">-&gt;</span><span class="n">setInformation</span><span class="p">(</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix2d</span><span class="o">::</span><span class="n">Identity</span><span class="p">()</span><span class="o">*</span><span class="n">invSigmaSquare1</span><span class="p">);</span>
<a id="__codelineno-33-106" name="__codelineno-33-106" href="#__codelineno-33-106"></a>
<a id="__codelineno-33-107" name="__codelineno-33-107" href="#__codelineno-33-107"></a><span class="w">        </span><span class="n">g2o</span><span class="o">::</span><span class="n">RobustKernelHuber</span><span class="o">*</span><span class="w"> </span><span class="n">rk1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">g2o</span><span class="o">::</span><span class="n">RobustKernelHuber</span><span class="p">;</span>
<a id="__codelineno-33-108" name="__codelineno-33-108" href="#__codelineno-33-108"></a><span class="w">        </span><span class="n">e12</span><span class="o">-&gt;</span><span class="n">setRobustKernel</span><span class="p">(</span><span class="n">rk1</span><span class="p">);</span>
<a id="__codelineno-33-109" name="__codelineno-33-109" href="#__codelineno-33-109"></a><span class="w">        </span><span class="n">rk1</span><span class="o">-&gt;</span><span class="n">setDelta</span><span class="p">(</span><span class="n">deltaHuber</span><span class="p">);</span>
<a id="__codelineno-33-110" name="__codelineno-33-110" href="#__codelineno-33-110"></a><span class="w">        </span><span class="n">optimizer</span><span class="p">.</span><span class="n">addEdge</span><span class="p">(</span><span class="n">e12</span><span class="p">);</span>
<a id="__codelineno-33-111" name="__codelineno-33-111" href="#__codelineno-33-111"></a>
<a id="__codelineno-33-112" name="__codelineno-33-112" href="#__codelineno-33-112"></a><span class="w">        </span><span class="c1">// Set edge x2 = S21*X1</span>
<a id="__codelineno-33-113" name="__codelineno-33-113" href="#__codelineno-33-113"></a><span class="w">        </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">obs2</span><span class="p">;</span>
<a id="__codelineno-33-114" name="__codelineno-33-114" href="#__codelineno-33-114"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">KeyPoint</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kpUn2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF2</span><span class="o">-&gt;</span><span class="n">mvKeysUn</span><span class="p">[</span><span class="n">i2</span><span class="p">];</span>
<a id="__codelineno-33-115" name="__codelineno-33-115" href="#__codelineno-33-115"></a><span class="w">        </span><span class="n">obs2</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">kpUn2</span><span class="p">.</span><span class="n">pt</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">kpUn2</span><span class="p">.</span><span class="n">pt</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<a id="__codelineno-33-116" name="__codelineno-33-116" href="#__codelineno-33-116"></a>
<a id="__codelineno-33-117" name="__codelineno-33-117" href="#__codelineno-33-117"></a><span class="w">        </span><span class="n">g2o</span><span class="o">::</span><span class="n">EdgeInverseSim3ProjectXYZ</span><span class="o">*</span><span class="w"> </span><span class="n">e21</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">g2o</span><span class="o">::</span><span class="n">EdgeInverseSim3ProjectXYZ</span><span class="p">();</span>
<a id="__codelineno-33-118" name="__codelineno-33-118" href="#__codelineno-33-118"></a>
<a id="__codelineno-33-119" name="__codelineno-33-119" href="#__codelineno-33-119"></a><span class="w">        </span><span class="n">e21</span><span class="o">-&gt;</span><span class="n">setVertex</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">OptimizableGraph</span><span class="o">::</span><span class="n">Vertex</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">optimizer</span><span class="p">.</span><span class="n">vertex</span><span class="p">(</span><span class="n">id1</span><span class="p">)));</span>
<a id="__codelineno-33-120" name="__codelineno-33-120" href="#__codelineno-33-120"></a><span class="w">        </span><span class="n">e21</span><span class="o">-&gt;</span><span class="n">setVertex</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">OptimizableGraph</span><span class="o">::</span><span class="n">Vertex</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">optimizer</span><span class="p">.</span><span class="n">vertex</span><span class="p">(</span><span class="mi">0</span><span class="p">)));</span>
<a id="__codelineno-33-121" name="__codelineno-33-121" href="#__codelineno-33-121"></a><span class="w">        </span><span class="n">e21</span><span class="o">-&gt;</span><span class="n">setMeasurement</span><span class="p">(</span><span class="n">obs2</span><span class="p">);</span>
<a id="__codelineno-33-122" name="__codelineno-33-122" href="#__codelineno-33-122"></a><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">invSigmaSquare2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF2</span><span class="o">-&gt;</span><span class="n">mvInvLevelSigma2</span><span class="p">[</span><span class="n">kpUn2</span><span class="p">.</span><span class="n">octave</span><span class="p">];</span>
<a id="__codelineno-33-123" name="__codelineno-33-123" href="#__codelineno-33-123"></a><span class="w">        </span><span class="n">e21</span><span class="o">-&gt;</span><span class="n">setInformation</span><span class="p">(</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix2d</span><span class="o">::</span><span class="n">Identity</span><span class="p">()</span><span class="o">*</span><span class="n">invSigmaSquare2</span><span class="p">);</span>
<a id="__codelineno-33-124" name="__codelineno-33-124" href="#__codelineno-33-124"></a>
<a id="__codelineno-33-125" name="__codelineno-33-125" href="#__codelineno-33-125"></a><span class="w">        </span><span class="n">g2o</span><span class="o">::</span><span class="n">RobustKernelHuber</span><span class="o">*</span><span class="w"> </span><span class="n">rk2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">g2o</span><span class="o">::</span><span class="n">RobustKernelHuber</span><span class="p">;</span>
<a id="__codelineno-33-126" name="__codelineno-33-126" href="#__codelineno-33-126"></a><span class="w">        </span><span class="n">e21</span><span class="o">-&gt;</span><span class="n">setRobustKernel</span><span class="p">(</span><span class="n">rk2</span><span class="p">);</span>
<a id="__codelineno-33-127" name="__codelineno-33-127" href="#__codelineno-33-127"></a><span class="w">        </span><span class="n">rk2</span><span class="o">-&gt;</span><span class="n">setDelta</span><span class="p">(</span><span class="n">deltaHuber</span><span class="p">);</span>
<a id="__codelineno-33-128" name="__codelineno-33-128" href="#__codelineno-33-128"></a><span class="w">        </span><span class="n">optimizer</span><span class="p">.</span><span class="n">addEdge</span><span class="p">(</span><span class="n">e21</span><span class="p">);</span>
<a id="__codelineno-33-129" name="__codelineno-33-129" href="#__codelineno-33-129"></a>
<a id="__codelineno-33-130" name="__codelineno-33-130" href="#__codelineno-33-130"></a><span class="w">        </span><span class="n">vpEdges12</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">e12</span><span class="p">);</span>
<a id="__codelineno-33-131" name="__codelineno-33-131" href="#__codelineno-33-131"></a><span class="w">        </span><span class="n">vpEdges21</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">e21</span><span class="p">);</span>
<a id="__codelineno-33-132" name="__codelineno-33-132" href="#__codelineno-33-132"></a><span class="w">        </span><span class="n">vnIndexEdge</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<a id="__codelineno-33-133" name="__codelineno-33-133" href="#__codelineno-33-133"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-33-134" name="__codelineno-33-134" href="#__codelineno-33-134"></a>
<a id="__codelineno-33-135" name="__codelineno-33-135" href="#__codelineno-33-135"></a><span class="w">    </span><span class="c1">// Optimize!</span>
<a id="__codelineno-33-136" name="__codelineno-33-136" href="#__codelineno-33-136"></a><span class="w">    </span><span class="n">optimizer</span><span class="p">.</span><span class="n">initializeOptimization</span><span class="p">();</span>
<a id="__codelineno-33-137" name="__codelineno-33-137" href="#__codelineno-33-137"></a><span class="w">    </span><span class="n">optimizer</span><span class="p">.</span><span class="n">optimize</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<a id="__codelineno-33-138" name="__codelineno-33-138" href="#__codelineno-33-138"></a>
<a id="__codelineno-33-139" name="__codelineno-33-139" href="#__codelineno-33-139"></a><span class="w">    </span><span class="c1">// Check inliers</span>
<a id="__codelineno-33-140" name="__codelineno-33-140" href="#__codelineno-33-140"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nBad</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-33-141" name="__codelineno-33-141" href="#__codelineno-33-141"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">vpEdges12</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-33-142" name="__codelineno-33-142" href="#__codelineno-33-142"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-33-143" name="__codelineno-33-143" href="#__codelineno-33-143"></a><span class="w">        </span><span class="n">g2o</span><span class="o">::</span><span class="n">EdgeSim3ProjectXYZ</span><span class="o">*</span><span class="w"> </span><span class="n">e12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vpEdges12</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-33-144" name="__codelineno-33-144" href="#__codelineno-33-144"></a><span class="w">        </span><span class="n">g2o</span><span class="o">::</span><span class="n">EdgeInverseSim3ProjectXYZ</span><span class="o">*</span><span class="w"> </span><span class="n">e21</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vpEdges21</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-33-145" name="__codelineno-33-145" href="#__codelineno-33-145"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">e12</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">e21</span><span class="p">)</span>
<a id="__codelineno-33-146" name="__codelineno-33-146" href="#__codelineno-33-146"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-33-147" name="__codelineno-33-147" href="#__codelineno-33-147"></a>
<a id="__codelineno-33-148" name="__codelineno-33-148" href="#__codelineno-33-148"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">e12</span><span class="o">-&gt;</span><span class="n">chi2</span><span class="p">()</span><span class="o">&gt;</span><span class="n">th2</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">e21</span><span class="o">-&gt;</span><span class="n">chi2</span><span class="p">()</span><span class="o">&gt;</span><span class="n">th2</span><span class="p">)</span>
<a id="__codelineno-33-149" name="__codelineno-33-149" href="#__codelineno-33-149"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-33-150" name="__codelineno-33-150" href="#__codelineno-33-150"></a><span class="w">            </span><span class="kt">size_t</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vnIndexEdge</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-33-151" name="__codelineno-33-151" href="#__codelineno-33-151"></a><span class="w">            </span><span class="n">vpMatches1</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">=</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<a id="__codelineno-33-152" name="__codelineno-33-152" href="#__codelineno-33-152"></a><span class="w">            </span><span class="n">optimizer</span><span class="p">.</span><span class="n">removeEdge</span><span class="p">(</span><span class="n">e12</span><span class="p">);</span>
<a id="__codelineno-33-153" name="__codelineno-33-153" href="#__codelineno-33-153"></a><span class="w">            </span><span class="n">optimizer</span><span class="p">.</span><span class="n">removeEdge</span><span class="p">(</span><span class="n">e21</span><span class="p">);</span>
<a id="__codelineno-33-154" name="__codelineno-33-154" href="#__codelineno-33-154"></a><span class="w">            </span><span class="n">vpEdges12</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">EdgeSim3ProjectXYZ</span><span class="o">*&gt;</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<a id="__codelineno-33-155" name="__codelineno-33-155" href="#__codelineno-33-155"></a><span class="w">            </span><span class="n">vpEdges21</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">EdgeInverseSim3ProjectXYZ</span><span class="o">*&gt;</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<a id="__codelineno-33-156" name="__codelineno-33-156" href="#__codelineno-33-156"></a><span class="w">            </span><span class="n">nBad</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-33-157" name="__codelineno-33-157" href="#__codelineno-33-157"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-33-158" name="__codelineno-33-158" href="#__codelineno-33-158"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-33-159" name="__codelineno-33-159" href="#__codelineno-33-159"></a>
<a id="__codelineno-33-160" name="__codelineno-33-160" href="#__codelineno-33-160"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nMoreIterations</span><span class="p">;</span>
<a id="__codelineno-33-161" name="__codelineno-33-161" href="#__codelineno-33-161"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">nBad</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-33-162" name="__codelineno-33-162" href="#__codelineno-33-162"></a><span class="w">        </span><span class="n">nMoreIterations</span><span class="o">=</span><span class="mi">10</span><span class="p">;</span>
<a id="__codelineno-33-163" name="__codelineno-33-163" href="#__codelineno-33-163"></a><span class="w">    </span><span class="k">else</span>
<a id="__codelineno-33-164" name="__codelineno-33-164" href="#__codelineno-33-164"></a><span class="w">        </span><span class="n">nMoreIterations</span><span class="o">=</span><span class="mi">5</span><span class="p">;</span>
<a id="__codelineno-33-165" name="__codelineno-33-165" href="#__codelineno-33-165"></a>
<a id="__codelineno-33-166" name="__codelineno-33-166" href="#__codelineno-33-166"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">nCorrespondences</span><span class="o">-</span><span class="n">nBad</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">)</span>
<a id="__codelineno-33-167" name="__codelineno-33-167" href="#__codelineno-33-167"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-33-168" name="__codelineno-33-168" href="#__codelineno-33-168"></a>
<a id="__codelineno-33-169" name="__codelineno-33-169" href="#__codelineno-33-169"></a><span class="w">    </span><span class="c1">// Optimize again only with inliers</span>
<a id="__codelineno-33-170" name="__codelineno-33-170" href="#__codelineno-33-170"></a>
<a id="__codelineno-33-171" name="__codelineno-33-171" href="#__codelineno-33-171"></a><span class="w">    </span><span class="n">optimizer</span><span class="p">.</span><span class="n">initializeOptimization</span><span class="p">();</span>
<a id="__codelineno-33-172" name="__codelineno-33-172" href="#__codelineno-33-172"></a><span class="w">    </span><span class="n">optimizer</span><span class="p">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">nMoreIterations</span><span class="p">);</span>
<a id="__codelineno-33-173" name="__codelineno-33-173" href="#__codelineno-33-173"></a>
<a id="__codelineno-33-174" name="__codelineno-33-174" href="#__codelineno-33-174"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nIn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-33-175" name="__codelineno-33-175" href="#__codelineno-33-175"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">vpEdges12</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-33-176" name="__codelineno-33-176" href="#__codelineno-33-176"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-33-177" name="__codelineno-33-177" href="#__codelineno-33-177"></a><span class="w">        </span><span class="n">g2o</span><span class="o">::</span><span class="n">EdgeSim3ProjectXYZ</span><span class="o">*</span><span class="w"> </span><span class="n">e12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vpEdges12</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-33-178" name="__codelineno-33-178" href="#__codelineno-33-178"></a><span class="w">        </span><span class="n">g2o</span><span class="o">::</span><span class="n">EdgeInverseSim3ProjectXYZ</span><span class="o">*</span><span class="w"> </span><span class="n">e21</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vpEdges21</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-33-179" name="__codelineno-33-179" href="#__codelineno-33-179"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">e12</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">e21</span><span class="p">)</span>
<a id="__codelineno-33-180" name="__codelineno-33-180" href="#__codelineno-33-180"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-33-181" name="__codelineno-33-181" href="#__codelineno-33-181"></a>
<a id="__codelineno-33-182" name="__codelineno-33-182" href="#__codelineno-33-182"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">e12</span><span class="o">-&gt;</span><span class="n">chi2</span><span class="p">()</span><span class="o">&gt;</span><span class="n">th2</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">e21</span><span class="o">-&gt;</span><span class="n">chi2</span><span class="p">()</span><span class="o">&gt;</span><span class="n">th2</span><span class="p">)</span>
<a id="__codelineno-33-183" name="__codelineno-33-183" href="#__codelineno-33-183"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-33-184" name="__codelineno-33-184" href="#__codelineno-33-184"></a><span class="w">            </span><span class="kt">size_t</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vnIndexEdge</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-33-185" name="__codelineno-33-185" href="#__codelineno-33-185"></a><span class="w">            </span><span class="n">vpMatches1</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">=</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<a id="__codelineno-33-186" name="__codelineno-33-186" href="#__codelineno-33-186"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-33-187" name="__codelineno-33-187" href="#__codelineno-33-187"></a><span class="w">        </span><span class="k">else</span>
<a id="__codelineno-33-188" name="__codelineno-33-188" href="#__codelineno-33-188"></a><span class="w">            </span><span class="n">nIn</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-33-189" name="__codelineno-33-189" href="#__codelineno-33-189"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-33-190" name="__codelineno-33-190" href="#__codelineno-33-190"></a>
<a id="__codelineno-33-191" name="__codelineno-33-191" href="#__codelineno-33-191"></a><span class="w">    </span><span class="c1">// Recover optimized Sim3</span>
<a id="__codelineno-33-192" name="__codelineno-33-192" href="#__codelineno-33-192"></a><span class="w">    </span><span class="n">g2o</span><span class="o">::</span><span class="n">VertexSim3Expmap</span><span class="o">*</span><span class="w"> </span><span class="n">vSim3_recov</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">VertexSim3Expmap</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">optimizer</span><span class="p">.</span><span class="n">vertex</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<a id="__codelineno-33-193" name="__codelineno-33-193" href="#__codelineno-33-193"></a><span class="w">    </span><span class="n">g2oS12</span><span class="o">=</span><span class="w"> </span><span class="n">vSim3_recov</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">();</span>
<a id="__codelineno-33-194" name="__codelineno-33-194" href="#__codelineno-33-194"></a>
<a id="__codelineno-33-195" name="__codelineno-33-195" href="#__codelineno-33-195"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">nIn</span><span class="p">;</span>
<a id="__codelineno-33-196" name="__codelineno-33-196" href="#__codelineno-33-196"></a><span class="p">}</span>
</code></pre></div>
where error is a 2d projection error such that <code>_error = obs-v1-&gt;cam_map1(project(v1-&gt;estimate().map(v2-&gt;estimate())));</code>.
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">EdgeSim3ProjectXYZ</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w">  </span><span class="n">BaseBinaryEdge</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">Vector2d</span><span class="p">,</span><span class="w">  </span><span class="n">VertexSBAPointXYZ</span><span class="p">,</span><span class="w"> </span><span class="n">VertexSim3Expmap</span><span class="o">&gt;</span>
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="p">{</span>
<a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="w">  </span><span class="k">public</span><span class="o">:</span>
<a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="w">    </span><span class="n">EIGEN_MAKE_ALIGNED_OPERATOR_NEW</span>
<a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a><span class="w">    </span><span class="n">EdgeSim3ProjectXYZ</span><span class="p">();</span>
<a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">read</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">istream</span><span class="o">&amp;</span><span class="w"> </span><span class="n">is</span><span class="p">);</span>
<a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">write</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="n">os</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a>
<a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">computeError</span><span class="p">()</span>
<a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-34-11" name="__codelineno-34-11" href="#__codelineno-34-11"></a><span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="n">VertexSim3Expmap</span><span class="o">*</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">VertexSim3Expmap</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">_vertices</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<a id="__codelineno-34-12" name="__codelineno-34-12" href="#__codelineno-34-12"></a><span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="n">VertexSBAPointXYZ</span><span class="o">*</span><span class="w"> </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">VertexSBAPointXYZ</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">_vertices</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<a id="__codelineno-34-13" name="__codelineno-34-13" href="#__codelineno-34-13"></a>
<a id="__codelineno-34-14" name="__codelineno-34-14" href="#__codelineno-34-14"></a><span class="w">      </span><span class="n">Vector2d</span><span class="w"> </span><span class="n">obs</span><span class="p">(</span><span class="n">_measurement</span><span class="p">);</span>
<a id="__codelineno-34-15" name="__codelineno-34-15" href="#__codelineno-34-15"></a><span class="w">      </span><span class="n">_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obs</span><span class="o">-</span><span class="n">v1</span><span class="o">-&gt;</span><span class="n">cam_map1</span><span class="p">(</span><span class="n">project</span><span class="p">(</span><span class="n">v1</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="n">v2</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">())));</span>
<a id="__codelineno-34-16" name="__codelineno-34-16" href="#__codelineno-34-16"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-34-17" name="__codelineno-34-17" href="#__codelineno-34-17"></a>
<a id="__codelineno-34-18" name="__codelineno-34-18" href="#__codelineno-34-18"></a><span class="w">   </span><span class="c1">// virtual void linearizeOplus();</span>
<a id="__codelineno-34-19" name="__codelineno-34-19" href="#__codelineno-34-19"></a>
<a id="__codelineno-34-20" name="__codelineno-34-20" href="#__codelineno-34-20"></a><span class="p">};</span>
</code></pre></div></p>
<h2 id="feature-tracking">Feature Tracking</h2>
<h3 id="constructor">Constructor</h3>
<p>The <code>Tracking</code> constructor basically does the two jobs:
* Load camera params such as intrinsics and distortion coefficients
* Build <code>ORBextractor</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="c1">// use by `Tracking`</span>
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="n">mpTracker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Tracking</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">mpVocabulary</span><span class="p">,</span><span class="w"> </span><span class="n">mpFrameDrawer</span><span class="p">,</span><span class="w"> </span><span class="n">mpMapDrawer</span><span class="p">,</span>
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="w">                             </span><span class="n">mpMap</span><span class="p">,</span><span class="w"> </span><span class="n">mpKeyFrameDatabase</span><span class="p">,</span><span class="w"> </span><span class="n">strSettingsFile</span><span class="p">,</span><span class="w"> </span><span class="n">mSensor</span><span class="p">);</span>
<a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a>
<a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="c1">// definition</span>
<a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a><span class="n">Tracking</span><span class="o">::</span><span class="n">Tracking</span><span class="p">(</span><span class="n">System</span><span class="w"> </span><span class="o">*</span><span class="n">pSys</span><span class="p">,</span><span class="w"> </span><span class="n">ORBVocabulary</span><span class="o">*</span><span class="w"> </span><span class="n">pVoc</span><span class="p">,</span><span class="w"> </span><span class="n">FrameDrawer</span><span class="w"> </span><span class="o">*</span><span class="n">pFrameDrawer</span><span class="p">,</span><span class="w"> </span><span class="n">MapDrawer</span><span class="w"> </span><span class="o">*</span><span class="n">pMapDrawer</span><span class="p">,</span><span class="w"> </span><span class="n">Map</span><span class="w"> </span><span class="o">*</span><span class="n">pMap</span><span class="p">,</span><span class="w"> </span><span class="n">KeyFrameDatabase</span><span class="o">*</span><span class="w"> </span><span class="n">pKFDB</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">strSettingPath</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">sensor</span><span class="p">)</span><span class="o">:</span>
<a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a><span class="w">    </span><span class="n">mState</span><span class="p">(</span><span class="n">NO_IMAGES_YET</span><span class="p">),</span><span class="w"> </span><span class="n">mSensor</span><span class="p">(</span><span class="n">sensor</span><span class="p">),</span><span class="w"> </span><span class="n">mbOnlyTracking</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span><span class="w"> </span><span class="n">mbVO</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span><span class="w"> </span><span class="n">mpORBVocabulary</span><span class="p">(</span><span class="n">pVoc</span><span class="p">),</span>
<a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a><span class="w">    </span><span class="n">mpKeyFrameDB</span><span class="p">(</span><span class="n">pKFDB</span><span class="p">),</span><span class="w"> </span><span class="n">mpInitializer</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Initializer</span><span class="o">*&gt;</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)),</span><span class="w"> </span><span class="n">mpSystem</span><span class="p">(</span><span class="n">pSys</span><span class="p">),</span><span class="w"> </span><span class="n">mpViewer</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span>
<a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a><span class="w">    </span><span class="n">mpFrameDrawer</span><span class="p">(</span><span class="n">pFrameDrawer</span><span class="p">),</span><span class="w"> </span><span class="n">mpMapDrawer</span><span class="p">(</span><span class="n">pMapDrawer</span><span class="p">),</span><span class="w"> </span><span class="n">mpMap</span><span class="p">(</span><span class="n">pMap</span><span class="p">),</span><span class="w"> </span><span class="n">mnLastRelocFrameId</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a><span class="p">{</span>
<a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a><span class="w">    </span><span class="c1">// ########## Load camera parameters ########## </span>
<a id="__codelineno-35-12" name="__codelineno-35-12" href="#__codelineno-35-12"></a><span class="w">    </span><span class="c1">// Camera.fx: 535.4</span>
<a id="__codelineno-35-13" name="__codelineno-35-13" href="#__codelineno-35-13"></a><span class="w">    </span><span class="c1">// Camera.fy: 539.2</span>
<a id="__codelineno-35-14" name="__codelineno-35-14" href="#__codelineno-35-14"></a><span class="w">    </span><span class="c1">// Camera.cx: 320.1</span>
<a id="__codelineno-35-15" name="__codelineno-35-15" href="#__codelineno-35-15"></a><span class="w">    </span><span class="c1">// Camera.cy: 247.6</span>
<a id="__codelineno-35-16" name="__codelineno-35-16" href="#__codelineno-35-16"></a><span class="w">    </span><span class="c1">// Camera.k1: 0.0</span>
<a id="__codelineno-35-17" name="__codelineno-35-17" href="#__codelineno-35-17"></a><span class="w">    </span><span class="c1">// Camera.k2: 0.0</span>
<a id="__codelineno-35-18" name="__codelineno-35-18" href="#__codelineno-35-18"></a><span class="w">    </span><span class="c1">// Camera.p1: 0.0</span>
<a id="__codelineno-35-19" name="__codelineno-35-19" href="#__codelineno-35-19"></a><span class="w">    </span><span class="c1">// Camera.p2: 0.0</span>
<a id="__codelineno-35-20" name="__codelineno-35-20" href="#__codelineno-35-20"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">FileStorage</span><span class="w"> </span><span class="nf">fSettings</span><span class="p">(</span><span class="n">strSettingPath</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">FileStorage</span><span class="o">::</span><span class="n">READ</span><span class="p">);</span>
<a id="__codelineno-35-21" name="__codelineno-35-21" href="#__codelineno-35-21"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">fx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fSettings</span><span class="p">[</span><span class="s">&quot;Camera.fx&quot;</span><span class="p">];</span>
<a id="__codelineno-35-22" name="__codelineno-35-22" href="#__codelineno-35-22"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">fy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fSettings</span><span class="p">[</span><span class="s">&quot;Camera.fy&quot;</span><span class="p">];</span>
<a id="__codelineno-35-23" name="__codelineno-35-23" href="#__codelineno-35-23"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">cx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fSettings</span><span class="p">[</span><span class="s">&quot;Camera.cx&quot;</span><span class="p">];</span>
<a id="__codelineno-35-24" name="__codelineno-35-24" href="#__codelineno-35-24"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">cy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fSettings</span><span class="p">[</span><span class="s">&quot;Camera.cy&quot;</span><span class="p">];</span>
<a id="__codelineno-35-25" name="__codelineno-35-25" href="#__codelineno-35-25"></a>
<a id="__codelineno-35-26" name="__codelineno-35-26" href="#__codelineno-35-26"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">K</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">::</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">CV_32F</span><span class="p">);</span>
<a id="__codelineno-35-27" name="__codelineno-35-27" href="#__codelineno-35-27"></a><span class="w">    </span><span class="n">K</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fx</span><span class="p">;</span>
<a id="__codelineno-35-28" name="__codelineno-35-28" href="#__codelineno-35-28"></a><span class="w">    </span><span class="n">K</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fy</span><span class="p">;</span>
<a id="__codelineno-35-29" name="__codelineno-35-29" href="#__codelineno-35-29"></a><span class="w">    </span><span class="n">K</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cx</span><span class="p">;</span>
<a id="__codelineno-35-30" name="__codelineno-35-30" href="#__codelineno-35-30"></a><span class="w">    </span><span class="n">K</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cy</span><span class="p">;</span>
<a id="__codelineno-35-31" name="__codelineno-35-31" href="#__codelineno-35-31"></a><span class="w">    </span><span class="n">K</span><span class="p">.</span><span class="n">copyTo</span><span class="p">(</span><span class="n">mK</span><span class="p">);</span>
<a id="__codelineno-35-32" name="__codelineno-35-32" href="#__codelineno-35-32"></a>
<a id="__codelineno-35-33" name="__codelineno-35-33" href="#__codelineno-35-33"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="nf">DistCoef</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">CV_32F</span><span class="p">);</span>
<a id="__codelineno-35-34" name="__codelineno-35-34" href="#__codelineno-35-34"></a><span class="w">    </span><span class="n">DistCoef</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fSettings</span><span class="p">[</span><span class="s">&quot;Camera.k1&quot;</span><span class="p">];</span>
<a id="__codelineno-35-35" name="__codelineno-35-35" href="#__codelineno-35-35"></a><span class="w">    </span><span class="n">DistCoef</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fSettings</span><span class="p">[</span><span class="s">&quot;Camera.k2&quot;</span><span class="p">];</span>
<a id="__codelineno-35-36" name="__codelineno-35-36" href="#__codelineno-35-36"></a><span class="w">    </span><span class="n">DistCoef</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fSettings</span><span class="p">[</span><span class="s">&quot;Camera.p1&quot;</span><span class="p">];</span>
<a id="__codelineno-35-37" name="__codelineno-35-37" href="#__codelineno-35-37"></a><span class="w">    </span><span class="n">DistCoef</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fSettings</span><span class="p">[</span><span class="s">&quot;Camera.p2&quot;</span><span class="p">];</span>
<a id="__codelineno-35-38" name="__codelineno-35-38" href="#__codelineno-35-38"></a>
<a id="__codelineno-35-39" name="__codelineno-35-39" href="#__codelineno-35-39"></a><span class="w">    </span><span class="p">...</span><span class="w"> </span><span class="c1">// some other camera configs</span>
<a id="__codelineno-35-40" name="__codelineno-35-40" href="#__codelineno-35-40"></a>
<a id="__codelineno-35-41" name="__codelineno-35-41" href="#__codelineno-35-41"></a><span class="w">    </span><span class="c1">// ########## Load ORB parameters ########## </span>
<a id="__codelineno-35-42" name="__codelineno-35-42" href="#__codelineno-35-42"></a><span class="w">    </span><span class="c1">// # ORB Extractor: Number of features per image</span>
<a id="__codelineno-35-43" name="__codelineno-35-43" href="#__codelineno-35-43"></a><span class="w">    </span><span class="c1">// ORBextractor.nFeatures: 1000</span>
<a id="__codelineno-35-44" name="__codelineno-35-44" href="#__codelineno-35-44"></a><span class="w">    </span><span class="c1">// # ORB Extractor: Scale factor between levels in the scale pyramid    </span>
<a id="__codelineno-35-45" name="__codelineno-35-45" href="#__codelineno-35-45"></a><span class="w">    </span><span class="c1">// ORBextractor.scaleFactor: 1.2</span>
<a id="__codelineno-35-46" name="__codelineno-35-46" href="#__codelineno-35-46"></a><span class="w">    </span><span class="c1">// # ORB Extractor: Number of levels in the scale pyramid   </span>
<a id="__codelineno-35-47" name="__codelineno-35-47" href="#__codelineno-35-47"></a><span class="w">    </span><span class="c1">// ORBextractor.nLevels: 8</span>
<a id="__codelineno-35-48" name="__codelineno-35-48" href="#__codelineno-35-48"></a><span class="w">    </span><span class="c1">// # ORB Extractor: Fast threshold</span>
<a id="__codelineno-35-49" name="__codelineno-35-49" href="#__codelineno-35-49"></a><span class="w">    </span><span class="c1">// # Image is divided in a grid. At each cell FAST are extracted imposing a minimum response.</span>
<a id="__codelineno-35-50" name="__codelineno-35-50" href="#__codelineno-35-50"></a><span class="w">    </span><span class="c1">// # Firstly we impose iniThFAST. If no corners are detected we impose a lower value minThFAST</span>
<a id="__codelineno-35-51" name="__codelineno-35-51" href="#__codelineno-35-51"></a><span class="w">    </span><span class="c1">// # You can lower these values if your images have low contrast            </span>
<a id="__codelineno-35-52" name="__codelineno-35-52" href="#__codelineno-35-52"></a><span class="w">    </span><span class="c1">// ORBextractor.iniThFAST: 20</span>
<a id="__codelineno-35-53" name="__codelineno-35-53" href="#__codelineno-35-53"></a><span class="w">    </span><span class="c1">// ORBextractor.minThFAST: 7</span>
<a id="__codelineno-35-54" name="__codelineno-35-54" href="#__codelineno-35-54"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nFeatures</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fSettings</span><span class="p">[</span><span class="s">&quot;ORBextractor.nFeatures&quot;</span><span class="p">];</span>
<a id="__codelineno-35-55" name="__codelineno-35-55" href="#__codelineno-35-55"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">fScaleFactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fSettings</span><span class="p">[</span><span class="s">&quot;ORBextractor.scaleFactor&quot;</span><span class="p">];</span>
<a id="__codelineno-35-56" name="__codelineno-35-56" href="#__codelineno-35-56"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nLevels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fSettings</span><span class="p">[</span><span class="s">&quot;ORBextractor.nLevels&quot;</span><span class="p">];</span>
<a id="__codelineno-35-57" name="__codelineno-35-57" href="#__codelineno-35-57"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fIniThFAST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fSettings</span><span class="p">[</span><span class="s">&quot;ORBextractor.iniThFAST&quot;</span><span class="p">];</span>
<a id="__codelineno-35-58" name="__codelineno-35-58" href="#__codelineno-35-58"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fMinThFAST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fSettings</span><span class="p">[</span><span class="s">&quot;ORBextractor.minThFAST&quot;</span><span class="p">];</span><span class="w">    </span>
<a id="__codelineno-35-59" name="__codelineno-35-59" href="#__codelineno-35-59"></a>
<a id="__codelineno-35-60" name="__codelineno-35-60" href="#__codelineno-35-60"></a><span class="w">    </span><span class="n">mpORBextractorLeft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ORBextractor</span><span class="p">(</span><span class="n">nFeatures</span><span class="p">,</span><span class="n">fScaleFactor</span><span class="p">,</span><span class="n">nLevels</span><span class="p">,</span><span class="n">fIniThFAST</span><span class="p">,</span><span class="n">fMinThFAST</span><span class="p">);</span>
<a id="__codelineno-35-61" name="__codelineno-35-61" href="#__codelineno-35-61"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">sensor</span><span class="o">==</span><span class="n">System</span><span class="o">::</span><span class="n">MONOCULAR</span><span class="p">)</span>
<a id="__codelineno-35-62" name="__codelineno-35-62" href="#__codelineno-35-62"></a><span class="w">        </span><span class="n">mpIniORBextractor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ORBextractor</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">nFeatures</span><span class="p">,</span><span class="n">fScaleFactor</span><span class="p">,</span><span class="n">nLevels</span><span class="p">,</span><span class="n">fIniThFAST</span><span class="p">,</span><span class="n">fMinThFAST</span><span class="p">);</span>
<a id="__codelineno-35-63" name="__codelineno-35-63" href="#__codelineno-35-63"></a><span class="p">}</span>
</code></pre></div>
<h3 id="systemtrackmonocular"><code>System::TrackMonocular</code></h3>
<p><code>System::TrackMonocular(...)</code> is the callback function to be invoked every time when an image arrives to the topic <code>nodeHandler.subscribe("/camera/image_raw", 1, &amp;ImageGrabber::GrabImage,&amp;igb);</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="nf">System::TrackMonocular</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="o">&amp;</span><span class="n">im</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">&amp;</span><span class="n">timestamp</span><span class="p">)</span>
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="p">{</span>
<a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="w">    </span><span class="p">...</span><span class="w"> </span><span class="c1">// some checking</span>
<a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a>
<a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">Tcw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mpTracker</span><span class="o">-&gt;</span><span class="n">GrabImageMonocular</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">timestamp</span><span class="p">);</span>
<a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a>
<a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a><span class="w">    </span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock2</span><span class="p">(</span><span class="n">mMutexState</span><span class="p">);</span>
<a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a><span class="w">    </span><span class="n">mTrackingState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mpTracker</span><span class="o">-&gt;</span><span class="n">mState</span><span class="p">;</span>
<a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a><span class="w">    </span><span class="n">mTrackedMapPoints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mpTracker</span><span class="o">-&gt;</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mvpMapPoints</span><span class="p">;</span>
<a id="__codelineno-36-10" name="__codelineno-36-10" href="#__codelineno-36-10"></a><span class="w">    </span><span class="n">mTrackedKeyPointsUn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mpTracker</span><span class="o">-&gt;</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mvKeysUn</span><span class="p">;</span>
<a id="__codelineno-36-11" name="__codelineno-36-11" href="#__codelineno-36-11"></a>
<a id="__codelineno-36-12" name="__codelineno-36-12" href="#__codelineno-36-12"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Tcw</span><span class="p">;</span>
<a id="__codelineno-36-13" name="__codelineno-36-13" href="#__codelineno-36-13"></a><span class="p">}</span>
</code></pre></div>
<p><code>GrabImageMonocular(...)</code> converts an image to a gray image;
if the frame is not yet init, create a new frame <code>Frame</code>, then track features by <code>Track();</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="nf">Tracking::GrabImageMonocular</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="o">&amp;</span><span class="n">im</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">&amp;</span><span class="n">timestamp</span><span class="p">)</span>
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="p">{</span>
<a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a><span class="w">    </span><span class="n">mImGray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">im</span><span class="p">;</span>
<a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a>
<a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a><span class="w">    </span><span class="n">cvtColor</span><span class="p">(</span><span class="n">mImGray</span><span class="p">,</span><span class="n">mImGray</span><span class="p">,</span><span class="n">CV_RGB2GRAY</span><span class="p">);</span>
<a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a>
<a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mState</span><span class="o">==</span><span class="n">NOT_INITIALIZED</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">mState</span><span class="o">==</span><span class="n">NO_IMAGES_YET</span><span class="p">)</span>
<a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a><span class="w">        </span><span class="n">mCurrentFrame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Frame</span><span class="p">(</span><span class="n">mImGray</span><span class="p">,</span><span class="n">timestamp</span><span class="p">,</span><span class="n">mpIniORBextractor</span><span class="p">,</span><span class="n">mpORBVocabulary</span><span class="p">,</span><span class="n">mK</span><span class="p">,</span><span class="n">mDistCoef</span><span class="p">,</span><span class="n">mbf</span><span class="p">,</span><span class="n">mThDepth</span><span class="p">);</span>
<a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a><span class="w">    </span><span class="k">else</span>
<a id="__codelineno-37-10" name="__codelineno-37-10" href="#__codelineno-37-10"></a><span class="w">        </span><span class="n">mCurrentFrame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Frame</span><span class="p">(</span><span class="n">mImGray</span><span class="p">,</span><span class="n">timestamp</span><span class="p">,</span><span class="n">mpORBextractorLeft</span><span class="p">,</span><span class="n">mpORBVocabulary</span><span class="p">,</span><span class="n">mK</span><span class="p">,</span><span class="n">mDistCoef</span><span class="p">,</span><span class="n">mbf</span><span class="p">,</span><span class="n">mThDepth</span><span class="p">);</span>
<a id="__codelineno-37-11" name="__codelineno-37-11" href="#__codelineno-37-11"></a>
<a id="__codelineno-37-12" name="__codelineno-37-12" href="#__codelineno-37-12"></a><span class="w">    </span><span class="n">Track</span><span class="p">();</span>
<a id="__codelineno-37-13" name="__codelineno-37-13" href="#__codelineno-37-13"></a>
<a id="__codelineno-37-14" name="__codelineno-37-14" href="#__codelineno-37-14"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mTcw</span><span class="p">.</span><span class="n">clone</span><span class="p">();</span>
<a id="__codelineno-37-15" name="__codelineno-37-15" href="#__codelineno-37-15"></a><span class="p">}</span>
</code></pre></div>
<h3 id="tracking">Tracking</h3>
<p><code>Tracking::Track()</code> manages performing different tasks given the below procedures/conditions.
In general, they are
* Camera has some movements, use <code>TrackWithMotionModel</code>
* Camera has little movements, use <code>TrackReferenceKeyFrame</code>
* Tracking is lost, use <code>Relocalization</code></p>
<p>The above three tasks would optimize camera pose for this frame.
Having done pose optimization, then by the new camera pose, update map points in the current local map.</p>
<p>Then, check if the current frame can be considered as a keyframe.</p>
<p>Finally, conduct some cleaning work such as mapping variables to nullptrs, and store (by <code>push_back</code>) the current frame to a list.</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">Tracking::Track</span><span class="p">()</span>
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="p">{</span>
<a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mState</span><span class="o">==</span><span class="n">NO_IMAGES_YET</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a><span class="w">        </span><span class="n">mState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NOT_INITIALIZED</span><span class="p">;</span>
<a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a>
<a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a><span class="w">    </span><span class="n">mLastProcessedState</span><span class="o">=</span><span class="n">mState</span><span class="p">;</span>
<a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a>
<a id="__codelineno-38-9" name="__codelineno-38-9" href="#__codelineno-38-9"></a><span class="w">    </span><span class="c1">// Get Map Mutex -&gt; Map cannot be changed</span>
<a id="__codelineno-38-10" name="__codelineno-38-10" href="#__codelineno-38-10"></a><span class="w">    </span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">mpMap</span><span class="o">-&gt;</span><span class="n">mMutexMapUpdate</span><span class="p">);</span>
<a id="__codelineno-38-11" name="__codelineno-38-11" href="#__codelineno-38-11"></a>
<a id="__codelineno-38-12" name="__codelineno-38-12" href="#__codelineno-38-12"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mState</span><span class="o">==</span><span class="n">NOT_INITIALIZED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-13" name="__codelineno-38-13" href="#__codelineno-38-13"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">mSensor</span><span class="o">==</span><span class="n">System</span><span class="o">::</span><span class="n">STEREO</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">mSensor</span><span class="o">==</span><span class="n">System</span><span class="o">::</span><span class="n">RGBD</span><span class="p">)</span>
<a id="__codelineno-38-14" name="__codelineno-38-14" href="#__codelineno-38-14"></a><span class="w">            </span><span class="n">StereoInitialization</span><span class="p">();</span>
<a id="__codelineno-38-15" name="__codelineno-38-15" href="#__codelineno-38-15"></a><span class="w">        </span><span class="k">else</span>
<a id="__codelineno-38-16" name="__codelineno-38-16" href="#__codelineno-38-16"></a><span class="w">            </span><span class="n">MonocularInitialization</span><span class="p">();</span>
<a id="__codelineno-38-17" name="__codelineno-38-17" href="#__codelineno-38-17"></a>
<a id="__codelineno-38-18" name="__codelineno-38-18" href="#__codelineno-38-18"></a><span class="w">        </span><span class="n">mpFrameDrawer</span><span class="o">-&gt;</span><span class="n">Update</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<a id="__codelineno-38-19" name="__codelineno-38-19" href="#__codelineno-38-19"></a>
<a id="__codelineno-38-20" name="__codelineno-38-20" href="#__codelineno-38-20"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">mState</span><span class="o">!=</span><span class="n">OK</span><span class="p">)</span>
<a id="__codelineno-38-21" name="__codelineno-38-21" href="#__codelineno-38-21"></a><span class="w">            </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-38-22" name="__codelineno-38-22" href="#__codelineno-38-22"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-38-23" name="__codelineno-38-23" href="#__codelineno-38-23"></a><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-24" name="__codelineno-38-24" href="#__codelineno-38-24"></a><span class="w">        </span><span class="c1">// System is initialized. Track Frame.</span>
<a id="__codelineno-38-25" name="__codelineno-38-25" href="#__codelineno-38-25"></a><span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">bOK</span><span class="p">;</span>
<a id="__codelineno-38-26" name="__codelineno-38-26" href="#__codelineno-38-26"></a>
<a id="__codelineno-38-27" name="__codelineno-38-27" href="#__codelineno-38-27"></a><span class="w">        </span><span class="c1">// Initial camera pose estimation using motion model or relocalization (if tracking is lost)</span>
<a id="__codelineno-38-28" name="__codelineno-38-28" href="#__codelineno-38-28"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">mbOnlyTracking</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-29" name="__codelineno-38-29" href="#__codelineno-38-29"></a><span class="w">            </span><span class="c1">// Local Mapping is activated. This is the normal behaviour, unless</span>
<a id="__codelineno-38-30" name="__codelineno-38-30" href="#__codelineno-38-30"></a><span class="w">            </span><span class="c1">// you explicitly activate the &quot;only tracking&quot; mode.</span>
<a id="__codelineno-38-31" name="__codelineno-38-31" href="#__codelineno-38-31"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">mState</span><span class="o">==</span><span class="n">OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-32" name="__codelineno-38-32" href="#__codelineno-38-32"></a><span class="w">                </span><span class="c1">// Local Mapping might have changed some MapPoints tracked in last frame</span>
<a id="__codelineno-38-33" name="__codelineno-38-33" href="#__codelineno-38-33"></a><span class="w">                </span><span class="n">CheckReplacedInLastFrame</span><span class="p">();</span>
<a id="__codelineno-38-34" name="__codelineno-38-34" href="#__codelineno-38-34"></a>
<a id="__codelineno-38-35" name="__codelineno-38-35" href="#__codelineno-38-35"></a><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">mVelocity</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mnId</span><span class="o">&lt;</span><span class="n">mnLastRelocFrameId</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-36" name="__codelineno-38-36" href="#__codelineno-38-36"></a><span class="w">                    </span><span class="n">bOK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TrackReferenceKeyFrame</span><span class="p">();</span>
<a id="__codelineno-38-37" name="__codelineno-38-37" href="#__codelineno-38-37"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-38-38" name="__codelineno-38-38" href="#__codelineno-38-38"></a><span class="w">                </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-39" name="__codelineno-38-39" href="#__codelineno-38-39"></a><span class="w">                    </span><span class="n">bOK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TrackWithMotionModel</span><span class="p">();</span>
<a id="__codelineno-38-40" name="__codelineno-38-40" href="#__codelineno-38-40"></a><span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">bOK</span><span class="p">)</span>
<a id="__codelineno-38-41" name="__codelineno-38-41" href="#__codelineno-38-41"></a><span class="w">                        </span><span class="n">bOK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TrackReferenceKeyFrame</span><span class="p">();</span>
<a id="__codelineno-38-42" name="__codelineno-38-42" href="#__codelineno-38-42"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-38-43" name="__codelineno-38-43" href="#__codelineno-38-43"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-38-44" name="__codelineno-38-44" href="#__codelineno-38-44"></a><span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-45" name="__codelineno-38-45" href="#__codelineno-38-45"></a><span class="w">                </span><span class="n">bOK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Relocalization</span><span class="p">();</span>
<a id="__codelineno-38-46" name="__codelineno-38-46" href="#__codelineno-38-46"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-38-47" name="__codelineno-38-47" href="#__codelineno-38-47"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-38-48" name="__codelineno-38-48" href="#__codelineno-38-48"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-49" name="__codelineno-38-49" href="#__codelineno-38-49"></a><span class="w">            </span><span class="c1">// Localization Mode: Local Mapping is deactivated</span>
<a id="__codelineno-38-50" name="__codelineno-38-50" href="#__codelineno-38-50"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">mState</span><span class="o">==</span><span class="n">LOST</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-51" name="__codelineno-38-51" href="#__codelineno-38-51"></a><span class="w">                </span><span class="n">bOK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Relocalization</span><span class="p">();</span>
<a id="__codelineno-38-52" name="__codelineno-38-52" href="#__codelineno-38-52"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-38-53" name="__codelineno-38-53" href="#__codelineno-38-53"></a><span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-54" name="__codelineno-38-54" href="#__codelineno-38-54"></a><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">mbVO</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-55" name="__codelineno-38-55" href="#__codelineno-38-55"></a><span class="w">                    </span><span class="c1">// In last frame we tracked enough MapPoints in the map</span>
<a id="__codelineno-38-56" name="__codelineno-38-56" href="#__codelineno-38-56"></a><span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">mVelocity</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-57" name="__codelineno-38-57" href="#__codelineno-38-57"></a><span class="w">                        </span><span class="n">bOK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TrackWithMotionModel</span><span class="p">();</span>
<a id="__codelineno-38-58" name="__codelineno-38-58" href="#__codelineno-38-58"></a><span class="w">                    </span><span class="p">}</span>
<a id="__codelineno-38-59" name="__codelineno-38-59" href="#__codelineno-38-59"></a><span class="w">                    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-60" name="__codelineno-38-60" href="#__codelineno-38-60"></a><span class="w">                        </span><span class="n">bOK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TrackReferenceKeyFrame</span><span class="p">();</span>
<a id="__codelineno-38-61" name="__codelineno-38-61" href="#__codelineno-38-61"></a><span class="w">                    </span><span class="p">}</span>
<a id="__codelineno-38-62" name="__codelineno-38-62" href="#__codelineno-38-62"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-38-63" name="__codelineno-38-63" href="#__codelineno-38-63"></a><span class="w">                </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-64" name="__codelineno-38-64" href="#__codelineno-38-64"></a><span class="w">                    </span><span class="c1">// In last frame we tracked mainly &quot;visual odometry&quot; points.</span>
<a id="__codelineno-38-65" name="__codelineno-38-65" href="#__codelineno-38-65"></a>
<a id="__codelineno-38-66" name="__codelineno-38-66" href="#__codelineno-38-66"></a><span class="w">                    </span><span class="c1">// We compute two camera poses, one from motion model and one doing relocalization.</span>
<a id="__codelineno-38-67" name="__codelineno-38-67" href="#__codelineno-38-67"></a><span class="w">                    </span><span class="c1">// If relocalization is sucessfull we choose that solution, otherwise we retain</span>
<a id="__codelineno-38-68" name="__codelineno-38-68" href="#__codelineno-38-68"></a><span class="w">                    </span><span class="c1">// the &quot;visual odometry&quot; solution.</span>
<a id="__codelineno-38-69" name="__codelineno-38-69" href="#__codelineno-38-69"></a>
<a id="__codelineno-38-70" name="__codelineno-38-70" href="#__codelineno-38-70"></a><span class="w">                    </span><span class="kt">bool</span><span class="w"> </span><span class="n">bOKMM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-38-71" name="__codelineno-38-71" href="#__codelineno-38-71"></a><span class="w">                    </span><span class="kt">bool</span><span class="w"> </span><span class="n">bOKReloc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-38-72" name="__codelineno-38-72" href="#__codelineno-38-72"></a><span class="w">                    </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">vpMPsMM</span><span class="p">;</span>
<a id="__codelineno-38-73" name="__codelineno-38-73" href="#__codelineno-38-73"></a><span class="w">                    </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vbOutMM</span><span class="p">;</span>
<a id="__codelineno-38-74" name="__codelineno-38-74" href="#__codelineno-38-74"></a><span class="w">                    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">TcwMM</span><span class="p">;</span>
<a id="__codelineno-38-75" name="__codelineno-38-75" href="#__codelineno-38-75"></a><span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">mVelocity</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-76" name="__codelineno-38-76" href="#__codelineno-38-76"></a><span class="w">                        </span><span class="n">bOKMM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TrackWithMotionModel</span><span class="p">();</span>
<a id="__codelineno-38-77" name="__codelineno-38-77" href="#__codelineno-38-77"></a><span class="w">                        </span><span class="n">vpMPsMM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mvpMapPoints</span><span class="p">;</span>
<a id="__codelineno-38-78" name="__codelineno-38-78" href="#__codelineno-38-78"></a><span class="w">                        </span><span class="n">vbOutMM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mvbOutlier</span><span class="p">;</span>
<a id="__codelineno-38-79" name="__codelineno-38-79" href="#__codelineno-38-79"></a><span class="w">                        </span><span class="n">TcwMM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mTcw</span><span class="p">.</span><span class="n">clone</span><span class="p">();</span>
<a id="__codelineno-38-80" name="__codelineno-38-80" href="#__codelineno-38-80"></a><span class="w">                    </span><span class="p">}</span>
<a id="__codelineno-38-81" name="__codelineno-38-81" href="#__codelineno-38-81"></a><span class="w">                    </span><span class="n">bOKReloc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Relocalization</span><span class="p">();</span>
<a id="__codelineno-38-82" name="__codelineno-38-82" href="#__codelineno-38-82"></a>
<a id="__codelineno-38-83" name="__codelineno-38-83" href="#__codelineno-38-83"></a><span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="n">bOKMM</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">bOKReloc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-84" name="__codelineno-38-84" href="#__codelineno-38-84"></a><span class="w">                        </span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">SetPose</span><span class="p">(</span><span class="n">TcwMM</span><span class="p">);</span>
<a id="__codelineno-38-85" name="__codelineno-38-85" href="#__codelineno-38-85"></a><span class="w">                        </span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mvpMapPoints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vpMPsMM</span><span class="p">;</span>
<a id="__codelineno-38-86" name="__codelineno-38-86" href="#__codelineno-38-86"></a><span class="w">                        </span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mvbOutlier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vbOutMM</span><span class="p">;</span>
<a id="__codelineno-38-87" name="__codelineno-38-87" href="#__codelineno-38-87"></a>
<a id="__codelineno-38-88" name="__codelineno-38-88" href="#__codelineno-38-88"></a><span class="w">                        </span><span class="k">if</span><span class="p">(</span><span class="n">mbVO</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-89" name="__codelineno-38-89" href="#__codelineno-38-89"></a><span class="w">                            </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-90" name="__codelineno-38-90" href="#__codelineno-38-90"></a><span class="w">                                </span><span class="k">if</span><span class="p">(</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mvpMapPoints</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mvbOutlier</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-91" name="__codelineno-38-91" href="#__codelineno-38-91"></a><span class="w">                                    </span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mvpMapPoints</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">IncreaseFound</span><span class="p">();</span>
<a id="__codelineno-38-92" name="__codelineno-38-92" href="#__codelineno-38-92"></a><span class="w">                                </span><span class="p">}</span>
<a id="__codelineno-38-93" name="__codelineno-38-93" href="#__codelineno-38-93"></a><span class="w">                            </span><span class="p">}</span>
<a id="__codelineno-38-94" name="__codelineno-38-94" href="#__codelineno-38-94"></a><span class="w">                        </span><span class="p">}</span>
<a id="__codelineno-38-95" name="__codelineno-38-95" href="#__codelineno-38-95"></a><span class="w">                    </span><span class="p">}</span>
<a id="__codelineno-38-96" name="__codelineno-38-96" href="#__codelineno-38-96"></a><span class="w">                    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">bOKReloc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-97" name="__codelineno-38-97" href="#__codelineno-38-97"></a><span class="w">                        </span><span class="n">mbVO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-38-98" name="__codelineno-38-98" href="#__codelineno-38-98"></a><span class="w">                    </span><span class="p">}</span>
<a id="__codelineno-38-99" name="__codelineno-38-99" href="#__codelineno-38-99"></a>
<a id="__codelineno-38-100" name="__codelineno-38-100" href="#__codelineno-38-100"></a><span class="w">                    </span><span class="n">bOK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bOKReloc</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">bOKMM</span><span class="p">;</span>
<a id="__codelineno-38-101" name="__codelineno-38-101" href="#__codelineno-38-101"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-38-102" name="__codelineno-38-102" href="#__codelineno-38-102"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-38-103" name="__codelineno-38-103" href="#__codelineno-38-103"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-38-104" name="__codelineno-38-104" href="#__codelineno-38-104"></a>
<a id="__codelineno-38-105" name="__codelineno-38-105" href="#__codelineno-38-105"></a><span class="w">        </span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mpReferenceKF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mpReferenceKF</span><span class="p">;</span>
<a id="__codelineno-38-106" name="__codelineno-38-106" href="#__codelineno-38-106"></a>
<a id="__codelineno-38-107" name="__codelineno-38-107" href="#__codelineno-38-107"></a><span class="w">        </span><span class="c1">// If we have an initial estimation of the camera pose and matching. Track the local map.</span>
<a id="__codelineno-38-108" name="__codelineno-38-108" href="#__codelineno-38-108"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">mbOnlyTracking</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-109" name="__codelineno-38-109" href="#__codelineno-38-109"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">bOK</span><span class="p">)</span>
<a id="__codelineno-38-110" name="__codelineno-38-110" href="#__codelineno-38-110"></a><span class="w">                </span><span class="n">bOK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TrackLocalMap</span><span class="p">();</span>
<a id="__codelineno-38-111" name="__codelineno-38-111" href="#__codelineno-38-111"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-38-112" name="__codelineno-38-112" href="#__codelineno-38-112"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-113" name="__codelineno-38-113" href="#__codelineno-38-113"></a><span class="w">            </span><span class="c1">// mbVO true means that there are few matches to MapPoints in the map. We cannot retrieve</span>
<a id="__codelineno-38-114" name="__codelineno-38-114" href="#__codelineno-38-114"></a><span class="w">            </span><span class="c1">// a local map and therefore we do not perform TrackLocalMap(). Once the system relocalizes</span>
<a id="__codelineno-38-115" name="__codelineno-38-115" href="#__codelineno-38-115"></a><span class="w">            </span><span class="c1">// the camera we will use the local map again.</span>
<a id="__codelineno-38-116" name="__codelineno-38-116" href="#__codelineno-38-116"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">bOK</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">mbVO</span><span class="p">)</span>
<a id="__codelineno-38-117" name="__codelineno-38-117" href="#__codelineno-38-117"></a><span class="w">                </span><span class="n">bOK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TrackLocalMap</span><span class="p">();</span>
<a id="__codelineno-38-118" name="__codelineno-38-118" href="#__codelineno-38-118"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-38-119" name="__codelineno-38-119" href="#__codelineno-38-119"></a>
<a id="__codelineno-38-120" name="__codelineno-38-120" href="#__codelineno-38-120"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">bOK</span><span class="p">)</span>
<a id="__codelineno-38-121" name="__codelineno-38-121" href="#__codelineno-38-121"></a><span class="w">            </span><span class="n">mState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OK</span><span class="p">;</span>
<a id="__codelineno-38-122" name="__codelineno-38-122" href="#__codelineno-38-122"></a><span class="w">        </span><span class="k">else</span>
<a id="__codelineno-38-123" name="__codelineno-38-123" href="#__codelineno-38-123"></a><span class="w">            </span><span class="n">mState</span><span class="o">=</span><span class="n">LOST</span><span class="p">;</span>
<a id="__codelineno-38-124" name="__codelineno-38-124" href="#__codelineno-38-124"></a>
<a id="__codelineno-38-125" name="__codelineno-38-125" href="#__codelineno-38-125"></a><span class="w">        </span><span class="c1">// Update drawer</span>
<a id="__codelineno-38-126" name="__codelineno-38-126" href="#__codelineno-38-126"></a><span class="w">        </span><span class="n">mpFrameDrawer</span><span class="o">-&gt;</span><span class="n">Update</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<a id="__codelineno-38-127" name="__codelineno-38-127" href="#__codelineno-38-127"></a>
<a id="__codelineno-38-128" name="__codelineno-38-128" href="#__codelineno-38-128"></a><span class="w">        </span><span class="c1">// If tracking were good, check if we insert a keyframe</span>
<a id="__codelineno-38-129" name="__codelineno-38-129" href="#__codelineno-38-129"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">bOK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-130" name="__codelineno-38-130" href="#__codelineno-38-130"></a><span class="w">            </span><span class="c1">// Update motion model</span>
<a id="__codelineno-38-131" name="__codelineno-38-131" href="#__codelineno-38-131"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">mLastFrame</span><span class="p">.</span><span class="n">mTcw</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-132" name="__codelineno-38-132" href="#__codelineno-38-132"></a><span class="w">                </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">LastTwc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">::</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">CV_32F</span><span class="p">);</span>
<a id="__codelineno-38-133" name="__codelineno-38-133" href="#__codelineno-38-133"></a><span class="w">                </span><span class="n">mLastFrame</span><span class="p">.</span><span class="n">GetRotationInverse</span><span class="p">().</span><span class="n">copyTo</span><span class="p">(</span><span class="n">LastTwc</span><span class="p">.</span><span class="n">rowRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">).</span><span class="n">colRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">));</span>
<a id="__codelineno-38-134" name="__codelineno-38-134" href="#__codelineno-38-134"></a><span class="w">                </span><span class="n">mLastFrame</span><span class="p">.</span><span class="n">GetCameraCenter</span><span class="p">().</span><span class="n">copyTo</span><span class="p">(</span><span class="n">LastTwc</span><span class="p">.</span><span class="n">rowRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">).</span><span class="n">col</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
<a id="__codelineno-38-135" name="__codelineno-38-135" href="#__codelineno-38-135"></a><span class="w">                </span><span class="n">mVelocity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mTcw</span><span class="o">*</span><span class="n">LastTwc</span><span class="p">;</span>
<a id="__codelineno-38-136" name="__codelineno-38-136" href="#__codelineno-38-136"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-38-137" name="__codelineno-38-137" href="#__codelineno-38-137"></a><span class="w">            </span><span class="k">else</span>
<a id="__codelineno-38-138" name="__codelineno-38-138" href="#__codelineno-38-138"></a><span class="w">                </span><span class="n">mVelocity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="p">();</span>
<a id="__codelineno-38-139" name="__codelineno-38-139" href="#__codelineno-38-139"></a>
<a id="__codelineno-38-140" name="__codelineno-38-140" href="#__codelineno-38-140"></a><span class="w">            </span><span class="n">mpMapDrawer</span><span class="o">-&gt;</span><span class="n">SetCurrentCameraPose</span><span class="p">(</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mTcw</span><span class="p">);</span>
<a id="__codelineno-38-141" name="__codelineno-38-141" href="#__codelineno-38-141"></a>
<a id="__codelineno-38-142" name="__codelineno-38-142" href="#__codelineno-38-142"></a><span class="w">            </span><span class="p">...</span><span class="w"> </span><span class="c1">// some cleaning work such as deleting pointers/setting mapping to nullptr</span>
<a id="__codelineno-38-143" name="__codelineno-38-143" href="#__codelineno-38-143"></a>
<a id="__codelineno-38-144" name="__codelineno-38-144" href="#__codelineno-38-144"></a><span class="w">            </span><span class="c1">// Check if we need to insert a new keyframe</span>
<a id="__codelineno-38-145" name="__codelineno-38-145" href="#__codelineno-38-145"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">NeedNewKeyFrame</span><span class="p">())</span>
<a id="__codelineno-38-146" name="__codelineno-38-146" href="#__codelineno-38-146"></a><span class="w">                </span><span class="n">CreateNewKeyFrame</span><span class="p">();</span>
<a id="__codelineno-38-147" name="__codelineno-38-147" href="#__codelineno-38-147"></a>
<a id="__codelineno-38-148" name="__codelineno-38-148" href="#__codelineno-38-148"></a><span class="w">            </span><span class="c1">// We allow points with high innovation (considererd outliers by the Huber Function)</span>
<a id="__codelineno-38-149" name="__codelineno-38-149" href="#__codelineno-38-149"></a><span class="w">            </span><span class="c1">// pass to the new keyframe, so that bundle adjustment will finally decide</span>
<a id="__codelineno-38-150" name="__codelineno-38-150" href="#__codelineno-38-150"></a><span class="w">            </span><span class="c1">// if they are outliers or not. We don&#39;t want next frame to estimate its position</span>
<a id="__codelineno-38-151" name="__codelineno-38-151" href="#__codelineno-38-151"></a><span class="w">            </span><span class="c1">// with those points so we discard them in the frame.</span>
<a id="__codelineno-38-152" name="__codelineno-38-152" href="#__codelineno-38-152"></a><span class="w">            </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">N</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-153" name="__codelineno-38-153" href="#__codelineno-38-153"></a><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mvpMapPoints</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mvbOutlier</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<a id="__codelineno-38-154" name="__codelineno-38-154" href="#__codelineno-38-154"></a><span class="w">                    </span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mvpMapPoints</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<a id="__codelineno-38-155" name="__codelineno-38-155" href="#__codelineno-38-155"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-38-156" name="__codelineno-38-156" href="#__codelineno-38-156"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-38-157" name="__codelineno-38-157" href="#__codelineno-38-157"></a>
<a id="__codelineno-38-158" name="__codelineno-38-158" href="#__codelineno-38-158"></a><span class="w">        </span><span class="c1">// Reset if the camera get lost soon after initialization</span>
<a id="__codelineno-38-159" name="__codelineno-38-159" href="#__codelineno-38-159"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">mState</span><span class="o">==</span><span class="n">LOST</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-160" name="__codelineno-38-160" href="#__codelineno-38-160"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">mpMap</span><span class="o">-&gt;</span><span class="n">KeyFramesInMap</span><span class="p">()</span><span class="o">&lt;=</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-161" name="__codelineno-38-161" href="#__codelineno-38-161"></a><span class="w">                </span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Track lost soon after initialisation, reseting...&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">endl</span><span class="p">;</span>
<a id="__codelineno-38-162" name="__codelineno-38-162" href="#__codelineno-38-162"></a><span class="w">                </span><span class="n">mpSystem</span><span class="o">-&gt;</span><span class="n">Reset</span><span class="p">();</span>
<a id="__codelineno-38-163" name="__codelineno-38-163" href="#__codelineno-38-163"></a><span class="w">                </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-38-164" name="__codelineno-38-164" href="#__codelineno-38-164"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-38-165" name="__codelineno-38-165" href="#__codelineno-38-165"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-38-166" name="__codelineno-38-166" href="#__codelineno-38-166"></a>
<a id="__codelineno-38-167" name="__codelineno-38-167" href="#__codelineno-38-167"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mpReferenceKF</span><span class="p">)</span>
<a id="__codelineno-38-168" name="__codelineno-38-168" href="#__codelineno-38-168"></a><span class="w">            </span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mpReferenceKF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mpReferenceKF</span><span class="p">;</span>
<a id="__codelineno-38-169" name="__codelineno-38-169" href="#__codelineno-38-169"></a>
<a id="__codelineno-38-170" name="__codelineno-38-170" href="#__codelineno-38-170"></a><span class="w">        </span><span class="n">mLastFrame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Frame</span><span class="p">(</span><span class="n">mCurrentFrame</span><span class="p">);</span>
<a id="__codelineno-38-171" name="__codelineno-38-171" href="#__codelineno-38-171"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-38-172" name="__codelineno-38-172" href="#__codelineno-38-172"></a>
<a id="__codelineno-38-173" name="__codelineno-38-173" href="#__codelineno-38-173"></a><span class="w">    </span><span class="c1">// Store frame pose information to retrieve the complete camera trajectory afterwards.</span>
<a id="__codelineno-38-174" name="__codelineno-38-174" href="#__codelineno-38-174"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mTcw</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-175" name="__codelineno-38-175" href="#__codelineno-38-175"></a><span class="w">        </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">Tcr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mTcw</span><span class="o">*</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mpReferenceKF</span><span class="o">-&gt;</span><span class="n">GetPoseInverse</span><span class="p">();</span>
<a id="__codelineno-38-176" name="__codelineno-38-176" href="#__codelineno-38-176"></a><span class="w">        </span><span class="n">mlRelativeFramePoses</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">Tcr</span><span class="p">);</span>
<a id="__codelineno-38-177" name="__codelineno-38-177" href="#__codelineno-38-177"></a><span class="w">        </span><span class="n">mlpReferences</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">mpReferenceKF</span><span class="p">);</span>
<a id="__codelineno-38-178" name="__codelineno-38-178" href="#__codelineno-38-178"></a><span class="w">        </span><span class="n">mlFrameTimes</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mTimeStamp</span><span class="p">);</span>
<a id="__codelineno-38-179" name="__codelineno-38-179" href="#__codelineno-38-179"></a><span class="w">        </span><span class="n">mlbLost</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">mState</span><span class="o">==</span><span class="n">LOST</span><span class="p">);</span>
<a id="__codelineno-38-180" name="__codelineno-38-180" href="#__codelineno-38-180"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-38-181" name="__codelineno-38-181" href="#__codelineno-38-181"></a><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-182" name="__codelineno-38-182" href="#__codelineno-38-182"></a><span class="w">        </span><span class="c1">// This can happen if tracking is lost</span>
<a id="__codelineno-38-183" name="__codelineno-38-183" href="#__codelineno-38-183"></a><span class="w">        </span><span class="n">mlRelativeFramePoses</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">mlRelativeFramePoses</span><span class="p">.</span><span class="n">back</span><span class="p">());</span>
<a id="__codelineno-38-184" name="__codelineno-38-184" href="#__codelineno-38-184"></a><span class="w">        </span><span class="n">mlpReferences</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">mlpReferences</span><span class="p">.</span><span class="n">back</span><span class="p">());</span>
<a id="__codelineno-38-185" name="__codelineno-38-185" href="#__codelineno-38-185"></a><span class="w">        </span><span class="n">mlFrameTimes</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">mlFrameTimes</span><span class="p">.</span><span class="n">back</span><span class="p">());</span>
<a id="__codelineno-38-186" name="__codelineno-38-186" href="#__codelineno-38-186"></a><span class="w">        </span><span class="n">mlbLost</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">mState</span><span class="o">==</span><span class="n">LOST</span><span class="p">);</span>
<a id="__codelineno-38-187" name="__codelineno-38-187" href="#__codelineno-38-187"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-38-188" name="__codelineno-38-188" href="#__codelineno-38-188"></a><span class="p">}</span>
</code></pre></div>
where <code>TrackWithMotionModel()</code> and <code>TrackReferenceKeyFrame()</code> pretty much do the same thing: finding the match points corresponding between this frame the last frame, then by these points find the optimized pose/transform of this frame,
except for one tracking by motion from the updated pose/transform searching for feature points, another one by directly querying BoW database.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="kt">bool</span><span class="w"> </span><span class="nf">Tracking::TrackWithMotionModel</span><span class="p">()</span>
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="p">{</span>
<a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="w">    </span><span class="n">ORBmatcher</span><span class="w"> </span><span class="n">matcher</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span><span class="nb">true</span><span class="p">);</span>
<a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a>
<a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a><span class="w">    </span><span class="c1">// Update last frame pose according to its reference keyframe</span>
<a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a><span class="w">    </span><span class="c1">// Create &quot;visual odometry&quot; points if in Localization Mode</span>
<a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a><span class="w">    </span><span class="c1">// simply use the last frame&#39;s transform (velocity) to predict the map points in this frame.</span>
<a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a><span class="w">    </span><span class="n">UpdateLastFrame</span><span class="p">();</span>
<a id="__codelineno-39-9" name="__codelineno-39-9" href="#__codelineno-39-9"></a>
<a id="__codelineno-39-10" name="__codelineno-39-10" href="#__codelineno-39-10"></a><span class="w">    </span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">SetPose</span><span class="p">(</span><span class="n">mVelocity</span><span class="o">*</span><span class="n">mLastFrame</span><span class="p">.</span><span class="n">mTcw</span><span class="p">);</span>
<a id="__codelineno-39-11" name="__codelineno-39-11" href="#__codelineno-39-11"></a>
<a id="__codelineno-39-12" name="__codelineno-39-12" href="#__codelineno-39-12"></a><span class="w">    </span><span class="n">fill</span><span class="p">(</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mvpMapPoints</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mvpMapPoints</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
<a id="__codelineno-39-13" name="__codelineno-39-13" href="#__codelineno-39-13"></a>
<a id="__codelineno-39-14" name="__codelineno-39-14" href="#__codelineno-39-14"></a><span class="w">    </span><span class="c1">// Project points seen in previous frame</span>
<a id="__codelineno-39-15" name="__codelineno-39-15" href="#__codelineno-39-15"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">th</span><span class="p">;</span>
<a id="__codelineno-39-16" name="__codelineno-39-16" href="#__codelineno-39-16"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mSensor</span><span class="o">!=</span><span class="n">System</span><span class="o">::</span><span class="n">STEREO</span><span class="p">)</span>
<a id="__codelineno-39-17" name="__codelineno-39-17" href="#__codelineno-39-17"></a><span class="w">        </span><span class="n">th</span><span class="o">=</span><span class="mi">15</span><span class="p">;</span><span class="w"> </span>
<a id="__codelineno-39-18" name="__codelineno-39-18" href="#__codelineno-39-18"></a><span class="w">    </span><span class="k">else</span>
<a id="__codelineno-39-19" name="__codelineno-39-19" href="#__codelineno-39-19"></a><span class="w">        </span><span class="n">th</span><span class="o">=</span><span class="mi">7</span><span class="p">;</span>
<a id="__codelineno-39-20" name="__codelineno-39-20" href="#__codelineno-39-20"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nmatches</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">matcher</span><span class="p">.</span><span class="n">SearchByProjection</span><span class="p">(</span><span class="n">mCurrentFrame</span><span class="p">,</span><span class="n">mLastFrame</span><span class="p">,</span><span class="n">th</span><span class="p">,</span><span class="n">mSensor</span><span class="o">==</span><span class="n">System</span><span class="o">::</span><span class="n">MONOCULAR</span><span class="p">);</span>
<a id="__codelineno-39-21" name="__codelineno-39-21" href="#__codelineno-39-21"></a>
<a id="__codelineno-39-22" name="__codelineno-39-22" href="#__codelineno-39-22"></a><span class="w">    </span><span class="c1">// If few matches, uses a wider window search</span>
<a id="__codelineno-39-23" name="__codelineno-39-23" href="#__codelineno-39-23"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">nmatches</span><span class="o">&lt;</span><span class="mi">20</span><span class="p">)</span>
<a id="__codelineno-39-24" name="__codelineno-39-24" href="#__codelineno-39-24"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-39-25" name="__codelineno-39-25" href="#__codelineno-39-25"></a><span class="w">        </span><span class="n">fill</span><span class="p">(</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mvpMapPoints</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mvpMapPoints</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
<a id="__codelineno-39-26" name="__codelineno-39-26" href="#__codelineno-39-26"></a><span class="w">        </span><span class="n">nmatches</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">matcher</span><span class="p">.</span><span class="n">SearchByProjection</span><span class="p">(</span><span class="n">mCurrentFrame</span><span class="p">,</span><span class="n">mLastFrame</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">th</span><span class="p">,</span><span class="n">mSensor</span><span class="o">==</span><span class="n">System</span><span class="o">::</span><span class="n">MONOCULAR</span><span class="p">);</span>
<a id="__codelineno-39-27" name="__codelineno-39-27" href="#__codelineno-39-27"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-39-28" name="__codelineno-39-28" href="#__codelineno-39-28"></a>
<a id="__codelineno-39-29" name="__codelineno-39-29" href="#__codelineno-39-29"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">nmatches</span><span class="o">&lt;</span><span class="mi">20</span><span class="p">)</span>
<a id="__codelineno-39-30" name="__codelineno-39-30" href="#__codelineno-39-30"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-39-31" name="__codelineno-39-31" href="#__codelineno-39-31"></a>
<a id="__codelineno-39-32" name="__codelineno-39-32" href="#__codelineno-39-32"></a><span class="w">    </span><span class="c1">// Optimize frame pose with all matches</span>
<a id="__codelineno-39-33" name="__codelineno-39-33" href="#__codelineno-39-33"></a><span class="w">    </span><span class="n">Optimizer</span><span class="o">::</span><span class="n">PoseOptimization</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mCurrentFrame</span><span class="p">);</span>
<a id="__codelineno-39-34" name="__codelineno-39-34" href="#__codelineno-39-34"></a>
<a id="__codelineno-39-35" name="__codelineno-39-35" href="#__codelineno-39-35"></a><span class="w">    </span><span class="c1">// Discard outliers</span>
<a id="__codelineno-39-36" name="__codelineno-39-36" href="#__codelineno-39-36"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nmatchesMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-39-37" name="__codelineno-39-37" href="#__codelineno-39-37"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-39-38" name="__codelineno-39-38" href="#__codelineno-39-38"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-39-39" name="__codelineno-39-39" href="#__codelineno-39-39"></a><span class="w">        </span><span class="p">...</span><span class="w"> </span><span class="c1">// remove outliers</span>
<a id="__codelineno-39-40" name="__codelineno-39-40" href="#__codelineno-39-40"></a><span class="w">    </span><span class="p">}</span><span class="w">    </span>
<a id="__codelineno-39-41" name="__codelineno-39-41" href="#__codelineno-39-41"></a>
<a id="__codelineno-39-42" name="__codelineno-39-42" href="#__codelineno-39-42"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mbOnlyTracking</span><span class="p">)</span>
<a id="__codelineno-39-43" name="__codelineno-39-43" href="#__codelineno-39-43"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-39-44" name="__codelineno-39-44" href="#__codelineno-39-44"></a><span class="w">        </span><span class="n">mbVO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nmatchesMap</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">;</span>
<a id="__codelineno-39-45" name="__codelineno-39-45" href="#__codelineno-39-45"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">nmatches</span><span class="o">&gt;</span><span class="mi">20</span><span class="p">;</span>
<a id="__codelineno-39-46" name="__codelineno-39-46" href="#__codelineno-39-46"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-39-47" name="__codelineno-39-47" href="#__codelineno-39-47"></a>
<a id="__codelineno-39-48" name="__codelineno-39-48" href="#__codelineno-39-48"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">nmatchesMap</span><span class="o">&gt;=</span><span class="mi">10</span><span class="p">;</span>
<a id="__codelineno-39-49" name="__codelineno-39-49" href="#__codelineno-39-49"></a><span class="p">}</span>
<a id="__codelineno-39-50" name="__codelineno-39-50" href="#__codelineno-39-50"></a>
<a id="__codelineno-39-51" name="__codelineno-39-51" href="#__codelineno-39-51"></a><span class="kt">bool</span><span class="w"> </span><span class="nf">Tracking::TrackReferenceKeyFrame</span><span class="p">()</span>
<a id="__codelineno-39-52" name="__codelineno-39-52" href="#__codelineno-39-52"></a><span class="p">{</span>
<a id="__codelineno-39-53" name="__codelineno-39-53" href="#__codelineno-39-53"></a><span class="w">    </span><span class="c1">// Compute Bag of Words vector</span>
<a id="__codelineno-39-54" name="__codelineno-39-54" href="#__codelineno-39-54"></a><span class="w">    </span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">ComputeBoW</span><span class="p">();</span>
<a id="__codelineno-39-55" name="__codelineno-39-55" href="#__codelineno-39-55"></a>
<a id="__codelineno-39-56" name="__codelineno-39-56" href="#__codelineno-39-56"></a><span class="w">    </span><span class="c1">// We perform first an ORB matching with the reference keyframe</span>
<a id="__codelineno-39-57" name="__codelineno-39-57" href="#__codelineno-39-57"></a><span class="w">    </span><span class="c1">// If enough matches are found we setup a PnP solver</span>
<a id="__codelineno-39-58" name="__codelineno-39-58" href="#__codelineno-39-58"></a><span class="w">    </span><span class="n">ORBmatcher</span><span class="w"> </span><span class="n">matcher</span><span class="p">(</span><span class="mf">0.7</span><span class="p">,</span><span class="nb">true</span><span class="p">);</span>
<a id="__codelineno-39-59" name="__codelineno-39-59" href="#__codelineno-39-59"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">vpMapPointMatches</span><span class="p">;</span>
<a id="__codelineno-39-60" name="__codelineno-39-60" href="#__codelineno-39-60"></a>
<a id="__codelineno-39-61" name="__codelineno-39-61" href="#__codelineno-39-61"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nmatches</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">matcher</span><span class="p">.</span><span class="n">SearchByBoW</span><span class="p">(</span><span class="n">mpReferenceKF</span><span class="p">,</span><span class="n">mCurrentFrame</span><span class="p">,</span><span class="n">vpMapPointMatches</span><span class="p">);</span>
<a id="__codelineno-39-62" name="__codelineno-39-62" href="#__codelineno-39-62"></a>
<a id="__codelineno-39-63" name="__codelineno-39-63" href="#__codelineno-39-63"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">nmatches</span><span class="o">&lt;</span><span class="mi">15</span><span class="p">)</span>
<a id="__codelineno-39-64" name="__codelineno-39-64" href="#__codelineno-39-64"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-39-65" name="__codelineno-39-65" href="#__codelineno-39-65"></a>
<a id="__codelineno-39-66" name="__codelineno-39-66" href="#__codelineno-39-66"></a><span class="w">    </span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mvpMapPoints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vpMapPointMatches</span><span class="p">;</span>
<a id="__codelineno-39-67" name="__codelineno-39-67" href="#__codelineno-39-67"></a><span class="w">    </span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">SetPose</span><span class="p">(</span><span class="n">mLastFrame</span><span class="p">.</span><span class="n">mTcw</span><span class="p">);</span>
<a id="__codelineno-39-68" name="__codelineno-39-68" href="#__codelineno-39-68"></a>
<a id="__codelineno-39-69" name="__codelineno-39-69" href="#__codelineno-39-69"></a><span class="w">    </span><span class="n">Optimizer</span><span class="o">::</span><span class="n">PoseOptimization</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mCurrentFrame</span><span class="p">);</span>
<a id="__codelineno-39-70" name="__codelineno-39-70" href="#__codelineno-39-70"></a>
<a id="__codelineno-39-71" name="__codelineno-39-71" href="#__codelineno-39-71"></a><span class="w">    </span><span class="c1">// Discard outliers</span>
<a id="__codelineno-39-72" name="__codelineno-39-72" href="#__codelineno-39-72"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nmatchesMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-39-73" name="__codelineno-39-73" href="#__codelineno-39-73"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-39-74" name="__codelineno-39-74" href="#__codelineno-39-74"></a><span class="w">        </span><span class="p">...</span><span class="w"> </span><span class="c1">// remove outliers</span>
<a id="__codelineno-39-75" name="__codelineno-39-75" href="#__codelineno-39-75"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-39-76" name="__codelineno-39-76" href="#__codelineno-39-76"></a>
<a id="__codelineno-39-77" name="__codelineno-39-77" href="#__codelineno-39-77"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">nmatchesMap</span><span class="o">&gt;=</span><span class="mi">10</span><span class="p">;</span>
<a id="__codelineno-39-78" name="__codelineno-39-78" href="#__codelineno-39-78"></a><span class="p">}</span>
</code></pre></div>
<p><code>Relocalization()</code> happens when tracking is lost.
First, it find some keyframes that share observed features by <code>DetectRelocalizationCandidates(...)</code>.
If the number of shared feature is greater than <span class="arithmatex">\(15\)</span>, build <code>new PnPsolver(mCurrentFrame,vvpMapPointMatches[i]);</code> for the keyframes. 
Record the number of to be PnP solved keyrames as <code>nCandidates</code>.</p>
<p>For these shared-feature keyframes, run <code>pSolver-&gt;iterate(5,bNoMore,vbInliers,nInliers);</code> that runs five times RANSAC to update camera pose and find inliers (by checking projection error).`1</p>
<p>Check the number of match points, if having too few match points, run <code>SearchByProjection(...)</code> to obtain more feature points to match.</p>
<p>Finally, perform <code>Optimizer::PoseOptimization(&amp;mCurrentFrame);</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="kt">bool</span><span class="w"> </span><span class="nf">Tracking::Relocalization</span><span class="p">()</span>
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="p">{</span>
<a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="w">    </span><span class="c1">// Compute Bag of Words Vector</span>
<a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a><span class="w">    </span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">ComputeBoW</span><span class="p">();</span>
<a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a>
<a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a><span class="w">    </span><span class="c1">// Relocalization is performed when tracking is lost</span>
<a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a><span class="w">    </span><span class="c1">// Track Lost: Query KeyFrame Database for keyframe candidates for relocalisation</span>
<a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">vpCandidateKFs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mpKeyFrameDB</span><span class="o">-&gt;</span><span class="n">DetectRelocalizationCandidates</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mCurrentFrame</span><span class="p">);</span>
<a id="__codelineno-40-9" name="__codelineno-40-9" href="#__codelineno-40-9"></a>
<a id="__codelineno-40-10" name="__codelineno-40-10" href="#__codelineno-40-10"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">vpCandidateKFs</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
<a id="__codelineno-40-11" name="__codelineno-40-11" href="#__codelineno-40-11"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-40-12" name="__codelineno-40-12" href="#__codelineno-40-12"></a>
<a id="__codelineno-40-13" name="__codelineno-40-13" href="#__codelineno-40-13"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nKFs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vpCandidateKFs</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<a id="__codelineno-40-14" name="__codelineno-40-14" href="#__codelineno-40-14"></a>
<a id="__codelineno-40-15" name="__codelineno-40-15" href="#__codelineno-40-15"></a><span class="w">    </span><span class="c1">// We perform first an ORB matching with each candidate</span>
<a id="__codelineno-40-16" name="__codelineno-40-16" href="#__codelineno-40-16"></a><span class="w">    </span><span class="c1">// If enough matches are found we setup a PnP solver</span>
<a id="__codelineno-40-17" name="__codelineno-40-17" href="#__codelineno-40-17"></a><span class="w">    </span><span class="n">ORBmatcher</span><span class="w"> </span><span class="n">matcher</span><span class="p">(</span><span class="mf">0.75</span><span class="p">,</span><span class="nb">true</span><span class="p">);</span>
<a id="__codelineno-40-18" name="__codelineno-40-18" href="#__codelineno-40-18"></a>
<a id="__codelineno-40-19" name="__codelineno-40-19" href="#__codelineno-40-19"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">PnPsolver</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">vpPnPsolvers</span><span class="p">;</span>
<a id="__codelineno-40-20" name="__codelineno-40-20" href="#__codelineno-40-20"></a><span class="w">    </span><span class="n">vpPnPsolvers</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">nKFs</span><span class="p">);</span>
<a id="__codelineno-40-21" name="__codelineno-40-21" href="#__codelineno-40-21"></a>
<a id="__codelineno-40-22" name="__codelineno-40-22" href="#__codelineno-40-22"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vvpMapPointMatches</span><span class="p">;</span>
<a id="__codelineno-40-23" name="__codelineno-40-23" href="#__codelineno-40-23"></a><span class="w">    </span><span class="n">vvpMapPointMatches</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">nKFs</span><span class="p">);</span>
<a id="__codelineno-40-24" name="__codelineno-40-24" href="#__codelineno-40-24"></a>
<a id="__codelineno-40-25" name="__codelineno-40-25" href="#__codelineno-40-25"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vbDiscarded</span><span class="p">;</span>
<a id="__codelineno-40-26" name="__codelineno-40-26" href="#__codelineno-40-26"></a><span class="w">    </span><span class="n">vbDiscarded</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">nKFs</span><span class="p">);</span>
<a id="__codelineno-40-27" name="__codelineno-40-27" href="#__codelineno-40-27"></a>
<a id="__codelineno-40-28" name="__codelineno-40-28" href="#__codelineno-40-28"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nCandidates</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-40-29" name="__codelineno-40-29" href="#__codelineno-40-29"></a>
<a id="__codelineno-40-30" name="__codelineno-40-30" href="#__codelineno-40-30"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">nKFs</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-40-31" name="__codelineno-40-31" href="#__codelineno-40-31"></a><span class="w">        </span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pKF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vpCandidateKFs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-40-32" name="__codelineno-40-32" href="#__codelineno-40-32"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">isBad</span><span class="p">())</span>
<a id="__codelineno-40-33" name="__codelineno-40-33" href="#__codelineno-40-33"></a><span class="w">            </span><span class="n">vbDiscarded</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<a id="__codelineno-40-34" name="__codelineno-40-34" href="#__codelineno-40-34"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-40-35" name="__codelineno-40-35" href="#__codelineno-40-35"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">nmatches</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">matcher</span><span class="p">.</span><span class="n">SearchByBoW</span><span class="p">(</span><span class="n">pKF</span><span class="p">,</span><span class="n">mCurrentFrame</span><span class="p">,</span><span class="n">vvpMapPointMatches</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<a id="__codelineno-40-36" name="__codelineno-40-36" href="#__codelineno-40-36"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">nmatches</span><span class="o">&lt;</span><span class="mi">15</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-40-37" name="__codelineno-40-37" href="#__codelineno-40-37"></a><span class="w">                </span><span class="n">vbDiscarded</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<a id="__codelineno-40-38" name="__codelineno-40-38" href="#__codelineno-40-38"></a><span class="w">                </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-40-39" name="__codelineno-40-39" href="#__codelineno-40-39"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-40-40" name="__codelineno-40-40" href="#__codelineno-40-40"></a><span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-40-41" name="__codelineno-40-41" href="#__codelineno-40-41"></a><span class="w">                </span><span class="n">PnPsolver</span><span class="o">*</span><span class="w"> </span><span class="n">pSolver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PnPsolver</span><span class="p">(</span><span class="n">mCurrentFrame</span><span class="p">,</span><span class="n">vvpMapPointMatches</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<a id="__codelineno-40-42" name="__codelineno-40-42" href="#__codelineno-40-42"></a><span class="w">                </span><span class="n">pSolver</span><span class="o">-&gt;</span><span class="n">SetRansacParameters</span><span class="p">(</span><span class="mf">0.99</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">300</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">5.991</span><span class="p">);</span>
<a id="__codelineno-40-43" name="__codelineno-40-43" href="#__codelineno-40-43"></a><span class="w">                </span><span class="n">vpPnPsolvers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pSolver</span><span class="p">;</span>
<a id="__codelineno-40-44" name="__codelineno-40-44" href="#__codelineno-40-44"></a><span class="w">                </span><span class="n">nCandidates</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-40-45" name="__codelineno-40-45" href="#__codelineno-40-45"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-40-46" name="__codelineno-40-46" href="#__codelineno-40-46"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-40-47" name="__codelineno-40-47" href="#__codelineno-40-47"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-40-48" name="__codelineno-40-48" href="#__codelineno-40-48"></a>
<a id="__codelineno-40-49" name="__codelineno-40-49" href="#__codelineno-40-49"></a><span class="w">    </span><span class="c1">// Alternatively perform some iterations of P4P RANSAC</span>
<a id="__codelineno-40-50" name="__codelineno-40-50" href="#__codelineno-40-50"></a><span class="w">    </span><span class="c1">// Until we found a camera pose supported by enough inliers</span>
<a id="__codelineno-40-51" name="__codelineno-40-51" href="#__codelineno-40-51"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">bMatch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-40-52" name="__codelineno-40-52" href="#__codelineno-40-52"></a><span class="w">    </span><span class="n">ORBmatcher</span><span class="w"> </span><span class="n">matcher2</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span><span class="nb">true</span><span class="p">);</span>
<a id="__codelineno-40-53" name="__codelineno-40-53" href="#__codelineno-40-53"></a>
<a id="__codelineno-40-54" name="__codelineno-40-54" href="#__codelineno-40-54"></a><span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="n">nCandidates</span><span class="o">&gt;</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">bMatch</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-40-55" name="__codelineno-40-55" href="#__codelineno-40-55"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">nKFs</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-40-56" name="__codelineno-40-56" href="#__codelineno-40-56"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">vbDiscarded</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<a id="__codelineno-40-57" name="__codelineno-40-57" href="#__codelineno-40-57"></a><span class="w">                </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-40-58" name="__codelineno-40-58" href="#__codelineno-40-58"></a>
<a id="__codelineno-40-59" name="__codelineno-40-59" href="#__codelineno-40-59"></a><span class="w">            </span><span class="c1">// Perform 5 Ransac Iterations</span>
<a id="__codelineno-40-60" name="__codelineno-40-60" href="#__codelineno-40-60"></a><span class="w">            </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vbInliers</span><span class="p">;</span>
<a id="__codelineno-40-61" name="__codelineno-40-61" href="#__codelineno-40-61"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">nInliers</span><span class="p">;</span>
<a id="__codelineno-40-62" name="__codelineno-40-62" href="#__codelineno-40-62"></a><span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="n">bNoMore</span><span class="p">;</span>
<a id="__codelineno-40-63" name="__codelineno-40-63" href="#__codelineno-40-63"></a>
<a id="__codelineno-40-64" name="__codelineno-40-64" href="#__codelineno-40-64"></a><span class="w">            </span><span class="n">PnPsolver</span><span class="o">*</span><span class="w"> </span><span class="n">pSolver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vpPnPsolvers</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-40-65" name="__codelineno-40-65" href="#__codelineno-40-65"></a><span class="w">            </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">Tcw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pSolver</span><span class="o">-&gt;</span><span class="n">iterate</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="n">bNoMore</span><span class="p">,</span><span class="n">vbInliers</span><span class="p">,</span><span class="n">nInliers</span><span class="p">);</span>
<a id="__codelineno-40-66" name="__codelineno-40-66" href="#__codelineno-40-66"></a>
<a id="__codelineno-40-67" name="__codelineno-40-67" href="#__codelineno-40-67"></a><span class="w">            </span><span class="c1">// If Ransac reachs max. iterations discard keyframe</span>
<a id="__codelineno-40-68" name="__codelineno-40-68" href="#__codelineno-40-68"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">bNoMore</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-40-69" name="__codelineno-40-69" href="#__codelineno-40-69"></a><span class="w">                </span><span class="n">vbDiscarded</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="nb">true</span><span class="p">;</span>
<a id="__codelineno-40-70" name="__codelineno-40-70" href="#__codelineno-40-70"></a><span class="w">                </span><span class="n">nCandidates</span><span class="o">--</span><span class="p">;</span>
<a id="__codelineno-40-71" name="__codelineno-40-71" href="#__codelineno-40-71"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-40-72" name="__codelineno-40-72" href="#__codelineno-40-72"></a>
<a id="__codelineno-40-73" name="__codelineno-40-73" href="#__codelineno-40-73"></a><span class="w">            </span><span class="c1">// If a Camera Pose is computed, optimize</span>
<a id="__codelineno-40-74" name="__codelineno-40-74" href="#__codelineno-40-74"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">Tcw</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-40-75" name="__codelineno-40-75" href="#__codelineno-40-75"></a><span class="w">                </span><span class="n">Tcw</span><span class="p">.</span><span class="n">copyTo</span><span class="p">(</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mTcw</span><span class="p">);</span>
<a id="__codelineno-40-76" name="__codelineno-40-76" href="#__codelineno-40-76"></a>
<a id="__codelineno-40-77" name="__codelineno-40-77" href="#__codelineno-40-77"></a><span class="w">                </span><span class="n">set</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">sFound</span><span class="p">;</span>
<a id="__codelineno-40-78" name="__codelineno-40-78" href="#__codelineno-40-78"></a>
<a id="__codelineno-40-79" name="__codelineno-40-79" href="#__codelineno-40-79"></a><span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vbInliers</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<a id="__codelineno-40-80" name="__codelineno-40-80" href="#__codelineno-40-80"></a>
<a id="__codelineno-40-81" name="__codelineno-40-81" href="#__codelineno-40-81"></a><span class="w">                </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;</span><span class="n">np</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-40-82" name="__codelineno-40-82" href="#__codelineno-40-82"></a><span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="n">vbInliers</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-40-83" name="__codelineno-40-83" href="#__codelineno-40-83"></a><span class="w">                        </span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mvpMapPoints</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">vvpMapPointMatches</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
<a id="__codelineno-40-84" name="__codelineno-40-84" href="#__codelineno-40-84"></a><span class="w">                        </span><span class="n">sFound</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">vvpMapPointMatches</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]);</span>
<a id="__codelineno-40-85" name="__codelineno-40-85" href="#__codelineno-40-85"></a><span class="w">                    </span><span class="p">}</span>
<a id="__codelineno-40-86" name="__codelineno-40-86" href="#__codelineno-40-86"></a><span class="w">                    </span><span class="k">else</span>
<a id="__codelineno-40-87" name="__codelineno-40-87" href="#__codelineno-40-87"></a><span class="w">                        </span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mvpMapPoints</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
<a id="__codelineno-40-88" name="__codelineno-40-88" href="#__codelineno-40-88"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-40-89" name="__codelineno-40-89" href="#__codelineno-40-89"></a>
<a id="__codelineno-40-90" name="__codelineno-40-90" href="#__codelineno-40-90"></a><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">nGood</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Optimizer</span><span class="o">::</span><span class="n">PoseOptimization</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mCurrentFrame</span><span class="p">);</span>
<a id="__codelineno-40-91" name="__codelineno-40-91" href="#__codelineno-40-91"></a>
<a id="__codelineno-40-92" name="__codelineno-40-92" href="#__codelineno-40-92"></a><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">nGood</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">)</span>
<a id="__codelineno-40-93" name="__codelineno-40-93" href="#__codelineno-40-93"></a><span class="w">                    </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-40-94" name="__codelineno-40-94" href="#__codelineno-40-94"></a>
<a id="__codelineno-40-95" name="__codelineno-40-95" href="#__codelineno-40-95"></a><span class="w">                </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">io</span><span class="o">&lt;</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">io</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-40-96" name="__codelineno-40-96" href="#__codelineno-40-96"></a><span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mvbOutlier</span><span class="p">[</span><span class="n">io</span><span class="p">])</span>
<a id="__codelineno-40-97" name="__codelineno-40-97" href="#__codelineno-40-97"></a><span class="w">                        </span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mvpMapPoints</span><span class="p">[</span><span class="n">io</span><span class="p">]</span><span class="o">=</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<a id="__codelineno-40-98" name="__codelineno-40-98" href="#__codelineno-40-98"></a>
<a id="__codelineno-40-99" name="__codelineno-40-99" href="#__codelineno-40-99"></a><span class="w">                </span><span class="c1">// If few inliers, search by projection in a coarse window and optimize again</span>
<a id="__codelineno-40-100" name="__codelineno-40-100" href="#__codelineno-40-100"></a><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">nGood</span><span class="o">&lt;</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-40-101" name="__codelineno-40-101" href="#__codelineno-40-101"></a><span class="w">                    </span><span class="p">...</span><span class="w"> </span><span class="c1">// some logics to include more feature points, by then perform pose optimization</span>
<a id="__codelineno-40-102" name="__codelineno-40-102" href="#__codelineno-40-102"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-40-103" name="__codelineno-40-103" href="#__codelineno-40-103"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-40-104" name="__codelineno-40-104" href="#__codelineno-40-104"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-40-105" name="__codelineno-40-105" href="#__codelineno-40-105"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-40-106" name="__codelineno-40-106" href="#__codelineno-40-106"></a>
<a id="__codelineno-40-107" name="__codelineno-40-107" href="#__codelineno-40-107"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">bMatch</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-40-108" name="__codelineno-40-108" href="#__codelineno-40-108"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-40-109" name="__codelineno-40-109" href="#__codelineno-40-109"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-40-110" name="__codelineno-40-110" href="#__codelineno-40-110"></a><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-40-111" name="__codelineno-40-111" href="#__codelineno-40-111"></a><span class="w">        </span><span class="n">mnLastRelocFrameId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mnId</span><span class="p">;</span>
<a id="__codelineno-40-112" name="__codelineno-40-112" href="#__codelineno-40-112"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<a id="__codelineno-40-113" name="__codelineno-40-113" href="#__codelineno-40-113"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-40-114" name="__codelineno-40-114" href="#__codelineno-40-114"></a>
<a id="__codelineno-40-115" name="__codelineno-40-115" href="#__codelineno-40-115"></a><span class="p">}</span>
</code></pre></div>
<p>Having obtained camera pose estimate and some tracked map points, update local map's points</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="kt">bool</span><span class="w"> </span><span class="nf">Tracking::TrackLocalMap</span><span class="p">()</span>
<a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="p">{</span>
<a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="w">    </span><span class="c1">// We have an estimation of the camera pose and some map points tracked in the frame.</span>
<a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a><span class="w">    </span><span class="c1">// We retrieve the local map and try to find matches to points in the local map.</span>
<a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a><span class="w">    </span><span class="n">UpdateLocalMap</span><span class="p">();</span>
<a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a>
<a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a><span class="w">    </span><span class="n">SearchLocalPoints</span><span class="p">();</span>
<a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a>
<a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a><span class="w">    </span><span class="c1">// Optimize Pose</span>
<a id="__codelineno-41-10" name="__codelineno-41-10" href="#__codelineno-41-10"></a><span class="w">    </span><span class="n">Optimizer</span><span class="o">::</span><span class="n">PoseOptimization</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mCurrentFrame</span><span class="p">);</span>
<a id="__codelineno-41-11" name="__codelineno-41-11" href="#__codelineno-41-11"></a><span class="w">    </span><span class="n">mnMatchesInliers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-41-12" name="__codelineno-41-12" href="#__codelineno-41-12"></a>
<a id="__codelineno-41-13" name="__codelineno-41-13" href="#__codelineno-41-13"></a><span class="w">    </span><span class="c1">// Update MapPoints Statistics</span>
<a id="__codelineno-41-14" name="__codelineno-41-14" href="#__codelineno-41-14"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-41-15" name="__codelineno-41-15" href="#__codelineno-41-15"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-41-16" name="__codelineno-41-16" href="#__codelineno-41-16"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mvpMapPoints</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<a id="__codelineno-41-17" name="__codelineno-41-17" href="#__codelineno-41-17"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-41-18" name="__codelineno-41-18" href="#__codelineno-41-18"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mvbOutlier</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<a id="__codelineno-41-19" name="__codelineno-41-19" href="#__codelineno-41-19"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-41-20" name="__codelineno-41-20" href="#__codelineno-41-20"></a><span class="w">                </span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mvpMapPoints</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">IncreaseFound</span><span class="p">();</span>
<a id="__codelineno-41-21" name="__codelineno-41-21" href="#__codelineno-41-21"></a><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">mbOnlyTracking</span><span class="p">)</span>
<a id="__codelineno-41-22" name="__codelineno-41-22" href="#__codelineno-41-22"></a><span class="w">                </span><span class="p">{</span>
<a id="__codelineno-41-23" name="__codelineno-41-23" href="#__codelineno-41-23"></a><span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mvpMapPoints</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">Observations</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-41-24" name="__codelineno-41-24" href="#__codelineno-41-24"></a><span class="w">                        </span><span class="n">mnMatchesInliers</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-41-25" name="__codelineno-41-25" href="#__codelineno-41-25"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-41-26" name="__codelineno-41-26" href="#__codelineno-41-26"></a><span class="w">                </span><span class="k">else</span>
<a id="__codelineno-41-27" name="__codelineno-41-27" href="#__codelineno-41-27"></a><span class="w">                    </span><span class="n">mnMatchesInliers</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-41-28" name="__codelineno-41-28" href="#__codelineno-41-28"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-41-29" name="__codelineno-41-29" href="#__codelineno-41-29"></a><span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">mSensor</span><span class="o">==</span><span class="n">System</span><span class="o">::</span><span class="n">STEREO</span><span class="p">)</span>
<a id="__codelineno-41-30" name="__codelineno-41-30" href="#__codelineno-41-30"></a><span class="w">                </span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mvpMapPoints</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<a id="__codelineno-41-31" name="__codelineno-41-31" href="#__codelineno-41-31"></a>
<a id="__codelineno-41-32" name="__codelineno-41-32" href="#__codelineno-41-32"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-41-33" name="__codelineno-41-33" href="#__codelineno-41-33"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-41-34" name="__codelineno-41-34" href="#__codelineno-41-34"></a>
<a id="__codelineno-41-35" name="__codelineno-41-35" href="#__codelineno-41-35"></a><span class="w">    </span><span class="c1">// Decide if the tracking was succesful</span>
<a id="__codelineno-41-36" name="__codelineno-41-36" href="#__codelineno-41-36"></a><span class="w">    </span><span class="c1">// More restrictive if there was a relocalization recently</span>
<a id="__codelineno-41-37" name="__codelineno-41-37" href="#__codelineno-41-37"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mnId</span><span class="o">&lt;</span><span class="n">mnLastRelocFrameId</span><span class="o">+</span><span class="n">mMaxFrames</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mnMatchesInliers</span><span class="o">&lt;</span><span class="mi">50</span><span class="p">)</span>
<a id="__codelineno-41-38" name="__codelineno-41-38" href="#__codelineno-41-38"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-41-39" name="__codelineno-41-39" href="#__codelineno-41-39"></a>
<a id="__codelineno-41-40" name="__codelineno-41-40" href="#__codelineno-41-40"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mnMatchesInliers</span><span class="o">&lt;</span><span class="mi">30</span><span class="p">)</span>
<a id="__codelineno-41-41" name="__codelineno-41-41" href="#__codelineno-41-41"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-41-42" name="__codelineno-41-42" href="#__codelineno-41-42"></a><span class="w">    </span><span class="k">else</span>
<a id="__codelineno-41-43" name="__codelineno-41-43" href="#__codelineno-41-43"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<a id="__codelineno-41-44" name="__codelineno-41-44" href="#__codelineno-41-44"></a><span class="p">}</span>
</code></pre></div>
<p>where <code>UpdateLocalMap();</code> does the below tasks:
* <code>UpdateLocalKeyFrames()</code> stores the pointers of relevent keyframes: nearby keyframes and co-visibility keyframes that are likely forming a consistent local map
* <code>mvpLocalMapPoints()</code> stores all above obtained keyframes' map points to the local map</p>
<p><code>SearchLocalPoints()</code> iterates all current frame map points as well as above found local map points, then does <code>pMP-&gt;IncreaseVisible();</code>, which marks the points are clearly presented in the local map.
In local mapping, there is <code>if(pMP-&gt;GetFoundRatio()&lt;0.25f )</code> that removes map points if points' "visibility" is low.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="n">UpdateLocalKeyFrames</span><span class="p">()</span>
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="p">{</span>
<a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a><span class="w">    </span><span class="c1">// Each map point of the current keyframe votes for the keyframes in which it has been observed.</span>
<a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">map</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*</span><span class="p">,</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">observations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">GetObservations</span><span class="p">();</span>
<a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">map</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*</span><span class="p">,</span><span class="kt">size_t</span><span class="o">&gt;::</span><span class="n">const_iterator</span><span class="w"> </span><span class="n">it</span><span class="o">=</span><span class="n">observations</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">itend</span><span class="o">=</span><span class="n">observations</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="o">!=</span><span class="n">itend</span><span class="p">;</span><span class="w"> </span><span class="n">it</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a><span class="w">        </span><span class="n">keyframeCounter</span><span class="p">[</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a>
<a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a>
<a id="__codelineno-42-9" name="__codelineno-42-9" href="#__codelineno-42-9"></a><span class="w">    </span><span class="c1">// All keyframes that observe a map point are included in the local map. </span>
<a id="__codelineno-42-10" name="__codelineno-42-10" href="#__codelineno-42-10"></a><span class="w">    </span><span class="c1">// Also check which keyframe shares most points</span>
<a id="__codelineno-42-11" name="__codelineno-42-11" href="#__codelineno-42-11"></a><span class="w">    </span><span class="n">mvpLocalKeyFrames</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<a id="__codelineno-42-12" name="__codelineno-42-12" href="#__codelineno-42-12"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">map</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*</span><span class="p">,</span><span class="kt">int</span><span class="o">&gt;::</span><span class="n">const_iterator</span><span class="w"> </span><span class="n">it</span><span class="o">=</span><span class="n">keyframeCounter</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">itEnd</span><span class="o">=</span><span class="n">keyframeCounter</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="o">!=</span><span class="n">itEnd</span><span class="p">;</span><span class="w"> </span><span class="n">it</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-42-13" name="__codelineno-42-13" href="#__codelineno-42-13"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-42-14" name="__codelineno-42-14" href="#__codelineno-42-14"></a><span class="w">        </span><span class="n">mvpLocalKeyFrames</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">);</span>
<a id="__codelineno-42-15" name="__codelineno-42-15" href="#__codelineno-42-15"></a><span class="w">        </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">mnTrackReferenceForFrame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mnId</span><span class="p">;</span>
<a id="__codelineno-42-16" name="__codelineno-42-16" href="#__codelineno-42-16"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-42-17" name="__codelineno-42-17" href="#__codelineno-42-17"></a>
<a id="__codelineno-42-18" name="__codelineno-42-18" href="#__codelineno-42-18"></a>
<a id="__codelineno-42-19" name="__codelineno-42-19" href="#__codelineno-42-19"></a><span class="w">    </span><span class="c1">// Include also some not-already-included keyframes that are neighbors to already-included keyframes</span>
<a id="__codelineno-42-20" name="__codelineno-42-20" href="#__codelineno-42-20"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;::</span><span class="n">const_iterator</span><span class="w"> </span><span class="n">itKF</span><span class="o">=</span><span class="n">mvpLocalKeyFrames</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">itEndKF</span><span class="o">=</span><span class="n">mvpLocalKeyFrames</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">itKF</span><span class="o">!=</span><span class="n">itEndKF</span><span class="p">;</span><span class="w"> </span><span class="n">itKF</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-42-21" name="__codelineno-42-21" href="#__codelineno-42-21"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-42-22" name="__codelineno-42-22" href="#__codelineno-42-22"></a><span class="w">        </span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pKF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">itKF</span><span class="p">;</span>
<a id="__codelineno-42-23" name="__codelineno-42-23" href="#__codelineno-42-23"></a>
<a id="__codelineno-42-24" name="__codelineno-42-24" href="#__codelineno-42-24"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">vNeighs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">GetBestCovisibilityKeyFrames</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<a id="__codelineno-42-25" name="__codelineno-42-25" href="#__codelineno-42-25"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;::</span><span class="n">const_iterator</span><span class="w"> </span><span class="n">itNeighKF</span><span class="o">=</span><span class="n">vNeighs</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">itEndNeighKF</span><span class="o">=</span><span class="n">vNeighs</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">itNeighKF</span><span class="o">!=</span><span class="n">itEndNeighKF</span><span class="p">;</span><span class="w"> </span><span class="n">itNeighKF</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-42-26" name="__codelineno-42-26" href="#__codelineno-42-26"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-42-27" name="__codelineno-42-27" href="#__codelineno-42-27"></a><span class="w">            </span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pNeighKF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">itNeighKF</span><span class="p">;</span>
<a id="__codelineno-42-28" name="__codelineno-42-28" href="#__codelineno-42-28"></a><span class="w">            </span><span class="n">mvpLocalKeyFrames</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pNeighKF</span><span class="p">);</span>
<a id="__codelineno-42-29" name="__codelineno-42-29" href="#__codelineno-42-29"></a><span class="w">            </span><span class="n">pNeighKF</span><span class="o">-&gt;</span><span class="n">mnTrackReferenceForFrame</span><span class="o">=</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mnId</span><span class="p">;</span>
<a id="__codelineno-42-30" name="__codelineno-42-30" href="#__codelineno-42-30"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-42-31" name="__codelineno-42-31" href="#__codelineno-42-31"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-42-32" name="__codelineno-42-32" href="#__codelineno-42-32"></a>
<a id="__codelineno-42-33" name="__codelineno-42-33" href="#__codelineno-42-33"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">set</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">spChilds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">GetChilds</span><span class="p">();</span>
<a id="__codelineno-42-34" name="__codelineno-42-34" href="#__codelineno-42-34"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">set</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;::</span><span class="n">const_iterator</span><span class="w"> </span><span class="n">sit</span><span class="o">=</span><span class="n">spChilds</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">send</span><span class="o">=</span><span class="n">spChilds</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">sit</span><span class="o">!=</span><span class="n">send</span><span class="p">;</span><span class="w"> </span><span class="n">sit</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-42-35" name="__codelineno-42-35" href="#__codelineno-42-35"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-42-36" name="__codelineno-42-36" href="#__codelineno-42-36"></a><span class="w">            </span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pChildKF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">sit</span><span class="p">;</span>
<a id="__codelineno-42-37" name="__codelineno-42-37" href="#__codelineno-42-37"></a><span class="w">            </span><span class="n">mvpLocalKeyFrames</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pChildKF</span><span class="p">);</span>
<a id="__codelineno-42-38" name="__codelineno-42-38" href="#__codelineno-42-38"></a><span class="w">            </span><span class="n">pChildKF</span><span class="o">-&gt;</span><span class="n">mnTrackReferenceForFrame</span><span class="o">=</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mnId</span><span class="p">;</span>
<a id="__codelineno-42-39" name="__codelineno-42-39" href="#__codelineno-42-39"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-42-40" name="__codelineno-42-40" href="#__codelineno-42-40"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-42-41" name="__codelineno-42-41" href="#__codelineno-42-41"></a>
<a id="__codelineno-42-42" name="__codelineno-42-42" href="#__codelineno-42-42"></a><span class="w">        </span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pParent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">GetParent</span><span class="p">();</span>
<a id="__codelineno-42-43" name="__codelineno-42-43" href="#__codelineno-42-43"></a><span class="w">        </span><span class="n">mvpLocalKeyFrames</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pParent</span><span class="p">);</span>
<a id="__codelineno-42-44" name="__codelineno-42-44" href="#__codelineno-42-44"></a><span class="w">        </span><span class="n">pParent</span><span class="o">-&gt;</span><span class="n">mnTrackReferenceForFrame</span><span class="o">=</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mnId</span><span class="p">;</span>
<a id="__codelineno-42-45" name="__codelineno-42-45" href="#__codelineno-42-45"></a><span class="w">    </span><span class="p">}</span><span class="w">   </span>
<a id="__codelineno-42-46" name="__codelineno-42-46" href="#__codelineno-42-46"></a><span class="p">}</span>
<a id="__codelineno-42-47" name="__codelineno-42-47" href="#__codelineno-42-47"></a>
<a id="__codelineno-42-48" name="__codelineno-42-48" href="#__codelineno-42-48"></a>
<a id="__codelineno-42-49" name="__codelineno-42-49" href="#__codelineno-42-49"></a><span class="kt">void</span><span class="w"> </span><span class="n">Tracking</span><span class="o">::</span><span class="n">UpdateLocalPoints</span><span class="p">()</span>
<a id="__codelineno-42-50" name="__codelineno-42-50" href="#__codelineno-42-50"></a><span class="p">{</span>
<a id="__codelineno-42-51" name="__codelineno-42-51" href="#__codelineno-42-51"></a><span class="w">    </span><span class="n">mvpLocalMapPoints</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<a id="__codelineno-42-52" name="__codelineno-42-52" href="#__codelineno-42-52"></a>
<a id="__codelineno-42-53" name="__codelineno-42-53" href="#__codelineno-42-53"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;::</span><span class="n">const_iterator</span><span class="w"> </span><span class="n">itKF</span><span class="o">=</span><span class="n">mvpLocalKeyFrames</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">itEndKF</span><span class="o">=</span><span class="n">mvpLocalKeyFrames</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">itKF</span><span class="o">!=</span><span class="n">itEndKF</span><span class="p">;</span><span class="w"> </span><span class="n">itKF</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-42-54" name="__codelineno-42-54" href="#__codelineno-42-54"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-42-55" name="__codelineno-42-55" href="#__codelineno-42-55"></a><span class="w">        </span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pKF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">itKF</span><span class="p">;</span>
<a id="__codelineno-42-56" name="__codelineno-42-56" href="#__codelineno-42-56"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">vpMPs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">GetMapPointMatches</span><span class="p">();</span>
<a id="__codelineno-42-57" name="__codelineno-42-57" href="#__codelineno-42-57"></a>
<a id="__codelineno-42-58" name="__codelineno-42-58" href="#__codelineno-42-58"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;::</span><span class="n">const_iterator</span><span class="w"> </span><span class="n">itMP</span><span class="o">=</span><span class="n">vpMPs</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">itEndMP</span><span class="o">=</span><span class="n">vpMPs</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">itMP</span><span class="o">!=</span><span class="n">itEndMP</span><span class="p">;</span><span class="w"> </span><span class="n">itMP</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-42-59" name="__codelineno-42-59" href="#__codelineno-42-59"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-42-60" name="__codelineno-42-60" href="#__codelineno-42-60"></a><span class="w">            </span><span class="n">MapPoint</span><span class="o">*</span><span class="w"> </span><span class="n">pMP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">itMP</span><span class="p">;</span>
<a id="__codelineno-42-61" name="__codelineno-42-61" href="#__codelineno-42-61"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">pMP</span><span class="p">)</span>
<a id="__codelineno-42-62" name="__codelineno-42-62" href="#__codelineno-42-62"></a><span class="w">                </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-42-63" name="__codelineno-42-63" href="#__codelineno-42-63"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">mnTrackReferenceForFrame</span><span class="o">==</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mnId</span><span class="p">)</span>
<a id="__codelineno-42-64" name="__codelineno-42-64" href="#__codelineno-42-64"></a><span class="w">                </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-42-65" name="__codelineno-42-65" href="#__codelineno-42-65"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">isBad</span><span class="p">())</span>
<a id="__codelineno-42-66" name="__codelineno-42-66" href="#__codelineno-42-66"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-42-67" name="__codelineno-42-67" href="#__codelineno-42-67"></a><span class="w">                </span><span class="n">mvpLocalMapPoints</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pMP</span><span class="p">);</span>
<a id="__codelineno-42-68" name="__codelineno-42-68" href="#__codelineno-42-68"></a><span class="w">                </span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">mnTrackReferenceForFrame</span><span class="o">=</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mnId</span><span class="p">;</span>
<a id="__codelineno-42-69" name="__codelineno-42-69" href="#__codelineno-42-69"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-42-70" name="__codelineno-42-70" href="#__codelineno-42-70"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-42-71" name="__codelineno-42-71" href="#__codelineno-42-71"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-42-72" name="__codelineno-42-72" href="#__codelineno-42-72"></a><span class="p">}</span>
<a id="__codelineno-42-73" name="__codelineno-42-73" href="#__codelineno-42-73"></a>
<a id="__codelineno-42-74" name="__codelineno-42-74" href="#__codelineno-42-74"></a>
<a id="__codelineno-42-75" name="__codelineno-42-75" href="#__codelineno-42-75"></a><span class="kt">void</span><span class="w"> </span><span class="n">Tracking</span><span class="o">::</span><span class="n">SearchLocalPoints</span><span class="p">()</span>
<a id="__codelineno-42-76" name="__codelineno-42-76" href="#__codelineno-42-76"></a><span class="p">{</span>
<a id="__codelineno-42-77" name="__codelineno-42-77" href="#__codelineno-42-77"></a><span class="w">    </span><span class="c1">// Do not search map points already matched</span>
<a id="__codelineno-42-78" name="__codelineno-42-78" href="#__codelineno-42-78"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">vit</span><span class="o">=</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mvpMapPoints</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">vend</span><span class="o">=</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mvpMapPoints</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">vit</span><span class="o">!=</span><span class="n">vend</span><span class="p">;</span><span class="w"> </span><span class="n">vit</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-42-79" name="__codelineno-42-79" href="#__codelineno-42-79"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-42-80" name="__codelineno-42-80" href="#__codelineno-42-80"></a><span class="w">        </span><span class="n">MapPoint</span><span class="o">*</span><span class="w"> </span><span class="n">pMP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">vit</span><span class="p">;</span>
<a id="__codelineno-42-81" name="__codelineno-42-81" href="#__codelineno-42-81"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">pMP</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-42-82" name="__codelineno-42-82" href="#__codelineno-42-82"></a><span class="w">            </span><span class="p">...</span><span class="w"> </span><span class="c1">// remove bad points</span>
<a id="__codelineno-42-83" name="__codelineno-42-83" href="#__codelineno-42-83"></a><span class="w">            </span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">IncreaseVisible</span><span class="p">();</span>
<a id="__codelineno-42-84" name="__codelineno-42-84" href="#__codelineno-42-84"></a><span class="w">            </span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">mnLastFrameSeen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">mnId</span><span class="p">;</span>
<a id="__codelineno-42-85" name="__codelineno-42-85" href="#__codelineno-42-85"></a><span class="w">            </span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">mbTrackInView</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-42-86" name="__codelineno-42-86" href="#__codelineno-42-86"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-42-87" name="__codelineno-42-87" href="#__codelineno-42-87"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-42-88" name="__codelineno-42-88" href="#__codelineno-42-88"></a>
<a id="__codelineno-42-89" name="__codelineno-42-89" href="#__codelineno-42-89"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nToMatch</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-42-90" name="__codelineno-42-90" href="#__codelineno-42-90"></a>
<a id="__codelineno-42-91" name="__codelineno-42-91" href="#__codelineno-42-91"></a><span class="w">    </span><span class="c1">// Project points in frame and check its visibility</span>
<a id="__codelineno-42-92" name="__codelineno-42-92" href="#__codelineno-42-92"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">vit</span><span class="o">=</span><span class="n">mvpLocalMapPoints</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">vend</span><span class="o">=</span><span class="n">mvpLocalMapPoints</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">vit</span><span class="o">!=</span><span class="n">vend</span><span class="p">;</span><span class="w"> </span><span class="n">vit</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-42-93" name="__codelineno-42-93" href="#__codelineno-42-93"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-42-94" name="__codelineno-42-94" href="#__codelineno-42-94"></a><span class="w">        </span><span class="n">MapPoint</span><span class="o">*</span><span class="w"> </span><span class="n">pMP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">vit</span><span class="p">;</span>
<a id="__codelineno-42-95" name="__codelineno-42-95" href="#__codelineno-42-95"></a><span class="w">        </span><span class="p">...</span><span class="w"> </span><span class="c1">// bad point checking</span>
<a id="__codelineno-42-96" name="__codelineno-42-96" href="#__codelineno-42-96"></a><span class="w">        </span><span class="c1">// Project (this fills MapPoint variables for matching)</span>
<a id="__codelineno-42-97" name="__codelineno-42-97" href="#__codelineno-42-97"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">mCurrentFrame</span><span class="p">.</span><span class="n">isInFrustum</span><span class="p">(</span><span class="n">pMP</span><span class="p">,</span><span class="mf">0.5</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-42-98" name="__codelineno-42-98" href="#__codelineno-42-98"></a><span class="w">            </span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">IncreaseVisible</span><span class="p">();</span>
<a id="__codelineno-42-99" name="__codelineno-42-99" href="#__codelineno-42-99"></a><span class="w">            </span><span class="n">nToMatch</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-42-100" name="__codelineno-42-100" href="#__codelineno-42-100"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-42-101" name="__codelineno-42-101" href="#__codelineno-42-101"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-42-102" name="__codelineno-42-102" href="#__codelineno-42-102"></a><span class="p">}</span>
</code></pre></div>
<h2 id="bundle-adjustment">Bundle Adjustment</h2>
<h3 id="global-bundle-adjustment">Global Bundle Adjustment</h3>
<p>Global bundle adjustment simply takes all keyframes and map points to perform bundle adjustment</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">Optimizer::GlobalBundleAdjustemnt</span><span class="p">(</span><span class="n">Map</span><span class="o">*</span><span class="w"> </span><span class="n">pMap</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nIterations</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="o">*</span><span class="w"> </span><span class="n">pbStopFlag</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">nLoopKF</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">bRobust</span><span class="p">)</span>
<a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="p">{</span>
<a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">vpKFs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pMap</span><span class="o">-&gt;</span><span class="n">GetAllKeyFrames</span><span class="p">();</span>
<a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">vpMP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pMap</span><span class="o">-&gt;</span><span class="n">GetAllMapPoints</span><span class="p">();</span>
<a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a><span class="w">    </span><span class="n">BundleAdjustment</span><span class="p">(</span><span class="n">vpKFs</span><span class="p">,</span><span class="n">vpMP</span><span class="p">,</span><span class="n">nIterations</span><span class="p">,</span><span class="n">pbStopFlag</span><span class="p">,</span><span class="w"> </span><span class="n">nLoopKF</span><span class="p">,</span><span class="w"> </span><span class="n">bRobust</span><span class="p">);</span>
<a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a><span class="p">}</span>
</code></pre></div>
<p>From keyframes <code>vpKFs</code> extract poses <span class="arithmatex">\(\mathbf{\xi}_j\)</span> and add them to G2O optimizer <code>optimizer.addVertex(vSE3);</code>;
from world map 3d points <code>vpMP</code> extract points <span class="arithmatex">\(\mathbf{p}_i\)</span> and add them to G2O optimizer <code>optimizer.addVertex(vPoint);</code>.
The edge/error is defined in <code>g2o::EdgeSE3ProjectXYZ* e</code> which is a binary edge linking a keyframe camera pose <code>vSE3-&gt;setId(pKF-&gt;mnId);</code> and a map point <code>const int id = pMP-&gt;mnId+maxKFid+1; vPoint-&gt;setId(id);</code>.
Only keyframes' observed map points are added (map points are extracted from <code>const map&lt;KeyFrame*,size_t&gt; observations = pMP-&gt;GetObservations();</code> that maps between keyframes and observed map points).</p>
<p>In particular, <code>vSE3-&gt;setFixed(pKF-&gt;mnId==0);</code> means the first keyframe is fixed that the pose does not get optimized.</p>
<p>Noted here map points are set <code>vPoint-&gt;setMarginalized(true);</code>.
In short, bundle adjustment only adjusts camera poses and the map points are computed/transformed as the result of the finished poses, hence map points are called "marginalized out".</p>
<div class="arithmatex">\[
\mathbf{x}=\big[
    \underbrace{[\mathbf{R}|\mathbf{t}]_1, [\mathbf{R}|\mathbf{t}]_2, ..., [\mathbf{R}|\mathbf{t}]_n, }_{\text{camera transform }\mathbf{\xi}_{j}}
    \underbrace{\mathbf{p}_{1}, \mathbf{p}_{2}, ..., \mathbf{p}_{m} }_{\text{map point }\mathbf{p}_i}
\big]
\]</div>
<p>An error/edge can be defined as below, where <span class="arithmatex">\(\mathbf{z}_{ij}\)</span> is the observation (image pixel/feature point) and <span class="arithmatex">\(\pi\)</span> is the projection mapping that transform the world points to the corresponding camera image pixel coordinates.</p>
<div class="arithmatex">\[
\mathbf{e}_{ij} = \mathbf{z}_{ij} - \pi(\mathbf{\xi}_j \mathbf{p}_i)
\]</div>
<p>The total error <span class="arithmatex">\(\mathbf{e}\)</span> to be minimized can be approximated by first-order derivative.</p>
<div class="arithmatex">\[
\begin{align*}
\frac{1}{2} \big|\big|
    \mathbf{e}(\mathbf{x}+\Delta\mathbf{x})
\big|\big|^2
&amp;\approx
\frac{1}{2} \sum^n_{i=1} \sum^m_{j=1} 
\big|\big|
    \mathbf{e}_{ij} + \mathbf{F}_{ij}\Delta\mathbf{\xi}_i + \mathbf{E}_{ij} \Delta \mathbf{p}_j
\big|\big|
\\\\ &amp;\approx
\frac{1}{2} \big|\big|
    \mathbf{e} + \mathbf{F}\Delta\mathbf{x}_{\mathbf{\xi}} + \mathbf{E}\Delta\mathbf{x}_{\mathbf{p}}
\big|\big|^2
\end{align*}
\]</div>
<p>The Jacobian can be computed as below</p>
<div class="arithmatex">\[
\begin{align*}
\mathbf{J}^\text{T} \mathbf{J} &amp;= 
\begin{bmatrix}
    \mathbf{F}^\text{T} \mathbf{F} &amp; \mathbf{F}^\text{T} \mathbf{E} \\\\
    \mathbf{E}^\text{T} \mathbf{F} &amp; \mathbf{E}^\text{T} \mathbf{E} \\\\
\end{bmatrix}
\overset{\Delta}{=}
\begin{bmatrix}
    \mathbf{B} &amp; \mathbf{E} \\\\
    \mathbf{E}^\text{T} &amp; \mathbf{C}
\end{bmatrix}
\qquad \text{rewrite variable notation }\mathbf{E}:=\mathbf{F}^\text{T} \mathbf{E}
\\\\ &amp;=
\sum^n_{i=1} \sum^m_{j=1} 
\mathbf{J}^\text{T}_{ij} \mathbf{J}_{ij}
\end{align*}
\]</div>
<p>By optimization, the optimal <span class="arithmatex">\(\mathbf{x}^*\)</span> can be approached by <span class="arithmatex">\(\mathbf{x}^* = \mathbf{x}_0 + \Delta\mathbf{x}\)</span>, 
and <span class="arithmatex">\(\mathbf{g}=[\mathbf{v} \quad \mathbf{w}]^\top\)</span> is the noises.</p>
<p>The camera pose convergence step <span class="arithmatex">\(\Delta \mathbf{x}_{\mathbf{\xi}}\)</span> can be computed by <em>Schur trick</em>.</p>
<div class="arithmatex">\[
\begin{align*}
&amp;&amp;
\mathbf{J}^\text{T} \mathbf{J} \mathbf{x} &amp;= \mathbf{g}
\\\\ &amp;&amp;
\begin{bmatrix}
    \mathbf{B} &amp; \mathbf{E} \\\\
    \mathbf{E}^\text{T} &amp; \mathbf{C}
\end{bmatrix}
\begin{bmatrix}
    \Delta \mathbf{x}_{\mathbf{\xi}} \\\\
    \Delta \mathbf{x}_{\mathbf{p}}
\end{bmatrix}&amp;=
\begin{bmatrix}
    \mathbf{v} \\\\
    \mathbf{w}
\end{bmatrix}
\\\\ \Rightarrow &amp;&amp;
(\mathbf{B}-\mathbf{E}\mathbf{C}^{-1}\mathbf{E}^\text{T})
\Delta \mathbf{x}_{\mathbf{\xi}}&amp;=
\mathbf{v} - \mathbf{E}\mathbf{C}^{-1} \mathbf{w}
\end{align*}
\]</div>
<p>Then, the map point convergence step can be computed by
<span class="arithmatex">\(\Delta \mathbf{x}_{\mathbf{p}}=\mathbf{C}^{-1}(\mathbf{w}-\mathbf{E}^\text{T} \Delta\mathbf{x}_{\mathbf{\xi}})\)</span></p>
<p>It can tell that <span class="arithmatex">\(\Delta \mathbf{x}_{\mathbf{p}}\)</span> is a computation result out of the finished <span class="arithmatex">\(\Delta\mathbf{x}_{\mathbf{\xi}}\)</span>.</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">Optimizer::BundleAdjustment</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vpKFs</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vpMP</span><span class="p">,</span>
<a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="w">                                 </span><span class="kt">int</span><span class="w"> </span><span class="n">nIterations</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="o">*</span><span class="w"> </span><span class="n">pbStopFlag</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">nLoopKF</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">bRobust</span><span class="p">)</span>
<a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a><span class="p">{</span>
<a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vbNotIncludedMP</span><span class="p">;</span>
<a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a><span class="w">    </span><span class="n">vbNotIncludedMP</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">vpMP</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
<a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a>
<a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a><span class="w">    </span><span class="n">g2o</span><span class="o">::</span><span class="n">SparseOptimizer</span><span class="w"> </span><span class="n">optimizer</span><span class="p">;</span>
<a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a><span class="w">    </span><span class="n">g2o</span><span class="o">::</span><span class="n">BlockSolver_6_3</span><span class="o">::</span><span class="n">LinearSolverType</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">linearSolver</span><span class="p">;</span>
<a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a><span class="w">    </span><span class="n">linearSolver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">g2o</span><span class="o">::</span><span class="n">LinearSolverEigen</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">BlockSolver_6_3</span><span class="o">::</span><span class="n">PoseMatrixType</span><span class="o">&gt;</span><span class="p">();</span>
<a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a><span class="w">    </span><span class="n">g2o</span><span class="o">::</span><span class="n">BlockSolver_6_3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">solver_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">g2o</span><span class="o">::</span><span class="n">BlockSolver_6_3</span><span class="p">(</span><span class="n">linearSolver</span><span class="p">);</span>
<a id="__codelineno-44-11" name="__codelineno-44-11" href="#__codelineno-44-11"></a><span class="w">    </span><span class="n">g2o</span><span class="o">::</span><span class="n">OptimizationAlgorithmLevenberg</span><span class="o">*</span><span class="w"> </span><span class="n">solver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">g2o</span><span class="o">::</span><span class="n">OptimizationAlgorithmLevenberg</span><span class="p">(</span><span class="n">solver_ptr</span><span class="p">);</span>
<a id="__codelineno-44-12" name="__codelineno-44-12" href="#__codelineno-44-12"></a><span class="w">    </span><span class="n">optimizer</span><span class="p">.</span><span class="n">setAlgorithm</span><span class="p">(</span><span class="n">solver</span><span class="p">);</span>
<a id="__codelineno-44-13" name="__codelineno-44-13" href="#__codelineno-44-13"></a>
<a id="__codelineno-44-14" name="__codelineno-44-14" href="#__codelineno-44-14"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">pbStopFlag</span><span class="p">)</span>
<a id="__codelineno-44-15" name="__codelineno-44-15" href="#__codelineno-44-15"></a><span class="w">        </span><span class="n">optimizer</span><span class="p">.</span><span class="n">setForceStopFlag</span><span class="p">(</span><span class="n">pbStopFlag</span><span class="p">);</span>
<a id="__codelineno-44-16" name="__codelineno-44-16" href="#__codelineno-44-16"></a>
<a id="__codelineno-44-17" name="__codelineno-44-17" href="#__codelineno-44-17"></a><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">maxKFid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-44-18" name="__codelineno-44-18" href="#__codelineno-44-18"></a>
<a id="__codelineno-44-19" name="__codelineno-44-19" href="#__codelineno-44-19"></a><span class="w">    </span><span class="c1">// Set KeyFrame vertices</span>
<a id="__codelineno-44-20" name="__codelineno-44-20" href="#__codelineno-44-20"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">vpKFs</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-44-21" name="__codelineno-44-21" href="#__codelineno-44-21"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-44-22" name="__codelineno-44-22" href="#__codelineno-44-22"></a><span class="w">        </span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pKF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vpKFs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-44-23" name="__codelineno-44-23" href="#__codelineno-44-23"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">isBad</span><span class="p">())</span>
<a id="__codelineno-44-24" name="__codelineno-44-24" href="#__codelineno-44-24"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-44-25" name="__codelineno-44-25" href="#__codelineno-44-25"></a><span class="w">        </span><span class="n">g2o</span><span class="o">::</span><span class="n">VertexSE3Expmap</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">vSE3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">g2o</span><span class="o">::</span><span class="n">VertexSE3Expmap</span><span class="p">();</span>
<a id="__codelineno-44-26" name="__codelineno-44-26" href="#__codelineno-44-26"></a><span class="w">        </span><span class="n">vSE3</span><span class="o">-&gt;</span><span class="n">setEstimate</span><span class="p">(</span><span class="n">Converter</span><span class="o">::</span><span class="n">toSE3Quat</span><span class="p">(</span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">GetPose</span><span class="p">()));</span>
<a id="__codelineno-44-27" name="__codelineno-44-27" href="#__codelineno-44-27"></a><span class="w">        </span><span class="n">vSE3</span><span class="o">-&gt;</span><span class="n">setId</span><span class="p">(</span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="p">);</span>
<a id="__codelineno-44-28" name="__codelineno-44-28" href="#__codelineno-44-28"></a><span class="w">        </span><span class="n">vSE3</span><span class="o">-&gt;</span><span class="n">setFixed</span><span class="p">(</span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="o">==</span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-44-29" name="__codelineno-44-29" href="#__codelineno-44-29"></a><span class="w">        </span><span class="n">optimizer</span><span class="p">.</span><span class="n">addVertex</span><span class="p">(</span><span class="n">vSE3</span><span class="p">);</span>
<a id="__codelineno-44-30" name="__codelineno-44-30" href="#__codelineno-44-30"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="o">&gt;</span><span class="n">maxKFid</span><span class="p">)</span>
<a id="__codelineno-44-31" name="__codelineno-44-31" href="#__codelineno-44-31"></a><span class="w">            </span><span class="n">maxKFid</span><span class="o">=</span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="p">;</span>
<a id="__codelineno-44-32" name="__codelineno-44-32" href="#__codelineno-44-32"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-44-33" name="__codelineno-44-33" href="#__codelineno-44-33"></a>
<a id="__codelineno-44-34" name="__codelineno-44-34" href="#__codelineno-44-34"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">thHuber2D</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="mf">5.99</span><span class="p">);</span>
<a id="__codelineno-44-35" name="__codelineno-44-35" href="#__codelineno-44-35"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">thHuber3D</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="mf">7.815</span><span class="p">);</span>
<a id="__codelineno-44-36" name="__codelineno-44-36" href="#__codelineno-44-36"></a>
<a id="__codelineno-44-37" name="__codelineno-44-37" href="#__codelineno-44-37"></a><span class="w">    </span><span class="c1">// Set MapPoint vertices</span>
<a id="__codelineno-44-38" name="__codelineno-44-38" href="#__codelineno-44-38"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">vpMP</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-44-39" name="__codelineno-44-39" href="#__codelineno-44-39"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-44-40" name="__codelineno-44-40" href="#__codelineno-44-40"></a><span class="w">        </span><span class="n">MapPoint</span><span class="o">*</span><span class="w"> </span><span class="n">pMP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vpMP</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-44-41" name="__codelineno-44-41" href="#__codelineno-44-41"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">isBad</span><span class="p">())</span>
<a id="__codelineno-44-42" name="__codelineno-44-42" href="#__codelineno-44-42"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-44-43" name="__codelineno-44-43" href="#__codelineno-44-43"></a><span class="w">        </span><span class="n">g2o</span><span class="o">::</span><span class="n">VertexSBAPointXYZ</span><span class="o">*</span><span class="w"> </span><span class="n">vPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">g2o</span><span class="o">::</span><span class="n">VertexSBAPointXYZ</span><span class="p">();</span>
<a id="__codelineno-44-44" name="__codelineno-44-44" href="#__codelineno-44-44"></a><span class="w">        </span><span class="n">vPoint</span><span class="o">-&gt;</span><span class="n">setEstimate</span><span class="p">(</span><span class="n">Converter</span><span class="o">::</span><span class="n">toVector3d</span><span class="p">(</span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">GetWorldPos</span><span class="p">()));</span>
<a id="__codelineno-44-45" name="__codelineno-44-45" href="#__codelineno-44-45"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="o">+</span><span class="n">maxKFid</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-44-46" name="__codelineno-44-46" href="#__codelineno-44-46"></a><span class="w">        </span><span class="n">vPoint</span><span class="o">-&gt;</span><span class="n">setId</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
<a id="__codelineno-44-47" name="__codelineno-44-47" href="#__codelineno-44-47"></a><span class="w">        </span><span class="n">vPoint</span><span class="o">-&gt;</span><span class="n">setMarginalized</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<a id="__codelineno-44-48" name="__codelineno-44-48" href="#__codelineno-44-48"></a><span class="w">        </span><span class="n">optimizer</span><span class="p">.</span><span class="n">addVertex</span><span class="p">(</span><span class="n">vPoint</span><span class="p">);</span>
<a id="__codelineno-44-49" name="__codelineno-44-49" href="#__codelineno-44-49"></a>
<a id="__codelineno-44-50" name="__codelineno-44-50" href="#__codelineno-44-50"></a><span class="w">        </span><span class="c1">// Keyframes observing the point and associated index in keyframe</span>
<a id="__codelineno-44-51" name="__codelineno-44-51" href="#__codelineno-44-51"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">map</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*</span><span class="p">,</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">observations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">GetObservations</span><span class="p">();</span>
<a id="__codelineno-44-52" name="__codelineno-44-52" href="#__codelineno-44-52"></a>
<a id="__codelineno-44-53" name="__codelineno-44-53" href="#__codelineno-44-53"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">nEdges</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-44-54" name="__codelineno-44-54" href="#__codelineno-44-54"></a><span class="w">        </span><span class="c1">//SET EDGES</span>
<a id="__codelineno-44-55" name="__codelineno-44-55" href="#__codelineno-44-55"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">map</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*</span><span class="p">,</span><span class="kt">size_t</span><span class="o">&gt;::</span><span class="n">const_iterator</span><span class="w"> </span><span class="n">mit</span><span class="o">=</span><span class="n">observations</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"> </span><span class="n">mit</span><span class="o">!=</span><span class="n">observations</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">mit</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-44-56" name="__codelineno-44-56" href="#__codelineno-44-56"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-44-57" name="__codelineno-44-57" href="#__codelineno-44-57"></a>
<a id="__codelineno-44-58" name="__codelineno-44-58" href="#__codelineno-44-58"></a><span class="w">            </span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pKF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mit</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">;</span>
<a id="__codelineno-44-59" name="__codelineno-44-59" href="#__codelineno-44-59"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">isBad</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="o">&gt;</span><span class="n">maxKFid</span><span class="p">)</span>
<a id="__codelineno-44-60" name="__codelineno-44-60" href="#__codelineno-44-60"></a><span class="w">                </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-44-61" name="__codelineno-44-61" href="#__codelineno-44-61"></a>
<a id="__codelineno-44-62" name="__codelineno-44-62" href="#__codelineno-44-62"></a><span class="w">            </span><span class="n">nEdges</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-44-63" name="__codelineno-44-63" href="#__codelineno-44-63"></a>
<a id="__codelineno-44-64" name="__codelineno-44-64" href="#__codelineno-44-64"></a><span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">KeyPoint</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kpUn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">mvKeysUn</span><span class="p">[</span><span class="n">mit</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">];</span>
<a id="__codelineno-44-65" name="__codelineno-44-65" href="#__codelineno-44-65"></a>
<a id="__codelineno-44-66" name="__codelineno-44-66" href="#__codelineno-44-66"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">mvuRight</span><span class="p">[</span><span class="n">mit</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-44-67" name="__codelineno-44-67" href="#__codelineno-44-67"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-44-68" name="__codelineno-44-68" href="#__codelineno-44-68"></a><span class="w">                </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">obs</span><span class="p">;</span>
<a id="__codelineno-44-69" name="__codelineno-44-69" href="#__codelineno-44-69"></a><span class="w">                </span><span class="n">obs</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">kpUn</span><span class="p">.</span><span class="n">pt</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">kpUn</span><span class="p">.</span><span class="n">pt</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<a id="__codelineno-44-70" name="__codelineno-44-70" href="#__codelineno-44-70"></a>
<a id="__codelineno-44-71" name="__codelineno-44-71" href="#__codelineno-44-71"></a><span class="w">                </span><span class="n">g2o</span><span class="o">::</span><span class="n">EdgeSE3ProjectXYZ</span><span class="o">*</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">g2o</span><span class="o">::</span><span class="n">EdgeSE3ProjectXYZ</span><span class="p">();</span>
<a id="__codelineno-44-72" name="__codelineno-44-72" href="#__codelineno-44-72"></a>
<a id="__codelineno-44-73" name="__codelineno-44-73" href="#__codelineno-44-73"></a><span class="w">                </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">setVertex</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">OptimizableGraph</span><span class="o">::</span><span class="n">Vertex</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">optimizer</span><span class="p">.</span><span class="n">vertex</span><span class="p">(</span><span class="n">id</span><span class="p">)));</span>
<a id="__codelineno-44-74" name="__codelineno-44-74" href="#__codelineno-44-74"></a><span class="w">                </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">setVertex</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">OptimizableGraph</span><span class="o">::</span><span class="n">Vertex</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">optimizer</span><span class="p">.</span><span class="n">vertex</span><span class="p">(</span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="p">)));</span>
<a id="__codelineno-44-75" name="__codelineno-44-75" href="#__codelineno-44-75"></a><span class="w">                </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">setMeasurement</span><span class="p">(</span><span class="n">obs</span><span class="p">);</span>
<a id="__codelineno-44-76" name="__codelineno-44-76" href="#__codelineno-44-76"></a><span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">&amp;</span><span class="n">invSigma2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">mvInvLevelSigma2</span><span class="p">[</span><span class="n">kpUn</span><span class="p">.</span><span class="n">octave</span><span class="p">];</span>
<a id="__codelineno-44-77" name="__codelineno-44-77" href="#__codelineno-44-77"></a><span class="w">                </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">setInformation</span><span class="p">(</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix2d</span><span class="o">::</span><span class="n">Identity</span><span class="p">()</span><span class="o">*</span><span class="n">invSigma2</span><span class="p">);</span>
<a id="__codelineno-44-78" name="__codelineno-44-78" href="#__codelineno-44-78"></a>
<a id="__codelineno-44-79" name="__codelineno-44-79" href="#__codelineno-44-79"></a><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">bRobust</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-44-80" name="__codelineno-44-80" href="#__codelineno-44-80"></a><span class="w">                    </span><span class="n">g2o</span><span class="o">::</span><span class="n">RobustKernelHuber</span><span class="o">*</span><span class="w"> </span><span class="n">rk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">g2o</span><span class="o">::</span><span class="n">RobustKernelHuber</span><span class="p">;</span>
<a id="__codelineno-44-81" name="__codelineno-44-81" href="#__codelineno-44-81"></a><span class="w">                    </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">setRobustKernel</span><span class="p">(</span><span class="n">rk</span><span class="p">);</span>
<a id="__codelineno-44-82" name="__codelineno-44-82" href="#__codelineno-44-82"></a><span class="w">                    </span><span class="n">rk</span><span class="o">-&gt;</span><span class="n">setDelta</span><span class="p">(</span><span class="n">thHuber2D</span><span class="p">);</span>
<a id="__codelineno-44-83" name="__codelineno-44-83" href="#__codelineno-44-83"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-44-84" name="__codelineno-44-84" href="#__codelineno-44-84"></a>
<a id="__codelineno-44-85" name="__codelineno-44-85" href="#__codelineno-44-85"></a><span class="w">                </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">fx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">fx</span><span class="p">;</span>
<a id="__codelineno-44-86" name="__codelineno-44-86" href="#__codelineno-44-86"></a><span class="w">                </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">fy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">fy</span><span class="p">;</span>
<a id="__codelineno-44-87" name="__codelineno-44-87" href="#__codelineno-44-87"></a><span class="w">                </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">cx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">cx</span><span class="p">;</span>
<a id="__codelineno-44-88" name="__codelineno-44-88" href="#__codelineno-44-88"></a><span class="w">                </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">cy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">cy</span><span class="p">;</span>
<a id="__codelineno-44-89" name="__codelineno-44-89" href="#__codelineno-44-89"></a>
<a id="__codelineno-44-90" name="__codelineno-44-90" href="#__codelineno-44-90"></a><span class="w">                </span><span class="n">optimizer</span><span class="p">.</span><span class="n">addEdge</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
<a id="__codelineno-44-91" name="__codelineno-44-91" href="#__codelineno-44-91"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-44-92" name="__codelineno-44-92" href="#__codelineno-44-92"></a><span class="w">            </span><span class="k">else</span>
<a id="__codelineno-44-93" name="__codelineno-44-93" href="#__codelineno-44-93"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-44-94" name="__codelineno-44-94" href="#__codelineno-44-94"></a><span class="w">                </span><span class="p">...</span><span class="w"> </span><span class="c1">// mono/stereo switch</span>
<a id="__codelineno-44-95" name="__codelineno-44-95" href="#__codelineno-44-95"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-44-96" name="__codelineno-44-96" href="#__codelineno-44-96"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-44-97" name="__codelineno-44-97" href="#__codelineno-44-97"></a>
<a id="__codelineno-44-98" name="__codelineno-44-98" href="#__codelineno-44-98"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">nEdges</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-44-99" name="__codelineno-44-99" href="#__codelineno-44-99"></a><span class="w">            </span><span class="n">optimizer</span><span class="p">.</span><span class="n">removeVertex</span><span class="p">(</span><span class="n">vPoint</span><span class="p">);</span>
<a id="__codelineno-44-100" name="__codelineno-44-100" href="#__codelineno-44-100"></a><span class="w">            </span><span class="n">vbNotIncludedMP</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="nb">true</span><span class="p">;</span>
<a id="__codelineno-44-101" name="__codelineno-44-101" href="#__codelineno-44-101"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-44-102" name="__codelineno-44-102" href="#__codelineno-44-102"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-44-103" name="__codelineno-44-103" href="#__codelineno-44-103"></a><span class="w">            </span><span class="n">vbNotIncludedMP</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-44-104" name="__codelineno-44-104" href="#__codelineno-44-104"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-44-105" name="__codelineno-44-105" href="#__codelineno-44-105"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-44-106" name="__codelineno-44-106" href="#__codelineno-44-106"></a>
<a id="__codelineno-44-107" name="__codelineno-44-107" href="#__codelineno-44-107"></a><span class="w">    </span><span class="c1">// Optimize!</span>
<a id="__codelineno-44-108" name="__codelineno-44-108" href="#__codelineno-44-108"></a><span class="w">    </span><span class="n">optimizer</span><span class="p">.</span><span class="n">initializeOptimization</span><span class="p">();</span>
<a id="__codelineno-44-109" name="__codelineno-44-109" href="#__codelineno-44-109"></a><span class="w">    </span><span class="n">optimizer</span><span class="p">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">nIterations</span><span class="p">);</span>
<a id="__codelineno-44-110" name="__codelineno-44-110" href="#__codelineno-44-110"></a>
<a id="__codelineno-44-111" name="__codelineno-44-111" href="#__codelineno-44-111"></a><span class="w">    </span><span class="c1">// Recover optimized data</span>
<a id="__codelineno-44-112" name="__codelineno-44-112" href="#__codelineno-44-112"></a><span class="w">    </span><span class="c1">//Keyframes</span>
<a id="__codelineno-44-113" name="__codelineno-44-113" href="#__codelineno-44-113"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">vpKFs</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-44-114" name="__codelineno-44-114" href="#__codelineno-44-114"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-44-115" name="__codelineno-44-115" href="#__codelineno-44-115"></a><span class="w">        </span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pKF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vpKFs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-44-116" name="__codelineno-44-116" href="#__codelineno-44-116"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">isBad</span><span class="p">())</span>
<a id="__codelineno-44-117" name="__codelineno-44-117" href="#__codelineno-44-117"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-44-118" name="__codelineno-44-118" href="#__codelineno-44-118"></a><span class="w">        </span><span class="n">g2o</span><span class="o">::</span><span class="n">VertexSE3Expmap</span><span class="o">*</span><span class="w"> </span><span class="n">vSE3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">VertexSE3Expmap</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">optimizer</span><span class="p">.</span><span class="n">vertex</span><span class="p">(</span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="p">));</span>
<a id="__codelineno-44-119" name="__codelineno-44-119" href="#__codelineno-44-119"></a><span class="w">        </span><span class="n">g2o</span><span class="o">::</span><span class="n">SE3Quat</span><span class="w"> </span><span class="n">SE3quat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vSE3</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">();</span>
<a id="__codelineno-44-120" name="__codelineno-44-120" href="#__codelineno-44-120"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">nLoopKF</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-44-121" name="__codelineno-44-121" href="#__codelineno-44-121"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-44-122" name="__codelineno-44-122" href="#__codelineno-44-122"></a><span class="w">            </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">SetPose</span><span class="p">(</span><span class="n">Converter</span><span class="o">::</span><span class="n">toCvMat</span><span class="p">(</span><span class="n">SE3quat</span><span class="p">));</span>
<a id="__codelineno-44-123" name="__codelineno-44-123" href="#__codelineno-44-123"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-44-124" name="__codelineno-44-124" href="#__codelineno-44-124"></a><span class="w">        </span><span class="k">else</span>
<a id="__codelineno-44-125" name="__codelineno-44-125" href="#__codelineno-44-125"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-44-126" name="__codelineno-44-126" href="#__codelineno-44-126"></a><span class="w">            </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">mTcwGBA</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">CV_32F</span><span class="p">);</span>
<a id="__codelineno-44-127" name="__codelineno-44-127" href="#__codelineno-44-127"></a><span class="w">            </span><span class="n">Converter</span><span class="o">::</span><span class="n">toCvMat</span><span class="p">(</span><span class="n">SE3quat</span><span class="p">).</span><span class="n">copyTo</span><span class="p">(</span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">mTcwGBA</span><span class="p">);</span>
<a id="__codelineno-44-128" name="__codelineno-44-128" href="#__codelineno-44-128"></a><span class="w">            </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">mnBAGlobalForKF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nLoopKF</span><span class="p">;</span>
<a id="__codelineno-44-129" name="__codelineno-44-129" href="#__codelineno-44-129"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-44-130" name="__codelineno-44-130" href="#__codelineno-44-130"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-44-131" name="__codelineno-44-131" href="#__codelineno-44-131"></a><span class="w">    </span><span class="c1">//Points</span>
<a id="__codelineno-44-132" name="__codelineno-44-132" href="#__codelineno-44-132"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">vpMP</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-44-133" name="__codelineno-44-133" href="#__codelineno-44-133"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-44-134" name="__codelineno-44-134" href="#__codelineno-44-134"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">vbNotIncludedMP</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<a id="__codelineno-44-135" name="__codelineno-44-135" href="#__codelineno-44-135"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-44-136" name="__codelineno-44-136" href="#__codelineno-44-136"></a>
<a id="__codelineno-44-137" name="__codelineno-44-137" href="#__codelineno-44-137"></a><span class="w">        </span><span class="n">MapPoint</span><span class="o">*</span><span class="w"> </span><span class="n">pMP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vpMP</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-44-138" name="__codelineno-44-138" href="#__codelineno-44-138"></a>
<a id="__codelineno-44-139" name="__codelineno-44-139" href="#__codelineno-44-139"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">isBad</span><span class="p">())</span>
<a id="__codelineno-44-140" name="__codelineno-44-140" href="#__codelineno-44-140"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-44-141" name="__codelineno-44-141" href="#__codelineno-44-141"></a><span class="w">        </span><span class="n">g2o</span><span class="o">::</span><span class="n">VertexSBAPointXYZ</span><span class="o">*</span><span class="w"> </span><span class="n">vPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">VertexSBAPointXYZ</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">optimizer</span><span class="p">.</span><span class="n">vertex</span><span class="p">(</span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="o">+</span><span class="n">maxKFid</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
<a id="__codelineno-44-142" name="__codelineno-44-142" href="#__codelineno-44-142"></a>
<a id="__codelineno-44-143" name="__codelineno-44-143" href="#__codelineno-44-143"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">nLoopKF</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-44-144" name="__codelineno-44-144" href="#__codelineno-44-144"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-44-145" name="__codelineno-44-145" href="#__codelineno-44-145"></a><span class="w">            </span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">SetWorldPos</span><span class="p">(</span><span class="n">Converter</span><span class="o">::</span><span class="n">toCvMat</span><span class="p">(</span><span class="n">vPoint</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">()));</span>
<a id="__codelineno-44-146" name="__codelineno-44-146" href="#__codelineno-44-146"></a><span class="w">            </span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">UpdateNormalAndDepth</span><span class="p">();</span>
<a id="__codelineno-44-147" name="__codelineno-44-147" href="#__codelineno-44-147"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-44-148" name="__codelineno-44-148" href="#__codelineno-44-148"></a><span class="w">        </span><span class="k">else</span>
<a id="__codelineno-44-149" name="__codelineno-44-149" href="#__codelineno-44-149"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-44-150" name="__codelineno-44-150" href="#__codelineno-44-150"></a><span class="w">            </span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">mPosGBA</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">CV_32F</span><span class="p">);</span>
<a id="__codelineno-44-151" name="__codelineno-44-151" href="#__codelineno-44-151"></a><span class="w">            </span><span class="n">Converter</span><span class="o">::</span><span class="n">toCvMat</span><span class="p">(</span><span class="n">vPoint</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">()).</span><span class="n">copyTo</span><span class="p">(</span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">mPosGBA</span><span class="p">);</span>
<a id="__codelineno-44-152" name="__codelineno-44-152" href="#__codelineno-44-152"></a><span class="w">            </span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">mnBAGlobalForKF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nLoopKF</span><span class="p">;</span>
<a id="__codelineno-44-153" name="__codelineno-44-153" href="#__codelineno-44-153"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-44-154" name="__codelineno-44-154" href="#__codelineno-44-154"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-44-155" name="__codelineno-44-155" href="#__codelineno-44-155"></a>
<a id="__codelineno-44-156" name="__codelineno-44-156" href="#__codelineno-44-156"></a><span class="p">}</span>
</code></pre></div>
where the edge/error is defined as the projection error <code>_error = obs-cam_project(v1-&gt;estimate().map(v2-&gt;estimate()));</code> projecting the camera pose transformed 3d map point to image pixel.</p>
<p>As a result, the Jacobian for the PnP problem is defined as <span class="arithmatex">\(\frac{\partial \mathbf{e}}{\partial \mathbf{p}} \frac{\partial \mathbf{p}}{\partial \Delta\mathbf{\xi}}\)</span>, where <span class="arithmatex">\(\Delta\mathbf{\xi}\)</span> is the convergence step to be optimized, while <span class="arithmatex">\(\mathbf{p}\)</span> are not optimized but recomputed every time <span class="arithmatex">\(\Delta\mathbf{\xi}\)</span> is adjusted.</p>
<p>Define a trivial perturbation as <span class="arithmatex">\(\delta\mathbf{\xi}\)</span>, set <span class="arithmatex">\(\mathbf{p}=[X \quad Y \quad Z]^\top\)</span> as the 3d map point estimate, by the rule of left perturbation multiplication in Lie algebra (operator denoted as <span class="arithmatex">\(\oplus\)</span>), and by the definition of chained derivative taking the limit <span class="arithmatex">\(\underset{\Delta\mathbf{\xi} \rightarrow 0}{\lim}\)</span>, there is</p>
<div class="arithmatex">\[
\begin{align*}
\frac{\partial \mathbf{e}}{\partial \Delta\mathbf{\xi}}&amp;=
\underset{\Delta\mathbf{\xi} \rightarrow 0}{\lim}
\frac{\mathbf{e}(\delta\mathbf{\xi} \oplus \mathbf{\xi})-\mathbf{e}(\mathbf{\xi})}{\Delta\mathbf{\xi}}
\\\\ &amp;=
\frac{\partial \mathbf{e}}{\partial \mathbf{p}}
\frac{\partial \mathbf{p}}{\partial \Delta\mathbf{\xi}}
\end{align*}
\]</div>
<p>where</p>
<p>$$
\begin{align*}
\frac{\partial \mathbf{e}}{\partial \mathbf{p}}&amp;= - \begin{bmatrix}
    \frac{\partial u}{\partial X} &amp;
    \frac{\partial u}{\partial Y} &amp;
    \frac{\partial u}{\partial Z} \\
    \frac{\partial v}{\partial X} &amp;
    \frac{\partial v}{\partial Y} &amp;
    \frac{\partial v}{\partial Z}
\end{bmatrix}
\\ &amp;= -   \frac{\partial (f_y \frac{Y}{Z} + c_y)}{\partial X} &amp;
    \frac{\partial (f_y \frac{Y}{Z} + c_y)}{\partial Y} &amp;
    \frac{\partial (f_y \frac{Y}{Z} + c_y)}{\partial Z}
\end{bmatrix}
\\ &amp;= - \begin{bmatrix}
    \frac{f_x}{Z} &amp; 0 &amp; -\frac{f_x X}{Z^2} \\
    0 &amp; \frac{f_y}{Z} &amp; -\frac{f_y Y}{Z^2} \\
\end{bmatrix}
\end{ - </p>
<p>and, this term <span class="arithmatex">\(\frac{\partial \mathbf{p}}{\partial \Delta\mathbf{\xi}}\)</span> is the derivative of the transformed point with respect to the Lie algebra such that</p>
<div class="arithmatex">\[
\begin{align*}
\frac{\partial \mathbf{p}}{\partial \Delta\mathbf{\xi}}&amp;=
\frac{\partial \mathbf{\xi} \mathbf{p}}{\partial \Delta\mathbf{\xi}}
\\\\ &amp;=
\begin{bmatrix}
    \mathbf{I} &amp; -\mathbf{p}^{\wedge} \\\\ 
    \mathbf{0} &amp; \mathbf{0}
\end{bmatrix}
\end{align*}
\]</div>
<p>where</p>
<div class="arithmatex">\[
\begin{align*}
\mathbf{p}^{\wedge}&amp;=
\begin{bmatrix}
    0 &amp; Z &amp; Y \\\\
    -Z &amp; 0 &amp; -X \\\\
    -Y &amp; X &amp; 0
\end{bmatrix}
\end{align*}
\]</div>
<p>Combined, and removed <span class="arithmatex">\(\mathbf{0}\)</span> from <span class="arithmatex">\(\frac{\partial \mathbf{p}}{\partial \Delta\mathbf{\xi}}\)</span>, there is</p>
<p>$$
\begin{align*}
\frac{\partial \mathbf{e}}{\partial \Delta\mathbf{\xi}}&amp;=
\frac{\partial \mathbf{e}}{\partial \mathbf{p}}
\frac{\partial \mathbf{p}}{\partial \Delta\mathbf{\xi}}
\\ &amp;= - \begin{bmatrix}
    \frac{f_x}{Z} &amp; 0 &amp; -\frac{f_x X}{Z^2} \\
    0 &amp; \frac{f_y}{Z} &amp; -\frac{f_y Y}{Z^2} \\
\end{bmatrix}
\begin{bmatrix}
    1 -   0 &amp; 1 &amp; 0 &amp; Z &amp; 0 &amp; X \\
    0 &amp; 0 &amp; 1 &amp; Y &amp; -X &amp; 0
\end{bmatrix}
\\ &amp;=
-\begin{bmatrix}
    \frac{f_x}{Z} &amp; 0 &amp; -\frac{f_x X}{Z^2} &amp;
    -\frac{f_x X Y}{Z^2} &amp; f_x + \frac{f_x X^2}{Z^2} &amp; -\frac{f_x Y}{Z}
    \\
    0 &amp; \frac{f_y}{Z} &amp; -\frac{f_y Y}{Z^2} &amp;
    -f_y - \frac{f_y Y^2}{Z^2} &amp; \frac{f_y YX'}{Z} &amp; \frac{f_y X}{Z}</p>
<p>\end{bmatrix}
\end{align*}
$$</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="k">class</span><span class="w">  </span><span class="nc">EdgeSE3ProjectXYZ</span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w">  </span><span class="n">BaseBinaryEdge</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">Vector2d</span><span class="p">,</span><span class="w"> </span><span class="n">VertexSBAPointXYZ</span><span class="p">,</span><span class="w"> </span><span class="n">VertexSE3Expmap</span><span class="o">&gt;</span><span class="p">{</span>
<a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="k">public</span><span class="o">:</span>
<a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="w">  </span><span class="n">EIGEN_MAKE_ALIGNED_OPERATOR_NEW</span>
<a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a>
<a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a><span class="w">  </span><span class="n">EdgeSE3ProjectXYZ</span><span class="p">();</span>
<a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a>
<a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a><span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="nf">read</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">istream</span><span class="o">&amp;</span><span class="w"> </span><span class="n">is</span><span class="p">);</span>
<a id="__codelineno-45-8" name="__codelineno-45-8" href="#__codelineno-45-8"></a>
<a id="__codelineno-45-9" name="__codelineno-45-9" href="#__codelineno-45-9"></a><span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="nf">write</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="n">os</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<a id="__codelineno-45-10" name="__codelineno-45-10" href="#__codelineno-45-10"></a>
<a id="__codelineno-45-11" name="__codelineno-45-11" href="#__codelineno-45-11"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">computeError</span><span class="p">()</span><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-45-12" name="__codelineno-45-12" href="#__codelineno-45-12"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VertexSE3Expmap</span><span class="o">*</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">VertexSE3Expmap</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">_vertices</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<a id="__codelineno-45-13" name="__codelineno-45-13" href="#__codelineno-45-13"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VertexSBAPointXYZ</span><span class="o">*</span><span class="w"> </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">VertexSBAPointXYZ</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">_vertices</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<a id="__codelineno-45-14" name="__codelineno-45-14" href="#__codelineno-45-14"></a><span class="w">    </span><span class="n">Vector2d</span><span class="w"> </span><span class="n">obs</span><span class="p">(</span><span class="n">_measurement</span><span class="p">);</span>
<a id="__codelineno-45-15" name="__codelineno-45-15" href="#__codelineno-45-15"></a><span class="w">    </span><span class="n">_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obs</span><span class="o">-</span><span class="n">cam_project</span><span class="p">(</span><span class="n">v1</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="n">v2</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">()));</span>
<a id="__codelineno-45-16" name="__codelineno-45-16" href="#__codelineno-45-16"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-45-17" name="__codelineno-45-17" href="#__codelineno-45-17"></a>
<a id="__codelineno-45-18" name="__codelineno-45-18" href="#__codelineno-45-18"></a><span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="nf">isDepthPositive</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-45-19" name="__codelineno-45-19" href="#__codelineno-45-19"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VertexSE3Expmap</span><span class="o">*</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">VertexSE3Expmap</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">_vertices</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<a id="__codelineno-45-20" name="__codelineno-45-20" href="#__codelineno-45-20"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VertexSBAPointXYZ</span><span class="o">*</span><span class="w"> </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">VertexSBAPointXYZ</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">_vertices</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<a id="__codelineno-45-21" name="__codelineno-45-21" href="#__codelineno-45-21"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">v1</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="n">v2</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">()))(</span><span class="mi">2</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.0</span><span class="p">;</span>
<a id="__codelineno-45-22" name="__codelineno-45-22" href="#__codelineno-45-22"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-45-23" name="__codelineno-45-23" href="#__codelineno-45-23"></a>
<a id="__codelineno-45-24" name="__codelineno-45-24" href="#__codelineno-45-24"></a>
<a id="__codelineno-45-25" name="__codelineno-45-25" href="#__codelineno-45-25"></a><span class="w">  </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">linearizeOplus</span><span class="p">();</span>
<a id="__codelineno-45-26" name="__codelineno-45-26" href="#__codelineno-45-26"></a>
<a id="__codelineno-45-27" name="__codelineno-45-27" href="#__codelineno-45-27"></a><span class="w">  </span><span class="n">Vector2d</span><span class="w"> </span><span class="nf">cam_project</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Vector3d</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">trans_xyz</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<a id="__codelineno-45-28" name="__codelineno-45-28" href="#__codelineno-45-28"></a>
<a id="__codelineno-45-29" name="__codelineno-45-29" href="#__codelineno-45-29"></a><span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">fx</span><span class="p">,</span><span class="w"> </span><span class="n">fy</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="n">cy</span><span class="p">;</span>
<a id="__codelineno-45-30" name="__codelineno-45-30" href="#__codelineno-45-30"></a><span class="p">};</span>
<a id="__codelineno-45-31" name="__codelineno-45-31" href="#__codelineno-45-31"></a>
<a id="__codelineno-45-32" name="__codelineno-45-32" href="#__codelineno-45-32"></a><span class="kt">void</span><span class="w"> </span><span class="nf">EdgeSE3ProjectXYZ::linearizeOplus</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-45-33" name="__codelineno-45-33" href="#__codelineno-45-33"></a><span class="w">  </span><span class="n">VertexSE3Expmap</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">vj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">VertexSE3Expmap</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">_vertices</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<a id="__codelineno-45-34" name="__codelineno-45-34" href="#__codelineno-45-34"></a><span class="w">  </span><span class="n">SE3Quat</span><span class="w"> </span><span class="n">T</span><span class="p">(</span><span class="n">vj</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">());</span>
<a id="__codelineno-45-35" name="__codelineno-45-35" href="#__codelineno-45-35"></a><span class="w">  </span><span class="n">VertexSBAPointXYZ</span><span class="o">*</span><span class="w"> </span><span class="n">vi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">VertexSBAPointXYZ</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">_vertices</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<a id="__codelineno-45-36" name="__codelineno-45-36" href="#__codelineno-45-36"></a><span class="w">  </span><span class="n">Vector3d</span><span class="w"> </span><span class="n">xyz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vi</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">();</span>
<a id="__codelineno-45-37" name="__codelineno-45-37" href="#__codelineno-45-37"></a><span class="w">  </span><span class="n">Vector3d</span><span class="w"> </span><span class="n">xyz_trans</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">xyz</span><span class="p">);</span>
<a id="__codelineno-45-38" name="__codelineno-45-38" href="#__codelineno-45-38"></a>
<a id="__codelineno-45-39" name="__codelineno-45-39" href="#__codelineno-45-39"></a><span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xyz_trans</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<a id="__codelineno-45-40" name="__codelineno-45-40" href="#__codelineno-45-40"></a><span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xyz_trans</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<a id="__codelineno-45-41" name="__codelineno-45-41" href="#__codelineno-45-41"></a><span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xyz_trans</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<a id="__codelineno-45-42" name="__codelineno-45-42" href="#__codelineno-45-42"></a><span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">z_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z</span><span class="o">*</span><span class="n">z</span><span class="p">;</span>
<a id="__codelineno-45-43" name="__codelineno-45-43" href="#__codelineno-45-43"></a>
<a id="__codelineno-45-44" name="__codelineno-45-44" href="#__codelineno-45-44"></a><span class="w">  </span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tmp</span><span class="p">;</span>
<a id="__codelineno-45-45" name="__codelineno-45-45" href="#__codelineno-45-45"></a><span class="w">  </span><span class="n">tmp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fx</span><span class="p">;</span>
<a id="__codelineno-45-46" name="__codelineno-45-46" href="#__codelineno-45-46"></a><span class="w">  </span><span class="n">tmp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-45-47" name="__codelineno-45-47" href="#__codelineno-45-47"></a><span class="w">  </span><span class="n">tmp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">x</span><span class="o">/</span><span class="n">z</span><span class="o">*</span><span class="n">fx</span><span class="p">;</span>
<a id="__codelineno-45-48" name="__codelineno-45-48" href="#__codelineno-45-48"></a>
<a id="__codelineno-45-49" name="__codelineno-45-49" href="#__codelineno-45-49"></a><span class="w">  </span><span class="n">tmp</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-45-50" name="__codelineno-45-50" href="#__codelineno-45-50"></a><span class="w">  </span><span class="n">tmp</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fy</span><span class="p">;</span>
<a id="__codelineno-45-51" name="__codelineno-45-51" href="#__codelineno-45-51"></a><span class="w">  </span><span class="n">tmp</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">y</span><span class="o">/</span><span class="n">z</span><span class="o">*</span><span class="n">fy</span><span class="p">;</span>
<a id="__codelineno-45-52" name="__codelineno-45-52" href="#__codelineno-45-52"></a>
<a id="__codelineno-45-53" name="__codelineno-45-53" href="#__codelineno-45-53"></a><span class="w">  </span><span class="n">_jacobianOplusXi</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">-1.</span><span class="o">/</span><span class="n">z</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">T</span><span class="p">.</span><span class="n">rotation</span><span class="p">().</span><span class="n">toRotationMatrix</span><span class="p">();</span>
<a id="__codelineno-45-54" name="__codelineno-45-54" href="#__codelineno-45-54"></a>
<a id="__codelineno-45-55" name="__codelineno-45-55" href="#__codelineno-45-55"></a><span class="w">  </span><span class="n">_jacobianOplusXj</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="o">/</span><span class="n">z_2</span><span class="w"> </span><span class="o">*</span><span class="n">fx</span><span class="p">;</span>
<a id="__codelineno-45-56" name="__codelineno-45-56" href="#__codelineno-45-56"></a><span class="w">  </span><span class="n">_jacobianOplusXj</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="o">/</span><span class="n">z_2</span><span class="p">))</span><span class="w"> </span><span class="o">*</span><span class="n">fx</span><span class="p">;</span>
<a id="__codelineno-45-57" name="__codelineno-45-57" href="#__codelineno-45-57"></a><span class="w">  </span><span class="n">_jacobianOplusXj</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="o">/</span><span class="n">z</span><span class="w"> </span><span class="o">*</span><span class="n">fx</span><span class="p">;</span>
<a id="__codelineno-45-58" name="__codelineno-45-58" href="#__codelineno-45-58"></a><span class="w">  </span><span class="n">_jacobianOplusXj</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.</span><span class="o">/</span><span class="n">z</span><span class="w"> </span><span class="o">*</span><span class="n">fx</span><span class="p">;</span>
<a id="__codelineno-45-59" name="__codelineno-45-59" href="#__codelineno-45-59"></a><span class="w">  </span><span class="n">_jacobianOplusXj</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-45-60" name="__codelineno-45-60" href="#__codelineno-45-60"></a><span class="w">  </span><span class="n">_jacobianOplusXj</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="o">/</span><span class="n">z_2</span><span class="w"> </span><span class="o">*</span><span class="n">fx</span><span class="p">;</span>
<a id="__codelineno-45-61" name="__codelineno-45-61" href="#__codelineno-45-61"></a>
<a id="__codelineno-45-62" name="__codelineno-45-62" href="#__codelineno-45-62"></a><span class="w">  </span><span class="n">_jacobianOplusXj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">y</span><span class="o">*</span><span class="n">y</span><span class="o">/</span><span class="n">z_2</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="n">fy</span><span class="p">;</span>
<a id="__codelineno-45-63" name="__codelineno-45-63" href="#__codelineno-45-63"></a><span class="w">  </span><span class="n">_jacobianOplusXj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="o">/</span><span class="n">z_2</span><span class="w"> </span><span class="o">*</span><span class="n">fy</span><span class="p">;</span>
<a id="__codelineno-45-64" name="__codelineno-45-64" href="#__codelineno-45-64"></a><span class="w">  </span><span class="n">_jacobianOplusXj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">x</span><span class="o">/</span><span class="n">z</span><span class="w"> </span><span class="o">*</span><span class="n">fy</span><span class="p">;</span>
<a id="__codelineno-45-65" name="__codelineno-45-65" href="#__codelineno-45-65"></a><span class="w">  </span><span class="n">_jacobianOplusXj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-45-66" name="__codelineno-45-66" href="#__codelineno-45-66"></a><span class="w">  </span><span class="n">_jacobianOplusXj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.</span><span class="o">/</span><span class="n">z</span><span class="w"> </span><span class="o">*</span><span class="n">fy</span><span class="p">;</span>
<a id="__codelineno-45-67" name="__codelineno-45-67" href="#__codelineno-45-67"></a><span class="w">  </span><span class="n">_jacobianOplusXj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="o">/</span><span class="n">z_2</span><span class="w"> </span><span class="o">*</span><span class="n">fy</span><span class="p">;</span>
<a id="__codelineno-45-68" name="__codelineno-45-68" href="#__codelineno-45-68"></a><span class="p">}</span>
</code></pre></div>
<h3 id="map-point-normal-and-depth-update">Map Point Normal And Depth Update</h3>
<p>After setting a map point pose <code>pMP-&gt;SetWorldPos(...)</code>, should then update the normal and depth of the map point.</p>
<p>The normal vector is the mean vector of one map point's all observations by different keyframes aligned to individual keyframe's camera pose, that is <span class="arithmatex">\(\mathbf{n}=\frac{1}{n} \sum^n_i \frac{\mathbf{n}_i}{\big|\mathbf{n}_i\big|}\)</span>, where <span class="arithmatex">\(\mathbf{n}_i\)</span> is computed by <code>cv::Mat normali = mWorldPos - Owi;</code>.</p>
<p>For map point depth, compute by <code>cv::Mat PC = Pos - pRefKF-&gt;GetCameraCenter();</code> then taking the length by <code>const float dist = cv::norm(PC);</code>.
The depth's max and min estimate is scaled by keyframe's scale factor.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">MapPoint::UpdateNormalAndDepth</span><span class="p">()</span>
<a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="p">{</span>
<a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a><span class="w">    </span><span class="n">map</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*</span><span class="p">,</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">observations</span><span class="p">;</span>
<a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a><span class="w">    </span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pRefKF</span><span class="p">;</span>
<a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">Pos</span><span class="p">;</span>
<a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a><span class="w">        </span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock1</span><span class="p">(</span><span class="n">mMutexFeatures</span><span class="p">);</span>
<a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a><span class="w">        </span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock2</span><span class="p">(</span><span class="n">mMutexPos</span><span class="p">);</span>
<a id="__codelineno-46-9" name="__codelineno-46-9" href="#__codelineno-46-9"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">mbBad</span><span class="p">)</span>
<a id="__codelineno-46-10" name="__codelineno-46-10" href="#__codelineno-46-10"></a><span class="w">            </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-46-11" name="__codelineno-46-11" href="#__codelineno-46-11"></a><span class="w">        </span><span class="n">observations</span><span class="o">=</span><span class="n">mObservations</span><span class="p">;</span>
<a id="__codelineno-46-12" name="__codelineno-46-12" href="#__codelineno-46-12"></a><span class="w">        </span><span class="n">pRefKF</span><span class="o">=</span><span class="n">mpRefKF</span><span class="p">;</span>
<a id="__codelineno-46-13" name="__codelineno-46-13" href="#__codelineno-46-13"></a><span class="w">        </span><span class="n">Pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mWorldPos</span><span class="p">.</span><span class="n">clone</span><span class="p">();</span>
<a id="__codelineno-46-14" name="__codelineno-46-14" href="#__codelineno-46-14"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-46-15" name="__codelineno-46-15" href="#__codelineno-46-15"></a>
<a id="__codelineno-46-16" name="__codelineno-46-16" href="#__codelineno-46-16"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">observations</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
<a id="__codelineno-46-17" name="__codelineno-46-17" href="#__codelineno-46-17"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-46-18" name="__codelineno-46-18" href="#__codelineno-46-18"></a>
<a id="__codelineno-46-19" name="__codelineno-46-19" href="#__codelineno-46-19"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">normal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">::</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">CV_32F</span><span class="p">);</span>
<a id="__codelineno-46-20" name="__codelineno-46-20" href="#__codelineno-46-20"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-46-21" name="__codelineno-46-21" href="#__codelineno-46-21"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">map</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*</span><span class="p">,</span><span class="kt">size_t</span><span class="o">&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">mit</span><span class="o">=</span><span class="n">observations</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">mend</span><span class="o">=</span><span class="n">observations</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">mit</span><span class="o">!=</span><span class="n">mend</span><span class="p">;</span><span class="w"> </span><span class="n">mit</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-46-22" name="__codelineno-46-22" href="#__codelineno-46-22"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-46-23" name="__codelineno-46-23" href="#__codelineno-46-23"></a><span class="w">        </span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pKF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mit</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">;</span>
<a id="__codelineno-46-24" name="__codelineno-46-24" href="#__codelineno-46-24"></a><span class="w">        </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">Owi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">GetCameraCenter</span><span class="p">();</span>
<a id="__codelineno-46-25" name="__codelineno-46-25" href="#__codelineno-46-25"></a><span class="w">        </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">normali</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mWorldPos</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Owi</span><span class="p">;</span>
<a id="__codelineno-46-26" name="__codelineno-46-26" href="#__codelineno-46-26"></a><span class="w">        </span><span class="n">normal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">normal</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">normali</span><span class="o">/</span><span class="n">cv</span><span class="o">::</span><span class="n">norm</span><span class="p">(</span><span class="n">normali</span><span class="p">);</span>
<a id="__codelineno-46-27" name="__codelineno-46-27" href="#__codelineno-46-27"></a><span class="w">        </span><span class="n">n</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-46-28" name="__codelineno-46-28" href="#__codelineno-46-28"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-46-29" name="__codelineno-46-29" href="#__codelineno-46-29"></a>
<a id="__codelineno-46-30" name="__codelineno-46-30" href="#__codelineno-46-30"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">PC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pos</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pRefKF</span><span class="o">-&gt;</span><span class="n">GetCameraCenter</span><span class="p">();</span>
<a id="__codelineno-46-31" name="__codelineno-46-31" href="#__codelineno-46-31"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">norm</span><span class="p">(</span><span class="n">PC</span><span class="p">);</span>
<a id="__codelineno-46-32" name="__codelineno-46-32" href="#__codelineno-46-32"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pRefKF</span><span class="o">-&gt;</span><span class="n">mvKeysUn</span><span class="p">[</span><span class="n">observations</span><span class="p">[</span><span class="n">pRefKF</span><span class="p">]].</span><span class="n">octave</span><span class="p">;</span>
<a id="__codelineno-46-33" name="__codelineno-46-33" href="#__codelineno-46-33"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">levelScaleFactor</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">pRefKF</span><span class="o">-&gt;</span><span class="n">mvScaleFactors</span><span class="p">[</span><span class="n">level</span><span class="p">];</span>
<a id="__codelineno-46-34" name="__codelineno-46-34" href="#__codelineno-46-34"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nLevels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pRefKF</span><span class="o">-&gt;</span><span class="n">mnScaleLevels</span><span class="p">;</span>
<a id="__codelineno-46-35" name="__codelineno-46-35" href="#__codelineno-46-35"></a>
<a id="__codelineno-46-36" name="__codelineno-46-36" href="#__codelineno-46-36"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-46-37" name="__codelineno-46-37" href="#__codelineno-46-37"></a><span class="w">        </span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock3</span><span class="p">(</span><span class="n">mMutexPos</span><span class="p">);</span>
<a id="__codelineno-46-38" name="__codelineno-46-38" href="#__codelineno-46-38"></a><span class="w">        </span><span class="n">mfMaxDistance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dist</span><span class="o">*</span><span class="n">levelScaleFactor</span><span class="p">;</span>
<a id="__codelineno-46-39" name="__codelineno-46-39" href="#__codelineno-46-39"></a><span class="w">        </span><span class="n">mfMinDistance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mfMaxDistance</span><span class="o">/</span><span class="n">pRefKF</span><span class="o">-&gt;</span><span class="n">mvScaleFactors</span><span class="p">[</span><span class="n">nLevels</span><span class="mi">-1</span><span class="p">];</span>
<a id="__codelineno-46-40" name="__codelineno-46-40" href="#__codelineno-46-40"></a><span class="w">        </span><span class="n">mNormalVector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">normal</span><span class="o">/</span><span class="n">n</span><span class="p">;</span>
<a id="__codelineno-46-41" name="__codelineno-46-41" href="#__codelineno-46-41"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-46-42" name="__codelineno-46-42" href="#__codelineno-46-42"></a><span class="p">}</span>
</code></pre></div>
<h3 id="local-bundle-adjustment">Local Bundle Adjustment</h3>
<p>Local bundle adjustment takes care of keyframe from <code>pKF-&gt;GetVectorCovisibleKeyFrames();</code>.
The rest of work is a typical bundle adjustment.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">Optimizer::LocalBundleAdjustment</span><span class="p">(</span><span class="n">KeyFrame</span><span class="w"> </span><span class="o">*</span><span class="n">pKF</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="o">*</span><span class="w"> </span><span class="n">pbStopFlag</span><span class="p">,</span><span class="w"> </span><span class="n">Map</span><span class="o">*</span><span class="w"> </span><span class="n">pMap</span><span class="p">)</span>
<a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="p">{</span>
<a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="w">    </span><span class="n">list</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">lLocalKeyFrames</span><span class="p">;</span>
<a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a>
<a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a><span class="w">    </span><span class="n">lLocalKeyFrames</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pKF</span><span class="p">);</span>
<a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a><span class="w">    </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">mnBALocalForKF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="p">;</span>
<a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a>
<a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">vNeighKFs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">GetVectorCovisibleKeyFrames</span><span class="p">();</span>
<a id="__codelineno-47-9" name="__codelineno-47-9" href="#__codelineno-47-9"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">iend</span><span class="o">=</span><span class="n">vNeighKFs</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">iend</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-47-10" name="__codelineno-47-10" href="#__codelineno-47-10"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-47-11" name="__codelineno-47-11" href="#__codelineno-47-11"></a><span class="w">        </span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pKFi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vNeighKFs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-47-12" name="__codelineno-47-12" href="#__codelineno-47-12"></a><span class="w">        </span><span class="n">pKFi</span><span class="o">-&gt;</span><span class="n">mnBALocalForKF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="p">;</span>
<a id="__codelineno-47-13" name="__codelineno-47-13" href="#__codelineno-47-13"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">pKFi</span><span class="o">-&gt;</span><span class="n">isBad</span><span class="p">())</span>
<a id="__codelineno-47-14" name="__codelineno-47-14" href="#__codelineno-47-14"></a><span class="w">            </span><span class="n">lLocalKeyFrames</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pKFi</span><span class="p">);</span>
<a id="__codelineno-47-15" name="__codelineno-47-15" href="#__codelineno-47-15"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-47-16" name="__codelineno-47-16" href="#__codelineno-47-16"></a>
<a id="__codelineno-47-17" name="__codelineno-47-17" href="#__codelineno-47-17"></a><span class="w">    </span><span class="p">...</span><span class="w"> </span><span class="c1">// bundle adjustment</span>
<a id="__codelineno-47-18" name="__codelineno-47-18" href="#__codelineno-47-18"></a><span class="p">}</span>
</code></pre></div>
<h2 id="local-mapping">Local Mapping</h2>
<p><code>LocalMapping</code> is a thread launched from <code>System::System(...)</code> when ORB-SLAM starts.
Thread runs <code>ORB_SLAM2::LocalMapping::Run();</code> which is a <code>while(true)</code> loop that does the below tasks.</p>
<p>Most importantly, it first triangulates building some map points in <code>CreateNewMapPoints();</code>, then perform local bundle ajdustment to find the optimal transform.</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="n">System</span><span class="o">::</span><span class="n">System</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">strVocFile</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">strSettingsFile</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">eSensor</span><span class="w"> </span><span class="n">sensor</span><span class="p">,</span>
<a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="w">               </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">bUseViewer</span><span class="p">)</span><span class="o">:</span><span class="n">mSensor</span><span class="p">(</span><span class="n">sensor</span><span class="p">),</span><span class="w"> </span><span class="n">mpViewer</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Viewer</span><span class="o">*&gt;</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)),</span><span class="w"> </span><span class="n">mbReset</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span><span class="n">mbActivateLocalizationMode</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span>
<a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a><span class="w">        </span><span class="n">mbDeactivateLocalizationMode</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span>
<a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a><span class="p">{</span>
<a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a>
<a id="__codelineno-48-7" name="__codelineno-48-7" href="#__codelineno-48-7"></a><span class="w">    </span><span class="c1">//Initialize the Local Mapping thread and launch</span>
<a id="__codelineno-48-8" name="__codelineno-48-8" href="#__codelineno-48-8"></a><span class="w">    </span><span class="n">mpLocalMapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LocalMapping</span><span class="p">(</span><span class="n">mpMap</span><span class="p">,</span><span class="w"> </span><span class="n">mSensor</span><span class="o">==</span><span class="n">MONOCULAR</span><span class="p">);</span>
<a id="__codelineno-48-9" name="__codelineno-48-9" href="#__codelineno-48-9"></a><span class="w">    </span><span class="n">mptLocalMapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kr">thread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ORB_SLAM2</span><span class="o">::</span><span class="n">LocalMapping</span><span class="o">::</span><span class="n">Run</span><span class="p">,</span><span class="n">mpLocalMapper</span><span class="p">);</span>
<a id="__codelineno-48-10" name="__codelineno-48-10" href="#__codelineno-48-10"></a>
<a id="__codelineno-48-11" name="__codelineno-48-11" href="#__codelineno-48-11"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-48-12" name="__codelineno-48-12" href="#__codelineno-48-12"></a><span class="p">}</span>
<a id="__codelineno-48-13" name="__codelineno-48-13" href="#__codelineno-48-13"></a>
<a id="__codelineno-48-14" name="__codelineno-48-14" href="#__codelineno-48-14"></a><span class="kt">void</span><span class="w"> </span><span class="n">LocalMapping</span><span class="o">::</span><span class="n">Run</span><span class="p">()</span>
<a id="__codelineno-48-15" name="__codelineno-48-15" href="#__codelineno-48-15"></a><span class="p">{</span>
<a id="__codelineno-48-16" name="__codelineno-48-16" href="#__codelineno-48-16"></a>
<a id="__codelineno-48-17" name="__codelineno-48-17" href="#__codelineno-48-17"></a><span class="w">    </span><span class="n">mbFinished</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-48-18" name="__codelineno-48-18" href="#__codelineno-48-18"></a>
<a id="__codelineno-48-19" name="__codelineno-48-19" href="#__codelineno-48-19"></a><span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-48-20" name="__codelineno-48-20" href="#__codelineno-48-20"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-48-21" name="__codelineno-48-21" href="#__codelineno-48-21"></a><span class="w">        </span><span class="c1">// Tracking will see that Local Mapping is busy</span>
<a id="__codelineno-48-22" name="__codelineno-48-22" href="#__codelineno-48-22"></a><span class="w">        </span><span class="n">SetAcceptKeyFrames</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
<a id="__codelineno-48-23" name="__codelineno-48-23" href="#__codelineno-48-23"></a>
<a id="__codelineno-48-24" name="__codelineno-48-24" href="#__codelineno-48-24"></a><span class="w">        </span><span class="c1">// Check if there are keyframes in the queue</span>
<a id="__codelineno-48-25" name="__codelineno-48-25" href="#__codelineno-48-25"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">CheckNewKeyFrames</span><span class="p">())</span>
<a id="__codelineno-48-26" name="__codelineno-48-26" href="#__codelineno-48-26"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-48-27" name="__codelineno-48-27" href="#__codelineno-48-27"></a><span class="w">            </span><span class="c1">// BoW conversion and insertion in Map</span>
<a id="__codelineno-48-28" name="__codelineno-48-28" href="#__codelineno-48-28"></a><span class="w">            </span><span class="c1">// compute some attributes of a map point: observations, normals, etc.</span>
<a id="__codelineno-48-29" name="__codelineno-48-29" href="#__codelineno-48-29"></a><span class="w">            </span><span class="c1">// add co-visibility for the new keyframe</span>
<a id="__codelineno-48-30" name="__codelineno-48-30" href="#__codelineno-48-30"></a><span class="w">            </span><span class="n">ProcessNewKeyFrame</span><span class="p">();</span>
<a id="__codelineno-48-31" name="__codelineno-48-31" href="#__codelineno-48-31"></a>
<a id="__codelineno-48-32" name="__codelineno-48-32" href="#__codelineno-48-32"></a><span class="w">            </span><span class="c1">// Check recent MapPoints</span>
<a id="__codelineno-48-33" name="__codelineno-48-33" href="#__codelineno-48-33"></a><span class="w">            </span><span class="c1">// remove some map points</span>
<a id="__codelineno-48-34" name="__codelineno-48-34" href="#__codelineno-48-34"></a><span class="w">            </span><span class="n">MapPointCulling</span><span class="p">();</span>
<a id="__codelineno-48-35" name="__codelineno-48-35" href="#__codelineno-48-35"></a>
<a id="__codelineno-48-36" name="__codelineno-48-36" href="#__codelineno-48-36"></a><span class="w">            </span><span class="c1">// Triangulate new MapPoints</span>
<a id="__codelineno-48-37" name="__codelineno-48-37" href="#__codelineno-48-37"></a><span class="w">            </span><span class="n">CreateNewMapPoints</span><span class="p">();</span>
<a id="__codelineno-48-38" name="__codelineno-48-38" href="#__codelineno-48-38"></a>
<a id="__codelineno-48-39" name="__codelineno-48-39" href="#__codelineno-48-39"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">CheckNewKeyFrames</span><span class="p">())</span>
<a id="__codelineno-48-40" name="__codelineno-48-40" href="#__codelineno-48-40"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-48-41" name="__codelineno-48-41" href="#__codelineno-48-41"></a><span class="w">                </span><span class="c1">// Find more matches in neighbor keyframes and fuse point duplications</span>
<a id="__codelineno-48-42" name="__codelineno-48-42" href="#__codelineno-48-42"></a><span class="w">                </span><span class="n">SearchInNeighbors</span><span class="p">();</span>
<a id="__codelineno-48-43" name="__codelineno-48-43" href="#__codelineno-48-43"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-48-44" name="__codelineno-48-44" href="#__codelineno-48-44"></a>
<a id="__codelineno-48-45" name="__codelineno-48-45" href="#__codelineno-48-45"></a><span class="w">            </span><span class="n">mbAbortBA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-48-46" name="__codelineno-48-46" href="#__codelineno-48-46"></a>
<a id="__codelineno-48-47" name="__codelineno-48-47" href="#__codelineno-48-47"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">CheckNewKeyFrames</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">stopRequested</span><span class="p">())</span>
<a id="__codelineno-48-48" name="__codelineno-48-48" href="#__codelineno-48-48"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-48-49" name="__codelineno-48-49" href="#__codelineno-48-49"></a><span class="w">                </span><span class="c1">// Local BA</span>
<a id="__codelineno-48-50" name="__codelineno-48-50" href="#__codelineno-48-50"></a><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">mpMap</span><span class="o">-&gt;</span><span class="n">KeyFramesInMap</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-48-51" name="__codelineno-48-51" href="#__codelineno-48-51"></a><span class="w">                    </span><span class="n">Optimizer</span><span class="o">::</span><span class="n">LocalBundleAdjustment</span><span class="p">(</span><span class="n">mpCurrentKeyFrame</span><span class="p">,</span><span class="o">&amp;</span><span class="n">mbAbortBA</span><span class="p">,</span><span class="w"> </span><span class="n">mpMap</span><span class="p">);</span>
<a id="__codelineno-48-52" name="__codelineno-48-52" href="#__codelineno-48-52"></a>
<a id="__codelineno-48-53" name="__codelineno-48-53" href="#__codelineno-48-53"></a><span class="w">                </span><span class="c1">// Check redundant local Keyframes</span>
<a id="__codelineno-48-54" name="__codelineno-48-54" href="#__codelineno-48-54"></a><span class="w">                </span><span class="n">KeyFrameCulling</span><span class="p">();</span>
<a id="__codelineno-48-55" name="__codelineno-48-55" href="#__codelineno-48-55"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-48-56" name="__codelineno-48-56" href="#__codelineno-48-56"></a>
<a id="__codelineno-48-57" name="__codelineno-48-57" href="#__codelineno-48-57"></a><span class="w">            </span><span class="n">mpLoopCloser</span><span class="o">-&gt;</span><span class="n">InsertKeyFrame</span><span class="p">(</span><span class="n">mpCurrentKeyFrame</span><span class="p">);</span>
<a id="__codelineno-48-58" name="__codelineno-48-58" href="#__codelineno-48-58"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-48-59" name="__codelineno-48-59" href="#__codelineno-48-59"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">Stop</span><span class="p">())</span>
<a id="__codelineno-48-60" name="__codelineno-48-60" href="#__codelineno-48-60"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-48-61" name="__codelineno-48-61" href="#__codelineno-48-61"></a><span class="w">            </span><span class="c1">// Safe area to stop</span>
<a id="__codelineno-48-62" name="__codelineno-48-62" href="#__codelineno-48-62"></a><span class="w">            </span><span class="k">while</span><span class="p">(</span><span class="n">isStopped</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">CheckFinish</span><span class="p">())</span>
<a id="__codelineno-48-63" name="__codelineno-48-63" href="#__codelineno-48-63"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-48-64" name="__codelineno-48-64" href="#__codelineno-48-64"></a><span class="w">                </span><span class="n">usleep</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
<a id="__codelineno-48-65" name="__codelineno-48-65" href="#__codelineno-48-65"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-48-66" name="__codelineno-48-66" href="#__codelineno-48-66"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">CheckFinish</span><span class="p">())</span>
<a id="__codelineno-48-67" name="__codelineno-48-67" href="#__codelineno-48-67"></a><span class="w">                </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-48-68" name="__codelineno-48-68" href="#__codelineno-48-68"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-48-69" name="__codelineno-48-69" href="#__codelineno-48-69"></a>
<a id="__codelineno-48-70" name="__codelineno-48-70" href="#__codelineno-48-70"></a><span class="w">        </span><span class="n">ResetIfRequested</span><span class="p">();</span>
<a id="__codelineno-48-71" name="__codelineno-48-71" href="#__codelineno-48-71"></a>
<a id="__codelineno-48-72" name="__codelineno-48-72" href="#__codelineno-48-72"></a><span class="w">        </span><span class="c1">// Tracking will see that Local Mapping is busy</span>
<a id="__codelineno-48-73" name="__codelineno-48-73" href="#__codelineno-48-73"></a><span class="w">        </span><span class="n">SetAcceptKeyFrames</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<a id="__codelineno-48-74" name="__codelineno-48-74" href="#__codelineno-48-74"></a>
<a id="__codelineno-48-75" name="__codelineno-48-75" href="#__codelineno-48-75"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">CheckFinish</span><span class="p">())</span>
<a id="__codelineno-48-76" name="__codelineno-48-76" href="#__codelineno-48-76"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-48-77" name="__codelineno-48-77" href="#__codelineno-48-77"></a>
<a id="__codelineno-48-78" name="__codelineno-48-78" href="#__codelineno-48-78"></a><span class="w">        </span><span class="n">usleep</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
<a id="__codelineno-48-79" name="__codelineno-48-79" href="#__codelineno-48-79"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-48-80" name="__codelineno-48-80" href="#__codelineno-48-80"></a>
<a id="__codelineno-48-81" name="__codelineno-48-81" href="#__codelineno-48-81"></a><span class="w">    </span><span class="n">SetFinish</span><span class="p">();</span>
<a id="__codelineno-48-82" name="__codelineno-48-82" href="#__codelineno-48-82"></a><span class="p">}</span>
</code></pre></div>
where <code>CreateNewMapPoints()</code> computes new map points by triangulation.</p>
<p><code>vpNeighKFs</code> are some co-visible keyframes to <code>this</code> keyframe.</p>
<p>Check baseline not too short, where <code>Ow2</code> and <code>Ow1</code> are the camera centers of two keyframes.
In other words, there should be some long distance between two keyframes for triangulation to be accurate.
<div class="highlight"><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">vBaseline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Ow2</span><span class="o">-</span><span class="n">Ow1</span><span class="p">;</span>
<a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">ratioBaselineDepth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">baseline</span><span class="o">/</span><span class="n">medianDepthKF2</span><span class="p">;</span>
<a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a><span class="k">if</span><span class="p">(</span><span class="n">ratioBaselineDepth</span><span class="o">&lt;</span><span class="mf">0.01</span><span class="p">)</span>
<a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a><span class="w">    </span><span class="k">continue</span><span class="p">;</span>
</code></pre></div></p>
<p>Compute the fundamental matrix between the current keyframe and the co-visible keyframes <code>cv::Mat F12 = ComputeF12(mpCurrentKeyFrame,pKF2);</code>.</p>
<p>Then, <code>matcher.SearchForTriangulation(...);</code> finds good matched points for triangulation, that Chi-squared test is performed removing the worst <span class="arithmatex">\(5\%\)</span> points.</p>
<p>Triangulation starts.</p>
<div class="arithmatex">\[
\begin{align*}
\text{Given pixel } (x_p, y_p) \text{ and world point } (x_w, y_w), 
\\\\ \text{here are the projection equations} &amp;&amp; 
x_p &amp;= \frac{f_x}{Z} x_w +c_x
&amp;\qquad
y_p &amp;= \frac{f_y}{Z} y_w +c_y
\\\\ \text{Find the world points for the two keyframes by } Z=1 \Rightarrow &amp;&amp;
\mathbf{x}_1 &amp;= 
\begin{bmatrix}
    x_{1w} \\\\ y_{1w} \\\\ 1
\end{bmatrix} =
\begin{bmatrix}
\frac{x_1 - c_{1x}}{f_{1x}} \\\\ \frac{y_1 - c_{1y}}{f_{1y}} \\\\ 1
\end{bmatrix}
&amp;\qquad
\mathbf{x}_2 &amp;= 
\begin{bmatrix}
    x_{2w} \\\\ y_{2w} \\\\ 1
\end{bmatrix} =
\begin{bmatrix}
\frac{x_2 - c_{2x}}{f_{2x}} \\\\ \frac{y_1 - c_{2y}}{f_{2y}} \\\\ 1
\end{bmatrix}
\\\\ \text{Camera to world point rays/homography} \Rightarrow &amp;&amp;
\mathbf{r}_1 &amp;= R_1^{\top} \mathbf{x}_1
&amp;\qquad
\mathbf{r}_2 &amp;= R_2^{\top} \mathbf{x}_2
\\\\ \text{Parallax angle} \Rightarrow &amp;&amp;
\cos\angle{\theta_{12}} &amp;=
\frac{\mathbf{r}_1 \cdot \mathbf{r}_2}{\big|\mathbf{r}_2\big| \cdot \big|\mathbf{r}_2\big|}= \frac{\big|\mathbf{r}_2\big| \cdot \big|\mathbf{r}_2\big| \cos\angle{\theta_{12}}}{\big|\mathbf{r}_2\big| \cdot \big|\mathbf{r}_2\big|}
\end{align*}
\]</div>
<p><span class="arithmatex">\(0 \le \cos\angle{\theta_{12}}&lt;0.9998\)</span> should hold true before performing triangulation, since lower the <span class="arithmatex">\(\cos\angle{\theta_{12}}\)</span>, greater the <span class="arithmatex">\(\angle{\theta_{12}}\)</span> and better result/higher precision.</p>
<p>For triangulation, here is the full formula.</p>
<p>PnP (Perspective-n-Point) describes how a 3d world point <span class="arithmatex">\(\mathbf{X}=[X\quad Y\quad Z\quad 1]^\top\)</span> is projected to an image pixel <span class="arithmatex">\(\mathbf{x}=[u\quad v\quad 1]^\top\)</span> scaled by <span class="arithmatex">\(s\)</span>.
Denote the projection as <span class="arithmatex">\(\mathbf{P}\)</span>.</p>
<div class="arithmatex">\[
s \underbrace{\begin{bmatrix}
    u \\\\
    v \\\\
    1
\end{bmatrix}}_{\mathbf{x}}=
\underbrace{
\begin{bmatrix}
    f_x &amp; 0 &amp; c_x \\\\
    0 &amp; f_y &amp; c_y \\\\
    0 &amp; 0 &amp; 1
\end{bmatrix}
\underbrace{
    \begin{bmatrix}
        t_1 &amp; t_2 &amp; t_3 &amp; t_4 \\\\
        t_5 &amp; t_6 &amp; t_7 &amp; t_8 \\\\
        t_9 &amp; t_{10} &amp; t_{11} &amp; t_{12} \\\\
    \end{bmatrix}
}_{[\mathbf{R}|\mathbf{t}]}
}_{\mathbf{P}=\begin{bmatrix}
        p_1 &amp; p_2 &amp; p_3 &amp; p_4 \\\\
        p_5 &amp; p_6 &amp; p_7 &amp; p_8 \\\\
        p_9 &amp; p_{10} &amp; p_{11} &amp; p_{12} \\\\
    \end{bmatrix}=\begin{bmatrix}
        \mathbf{p}_1^\top \\\\
        \mathbf{p}_2^\top \\\\
        \mathbf{p}_3^\top
    \end{bmatrix}
    }
\underbrace{\begin{bmatrix}
    X \\\\
    Y \\\\
    Z \\\\
    1
\end{bmatrix}}_{\mathbf{X}}
\]</div>
<p>where <span class="arithmatex">\(\mathbf{p}_1^\top=[p_1\quad p_2\quad p_3\quad p_4],\qquad \mathbf{p}_2^\top=[p_5\quad p_6\quad p_7\quad p_8], \qquad \mathbf{p}_3^\top=[p_9\quad p_{10}\quad p_{11}\quad p_{12}]\)</span>.</p>
<p>Consider image pixels <span class="arithmatex">\((u, v)\)</span> and <span class="arithmatex">\((u', v')\)</span> for the two keyframes, and the corresponding transform 
<span class="arithmatex">\(\mathbf{P} = \begin{bmatrix} \mathbf{p}_1^\top \\\\ \mathbf{p}_2^\top \\\\ \mathbf{p}_3^\top \end{bmatrix}\)</span> 
and <span class="arithmatex">\(\mathbf{P}' = \begin{bmatrix} \mathbf{p'}_1^\top \\\\ \mathbf{p'}_2^\top \\\\ \mathbf{p'}_3^\top \end{bmatrix}\)</span>
by triangulation rule, there is <span class="arithmatex">\(A\mathbf{X}=\mathbf{0}\)</span>:</p>
<div class="arithmatex">\[
\begin{bmatrix}
    v\mathbf{p}_3^\top \mathbf{X} - \mathbf{p}_1^\top \mathbf{X} \\\\
    \mathbf{p}_1^\top \mathbf{X} - u\mathbf{p}_3^\top \mathbf{X} \\\\
    v'\mathbf{p'}_3^\top \mathbf{X} - \mathbf{p'}_1^\top \mathbf{X} \\\\
    \mathbf{p'}_1^\top \mathbf{X} - u'\mathbf{p'}_3^\top \mathbf{X}
\end{bmatrix}
\overset{\text{take out }\mathbf{X}}{=}
\underbrace{\begin{bmatrix}
    v\mathbf{p}_3^\top - \mathbf{p}_1^\top \\\\
    \mathbf{p}_1^\top - u\mathbf{p}_3^\top \\\\
    v'\mathbf{p'}_3^\top - \mathbf{p'}_1^\top \\\\
    \mathbf{p'}_1^\top - u'\mathbf{p'}_3^\top
\end{bmatrix}}_{A}
\mathbf{X}=
\begin{bmatrix}
    0 \\\\
    0 \\\\
    0 \\\\
    0
\end{bmatrix}
\]</div>
<p>The above equations are decomposed by SVD <code>cv::SVD::compute(A,w,u,vt,cv::SVD::MODIFY_A| cv::SVD::FULL_UV);</code>, where <code>vt</code> is the sorted eigenvectors, and <code>x3D = vt.row(3).t();</code> is the eigenvector corresponding to the smallest eigenvalue.
By  Rayleigh quotient, this eigenvector <code>x3D</code> is the solution <span class="arithmatex">\(\mathbf{X}=[X\quad Y\quad Z\quad 1]^{\top}\)</span>.
<code>x3D = x3D.rowRange(0,3)/x3D.at&lt;float&gt;(3);</code> is the normalization term for the fourth element <span class="arithmatex">\(1\)</span>.
Denote <code>x3D</code> as <span class="arithmatex">\(\mathbf{x}\)</span>.</p>
<p>Denote the projection from the triangulated estimate map point as <span class="arithmatex">\((\hat{u},\hat{v})\)</span>, and keypoint observations <span class="arithmatex">\((u,v)\)</span> from camera as the truth, compute the error.
If the error passes the <span class="arithmatex">\(\mathcal{X}^2\)</span> test of <span class="arithmatex">\(95\%\)</span> confidence, the triangulated result <span class="arithmatex">\(\mathbf{x}\)</span> is good.</p>
<p>$$
\begin{align<em>}
&amp;&amp;
\hat{\mathbf{x}}<em>{1c} &amp;= 
\begin{bmatrix}
    x</em>{1c} \\ y_{1c} \\ z_{1c}
\end{bmatrix}
 = R_1 \mathbf{x} + \mathbf{t}<em>1
&amp; &amp;&amp;\qquad
\hat{\mathbf{x}}</em>{2c} &amp;= 
\begin{bmatrix}
    x_{2c} \\ y_{2c} \\ z_{2c}
\end{bmatrix}
 = R_2 \mathbf{x} + \mathbf{t}<em>2
\\ \text{Projection } \Rightarrow &amp;&amp;
\hat{u}</em>{1} &amp;= \frac{f_x}{z_{1c}} x_{1c} + c_x
&amp;\qquad
\hat{v}<em>{1} = \frac{f_y}{z</em>{1c}} y_{1c} + c_y
&amp;&amp;\qquad
\hat{u}<em>{2} &amp;= \frac{f_x}{z</em>{2c}} x_{2c} + c_x
&amp;\qquad
\hat{v}<em>{2} = \frac{f_y}{z</em>{2c}} y_{2c} + c_y
\\ \text{Error } \Rightarrow &amp;&amp;
\mathbf{e}<em>1 &amp;= \begin{bmatrix} \hat{u}</em>{1} \\ \hat{v}<em>{1} \end{bmatrix} - \begin{bmatrix} {u}</em>{1} \\ {v}<em>{1} \end{bmatrix}
&amp; &amp;&amp;\qquad
\mathbf{e}_2 &amp;= \begin{bmatrix} \hat{u}</em>{2} \\ \hat{v}<em>{2} \end{bmatrix} - \begin{bmatrix} {u}</em>{2} \\ {v}_{2} \end{bmatrix}
\\ \mathcal{X}^2 \text{ test by } 95\% \text{ confidence } \Rightarrow &amp;&amp;
\mathbf{e}_1 \mathbf{e}_1^{\top} &amp;&lt; 5.991
&amp; &amp;&amp;\qquad - old{e}_2 \mathbf{e}_2^{\top} &amp;&lt; 5.991
\end{align</em>}
$$
 - `cpp
void LocalMapping::CreateNewMapPoints()
{
    // Retrieve neighbor keyframes in covisibility graph
    int nn = 10;
    if(mbMonocular)
        nn=20;
    const vector<KeyFrame*> vpNeighKFs = mpCurrentKeyFrame-&gt;GetBestCovisibilityKeyFrames(nn);</p>
<div class="highlight"><pre><span></span><code>ORBmatcher matcher(0.6,false);

cv::Mat Rcw1 = mpCurrentKeyFrame-&gt;GetRotation();
cv::Mat Rwc1 = Rcw1.t();
cv::Mat tcw1 = mpCurrentKeyFrame-&gt;GetTranslation();
cv::Mat Tcw1(3,4,CV_32F);
Rcw1.copyTo(Tcw1.colRange(0,3));
tcw1.copyTo(Tcw1.col(3));
cv::Mat Ow1 = mpCurrentKeyFrame-&gt;GetCameraCenter();

const float &amp;fx1 = mpCurrentKeyFrame-&gt;fx;
const float &amp;fy1 = mpCurrentKeyFrame-&gt;fy;
const float &amp;cx1 = mpCurrentKeyFrame-&gt;cx;
const float &amp;cy1 = mpCurrentKeyFrame-&gt;cy;
const float &amp;invfx1 = mpCurrentKeyFrame-&gt;invfx;
const float &amp;invfy1 = mpCurrentKeyFrame-&gt;invfy;

const float ratioFactor = 1.5f*mpCurrentKeyFrame-&gt;mfScaleFactor;

int nnew=0;

// Search matches with epipolar restriction and triangulate
for(size_t i=0; i&lt;vpNeighKFs.size(); i++)
{
    if(i&gt;0 &amp;&amp; CheckNewKeyFrames())
        return;

    KeyFrame* pKF2 = vpNeighKFs[i];

    // Check first that baseline is not too short
    cv::Mat Ow2 = pKF2-&gt;GetCameraCenter();
    cv::Mat vBaseline = Ow2-Ow1;
    const float baseline = cv::norm(vBaseline);

    if(!mbMonocular)
    {
        if(baseline&lt;pKF2-&gt;mb)
        continue;
    }
    else
    {
        const float medianDepthKF2 = pKF2-&gt;ComputeSceneMedianDepth(2);
        const float ratioBaselineDepth = baseline/medianDepthKF2;

        if(ratioBaselineDepth&lt;0.01)
            continue;
    }

    // Compute Fundamental Matrix
    cv::Mat F12 = ComputeF12(mpCurrentKeyFrame,pKF2);

    // Search matches that fullfil epipolar constraint
    vector&lt;pair&lt;size_t,size_t&gt; &gt; vMatchedIndices;
    matcher.SearchForTriangulation(mpCurrentKeyFrame,pKF2,F12,vMatchedIndices,false);

    cv::Mat Rcw2 = pKF2-&gt;GetRotation();
    cv::Mat Rwc2 = Rcw2.t();
    cv::Mat tcw2 = pKF2-&gt;GetTranslation();
    cv::Mat Tcw2(3,4,CV_32F);
    Rcw2.copyTo(Tcw2.colRange(0,3));
    tcw2.copyTo(Tcw2.col(3));

    const float &amp;fx2 = pKF2-&gt;fx;
    const float &amp;fy2 = pKF2-&gt;fy;
    const float &amp;cx2 = pKF2-&gt;cx;
    const float &amp;cy2 = pKF2-&gt;cy;
    const float &amp;invfx2 = pKF2-&gt;invfx;
    const float &amp;invfy2 = pKF2-&gt;invfy;

    // Triangulate each match
    const int nmatches = vMatchedIndices.size();
    for(int ikp=0; ikp&lt;nmatches; ikp++)
    {
        const int &amp;idx1 = vMatchedIndices[ikp].first;
        const int &amp;idx2 = vMatchedIndices[ikp].second;

        const cv::KeyPoint &amp;kp1 = mpCurrentKeyFrame-&gt;mvKeysUn[idx1];
        const float kp1_ur=mpCurrentKeyFrame-&gt;mvuRight[idx1];
        bool bStereo1 = kp1_ur&gt;=0;

        const cv::KeyPoint &amp;kp2 = pKF2-&gt;mvKeysUn[idx2];
        const float kp2_ur = pKF2-&gt;mvuRight[idx2];
        bool bStereo2 = kp2_ur&gt;=0;

        // Check parallax between rays
        cv::Mat xn1 = (cv::Mat_&lt;float&gt;(3,1) &lt;&lt; (kp1.pt.x-cx1)*invfx1, (kp1.pt.y-cy1)*invfy1, 1.0);
        cv::Mat xn2 = (cv::Mat_&lt;float&gt;(3,1) &lt;&lt; (kp2.pt.x-cx2)*invfx2, (kp2.pt.y-cy2)*invfy2, 1.0);

        cv::Mat ray1 = Rwc1*xn1;
        cv::Mat ray2 = Rwc2*xn2;
        const float cosParallaxRays = ray1.dot(ray2)/(cv::norm(ray1)*cv::norm(ray2));

        float cosParallaxStereo = cosParallaxRays+1;
        float cosParallaxStereo1 = cosParallaxStereo;
        float cosParallaxStereo2 = cosParallaxStereo;

        if(bStereo1)
            cosParallaxStereo1 = cos(2*atan2(mpCurrentKeyFrame-&gt;mb/2,mpCurrentKeyFrame-&gt;mvDepth[idx1]));
        else if(bStereo2)
            cosParallaxStereo2 = cos(2*atan2(pKF2-&gt;mb/2,pKF2-&gt;mvDepth[idx2]));

        cosParallaxStereo = min(cosParallaxStereo1,cosParallaxStereo2);

        cv::Mat x3D;
        if(cosParallaxRays&lt;cosParallaxStereo &amp;&amp; cosParallaxRays&gt;0 &amp;&amp; (bStereo1 || bStereo2 || cosParallaxRays&lt;0.9998))
        {
            // Linear Triangulation Method
            cv::Mat A(4,4,CV_32F);
            A.row(0) = xn1.at&lt;float&gt;(0)*Tcw1.row(2)-Tcw1.row(0);
            A.row(1) = xn1.at&lt;float&gt;(1)*Tcw1.row(2)-Tcw1.row(1);
            A.row(2) = xn2.at&lt;float&gt;(0)*Tcw2.row(2)-Tcw2.row(0);
            A.row(3) = xn2.at&lt;float&gt;(1)*Tcw2.row(2)-Tcw2.row(1);

            cv::Mat w,u,vt;
            cv::SVD::compute(A,w,u,vt,cv::SVD::MODIFY_A| cv::SVD::FULL_UV);

            x3D = vt.row(3).t();

            if(x3D.at&lt;float&gt;(3)==0)
                continue;

            // Euclidean coordinates
            x3D = x3D.rowRange(0,3)/x3D.at&lt;float&gt;(3);

        }
        else if(bStereo1 &amp;&amp; cosParallaxStereo1&lt;cosParallaxStereo2)
        {
            x3D = mpCurrentKeyFrame-&gt;UnprojectStereo(idx1);                
        }
        else if(bStereo2 &amp;&amp; cosParallaxStereo2&lt;cosParallaxStereo1)
        {
            x3D = pKF2-&gt;UnprojectStereo(idx2);
        }
        else
            continue; //No stereo and very low parallax

        cv::Mat x3Dt = x3D.t();

        //Check triangulation in front of cameras
        float z1 = Rcw1.row(2).dot(x3Dt)+tcw1.at&lt;float&gt;(2);
        if(z1&lt;=0)
            continue;

        float z2 = Rcw2.row(2).dot(x3Dt)+tcw2.at&lt;float&gt;(2);
        if(z2&lt;=0)
            continue;

        //Check reprojection error in first keyframe
        const float &amp;sigmaSquare1 = mpCurrentKeyFrame-&gt;mvLevelSigma2[kp1.octave];
        const float x1 = Rcw1.row(0).dot(x3Dt)+tcw1.at&lt;float&gt;(0);
        const float y1 = Rcw1.row(1).dot(x3Dt)+tcw1.at&lt;float&gt;(1);
        const float invz1 = 1.0/z1;

        if(!bStereo1)
        {
            float u1 = fx1*x1*invz1+cx1;
            float v1 = fy1*y1*invz1+cy1;
            float errX1 = u1 - kp1.pt.x;
            float errY1 = v1 - kp1.pt.y;
            if((errX1*errX1+errY1*errY1)&gt;5.991*sigmaSquare1)
                continue;
        }
        else
        {
            float u1 = fx1*x1*invz1+cx1;
            float u1_r = u1 - mpCurrentKeyFrame-&gt;mbf*invz1;
            float v1 = fy1*y1*invz1+cy1;
            float errX1 = u1 - kp1.pt.x;
            float errY1 = v1 - kp1.pt.y;
            float errX1_r = u1_r - kp1_ur;
            if((errX1*errX1+errY1*errY1+errX1_r*errX1_r)&gt;7.8*sigmaSquare1)
                continue;
        }

        //Check reprojection error in second keyframe
        const float sigmaSquare2 = pKF2-&gt;mvLevelSigma2[kp2.octave];
        const float x2 = Rcw2.row(0).dot(x3Dt)+tcw2.at&lt;float&gt;(0);
        const float y2 = Rcw2.row(1).dot(x3Dt)+tcw2.at&lt;float&gt;(1);
        const float invz2 = 1.0/z2;
        if(!bStereo2)
        {
            float u2 = fx2*x2*invz2+cx2;
            float v2 = fy2*y2*invz2+cy2;
            float errX2 = u2 - kp2.pt.x;
            float errY2 = v2 - kp2.pt.y;
            if((errX2*errX2+errY2*errY2)&gt;5.991*sigmaSquare2)
                continue;
        }
        else
        {
            float u2 = fx2*x2*invz2+cx2;
            float u2_r = u2 - mpCurrentKeyFrame-&gt;mbf*invz2;
            float v2 = fy2*y2*invz2+cy2;
            float errX2 = u2 - kp2.pt.x;
            float errY2 = v2 - kp2.pt.y;
            float errX2_r = u2_r - kp2_ur;
            if((errX2*errX2+errY2*errY2+errX2_r*errX2_r)&gt;7.8*sigmaSquare2)
                continue;
        }

        //Check scale consistency
        cv::Mat normal1 = x3D-Ow1;
        float dist1 = cv::norm(normal1);

        cv::Mat normal2 = x3D-Ow2;
        float dist2 = cv::norm(normal2);

        if(dist1==0 || dist2==0)
            continue;

        const float ratioDist = dist2/dist1;
        const float ratioOctave = mpCurrentKeyFrame-&gt;mvScaleFactors[kp1.octave]/pKF2-&gt;mvScaleFactors[kp2.octave];

        /*if(fabs(ratioDist-ratioOctave)&gt;ratioFactor)
            continue;*/
        if(ratioDist*ratioFactor&lt;ratioOctave || ratioDist&gt;ratioOctave*ratioFactor)
            continue;

        // Triangulation is succesfull
        MapPoint* pMP = new MapPoint(x3D,mpCurrentKeyFrame,mpMap);

        pMP-&gt;AddObservation(mpCurrentKeyFrame,idx1);            
        pMP-&gt;AddObservation(pKF2,idx2);

        mpCurrentKeyFrame-&gt;AddMapPoint(pMP,idx1);
        pKF2-&gt;AddMapPoint(pMP,idx2);

        pMP-&gt;ComputeDistinctiveDescriptors();

        pMP-&gt;UpdateNormalAndDepth();

        mpMap-&gt;AddMapPoint(pMP);
        mlpRecentAddedMapPoints.push_back(pMP);

        nnew++;
    }
}
</code></pre></div>
<p>}
<code>`SearchForTriangulation(...)` finds feature points from two keyframes to compute triangulation.
If two feature points have very small Hamming distance, they are regarded as referring to the same map point.

Denote $C_1=[X_1\quad Y_1\quad Z_1]^{\top}$ as the keyframe `pKF1`'s  camera center, 
the keyframe `pKF2`'s  camera center can be computed by $C_2=[X_2\quad Y_2\quad Z_2]^{\top}=R_2 C_1 + \mathbf{t}_2$.

$$
\begin{align*}
    e_x &amp;= f_x \frac{X_2}{Z_2} + c_x
    &amp;&amp;&amp;
    e_y &amp;= f_y \frac{Y_2}{Z_2} + c_y
\end{align*}
$$

In the figure below, having assumed keyframe `pKF1` on the left hand side, keyframe `pKF2` on the right hand side, there is $\mathbf{e}_R=[e_x\quad e_y]$

&lt;div style="display: flex; justify-content: center;"&gt;
      &lt;img src="imgs/epipolar_geo.png" width="40%" height="40%" alt="epipolar_geo" /&gt;
&lt;/div&gt;
&lt;/br&gt;

Then, search for corresponding matching points.

If `if(f1it-&gt;first == f2it-&gt;first)` is false, it means the features are located on different nodes/branches of the BoW tree.
For example, `if(f1it-&gt;first &lt; f2it-&gt;first)` is true, it means `f1it`'s node id is smaller than `f2it`'s, indicating `f2it` resides at a higer layer (closer to leaf nodes) than `f1it`'s, 
hence having `f1it = vFeatVec1.lower_bound(f2it-&gt;first);` to move `f1it` to `f2it`'s layer.

The feature point `kp2.pt` must keep some distance away from $\mathbf{e}_R$, then run `CheckDistEpipolarLine(kp1,kp2,F12,pKF2)` which find the distance/error of matching points by epipolar geometry.
If `CheckDistEpipolarLine(kp1,kp2,F12,pKF2)` retruns true, it means there is a good triangulation result, and should record the keypoint index `idx2` for `kp2`.</code>cpp
const float distex = ex-kp2.pt.x;
const float distey = ey-kp2.pt.y;
if(distex<em>distex+distey</em>distey&lt;100*pKF2-&gt;mvScaleFactors[kp2.octave])
    continue;

if(CheckDistEpipolarLine(kp1,kp2,F12,pKF2))
{
    bestIdx2 = idx2;
    bestDist = dist;
}
```</p>
<p>Finally, apply rotation consistency.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">ORBmatcher::SearchForTriangulation</span><span class="p">(</span><span class="n">KeyFrame</span><span class="w"> </span><span class="o">*</span><span class="n">pKF1</span><span class="p">,</span><span class="w"> </span><span class="n">KeyFrame</span><span class="w"> </span><span class="o">*</span><span class="n">pKF2</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">F12</span><span class="p">,</span>
<a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a><span class="w">                                       </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vMatchedPairs</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">bOnlyStereo</span><span class="p">)</span>
<a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a><span class="p">{</span><span class="w">    </span>
<a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">DBoW2</span><span class="o">::</span><span class="n">FeatureVector</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vFeatVec1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF1</span><span class="o">-&gt;</span><span class="n">mFeatVec</span><span class="p">;</span>
<a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">DBoW2</span><span class="o">::</span><span class="n">FeatureVector</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vFeatVec2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF2</span><span class="o">-&gt;</span><span class="n">mFeatVec</span><span class="p">;</span>
<a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a>
<a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a><span class="w">    </span><span class="c1">//Compute epipole in second image</span>
<a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">Cw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF1</span><span class="o">-&gt;</span><span class="n">GetCameraCenter</span><span class="p">();</span>
<a id="__codelineno-51-9" name="__codelineno-51-9" href="#__codelineno-51-9"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">R2w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF2</span><span class="o">-&gt;</span><span class="n">GetRotation</span><span class="p">();</span>
<a id="__codelineno-51-10" name="__codelineno-51-10" href="#__codelineno-51-10"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">t2w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF2</span><span class="o">-&gt;</span><span class="n">GetTranslation</span><span class="p">();</span>
<a id="__codelineno-51-11" name="__codelineno-51-11" href="#__codelineno-51-11"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">C2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">R2w</span><span class="o">*</span><span class="n">Cw</span><span class="o">+</span><span class="n">t2w</span><span class="p">;</span>
<a id="__codelineno-51-12" name="__codelineno-51-12" href="#__codelineno-51-12"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">invz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0f</span><span class="o">/</span><span class="n">C2</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-51-13" name="__codelineno-51-13" href="#__codelineno-51-13"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">ex</span><span class="w"> </span><span class="o">=</span><span class="n">pKF2</span><span class="o">-&gt;</span><span class="n">fx</span><span class="o">*</span><span class="n">C2</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">invz</span><span class="o">+</span><span class="n">pKF2</span><span class="o">-&gt;</span><span class="n">cx</span><span class="p">;</span>
<a id="__codelineno-51-14" name="__codelineno-51-14" href="#__codelineno-51-14"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">ey</span><span class="w"> </span><span class="o">=</span><span class="n">pKF2</span><span class="o">-&gt;</span><span class="n">fy</span><span class="o">*</span><span class="n">C2</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">invz</span><span class="o">+</span><span class="n">pKF2</span><span class="o">-&gt;</span><span class="n">cy</span><span class="p">;</span>
<a id="__codelineno-51-15" name="__codelineno-51-15" href="#__codelineno-51-15"></a>
<a id="__codelineno-51-16" name="__codelineno-51-16" href="#__codelineno-51-16"></a><span class="w">    </span><span class="c1">// Find matches between not tracked keypoints</span>
<a id="__codelineno-51-17" name="__codelineno-51-17" href="#__codelineno-51-17"></a><span class="w">    </span><span class="c1">// Matching speed-up by ORB Vocabulary</span>
<a id="__codelineno-51-18" name="__codelineno-51-18" href="#__codelineno-51-18"></a><span class="w">    </span><span class="c1">// Compare only ORB that share the same node</span>
<a id="__codelineno-51-19" name="__codelineno-51-19" href="#__codelineno-51-19"></a>
<a id="__codelineno-51-20" name="__codelineno-51-20" href="#__codelineno-51-20"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nmatches</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-51-21" name="__codelineno-51-21" href="#__codelineno-51-21"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vbMatched2</span><span class="p">(</span><span class="n">pKF2</span><span class="o">-&gt;</span><span class="n">N</span><span class="p">,</span><span class="nb">false</span><span class="p">);</span>
<a id="__codelineno-51-22" name="__codelineno-51-22" href="#__codelineno-51-22"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vMatches12</span><span class="p">(</span><span class="n">pKF1</span><span class="o">-&gt;</span><span class="n">N</span><span class="p">,</span><span class="mi">-1</span><span class="p">);</span>
<a id="__codelineno-51-23" name="__codelineno-51-23" href="#__codelineno-51-23"></a>
<a id="__codelineno-51-24" name="__codelineno-51-24" href="#__codelineno-51-24"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">rotHist</span><span class="p">[</span><span class="n">HISTO_LENGTH</span><span class="p">];</span>
<a id="__codelineno-51-25" name="__codelineno-51-25" href="#__codelineno-51-25"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">HISTO_LENGTH</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-51-26" name="__codelineno-51-26" href="#__codelineno-51-26"></a><span class="w">        </span><span class="n">rotHist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reserve</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
<a id="__codelineno-51-27" name="__codelineno-51-27" href="#__codelineno-51-27"></a>
<a id="__codelineno-51-28" name="__codelineno-51-28" href="#__codelineno-51-28"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">factor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0f</span><span class="o">/</span><span class="n">HISTO_LENGTH</span><span class="p">;</span>
<a id="__codelineno-51-29" name="__codelineno-51-29" href="#__codelineno-51-29"></a>
<a id="__codelineno-51-30" name="__codelineno-51-30" href="#__codelineno-51-30"></a><span class="w">    </span><span class="n">DBoW2</span><span class="o">::</span><span class="n">FeatureVector</span><span class="o">::</span><span class="n">const_iterator</span><span class="w"> </span><span class="n">f1it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vFeatVec1</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
<a id="__codelineno-51-31" name="__codelineno-51-31" href="#__codelineno-51-31"></a><span class="w">    </span><span class="n">DBoW2</span><span class="o">::</span><span class="n">FeatureVector</span><span class="o">::</span><span class="n">const_iterator</span><span class="w"> </span><span class="n">f2it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vFeatVec2</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
<a id="__codelineno-51-32" name="__codelineno-51-32" href="#__codelineno-51-32"></a><span class="w">    </span><span class="n">DBoW2</span><span class="o">::</span><span class="n">FeatureVector</span><span class="o">::</span><span class="n">const_iterator</span><span class="w"> </span><span class="n">f1end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vFeatVec1</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
<a id="__codelineno-51-33" name="__codelineno-51-33" href="#__codelineno-51-33"></a><span class="w">    </span><span class="n">DBoW2</span><span class="o">::</span><span class="n">FeatureVector</span><span class="o">::</span><span class="n">const_iterator</span><span class="w"> </span><span class="n">f2end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vFeatVec2</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
<a id="__codelineno-51-34" name="__codelineno-51-34" href="#__codelineno-51-34"></a>
<a id="__codelineno-51-35" name="__codelineno-51-35" href="#__codelineno-51-35"></a><span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="n">f1it</span><span class="o">!=</span><span class="n">f1end</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">f2it</span><span class="o">!=</span><span class="n">f2end</span><span class="p">)</span>
<a id="__codelineno-51-36" name="__codelineno-51-36" href="#__codelineno-51-36"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-51-37" name="__codelineno-51-37" href="#__codelineno-51-37"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">f1it</span><span class="o">-&gt;</span><span class="n">first</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">f2it</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">)</span>
<a id="__codelineno-51-38" name="__codelineno-51-38" href="#__codelineno-51-38"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-51-39" name="__codelineno-51-39" href="#__codelineno-51-39"></a><span class="w">            </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">iend1</span><span class="o">=</span><span class="n">f1it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i1</span><span class="o">&lt;</span><span class="n">iend1</span><span class="p">;</span><span class="w"> </span><span class="n">i1</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-51-40" name="__codelineno-51-40" href="#__codelineno-51-40"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-51-41" name="__codelineno-51-41" href="#__codelineno-51-41"></a><span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">idx1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f1it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">[</span><span class="n">i1</span><span class="p">];</span>
<a id="__codelineno-51-42" name="__codelineno-51-42" href="#__codelineno-51-42"></a>
<a id="__codelineno-51-43" name="__codelineno-51-43" href="#__codelineno-51-43"></a><span class="w">                </span><span class="n">MapPoint</span><span class="o">*</span><span class="w"> </span><span class="n">pMP1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF1</span><span class="o">-&gt;</span><span class="n">GetMapPoint</span><span class="p">(</span><span class="n">idx1</span><span class="p">);</span>
<a id="__codelineno-51-44" name="__codelineno-51-44" href="#__codelineno-51-44"></a>
<a id="__codelineno-51-45" name="__codelineno-51-45" href="#__codelineno-51-45"></a><span class="w">                </span><span class="c1">// If there is already a MapPoint skip</span>
<a id="__codelineno-51-46" name="__codelineno-51-46" href="#__codelineno-51-46"></a><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">pMP1</span><span class="p">)</span>
<a id="__codelineno-51-47" name="__codelineno-51-47" href="#__codelineno-51-47"></a><span class="w">                    </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-51-48" name="__codelineno-51-48" href="#__codelineno-51-48"></a>
<a id="__codelineno-51-49" name="__codelineno-51-49" href="#__codelineno-51-49"></a><span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">bStereo1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF1</span><span class="o">-&gt;</span><span class="n">mvuRight</span><span class="p">[</span><span class="n">idx1</span><span class="p">]</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-51-50" name="__codelineno-51-50" href="#__codelineno-51-50"></a>
<a id="__codelineno-51-51" name="__codelineno-51-51" href="#__codelineno-51-51"></a><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">bOnlyStereo</span><span class="p">)</span>
<a id="__codelineno-51-52" name="__codelineno-51-52" href="#__codelineno-51-52"></a><span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">bStereo1</span><span class="p">)</span>
<a id="__codelineno-51-53" name="__codelineno-51-53" href="#__codelineno-51-53"></a><span class="w">                        </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-51-54" name="__codelineno-51-54" href="#__codelineno-51-54"></a>
<a id="__codelineno-51-55" name="__codelineno-51-55" href="#__codelineno-51-55"></a><span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">KeyPoint</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kp1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF1</span><span class="o">-&gt;</span><span class="n">mvKeysUn</span><span class="p">[</span><span class="n">idx1</span><span class="p">];</span>
<a id="__codelineno-51-56" name="__codelineno-51-56" href="#__codelineno-51-56"></a>
<a id="__codelineno-51-57" name="__codelineno-51-57" href="#__codelineno-51-57"></a><span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="o">&amp;</span><span class="n">d1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF1</span><span class="o">-&gt;</span><span class="n">mDescriptors</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="n">idx1</span><span class="p">);</span>
<a id="__codelineno-51-58" name="__codelineno-51-58" href="#__codelineno-51-58"></a>
<a id="__codelineno-51-59" name="__codelineno-51-59" href="#__codelineno-51-59"></a><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">bestDist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TH_LOW</span><span class="p">;</span>
<a id="__codelineno-51-60" name="__codelineno-51-60" href="#__codelineno-51-60"></a><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">bestIdx2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<a id="__codelineno-51-61" name="__codelineno-51-61" href="#__codelineno-51-61"></a>
<a id="__codelineno-51-62" name="__codelineno-51-62" href="#__codelineno-51-62"></a><span class="w">                </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i2</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">iend2</span><span class="o">=</span><span class="n">f2it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i2</span><span class="o">&lt;</span><span class="n">iend2</span><span class="p">;</span><span class="w"> </span><span class="n">i2</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-51-63" name="__codelineno-51-63" href="#__codelineno-51-63"></a><span class="w">                </span><span class="p">{</span>
<a id="__codelineno-51-64" name="__codelineno-51-64" href="#__codelineno-51-64"></a><span class="w">                    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">idx2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f2it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">[</span><span class="n">i2</span><span class="p">];</span>
<a id="__codelineno-51-65" name="__codelineno-51-65" href="#__codelineno-51-65"></a>
<a id="__codelineno-51-66" name="__codelineno-51-66" href="#__codelineno-51-66"></a><span class="w">                    </span><span class="n">MapPoint</span><span class="o">*</span><span class="w"> </span><span class="n">pMP2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF2</span><span class="o">-&gt;</span><span class="n">GetMapPoint</span><span class="p">(</span><span class="n">idx2</span><span class="p">);</span>
<a id="__codelineno-51-67" name="__codelineno-51-67" href="#__codelineno-51-67"></a>
<a id="__codelineno-51-68" name="__codelineno-51-68" href="#__codelineno-51-68"></a><span class="w">                    </span><span class="c1">// If we have already matched or there is a MapPoint skip</span>
<a id="__codelineno-51-69" name="__codelineno-51-69" href="#__codelineno-51-69"></a><span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="n">vbMatched2</span><span class="p">[</span><span class="n">idx2</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">pMP2</span><span class="p">)</span>
<a id="__codelineno-51-70" name="__codelineno-51-70" href="#__codelineno-51-70"></a><span class="w">                        </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-51-71" name="__codelineno-51-71" href="#__codelineno-51-71"></a>
<a id="__codelineno-51-72" name="__codelineno-51-72" href="#__codelineno-51-72"></a><span class="w">                    </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">bStereo2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF2</span><span class="o">-&gt;</span><span class="n">mvuRight</span><span class="p">[</span><span class="n">idx2</span><span class="p">]</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-51-73" name="__codelineno-51-73" href="#__codelineno-51-73"></a>
<a id="__codelineno-51-74" name="__codelineno-51-74" href="#__codelineno-51-74"></a><span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="n">bOnlyStereo</span><span class="p">)</span>
<a id="__codelineno-51-75" name="__codelineno-51-75" href="#__codelineno-51-75"></a><span class="w">                        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">bStereo2</span><span class="p">)</span>
<a id="__codelineno-51-76" name="__codelineno-51-76" href="#__codelineno-51-76"></a><span class="w">                            </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-51-77" name="__codelineno-51-77" href="#__codelineno-51-77"></a>
<a id="__codelineno-51-78" name="__codelineno-51-78" href="#__codelineno-51-78"></a><span class="w">                    </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="o">&amp;</span><span class="n">d2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF2</span><span class="o">-&gt;</span><span class="n">mDescriptors</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="n">idx2</span><span class="p">);</span>
<a id="__codelineno-51-79" name="__codelineno-51-79" href="#__codelineno-51-79"></a>
<a id="__codelineno-51-80" name="__codelineno-51-80" href="#__codelineno-51-80"></a><span class="w">                    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DescriptorDistance</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span><span class="n">d2</span><span class="p">);</span>
<a id="__codelineno-51-81" name="__codelineno-51-81" href="#__codelineno-51-81"></a>
<a id="__codelineno-51-82" name="__codelineno-51-82" href="#__codelineno-51-82"></a><span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="n">dist</span><span class="o">&gt;</span><span class="n">TH_LOW</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">dist</span><span class="o">&gt;</span><span class="n">bestDist</span><span class="p">)</span>
<a id="__codelineno-51-83" name="__codelineno-51-83" href="#__codelineno-51-83"></a><span class="w">                        </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-51-84" name="__codelineno-51-84" href="#__codelineno-51-84"></a>
<a id="__codelineno-51-85" name="__codelineno-51-85" href="#__codelineno-51-85"></a><span class="w">                    </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">KeyPoint</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kp2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF2</span><span class="o">-&gt;</span><span class="n">mvKeysUn</span><span class="p">[</span><span class="n">idx2</span><span class="p">];</span>
<a id="__codelineno-51-86" name="__codelineno-51-86" href="#__codelineno-51-86"></a>
<a id="__codelineno-51-87" name="__codelineno-51-87" href="#__codelineno-51-87"></a><span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">bStereo1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">bStereo2</span><span class="p">)</span>
<a id="__codelineno-51-88" name="__codelineno-51-88" href="#__codelineno-51-88"></a><span class="w">                    </span><span class="p">{</span>
<a id="__codelineno-51-89" name="__codelineno-51-89" href="#__codelineno-51-89"></a><span class="w">                        </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">distex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ex</span><span class="o">-</span><span class="n">kp2</span><span class="p">.</span><span class="n">pt</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<a id="__codelineno-51-90" name="__codelineno-51-90" href="#__codelineno-51-90"></a><span class="w">                        </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">distey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ey</span><span class="o">-</span><span class="n">kp2</span><span class="p">.</span><span class="n">pt</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<a id="__codelineno-51-91" name="__codelineno-51-91" href="#__codelineno-51-91"></a><span class="w">                        </span><span class="k">if</span><span class="p">(</span><span class="n">distex</span><span class="o">*</span><span class="n">distex</span><span class="o">+</span><span class="n">distey</span><span class="o">*</span><span class="n">distey</span><span class="o">&lt;</span><span class="mi">100</span><span class="o">*</span><span class="n">pKF2</span><span class="o">-&gt;</span><span class="n">mvScaleFactors</span><span class="p">[</span><span class="n">kp2</span><span class="p">.</span><span class="n">octave</span><span class="p">])</span>
<a id="__codelineno-51-92" name="__codelineno-51-92" href="#__codelineno-51-92"></a><span class="w">                            </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-51-93" name="__codelineno-51-93" href="#__codelineno-51-93"></a><span class="w">                    </span><span class="p">}</span>
<a id="__codelineno-51-94" name="__codelineno-51-94" href="#__codelineno-51-94"></a>
<a id="__codelineno-51-95" name="__codelineno-51-95" href="#__codelineno-51-95"></a><span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="n">CheckDistEpipolarLine</span><span class="p">(</span><span class="n">kp1</span><span class="p">,</span><span class="n">kp2</span><span class="p">,</span><span class="n">F12</span><span class="p">,</span><span class="n">pKF2</span><span class="p">))</span>
<a id="__codelineno-51-96" name="__codelineno-51-96" href="#__codelineno-51-96"></a><span class="w">                    </span><span class="p">{</span>
<a id="__codelineno-51-97" name="__codelineno-51-97" href="#__codelineno-51-97"></a><span class="w">                        </span><span class="n">bestIdx2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idx2</span><span class="p">;</span>
<a id="__codelineno-51-98" name="__codelineno-51-98" href="#__codelineno-51-98"></a><span class="w">                        </span><span class="n">bestDist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dist</span><span class="p">;</span>
<a id="__codelineno-51-99" name="__codelineno-51-99" href="#__codelineno-51-99"></a><span class="w">                    </span><span class="p">}</span>
<a id="__codelineno-51-100" name="__codelineno-51-100" href="#__codelineno-51-100"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-51-101" name="__codelineno-51-101" href="#__codelineno-51-101"></a>
<a id="__codelineno-51-102" name="__codelineno-51-102" href="#__codelineno-51-102"></a><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">bestIdx2</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-51-103" name="__codelineno-51-103" href="#__codelineno-51-103"></a><span class="w">                </span><span class="p">{</span>
<a id="__codelineno-51-104" name="__codelineno-51-104" href="#__codelineno-51-104"></a><span class="w">                    </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">KeyPoint</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kp2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF2</span><span class="o">-&gt;</span><span class="n">mvKeysUn</span><span class="p">[</span><span class="n">bestIdx2</span><span class="p">];</span>
<a id="__codelineno-51-105" name="__codelineno-51-105" href="#__codelineno-51-105"></a><span class="w">                    </span><span class="n">vMatches12</span><span class="p">[</span><span class="n">idx1</span><span class="p">]</span><span class="o">=</span><span class="n">bestIdx2</span><span class="p">;</span>
<a id="__codelineno-51-106" name="__codelineno-51-106" href="#__codelineno-51-106"></a><span class="w">                    </span><span class="n">nmatches</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-51-107" name="__codelineno-51-107" href="#__codelineno-51-107"></a>
<a id="__codelineno-51-108" name="__codelineno-51-108" href="#__codelineno-51-108"></a><span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="n">mbCheckOrientation</span><span class="p">)</span>
<a id="__codelineno-51-109" name="__codelineno-51-109" href="#__codelineno-51-109"></a><span class="w">                    </span><span class="p">{</span>
<a id="__codelineno-51-110" name="__codelineno-51-110" href="#__codelineno-51-110"></a><span class="w">                        </span><span class="kt">float</span><span class="w"> </span><span class="n">rot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kp1</span><span class="p">.</span><span class="n">angle</span><span class="o">-</span><span class="n">kp2</span><span class="p">.</span><span class="n">angle</span><span class="p">;</span>
<a id="__codelineno-51-111" name="__codelineno-51-111" href="#__codelineno-51-111"></a><span class="w">                        </span><span class="k">if</span><span class="p">(</span><span class="n">rot</span><span class="o">&lt;</span><span class="mf">0.0</span><span class="p">)</span>
<a id="__codelineno-51-112" name="__codelineno-51-112" href="#__codelineno-51-112"></a><span class="w">                            </span><span class="n">rot</span><span class="o">+=</span><span class="mf">360.0f</span><span class="p">;</span>
<a id="__codelineno-51-113" name="__codelineno-51-113" href="#__codelineno-51-113"></a><span class="w">                        </span><span class="kt">int</span><span class="w"> </span><span class="n">bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">round</span><span class="p">(</span><span class="n">rot</span><span class="o">*</span><span class="n">factor</span><span class="p">);</span>
<a id="__codelineno-51-114" name="__codelineno-51-114" href="#__codelineno-51-114"></a><span class="w">                        </span><span class="k">if</span><span class="p">(</span><span class="n">bin</span><span class="o">==</span><span class="n">HISTO_LENGTH</span><span class="p">)</span>
<a id="__codelineno-51-115" name="__codelineno-51-115" href="#__codelineno-51-115"></a><span class="w">                            </span><span class="n">bin</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-51-116" name="__codelineno-51-116" href="#__codelineno-51-116"></a><span class="w">                        </span><span class="n">assert</span><span class="p">(</span><span class="n">bin</span><span class="o">&gt;=</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">bin</span><span class="o">&lt;</span><span class="n">HISTO_LENGTH</span><span class="p">);</span>
<a id="__codelineno-51-117" name="__codelineno-51-117" href="#__codelineno-51-117"></a><span class="w">                        </span><span class="n">rotHist</span><span class="p">[</span><span class="n">bin</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">idx1</span><span class="p">);</span>
<a id="__codelineno-51-118" name="__codelineno-51-118" href="#__codelineno-51-118"></a><span class="w">                    </span><span class="p">}</span>
<a id="__codelineno-51-119" name="__codelineno-51-119" href="#__codelineno-51-119"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-51-120" name="__codelineno-51-120" href="#__codelineno-51-120"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-51-121" name="__codelineno-51-121" href="#__codelineno-51-121"></a>
<a id="__codelineno-51-122" name="__codelineno-51-122" href="#__codelineno-51-122"></a><span class="w">            </span><span class="n">f1it</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-51-123" name="__codelineno-51-123" href="#__codelineno-51-123"></a><span class="w">            </span><span class="n">f2it</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-51-124" name="__codelineno-51-124" href="#__codelineno-51-124"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-51-125" name="__codelineno-51-125" href="#__codelineno-51-125"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">f1it</span><span class="o">-&gt;</span><span class="n">first</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">f2it</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">)</span>
<a id="__codelineno-51-126" name="__codelineno-51-126" href="#__codelineno-51-126"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-51-127" name="__codelineno-51-127" href="#__codelineno-51-127"></a><span class="w">            </span><span class="n">f1it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vFeatVec1</span><span class="p">.</span><span class="n">lower_bound</span><span class="p">(</span><span class="n">f2it</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">);</span>
<a id="__codelineno-51-128" name="__codelineno-51-128" href="#__codelineno-51-128"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-51-129" name="__codelineno-51-129" href="#__codelineno-51-129"></a><span class="w">        </span><span class="k">else</span>
<a id="__codelineno-51-130" name="__codelineno-51-130" href="#__codelineno-51-130"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-51-131" name="__codelineno-51-131" href="#__codelineno-51-131"></a><span class="w">            </span><span class="n">f2it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vFeatVec2</span><span class="p">.</span><span class="n">lower_bound</span><span class="p">(</span><span class="n">f1it</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">);</span>
<a id="__codelineno-51-132" name="__codelineno-51-132" href="#__codelineno-51-132"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-51-133" name="__codelineno-51-133" href="#__codelineno-51-133"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-51-134" name="__codelineno-51-134" href="#__codelineno-51-134"></a>
<a id="__codelineno-51-135" name="__codelineno-51-135" href="#__codelineno-51-135"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mbCheckOrientation</span><span class="p">)</span>
<a id="__codelineno-51-136" name="__codelineno-51-136" href="#__codelineno-51-136"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-51-137" name="__codelineno-51-137" href="#__codelineno-51-137"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">ind1</span><span class="o">=</span><span class="mi">-1</span><span class="p">;</span>
<a id="__codelineno-51-138" name="__codelineno-51-138" href="#__codelineno-51-138"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">ind2</span><span class="o">=</span><span class="mi">-1</span><span class="p">;</span>
<a id="__codelineno-51-139" name="__codelineno-51-139" href="#__codelineno-51-139"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">ind3</span><span class="o">=</span><span class="mi">-1</span><span class="p">;</span>
<a id="__codelineno-51-140" name="__codelineno-51-140" href="#__codelineno-51-140"></a>
<a id="__codelineno-51-141" name="__codelineno-51-141" href="#__codelineno-51-141"></a><span class="w">        </span><span class="n">ComputeThreeMaxima</span><span class="p">(</span><span class="n">rotHist</span><span class="p">,</span><span class="n">HISTO_LENGTH</span><span class="p">,</span><span class="n">ind1</span><span class="p">,</span><span class="n">ind2</span><span class="p">,</span><span class="n">ind3</span><span class="p">);</span>
<a id="__codelineno-51-142" name="__codelineno-51-142" href="#__codelineno-51-142"></a>
<a id="__codelineno-51-143" name="__codelineno-51-143" href="#__codelineno-51-143"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">HISTO_LENGTH</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-51-144" name="__codelineno-51-144" href="#__codelineno-51-144"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-51-145" name="__codelineno-51-145" href="#__codelineno-51-145"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="n">ind1</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">i</span><span class="o">==</span><span class="n">ind2</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">i</span><span class="o">==</span><span class="n">ind3</span><span class="p">)</span>
<a id="__codelineno-51-146" name="__codelineno-51-146" href="#__codelineno-51-146"></a><span class="w">                </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-51-147" name="__codelineno-51-147" href="#__codelineno-51-147"></a><span class="w">            </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">jend</span><span class="o">=</span><span class="n">rotHist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;</span><span class="n">jend</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-51-148" name="__codelineno-51-148" href="#__codelineno-51-148"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-51-149" name="__codelineno-51-149" href="#__codelineno-51-149"></a><span class="w">                </span><span class="n">vMatches12</span><span class="p">[</span><span class="n">rotHist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]]</span><span class="o">=</span><span class="mi">-1</span><span class="p">;</span>
<a id="__codelineno-51-150" name="__codelineno-51-150" href="#__codelineno-51-150"></a><span class="w">                </span><span class="n">nmatches</span><span class="o">--</span><span class="p">;</span>
<a id="__codelineno-51-151" name="__codelineno-51-151" href="#__codelineno-51-151"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-51-152" name="__codelineno-51-152" href="#__codelineno-51-152"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-51-153" name="__codelineno-51-153" href="#__codelineno-51-153"></a>
<a id="__codelineno-51-154" name="__codelineno-51-154" href="#__codelineno-51-154"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-51-155" name="__codelineno-51-155" href="#__codelineno-51-155"></a>
<a id="__codelineno-51-156" name="__codelineno-51-156" href="#__codelineno-51-156"></a><span class="w">    </span><span class="n">vMatchedPairs</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<a id="__codelineno-51-157" name="__codelineno-51-157" href="#__codelineno-51-157"></a><span class="w">    </span><span class="n">vMatchedPairs</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">nmatches</span><span class="p">);</span>
<a id="__codelineno-51-158" name="__codelineno-51-158" href="#__codelineno-51-158"></a>
<a id="__codelineno-51-159" name="__codelineno-51-159" href="#__codelineno-51-159"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">iend</span><span class="o">=</span><span class="n">vMatches12</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">iend</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-51-160" name="__codelineno-51-160" href="#__codelineno-51-160"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-51-161" name="__codelineno-51-161" href="#__codelineno-51-161"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">vMatches12</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-51-162" name="__codelineno-51-162" href="#__codelineno-51-162"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-51-163" name="__codelineno-51-163" href="#__codelineno-51-163"></a><span class="w">        </span><span class="n">vMatchedPairs</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">make_pair</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">vMatches12</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
<a id="__codelineno-51-164" name="__codelineno-51-164" href="#__codelineno-51-164"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-51-165" name="__codelineno-51-165" href="#__codelineno-51-165"></a>
<a id="__codelineno-51-166" name="__codelineno-51-166" href="#__codelineno-51-166"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">nmatches</span><span class="p">;</span>
<a id="__codelineno-51-167" name="__codelineno-51-167" href="#__codelineno-51-167"></a><span class="p">}</span>
</code></pre></div>
<div style="display: flex; justify-content: center;">
      <img src="imgs/epipolar_geo.png" width="40%" height="40%" alt="epipolar_geo" />
</div>
<p></br></p>
<p>Compute epipolar line <span class="arithmatex">\(\mathbf{l}_r=[l_{ra}\quad l_{rb}\quad l_{rc}]\)</span> in right image:</p>
<div class="arithmatex">\[
\mathbf{l}_r =
\mathbf{x}_l^{\top} F_{rl} =
\begin{bmatrix}
    x_l \\\\
    y_l \\\\
    1 \\\\
\end{bmatrix}^{\top}
F_{rl}
\qquad
\mathbf{l}_r \mathbf{x}_r = 
\mathbf{l}_r
\begin{bmatrix}
    x_r \\\\
    y_r \\\\
    1 \\\\
\end{bmatrix}
\]</div>
<p>Idealy, there is <span class="arithmatex">\(\mathbf{x}_l^{\top} F_{rl} \mathbf{x}_r = 0\)</span> by epipolar gemomerty constraints.
But often, there is error such that <span class="arithmatex">\(e = \mathbf{x}_l^{\top} F_{rl} \mathbf{x}_r \ne 0\)</span>.</p>
<p>Look at epipolar line <span class="arithmatex">\(\mathbf{l}_r=[l_{ra}\quad l_{rb}\quad l_{rc}]\)</span>, having assumed Guassian noises for <span class="arithmatex">\(\mathbf{x}_r\)</span>, <span class="arithmatex">\(\mathbf{x}_r\)</span> should have the mean <span class="arithmatex">\(\mu_{\mathbf{x}_r}=[l_{ra}\quad l_{rb}\quad 0]\)</span>.
By Chi-squared test <span class="arithmatex">\(\frac{(observed-expected)^2}{expected}\)</span>, can compute if the epipolar error is small.</p>
<p><span class="arithmatex">\(3.84\)</span> refers to <span class="arithmatex">\(1\)</span>-d Chi-squared distribution at the <span class="arithmatex">\(95\%\)</span> confidence level.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="kt">bool</span><span class="w"> </span><span class="nf">ORBmatcher::CheckDistEpipolarLine</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">KeyPoint</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kp1</span><span class="p">,</span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">KeyPoint</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kp2</span><span class="p">,</span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="o">&amp;</span><span class="n">F12</span><span class="p">,</span><span class="k">const</span><span class="w"> </span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pKF2</span><span class="p">)</span>
<a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a><span class="p">{</span>
<a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a><span class="w">    </span><span class="c1">// Epipolar line in second image l = x1&#39;F12 = [a b c]</span>
<a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kp1</span><span class="p">.</span><span class="n">pt</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">F12</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">kp1</span><span class="p">.</span><span class="n">pt</span><span class="p">.</span><span class="n">y</span><span class="o">*</span><span class="n">F12</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">F12</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kp1</span><span class="p">.</span><span class="n">pt</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">F12</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">kp1</span><span class="p">.</span><span class="n">pt</span><span class="p">.</span><span class="n">y</span><span class="o">*</span><span class="n">F12</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">F12</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kp1</span><span class="p">.</span><span class="n">pt</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">F12</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">kp1</span><span class="p">.</span><span class="n">pt</span><span class="p">.</span><span class="n">y</span><span class="o">*</span><span class="n">F12</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">F12</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-52-7" name="__codelineno-52-7" href="#__codelineno-52-7"></a>
<a id="__codelineno-52-8" name="__codelineno-52-8" href="#__codelineno-52-8"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="o">*</span><span class="n">kp2</span><span class="p">.</span><span class="n">pt</span><span class="p">.</span><span class="n">x</span><span class="o">+</span><span class="n">b</span><span class="o">*</span><span class="n">kp2</span><span class="p">.</span><span class="n">pt</span><span class="p">.</span><span class="n">y</span><span class="o">+</span><span class="n">c</span><span class="p">;</span>
<a id="__codelineno-52-9" name="__codelineno-52-9" href="#__codelineno-52-9"></a>
<a id="__codelineno-52-10" name="__codelineno-52-10" href="#__codelineno-52-10"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">den</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="o">*</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="o">*</span><span class="n">b</span><span class="p">;</span>
<a id="__codelineno-52-11" name="__codelineno-52-11" href="#__codelineno-52-11"></a>
<a id="__codelineno-52-12" name="__codelineno-52-12" href="#__codelineno-52-12"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">den</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-52-13" name="__codelineno-52-13" href="#__codelineno-52-13"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-52-14" name="__codelineno-52-14" href="#__codelineno-52-14"></a>
<a id="__codelineno-52-15" name="__codelineno-52-15" href="#__codelineno-52-15"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">dsqr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">num</span><span class="o">*</span><span class="n">num</span><span class="o">/</span><span class="n">den</span><span class="p">;</span>
<a id="__codelineno-52-16" name="__codelineno-52-16" href="#__codelineno-52-16"></a>
<a id="__codelineno-52-17" name="__codelineno-52-17" href="#__codelineno-52-17"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">dsqr</span><span class="o">&lt;</span><span class="mf">3.84</span><span class="o">*</span><span class="n">pKF2</span><span class="o">-&gt;</span><span class="n">mvLevelSigma2</span><span class="p">[</span><span class="n">kp2</span><span class="p">.</span><span class="n">octave</span><span class="p">];</span>
<a id="__codelineno-52-18" name="__codelineno-52-18" href="#__codelineno-52-18"></a><span class="p">}</span>
</code></pre></div>
<h2 id="loop-closure">Loop Closure</h2>
<p><code>LoopClosing</code> is a thread launched from <code>System::System(...)</code> when ORB-SLAM starts.
Thread runs <code>ORB_SLAM2::LoopClosing::Run();</code> which is a <code>while(true)</code> loop that does the below tasks.</p>
<p>Generally speaking, it first performs <code>DetectLoop();</code>, then <code>CorrectLoop()</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="n">System</span><span class="o">::</span><span class="n">System</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">strVocFile</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">strSettingsFile</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">eSensor</span><span class="w"> </span><span class="n">sensor</span><span class="p">,</span>
<a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a><span class="w">               </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">bUseViewer</span><span class="p">)</span><span class="o">:</span><span class="n">mSensor</span><span class="p">(</span><span class="n">sensor</span><span class="p">),</span><span class="w"> </span><span class="n">mpViewer</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Viewer</span><span class="o">*&gt;</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)),</span><span class="w"> </span><span class="n">mbReset</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span><span class="n">mbActivateLocalizationMode</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span>
<a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a><span class="w">        </span><span class="n">mbDeactivateLocalizationMode</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span>
<a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a><span class="p">{</span>
<a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a>
<a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a><span class="w">    </span><span class="c1">//Initialize the Loop Closing thread and launch</span>
<a id="__codelineno-53-8" name="__codelineno-53-8" href="#__codelineno-53-8"></a><span class="w">    </span><span class="n">mpLoopCloser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LoopClosing</span><span class="p">(</span><span class="n">mpMap</span><span class="p">,</span><span class="w"> </span><span class="n">mpKeyFrameDatabase</span><span class="p">,</span><span class="w"> </span><span class="n">mpVocabulary</span><span class="p">,</span><span class="w"> </span><span class="n">mSensor</span><span class="o">!=</span><span class="n">MONOCULAR</span><span class="p">);</span>
<a id="__codelineno-53-9" name="__codelineno-53-9" href="#__codelineno-53-9"></a><span class="w">    </span><span class="n">mptLoopClosing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kr">thread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ORB_SLAM2</span><span class="o">::</span><span class="n">LoopClosing</span><span class="o">::</span><span class="n">Run</span><span class="p">,</span><span class="w"> </span><span class="n">mpLoopCloser</span><span class="p">);</span>
<a id="__codelineno-53-10" name="__codelineno-53-10" href="#__codelineno-53-10"></a>
<a id="__codelineno-53-11" name="__codelineno-53-11" href="#__codelineno-53-11"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-53-12" name="__codelineno-53-12" href="#__codelineno-53-12"></a><span class="p">}</span>
<a id="__codelineno-53-13" name="__codelineno-53-13" href="#__codelineno-53-13"></a>
<a id="__codelineno-53-14" name="__codelineno-53-14" href="#__codelineno-53-14"></a><span class="kt">void</span><span class="w"> </span><span class="n">LoopClosing</span><span class="o">::</span><span class="n">Run</span><span class="p">()</span>
<a id="__codelineno-53-15" name="__codelineno-53-15" href="#__codelineno-53-15"></a><span class="p">{</span>
<a id="__codelineno-53-16" name="__codelineno-53-16" href="#__codelineno-53-16"></a><span class="w">    </span><span class="n">mbFinished</span><span class="w"> </span><span class="o">=</span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-53-17" name="__codelineno-53-17" href="#__codelineno-53-17"></a>
<a id="__codelineno-53-18" name="__codelineno-53-18" href="#__codelineno-53-18"></a><span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-53-19" name="__codelineno-53-19" href="#__codelineno-53-19"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-53-20" name="__codelineno-53-20" href="#__codelineno-53-20"></a><span class="w">        </span><span class="c1">// Check if there are keyframes in the queue</span>
<a id="__codelineno-53-21" name="__codelineno-53-21" href="#__codelineno-53-21"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">CheckNewKeyFrames</span><span class="p">())</span>
<a id="__codelineno-53-22" name="__codelineno-53-22" href="#__codelineno-53-22"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-53-23" name="__codelineno-53-23" href="#__codelineno-53-23"></a><span class="w">            </span><span class="c1">// Detect loop candidates and check covisibility consistency</span>
<a id="__codelineno-53-24" name="__codelineno-53-24" href="#__codelineno-53-24"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">DetectLoop</span><span class="p">())</span>
<a id="__codelineno-53-25" name="__codelineno-53-25" href="#__codelineno-53-25"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-53-26" name="__codelineno-53-26" href="#__codelineno-53-26"></a><span class="w">               </span><span class="c1">// Compute similarity transformation [sR|t]</span>
<a id="__codelineno-53-27" name="__codelineno-53-27" href="#__codelineno-53-27"></a><span class="w">               </span><span class="c1">// In the stereo/RGBD case s=1</span>
<a id="__codelineno-53-28" name="__codelineno-53-28" href="#__codelineno-53-28"></a><span class="w">               </span><span class="k">if</span><span class="p">(</span><span class="n">ComputeSim3</span><span class="p">())</span>
<a id="__codelineno-53-29" name="__codelineno-53-29" href="#__codelineno-53-29"></a><span class="w">               </span><span class="p">{</span>
<a id="__codelineno-53-30" name="__codelineno-53-30" href="#__codelineno-53-30"></a><span class="w">                   </span><span class="c1">// Perform loop fusion and pose graph optimization</span>
<a id="__codelineno-53-31" name="__codelineno-53-31" href="#__codelineno-53-31"></a><span class="w">                   </span><span class="n">CorrectLoop</span><span class="p">();</span>
<a id="__codelineno-53-32" name="__codelineno-53-32" href="#__codelineno-53-32"></a><span class="w">               </span><span class="p">}</span>
<a id="__codelineno-53-33" name="__codelineno-53-33" href="#__codelineno-53-33"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-53-34" name="__codelineno-53-34" href="#__codelineno-53-34"></a><span class="w">        </span><span class="p">}</span><span class="w">       </span>
<a id="__codelineno-53-35" name="__codelineno-53-35" href="#__codelineno-53-35"></a>
<a id="__codelineno-53-36" name="__codelineno-53-36" href="#__codelineno-53-36"></a><span class="w">        </span><span class="n">ResetIfRequested</span><span class="p">();</span>
<a id="__codelineno-53-37" name="__codelineno-53-37" href="#__codelineno-53-37"></a>
<a id="__codelineno-53-38" name="__codelineno-53-38" href="#__codelineno-53-38"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">CheckFinish</span><span class="p">())</span>
<a id="__codelineno-53-39" name="__codelineno-53-39" href="#__codelineno-53-39"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-53-40" name="__codelineno-53-40" href="#__codelineno-53-40"></a>
<a id="__codelineno-53-41" name="__codelineno-53-41" href="#__codelineno-53-41"></a><span class="w">        </span><span class="n">usleep</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span>
<a id="__codelineno-53-42" name="__codelineno-53-42" href="#__codelineno-53-42"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-53-43" name="__codelineno-53-43" href="#__codelineno-53-43"></a>
<a id="__codelineno-53-44" name="__codelineno-53-44" href="#__codelineno-53-44"></a><span class="w">    </span><span class="n">SetFinish</span><span class="p">();</span>
<a id="__codelineno-53-45" name="__codelineno-53-45" href="#__codelineno-53-45"></a><span class="p">}</span>
</code></pre></div>
<h3 id="detectloop"><code>DetectLoop()</code></h3>
<p><code>DetectLoop()</code> uses BoW to compare similarities between the current keyframe and others from covisibility keyframes.</p>
<p>Recall that covisibility keyframes of a keyframe are stored as a vector of keyframe pointers that are sorted by the number of co-observed features.
<div class="highlight"><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">KeyFrame::UpdateBestCovisibles</span><span class="p">()</span>
<a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a><span class="p">{</span>
<a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a><span class="w">    </span><span class="n">mvpOrderedConnectedKeyFrames</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">lKFs</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="n">lKFs</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
<a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a><span class="w">    </span><span class="n">mvOrderedWeights</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">lWs</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">lWs</span><span class="p">.</span><span class="n">end</span><span class="p">());</span><span class="w">  </span>
<a id="__codelineno-54-6" name="__codelineno-54-6" href="#__codelineno-54-6"></a><span class="p">}</span><span class="w">  </span>
</code></pre></div></p>
<p>In DBoW2, image similarity is measured by comparing BoW vector representations of the two keyframes, and a score is produced such that <code>float score = mpORBVocabulary-&gt;score(CurrentBowVec, BowVec);</code>.
Higher the score, more similar the two images.</p>
<div class="arithmatex">\[
\text{s}(\mathbf{v}_1, \mathbf{v}_2) =
1 - \frac{1}{2}
\Bigg| \frac{\mathbf{v}_1}{|\mathbf{v}_1|} - \frac{\mathbf{v}_2}{|\mathbf{v}_2|} \Bigg|
\]</div>
<p><code>mpKeyFrameDB-&gt;DetectLoopCandidates(mpCurrentKF, minScore);</code> finds history keyframes that share visual features.
Keyframes' score must be greater than <code>minScore</code> to be considered as loop candidate keyframes.
<div class="highlight"><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="n">vector</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">KeyFrameDatabase</span><span class="o">::</span><span class="n">DetectLoopCandidates</span><span class="p">(</span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pKF</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">minScore</span><span class="p">)</span>
<a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a><span class="p">{</span>
<a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a><span class="w">    </span><span class="c1">// extract each word/feature from this current keyframe</span>
<a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">DBoW2</span><span class="o">::</span><span class="n">BowVector</span><span class="o">::</span><span class="n">const_iterator</span><span class="w"> </span><span class="n">vit</span><span class="o">=</span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">mBowVec</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">vend</span><span class="o">=</span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">mBowVec</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">vit</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">vend</span><span class="p">;</span><span class="w"> </span><span class="n">vit</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a><span class="w">        </span><span class="n">list</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lKFs</span><span class="w"> </span><span class="o">=</span><span class="w">   </span><span class="n">mvInvertedFile</span><span class="p">[</span><span class="n">vit</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">];</span>
<a id="__codelineno-55-6" name="__codelineno-55-6" href="#__codelineno-55-6"></a><span class="w">        </span><span class="c1">// from each word/feature, find all keyframes having observed this feature</span>
<a id="__codelineno-55-7" name="__codelineno-55-7" href="#__codelineno-55-7"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">list</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">lit</span><span class="o">=</span><span class="n">lKFs</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">lend</span><span class="o">=</span><span class="w"> </span><span class="n">lKFs</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">lit</span><span class="o">!=</span><span class="n">lend</span><span class="p">;</span><span class="w"> </span><span class="n">lit</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-55-8" name="__codelineno-55-8" href="#__codelineno-55-8"></a><span class="w">            </span><span class="p">...</span><span class="w"> </span><span class="c1">// record/count keyframes</span>
<a id="__codelineno-55-9" name="__codelineno-55-9" href="#__codelineno-55-9"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-55-10" name="__codelineno-55-10" href="#__codelineno-55-10"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-55-11" name="__codelineno-55-11" href="#__codelineno-55-11"></a><span class="w">    </span><span class="p">...</span><span class="w"> </span><span class="c1">// some engineering filter details, such as filtering out keyframes having scores too low, </span>
<a id="__codelineno-55-12" name="__codelineno-55-12" href="#__codelineno-55-12"></a><span class="w">        </span><span class="c1">// do not include neighbor keyframes</span>
<a id="__codelineno-55-13" name="__codelineno-55-13" href="#__codelineno-55-13"></a>
<a id="__codelineno-55-14" name="__codelineno-55-14" href="#__codelineno-55-14"></a><span class="w">    </span><span class="p">...</span><span class="w"> </span><span class="c1">// `list&lt;pair&lt;float,KeyFrame*&gt; &gt; lAccScoreAndMatch;` is used to store some best score keyframes</span>
<a id="__codelineno-55-15" name="__codelineno-55-15" href="#__codelineno-55-15"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">vpLoopCandidates</span><span class="p">;</span>
<a id="__codelineno-55-16" name="__codelineno-55-16" href="#__codelineno-55-16"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">list</span><span class="o">&lt;</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="n">KeyFrame</span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">it</span><span class="o">=</span><span class="n">lAccScoreAndMatch</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">itend</span><span class="o">=</span><span class="n">lAccScoreAndMatch</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="o">!=</span><span class="n">itend</span><span class="p">;</span><span class="w"> </span><span class="n">it</span><span class="o">++</span><span class="p">){</span>
<a id="__codelineno-55-17" name="__codelineno-55-17" href="#__codelineno-55-17"></a><span class="w">        </span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pKFi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
<a id="__codelineno-55-18" name="__codelineno-55-18" href="#__codelineno-55-18"></a><span class="w">        </span><span class="n">vpLoopCandidates</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pKFi</span><span class="p">);</span>
<a id="__codelineno-55-19" name="__codelineno-55-19" href="#__codelineno-55-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-55-20" name="__codelineno-55-20" href="#__codelineno-55-20"></a>
<a id="__codelineno-55-21" name="__codelineno-55-21" href="#__codelineno-55-21"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">vpLoopCandidates</span><span class="p">;</span>
<a id="__codelineno-55-22" name="__codelineno-55-22" href="#__codelineno-55-22"></a><span class="p">}</span>
</code></pre></div></p>
<p>Then, for each loop candidate check consistency with previous loop candidates.
For each candidate keyframe <code>KeyFrame* pCandidateKF = vpCandidateKFs[i];</code>, derive <code>set&lt;KeyFrame*&gt; spCandidateGroup = pCandidateKF-&gt;GetConnectedKeyFrames();</code>, which is a group of keyframes sharing some observed features with the current keyframe.
Then, iterate through <code>std::vector&lt;std::pair&lt;std::set&lt;ORB_SLAM2::KeyFrame *&gt;, int&gt;&gt; mvConsistentGroups</code>, whose element is a pair that associates keyframe group with this group's the number of previous consistent keyframes.
A consistency group's elements' key is a previous group <code>set&lt;KeyFrame*&gt; sPreviousGroup = mvConsistentGroups[iG].first;</code> that if <code>if(sPreviousGroup.count(*sit))</code> holds ture, it means a previous group has seen a candidate group <code>set&lt;KeyFrame*&gt;::iterator sit</code>, and it can be said the previous group is consistent.</p>
<p>If is consistent, the consistent group is updated such as below.
<div class="highlight"><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">nCurrentConsistency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nPreviousConsistency</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a><span class="n">ConsistentGroup</span><span class="w"> </span><span class="n">cg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">make_pair</span><span class="p">(</span><span class="n">spCandidateGroup</span><span class="p">,</span><span class="n">nCurrentConsistency</span><span class="p">);</span>
<a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a><span class="n">vCurrentConsistentGroups</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">cg</span><span class="p">);</span>
</code></pre></div></p>
<p>The full <code>DetectLoop()</code> goes as below.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="kt">bool</span><span class="w"> </span><span class="nf">LoopClosing::DetectLoop</span><span class="p">()</span>
<a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a><span class="p">{</span>
<a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a><span class="w">        </span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">mMutexLoopQueue</span><span class="p">);</span>
<a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a><span class="w">        </span><span class="n">mpCurrentKF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mlpLoopKeyFrameQueue</span><span class="p">.</span><span class="n">front</span><span class="p">();</span>
<a id="__codelineno-57-6" name="__codelineno-57-6" href="#__codelineno-57-6"></a><span class="w">        </span><span class="n">mlpLoopKeyFrameQueue</span><span class="p">.</span><span class="n">pop_front</span><span class="p">();</span>
<a id="__codelineno-57-7" name="__codelineno-57-7" href="#__codelineno-57-7"></a><span class="w">        </span><span class="c1">// Avoid that a keyframe can be erased while it is being process by this thread</span>
<a id="__codelineno-57-8" name="__codelineno-57-8" href="#__codelineno-57-8"></a><span class="w">        </span><span class="n">mpCurrentKF</span><span class="o">-&gt;</span><span class="n">SetNotErase</span><span class="p">();</span>
<a id="__codelineno-57-9" name="__codelineno-57-9" href="#__codelineno-57-9"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-57-10" name="__codelineno-57-10" href="#__codelineno-57-10"></a>
<a id="__codelineno-57-11" name="__codelineno-57-11" href="#__codelineno-57-11"></a><span class="w">    </span><span class="c1">//If the map contains less than 10 KF or less than 10 KF have passed from last loop detection</span>
<a id="__codelineno-57-12" name="__codelineno-57-12" href="#__codelineno-57-12"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mpCurrentKF</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="o">&lt;</span><span class="n">mLastLoopKFid</span><span class="o">+</span><span class="mi">10</span><span class="p">)</span>
<a id="__codelineno-57-13" name="__codelineno-57-13" href="#__codelineno-57-13"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-57-14" name="__codelineno-57-14" href="#__codelineno-57-14"></a><span class="w">        </span><span class="n">mpKeyFrameDB</span><span class="o">-&gt;</span><span class="n">add</span><span class="p">(</span><span class="n">mpCurrentKF</span><span class="p">);</span>
<a id="__codelineno-57-15" name="__codelineno-57-15" href="#__codelineno-57-15"></a><span class="w">        </span><span class="n">mpCurrentKF</span><span class="o">-&gt;</span><span class="n">SetErase</span><span class="p">();</span>
<a id="__codelineno-57-16" name="__codelineno-57-16" href="#__codelineno-57-16"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-57-17" name="__codelineno-57-17" href="#__codelineno-57-17"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-57-18" name="__codelineno-57-18" href="#__codelineno-57-18"></a>
<a id="__codelineno-57-19" name="__codelineno-57-19" href="#__codelineno-57-19"></a><span class="w">    </span><span class="c1">// Compute reference BoW similarity score</span>
<a id="__codelineno-57-20" name="__codelineno-57-20" href="#__codelineno-57-20"></a><span class="w">    </span><span class="c1">// This is the lowest score to a connected keyframe in the covisibility graph</span>
<a id="__codelineno-57-21" name="__codelineno-57-21" href="#__codelineno-57-21"></a><span class="w">    </span><span class="c1">// We will impose loop candidates to have a higher similarity than this</span>
<a id="__codelineno-57-22" name="__codelineno-57-22" href="#__codelineno-57-22"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">vpConnectedKeyFrames</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mpCurrentKF</span><span class="o">-&gt;</span><span class="n">GetVectorCovisibleKeyFrames</span><span class="p">();</span>
<a id="__codelineno-57-23" name="__codelineno-57-23" href="#__codelineno-57-23"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">DBoW2</span><span class="o">::</span><span class="n">BowVector</span><span class="w"> </span><span class="o">&amp;</span><span class="n">CurrentBowVec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mpCurrentKF</span><span class="o">-&gt;</span><span class="n">mBowVec</span><span class="p">;</span>
<a id="__codelineno-57-24" name="__codelineno-57-24" href="#__codelineno-57-24"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">minScore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-57-25" name="__codelineno-57-25" href="#__codelineno-57-25"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">vpConnectedKeyFrames</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-57-26" name="__codelineno-57-26" href="#__codelineno-57-26"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-57-27" name="__codelineno-57-27" href="#__codelineno-57-27"></a><span class="w">        </span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pKF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vpConnectedKeyFrames</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-57-28" name="__codelineno-57-28" href="#__codelineno-57-28"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">isBad</span><span class="p">())</span>
<a id="__codelineno-57-29" name="__codelineno-57-29" href="#__codelineno-57-29"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-57-30" name="__codelineno-57-30" href="#__codelineno-57-30"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">DBoW2</span><span class="o">::</span><span class="n">BowVector</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BowVec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">mBowVec</span><span class="p">;</span>
<a id="__codelineno-57-31" name="__codelineno-57-31" href="#__codelineno-57-31"></a>
<a id="__codelineno-57-32" name="__codelineno-57-32" href="#__codelineno-57-32"></a><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mpORBVocabulary</span><span class="o">-&gt;</span><span class="n">score</span><span class="p">(</span><span class="n">CurrentBowVec</span><span class="p">,</span><span class="w"> </span><span class="n">BowVec</span><span class="p">);</span>
<a id="__codelineno-57-33" name="__codelineno-57-33" href="#__codelineno-57-33"></a>
<a id="__codelineno-57-34" name="__codelineno-57-34" href="#__codelineno-57-34"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">score</span><span class="o">&lt;</span><span class="n">minScore</span><span class="p">)</span>
<a id="__codelineno-57-35" name="__codelineno-57-35" href="#__codelineno-57-35"></a><span class="w">            </span><span class="n">minScore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">score</span><span class="p">;</span>
<a id="__codelineno-57-36" name="__codelineno-57-36" href="#__codelineno-57-36"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-57-37" name="__codelineno-57-37" href="#__codelineno-57-37"></a>
<a id="__codelineno-57-38" name="__codelineno-57-38" href="#__codelineno-57-38"></a><span class="w">    </span><span class="c1">// Query the database imposing the minimum score</span>
<a id="__codelineno-57-39" name="__codelineno-57-39" href="#__codelineno-57-39"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">vpCandidateKFs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mpKeyFrameDB</span><span class="o">-&gt;</span><span class="n">DetectLoopCandidates</span><span class="p">(</span><span class="n">mpCurrentKF</span><span class="p">,</span><span class="w"> </span><span class="n">minScore</span><span class="p">);</span>
<a id="__codelineno-57-40" name="__codelineno-57-40" href="#__codelineno-57-40"></a>
<a id="__codelineno-57-41" name="__codelineno-57-41" href="#__codelineno-57-41"></a><span class="w">    </span><span class="c1">// If there are no loop candidates, just add new keyframe and return false</span>
<a id="__codelineno-57-42" name="__codelineno-57-42" href="#__codelineno-57-42"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">vpCandidateKFs</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
<a id="__codelineno-57-43" name="__codelineno-57-43" href="#__codelineno-57-43"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-57-44" name="__codelineno-57-44" href="#__codelineno-57-44"></a><span class="w">        </span><span class="n">mpKeyFrameDB</span><span class="o">-&gt;</span><span class="n">add</span><span class="p">(</span><span class="n">mpCurrentKF</span><span class="p">);</span>
<a id="__codelineno-57-45" name="__codelineno-57-45" href="#__codelineno-57-45"></a><span class="w">        </span><span class="n">mvConsistentGroups</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<a id="__codelineno-57-46" name="__codelineno-57-46" href="#__codelineno-57-46"></a><span class="w">        </span><span class="n">mpCurrentKF</span><span class="o">-&gt;</span><span class="n">SetErase</span><span class="p">();</span>
<a id="__codelineno-57-47" name="__codelineno-57-47" href="#__codelineno-57-47"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-57-48" name="__codelineno-57-48" href="#__codelineno-57-48"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-57-49" name="__codelineno-57-49" href="#__codelineno-57-49"></a>
<a id="__codelineno-57-50" name="__codelineno-57-50" href="#__codelineno-57-50"></a><span class="w">    </span><span class="c1">// For each loop candidate check consistency with previous loop candidates</span>
<a id="__codelineno-57-51" name="__codelineno-57-51" href="#__codelineno-57-51"></a><span class="w">    </span><span class="c1">// Each candidate expands a covisibility group (keyframes connected to the loop candidate in the covisibility graph)</span>
<a id="__codelineno-57-52" name="__codelineno-57-52" href="#__codelineno-57-52"></a><span class="w">    </span><span class="c1">// A group is consistent with a previous group if they share at least a keyframe</span>
<a id="__codelineno-57-53" name="__codelineno-57-53" href="#__codelineno-57-53"></a><span class="w">    </span><span class="c1">// We must detect a consistent loop in several consecutive keyframes to accept it</span>
<a id="__codelineno-57-54" name="__codelineno-57-54" href="#__codelineno-57-54"></a><span class="w">    </span><span class="n">mvpEnoughConsistentCandidates</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<a id="__codelineno-57-55" name="__codelineno-57-55" href="#__codelineno-57-55"></a>
<a id="__codelineno-57-56" name="__codelineno-57-56" href="#__codelineno-57-56"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">ConsistentGroup</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vCurrentConsistentGroups</span><span class="p">;</span>
<a id="__codelineno-57-57" name="__codelineno-57-57" href="#__codelineno-57-57"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vbConsistentGroup</span><span class="p">(</span><span class="n">mvConsistentGroups</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span><span class="nb">false</span><span class="p">);</span>
<a id="__codelineno-57-58" name="__codelineno-57-58" href="#__codelineno-57-58"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">iend</span><span class="o">=</span><span class="n">vpCandidateKFs</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">iend</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-57-59" name="__codelineno-57-59" href="#__codelineno-57-59"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-57-60" name="__codelineno-57-60" href="#__codelineno-57-60"></a><span class="w">        </span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pCandidateKF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vpCandidateKFs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-57-61" name="__codelineno-57-61" href="#__codelineno-57-61"></a>
<a id="__codelineno-57-62" name="__codelineno-57-62" href="#__codelineno-57-62"></a><span class="w">        </span><span class="n">set</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">spCandidateGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pCandidateKF</span><span class="o">-&gt;</span><span class="n">GetConnectedKeyFrames</span><span class="p">();</span>
<a id="__codelineno-57-63" name="__codelineno-57-63" href="#__codelineno-57-63"></a><span class="w">        </span><span class="n">spCandidateGroup</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pCandidateKF</span><span class="p">);</span>
<a id="__codelineno-57-64" name="__codelineno-57-64" href="#__codelineno-57-64"></a>
<a id="__codelineno-57-65" name="__codelineno-57-65" href="#__codelineno-57-65"></a><span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">bEnoughConsistent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-57-66" name="__codelineno-57-66" href="#__codelineno-57-66"></a><span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">bConsistentForSomeGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-57-67" name="__codelineno-57-67" href="#__codelineno-57-67"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">iG</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">iendG</span><span class="o">=</span><span class="n">mvConsistentGroups</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">iG</span><span class="o">&lt;</span><span class="n">iendG</span><span class="p">;</span><span class="w"> </span><span class="n">iG</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-57-68" name="__codelineno-57-68" href="#__codelineno-57-68"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-57-69" name="__codelineno-57-69" href="#__codelineno-57-69"></a><span class="w">            </span><span class="n">set</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">sPreviousGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mvConsistentGroups</span><span class="p">[</span><span class="n">iG</span><span class="p">].</span><span class="n">first</span><span class="p">;</span>
<a id="__codelineno-57-70" name="__codelineno-57-70" href="#__codelineno-57-70"></a>
<a id="__codelineno-57-71" name="__codelineno-57-71" href="#__codelineno-57-71"></a><span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="n">bConsistent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-57-72" name="__codelineno-57-72" href="#__codelineno-57-72"></a><span class="w">            </span><span class="k">for</span><span class="p">(</span><span class="n">set</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">sit</span><span class="o">=</span><span class="n">spCandidateGroup</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">send</span><span class="o">=</span><span class="n">spCandidateGroup</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">sit</span><span class="o">!=</span><span class="n">send</span><span class="p">;</span><span class="n">sit</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-57-73" name="__codelineno-57-73" href="#__codelineno-57-73"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-57-74" name="__codelineno-57-74" href="#__codelineno-57-74"></a><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">sPreviousGroup</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="o">*</span><span class="n">sit</span><span class="p">))</span>
<a id="__codelineno-57-75" name="__codelineno-57-75" href="#__codelineno-57-75"></a><span class="w">                </span><span class="p">{</span>
<a id="__codelineno-57-76" name="__codelineno-57-76" href="#__codelineno-57-76"></a><span class="w">                    </span><span class="n">bConsistent</span><span class="o">=</span><span class="nb">true</span><span class="p">;</span>
<a id="__codelineno-57-77" name="__codelineno-57-77" href="#__codelineno-57-77"></a><span class="w">                    </span><span class="n">bConsistentForSomeGroup</span><span class="o">=</span><span class="nb">true</span><span class="p">;</span>
<a id="__codelineno-57-78" name="__codelineno-57-78" href="#__codelineno-57-78"></a><span class="w">                    </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-57-79" name="__codelineno-57-79" href="#__codelineno-57-79"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-57-80" name="__codelineno-57-80" href="#__codelineno-57-80"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-57-81" name="__codelineno-57-81" href="#__codelineno-57-81"></a>
<a id="__codelineno-57-82" name="__codelineno-57-82" href="#__codelineno-57-82"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">bConsistent</span><span class="p">)</span>
<a id="__codelineno-57-83" name="__codelineno-57-83" href="#__codelineno-57-83"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-57-84" name="__codelineno-57-84" href="#__codelineno-57-84"></a><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">nPreviousConsistency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mvConsistentGroups</span><span class="p">[</span><span class="n">iG</span><span class="p">].</span><span class="n">second</span><span class="p">;</span>
<a id="__codelineno-57-85" name="__codelineno-57-85" href="#__codelineno-57-85"></a><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">nCurrentConsistency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nPreviousConsistency</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-57-86" name="__codelineno-57-86" href="#__codelineno-57-86"></a><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">vbConsistentGroup</span><span class="p">[</span><span class="n">iG</span><span class="p">])</span>
<a id="__codelineno-57-87" name="__codelineno-57-87" href="#__codelineno-57-87"></a><span class="w">                </span><span class="p">{</span>
<a id="__codelineno-57-88" name="__codelineno-57-88" href="#__codelineno-57-88"></a><span class="w">                    </span><span class="n">ConsistentGroup</span><span class="w"> </span><span class="n">cg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">make_pair</span><span class="p">(</span><span class="n">spCandidateGroup</span><span class="p">,</span><span class="n">nCurrentConsistency</span><span class="p">);</span>
<a id="__codelineno-57-89" name="__codelineno-57-89" href="#__codelineno-57-89"></a><span class="w">                    </span><span class="n">vCurrentConsistentGroups</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">cg</span><span class="p">);</span>
<a id="__codelineno-57-90" name="__codelineno-57-90" href="#__codelineno-57-90"></a><span class="w">                    </span><span class="n">vbConsistentGroup</span><span class="p">[</span><span class="n">iG</span><span class="p">]</span><span class="o">=</span><span class="nb">true</span><span class="p">;</span><span class="w"> </span><span class="c1">//this avoid to include the same group more than once</span>
<a id="__codelineno-57-91" name="__codelineno-57-91" href="#__codelineno-57-91"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-57-92" name="__codelineno-57-92" href="#__codelineno-57-92"></a><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">nCurrentConsistency</span><span class="o">&gt;=</span><span class="n">mnCovisibilityConsistencyTh</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">bEnoughConsistent</span><span class="p">)</span>
<a id="__codelineno-57-93" name="__codelineno-57-93" href="#__codelineno-57-93"></a><span class="w">                </span><span class="p">{</span>
<a id="__codelineno-57-94" name="__codelineno-57-94" href="#__codelineno-57-94"></a><span class="w">                    </span><span class="n">mvpEnoughConsistentCandidates</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pCandidateKF</span><span class="p">);</span>
<a id="__codelineno-57-95" name="__codelineno-57-95" href="#__codelineno-57-95"></a><span class="w">                    </span><span class="n">bEnoughConsistent</span><span class="o">=</span><span class="nb">true</span><span class="p">;</span><span class="w"> </span><span class="c1">//this avoid to insert the same candidate more than once</span>
<a id="__codelineno-57-96" name="__codelineno-57-96" href="#__codelineno-57-96"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-57-97" name="__codelineno-57-97" href="#__codelineno-57-97"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-57-98" name="__codelineno-57-98" href="#__codelineno-57-98"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-57-99" name="__codelineno-57-99" href="#__codelineno-57-99"></a>
<a id="__codelineno-57-100" name="__codelineno-57-100" href="#__codelineno-57-100"></a><span class="w">        </span><span class="c1">// If the group is not consistent with any previous group insert with consistency counter set to zero</span>
<a id="__codelineno-57-101" name="__codelineno-57-101" href="#__codelineno-57-101"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">bConsistentForSomeGroup</span><span class="p">)</span>
<a id="__codelineno-57-102" name="__codelineno-57-102" href="#__codelineno-57-102"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-57-103" name="__codelineno-57-103" href="#__codelineno-57-103"></a><span class="w">            </span><span class="n">ConsistentGroup</span><span class="w"> </span><span class="n">cg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">make_pair</span><span class="p">(</span><span class="n">spCandidateGroup</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-57-104" name="__codelineno-57-104" href="#__codelineno-57-104"></a><span class="w">            </span><span class="n">vCurrentConsistentGroups</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">cg</span><span class="p">);</span>
<a id="__codelineno-57-105" name="__codelineno-57-105" href="#__codelineno-57-105"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-57-106" name="__codelineno-57-106" href="#__codelineno-57-106"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-57-107" name="__codelineno-57-107" href="#__codelineno-57-107"></a>
<a id="__codelineno-57-108" name="__codelineno-57-108" href="#__codelineno-57-108"></a><span class="w">    </span><span class="c1">// Update Covisibility Consistent Groups</span>
<a id="__codelineno-57-109" name="__codelineno-57-109" href="#__codelineno-57-109"></a><span class="w">    </span><span class="n">mvConsistentGroups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vCurrentConsistentGroups</span><span class="p">;</span>
<a id="__codelineno-57-110" name="__codelineno-57-110" href="#__codelineno-57-110"></a>
<a id="__codelineno-57-111" name="__codelineno-57-111" href="#__codelineno-57-111"></a>
<a id="__codelineno-57-112" name="__codelineno-57-112" href="#__codelineno-57-112"></a><span class="w">    </span><span class="c1">// Add Current Keyframe to database</span>
<a id="__codelineno-57-113" name="__codelineno-57-113" href="#__codelineno-57-113"></a><span class="w">    </span><span class="n">mpKeyFrameDB</span><span class="o">-&gt;</span><span class="n">add</span><span class="p">(</span><span class="n">mpCurrentKF</span><span class="p">);</span>
<a id="__codelineno-57-114" name="__codelineno-57-114" href="#__codelineno-57-114"></a>
<a id="__codelineno-57-115" name="__codelineno-57-115" href="#__codelineno-57-115"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mvpEnoughConsistentCandidates</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
<a id="__codelineno-57-116" name="__codelineno-57-116" href="#__codelineno-57-116"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-57-117" name="__codelineno-57-117" href="#__codelineno-57-117"></a><span class="w">        </span><span class="n">mpCurrentKF</span><span class="o">-&gt;</span><span class="n">SetErase</span><span class="p">();</span>
<a id="__codelineno-57-118" name="__codelineno-57-118" href="#__codelineno-57-118"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-57-119" name="__codelineno-57-119" href="#__codelineno-57-119"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-57-120" name="__codelineno-57-120" href="#__codelineno-57-120"></a><span class="w">    </span><span class="k">else</span>
<a id="__codelineno-57-121" name="__codelineno-57-121" href="#__codelineno-57-121"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-57-122" name="__codelineno-57-122" href="#__codelineno-57-122"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<a id="__codelineno-57-123" name="__codelineno-57-123" href="#__codelineno-57-123"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-57-124" name="__codelineno-57-124" href="#__codelineno-57-124"></a>
<a id="__codelineno-57-125" name="__codelineno-57-125" href="#__codelineno-57-125"></a><span class="w">    </span><span class="n">mpCurrentKF</span><span class="o">-&gt;</span><span class="n">SetErase</span><span class="p">();</span>
<a id="__codelineno-57-126" name="__codelineno-57-126" href="#__codelineno-57-126"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-57-127" name="__codelineno-57-127" href="#__codelineno-57-127"></a><span class="p">}</span>
</code></pre></div>
<h3 id="computesim3"><code>ComputeSim3()</code></h3>
<p><code>ComputeSim3()</code> in loop closure:
1. find enough matching keypoints by <code>matcher.SearchByBoW(mpCurrentKF,pKF,vvpMapPointMatches[i]);</code>
2. launch <span class="arithmatex">\(Sim(3)\)</span> solver for the transform between this current keyframe and some consistent loop candidate keyframes
3. solve <span class="arithmatex">\(Sim(3)\)</span> by 5-point RANSAC <code>cv::Mat Scm  = pSolver-&gt;iterate(5,bNoMore,vbInliers,nInliers);</code>, that selects some map points to estimate the transform between two keyframes as well as validating the map points as inliers
4. with the obtained transform, <code>matcher.SearchBySim3(mpCurrentKF,pKF,vpMapPointMatches,s,R,t,7.5);</code> associates map points observed from two keyframes by first transforming the two points from two keyframes to one global coordinate system, then try to merge them if they sit close to each other and have small Hamming distance
5. perform fine-tuning <span class="arithmatex">\(Sim(3)\)</span> considering all inlier map points by <code>Optimizer::OptimizeSim3(mpCurrentKF, pKF, vpMapPointMatches, gScm, 10, mbFixScale);</code>
6. derive this current keyframe pose by <code>mg2oScw = gScm*gSmw;</code>, where <code>gScm</code> is the transform between the current keyframe the a candidate keyframe, and <code>gSmw</code> is the candidate keyframe <span class="arithmatex">\(Sim(3)\)</span> pose
7. finally, store the corrected <span class="arithmatex">\(Sim(3)\)</span> map points by <code>mvpLoopMapPoints.push_back(pMP);</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="kt">bool</span><span class="w"> </span><span class="nf">LoopClosing::ComputeSim3</span><span class="p">()</span>
<a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a><span class="p">{</span>
<a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a><span class="w">    </span><span class="c1">// For each consistent loop candidate we try to compute a Sim3</span>
<a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a>
<a id="__codelineno-58-5" name="__codelineno-58-5" href="#__codelineno-58-5"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nInitialCandidates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mvpEnoughConsistentCandidates</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<a id="__codelineno-58-6" name="__codelineno-58-6" href="#__codelineno-58-6"></a>
<a id="__codelineno-58-7" name="__codelineno-58-7" href="#__codelineno-58-7"></a><span class="w">    </span><span class="c1">// We compute first ORB matches for each candidate</span>
<a id="__codelineno-58-8" name="__codelineno-58-8" href="#__codelineno-58-8"></a><span class="w">    </span><span class="c1">// If enough matches are found, we setup a Sim3Solver</span>
<a id="__codelineno-58-9" name="__codelineno-58-9" href="#__codelineno-58-9"></a><span class="w">    </span><span class="n">ORBmatcher</span><span class="w"> </span><span class="n">matcher</span><span class="p">(</span><span class="mf">0.75</span><span class="p">,</span><span class="nb">true</span><span class="p">);</span>
<a id="__codelineno-58-10" name="__codelineno-58-10" href="#__codelineno-58-10"></a>
<a id="__codelineno-58-11" name="__codelineno-58-11" href="#__codelineno-58-11"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Sim3Solver</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">vpSim3Solvers</span><span class="p">;</span>
<a id="__codelineno-58-12" name="__codelineno-58-12" href="#__codelineno-58-12"></a><span class="w">    </span><span class="n">vpSim3Solvers</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">nInitialCandidates</span><span class="p">);</span>
<a id="__codelineno-58-13" name="__codelineno-58-13" href="#__codelineno-58-13"></a>
<a id="__codelineno-58-14" name="__codelineno-58-14" href="#__codelineno-58-14"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vvpMapPointMatches</span><span class="p">;</span>
<a id="__codelineno-58-15" name="__codelineno-58-15" href="#__codelineno-58-15"></a><span class="w">    </span><span class="n">vvpMapPointMatches</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">nInitialCandidates</span><span class="p">);</span>
<a id="__codelineno-58-16" name="__codelineno-58-16" href="#__codelineno-58-16"></a>
<a id="__codelineno-58-17" name="__codelineno-58-17" href="#__codelineno-58-17"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vbDiscarded</span><span class="p">;</span>
<a id="__codelineno-58-18" name="__codelineno-58-18" href="#__codelineno-58-18"></a><span class="w">    </span><span class="n">vbDiscarded</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">nInitialCandidates</span><span class="p">);</span>
<a id="__codelineno-58-19" name="__codelineno-58-19" href="#__codelineno-58-19"></a>
<a id="__codelineno-58-20" name="__codelineno-58-20" href="#__codelineno-58-20"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nCandidates</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">//candidates with enough matches</span>
<a id="__codelineno-58-21" name="__codelineno-58-21" href="#__codelineno-58-21"></a>
<a id="__codelineno-58-22" name="__codelineno-58-22" href="#__codelineno-58-22"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">nInitialCandidates</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-58-23" name="__codelineno-58-23" href="#__codelineno-58-23"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-58-24" name="__codelineno-58-24" href="#__codelineno-58-24"></a><span class="w">        </span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pKF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mvpEnoughConsistentCandidates</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-58-25" name="__codelineno-58-25" href="#__codelineno-58-25"></a>
<a id="__codelineno-58-26" name="__codelineno-58-26" href="#__codelineno-58-26"></a><span class="w">        </span><span class="c1">// avoid that local mapping erase it while it is being processed in this thread</span>
<a id="__codelineno-58-27" name="__codelineno-58-27" href="#__codelineno-58-27"></a><span class="w">        </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">SetNotErase</span><span class="p">();</span>
<a id="__codelineno-58-28" name="__codelineno-58-28" href="#__codelineno-58-28"></a>
<a id="__codelineno-58-29" name="__codelineno-58-29" href="#__codelineno-58-29"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">isBad</span><span class="p">())</span>
<a id="__codelineno-58-30" name="__codelineno-58-30" href="#__codelineno-58-30"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-58-31" name="__codelineno-58-31" href="#__codelineno-58-31"></a><span class="w">            </span><span class="n">vbDiscarded</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<a id="__codelineno-58-32" name="__codelineno-58-32" href="#__codelineno-58-32"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-58-33" name="__codelineno-58-33" href="#__codelineno-58-33"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-58-34" name="__codelineno-58-34" href="#__codelineno-58-34"></a>
<a id="__codelineno-58-35" name="__codelineno-58-35" href="#__codelineno-58-35"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">nmatches</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">matcher</span><span class="p">.</span><span class="n">SearchByBoW</span><span class="p">(</span><span class="n">mpCurrentKF</span><span class="p">,</span><span class="n">pKF</span><span class="p">,</span><span class="n">vvpMapPointMatches</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<a id="__codelineno-58-36" name="__codelineno-58-36" href="#__codelineno-58-36"></a>
<a id="__codelineno-58-37" name="__codelineno-58-37" href="#__codelineno-58-37"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">nmatches</span><span class="o">&lt;</span><span class="mi">20</span><span class="p">)</span>
<a id="__codelineno-58-38" name="__codelineno-58-38" href="#__codelineno-58-38"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-58-39" name="__codelineno-58-39" href="#__codelineno-58-39"></a><span class="w">            </span><span class="n">vbDiscarded</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<a id="__codelineno-58-40" name="__codelineno-58-40" href="#__codelineno-58-40"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-58-41" name="__codelineno-58-41" href="#__codelineno-58-41"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-58-42" name="__codelineno-58-42" href="#__codelineno-58-42"></a><span class="w">        </span><span class="k">else</span>
<a id="__codelineno-58-43" name="__codelineno-58-43" href="#__codelineno-58-43"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-58-44" name="__codelineno-58-44" href="#__codelineno-58-44"></a><span class="w">            </span><span class="n">Sim3Solver</span><span class="o">*</span><span class="w"> </span><span class="n">pSolver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Sim3Solver</span><span class="p">(</span><span class="n">mpCurrentKF</span><span class="p">,</span><span class="n">pKF</span><span class="p">,</span><span class="n">vvpMapPointMatches</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">mbFixScale</span><span class="p">);</span>
<a id="__codelineno-58-45" name="__codelineno-58-45" href="#__codelineno-58-45"></a><span class="w">            </span><span class="n">pSolver</span><span class="o">-&gt;</span><span class="n">SetRansacParameters</span><span class="p">(</span><span class="mf">0.99</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">300</span><span class="p">);</span>
<a id="__codelineno-58-46" name="__codelineno-58-46" href="#__codelineno-58-46"></a><span class="w">            </span><span class="n">vpSim3Solvers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pSolver</span><span class="p">;</span>
<a id="__codelineno-58-47" name="__codelineno-58-47" href="#__codelineno-58-47"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-58-48" name="__codelineno-58-48" href="#__codelineno-58-48"></a>
<a id="__codelineno-58-49" name="__codelineno-58-49" href="#__codelineno-58-49"></a><span class="w">        </span><span class="n">nCandidates</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-58-50" name="__codelineno-58-50" href="#__codelineno-58-50"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-58-51" name="__codelineno-58-51" href="#__codelineno-58-51"></a>
<a id="__codelineno-58-52" name="__codelineno-58-52" href="#__codelineno-58-52"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">bMatch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-58-53" name="__codelineno-58-53" href="#__codelineno-58-53"></a>
<a id="__codelineno-58-54" name="__codelineno-58-54" href="#__codelineno-58-54"></a><span class="w">    </span><span class="c1">// Perform alternatively RANSAC iterations for each candidate</span>
<a id="__codelineno-58-55" name="__codelineno-58-55" href="#__codelineno-58-55"></a><span class="w">    </span><span class="c1">// until one is succesful or all fail</span>
<a id="__codelineno-58-56" name="__codelineno-58-56" href="#__codelineno-58-56"></a><span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="n">nCandidates</span><span class="o">&gt;</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">bMatch</span><span class="p">)</span>
<a id="__codelineno-58-57" name="__codelineno-58-57" href="#__codelineno-58-57"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-58-58" name="__codelineno-58-58" href="#__codelineno-58-58"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">nInitialCandidates</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-58-59" name="__codelineno-58-59" href="#__codelineno-58-59"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-58-60" name="__codelineno-58-60" href="#__codelineno-58-60"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">vbDiscarded</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<a id="__codelineno-58-61" name="__codelineno-58-61" href="#__codelineno-58-61"></a><span class="w">                </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-58-62" name="__codelineno-58-62" href="#__codelineno-58-62"></a>
<a id="__codelineno-58-63" name="__codelineno-58-63" href="#__codelineno-58-63"></a><span class="w">            </span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pKF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mvpEnoughConsistentCandidates</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-58-64" name="__codelineno-58-64" href="#__codelineno-58-64"></a>
<a id="__codelineno-58-65" name="__codelineno-58-65" href="#__codelineno-58-65"></a><span class="w">            </span><span class="c1">// Perform 5 Ransac Iterations</span>
<a id="__codelineno-58-66" name="__codelineno-58-66" href="#__codelineno-58-66"></a><span class="w">            </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vbInliers</span><span class="p">;</span>
<a id="__codelineno-58-67" name="__codelineno-58-67" href="#__codelineno-58-67"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">nInliers</span><span class="p">;</span>
<a id="__codelineno-58-68" name="__codelineno-58-68" href="#__codelineno-58-68"></a><span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="n">bNoMore</span><span class="p">;</span>
<a id="__codelineno-58-69" name="__codelineno-58-69" href="#__codelineno-58-69"></a>
<a id="__codelineno-58-70" name="__codelineno-58-70" href="#__codelineno-58-70"></a><span class="w">            </span><span class="n">Sim3Solver</span><span class="o">*</span><span class="w"> </span><span class="n">pSolver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vpSim3Solvers</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-58-71" name="__codelineno-58-71" href="#__codelineno-58-71"></a><span class="w">            </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">Scm</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">pSolver</span><span class="o">-&gt;</span><span class="n">iterate</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="n">bNoMore</span><span class="p">,</span><span class="n">vbInliers</span><span class="p">,</span><span class="n">nInliers</span><span class="p">);</span>
<a id="__codelineno-58-72" name="__codelineno-58-72" href="#__codelineno-58-72"></a>
<a id="__codelineno-58-73" name="__codelineno-58-73" href="#__codelineno-58-73"></a><span class="w">            </span><span class="c1">// If Ransac reachs max. iterations discard keyframe</span>
<a id="__codelineno-58-74" name="__codelineno-58-74" href="#__codelineno-58-74"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">bNoMore</span><span class="p">)</span>
<a id="__codelineno-58-75" name="__codelineno-58-75" href="#__codelineno-58-75"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-58-76" name="__codelineno-58-76" href="#__codelineno-58-76"></a><span class="w">                </span><span class="n">vbDiscarded</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="nb">true</span><span class="p">;</span>
<a id="__codelineno-58-77" name="__codelineno-58-77" href="#__codelineno-58-77"></a><span class="w">                </span><span class="n">nCandidates</span><span class="o">--</span><span class="p">;</span>
<a id="__codelineno-58-78" name="__codelineno-58-78" href="#__codelineno-58-78"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-58-79" name="__codelineno-58-79" href="#__codelineno-58-79"></a>
<a id="__codelineno-58-80" name="__codelineno-58-80" href="#__codelineno-58-80"></a><span class="w">            </span><span class="c1">// If RANSAC returns a Sim3, perform a guided matching and optimize with all correspondences</span>
<a id="__codelineno-58-81" name="__codelineno-58-81" href="#__codelineno-58-81"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">Scm</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
<a id="__codelineno-58-82" name="__codelineno-58-82" href="#__codelineno-58-82"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-58-83" name="__codelineno-58-83" href="#__codelineno-58-83"></a><span class="w">                </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">vpMapPointMatches</span><span class="p">(</span><span class="n">vvpMapPointMatches</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">(),</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
<a id="__codelineno-58-84" name="__codelineno-58-84" href="#__codelineno-58-84"></a><span class="w">                </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">jend</span><span class="o">=</span><span class="n">vbInliers</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;</span><span class="n">jend</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-58-85" name="__codelineno-58-85" href="#__codelineno-58-85"></a><span class="w">                </span><span class="p">{</span>
<a id="__codelineno-58-86" name="__codelineno-58-86" href="#__codelineno-58-86"></a><span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="n">vbInliers</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
<a id="__codelineno-58-87" name="__codelineno-58-87" href="#__codelineno-58-87"></a><span class="w">                       </span><span class="n">vpMapPointMatches</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">vvpMapPointMatches</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
<a id="__codelineno-58-88" name="__codelineno-58-88" href="#__codelineno-58-88"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-58-89" name="__codelineno-58-89" href="#__codelineno-58-89"></a>
<a id="__codelineno-58-90" name="__codelineno-58-90" href="#__codelineno-58-90"></a><span class="w">                </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pSolver</span><span class="o">-&gt;</span><span class="n">GetEstimatedRotation</span><span class="p">();</span>
<a id="__codelineno-58-91" name="__codelineno-58-91" href="#__codelineno-58-91"></a><span class="w">                </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pSolver</span><span class="o">-&gt;</span><span class="n">GetEstimatedTranslation</span><span class="p">();</span>
<a id="__codelineno-58-92" name="__codelineno-58-92" href="#__codelineno-58-92"></a><span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pSolver</span><span class="o">-&gt;</span><span class="n">GetEstimatedScale</span><span class="p">();</span>
<a id="__codelineno-58-93" name="__codelineno-58-93" href="#__codelineno-58-93"></a><span class="w">                </span><span class="n">matcher</span><span class="p">.</span><span class="n">SearchBySim3</span><span class="p">(</span><span class="n">mpCurrentKF</span><span class="p">,</span><span class="n">pKF</span><span class="p">,</span><span class="n">vpMapPointMatches</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="mf">7.5</span><span class="p">);</span>
<a id="__codelineno-58-94" name="__codelineno-58-94" href="#__codelineno-58-94"></a>
<a id="__codelineno-58-95" name="__codelineno-58-95" href="#__codelineno-58-95"></a><span class="w">                </span><span class="n">g2o</span><span class="o">::</span><span class="n">Sim3</span><span class="w"> </span><span class="n">gScm</span><span class="p">(</span><span class="n">Converter</span><span class="o">::</span><span class="n">toMatrix3d</span><span class="p">(</span><span class="n">R</span><span class="p">),</span><span class="n">Converter</span><span class="o">::</span><span class="n">toVector3d</span><span class="p">(</span><span class="n">t</span><span class="p">),</span><span class="n">s</span><span class="p">);</span>
<a id="__codelineno-58-96" name="__codelineno-58-96" href="#__codelineno-58-96"></a><span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nInliers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Optimizer</span><span class="o">::</span><span class="n">OptimizeSim3</span><span class="p">(</span><span class="n">mpCurrentKF</span><span class="p">,</span><span class="w"> </span><span class="n">pKF</span><span class="p">,</span><span class="w"> </span><span class="n">vpMapPointMatches</span><span class="p">,</span><span class="w"> </span><span class="n">gScm</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">mbFixScale</span><span class="p">);</span>
<a id="__codelineno-58-97" name="__codelineno-58-97" href="#__codelineno-58-97"></a>
<a id="__codelineno-58-98" name="__codelineno-58-98" href="#__codelineno-58-98"></a><span class="w">                </span><span class="c1">// If optimization is succesful stop ransacs and continue</span>
<a id="__codelineno-58-99" name="__codelineno-58-99" href="#__codelineno-58-99"></a><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">nInliers</span><span class="o">&gt;=</span><span class="mi">20</span><span class="p">)</span>
<a id="__codelineno-58-100" name="__codelineno-58-100" href="#__codelineno-58-100"></a><span class="w">                </span><span class="p">{</span>
<a id="__codelineno-58-101" name="__codelineno-58-101" href="#__codelineno-58-101"></a><span class="w">                    </span><span class="n">bMatch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<a id="__codelineno-58-102" name="__codelineno-58-102" href="#__codelineno-58-102"></a><span class="w">                    </span><span class="n">mpMatchedKF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF</span><span class="p">;</span>
<a id="__codelineno-58-103" name="__codelineno-58-103" href="#__codelineno-58-103"></a><span class="w">                    </span><span class="n">g2o</span><span class="o">::</span><span class="n">Sim3</span><span class="w"> </span><span class="n">gSmw</span><span class="p">(</span><span class="n">Converter</span><span class="o">::</span><span class="n">toMatrix3d</span><span class="p">(</span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">GetRotation</span><span class="p">()),</span><span class="n">Converter</span><span class="o">::</span><span class="n">toVector3d</span><span class="p">(</span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">GetTranslation</span><span class="p">()),</span><span class="mf">1.0</span><span class="p">);</span>
<a id="__codelineno-58-104" name="__codelineno-58-104" href="#__codelineno-58-104"></a><span class="w">                    </span><span class="n">mg2oScw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gScm</span><span class="o">*</span><span class="n">gSmw</span><span class="p">;</span>
<a id="__codelineno-58-105" name="__codelineno-58-105" href="#__codelineno-58-105"></a><span class="w">                    </span><span class="n">mScw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Converter</span><span class="o">::</span><span class="n">toCvMat</span><span class="p">(</span><span class="n">mg2oScw</span><span class="p">);</span>
<a id="__codelineno-58-106" name="__codelineno-58-106" href="#__codelineno-58-106"></a>
<a id="__codelineno-58-107" name="__codelineno-58-107" href="#__codelineno-58-107"></a><span class="w">                    </span><span class="n">mvpCurrentMatchedPoints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vpMapPointMatches</span><span class="p">;</span>
<a id="__codelineno-58-108" name="__codelineno-58-108" href="#__codelineno-58-108"></a><span class="w">                    </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-58-109" name="__codelineno-58-109" href="#__codelineno-58-109"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-58-110" name="__codelineno-58-110" href="#__codelineno-58-110"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-58-111" name="__codelineno-58-111" href="#__codelineno-58-111"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-58-112" name="__codelineno-58-112" href="#__codelineno-58-112"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-58-113" name="__codelineno-58-113" href="#__codelineno-58-113"></a>
<a id="__codelineno-58-114" name="__codelineno-58-114" href="#__codelineno-58-114"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">bMatch</span><span class="p">)</span>
<a id="__codelineno-58-115" name="__codelineno-58-115" href="#__codelineno-58-115"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-58-116" name="__codelineno-58-116" href="#__codelineno-58-116"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">nInitialCandidates</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-58-117" name="__codelineno-58-117" href="#__codelineno-58-117"></a><span class="w">             </span><span class="n">mvpEnoughConsistentCandidates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">SetErase</span><span class="p">();</span>
<a id="__codelineno-58-118" name="__codelineno-58-118" href="#__codelineno-58-118"></a><span class="w">        </span><span class="n">mpCurrentKF</span><span class="o">-&gt;</span><span class="n">SetErase</span><span class="p">();</span>
<a id="__codelineno-58-119" name="__codelineno-58-119" href="#__codelineno-58-119"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-58-120" name="__codelineno-58-120" href="#__codelineno-58-120"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-58-121" name="__codelineno-58-121" href="#__codelineno-58-121"></a>
<a id="__codelineno-58-122" name="__codelineno-58-122" href="#__codelineno-58-122"></a><span class="w">    </span><span class="c1">// Retrieve MapPoints seen in Loop Keyframe and neighbors</span>
<a id="__codelineno-58-123" name="__codelineno-58-123" href="#__codelineno-58-123"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">vpLoopConnectedKFs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mpMatchedKF</span><span class="o">-&gt;</span><span class="n">GetVectorCovisibleKeyFrames</span><span class="p">();</span>
<a id="__codelineno-58-124" name="__codelineno-58-124" href="#__codelineno-58-124"></a><span class="w">    </span><span class="n">vpLoopConnectedKFs</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">mpMatchedKF</span><span class="p">);</span>
<a id="__codelineno-58-125" name="__codelineno-58-125" href="#__codelineno-58-125"></a><span class="w">    </span><span class="n">mvpLoopMapPoints</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<a id="__codelineno-58-126" name="__codelineno-58-126" href="#__codelineno-58-126"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">vit</span><span class="o">=</span><span class="n">vpLoopConnectedKFs</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"> </span><span class="n">vit</span><span class="o">!=</span><span class="n">vpLoopConnectedKFs</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">vit</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-58-127" name="__codelineno-58-127" href="#__codelineno-58-127"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-58-128" name="__codelineno-58-128" href="#__codelineno-58-128"></a><span class="w">        </span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pKF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">vit</span><span class="p">;</span>
<a id="__codelineno-58-129" name="__codelineno-58-129" href="#__codelineno-58-129"></a><span class="w">        </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">vpMapPoints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">GetMapPointMatches</span><span class="p">();</span>
<a id="__codelineno-58-130" name="__codelineno-58-130" href="#__codelineno-58-130"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">iend</span><span class="o">=</span><span class="n">vpMapPoints</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">iend</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-58-131" name="__codelineno-58-131" href="#__codelineno-58-131"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-58-132" name="__codelineno-58-132" href="#__codelineno-58-132"></a><span class="w">            </span><span class="n">MapPoint</span><span class="o">*</span><span class="w"> </span><span class="n">pMP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vpMapPoints</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-58-133" name="__codelineno-58-133" href="#__codelineno-58-133"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">pMP</span><span class="p">)</span>
<a id="__codelineno-58-134" name="__codelineno-58-134" href="#__codelineno-58-134"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-58-135" name="__codelineno-58-135" href="#__codelineno-58-135"></a><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">isBad</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">mnLoopPointForKF</span><span class="o">!=</span><span class="n">mpCurrentKF</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="p">)</span>
<a id="__codelineno-58-136" name="__codelineno-58-136" href="#__codelineno-58-136"></a><span class="w">                </span><span class="p">{</span>
<a id="__codelineno-58-137" name="__codelineno-58-137" href="#__codelineno-58-137"></a><span class="w">                    </span><span class="n">mvpLoopMapPoints</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pMP</span><span class="p">);</span>
<a id="__codelineno-58-138" name="__codelineno-58-138" href="#__codelineno-58-138"></a><span class="w">                    </span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">mnLoopPointForKF</span><span class="o">=</span><span class="n">mpCurrentKF</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="p">;</span>
<a id="__codelineno-58-139" name="__codelineno-58-139" href="#__codelineno-58-139"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-58-140" name="__codelineno-58-140" href="#__codelineno-58-140"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-58-141" name="__codelineno-58-141" href="#__codelineno-58-141"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-58-142" name="__codelineno-58-142" href="#__codelineno-58-142"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-58-143" name="__codelineno-58-143" href="#__codelineno-58-143"></a>
<a id="__codelineno-58-144" name="__codelineno-58-144" href="#__codelineno-58-144"></a><span class="w">    </span><span class="c1">// Find more matches projecting with the computed Sim3</span>
<a id="__codelineno-58-145" name="__codelineno-58-145" href="#__codelineno-58-145"></a><span class="w">    </span><span class="n">matcher</span><span class="p">.</span><span class="n">SearchByProjection</span><span class="p">(</span><span class="n">mpCurrentKF</span><span class="p">,</span><span class="w"> </span><span class="n">mScw</span><span class="p">,</span><span class="w"> </span><span class="n">mvpLoopMapPoints</span><span class="p">,</span><span class="w"> </span><span class="n">mvpCurrentMatchedPoints</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>
<a id="__codelineno-58-146" name="__codelineno-58-146" href="#__codelineno-58-146"></a>
<a id="__codelineno-58-147" name="__codelineno-58-147" href="#__codelineno-58-147"></a><span class="w">    </span><span class="c1">// If enough matches accept Loop</span>
<a id="__codelineno-58-148" name="__codelineno-58-148" href="#__codelineno-58-148"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nTotalMatches</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-58-149" name="__codelineno-58-149" href="#__codelineno-58-149"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">mvpCurrentMatchedPoints</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-58-150" name="__codelineno-58-150" href="#__codelineno-58-150"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-58-151" name="__codelineno-58-151" href="#__codelineno-58-151"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">mvpCurrentMatchedPoints</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<a id="__codelineno-58-152" name="__codelineno-58-152" href="#__codelineno-58-152"></a><span class="w">            </span><span class="n">nTotalMatches</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-58-153" name="__codelineno-58-153" href="#__codelineno-58-153"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-58-154" name="__codelineno-58-154" href="#__codelineno-58-154"></a>
<a id="__codelineno-58-155" name="__codelineno-58-155" href="#__codelineno-58-155"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">nTotalMatches</span><span class="o">&gt;=</span><span class="mi">40</span><span class="p">)</span>
<a id="__codelineno-58-156" name="__codelineno-58-156" href="#__codelineno-58-156"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-58-157" name="__codelineno-58-157" href="#__codelineno-58-157"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">nInitialCandidates</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-58-158" name="__codelineno-58-158" href="#__codelineno-58-158"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">mvpEnoughConsistentCandidates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="n">mpMatchedKF</span><span class="p">)</span>
<a id="__codelineno-58-159" name="__codelineno-58-159" href="#__codelineno-58-159"></a><span class="w">                </span><span class="n">mvpEnoughConsistentCandidates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">SetErase</span><span class="p">();</span>
<a id="__codelineno-58-160" name="__codelineno-58-160" href="#__codelineno-58-160"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<a id="__codelineno-58-161" name="__codelineno-58-161" href="#__codelineno-58-161"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-58-162" name="__codelineno-58-162" href="#__codelineno-58-162"></a><span class="w">    </span><span class="k">else</span>
<a id="__codelineno-58-163" name="__codelineno-58-163" href="#__codelineno-58-163"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-58-164" name="__codelineno-58-164" href="#__codelineno-58-164"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">nInitialCandidates</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-58-165" name="__codelineno-58-165" href="#__codelineno-58-165"></a><span class="w">            </span><span class="n">mvpEnoughConsistentCandidates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">SetErase</span><span class="p">();</span>
<a id="__codelineno-58-166" name="__codelineno-58-166" href="#__codelineno-58-166"></a><span class="w">        </span><span class="n">mpCurrentKF</span><span class="o">-&gt;</span><span class="n">SetErase</span><span class="p">();</span>
<a id="__codelineno-58-167" name="__codelineno-58-167" href="#__codelineno-58-167"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-58-168" name="__codelineno-58-168" href="#__codelineno-58-168"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-58-169" name="__codelineno-58-169" href="#__codelineno-58-169"></a>
<a id="__codelineno-58-170" name="__codelineno-58-170" href="#__codelineno-58-170"></a><span class="p">}</span>
</code></pre></div>
<h3 id="correctloop"><code>CorrectLoop()</code></h3>
<p>Having detected a loop, perform loop closure.</p>
<p>First gather some keyframes that are co-visible to the current keyframe as a vector <code>mvpCurrentConnectedKFs</code>. 
These keyframes are first corrected by <code>mg2oScw = gScm*gSmw;</code> from the previous <code>ComputeSim3()</code>.
For all connected keyframes to this current keyframe, create the transform to this current keyframe <code>cv::Mat Tic = Tiw*Twc;</code>, 
that is <span class="arithmatex">\(T_{ic}=T^{-1}_{wi}T_{wc}\)</span>, where <span class="arithmatex">\(\space_{wc}\)</span> refers to transform from the camera frame to world frame (a.k.a. camera pose) for this current keyframe, and <span class="arithmatex">\(\space_{wi}\)</span> refers to one connected keyframe, and there exists <span class="arithmatex">\(T^{-1}_{wi}=T_{iw}\)</span>.
The connected keyframes are computed by <code>g2o::Sim3 g2oCorrectedSiw = g2oSic*mg2oScw;</code> and store them <code>CorrectedSim3[pKFi]=g2oCorrectedSiw;</code>.</p>
<p>The other keyframes are directly put into <code>NonCorrectedSim3[pKFi]=g2oSiw;</code> from their original keyframes' poses.</p>
<p>The <code>g2oCorrectedSiw</code> are regarded as initial estimates for those loop closure keyframes, leaving all remaining keyframes not yet transformed/corrected.
All <code>mvpCurrentConnectedKFs</code> and the remaining ones will be optimized together in <code>Optimizer::OptimizeEssentialGraph(...)</code>.</p>
<p><code>g2o::Sim3::map(const Vector3d &amp; xyz) const { return _r*xyz + _t; }</code> is defined to compute mapping the point <code>xyz</code> by the transform <span class="arithmatex">\([R|\mathbf{t}]\)</span>.
Hence, a corrected map point is computed by <code>eigCorrectedP3Dw = g2oCorrectedSwi.map(g2oSiw.map(eigP3Dw));</code>, 
that an existing map point is first transformed by old/not-yet-corrected keyframe camera pose's inverse <code>g2oSiw</code>, then by the after-corrected keyframe camera pose <code>g2oCorrectedSwi</code>.</p>
<p>Scale <span class="arithmatex">\(s\)</span> is taken into consideration for translation: retrieve the scale by <code>double s = g2oCorrectedSiw.scale();</code>,
then <code>eigt *=(1./s);</code> for <span class="arithmatex">\(\frac{1}{s}\mathbf{t}\)</span>.</p>
<p><code>SearchAndFuse(CorrectedSim3);</code> basically fuse duplicate map points.</p>
<p>Finally, having the corrected current keyframe's camera pose and map points, perform global bundle adjustment.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">LoopClosing::CorrectLoop</span><span class="p">()</span>
<a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a><span class="p">{</span>
<a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a><span class="w">    </span><span class="p">...</span><span class="w"> </span><span class="c1">// some init checking and thread sync work</span>
<a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a>
<a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a><span class="w">    </span><span class="c1">// Ensure current keyframe is updated</span>
<a id="__codelineno-59-6" name="__codelineno-59-6" href="#__codelineno-59-6"></a><span class="w">    </span><span class="n">mpCurrentKF</span><span class="o">-&gt;</span><span class="n">UpdateConnections</span><span class="p">();</span>
<a id="__codelineno-59-7" name="__codelineno-59-7" href="#__codelineno-59-7"></a>
<a id="__codelineno-59-8" name="__codelineno-59-8" href="#__codelineno-59-8"></a><span class="w">    </span><span class="c1">// Retrive keyframes connected to the current keyframe and compute corrected Sim3 pose by propagation</span>
<a id="__codelineno-59-9" name="__codelineno-59-9" href="#__codelineno-59-9"></a><span class="w">    </span><span class="n">mvpCurrentConnectedKFs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mpCurrentKF</span><span class="o">-&gt;</span><span class="n">GetVectorCovisibleKeyFrames</span><span class="p">();</span>
<a id="__codelineno-59-10" name="__codelineno-59-10" href="#__codelineno-59-10"></a><span class="w">    </span><span class="n">mvpCurrentConnectedKFs</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">mpCurrentKF</span><span class="p">);</span>
<a id="__codelineno-59-11" name="__codelineno-59-11" href="#__codelineno-59-11"></a>
<a id="__codelineno-59-12" name="__codelineno-59-12" href="#__codelineno-59-12"></a><span class="w">    </span><span class="n">KeyFrameAndPose</span><span class="w"> </span><span class="n">CorrectedSim3</span><span class="p">,</span><span class="w"> </span><span class="n">NonCorrectedSim3</span><span class="p">;</span>
<a id="__codelineno-59-13" name="__codelineno-59-13" href="#__codelineno-59-13"></a><span class="w">    </span><span class="n">CorrectedSim3</span><span class="p">[</span><span class="n">mpCurrentKF</span><span class="p">]</span><span class="o">=</span><span class="n">mg2oScw</span><span class="p">;</span>
<a id="__codelineno-59-14" name="__codelineno-59-14" href="#__codelineno-59-14"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">Twc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mpCurrentKF</span><span class="o">-&gt;</span><span class="n">GetPoseInverse</span><span class="p">();</span>
<a id="__codelineno-59-15" name="__codelineno-59-15" href="#__codelineno-59-15"></a>
<a id="__codelineno-59-16" name="__codelineno-59-16" href="#__codelineno-59-16"></a>
<a id="__codelineno-59-17" name="__codelineno-59-17" href="#__codelineno-59-17"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-59-18" name="__codelineno-59-18" href="#__codelineno-59-18"></a><span class="w">        </span><span class="c1">// Get Map Mutex</span>
<a id="__codelineno-59-19" name="__codelineno-59-19" href="#__codelineno-59-19"></a><span class="w">        </span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">mpMap</span><span class="o">-&gt;</span><span class="n">mMutexMapUpdate</span><span class="p">);</span>
<a id="__codelineno-59-20" name="__codelineno-59-20" href="#__codelineno-59-20"></a>
<a id="__codelineno-59-21" name="__codelineno-59-21" href="#__codelineno-59-21"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">vit</span><span class="o">=</span><span class="n">mvpCurrentConnectedKFs</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">vend</span><span class="o">=</span><span class="n">mvpCurrentConnectedKFs</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">vit</span><span class="o">!=</span><span class="n">vend</span><span class="p">;</span><span class="w"> </span><span class="n">vit</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-59-22" name="__codelineno-59-22" href="#__codelineno-59-22"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-59-23" name="__codelineno-59-23" href="#__codelineno-59-23"></a><span class="w">            </span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pKFi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">vit</span><span class="p">;</span>
<a id="__codelineno-59-24" name="__codelineno-59-24" href="#__codelineno-59-24"></a>
<a id="__codelineno-59-25" name="__codelineno-59-25" href="#__codelineno-59-25"></a><span class="w">            </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">Tiw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKFi</span><span class="o">-&gt;</span><span class="n">GetPose</span><span class="p">();</span>
<a id="__codelineno-59-26" name="__codelineno-59-26" href="#__codelineno-59-26"></a>
<a id="__codelineno-59-27" name="__codelineno-59-27" href="#__codelineno-59-27"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">pKFi</span><span class="o">!=</span><span class="n">mpCurrentKF</span><span class="p">)</span>
<a id="__codelineno-59-28" name="__codelineno-59-28" href="#__codelineno-59-28"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-59-29" name="__codelineno-59-29" href="#__codelineno-59-29"></a><span class="w">                </span><span class="c1">// `Tic` is the transform from `pKFi` to the current keyframe `mpCurrentKF`</span>
<a id="__codelineno-59-30" name="__codelineno-59-30" href="#__codelineno-59-30"></a><span class="w">                </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">Tic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Tiw</span><span class="o">*</span><span class="n">Twc</span><span class="p">;</span>
<a id="__codelineno-59-31" name="__codelineno-59-31" href="#__codelineno-59-31"></a><span class="w">                </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">Ric</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Tic</span><span class="p">.</span><span class="n">rowRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">).</span><span class="n">colRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
<a id="__codelineno-59-32" name="__codelineno-59-32" href="#__codelineno-59-32"></a><span class="w">                </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">tic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Tic</span><span class="p">.</span><span class="n">rowRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">).</span><span class="n">col</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<a id="__codelineno-59-33" name="__codelineno-59-33" href="#__codelineno-59-33"></a><span class="w">                </span><span class="n">g2o</span><span class="o">::</span><span class="n">Sim3</span><span class="w"> </span><span class="n">g2oSic</span><span class="p">(</span><span class="n">Converter</span><span class="o">::</span><span class="n">toMatrix3d</span><span class="p">(</span><span class="n">Ric</span><span class="p">),</span><span class="n">Converter</span><span class="o">::</span><span class="n">toVector3d</span><span class="p">(</span><span class="n">tic</span><span class="p">),</span><span class="mf">1.0</span><span class="p">);</span>
<a id="__codelineno-59-34" name="__codelineno-59-34" href="#__codelineno-59-34"></a><span class="w">                </span><span class="n">g2o</span><span class="o">::</span><span class="n">Sim3</span><span class="w"> </span><span class="n">g2oCorrectedSiw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g2oSic</span><span class="o">*</span><span class="n">mg2oScw</span><span class="p">;</span>
<a id="__codelineno-59-35" name="__codelineno-59-35" href="#__codelineno-59-35"></a><span class="w">                </span><span class="c1">//Pose corrected with the Sim3 of the loop closure</span>
<a id="__codelineno-59-36" name="__codelineno-59-36" href="#__codelineno-59-36"></a><span class="w">                </span><span class="n">CorrectedSim3</span><span class="p">[</span><span class="n">pKFi</span><span class="p">]</span><span class="o">=</span><span class="n">g2oCorrectedSiw</span><span class="p">;</span>
<a id="__codelineno-59-37" name="__codelineno-59-37" href="#__codelineno-59-37"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-59-38" name="__codelineno-59-38" href="#__codelineno-59-38"></a>
<a id="__codelineno-59-39" name="__codelineno-59-39" href="#__codelineno-59-39"></a><span class="w">            </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">Riw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Tiw</span><span class="p">.</span><span class="n">rowRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">).</span><span class="n">colRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
<a id="__codelineno-59-40" name="__codelineno-59-40" href="#__codelineno-59-40"></a><span class="w">            </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">tiw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Tiw</span><span class="p">.</span><span class="n">rowRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">).</span><span class="n">col</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<a id="__codelineno-59-41" name="__codelineno-59-41" href="#__codelineno-59-41"></a><span class="w">            </span><span class="n">g2o</span><span class="o">::</span><span class="n">Sim3</span><span class="w"> </span><span class="n">g2oSiw</span><span class="p">(</span><span class="n">Converter</span><span class="o">::</span><span class="n">toMatrix3d</span><span class="p">(</span><span class="n">Riw</span><span class="p">),</span><span class="n">Converter</span><span class="o">::</span><span class="n">toVector3d</span><span class="p">(</span><span class="n">tiw</span><span class="p">),</span><span class="mf">1.0</span><span class="p">);</span>
<a id="__codelineno-59-42" name="__codelineno-59-42" href="#__codelineno-59-42"></a><span class="w">            </span><span class="c1">//Pose without correction</span>
<a id="__codelineno-59-43" name="__codelineno-59-43" href="#__codelineno-59-43"></a><span class="w">            </span><span class="n">NonCorrectedSim3</span><span class="p">[</span><span class="n">pKFi</span><span class="p">]</span><span class="o">=</span><span class="n">g2oSiw</span><span class="p">;</span>
<a id="__codelineno-59-44" name="__codelineno-59-44" href="#__codelineno-59-44"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-59-45" name="__codelineno-59-45" href="#__codelineno-59-45"></a>
<a id="__codelineno-59-46" name="__codelineno-59-46" href="#__codelineno-59-46"></a><span class="w">        </span><span class="c1">// Correct all MapPoints obsrved by current keyframe and neighbors, so that they align with the other side of the loop</span>
<a id="__codelineno-59-47" name="__codelineno-59-47" href="#__codelineno-59-47"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">KeyFrameAndPose</span><span class="o">::</span><span class="n">iterator</span><span class="w"> </span><span class="n">mit</span><span class="o">=</span><span class="n">CorrectedSim3</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">mend</span><span class="o">=</span><span class="n">CorrectedSim3</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">mit</span><span class="o">!=</span><span class="n">mend</span><span class="p">;</span><span class="w"> </span><span class="n">mit</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-59-48" name="__codelineno-59-48" href="#__codelineno-59-48"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-59-49" name="__codelineno-59-49" href="#__codelineno-59-49"></a><span class="w">            </span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pKFi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mit</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">;</span>
<a id="__codelineno-59-50" name="__codelineno-59-50" href="#__codelineno-59-50"></a><span class="w">            </span><span class="n">g2o</span><span class="o">::</span><span class="n">Sim3</span><span class="w"> </span><span class="n">g2oCorrectedSiw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mit</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
<a id="__codelineno-59-51" name="__codelineno-59-51" href="#__codelineno-59-51"></a><span class="w">            </span><span class="n">g2o</span><span class="o">::</span><span class="n">Sim3</span><span class="w"> </span><span class="n">g2oCorrectedSwi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g2oCorrectedSiw</span><span class="p">.</span><span class="n">inverse</span><span class="p">();</span>
<a id="__codelineno-59-52" name="__codelineno-59-52" href="#__codelineno-59-52"></a>
<a id="__codelineno-59-53" name="__codelineno-59-53" href="#__codelineno-59-53"></a><span class="w">            </span><span class="n">g2o</span><span class="o">::</span><span class="n">Sim3</span><span class="w"> </span><span class="n">g2oSiw</span><span class="w"> </span><span class="o">=</span><span class="n">NonCorrectedSim3</span><span class="p">[</span><span class="n">pKFi</span><span class="p">];</span>
<a id="__codelineno-59-54" name="__codelineno-59-54" href="#__codelineno-59-54"></a>
<a id="__codelineno-59-55" name="__codelineno-59-55" href="#__codelineno-59-55"></a><span class="w">            </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">vpMPsi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKFi</span><span class="o">-&gt;</span><span class="n">GetMapPointMatches</span><span class="p">();</span>
<a id="__codelineno-59-56" name="__codelineno-59-56" href="#__codelineno-59-56"></a><span class="w">            </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">iMP</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">endMPi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vpMPsi</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">iMP</span><span class="o">&lt;</span><span class="n">endMPi</span><span class="p">;</span><span class="w"> </span><span class="n">iMP</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-59-57" name="__codelineno-59-57" href="#__codelineno-59-57"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-59-58" name="__codelineno-59-58" href="#__codelineno-59-58"></a><span class="w">                </span><span class="n">MapPoint</span><span class="o">*</span><span class="w"> </span><span class="n">pMPi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vpMPsi</span><span class="p">[</span><span class="n">iMP</span><span class="p">];</span>
<a id="__codelineno-59-59" name="__codelineno-59-59" href="#__codelineno-59-59"></a><span class="w">                </span><span class="p">...</span><span class="w"> </span><span class="c1">// bad point checking</span>
<a id="__codelineno-59-60" name="__codelineno-59-60" href="#__codelineno-59-60"></a>
<a id="__codelineno-59-61" name="__codelineno-59-61" href="#__codelineno-59-61"></a><span class="w">                </span><span class="c1">// Project with non-corrected pose and project back with corrected pose</span>
<a id="__codelineno-59-62" name="__codelineno-59-62" href="#__codelineno-59-62"></a><span class="w">                </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">P3Dw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pMPi</span><span class="o">-&gt;</span><span class="n">GetWorldPos</span><span class="p">();</span>
<a id="__codelineno-59-63" name="__codelineno-59-63" href="#__codelineno-59-63"></a><span class="w">                </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">eigP3Dw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Converter</span><span class="o">::</span><span class="n">toVector3d</span><span class="p">(</span><span class="n">P3Dw</span><span class="p">);</span>
<a id="__codelineno-59-64" name="__codelineno-59-64" href="#__codelineno-59-64"></a><span class="w">                </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">eigCorrectedP3Dw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g2oCorrectedSwi</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">g2oSiw</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">eigP3Dw</span><span class="p">));</span>
<a id="__codelineno-59-65" name="__codelineno-59-65" href="#__codelineno-59-65"></a>
<a id="__codelineno-59-66" name="__codelineno-59-66" href="#__codelineno-59-66"></a><span class="w">                </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">cvCorrectedP3Dw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Converter</span><span class="o">::</span><span class="n">toCvMat</span><span class="p">(</span><span class="n">eigCorrectedP3Dw</span><span class="p">);</span>
<a id="__codelineno-59-67" name="__codelineno-59-67" href="#__codelineno-59-67"></a><span class="w">                </span><span class="n">pMPi</span><span class="o">-&gt;</span><span class="n">SetWorldPos</span><span class="p">(</span><span class="n">cvCorrectedP3Dw</span><span class="p">);</span>
<a id="__codelineno-59-68" name="__codelineno-59-68" href="#__codelineno-59-68"></a><span class="w">                </span><span class="n">pMPi</span><span class="o">-&gt;</span><span class="n">mnCorrectedByKF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mpCurrentKF</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="p">;</span>
<a id="__codelineno-59-69" name="__codelineno-59-69" href="#__codelineno-59-69"></a><span class="w">                </span><span class="n">pMPi</span><span class="o">-&gt;</span><span class="n">mnCorrectedReference</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKFi</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="p">;</span>
<a id="__codelineno-59-70" name="__codelineno-59-70" href="#__codelineno-59-70"></a><span class="w">                </span><span class="n">pMPi</span><span class="o">-&gt;</span><span class="n">UpdateNormalAndDepth</span><span class="p">();</span>
<a id="__codelineno-59-71" name="__codelineno-59-71" href="#__codelineno-59-71"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-59-72" name="__codelineno-59-72" href="#__codelineno-59-72"></a>
<a id="__codelineno-59-73" name="__codelineno-59-73" href="#__codelineno-59-73"></a><span class="w">            </span><span class="c1">// Update keyframe pose with corrected Sim3. First transform Sim3 to SE3 (scale translation)</span>
<a id="__codelineno-59-74" name="__codelineno-59-74" href="#__codelineno-59-74"></a><span class="w">            </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix3d</span><span class="w"> </span><span class="n">eigR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g2oCorrectedSiw</span><span class="p">.</span><span class="n">rotation</span><span class="p">().</span><span class="n">toRotationMatrix</span><span class="p">();</span>
<a id="__codelineno-59-75" name="__codelineno-59-75" href="#__codelineno-59-75"></a><span class="w">            </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="w"> </span><span class="n">eigt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g2oCorrectedSiw</span><span class="p">.</span><span class="n">translation</span><span class="p">();</span>
<a id="__codelineno-59-76" name="__codelineno-59-76" href="#__codelineno-59-76"></a><span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g2oCorrectedSiw</span><span class="p">.</span><span class="n">scale</span><span class="p">();</span>
<a id="__codelineno-59-77" name="__codelineno-59-77" href="#__codelineno-59-77"></a>
<a id="__codelineno-59-78" name="__codelineno-59-78" href="#__codelineno-59-78"></a><span class="w">            </span><span class="n">eigt</span><span class="w"> </span><span class="o">*=</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">s</span><span class="p">);</span><span class="w"> </span><span class="c1">//[R t/s;0 1]</span>
<a id="__codelineno-59-79" name="__codelineno-59-79" href="#__codelineno-59-79"></a>
<a id="__codelineno-59-80" name="__codelineno-59-80" href="#__codelineno-59-80"></a><span class="w">            </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">correctedTiw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Converter</span><span class="o">::</span><span class="n">toCvSE3</span><span class="p">(</span><span class="n">eigR</span><span class="p">,</span><span class="n">eigt</span><span class="p">);</span>
<a id="__codelineno-59-81" name="__codelineno-59-81" href="#__codelineno-59-81"></a>
<a id="__codelineno-59-82" name="__codelineno-59-82" href="#__codelineno-59-82"></a><span class="w">            </span><span class="n">pKFi</span><span class="o">-&gt;</span><span class="n">SetPose</span><span class="p">(</span><span class="n">correctedTiw</span><span class="p">);</span>
<a id="__codelineno-59-83" name="__codelineno-59-83" href="#__codelineno-59-83"></a>
<a id="__codelineno-59-84" name="__codelineno-59-84" href="#__codelineno-59-84"></a><span class="w">            </span><span class="c1">// Make sure connections are updated</span>
<a id="__codelineno-59-85" name="__codelineno-59-85" href="#__codelineno-59-85"></a><span class="w">            </span><span class="n">pKFi</span><span class="o">-&gt;</span><span class="n">UpdateConnections</span><span class="p">();</span>
<a id="__codelineno-59-86" name="__codelineno-59-86" href="#__codelineno-59-86"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-59-87" name="__codelineno-59-87" href="#__codelineno-59-87"></a>
<a id="__codelineno-59-88" name="__codelineno-59-88" href="#__codelineno-59-88"></a><span class="w">        </span><span class="c1">// Start Loop Fusion</span>
<a id="__codelineno-59-89" name="__codelineno-59-89" href="#__codelineno-59-89"></a><span class="w">        </span><span class="c1">// Update matched map points and replace if duplicated</span>
<a id="__codelineno-59-90" name="__codelineno-59-90" href="#__codelineno-59-90"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">mvpCurrentMatchedPoints</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-59-91" name="__codelineno-59-91" href="#__codelineno-59-91"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-59-92" name="__codelineno-59-92" href="#__codelineno-59-92"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">mvpCurrentMatchedPoints</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<a id="__codelineno-59-93" name="__codelineno-59-93" href="#__codelineno-59-93"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-59-94" name="__codelineno-59-94" href="#__codelineno-59-94"></a><span class="w">                </span><span class="n">MapPoint</span><span class="o">*</span><span class="w"> </span><span class="n">pLoopMP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mvpCurrentMatchedPoints</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-59-95" name="__codelineno-59-95" href="#__codelineno-59-95"></a><span class="w">                </span><span class="n">MapPoint</span><span class="o">*</span><span class="w"> </span><span class="n">pCurMP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mpCurrentKF</span><span class="o">-&gt;</span><span class="n">GetMapPoint</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<a id="__codelineno-59-96" name="__codelineno-59-96" href="#__codelineno-59-96"></a><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">pCurMP</span><span class="p">)</span>
<a id="__codelineno-59-97" name="__codelineno-59-97" href="#__codelineno-59-97"></a><span class="w">                    </span><span class="n">pCurMP</span><span class="o">-&gt;</span><span class="n">Replace</span><span class="p">(</span><span class="n">pLoopMP</span><span class="p">);</span>
<a id="__codelineno-59-98" name="__codelineno-59-98" href="#__codelineno-59-98"></a><span class="w">                </span><span class="k">else</span>
<a id="__codelineno-59-99" name="__codelineno-59-99" href="#__codelineno-59-99"></a><span class="w">                </span><span class="p">{</span>
<a id="__codelineno-59-100" name="__codelineno-59-100" href="#__codelineno-59-100"></a><span class="w">                    </span><span class="n">mpCurrentKF</span><span class="o">-&gt;</span><span class="n">AddMapPoint</span><span class="p">(</span><span class="n">pLoopMP</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
<a id="__codelineno-59-101" name="__codelineno-59-101" href="#__codelineno-59-101"></a><span class="w">                    </span><span class="n">pLoopMP</span><span class="o">-&gt;</span><span class="n">AddObservation</span><span class="p">(</span><span class="n">mpCurrentKF</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
<a id="__codelineno-59-102" name="__codelineno-59-102" href="#__codelineno-59-102"></a><span class="w">                    </span><span class="n">pLoopMP</span><span class="o">-&gt;</span><span class="n">ComputeDistinctiveDescriptors</span><span class="p">();</span>
<a id="__codelineno-59-103" name="__codelineno-59-103" href="#__codelineno-59-103"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-59-104" name="__codelineno-59-104" href="#__codelineno-59-104"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-59-105" name="__codelineno-59-105" href="#__codelineno-59-105"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-59-106" name="__codelineno-59-106" href="#__codelineno-59-106"></a>
<a id="__codelineno-59-107" name="__codelineno-59-107" href="#__codelineno-59-107"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-59-108" name="__codelineno-59-108" href="#__codelineno-59-108"></a>
<a id="__codelineno-59-109" name="__codelineno-59-109" href="#__codelineno-59-109"></a><span class="w">    </span><span class="c1">// Project MapPoints observed in the neighborhood of the loop keyframe</span>
<a id="__codelineno-59-110" name="__codelineno-59-110" href="#__codelineno-59-110"></a><span class="w">    </span><span class="c1">// into the current keyframe and neighbors using corrected poses.</span>
<a id="__codelineno-59-111" name="__codelineno-59-111" href="#__codelineno-59-111"></a><span class="w">    </span><span class="c1">// Fuse duplications.</span>
<a id="__codelineno-59-112" name="__codelineno-59-112" href="#__codelineno-59-112"></a><span class="w">    </span><span class="n">SearchAndFuse</span><span class="p">(</span><span class="n">CorrectedSim3</span><span class="p">);</span>
<a id="__codelineno-59-113" name="__codelineno-59-113" href="#__codelineno-59-113"></a>
<a id="__codelineno-59-114" name="__codelineno-59-114" href="#__codelineno-59-114"></a>
<a id="__codelineno-59-115" name="__codelineno-59-115" href="#__codelineno-59-115"></a><span class="w">    </span><span class="c1">// After the MapPoint fusion, new links in the covisibility graph will appear attaching both sides of the loop</span>
<a id="__codelineno-59-116" name="__codelineno-59-116" href="#__codelineno-59-116"></a><span class="w">    </span><span class="n">map</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">set</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">LoopConnections</span><span class="p">;</span>
<a id="__codelineno-59-117" name="__codelineno-59-117" href="#__codelineno-59-117"></a>
<a id="__codelineno-59-118" name="__codelineno-59-118" href="#__codelineno-59-118"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">vit</span><span class="o">=</span><span class="n">mvpCurrentConnectedKFs</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">vend</span><span class="o">=</span><span class="n">mvpCurrentConnectedKFs</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">vit</span><span class="o">!=</span><span class="n">vend</span><span class="p">;</span><span class="w"> </span><span class="n">vit</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-59-119" name="__codelineno-59-119" href="#__codelineno-59-119"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-59-120" name="__codelineno-59-120" href="#__codelineno-59-120"></a><span class="w">        </span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pKFi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">vit</span><span class="p">;</span>
<a id="__codelineno-59-121" name="__codelineno-59-121" href="#__codelineno-59-121"></a><span class="w">        </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">vpPreviousNeighbors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKFi</span><span class="o">-&gt;</span><span class="n">GetVectorCovisibleKeyFrames</span><span class="p">();</span>
<a id="__codelineno-59-122" name="__codelineno-59-122" href="#__codelineno-59-122"></a>
<a id="__codelineno-59-123" name="__codelineno-59-123" href="#__codelineno-59-123"></a><span class="w">        </span><span class="c1">// Update connections. Detect new links.</span>
<a id="__codelineno-59-124" name="__codelineno-59-124" href="#__codelineno-59-124"></a><span class="w">        </span><span class="n">pKFi</span><span class="o">-&gt;</span><span class="n">UpdateConnections</span><span class="p">();</span>
<a id="__codelineno-59-125" name="__codelineno-59-125" href="#__codelineno-59-125"></a><span class="w">        </span><span class="n">LoopConnections</span><span class="p">[</span><span class="n">pKFi</span><span class="p">]</span><span class="o">=</span><span class="n">pKFi</span><span class="o">-&gt;</span><span class="n">GetConnectedKeyFrames</span><span class="p">();</span>
<a id="__codelineno-59-126" name="__codelineno-59-126" href="#__codelineno-59-126"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">vit_prev</span><span class="o">=</span><span class="n">vpPreviousNeighbors</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">vend_prev</span><span class="o">=</span><span class="n">vpPreviousNeighbors</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">vit_prev</span><span class="o">!=</span><span class="n">vend_prev</span><span class="p">;</span><span class="w"> </span><span class="n">vit_prev</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-59-127" name="__codelineno-59-127" href="#__codelineno-59-127"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-59-128" name="__codelineno-59-128" href="#__codelineno-59-128"></a><span class="w">            </span><span class="n">LoopConnections</span><span class="p">[</span><span class="n">pKFi</span><span class="p">].</span><span class="n">erase</span><span class="p">(</span><span class="o">*</span><span class="n">vit_prev</span><span class="p">);</span>
<a id="__codelineno-59-129" name="__codelineno-59-129" href="#__codelineno-59-129"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-59-130" name="__codelineno-59-130" href="#__codelineno-59-130"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">vit2</span><span class="o">=</span><span class="n">mvpCurrentConnectedKFs</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">vend2</span><span class="o">=</span><span class="n">mvpCurrentConnectedKFs</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">vit2</span><span class="o">!=</span><span class="n">vend2</span><span class="p">;</span><span class="w"> </span><span class="n">vit2</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-59-131" name="__codelineno-59-131" href="#__codelineno-59-131"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-59-132" name="__codelineno-59-132" href="#__codelineno-59-132"></a><span class="w">            </span><span class="n">LoopConnections</span><span class="p">[</span><span class="n">pKFi</span><span class="p">].</span><span class="n">erase</span><span class="p">(</span><span class="o">*</span><span class="n">vit2</span><span class="p">);</span>
<a id="__codelineno-59-133" name="__codelineno-59-133" href="#__codelineno-59-133"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-59-134" name="__codelineno-59-134" href="#__codelineno-59-134"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-59-135" name="__codelineno-59-135" href="#__codelineno-59-135"></a>
<a id="__codelineno-59-136" name="__codelineno-59-136" href="#__codelineno-59-136"></a><span class="w">    </span><span class="c1">// Optimize graph</span>
<a id="__codelineno-59-137" name="__codelineno-59-137" href="#__codelineno-59-137"></a><span class="w">    </span><span class="n">Optimizer</span><span class="o">::</span><span class="n">OptimizeEssentialGraph</span><span class="p">(</span><span class="n">mpMap</span><span class="p">,</span><span class="w"> </span><span class="n">mpMatchedKF</span><span class="p">,</span><span class="w"> </span><span class="n">mpCurrentKF</span><span class="p">,</span><span class="w"> </span><span class="n">NonCorrectedSim3</span><span class="p">,</span><span class="w"> </span><span class="n">CorrectedSim3</span><span class="p">,</span><span class="w"> </span><span class="n">LoopConnections</span><span class="p">,</span><span class="w"> </span><span class="n">mbFixScale</span><span class="p">);</span>
<a id="__codelineno-59-138" name="__codelineno-59-138" href="#__codelineno-59-138"></a>
<a id="__codelineno-59-139" name="__codelineno-59-139" href="#__codelineno-59-139"></a><span class="w">    </span><span class="n">mpMap</span><span class="o">-&gt;</span><span class="n">InformNewBigChange</span><span class="p">();</span>
<a id="__codelineno-59-140" name="__codelineno-59-140" href="#__codelineno-59-140"></a>
<a id="__codelineno-59-141" name="__codelineno-59-141" href="#__codelineno-59-141"></a><span class="w">    </span><span class="c1">// Add loop edge</span>
<a id="__codelineno-59-142" name="__codelineno-59-142" href="#__codelineno-59-142"></a><span class="w">    </span><span class="n">mpMatchedKF</span><span class="o">-&gt;</span><span class="n">AddLoopEdge</span><span class="p">(</span><span class="n">mpCurrentKF</span><span class="p">);</span>
<a id="__codelineno-59-143" name="__codelineno-59-143" href="#__codelineno-59-143"></a><span class="w">    </span><span class="n">mpCurrentKF</span><span class="o">-&gt;</span><span class="n">AddLoopEdge</span><span class="p">(</span><span class="n">mpMatchedKF</span><span class="p">);</span>
<a id="__codelineno-59-144" name="__codelineno-59-144" href="#__codelineno-59-144"></a>
<a id="__codelineno-59-145" name="__codelineno-59-145" href="#__codelineno-59-145"></a><span class="w">    </span><span class="c1">// Launch a new thread to perform Global Bundle Adjustment</span>
<a id="__codelineno-59-146" name="__codelineno-59-146" href="#__codelineno-59-146"></a><span class="w">    </span><span class="n">mbRunningGBA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<a id="__codelineno-59-147" name="__codelineno-59-147" href="#__codelineno-59-147"></a><span class="w">    </span><span class="n">mbFinishedGBA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-59-148" name="__codelineno-59-148" href="#__codelineno-59-148"></a><span class="w">    </span><span class="n">mbStopGBA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-59-149" name="__codelineno-59-149" href="#__codelineno-59-149"></a><span class="w">    </span><span class="n">mpThreadGBA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kr">thread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">LoopClosing</span><span class="o">::</span><span class="n">RunGlobalBundleAdjustment</span><span class="p">,</span><span class="k">this</span><span class="p">,</span><span class="n">mpCurrentKF</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="p">);</span>
<a id="__codelineno-59-150" name="__codelineno-59-150" href="#__codelineno-59-150"></a>
<a id="__codelineno-59-151" name="__codelineno-59-151" href="#__codelineno-59-151"></a><span class="w">    </span><span class="c1">// Loop closed. Release Local Mapping.</span>
<a id="__codelineno-59-152" name="__codelineno-59-152" href="#__codelineno-59-152"></a><span class="w">    </span><span class="n">mpLocalMapper</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span><span class="w">    </span>
<a id="__codelineno-59-153" name="__codelineno-59-153" href="#__codelineno-59-153"></a>
<a id="__codelineno-59-154" name="__codelineno-59-154" href="#__codelineno-59-154"></a><span class="w">    </span><span class="n">mLastLoopKFid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mpCurrentKF</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="p">;</span><span class="w">   </span>
<a id="__codelineno-59-155" name="__codelineno-59-155" href="#__codelineno-59-155"></a><span class="p">}</span>
</code></pre></div>
<p>To fuse duplicate map points that given the map points <code>cv::Mat p3Dw = pMP-&gt;GetWorldPos();</code>, 
transform it to the camera coordinate system by <code>cv::Mat p3Dc = Rcw*p3Dw+tcw;</code>, then project it to as image pixel.</p>
<p>There are some testsings before merging map points:
* depth estimate should be contained in between min and max depth estimates
* the projected image pixel must be in the central area of an image capture
* within the neighbor area of its corresponding map point</p>
<p>If merged, perform <code>vpReplacePoint[iMP] = pMPinKF;</code>, otherwise, create a new map point by <code>pMP-&gt;AddObservation(pKF,bestIdx);</code> and <code>pKF-&gt;AddMapPoint(pMP,bestIdx);</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">LoopClosing::SearchAndFuse</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">KeyFrameAndPose</span><span class="w"> </span><span class="o">&amp;</span><span class="n">CorrectedPosesMap</span><span class="p">)</span>
<a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a><span class="p">{</span>
<a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a><span class="w">    </span><span class="n">ORBmatcher</span><span class="w"> </span><span class="n">matcher</span><span class="p">(</span><span class="mf">0.8</span><span class="p">);</span>
<a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a>
<a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">KeyFrameAndPose</span><span class="o">::</span><span class="n">const_iterator</span><span class="w"> </span><span class="n">mit</span><span class="o">=</span><span class="n">CorrectedPosesMap</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">mend</span><span class="o">=</span><span class="n">CorrectedPosesMap</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">mit</span><span class="o">!=</span><span class="n">mend</span><span class="p">;</span><span class="n">mit</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-60-7" name="__codelineno-60-7" href="#__codelineno-60-7"></a><span class="w">        </span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pKF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mit</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">;</span>
<a id="__codelineno-60-8" name="__codelineno-60-8" href="#__codelineno-60-8"></a>
<a id="__codelineno-60-9" name="__codelineno-60-9" href="#__codelineno-60-9"></a><span class="w">        </span><span class="n">g2o</span><span class="o">::</span><span class="n">Sim3</span><span class="w"> </span><span class="n">g2oScw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mit</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
<a id="__codelineno-60-10" name="__codelineno-60-10" href="#__codelineno-60-10"></a>
<a id="__codelineno-60-11" name="__codelineno-60-11" href="#__codelineno-60-11"></a><span class="w">        </span><span class="c1">// *********************</span>
<a id="__codelineno-60-12" name="__codelineno-60-12" href="#__codelineno-60-12"></a><span class="w">        </span><span class="c1">//  cv::Mat Converter::toCvMat(const g2o::Sim3 &amp;Sim3)</span>
<a id="__codelineno-60-13" name="__codelineno-60-13" href="#__codelineno-60-13"></a><span class="w">        </span><span class="c1">//  {</span>
<a id="__codelineno-60-14" name="__codelineno-60-14" href="#__codelineno-60-14"></a><span class="w">        </span><span class="c1">//      Eigen::Matrix3d eigR = Sim3.rotation().toRotationMatrix();</span>
<a id="__codelineno-60-15" name="__codelineno-60-15" href="#__codelineno-60-15"></a><span class="w">        </span><span class="c1">//      Eigen::Vector3d eigt = Sim3.translation();</span>
<a id="__codelineno-60-16" name="__codelineno-60-16" href="#__codelineno-60-16"></a><span class="w">        </span><span class="c1">//      double s = Sim3.scale();</span>
<a id="__codelineno-60-17" name="__codelineno-60-17" href="#__codelineno-60-17"></a><span class="w">        </span><span class="c1">//      return toCvSE3(s*eigR,eigt);</span>
<a id="__codelineno-60-18" name="__codelineno-60-18" href="#__codelineno-60-18"></a><span class="w">        </span><span class="c1">//  }</span>
<a id="__codelineno-60-19" name="__codelineno-60-19" href="#__codelineno-60-19"></a><span class="w">        </span><span class="c1">// *********************</span>
<a id="__codelineno-60-20" name="__codelineno-60-20" href="#__codelineno-60-20"></a><span class="w">        </span><span class="c1">//  cv::Mat Converter::toCvSE3(const Eigen::Matrix&lt;double,3,3&gt; &amp;R, const Eigen::Matrix&lt;double,3,1&gt; &amp;t)</span>
<a id="__codelineno-60-21" name="__codelineno-60-21" href="#__codelineno-60-21"></a><span class="w">        </span><span class="c1">//  {</span>
<a id="__codelineno-60-22" name="__codelineno-60-22" href="#__codelineno-60-22"></a><span class="w">        </span><span class="c1">//  cv::Mat cvMat = cv::Mat::eye(4,4,CV_32F);</span>
<a id="__codelineno-60-23" name="__codelineno-60-23" href="#__codelineno-60-23"></a><span class="w">        </span><span class="c1">//  for(int i=0;i&lt;3;i++)</span>
<a id="__codelineno-60-24" name="__codelineno-60-24" href="#__codelineno-60-24"></a><span class="w">        </span><span class="c1">//  {</span>
<a id="__codelineno-60-25" name="__codelineno-60-25" href="#__codelineno-60-25"></a><span class="w">        </span><span class="c1">//    for(int j=0;j&lt;3;j++)</span>
<a id="__codelineno-60-26" name="__codelineno-60-26" href="#__codelineno-60-26"></a><span class="w">        </span><span class="c1">//    {</span>
<a id="__codelineno-60-27" name="__codelineno-60-27" href="#__codelineno-60-27"></a><span class="w">        </span><span class="c1">//        cvMat.at&lt;float&gt;(i,j)=R(i,j);</span>
<a id="__codelineno-60-28" name="__codelineno-60-28" href="#__codelineno-60-28"></a><span class="w">        </span><span class="c1">//    }</span>
<a id="__codelineno-60-29" name="__codelineno-60-29" href="#__codelineno-60-29"></a><span class="w">        </span><span class="c1">//  }</span>
<a id="__codelineno-60-30" name="__codelineno-60-30" href="#__codelineno-60-30"></a><span class="w">        </span><span class="c1">//  for(int i=0;i&lt;3;i++)</span>
<a id="__codelineno-60-31" name="__codelineno-60-31" href="#__codelineno-60-31"></a><span class="w">        </span><span class="c1">//  {</span>
<a id="__codelineno-60-32" name="__codelineno-60-32" href="#__codelineno-60-32"></a><span class="w">        </span><span class="c1">//    cvMat.at&lt;float&gt;(i,3)=t(i);</span>
<a id="__codelineno-60-33" name="__codelineno-60-33" href="#__codelineno-60-33"></a><span class="w">        </span><span class="c1">//  }</span>
<a id="__codelineno-60-34" name="__codelineno-60-34" href="#__codelineno-60-34"></a><span class="w">        </span><span class="c1">//  return cvMat.clone();</span>
<a id="__codelineno-60-35" name="__codelineno-60-35" href="#__codelineno-60-35"></a><span class="w">        </span><span class="c1">//  }</span>
<a id="__codelineno-60-36" name="__codelineno-60-36" href="#__codelineno-60-36"></a><span class="w">        </span><span class="c1">// *********************</span>
<a id="__codelineno-60-37" name="__codelineno-60-37" href="#__codelineno-60-37"></a><span class="w">        </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">cvScw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Converter</span><span class="o">::</span><span class="n">toCvMat</span><span class="p">(</span><span class="n">g2oScw</span><span class="p">);</span>
<a id="__codelineno-60-38" name="__codelineno-60-38" href="#__codelineno-60-38"></a>
<a id="__codelineno-60-39" name="__codelineno-60-39" href="#__codelineno-60-39"></a><span class="w">        </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">vpReplacePoints</span><span class="p">(</span><span class="n">mvpLoopMapPoints</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
<a id="__codelineno-60-40" name="__codelineno-60-40" href="#__codelineno-60-40"></a><span class="w">        </span><span class="n">matcher</span><span class="p">.</span><span class="n">Fuse</span><span class="p">(</span><span class="n">pKF</span><span class="p">,</span><span class="n">cvScw</span><span class="p">,</span><span class="n">mvpLoopMapPoints</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">vpReplacePoints</span><span class="p">);</span>
<a id="__codelineno-60-41" name="__codelineno-60-41" href="#__codelineno-60-41"></a>
<a id="__codelineno-60-42" name="__codelineno-60-42" href="#__codelineno-60-42"></a><span class="w">        </span><span class="c1">// Get Map Mutex</span>
<a id="__codelineno-60-43" name="__codelineno-60-43" href="#__codelineno-60-43"></a><span class="w">        </span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">mpMap</span><span class="o">-&gt;</span><span class="n">mMutexMapUpdate</span><span class="p">);</span>
<a id="__codelineno-60-44" name="__codelineno-60-44" href="#__codelineno-60-44"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nLP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mvpLoopMapPoints</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<a id="__codelineno-60-45" name="__codelineno-60-45" href="#__codelineno-60-45"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">nLP</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-60-46" name="__codelineno-60-46" href="#__codelineno-60-46"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-60-47" name="__codelineno-60-47" href="#__codelineno-60-47"></a><span class="w">            </span><span class="n">MapPoint</span><span class="o">*</span><span class="w"> </span><span class="n">pRep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vpReplacePoints</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-60-48" name="__codelineno-60-48" href="#__codelineno-60-48"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">pRep</span><span class="p">)</span>
<a id="__codelineno-60-49" name="__codelineno-60-49" href="#__codelineno-60-49"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-60-50" name="__codelineno-60-50" href="#__codelineno-60-50"></a><span class="w">                </span><span class="n">pRep</span><span class="o">-&gt;</span><span class="n">Replace</span><span class="p">(</span><span class="n">mvpLoopMapPoints</span><span class="p">[</span><span class="n">i</span><span class="p">]);;</span>
<a id="__codelineno-60-51" name="__codelineno-60-51" href="#__codelineno-60-51"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-60-52" name="__codelineno-60-52" href="#__codelineno-60-52"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-60-53" name="__codelineno-60-53" href="#__codelineno-60-53"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-60-54" name="__codelineno-60-54" href="#__codelineno-60-54"></a><span class="p">}</span>
<a id="__codelineno-60-55" name="__codelineno-60-55" href="#__codelineno-60-55"></a>
<a id="__codelineno-60-56" name="__codelineno-60-56" href="#__codelineno-60-56"></a><span class="kt">int</span><span class="w"> </span><span class="nf">ORBmatcher::Fuse</span><span class="p">(</span><span class="n">KeyFrame</span><span class="w"> </span><span class="o">*</span><span class="n">pKF</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">Scw</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vpPoints</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">th</span><span class="p">,</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vpReplacePoint</span><span class="p">)</span>
<a id="__codelineno-60-57" name="__codelineno-60-57" href="#__codelineno-60-57"></a><span class="p">{</span>
<a id="__codelineno-60-58" name="__codelineno-60-58" href="#__codelineno-60-58"></a><span class="w">    </span><span class="c1">// Get Calibration Parameters for later projection</span>
<a id="__codelineno-60-59" name="__codelineno-60-59" href="#__codelineno-60-59"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">&amp;</span><span class="n">fx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">fx</span><span class="p">;</span>
<a id="__codelineno-60-60" name="__codelineno-60-60" href="#__codelineno-60-60"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">&amp;</span><span class="n">fy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">fy</span><span class="p">;</span>
<a id="__codelineno-60-61" name="__codelineno-60-61" href="#__codelineno-60-61"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">cx</span><span class="p">;</span>
<a id="__codelineno-60-62" name="__codelineno-60-62" href="#__codelineno-60-62"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">cy</span><span class="p">;</span>
<a id="__codelineno-60-63" name="__codelineno-60-63" href="#__codelineno-60-63"></a>
<a id="__codelineno-60-64" name="__codelineno-60-64" href="#__codelineno-60-64"></a><span class="w">    </span><span class="c1">// Decompose Scw</span>
<a id="__codelineno-60-65" name="__codelineno-60-65" href="#__codelineno-60-65"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">sRcw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Scw</span><span class="p">.</span><span class="n">rowRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">).</span><span class="n">colRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
<a id="__codelineno-60-66" name="__codelineno-60-66" href="#__codelineno-60-66"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">scw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">sRcw</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">dot</span><span class="p">(</span><span class="n">sRcw</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="mi">0</span><span class="p">)));</span>
<a id="__codelineno-60-67" name="__codelineno-60-67" href="#__codelineno-60-67"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">Rcw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sRcw</span><span class="o">/</span><span class="n">scw</span><span class="p">;</span>
<a id="__codelineno-60-68" name="__codelineno-60-68" href="#__codelineno-60-68"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">tcw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Scw</span><span class="p">.</span><span class="n">rowRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">).</span><span class="n">col</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="n">scw</span><span class="p">;</span>
<a id="__codelineno-60-69" name="__codelineno-60-69" href="#__codelineno-60-69"></a><span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">Ow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">Rcw</span><span class="p">.</span><span class="n">t</span><span class="p">()</span><span class="o">*</span><span class="n">tcw</span><span class="p">;</span>
<a id="__codelineno-60-70" name="__codelineno-60-70" href="#__codelineno-60-70"></a>
<a id="__codelineno-60-71" name="__codelineno-60-71" href="#__codelineno-60-71"></a><span class="w">    </span><span class="c1">// Set of MapPoints already found in the KeyFrame</span>
<a id="__codelineno-60-72" name="__codelineno-60-72" href="#__codelineno-60-72"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">set</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">spAlreadyFound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">GetMapPoints</span><span class="p">();</span>
<a id="__codelineno-60-73" name="__codelineno-60-73" href="#__codelineno-60-73"></a>
<a id="__codelineno-60-74" name="__codelineno-60-74" href="#__codelineno-60-74"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nFused</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-60-75" name="__codelineno-60-75" href="#__codelineno-60-75"></a>
<a id="__codelineno-60-76" name="__codelineno-60-76" href="#__codelineno-60-76"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nPoints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vpPoints</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<a id="__codelineno-60-77" name="__codelineno-60-77" href="#__codelineno-60-77"></a>
<a id="__codelineno-60-78" name="__codelineno-60-78" href="#__codelineno-60-78"></a><span class="w">    </span><span class="c1">// For each candidate MapPoint project and match</span>
<a id="__codelineno-60-79" name="__codelineno-60-79" href="#__codelineno-60-79"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">iMP</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">iMP</span><span class="o">&lt;</span><span class="n">nPoints</span><span class="p">;</span><span class="w"> </span><span class="n">iMP</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-60-80" name="__codelineno-60-80" href="#__codelineno-60-80"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-60-81" name="__codelineno-60-81" href="#__codelineno-60-81"></a><span class="w">        </span><span class="n">MapPoint</span><span class="o">*</span><span class="w"> </span><span class="n">pMP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vpPoints</span><span class="p">[</span><span class="n">iMP</span><span class="p">];</span>
<a id="__codelineno-60-82" name="__codelineno-60-82" href="#__codelineno-60-82"></a>
<a id="__codelineno-60-83" name="__codelineno-60-83" href="#__codelineno-60-83"></a><span class="w">        </span><span class="c1">// Discard Bad MapPoints and already found</span>
<a id="__codelineno-60-84" name="__codelineno-60-84" href="#__codelineno-60-84"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">isBad</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">spAlreadyFound</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">pMP</span><span class="p">))</span>
<a id="__codelineno-60-85" name="__codelineno-60-85" href="#__codelineno-60-85"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-60-86" name="__codelineno-60-86" href="#__codelineno-60-86"></a>
<a id="__codelineno-60-87" name="__codelineno-60-87" href="#__codelineno-60-87"></a><span class="w">        </span><span class="c1">// Get 3D Coords.</span>
<a id="__codelineno-60-88" name="__codelineno-60-88" href="#__codelineno-60-88"></a><span class="w">        </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">p3Dw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">GetWorldPos</span><span class="p">();</span>
<a id="__codelineno-60-89" name="__codelineno-60-89" href="#__codelineno-60-89"></a>
<a id="__codelineno-60-90" name="__codelineno-60-90" href="#__codelineno-60-90"></a><span class="w">        </span><span class="c1">// Transform into Camera Coords.</span>
<a id="__codelineno-60-91" name="__codelineno-60-91" href="#__codelineno-60-91"></a><span class="w">        </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">p3Dc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Rcw</span><span class="o">*</span><span class="n">p3Dw</span><span class="o">+</span><span class="n">tcw</span><span class="p">;</span>
<a id="__codelineno-60-92" name="__codelineno-60-92" href="#__codelineno-60-92"></a>
<a id="__codelineno-60-93" name="__codelineno-60-93" href="#__codelineno-60-93"></a><span class="w">        </span><span class="c1">// Depth must be positive</span>
<a id="__codelineno-60-94" name="__codelineno-60-94" href="#__codelineno-60-94"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">p3Dc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">0.0f</span><span class="p">)</span>
<a id="__codelineno-60-95" name="__codelineno-60-95" href="#__codelineno-60-95"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-60-96" name="__codelineno-60-96" href="#__codelineno-60-96"></a>
<a id="__codelineno-60-97" name="__codelineno-60-97" href="#__codelineno-60-97"></a><span class="w">        </span><span class="c1">// Project into Image</span>
<a id="__codelineno-60-98" name="__codelineno-60-98" href="#__codelineno-60-98"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">invz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="o">/</span><span class="n">p3Dc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-60-99" name="__codelineno-60-99" href="#__codelineno-60-99"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p3Dc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">invz</span><span class="p">;</span>
<a id="__codelineno-60-100" name="__codelineno-60-100" href="#__codelineno-60-100"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p3Dc</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">invz</span><span class="p">;</span>
<a id="__codelineno-60-101" name="__codelineno-60-101" href="#__codelineno-60-101"></a>
<a id="__codelineno-60-102" name="__codelineno-60-102" href="#__codelineno-60-102"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fx</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="n">cx</span><span class="p">;</span>
<a id="__codelineno-60-103" name="__codelineno-60-103" href="#__codelineno-60-103"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fy</span><span class="o">*</span><span class="n">y</span><span class="o">+</span><span class="n">cy</span><span class="p">;</span>
<a id="__codelineno-60-104" name="__codelineno-60-104" href="#__codelineno-60-104"></a>
<a id="__codelineno-60-105" name="__codelineno-60-105" href="#__codelineno-60-105"></a><span class="w">        </span><span class="c1">// Point must be inside the image</span>
<a id="__codelineno-60-106" name="__codelineno-60-106" href="#__codelineno-60-106"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">IsInImage</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">))</span>
<a id="__codelineno-60-107" name="__codelineno-60-107" href="#__codelineno-60-107"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-60-108" name="__codelineno-60-108" href="#__codelineno-60-108"></a>
<a id="__codelineno-60-109" name="__codelineno-60-109" href="#__codelineno-60-109"></a><span class="w">        </span><span class="c1">// Depth must be inside the scale pyramid of the image</span>
<a id="__codelineno-60-110" name="__codelineno-60-110" href="#__codelineno-60-110"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">maxDistance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">GetMaxDistanceInvariance</span><span class="p">();</span>
<a id="__codelineno-60-111" name="__codelineno-60-111" href="#__codelineno-60-111"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">minDistance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">GetMinDistanceInvariance</span><span class="p">();</span>
<a id="__codelineno-60-112" name="__codelineno-60-112" href="#__codelineno-60-112"></a><span class="w">        </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">PO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p3Dw</span><span class="o">-</span><span class="n">Ow</span><span class="p">;</span>
<a id="__codelineno-60-113" name="__codelineno-60-113" href="#__codelineno-60-113"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">dist3D</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">norm</span><span class="p">(</span><span class="n">PO</span><span class="p">);</span>
<a id="__codelineno-60-114" name="__codelineno-60-114" href="#__codelineno-60-114"></a>
<a id="__codelineno-60-115" name="__codelineno-60-115" href="#__codelineno-60-115"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">dist3D</span><span class="o">&lt;</span><span class="n">minDistance</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">dist3D</span><span class="o">&gt;</span><span class="n">maxDistance</span><span class="p">)</span>
<a id="__codelineno-60-116" name="__codelineno-60-116" href="#__codelineno-60-116"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-60-117" name="__codelineno-60-117" href="#__codelineno-60-117"></a>
<a id="__codelineno-60-118" name="__codelineno-60-118" href="#__codelineno-60-118"></a><span class="w">        </span><span class="c1">// Viewing angle must be less than 60 deg</span>
<a id="__codelineno-60-119" name="__codelineno-60-119" href="#__codelineno-60-119"></a><span class="w">        </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">Pn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">GetNormal</span><span class="p">();</span>
<a id="__codelineno-60-120" name="__codelineno-60-120" href="#__codelineno-60-120"></a>
<a id="__codelineno-60-121" name="__codelineno-60-121" href="#__codelineno-60-121"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">PO</span><span class="p">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Pn</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">0.5</span><span class="o">*</span><span class="n">dist3D</span><span class="p">)</span>
<a id="__codelineno-60-122" name="__codelineno-60-122" href="#__codelineno-60-122"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-60-123" name="__codelineno-60-123" href="#__codelineno-60-123"></a>
<a id="__codelineno-60-124" name="__codelineno-60-124" href="#__codelineno-60-124"></a><span class="w">        </span><span class="c1">// Compute predicted scale level</span>
<a id="__codelineno-60-125" name="__codelineno-60-125" href="#__codelineno-60-125"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nPredictedLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">PredictScale</span><span class="p">(</span><span class="n">dist3D</span><span class="p">,</span><span class="n">pKF</span><span class="p">);</span>
<a id="__codelineno-60-126" name="__codelineno-60-126" href="#__codelineno-60-126"></a>
<a id="__codelineno-60-127" name="__codelineno-60-127" href="#__codelineno-60-127"></a><span class="w">        </span><span class="c1">// Search in a radius</span>
<a id="__codelineno-60-128" name="__codelineno-60-128" href="#__codelineno-60-128"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">radius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">th</span><span class="o">*</span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">mvScaleFactors</span><span class="p">[</span><span class="n">nPredictedLevel</span><span class="p">];</span>
<a id="__codelineno-60-129" name="__codelineno-60-129" href="#__codelineno-60-129"></a>
<a id="__codelineno-60-130" name="__codelineno-60-130" href="#__codelineno-60-130"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vIndices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">GetFeaturesInArea</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">radius</span><span class="p">);</span>
<a id="__codelineno-60-131" name="__codelineno-60-131" href="#__codelineno-60-131"></a>
<a id="__codelineno-60-132" name="__codelineno-60-132" href="#__codelineno-60-132"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">vIndices</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
<a id="__codelineno-60-133" name="__codelineno-60-133" href="#__codelineno-60-133"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-60-134" name="__codelineno-60-134" href="#__codelineno-60-134"></a>
<a id="__codelineno-60-135" name="__codelineno-60-135" href="#__codelineno-60-135"></a><span class="w">        </span><span class="c1">// Match to the most similar keypoint in the radius</span>
<a id="__codelineno-60-136" name="__codelineno-60-136" href="#__codelineno-60-136"></a>
<a id="__codelineno-60-137" name="__codelineno-60-137" href="#__codelineno-60-137"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">dMP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">GetDescriptor</span><span class="p">();</span>
<a id="__codelineno-60-138" name="__codelineno-60-138" href="#__codelineno-60-138"></a>
<a id="__codelineno-60-139" name="__codelineno-60-139" href="#__codelineno-60-139"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">bestDist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">INT_MAX</span><span class="p">;</span>
<a id="__codelineno-60-140" name="__codelineno-60-140" href="#__codelineno-60-140"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">bestIdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<a id="__codelineno-60-141" name="__codelineno-60-141" href="#__codelineno-60-141"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;::</span><span class="n">const_iterator</span><span class="w"> </span><span class="n">vit</span><span class="o">=</span><span class="n">vIndices</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"> </span><span class="n">vit</span><span class="o">!=</span><span class="n">vIndices</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">vit</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-60-142" name="__codelineno-60-142" href="#__codelineno-60-142"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-60-143" name="__codelineno-60-143" href="#__codelineno-60-143"></a><span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">vit</span><span class="p">;</span>
<a id="__codelineno-60-144" name="__codelineno-60-144" href="#__codelineno-60-144"></a><span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kpLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">mvKeysUn</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">octave</span><span class="p">;</span>
<a id="__codelineno-60-145" name="__codelineno-60-145" href="#__codelineno-60-145"></a>
<a id="__codelineno-60-146" name="__codelineno-60-146" href="#__codelineno-60-146"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">kpLevel</span><span class="o">&lt;</span><span class="n">nPredictedLevel</span><span class="mi">-1</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">kpLevel</span><span class="o">&gt;</span><span class="n">nPredictedLevel</span><span class="p">)</span>
<a id="__codelineno-60-147" name="__codelineno-60-147" href="#__codelineno-60-147"></a><span class="w">                </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-60-148" name="__codelineno-60-148" href="#__codelineno-60-148"></a>
<a id="__codelineno-60-149" name="__codelineno-60-149" href="#__codelineno-60-149"></a><span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dKF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">mDescriptors</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
<a id="__codelineno-60-150" name="__codelineno-60-150" href="#__codelineno-60-150"></a>
<a id="__codelineno-60-151" name="__codelineno-60-151" href="#__codelineno-60-151"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DescriptorDistance</span><span class="p">(</span><span class="n">dMP</span><span class="p">,</span><span class="n">dKF</span><span class="p">);</span>
<a id="__codelineno-60-152" name="__codelineno-60-152" href="#__codelineno-60-152"></a>
<a id="__codelineno-60-153" name="__codelineno-60-153" href="#__codelineno-60-153"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">dist</span><span class="o">&lt;</span><span class="n">bestDist</span><span class="p">)</span>
<a id="__codelineno-60-154" name="__codelineno-60-154" href="#__codelineno-60-154"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-60-155" name="__codelineno-60-155" href="#__codelineno-60-155"></a><span class="w">                </span><span class="n">bestDist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dist</span><span class="p">;</span>
<a id="__codelineno-60-156" name="__codelineno-60-156" href="#__codelineno-60-156"></a><span class="w">                </span><span class="n">bestIdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idx</span><span class="p">;</span>
<a id="__codelineno-60-157" name="__codelineno-60-157" href="#__codelineno-60-157"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-60-158" name="__codelineno-60-158" href="#__codelineno-60-158"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-60-159" name="__codelineno-60-159" href="#__codelineno-60-159"></a>
<a id="__codelineno-60-160" name="__codelineno-60-160" href="#__codelineno-60-160"></a><span class="w">        </span><span class="c1">// If there is already a MapPoint replace otherwise add new measurement</span>
<a id="__codelineno-60-161" name="__codelineno-60-161" href="#__codelineno-60-161"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">bestDist</span><span class="o">&lt;=</span><span class="n">TH_LOW</span><span class="p">)</span>
<a id="__codelineno-60-162" name="__codelineno-60-162" href="#__codelineno-60-162"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-60-163" name="__codelineno-60-163" href="#__codelineno-60-163"></a><span class="w">            </span><span class="n">MapPoint</span><span class="o">*</span><span class="w"> </span><span class="n">pMPinKF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">GetMapPoint</span><span class="p">(</span><span class="n">bestIdx</span><span class="p">);</span>
<a id="__codelineno-60-164" name="__codelineno-60-164" href="#__codelineno-60-164"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">pMPinKF</span><span class="p">)</span>
<a id="__codelineno-60-165" name="__codelineno-60-165" href="#__codelineno-60-165"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-60-166" name="__codelineno-60-166" href="#__codelineno-60-166"></a><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">pMPinKF</span><span class="o">-&gt;</span><span class="n">isBad</span><span class="p">())</span>
<a id="__codelineno-60-167" name="__codelineno-60-167" href="#__codelineno-60-167"></a><span class="w">                    </span><span class="n">vpReplacePoint</span><span class="p">[</span><span class="n">iMP</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pMPinKF</span><span class="p">;</span>
<a id="__codelineno-60-168" name="__codelineno-60-168" href="#__codelineno-60-168"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-60-169" name="__codelineno-60-169" href="#__codelineno-60-169"></a><span class="w">            </span><span class="k">else</span>
<a id="__codelineno-60-170" name="__codelineno-60-170" href="#__codelineno-60-170"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-60-171" name="__codelineno-60-171" href="#__codelineno-60-171"></a><span class="w">                </span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">AddObservation</span><span class="p">(</span><span class="n">pKF</span><span class="p">,</span><span class="n">bestIdx</span><span class="p">);</span>
<a id="__codelineno-60-172" name="__codelineno-60-172" href="#__codelineno-60-172"></a><span class="w">                </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">AddMapPoint</span><span class="p">(</span><span class="n">pMP</span><span class="p">,</span><span class="n">bestIdx</span><span class="p">);</span>
<a id="__codelineno-60-173" name="__codelineno-60-173" href="#__codelineno-60-173"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-60-174" name="__codelineno-60-174" href="#__codelineno-60-174"></a><span class="w">            </span><span class="n">nFused</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-60-175" name="__codelineno-60-175" href="#__codelineno-60-175"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-60-176" name="__codelineno-60-176" href="#__codelineno-60-176"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-60-177" name="__codelineno-60-177" href="#__codelineno-60-177"></a>
<a id="__codelineno-60-178" name="__codelineno-60-178" href="#__codelineno-60-178"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">nFused</span><span class="p">;</span>
<a id="__codelineno-60-179" name="__codelineno-60-179" href="#__codelineno-60-179"></a><span class="p">}</span>
</code></pre></div>
<h3 id="essentail-graph-optimization">Essentail Graph Optimization</h3>
<p>Get keyframes <code>const vector&lt;KeyFrame*&gt; vpKFs = pMap-&gt;GetAllKeyFrames();</code> whose poses are set to be optimized <code>optimizer.addVertex(VSim3);</code>.
All keyframes' poses are optimized except for some "truth" keyframes <code>if(pKF==pLoopKF)  VSim3-&gt;setFixed(true);</code>, where <code>pLoopKF</code> is computed in <code>LoopClosing::ComputeSim3()</code> if the keyframe's observed co-visible features are good.</p>
<p>There are three types of edges:
* <code>LoopConnections</code>: The keyframes in the area of loop closure, their transforms to each other are defined as edges
* from <code>vpKFs</code> get <code>KeyFrame* pKF = vpKFs[i];</code>
  * Spanning tree edge: <code>KeyFrame* pParentKF = pKF-&gt;GetParent();</code> when <code>if(pParentKF)</code> is true
  * Loop edge: <code>sLoopEdges = pKF-&gt;GetLoopEdges();</code> the transform between the current keyframe and the loop closure matched keyframe
  * Co-Visibility edge: <code>vpConnectedKFs = pKF-&gt;GetCovisiblesByWeight(minFeat);</code> every keyframe can have many associated highly co-visible keyframes, that the transforms are taken into consideration</p>
<p>The edge/error goes like this: before the optimization, loop closure keyframes <code>if(pKF==pLoopKF)  VSim3-&gt;setFixed(true);</code> are set to fixed, and the transform between keyframes <code>e-&gt;setMeasurement(&lt;transform&gt;);</code> are believed truths,
so that the non-loop-closure keyframes should have their poses aligned to the transforms.</p>
<p>Finally, perform <span class="arithmatex">\(SE(3)\)</span> recovery: <span class="arithmatex">\(\begin{bmatrix} sR &amp; \mathbf{t} \\\\ 0 &amp; 1 \end{bmatrix} \rightarrow \begin{bmatrix} R &amp; \frac{1}{s}\mathbf{t} \\\\ 0 &amp; 1 \end{bmatrix}\)</span> and by the recovery to restore map points.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">Optimizer::OptimizeEssentialGraph</span><span class="p">(</span><span class="n">Map</span><span class="o">*</span><span class="w"> </span><span class="n">pMap</span><span class="p">,</span><span class="w"> </span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pLoopKF</span><span class="p">,</span><span class="w"> </span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pCurKF</span><span class="p">,</span>
<a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a><span class="w">                                       </span><span class="k">const</span><span class="w"> </span><span class="n">LoopClosing</span><span class="o">::</span><span class="n">KeyFrameAndPose</span><span class="w"> </span><span class="o">&amp;</span><span class="n">NonCorrectedSim3</span><span class="p">,</span>
<a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a><span class="w">                                       </span><span class="k">const</span><span class="w"> </span><span class="n">LoopClosing</span><span class="o">::</span><span class="n">KeyFrameAndPose</span><span class="w"> </span><span class="o">&amp;</span><span class="n">CorrectedSim3</span><span class="p">,</span>
<a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a><span class="w">                                       </span><span class="k">const</span><span class="w"> </span><span class="n">map</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">set</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">LoopConnections</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bFixScale</span><span class="p">)</span>
<a id="__codelineno-61-5" name="__codelineno-61-5" href="#__codelineno-61-5"></a><span class="p">{</span>
<a id="__codelineno-61-6" name="__codelineno-61-6" href="#__codelineno-61-6"></a><span class="w">    </span><span class="c1">// Setup optimizer</span>
<a id="__codelineno-61-7" name="__codelineno-61-7" href="#__codelineno-61-7"></a><span class="w">    </span><span class="n">g2o</span><span class="o">::</span><span class="n">SparseOptimizer</span><span class="w"> </span><span class="n">optimizer</span><span class="p">;</span>
<a id="__codelineno-61-8" name="__codelineno-61-8" href="#__codelineno-61-8"></a><span class="w">    </span><span class="n">optimizer</span><span class="p">.</span><span class="n">setVerbose</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
<a id="__codelineno-61-9" name="__codelineno-61-9" href="#__codelineno-61-9"></a><span class="w">    </span><span class="n">g2o</span><span class="o">::</span><span class="n">BlockSolver_7_3</span><span class="o">::</span><span class="n">LinearSolverType</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">linearSolver</span><span class="w"> </span><span class="o">=</span>
<a id="__codelineno-61-10" name="__codelineno-61-10" href="#__codelineno-61-10"></a><span class="w">           </span><span class="k">new</span><span class="w"> </span><span class="n">g2o</span><span class="o">::</span><span class="n">LinearSolverEigen</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">BlockSolver_7_3</span><span class="o">::</span><span class="n">PoseMatrixType</span><span class="o">&gt;</span><span class="p">();</span>
<a id="__codelineno-61-11" name="__codelineno-61-11" href="#__codelineno-61-11"></a><span class="w">    </span><span class="n">g2o</span><span class="o">::</span><span class="n">BlockSolver_7_3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">solver_ptr</span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">g2o</span><span class="o">::</span><span class="n">BlockSolver_7_3</span><span class="p">(</span><span class="n">linearSolver</span><span class="p">);</span>
<a id="__codelineno-61-12" name="__codelineno-61-12" href="#__codelineno-61-12"></a><span class="w">    </span><span class="n">g2o</span><span class="o">::</span><span class="n">OptimizationAlgorithmLevenberg</span><span class="o">*</span><span class="w"> </span><span class="n">solver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">g2o</span><span class="o">::</span><span class="n">OptimizationAlgorithmLevenberg</span><span class="p">(</span><span class="n">solver_ptr</span><span class="p">);</span>
<a id="__codelineno-61-13" name="__codelineno-61-13" href="#__codelineno-61-13"></a>
<a id="__codelineno-61-14" name="__codelineno-61-14" href="#__codelineno-61-14"></a><span class="w">    </span><span class="n">solver</span><span class="o">-&gt;</span><span class="n">setUserLambdaInit</span><span class="p">(</span><span class="mf">1e-16</span><span class="p">);</span>
<a id="__codelineno-61-15" name="__codelineno-61-15" href="#__codelineno-61-15"></a><span class="w">    </span><span class="n">optimizer</span><span class="p">.</span><span class="n">setAlgorithm</span><span class="p">(</span><span class="n">solver</span><span class="p">);</span>
<a id="__codelineno-61-16" name="__codelineno-61-16" href="#__codelineno-61-16"></a>
<a id="__codelineno-61-17" name="__codelineno-61-17" href="#__codelineno-61-17"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">vpKFs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pMap</span><span class="o">-&gt;</span><span class="n">GetAllKeyFrames</span><span class="p">();</span>
<a id="__codelineno-61-18" name="__codelineno-61-18" href="#__codelineno-61-18"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">MapPoint</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">vpMPs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pMap</span><span class="o">-&gt;</span><span class="n">GetAllMapPoints</span><span class="p">();</span>
<a id="__codelineno-61-19" name="__codelineno-61-19" href="#__codelineno-61-19"></a>
<a id="__codelineno-61-20" name="__codelineno-61-20" href="#__codelineno-61-20"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nMaxKFid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pMap</span><span class="o">-&gt;</span><span class="n">GetMaxKFid</span><span class="p">();</span>
<a id="__codelineno-61-21" name="__codelineno-61-21" href="#__codelineno-61-21"></a>
<a id="__codelineno-61-22" name="__codelineno-61-22" href="#__codelineno-61-22"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">Sim3</span><span class="p">,</span><span class="n">Eigen</span><span class="o">::</span><span class="n">aligned_allocator</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">Sim3</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vScw</span><span class="p">(</span><span class="n">nMaxKFid</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-61-23" name="__codelineno-61-23" href="#__codelineno-61-23"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">Sim3</span><span class="p">,</span><span class="n">Eigen</span><span class="o">::</span><span class="n">aligned_allocator</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">Sim3</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vCorrectedSwc</span><span class="p">(</span><span class="n">nMaxKFid</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-61-24" name="__codelineno-61-24" href="#__codelineno-61-24"></a><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">VertexSim3Expmap</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">vpVertices</span><span class="p">(</span><span class="n">nMaxKFid</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-61-25" name="__codelineno-61-25" href="#__codelineno-61-25"></a>
<a id="__codelineno-61-26" name="__codelineno-61-26" href="#__codelineno-61-26"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">minFeat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
<a id="__codelineno-61-27" name="__codelineno-61-27" href="#__codelineno-61-27"></a>
<a id="__codelineno-61-28" name="__codelineno-61-28" href="#__codelineno-61-28"></a><span class="w">    </span><span class="c1">// Set KeyFrame vertices</span>
<a id="__codelineno-61-29" name="__codelineno-61-29" href="#__codelineno-61-29"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">iend</span><span class="o">=</span><span class="n">vpKFs</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">iend</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-61-30" name="__codelineno-61-30" href="#__codelineno-61-30"></a><span class="w">        </span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pKF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vpKFs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-61-31" name="__codelineno-61-31" href="#__codelineno-61-31"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">isBad</span><span class="p">())</span>
<a id="__codelineno-61-32" name="__codelineno-61-32" href="#__codelineno-61-32"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-61-33" name="__codelineno-61-33" href="#__codelineno-61-33"></a><span class="w">        </span><span class="n">g2o</span><span class="o">::</span><span class="n">VertexSim3Expmap</span><span class="o">*</span><span class="w"> </span><span class="n">VSim3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">g2o</span><span class="o">::</span><span class="n">VertexSim3Expmap</span><span class="p">();</span>
<a id="__codelineno-61-34" name="__codelineno-61-34" href="#__codelineno-61-34"></a>
<a id="__codelineno-61-35" name="__codelineno-61-35" href="#__codelineno-61-35"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nIDi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="p">;</span>
<a id="__codelineno-61-36" name="__codelineno-61-36" href="#__codelineno-61-36"></a>
<a id="__codelineno-61-37" name="__codelineno-61-37" href="#__codelineno-61-37"></a><span class="w">        </span><span class="n">LoopClosing</span><span class="o">::</span><span class="n">KeyFrameAndPose</span><span class="o">::</span><span class="n">const_iterator</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CorrectedSim3</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">pKF</span><span class="p">);</span>
<a id="__codelineno-61-38" name="__codelineno-61-38" href="#__codelineno-61-38"></a>
<a id="__codelineno-61-39" name="__codelineno-61-39" href="#__codelineno-61-39"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">it</span><span class="o">!=</span><span class="n">CorrectedSim3</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-61-40" name="__codelineno-61-40" href="#__codelineno-61-40"></a><span class="w">            </span><span class="n">vScw</span><span class="p">[</span><span class="n">nIDi</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
<a id="__codelineno-61-41" name="__codelineno-61-41" href="#__codelineno-61-41"></a><span class="w">            </span><span class="n">VSim3</span><span class="o">-&gt;</span><span class="n">setEstimate</span><span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">);</span>
<a id="__codelineno-61-42" name="__codelineno-61-42" href="#__codelineno-61-42"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-61-43" name="__codelineno-61-43" href="#__codelineno-61-43"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-61-44" name="__codelineno-61-44" href="#__codelineno-61-44"></a><span class="w">            </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Rcw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Converter</span><span class="o">::</span><span class="n">toMatrix3d</span><span class="p">(</span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">GetRotation</span><span class="p">());</span>
<a id="__codelineno-61-45" name="__codelineno-61-45" href="#__codelineno-61-45"></a><span class="w">            </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tcw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Converter</span><span class="o">::</span><span class="n">toVector3d</span><span class="p">(</span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">GetTranslation</span><span class="p">());</span>
<a id="__codelineno-61-46" name="__codelineno-61-46" href="#__codelineno-61-46"></a><span class="w">            </span><span class="n">g2o</span><span class="o">::</span><span class="n">Sim3</span><span class="w"> </span><span class="n">Siw</span><span class="p">(</span><span class="n">Rcw</span><span class="p">,</span><span class="n">tcw</span><span class="p">,</span><span class="mf">1.0</span><span class="p">);</span>
<a id="__codelineno-61-47" name="__codelineno-61-47" href="#__codelineno-61-47"></a><span class="w">            </span><span class="n">vScw</span><span class="p">[</span><span class="n">nIDi</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Siw</span><span class="p">;</span>
<a id="__codelineno-61-48" name="__codelineno-61-48" href="#__codelineno-61-48"></a><span class="w">            </span><span class="n">VSim3</span><span class="o">-&gt;</span><span class="n">setEstimate</span><span class="p">(</span><span class="n">Siw</span><span class="p">);</span>
<a id="__codelineno-61-49" name="__codelineno-61-49" href="#__codelineno-61-49"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-61-50" name="__codelineno-61-50" href="#__codelineno-61-50"></a>
<a id="__codelineno-61-51" name="__codelineno-61-51" href="#__codelineno-61-51"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">pKF</span><span class="o">==</span><span class="n">pLoopKF</span><span class="p">)</span>
<a id="__codelineno-61-52" name="__codelineno-61-52" href="#__codelineno-61-52"></a><span class="w">            </span><span class="n">VSim3</span><span class="o">-&gt;</span><span class="n">setFixed</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<a id="__codelineno-61-53" name="__codelineno-61-53" href="#__codelineno-61-53"></a>
<a id="__codelineno-61-54" name="__codelineno-61-54" href="#__codelineno-61-54"></a><span class="w">        </span><span class="n">VSim3</span><span class="o">-&gt;</span><span class="n">setId</span><span class="p">(</span><span class="n">nIDi</span><span class="p">);</span>
<a id="__codelineno-61-55" name="__codelineno-61-55" href="#__codelineno-61-55"></a><span class="w">        </span><span class="n">VSim3</span><span class="o">-&gt;</span><span class="n">setMarginalized</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
<a id="__codelineno-61-56" name="__codelineno-61-56" href="#__codelineno-61-56"></a><span class="w">        </span><span class="n">VSim3</span><span class="o">-&gt;</span><span class="n">_fix_scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bFixScale</span><span class="p">;</span>
<a id="__codelineno-61-57" name="__codelineno-61-57" href="#__codelineno-61-57"></a>
<a id="__codelineno-61-58" name="__codelineno-61-58" href="#__codelineno-61-58"></a><span class="w">        </span><span class="n">optimizer</span><span class="p">.</span><span class="n">addVertex</span><span class="p">(</span><span class="n">VSim3</span><span class="p">);</span>
<a id="__codelineno-61-59" name="__codelineno-61-59" href="#__codelineno-61-59"></a>
<a id="__codelineno-61-60" name="__codelineno-61-60" href="#__codelineno-61-60"></a><span class="w">        </span><span class="n">vpVertices</span><span class="p">[</span><span class="n">nIDi</span><span class="p">]</span><span class="o">=</span><span class="n">VSim3</span><span class="p">;</span>
<a id="__codelineno-61-61" name="__codelineno-61-61" href="#__codelineno-61-61"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-61-62" name="__codelineno-61-62" href="#__codelineno-61-62"></a>
<a id="__codelineno-61-63" name="__codelineno-61-63" href="#__codelineno-61-63"></a>
<a id="__codelineno-61-64" name="__codelineno-61-64" href="#__codelineno-61-64"></a><span class="w">    </span><span class="n">set</span><span class="o">&lt;</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">long</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="kt">long</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">sInsertedEdges</span><span class="p">;</span>
<a id="__codelineno-61-65" name="__codelineno-61-65" href="#__codelineno-61-65"></a>
<a id="__codelineno-61-66" name="__codelineno-61-66" href="#__codelineno-61-66"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="o">&gt;</span><span class="w"> </span><span class="n">matLambda</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="o">&gt;::</span><span class="n">Identity</span><span class="p">();</span><span class="n">vScw</span>
<a id="__codelineno-61-67" name="__codelineno-61-67" href="#__codelineno-61-67"></a>
<a id="__codelineno-61-68" name="__codelineno-61-68" href="#__codelineno-61-68"></a><span class="w">    </span><span class="c1">// Set Loop edges</span>
<a id="__codelineno-61-69" name="__codelineno-61-69" href="#__codelineno-61-69"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">map</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">set</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&gt;::</span><span class="n">const_iterator</span><span class="w"> </span><span class="n">mit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LoopConnections</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">mend</span><span class="o">=</span><span class="n">LoopConnections</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">mit</span><span class="o">!=</span><span class="n">mend</span><span class="p">;</span><span class="w"> </span><span class="n">mit</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-61-70" name="__codelineno-61-70" href="#__codelineno-61-70"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-61-71" name="__codelineno-61-71" href="#__codelineno-61-71"></a><span class="w">        </span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pKF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mit</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">;</span>
<a id="__codelineno-61-72" name="__codelineno-61-72" href="#__codelineno-61-72"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nIDi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="p">;</span>
<a id="__codelineno-61-73" name="__codelineno-61-73" href="#__codelineno-61-73"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">set</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">spConnections</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mit</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
<a id="__codelineno-61-74" name="__codelineno-61-74" href="#__codelineno-61-74"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">g2o</span><span class="o">::</span><span class="n">Sim3</span><span class="w"> </span><span class="n">Siw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vScw</span><span class="p">[</span><span class="n">nIDi</span><span class="p">];</span>
<a id="__codelineno-61-75" name="__codelineno-61-75" href="#__codelineno-61-75"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">g2o</span><span class="o">::</span><span class="n">Sim3</span><span class="w"> </span><span class="n">Swi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Siw</span><span class="p">.</span><span class="n">inverse</span><span class="p">();</span>
<a id="__codelineno-61-76" name="__codelineno-61-76" href="#__codelineno-61-76"></a>
<a id="__codelineno-61-77" name="__codelineno-61-77" href="#__codelineno-61-77"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">set</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;::</span><span class="n">const_iterator</span><span class="w"> </span><span class="n">sit</span><span class="o">=</span><span class="n">spConnections</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">send</span><span class="o">=</span><span class="n">spConnections</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">sit</span><span class="o">!=</span><span class="n">send</span><span class="p">;</span><span class="w"> </span><span class="n">sit</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-61-78" name="__codelineno-61-78" href="#__codelineno-61-78"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-61-79" name="__codelineno-61-79" href="#__codelineno-61-79"></a><span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nIDj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">sit</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="p">;</span>
<a id="__codelineno-61-80" name="__codelineno-61-80" href="#__codelineno-61-80"></a><span class="w">            </span><span class="k">if</span><span class="p">((</span><span class="n">nIDi</span><span class="o">!=</span><span class="n">pCurKF</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">nIDj</span><span class="o">!=</span><span class="n">pLoopKF</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">GetWeight</span><span class="p">(</span><span class="o">*</span><span class="n">sit</span><span class="p">)</span><span class="o">&lt;</span><span class="n">minFeat</span><span class="p">)</span>
<a id="__codelineno-61-81" name="__codelineno-61-81" href="#__codelineno-61-81"></a><span class="w">                </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-61-82" name="__codelineno-61-82" href="#__codelineno-61-82"></a>
<a id="__codelineno-61-83" name="__codelineno-61-83" href="#__codelineno-61-83"></a><span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="n">g2o</span><span class="o">::</span><span class="n">Sim3</span><span class="w"> </span><span class="n">Sjw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vScw</span><span class="p">[</span><span class="n">nIDj</span><span class="p">];</span>
<a id="__codelineno-61-84" name="__codelineno-61-84" href="#__codelineno-61-84"></a><span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="n">g2o</span><span class="o">::</span><span class="n">Sim3</span><span class="w"> </span><span class="n">Sji</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sjw</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Swi</span><span class="p">;</span>
<a id="__codelineno-61-85" name="__codelineno-61-85" href="#__codelineno-61-85"></a>
<a id="__codelineno-61-86" name="__codelineno-61-86" href="#__codelineno-61-86"></a><span class="w">            </span><span class="n">g2o</span><span class="o">::</span><span class="n">EdgeSim3</span><span class="o">*</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">g2o</span><span class="o">::</span><span class="n">EdgeSim3</span><span class="p">();</span>
<a id="__codelineno-61-87" name="__codelineno-61-87" href="#__codelineno-61-87"></a><span class="w">            </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">setVertex</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">OptimizableGraph</span><span class="o">::</span><span class="n">Vertex</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">optimizer</span><span class="p">.</span><span class="n">vertex</span><span class="p">(</span><span class="n">nIDj</span><span class="p">)));</span>
<a id="__codelineno-61-88" name="__codelineno-61-88" href="#__codelineno-61-88"></a><span class="w">            </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">setVertex</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">OptimizableGraph</span><span class="o">::</span><span class="n">Vertex</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">optimizer</span><span class="p">.</span><span class="n">vertex</span><span class="p">(</span><span class="n">nIDi</span><span class="p">)));</span>
<a id="__codelineno-61-89" name="__codelineno-61-89" href="#__codelineno-61-89"></a><span class="w">            </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">setMeasurement</span><span class="p">(</span><span class="n">Sji</span><span class="p">);</span>
<a id="__codelineno-61-90" name="__codelineno-61-90" href="#__codelineno-61-90"></a>
<a id="__codelineno-61-91" name="__codelineno-61-91" href="#__codelineno-61-91"></a><span class="w">            </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">information</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">matLambda</span><span class="p">;</span>
<a id="__codelineno-61-92" name="__codelineno-61-92" href="#__codelineno-61-92"></a>
<a id="__codelineno-61-93" name="__codelineno-61-93" href="#__codelineno-61-93"></a><span class="w">            </span><span class="n">optimizer</span><span class="p">.</span><span class="n">addEdge</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
<a id="__codelineno-61-94" name="__codelineno-61-94" href="#__codelineno-61-94"></a>
<a id="__codelineno-61-95" name="__codelineno-61-95" href="#__codelineno-61-95"></a><span class="w">            </span><span class="n">sInsertedEdges</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">make_pair</span><span class="p">(</span><span class="n">min</span><span class="p">(</span><span class="n">nIDi</span><span class="p">,</span><span class="n">nIDj</span><span class="p">),</span><span class="n">max</span><span class="p">(</span><span class="n">nIDi</span><span class="p">,</span><span class="n">nIDj</span><span class="p">)));</span>
<a id="__codelineno-61-96" name="__codelineno-61-96" href="#__codelineno-61-96"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-61-97" name="__codelineno-61-97" href="#__codelineno-61-97"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-61-98" name="__codelineno-61-98" href="#__codelineno-61-98"></a>
<a id="__codelineno-61-99" name="__codelineno-61-99" href="#__codelineno-61-99"></a><span class="w">    </span><span class="c1">// Set normal edges</span>
<a id="__codelineno-61-100" name="__codelineno-61-100" href="#__codelineno-61-100"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">iend</span><span class="o">=</span><span class="n">vpKFs</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">iend</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-61-101" name="__codelineno-61-101" href="#__codelineno-61-101"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-61-102" name="__codelineno-61-102" href="#__codelineno-61-102"></a><span class="w">        </span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pKF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vpKFs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-61-103" name="__codelineno-61-103" href="#__codelineno-61-103"></a>
<a id="__codelineno-61-104" name="__codelineno-61-104" href="#__codelineno-61-104"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nIDi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="p">;</span>
<a id="__codelineno-61-105" name="__codelineno-61-105" href="#__codelineno-61-105"></a>
<a id="__codelineno-61-106" name="__codelineno-61-106" href="#__codelineno-61-106"></a><span class="w">        </span><span class="n">g2o</span><span class="o">::</span><span class="n">Sim3</span><span class="w"> </span><span class="n">Swi</span><span class="p">;</span>
<a id="__codelineno-61-107" name="__codelineno-61-107" href="#__codelineno-61-107"></a>
<a id="__codelineno-61-108" name="__codelineno-61-108" href="#__codelineno-61-108"></a><span class="w">        </span><span class="n">LoopClosing</span><span class="o">::</span><span class="n">KeyFrameAndPose</span><span class="o">::</span><span class="n">const_iterator</span><span class="w"> </span><span class="n">iti</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NonCorrectedSim3</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">pKF</span><span class="p">);</span>
<a id="__codelineno-61-109" name="__codelineno-61-109" href="#__codelineno-61-109"></a>
<a id="__codelineno-61-110" name="__codelineno-61-110" href="#__codelineno-61-110"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">iti</span><span class="o">!=</span><span class="n">NonCorrectedSim3</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
<a id="__codelineno-61-111" name="__codelineno-61-111" href="#__codelineno-61-111"></a><span class="w">            </span><span class="n">Swi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">iti</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">).</span><span class="n">inverse</span><span class="p">();</span>
<a id="__codelineno-61-112" name="__codelineno-61-112" href="#__codelineno-61-112"></a><span class="w">        </span><span class="k">else</span>
<a id="__codelineno-61-113" name="__codelineno-61-113" href="#__codelineno-61-113"></a><span class="w">            </span><span class="n">Swi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vScw</span><span class="p">[</span><span class="n">nIDi</span><span class="p">].</span><span class="n">inverse</span><span class="p">();</span>
<a id="__codelineno-61-114" name="__codelineno-61-114" href="#__codelineno-61-114"></a>
<a id="__codelineno-61-115" name="__codelineno-61-115" href="#__codelineno-61-115"></a><span class="w">        </span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pParentKF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">GetParent</span><span class="p">();</span>
<a id="__codelineno-61-116" name="__codelineno-61-116" href="#__codelineno-61-116"></a>
<a id="__codelineno-61-117" name="__codelineno-61-117" href="#__codelineno-61-117"></a><span class="w">        </span><span class="c1">// Spanning tree edge</span>
<a id="__codelineno-61-118" name="__codelineno-61-118" href="#__codelineno-61-118"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">pParentKF</span><span class="p">)</span>
<a id="__codelineno-61-119" name="__codelineno-61-119" href="#__codelineno-61-119"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-61-120" name="__codelineno-61-120" href="#__codelineno-61-120"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">nIDj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pParentKF</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="p">;</span>
<a id="__codelineno-61-121" name="__codelineno-61-121" href="#__codelineno-61-121"></a>
<a id="__codelineno-61-122" name="__codelineno-61-122" href="#__codelineno-61-122"></a><span class="w">            </span><span class="n">g2o</span><span class="o">::</span><span class="n">Sim3</span><span class="w"> </span><span class="n">Sjw</span><span class="p">;</span>
<a id="__codelineno-61-123" name="__codelineno-61-123" href="#__codelineno-61-123"></a>
<a id="__codelineno-61-124" name="__codelineno-61-124" href="#__codelineno-61-124"></a><span class="w">            </span><span class="n">LoopClosing</span><span class="o">::</span><span class="n">KeyFrameAndPose</span><span class="o">::</span><span class="n">const_iterator</span><span class="w"> </span><span class="n">itj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NonCorrectedSim3</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">pParentKF</span><span class="p">);</span>
<a id="__codelineno-61-125" name="__codelineno-61-125" href="#__codelineno-61-125"></a>
<a id="__codelineno-61-126" name="__codelineno-61-126" href="#__codelineno-61-126"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">itj</span><span class="o">!=</span><span class="n">NonCorrectedSim3</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
<a id="__codelineno-61-127" name="__codelineno-61-127" href="#__codelineno-61-127"></a><span class="w">                </span><span class="n">Sjw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">itj</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
<a id="__codelineno-61-128" name="__codelineno-61-128" href="#__codelineno-61-128"></a><span class="w">            </span><span class="k">else</span>
<a id="__codelineno-61-129" name="__codelineno-61-129" href="#__codelineno-61-129"></a><span class="w">                </span><span class="n">Sjw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vScw</span><span class="p">[</span><span class="n">nIDj</span><span class="p">];</span>
<a id="__codelineno-61-130" name="__codelineno-61-130" href="#__codelineno-61-130"></a>
<a id="__codelineno-61-131" name="__codelineno-61-131" href="#__codelineno-61-131"></a><span class="w">            </span><span class="n">g2o</span><span class="o">::</span><span class="n">Sim3</span><span class="w"> </span><span class="n">Sji</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sjw</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Swi</span><span class="p">;</span>
<a id="__codelineno-61-132" name="__codelineno-61-132" href="#__codelineno-61-132"></a>
<a id="__codelineno-61-133" name="__codelineno-61-133" href="#__codelineno-61-133"></a><span class="w">            </span><span class="n">g2o</span><span class="o">::</span><span class="n">EdgeSim3</span><span class="o">*</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">g2o</span><span class="o">::</span><span class="n">EdgeSim3</span><span class="p">();</span>
<a id="__codelineno-61-134" name="__codelineno-61-134" href="#__codelineno-61-134"></a><span class="w">            </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">setVertex</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">OptimizableGraph</span><span class="o">::</span><span class="n">Vertex</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">optimizer</span><span class="p">.</span><span class="n">vertex</span><span class="p">(</span><span class="n">nIDj</span><span class="p">)));</span>
<a id="__codelineno-61-135" name="__codelineno-61-135" href="#__codelineno-61-135"></a><span class="w">            </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">setVertex</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">OptimizableGraph</span><span class="o">::</span><span class="n">Vertex</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">optimizer</span><span class="p">.</span><span class="n">vertex</span><span class="p">(</span><span class="n">nIDi</span><span class="p">)));</span>
<a id="__codelineno-61-136" name="__codelineno-61-136" href="#__codelineno-61-136"></a><span class="w">            </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">setMeasurement</span><span class="p">(</span><span class="n">Sji</span><span class="p">);</span>
<a id="__codelineno-61-137" name="__codelineno-61-137" href="#__codelineno-61-137"></a>
<a id="__codelineno-61-138" name="__codelineno-61-138" href="#__codelineno-61-138"></a><span class="w">            </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">information</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">matLambda</span><span class="p">;</span>
<a id="__codelineno-61-139" name="__codelineno-61-139" href="#__codelineno-61-139"></a><span class="w">            </span><span class="n">optimizer</span><span class="p">.</span><span class="n">addEdge</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
<a id="__codelineno-61-140" name="__codelineno-61-140" href="#__codelineno-61-140"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-61-141" name="__codelineno-61-141" href="#__codelineno-61-141"></a>
<a id="__codelineno-61-142" name="__codelineno-61-142" href="#__codelineno-61-142"></a><span class="w">        </span><span class="c1">// Loop edges</span>
<a id="__codelineno-61-143" name="__codelineno-61-143" href="#__codelineno-61-143"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">set</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">sLoopEdges</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">GetLoopEdges</span><span class="p">();</span>
<a id="__codelineno-61-144" name="__codelineno-61-144" href="#__codelineno-61-144"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">set</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;::</span><span class="n">const_iterator</span><span class="w"> </span><span class="n">sit</span><span class="o">=</span><span class="n">sLoopEdges</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">send</span><span class="o">=</span><span class="n">sLoopEdges</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">sit</span><span class="o">!=</span><span class="n">send</span><span class="p">;</span><span class="w"> </span><span class="n">sit</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-61-145" name="__codelineno-61-145" href="#__codelineno-61-145"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-61-146" name="__codelineno-61-146" href="#__codelineno-61-146"></a><span class="w">            </span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pLKF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">sit</span><span class="p">;</span>
<a id="__codelineno-61-147" name="__codelineno-61-147" href="#__codelineno-61-147"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">pLKF</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="o">&lt;</span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="p">)</span>
<a id="__codelineno-61-148" name="__codelineno-61-148" href="#__codelineno-61-148"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-61-149" name="__codelineno-61-149" href="#__codelineno-61-149"></a><span class="w">                </span><span class="n">g2o</span><span class="o">::</span><span class="n">Sim3</span><span class="w"> </span><span class="n">Slw</span><span class="p">;</span>
<a id="__codelineno-61-150" name="__codelineno-61-150" href="#__codelineno-61-150"></a>
<a id="__codelineno-61-151" name="__codelineno-61-151" href="#__codelineno-61-151"></a><span class="w">                </span><span class="n">LoopClosing</span><span class="o">::</span><span class="n">KeyFrameAndPose</span><span class="o">::</span><span class="n">const_iterator</span><span class="w"> </span><span class="n">itl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NonCorrectedSim3</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">pLKF</span><span class="p">);</span>
<a id="__codelineno-61-152" name="__codelineno-61-152" href="#__codelineno-61-152"></a>
<a id="__codelineno-61-153" name="__codelineno-61-153" href="#__codelineno-61-153"></a><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">itl</span><span class="o">!=</span><span class="n">NonCorrectedSim3</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
<a id="__codelineno-61-154" name="__codelineno-61-154" href="#__codelineno-61-154"></a><span class="w">                    </span><span class="n">Slw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">itl</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
<a id="__codelineno-61-155" name="__codelineno-61-155" href="#__codelineno-61-155"></a><span class="w">                </span><span class="k">else</span>
<a id="__codelineno-61-156" name="__codelineno-61-156" href="#__codelineno-61-156"></a><span class="w">                    </span><span class="n">Slw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vScw</span><span class="p">[</span><span class="n">pLKF</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="p">];</span>
<a id="__codelineno-61-157" name="__codelineno-61-157" href="#__codelineno-61-157"></a>
<a id="__codelineno-61-158" name="__codelineno-61-158" href="#__codelineno-61-158"></a><span class="w">                </span><span class="n">g2o</span><span class="o">::</span><span class="n">Sim3</span><span class="w"> </span><span class="n">Sli</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Slw</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Swi</span><span class="p">;</span>
<a id="__codelineno-61-159" name="__codelineno-61-159" href="#__codelineno-61-159"></a><span class="w">                </span><span class="n">g2o</span><span class="o">::</span><span class="n">EdgeSim3</span><span class="o">*</span><span class="w"> </span><span class="n">el</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">g2o</span><span class="o">::</span><span class="n">EdgeSim3</span><span class="p">();</span>
<a id="__codelineno-61-160" name="__codelineno-61-160" href="#__codelineno-61-160"></a><span class="w">                </span><span class="n">el</span><span class="o">-&gt;</span><span class="n">setVertex</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">OptimizableGraph</span><span class="o">::</span><span class="n">Vertex</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">optimizer</span><span class="p">.</span><span class="n">vertex</span><span class="p">(</span><span class="n">pLKF</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="p">)));</span>
<a id="__codelineno-61-161" name="__codelineno-61-161" href="#__codelineno-61-161"></a><span class="w">                </span><span class="n">el</span><span class="o">-&gt;</span><span class="n">setVertex</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">OptimizableGraph</span><span class="o">::</span><span class="n">Vertex</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">optimizer</span><span class="p">.</span><span class="n">vertex</span><span class="p">(</span><span class="n">nIDi</span><span class="p">)));</span>
<a id="__codelineno-61-162" name="__codelineno-61-162" href="#__codelineno-61-162"></a><span class="w">                </span><span class="n">el</span><span class="o">-&gt;</span><span class="n">setMeasurement</span><span class="p">(</span><span class="n">Sli</span><span class="p">);</span>
<a id="__codelineno-61-163" name="__codelineno-61-163" href="#__codelineno-61-163"></a><span class="w">                </span><span class="n">el</span><span class="o">-&gt;</span><span class="n">information</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">matLambda</span><span class="p">;</span>
<a id="__codelineno-61-164" name="__codelineno-61-164" href="#__codelineno-61-164"></a><span class="w">                </span><span class="n">optimizer</span><span class="p">.</span><span class="n">addEdge</span><span class="p">(</span><span class="n">el</span><span class="p">);</span>
<a id="__codelineno-61-165" name="__codelineno-61-165" href="#__codelineno-61-165"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-61-166" name="__codelineno-61-166" href="#__codelineno-61-166"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-61-167" name="__codelineno-61-167" href="#__codelineno-61-167"></a>
<a id="__codelineno-61-168" name="__codelineno-61-168" href="#__codelineno-61-168"></a><span class="w">        </span><span class="c1">// Covisibility graph edges</span>
<a id="__codelineno-61-169" name="__codelineno-61-169" href="#__codelineno-61-169"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">vpConnectedKFs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">GetCovisiblesByWeight</span><span class="p">(</span><span class="n">minFeat</span><span class="p">);</span>
<a id="__codelineno-61-170" name="__codelineno-61-170" href="#__codelineno-61-170"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;::</span><span class="n">const_iterator</span><span class="w"> </span><span class="n">vit</span><span class="o">=</span><span class="n">vpConnectedKFs</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"> </span><span class="n">vit</span><span class="o">!=</span><span class="n">vpConnectedKFs</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">vit</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-61-171" name="__codelineno-61-171" href="#__codelineno-61-171"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-61-172" name="__codelineno-61-172" href="#__codelineno-61-172"></a><span class="w">            </span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pKFn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">vit</span><span class="p">;</span>
<a id="__codelineno-61-173" name="__codelineno-61-173" href="#__codelineno-61-173"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">pKFn</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">pKFn</span><span class="o">!=</span><span class="n">pParentKF</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">hasChild</span><span class="p">(</span><span class="n">pKFn</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">sLoopEdges</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">pKFn</span><span class="p">))</span>
<a id="__codelineno-61-174" name="__codelineno-61-174" href="#__codelineno-61-174"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-61-175" name="__codelineno-61-175" href="#__codelineno-61-175"></a><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">pKFn</span><span class="o">-&gt;</span><span class="n">isBad</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">pKFn</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="o">&lt;</span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="p">)</span>
<a id="__codelineno-61-176" name="__codelineno-61-176" href="#__codelineno-61-176"></a><span class="w">                </span><span class="p">{</span>
<a id="__codelineno-61-177" name="__codelineno-61-177" href="#__codelineno-61-177"></a><span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="n">sInsertedEdges</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">make_pair</span><span class="p">(</span><span class="n">min</span><span class="p">(</span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="p">,</span><span class="n">pKFn</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="p">),</span><span class="n">max</span><span class="p">(</span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="p">,</span><span class="n">pKFn</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="p">))))</span>
<a id="__codelineno-61-178" name="__codelineno-61-178" href="#__codelineno-61-178"></a><span class="w">                        </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-61-179" name="__codelineno-61-179" href="#__codelineno-61-179"></a>
<a id="__codelineno-61-180" name="__codelineno-61-180" href="#__codelineno-61-180"></a><span class="w">                    </span><span class="n">g2o</span><span class="o">::</span><span class="n">Sim3</span><span class="w"> </span><span class="n">Snw</span><span class="p">;</span>
<a id="__codelineno-61-181" name="__codelineno-61-181" href="#__codelineno-61-181"></a>
<a id="__codelineno-61-182" name="__codelineno-61-182" href="#__codelineno-61-182"></a><span class="w">                    </span><span class="n">LoopClosing</span><span class="o">::</span><span class="n">KeyFrameAndPose</span><span class="o">::</span><span class="n">const_iterator</span><span class="w"> </span><span class="n">itn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NonCorrectedSim3</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">pKFn</span><span class="p">);</span>
<a id="__codelineno-61-183" name="__codelineno-61-183" href="#__codelineno-61-183"></a>
<a id="__codelineno-61-184" name="__codelineno-61-184" href="#__codelineno-61-184"></a><span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="n">itn</span><span class="o">!=</span><span class="n">NonCorrectedSim3</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
<a id="__codelineno-61-185" name="__codelineno-61-185" href="#__codelineno-61-185"></a><span class="w">                        </span><span class="n">Snw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">itn</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
<a id="__codelineno-61-186" name="__codelineno-61-186" href="#__codelineno-61-186"></a><span class="w">                    </span><span class="k">else</span>
<a id="__codelineno-61-187" name="__codelineno-61-187" href="#__codelineno-61-187"></a><span class="w">                        </span><span class="n">Snw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vScw</span><span class="p">[</span><span class="n">pKFn</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="p">];</span>
<a id="__codelineno-61-188" name="__codelineno-61-188" href="#__codelineno-61-188"></a>
<a id="__codelineno-61-189" name="__codelineno-61-189" href="#__codelineno-61-189"></a><span class="w">                    </span><span class="n">g2o</span><span class="o">::</span><span class="n">Sim3</span><span class="w"> </span><span class="n">Sni</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Snw</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Swi</span><span class="p">;</span>
<a id="__codelineno-61-190" name="__codelineno-61-190" href="#__codelineno-61-190"></a>
<a id="__codelineno-61-191" name="__codelineno-61-191" href="#__codelineno-61-191"></a><span class="w">                    </span><span class="n">g2o</span><span class="o">::</span><span class="n">EdgeSim3</span><span class="o">*</span><span class="w"> </span><span class="n">en</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">g2o</span><span class="o">::</span><span class="n">EdgeSim3</span><span class="p">();</span>
<a id="__codelineno-61-192" name="__codelineno-61-192" href="#__codelineno-61-192"></a><span class="w">                    </span><span class="n">en</span><span class="o">-&gt;</span><span class="n">setVertex</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">OptimizableGraph</span><span class="o">::</span><span class="n">Vertex</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">optimizer</span><span class="p">.</span><span class="n">vertex</span><span class="p">(</span><span class="n">pKFn</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="p">)));</span>
<a id="__codelineno-61-193" name="__codelineno-61-193" href="#__codelineno-61-193"></a><span class="w">                    </span><span class="n">en</span><span class="o">-&gt;</span><span class="n">setVertex</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">OptimizableGraph</span><span class="o">::</span><span class="n">Vertex</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">optimizer</span><span class="p">.</span><span class="n">vertex</span><span class="p">(</span><span class="n">nIDi</span><span class="p">)));</span>
<a id="__codelineno-61-194" name="__codelineno-61-194" href="#__codelineno-61-194"></a><span class="w">                    </span><span class="n">en</span><span class="o">-&gt;</span><span class="n">setMeasurement</span><span class="p">(</span><span class="n">Sni</span><span class="p">);</span>
<a id="__codelineno-61-195" name="__codelineno-61-195" href="#__codelineno-61-195"></a><span class="w">                    </span><span class="n">en</span><span class="o">-&gt;</span><span class="n">information</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">matLambda</span><span class="p">;</span>
<a id="__codelineno-61-196" name="__codelineno-61-196" href="#__codelineno-61-196"></a><span class="w">                    </span><span class="n">optimizer</span><span class="p">.</span><span class="n">addEdge</span><span class="p">(</span><span class="n">en</span><span class="p">);</span>
<a id="__codelineno-61-197" name="__codelineno-61-197" href="#__codelineno-61-197"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-61-198" name="__codelineno-61-198" href="#__codelineno-61-198"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-61-199" name="__codelineno-61-199" href="#__codelineno-61-199"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-61-200" name="__codelineno-61-200" href="#__codelineno-61-200"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-61-201" name="__codelineno-61-201" href="#__codelineno-61-201"></a>
<a id="__codelineno-61-202" name="__codelineno-61-202" href="#__codelineno-61-202"></a><span class="w">    </span><span class="c1">// Optimize!</span>
<a id="__codelineno-61-203" name="__codelineno-61-203" href="#__codelineno-61-203"></a><span class="w">    </span><span class="n">optimizer</span><span class="p">.</span><span class="n">initializeOptimization</span><span class="p">();</span>
<a id="__codelineno-61-204" name="__codelineno-61-204" href="#__codelineno-61-204"></a><span class="w">    </span><span class="n">optimizer</span><span class="p">.</span><span class="n">optimize</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<a id="__codelineno-61-205" name="__codelineno-61-205" href="#__codelineno-61-205"></a>
<a id="__codelineno-61-206" name="__codelineno-61-206" href="#__codelineno-61-206"></a><span class="w">    </span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">pMap</span><span class="o">-&gt;</span><span class="n">mMutexMapUpdate</span><span class="p">);</span>
<a id="__codelineno-61-207" name="__codelineno-61-207" href="#__codelineno-61-207"></a>
<a id="__codelineno-61-208" name="__codelineno-61-208" href="#__codelineno-61-208"></a><span class="w">    </span><span class="c1">// SE3 Pose Recovering. Sim3:[sR t;0 1] -&gt; SE3:[R t/s;0 1]</span>
<a id="__codelineno-61-209" name="__codelineno-61-209" href="#__codelineno-61-209"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">vpKFs</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-61-210" name="__codelineno-61-210" href="#__codelineno-61-210"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-61-211" name="__codelineno-61-211" href="#__codelineno-61-211"></a><span class="w">        </span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pKFi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vpKFs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-61-212" name="__codelineno-61-212" href="#__codelineno-61-212"></a>
<a id="__codelineno-61-213" name="__codelineno-61-213" href="#__codelineno-61-213"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nIDi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pKFi</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="p">;</span>
<a id="__codelineno-61-214" name="__codelineno-61-214" href="#__codelineno-61-214"></a>
<a id="__codelineno-61-215" name="__codelineno-61-215" href="#__codelineno-61-215"></a><span class="w">        </span><span class="n">g2o</span><span class="o">::</span><span class="n">VertexSim3Expmap</span><span class="o">*</span><span class="w"> </span><span class="n">VSim3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">VertexSim3Expmap</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">optimizer</span><span class="p">.</span><span class="n">vertex</span><span class="p">(</span><span class="n">nIDi</span><span class="p">));</span>
<a id="__codelineno-61-216" name="__codelineno-61-216" href="#__codelineno-61-216"></a><span class="w">        </span><span class="n">g2o</span><span class="o">::</span><span class="n">Sim3</span><span class="w"> </span><span class="n">CorrectedSiw</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">VSim3</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">();</span>
<a id="__codelineno-61-217" name="__codelineno-61-217" href="#__codelineno-61-217"></a><span class="w">        </span><span class="n">vCorrectedSwc</span><span class="p">[</span><span class="n">nIDi</span><span class="p">]</span><span class="o">=</span><span class="n">CorrectedSiw</span><span class="p">.</span><span class="n">inverse</span><span class="p">();</span>
<a id="__codelineno-61-218" name="__codelineno-61-218" href="#__codelineno-61-218"></a><span class="w">        </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix3d</span><span class="w"> </span><span class="n">eigR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CorrectedSiw</span><span class="p">.</span><span class="n">rotation</span><span class="p">().</span><span class="n">toRotationMatrix</span><span class="p">();</span>
<a id="__codelineno-61-219" name="__codelineno-61-219" href="#__codelineno-61-219"></a><span class="w">        </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="w"> </span><span class="n">eigt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CorrectedSiw</span><span class="p">.</span><span class="n">translation</span><span class="p">();</span>
<a id="__codelineno-61-220" name="__codelineno-61-220" href="#__codelineno-61-220"></a><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CorrectedSiw</span><span class="p">.</span><span class="n">scale</span><span class="p">();</span>
<a id="__codelineno-61-221" name="__codelineno-61-221" href="#__codelineno-61-221"></a>
<a id="__codelineno-61-222" name="__codelineno-61-222" href="#__codelineno-61-222"></a><span class="w">        </span><span class="n">eigt</span><span class="w"> </span><span class="o">*=</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">s</span><span class="p">);</span><span class="w"> </span><span class="c1">//[R t/s;0 1]</span>
<a id="__codelineno-61-223" name="__codelineno-61-223" href="#__codelineno-61-223"></a>
<a id="__codelineno-61-224" name="__codelineno-61-224" href="#__codelineno-61-224"></a><span class="w">        </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">Tiw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Converter</span><span class="o">::</span><span class="n">toCvSE3</span><span class="p">(</span><span class="n">eigR</span><span class="p">,</span><span class="n">eigt</span><span class="p">);</span>
<a id="__codelineno-61-225" name="__codelineno-61-225" href="#__codelineno-61-225"></a>
<a id="__codelineno-61-226" name="__codelineno-61-226" href="#__codelineno-61-226"></a><span class="w">        </span><span class="n">pKFi</span><span class="o">-&gt;</span><span class="n">SetPose</span><span class="p">(</span><span class="n">Tiw</span><span class="p">);</span>
<a id="__codelineno-61-227" name="__codelineno-61-227" href="#__codelineno-61-227"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-61-228" name="__codelineno-61-228" href="#__codelineno-61-228"></a>
<a id="__codelineno-61-229" name="__codelineno-61-229" href="#__codelineno-61-229"></a><span class="w">    </span><span class="c1">// Correct points. Transform to &quot;non-optimized&quot; reference keyframe pose and transform back with optimized pose</span>
<a id="__codelineno-61-230" name="__codelineno-61-230" href="#__codelineno-61-230"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">iend</span><span class="o">=</span><span class="n">vpMPs</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">iend</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-61-231" name="__codelineno-61-231" href="#__codelineno-61-231"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-61-232" name="__codelineno-61-232" href="#__codelineno-61-232"></a><span class="w">        </span><span class="n">MapPoint</span><span class="o">*</span><span class="w"> </span><span class="n">pMP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vpMPs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a id="__codelineno-61-233" name="__codelineno-61-233" href="#__codelineno-61-233"></a>
<a id="__codelineno-61-234" name="__codelineno-61-234" href="#__codelineno-61-234"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">isBad</span><span class="p">())</span>
<a id="__codelineno-61-235" name="__codelineno-61-235" href="#__codelineno-61-235"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-61-236" name="__codelineno-61-236" href="#__codelineno-61-236"></a>
<a id="__codelineno-61-237" name="__codelineno-61-237" href="#__codelineno-61-237"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">nIDr</span><span class="p">;</span>
<a id="__codelineno-61-238" name="__codelineno-61-238" href="#__codelineno-61-238"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">mnCorrectedByKF</span><span class="o">==</span><span class="n">pCurKF</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="p">)</span>
<a id="__codelineno-61-239" name="__codelineno-61-239" href="#__codelineno-61-239"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-61-240" name="__codelineno-61-240" href="#__codelineno-61-240"></a><span class="w">            </span><span class="n">nIDr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">mnCorrectedReference</span><span class="p">;</span>
<a id="__codelineno-61-241" name="__codelineno-61-241" href="#__codelineno-61-241"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-61-242" name="__codelineno-61-242" href="#__codelineno-61-242"></a><span class="w">        </span><span class="k">else</span>
<a id="__codelineno-61-243" name="__codelineno-61-243" href="#__codelineno-61-243"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-61-244" name="__codelineno-61-244" href="#__codelineno-61-244"></a><span class="w">            </span><span class="n">KeyFrame</span><span class="o">*</span><span class="w"> </span><span class="n">pRefKF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">GetReferenceKeyFrame</span><span class="p">();</span>
<a id="__codelineno-61-245" name="__codelineno-61-245" href="#__codelineno-61-245"></a><span class="w">            </span><span class="n">nIDr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pRefKF</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="p">;</span>
<a id="__codelineno-61-246" name="__codelineno-61-246" href="#__codelineno-61-246"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-61-247" name="__codelineno-61-247" href="#__codelineno-61-247"></a>
<a id="__codelineno-61-248" name="__codelineno-61-248" href="#__codelineno-61-248"></a>
<a id="__codelineno-61-249" name="__codelineno-61-249" href="#__codelineno-61-249"></a><span class="w">        </span><span class="n">g2o</span><span class="o">::</span><span class="n">Sim3</span><span class="w"> </span><span class="n">Srw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vScw</span><span class="p">[</span><span class="n">nIDr</span><span class="p">];</span>
<a id="__codelineno-61-250" name="__codelineno-61-250" href="#__codelineno-61-250"></a><span class="w">        </span><span class="n">g2o</span><span class="o">::</span><span class="n">Sim3</span><span class="w"> </span><span class="n">correctedSwr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vCorrectedSwc</span><span class="p">[</span><span class="n">nIDr</span><span class="p">];</span>
<a id="__codelineno-61-251" name="__codelineno-61-251" href="#__codelineno-61-251"></a>
<a id="__codelineno-61-252" name="__codelineno-61-252" href="#__codelineno-61-252"></a><span class="w">        </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">P3Dw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">GetWorldPos</span><span class="p">();</span>
<a id="__codelineno-61-253" name="__codelineno-61-253" href="#__codelineno-61-253"></a><span class="w">        </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">eigP3Dw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Converter</span><span class="o">::</span><span class="n">toVector3d</span><span class="p">(</span><span class="n">P3Dw</span><span class="p">);</span>
<a id="__codelineno-61-254" name="__codelineno-61-254" href="#__codelineno-61-254"></a><span class="w">        </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">eigCorrectedP3Dw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">correctedSwr</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">Srw</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">eigP3Dw</span><span class="p">));</span>
<a id="__codelineno-61-255" name="__codelineno-61-255" href="#__codelineno-61-255"></a>
<a id="__codelineno-61-256" name="__codelineno-61-256" href="#__codelineno-61-256"></a><span class="w">        </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">cvCorrectedP3Dw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Converter</span><span class="o">::</span><span class="n">toCvMat</span><span class="p">(</span><span class="n">eigCorrectedP3Dw</span><span class="p">);</span>
<a id="__codelineno-61-257" name="__codelineno-61-257" href="#__codelineno-61-257"></a><span class="w">        </span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">SetWorldPos</span><span class="p">(</span><span class="n">cvCorrectedP3Dw</span><span class="p">);</span>
<a id="__codelineno-61-258" name="__codelineno-61-258" href="#__codelineno-61-258"></a>
<a id="__codelineno-61-259" name="__codelineno-61-259" href="#__codelineno-61-259"></a><span class="w">        </span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">UpdateNormalAndDepth</span><span class="p">();</span>
<a id="__codelineno-61-260" name="__codelineno-61-260" href="#__codelineno-61-260"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-61-261" name="__codelineno-61-261" href="#__codelineno-61-261"></a><span class="p">}</span>
</code></pre></div>
<p>The <span class="arithmatex">\(Sim(3)\)</span> transform error is defined as below.</p>
<p><code>Sim3 C(_measurement);</code> is the measurement transform between two keyframes, 
<code>v1-&gt;estimate()*v2-&gt;estimate().inverse()</code> is the estimate transform between the two keyframes. 
The transform error is scaled by logorithm <code>error_.log();</code>.</p>
<p>As used in <code>Optimizer::OptimizeEssentialGraph(...)</code> where loop closure keyframes <code>if(pKF==pLoopKF)  VSim3-&gt;setFixed(true);</code> are set to fixed, and the transform between keyframes <code>e-&gt;setMeasurement(&lt;transform&gt;);</code> are believed truths that go to <code>Sim3 C(_measurement);</code>,
the optimization would go optimizing the non-loop-closure keyframes to have their poses aligned to the transforms.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">EdgeSim3</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">BaseBinaryEdge</span><span class="o">&lt;</span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="n">Sim3</span><span class="p">,</span><span class="w"> </span><span class="n">VertexSim3Expmap</span><span class="p">,</span><span class="w"> </span><span class="n">VertexSim3Expmap</span><span class="o">&gt;</span>
<a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a><span class="p">{</span>
<a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a><span class="k">public</span><span class="o">:</span>
<a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a><span class="w">  </span><span class="n">EIGEN_MAKE_ALIGNED_OPERATOR_NEW</span>
<a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a><span class="w">  </span><span class="n">EdgeSim3</span><span class="p">();</span>
<a id="__codelineno-62-6" name="__codelineno-62-6" href="#__codelineno-62-6"></a><span class="w">  </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">read</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">istream</span><span class="o">&amp;</span><span class="w"> </span><span class="n">is</span><span class="p">);</span>
<a id="__codelineno-62-7" name="__codelineno-62-7" href="#__codelineno-62-7"></a><span class="w">  </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">write</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="n">os</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<a id="__codelineno-62-8" name="__codelineno-62-8" href="#__codelineno-62-8"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">computeError</span><span class="p">()</span>
<a id="__codelineno-62-9" name="__codelineno-62-9" href="#__codelineno-62-9"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-62-10" name="__codelineno-62-10" href="#__codelineno-62-10"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VertexSim3Expmap</span><span class="o">*</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">VertexSim3Expmap</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">_vertices</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<a id="__codelineno-62-11" name="__codelineno-62-11" href="#__codelineno-62-11"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VertexSim3Expmap</span><span class="o">*</span><span class="w"> </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">VertexSim3Expmap</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">_vertices</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<a id="__codelineno-62-12" name="__codelineno-62-12" href="#__codelineno-62-12"></a>
<a id="__codelineno-62-13" name="__codelineno-62-13" href="#__codelineno-62-13"></a><span class="w">    </span><span class="n">Sim3</span><span class="w"> </span><span class="n">C</span><span class="p">(</span><span class="n">_measurement</span><span class="p">);</span>
<a id="__codelineno-62-14" name="__codelineno-62-14" href="#__codelineno-62-14"></a><span class="w">    </span><span class="n">Sim3</span><span class="w"> </span><span class="n">error_</span><span class="o">=</span><span class="n">C</span><span class="o">*</span><span class="n">v1</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">()</span><span class="o">*</span><span class="n">v2</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">().</span><span class="n">inverse</span><span class="p">();</span>
<a id="__codelineno-62-15" name="__codelineno-62-15" href="#__codelineno-62-15"></a><span class="w">    </span><span class="n">_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">error_</span><span class="p">.</span><span class="n">log</span><span class="p">();</span>
<a id="__codelineno-62-16" name="__codelineno-62-16" href="#__codelineno-62-16"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-62-17" name="__codelineno-62-17" href="#__codelineno-62-17"></a>
<a id="__codelineno-62-18" name="__codelineno-62-18" href="#__codelineno-62-18"></a><span class="w">  </span><span class="k">virtual</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nf">initialEstimatePossible</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">OptimizableGraph</span><span class="o">::</span><span class="n">VertexSet</span><span class="o">&amp;</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">OptimizableGraph</span><span class="o">::</span><span class="n">Vertex</span><span class="o">*</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mf">1.</span><span class="p">;}</span>
<a id="__codelineno-62-19" name="__codelineno-62-19" href="#__codelineno-62-19"></a><span class="w">  </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">initialEstimate</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">OptimizableGraph</span><span class="o">::</span><span class="n">VertexSet</span><span class="o">&amp;</span><span class="w"> </span><span class="n">from</span><span class="p">,</span><span class="w"> </span><span class="n">OptimizableGraph</span><span class="o">::</span><span class="n">Vertex</span><span class="o">*</span><span class="w"> </span><span class="cm">/*to*/</span><span class="p">)</span>
<a id="__codelineno-62-20" name="__codelineno-62-20" href="#__codelineno-62-20"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-62-21" name="__codelineno-62-21" href="#__codelineno-62-21"></a><span class="w">    </span><span class="n">VertexSim3Expmap</span><span class="o">*</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">VertexSim3Expmap</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">_vertices</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<a id="__codelineno-62-22" name="__codelineno-62-22" href="#__codelineno-62-22"></a><span class="w">    </span><span class="n">VertexSim3Expmap</span><span class="o">*</span><span class="w"> </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">VertexSim3Expmap</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">_vertices</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<a id="__codelineno-62-23" name="__codelineno-62-23" href="#__codelineno-62-23"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">from</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-62-24" name="__codelineno-62-24" href="#__codelineno-62-24"></a><span class="w">        </span><span class="n">v2</span><span class="o">-&gt;</span><span class="n">setEstimate</span><span class="p">(</span><span class="n">measurement</span><span class="p">()</span><span class="o">*</span><span class="n">v1</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">());</span>
<a id="__codelineno-62-25" name="__codelineno-62-25" href="#__codelineno-62-25"></a><span class="w">    </span><span class="k">else</span>
<a id="__codelineno-62-26" name="__codelineno-62-26" href="#__codelineno-62-26"></a><span class="w">        </span><span class="n">v1</span><span class="o">-&gt;</span><span class="n">setEstimate</span><span class="p">(</span><span class="n">measurement</span><span class="p">().</span><span class="n">inverse</span><span class="p">()</span><span class="o">*</span><span class="n">v2</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">());</span>
<a id="__codelineno-62-27" name="__codelineno-62-27" href="#__codelineno-62-27"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-62-28" name="__codelineno-62-28" href="#__codelineno-62-28"></a><span class="p">};</span>
<a id="__codelineno-62-29" name="__codelineno-62-29" href="#__codelineno-62-29"></a>
<a id="__codelineno-62-30" name="__codelineno-62-30" href="#__codelineno-62-30"></a><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="kt">int</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">E</span><span class="o">&gt;</span>
<a id="__codelineno-62-31" name="__codelineno-62-31" href="#__codelineno-62-31"></a><span class="k">class</span><span class="w"> </span><span class="nc">BaseEdge</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">OptimizableGraph</span><span class="o">::</span><span class="n">Edge</span>
<a id="__codelineno-62-32" name="__codelineno-62-32" href="#__codelineno-62-32"></a><span class="p">{</span>
<a id="__codelineno-62-33" name="__codelineno-62-33" href="#__codelineno-62-33"></a><span class="k">public</span><span class="o">:</span>
<a id="__codelineno-62-34" name="__codelineno-62-34" href="#__codelineno-62-34"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-62-35" name="__codelineno-62-35" href="#__codelineno-62-35"></a><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">setMeasurement</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Measurement</span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">_measurement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="p">;}</span>
<a id="__codelineno-62-36" name="__codelineno-62-36" href="#__codelineno-62-36"></a><span class="p">}</span>
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../../..", "features": ["navigation.top", "search.suggest", "search.highlight"], "search": "../../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="../../../../javascripts/katex.js"></script>
      
        <script src="https://unpkg.com/katex@0/dist/katex.min.js"></script>
      
        <script src="https://unpkg.com/katex@0/dist/contrib/auto-render.min.js"></script>
      
    
  </body>
</html>